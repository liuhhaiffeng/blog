<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\logical\worker.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\logical\worker.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:47 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * worker.c 
 *     PostgreSQL logical replication worker (apply) 
 * 
 * Copyright (c) 2016-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/logical/worker.c 
 * 
 * NOTES 
 *    This file contains the worker which applies logical changes as they come 
 *    from remote logical replication stream. 
 * 
 *    The main worker (apply) is started by logical replication worker 
 *    launcher for every enabled subscription in a database. It uses 
 *    walsender protocol to communicate with publisher. 
 * 
 *    This module includes server facing code and shares libpqwalreceiver 
 *    module with walreceiver for providing the libpq specific functionality. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"funcapi.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_subscription.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_subscription_rel.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"executor/executor.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/nodeModifyTable.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqformat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqsignal.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"optimizer/planner.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_relation.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgworker.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"replication/decode.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logical.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicalproto.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicalrelation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicalworker.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/reorderbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/origin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/snapbuild.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walreceiver.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/worker_internal.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteHandler.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"tcop/tcopprot.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/catcache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/datum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timeout.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NAPTIME_PER_CYCLE</span> <span class='Number'>1000</span>  <span class='Comment_Single_Line'>/* max sleep time between cycles (1s) */ 
</span> 
<a name="LN90"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FlushPosition</span> 
<span class='Delimiter'>{ 
</span><a name="LN92"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>node</span><span class='Delimiter'>; 
</span><a name="LN93"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>local_end</span><span class='Delimiter'>; 
</span><a name="LN94"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>remote_end</span><span class='Delimiter'>; 
</span><a name="LN95"></a>} <span class='Declare_Typedef'>FlushPosition</span><span class='Delimiter'>; 
</span> 
<a name="LN97"></a><span class='Keyword'>static </span><a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>lsn_mapping</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN247"><span class='Ref_to_Macro'>DLIST_STATIC_INIT</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN97"><span class='Ref_to_Global_Var'>lsn_mapping</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN99"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>SlotErrCallbackArg</span> 
<span class='Delimiter'>{ 
</span><a name="LN101"></a>    <a href="../../../include/replication/logicalproto.h.html#LN41"><span class='Ref_to_Struct'>LogicalRepRelation</span></a> <span class='Operator'>*</span><span class='Declare_Member'>rel</span><span class='Delimiter'>; 
</span><a name="LN102"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>attnum</span><span class='Delimiter'>; 
</span><a name="LN103"></a>} <span class='Declare_Typedef'>SlotErrCallbackArg</span><span class='Delimiter'>; 
</span> 
<a name="LN105"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>ApplyMessageContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN106"></a><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>ApplyContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN108"></a><a href="../libpqwalreceiver/libpqwalreceiver.c.html#LN39"><span class='Ref_to_Struct'>WalReceiverConn</span></a> <span class='Operator'>*</span><span class='Declare_Var'>wrconn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN110"></a><a href="../../../include/catalog/pg_subscription.h.html#LN74"><span class='Ref_to_Struct'>Subscription</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MySubscription</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN111"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>MySubscriptionValid</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN113"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>in_remote_transaction</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN114"></a><span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Var'>remote_final_lsn</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
<a name="LN116"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>send_feedback</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recvpos</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>requestReply</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN118"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>store_flush_position</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>remote_lsn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN120"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>maybe_reread_subscription</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Flags set by signal handlers */ 
</span><a name="LN123"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>got_SIGHUP</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Should this worker apply changes for given relation. 
 * 
 * This is mainly needed for initial relation data sync as that runs in 
 * separate worker process running in parallel and we need some way to skip 
 * changes coming to the main apply worker during the sync of a table. 
 * 
 * Note we need to do smaller or equals comparison for SYNCDONE state because 
 * it might hold position of end of initial slot consistent point WAL 
 * record + 1 (ie start of next record) and next record can be COMMIT of 
 * transaction we are now processing (which is what we set remote_final_lsn 
 * to in apply_handle_begin). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN139"></a><span class='Declare_Function'>should_apply_changes_for_rel</span><span class='Parentheses'>(</span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/replication/worker_internal.h.html#LN86"><span class='Ref_to_Func'>am_tablesync_worker</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN45"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>== </span><a href="worker.c.html#LN139"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN21"><span class='Ref_to_Member'>localreloid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN139"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN27"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_subscription_rel.h.html#LN58"><span class='Ref_to_Const'>SUBREL_STATE_READY</span></a> <span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span><a href="worker.c.html#LN139"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN27"><span class='Ref_to_Member'>state</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_subscription_rel.h.html#LN56"><span class='Ref_to_Const'>SUBREL_STATE_SYNCDONE</span></a> <span class='Operator'>&& 
</span>                 <a href="worker.c.html#LN139"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN28"><span class='Ref_to_Member'>statelsn</span></a> <span class='Operator'>&LT;= </span><a href="worker.c.html#LN114"><span class='Ref_to_Global_Var'>remote_final_lsn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Make sure that we started local transaction. 
 * 
 * Also switches to ApplyMessageContext as necessary. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN155"></a><span class='Declare_Function'>ensure_transaction</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a> <span class='Operator'>!= </span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN120"><span class='Ref_to_Proto'>maybe_reread_subscription</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Executor state preparation for evaluation of constraint expressions, 
 * indexes and triggers. 
 * 
 * This is based on similar code in copy.c 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a> <span class='Operator'>* 
</span><a name="LN181"></a><span class='Declare_Function'>create_estate_for_relation</span><span class='Parentheses'>(</span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN183"></a>    <a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>estate</span><span class='Delimiter'>; 
</span><a name="LN184"></a>    <a href="../../../include/nodes/execnodes.h.html#LN369"><span class='Ref_to_Struct'>ResultRelInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>resultRelInfo</span><span class='Delimiter'>; 
</span><a name="LN185"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a> <span class='Operator'>= </span><a href="../../executor/execUtils.c.html#LN78"><span class='Ref_to_Func'>CreateExecutorState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN185"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN185"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN185"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN181"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN185"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN181"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN410"><span class='Ref_to_Member'>es_range_table</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN138"><span class='Ref_to_Macro'>list_make1</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN185"><span class='Ref_To_Local'>rte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN184"><span class='Ref_To_Local'>resultRelInfo</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/execnodes.h.html#LN369"><span class='Ref_to_Struct'>ResultRelInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/executor.h.html#LN180"><span class='Ref_to_Proto'>InitResultRelInfo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN184"><span class='Ref_To_Local'>resultRelInfo</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN181"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN420"><span class='Ref_to_Member'>es_result_relations</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN184"><span class='Ref_To_Local'>resultRelInfo</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN421"><span class='Ref_to_Member'>es_num_result_relations</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN184"><span class='Ref_To_Local'>resultRelInfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Triggers might need a slot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN184"><span class='Ref_To_Local'>resultRelInfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN377"><span class='Ref_to_Member'>ri_TrigDesc</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN436"><span class='Ref_to_Member'>es_trig_tuple_slot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare to catch AFTER triggers. */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN187"><span class='Ref_to_Proto'>AfterTriggerBeginQuery</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="worker.c.html#LN183"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end create_estate_for_relation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Executes default values for columns for which we can't map to remote 
 * relation columns. 
 * 
 * This allows us to support tables which have more columns on the downstream 
 * than on the upstream. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN220"></a><span class='Declare_Function'>slot_fill_defaults</span><span class='Parentheses'>(</span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>estate</span><span class='Delimiter'>, 
</span><a name="LN221"></a>                   <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN223"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>desc</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN220"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN224"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_phys_attrs</span> <span class='Operator'>= </span><a href="worker.c.html#LN223"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN225"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN226"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>attnum</span><span class='Delimiter'>, 
</span><a name="LN227"></a>                <span class='Declare_Local'>num_defaults</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>defmap</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <a href="../../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a> <span class='Operator'>**</span><span class='Declare_Local'>defexprs</span><span class='Delimiter'>; 
</span><a name="LN230"></a>    <a href="../../../include/nodes/execnodes.h.html#LN191"><span class='Ref_to_Struct'>ExprContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>econtext</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN230"><span class='Ref_To_Local'>econtext</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN455"><span class='Ref_to_Macro'>GetPerTupleExprContext</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN220"><span class='Ref_to_Parameter'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We got all the data via replication, no need to evaluate anything. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN224"><span class='Ref_To_Local'>num_phys_attrs</span></a> <span class='Operator'>== </span><a href="worker.c.html#LN220"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN47"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN228"><span class='Ref_To_Local'>defmap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN224"><span class='Ref_To_Local'>num_phys_attrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN229"><span class='Ref_To_Local'>defexprs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN224"><span class='Ref_To_Local'>num_phys_attrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/nodes/execnodes.h.html#LN52"><span class='Ref_to_Struct'>ExprState</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN224"><span class='Ref_To_Local'>num_phys_attrs</span></a><span class='Delimiter'>; </span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN243"></a>        <a href="../../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>defexpr</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN223"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN220"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN23"><span class='Ref_to_Member'>attrmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="worker.c.html#LN243"><span class='Ref_To_Local'>defexpr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/rewrite/rewriteHandler.h.html#LN24"><span class='Ref_to_Proto'>build_column_default</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN220"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN243"><span class='Ref_To_Local'>defexpr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Run the expression through planner */ 
</span>            <a href="worker.c.html#LN243"><span class='Ref_To_Local'>defexpr</span></a> <span class='Operator'>= </span><a href="../../../include/optimizer/planner.h.html#LN53"><span class='Ref_to_Proto'>expression_planner</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN243"><span class='Ref_To_Local'>defexpr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Initialize executable expression in copycontext */ 
</span>            <a href="worker.c.html#LN229"><span class='Ref_To_Local'>defexprs</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN227"><span class='Ref_To_Local'>num_defaults</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../executor/execExpr.c.html#LN111"><span class='Ref_to_Func'>ExecInitExpr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN243"><span class='Ref_To_Local'>defexpr</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN228"><span class='Ref_To_Local'>defmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN227"><span class='Ref_To_Local'>num_defaults</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="worker.c.html#LN226"><span class='Ref_To_Local'>attnum</span></a><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN227"><span class='Ref_To_Local'>num_defaults</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for attnum=0;attnum&LT;num_p... &raquo; </span> 
 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN227"><span class='Ref_To_Local'>num_defaults</span></a><span class='Delimiter'>; </span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN221"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN228"><span class='Ref_To_Local'>defmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]] </span><span class='Operator'>= 
</span>            <a href="../../../include/executor/executor.h.html#LN264"><span class='Ref_to_Func'>ExecEvalExpr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN229"><span class='Ref_To_Local'>defexprs</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="worker.c.html#LN230"><span class='Ref_To_Local'>econtext</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN221"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN228"><span class='Ref_To_Local'>defmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN225"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end slot_fill_defaults &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Error callback to give more context info about type conversion failure. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN275"></a><span class='Declare_Function'>slot_store_error_callback</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN277"></a>    <a href="worker.c.html#LN99"><span class='Ref_to_Struct'>SlotErrCallbackArg</span></a> <span class='Operator'>*</span><span class='Declare_Local'>errarg</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="worker.c.html#LN99"><span class='Ref_to_Struct'>SlotErrCallbackArg</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="worker.c.html#LN275"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span><a name="LN278"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>remotetypoid</span><span class='Delimiter'>, 
</span><a name="LN279"></a>                <span class='Declare_Local'>localtypoid</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN278"><span class='Ref_To_Local'>remotetypoid</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalproto.h.html#LN49"><span class='Ref_to_Member'>atttyps</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>]; 
</span>    <a href="worker.c.html#LN279"><span class='Ref_To_Local'>localtypoid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalrelation.h.html#LN39"><span class='Ref_to_Proto'>logicalrep_typmap_getid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN278"><span class='Ref_To_Local'>remotetypoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    errcontext<span class='Parentheses'>(</span><span class='String'>"processing remote data for replication target relation \"%s.%s\" column \"%s\", "</span> 
               <span class='String'>"remote type %s, local type %s"</span><span class='Delimiter'>, 
</span>               <a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalproto.h.html#LN45"><span class='Ref_to_Member'>nspname</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalproto.h.html#LN46"><span class='Ref_to_Member'>relname</span></a><span class='Delimiter'>, 
</span>               <a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalproto.h.html#LN48"><span class='Ref_to_Member'>attnames</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN277"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a><span class='Delimiter'>], 
</span>               <a href="../../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN278"><span class='Ref_To_Local'>remotetypoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN279"><span class='Ref_To_Local'>localtypoid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Store data in C string form into slot. 
 * This is similar to BuildTupleFromCStrings but TupleTableSlot fits our 
 * use better. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN300"></a><span class='Declare_Function'>slot_store_cstrings</span><span class='Parentheses'>(</span><a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN301"></a>                    <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>values</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN303"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN120"><span class='Ref_to_Member'>tts_tupleDescriptor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN304"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN305"></a>    <a href="worker.c.html#LN99"><span class='Ref_to_Struct'>SlotErrCallbackArg</span></a> <span class='Declare_Local'>errarg</span><span class='Delimiter'>; 
</span><a name="LN306"></a>    ErrorContextCallback <span class='Declare_Local'>errcallback</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Push callback + info on the error context stack */ 
</span>    <a href="worker.c.html#LN305"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a> <span class='Operator'>= &</span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN305"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN306"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="worker.c.html#LN274"><span class='Ref_to_Func'>slot_store_error_callback</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN306"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="worker.c.html#LN305"><span class='Ref_To_Local'>errarg</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN306"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="worker.c.html#LN306"><span class='Ref_To_Local'>errcallback</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Call the "in" function for each non-dropped attribute */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN303"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN321"></a>        <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN120"><span class='Ref_to_Member'>tts_tupleDescriptor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN322"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>remoteattnum</span> <span class='Operator'>= </span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN23"><span class='Ref_to_Member'>attrmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN321"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>attisdropped <span class='Operator'>&& </span><a href="worker.c.html#LN322"><span class='Ref_To_Local'>remoteattnum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="worker.c.html#LN301"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN322"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN327"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typinput</span><span class='Delimiter'>; 
</span><a name="LN328"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typioparam</span><span class='Delimiter'>; 
</span> 
            <a href="worker.c.html#LN305"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN322"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/lsyscache.h.html#LN161"><span class='Ref_to_Proto'>getTypeInputInfo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN321"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN327"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN328"><span class='Ref_To_Local'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN644"><span class='Ref_to_Proto'>OidInputFunctionCall</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN327"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, 
</span>                                                       <a href="worker.c.html#LN301"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN322"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>], 
</span>                                                       <a href="worker.c.html#LN328"><span class='Ref_To_Local'>typioparam</span></a><span class='Delimiter'>, 
</span>                                                       <a href="worker.c.html#LN321"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We assign NULL to dropped attributes, NULL values, and missing 
             * values (missing values should be later filled using 
             * slot_fill_defaults). 
             */ 
</span>            <a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN304"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;natts;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Pop the error context stack */ 
</span>    <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN306"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN155"><span class='Ref_to_Proto'>ExecStoreVirtualTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN300"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end slot_store_cstrings &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Modify slot with user data provided as C strings. 
 * This is somewhat similar to heap_modify_tuple but also calls the type 
 * input function on the user data as the input is the text representation 
 * of the types. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN364"></a><span class='Declare_Function'>slot_modify_cstrings</span><span class='Parentheses'>(</span><a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, 
</span><a name="LN365"></a>                     <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>values</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>replaces</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN367"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN120"><span class='Ref_to_Member'>tts_tupleDescriptor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span><a name="LN368"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN369"></a>    <a href="worker.c.html#LN99"><span class='Ref_to_Struct'>SlotErrCallbackArg</span></a> <span class='Declare_Local'>errarg</span><span class='Delimiter'>; 
</span><a name="LN370"></a>    ErrorContextCallback <span class='Declare_Local'>errcallback</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN168"><span class='Ref_to_Proto'>slot_getallattrs</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Push callback + info on the error context stack */ 
</span>    <a href="worker.c.html#LN369"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN101"><span class='Ref_to_Member'>rel</span></a> <span class='Operator'>= &</span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN369"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN370"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="worker.c.html#LN274"><span class='Ref_to_Func'>slot_store_error_callback</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN370"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>arg <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="worker.c.html#LN369"><span class='Ref_To_Local'>errarg</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN370"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>    <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="worker.c.html#LN370"><span class='Ref_To_Local'>errcallback</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Call the "in" function for each replaced attribute */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN367"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN386"></a>        <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att</span> <span class='Operator'>= </span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN120"><span class='Ref_to_Member'>tts_tupleDescriptor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN387"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>remoteattnum</span> <span class='Operator'>= </span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN23"><span class='Ref_to_Member'>attrmap</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN387"><span class='Ref_To_Local'>remoteattnum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="worker.c.html#LN365"><span class='Ref_to_Parameter'>replaces</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN387"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN387"><span class='Ref_To_Local'>remoteattnum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="worker.c.html#LN365"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN387"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN394"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typinput</span><span class='Delimiter'>; 
</span><a name="LN395"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>typioparam</span><span class='Delimiter'>; 
</span> 
            <a href="worker.c.html#LN369"><span class='Ref_To_Local'>errarg</span></a><span class='Operator'>.</span><a href="worker.c.html#LN102"><span class='Ref_to_Member'>attnum</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN387"><span class='Ref_To_Local'>remoteattnum</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/lsyscache.h.html#LN161"><span class='Ref_to_Proto'>getTypeInputInfo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN386"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN394"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN395"><span class='Ref_To_Local'>typioparam</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN644"><span class='Ref_to_Proto'>OidInputFunctionCall</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN394"><span class='Ref_To_Local'>typinput</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN365"><span class='Ref_to_Parameter'>values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                                       <a href="worker.c.html#LN395"><span class='Ref_To_Local'>typioparam</span></a><span class='Delimiter'>, 
</span>                                                       <a href="worker.c.html#LN386"><span class='Ref_To_Local'>att</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="worker.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;natts;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Pop the error context stack */ 
</span>    <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN370"><span class='Ref_To_Local'>errcallback</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN155"><span class='Ref_to_Proto'>ExecStoreVirtualTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN364"><span class='Ref_to_Parameter'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end slot_modify_cstrings &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle BEGIN message. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN422"></a><span class='Declare_Function'>apply_handle_begin</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN424"></a>    <a href="../../../include/replication/logicalproto.h.html#LN64"><span class='Ref_to_Struct'>LogicalRepBeginData</span></a> <span class='Declare_Local'>begin_data</span><span class='Delimiter'>; 
</span> 
    <a href="proto.c.html#LN55"><span class='Ref_to_Func'>logicalrep_read_begin</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN422"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN424"><span class='Ref_To_Local'>begin_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN114"><span class='Ref_to_Global_Var'>remote_final_lsn</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN424"><span class='Ref_To_Local'>begin_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN66"><span class='Ref_to_Member'>final_lsn</span></a><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN113"><span class='Ref_to_Global_Var'>in_remote_transaction</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1168"><span class='Ref_to_Proto'>pgstat_report_activity</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN724"><span class='Ref_to_EnumConst'>STATE_RUNNING</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle COMMIT message. 
 * 
 * TODO, support tracking of multiple origins 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN441"></a><span class='Declare_Function'>apply_handle_commit</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN443"></a>    <a href="../../../include/replication/logicalproto.h.html#LN71"><span class='Ref_to_Struct'>LogicalRepCommitData</span></a> <span class='Declare_Local'>commit_data</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/logicalproto.h.html#LN83"><span class='Ref_to_Proto'>logicalrep_read_commit</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN441"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN73"><span class='Ref_to_Member'>commit_lsn</span></a> <span class='Operator'>== </span><a href="worker.c.html#LN114"><span class='Ref_to_Global_Var'>remote_final_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The synchronization worker runs in single transaction. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>() </span><span class='Operator'>&& !</span><a href="../../../include/replication/worker_internal.h.html#LN86"><span class='Ref_to_Func'>am_tablesync_worker</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Update origin state so we can restart streaming from correct 
         * position in case of crash. 
         */ 
</span>        <a href="origin.c.html#LN150"><span class='Ref_to_Global_Var'>replorigin_session_origin_lsn</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN74"><span class='Ref_to_Member'>end_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="origin.c.html#LN151"><span class='Ref_to_Global_Var'>replorigin_session_origin_timestamp</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN75"><span class='Ref_to_Member'>committime</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../postmaster/pgstat.c.html#LN810"><span class='Ref_to_Func'>pgstat_report_stat</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="worker.c.html#LN118"><span class='Ref_to_Proto'>store_flush_position</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN74"><span class='Ref_to_Member'>end_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Process any invalidation messages that might have accumulated. */ 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN120"><span class='Ref_to_Proto'>maybe_reread_subscription</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="worker.c.html#LN113"><span class='Ref_to_Global_Var'>in_remote_transaction</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process any tables that are being synchronized in parallel. */ 
</span>    <a href="../../../include/replication/worker_internal.h.html#LN82"><span class='Ref_to_Proto'>process_syncing_tables</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN443"><span class='Ref_To_Local'>commit_data</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN74"><span class='Ref_to_Member'>end_lsn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1168"><span class='Ref_to_Proto'>pgstat_report_activity</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN723"><span class='Ref_to_EnumConst'>STATE_IDLE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end apply_handle_commit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle ORIGIN message. 
 * 
 * TODO, support tracking of multiple origins 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN485"></a><span class='Declare_Function'>apply_handle_origin</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * ORIGIN message can only come inside remote transaction and before any 
     * actual writes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN113"><span class='Ref_to_Global_Var'>in_remote_transaction</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>() </span><span class='Operator'>&& !</span><a href="../../../include/replication/worker_internal.h.html#LN86"><span class='Ref_to_Func'>am_tablesync_worker</span></a><span class='Parentheses'>()))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ORIGIN message sent out of order"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle RELATION message. 
 * 
 * Note we don't do validation against local schema here. The validation 
 * against local schema is postponed until first change for given relation 
 * comes as we only care about it when applying changes for it anyway and we 
 * do less locking this way. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN507"></a><span class='Declare_Function'>apply_handle_relation</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN509"></a>    <a href="../../../include/replication/logicalproto.h.html#LN41"><span class='Ref_to_Struct'>LogicalRepRelation</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN509"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalproto.h.html#LN101"><span class='Ref_to_Proto'>logicalrep_read_rel</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN507"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/logicalrelation.h.html#LN31"><span class='Ref_to_Proto'>logicalrep_relmap_update</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN509"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle TYPE message. 
 * 
 * Note we don't do local mapping here, that's done when the type is 
 * actually used. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN522"></a><span class='Declare_Function'>apply_handle_type</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN524"></a>    <a href="../../../include/replication/logicalproto.h.html#LN55"><span class='Ref_to_Struct'>LogicalRepTyp</span></a> <span class='Declare_Local'>typ</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/logicalproto.h.html#LN103"><span class='Ref_to_Proto'>logicalrep_read_typ</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN522"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN524"><span class='Ref_To_Local'>typ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/logicalrelation.h.html#LN38"><span class='Ref_to_Proto'>logicalrep_typmap_update</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN524"><span class='Ref_To_Local'>typ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get replica identity index or if it is not defined a primary key. 
 * 
 * If neither is defined, returns InvalidOid 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN536"></a><span class='Declare_Function'>GetRelationIdentityOrPK</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN538"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>idxoid</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN538"><span class='Ref_To_Local'>idxoid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN44"><span class='Ref_to_Proto'>RelationGetReplicaIndex</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN536"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN538"><span class='Ref_To_Local'>idxoid</span></a><span class='Parentheses'>))</span> 
        <a href="worker.c.html#LN538"><span class='Ref_To_Local'>idxoid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relcache.h.html#LN43"><span class='Ref_to_Proto'>RelationGetPrimaryKeyIndex</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN536"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="worker.c.html#LN538"><span class='Ref_To_Local'>idxoid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Handle INSERT message. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN552"></a><span class='Declare_Function'>apply_handle_insert</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN554"></a>    <a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <a href="../../../include/replication/logicalproto.h.html#LN30"><span class='Ref_to_Struct'>LogicalRepTupleData</span></a> <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <a href="../../../include/replication/logicalproto.h.html#LN38"><span class='Ref_to_Typedef'>LogicalRepRelId</span></a> <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN557"></a>    <a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>estate</span><span class='Delimiter'>; 
</span><a name="LN558"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>remoteslot</span><span class='Delimiter'>; 
</span><a name="LN559"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN154"><span class='Ref_to_Func'>ensure_transaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN556"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalproto.h.html#LN90"><span class='Ref_to_Proto'>logicalrep_read_insert</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN552"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN555"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalrelation.h.html#LN33"><span class='Ref_to_Proto'>logicalrep_rel_open</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN556"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN138"><span class='Ref_to_Func'>should_apply_changes_for_rel</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The relation can't become interesting in the middle of the 
         * transaction so it's safe to unlock it. 
         */ 
</span>        <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the executor state. */ 
</span>    <a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN180"><span class='Ref_to_Func'>create_estate_for_relation</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN558"><span class='Ref_To_Local'>remoteslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN146"><span class='Ref_to_Proto'>ExecSetSlotDescriptor</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN558"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process and store remote tuple in the slot */ 
</span>    <a href="worker.c.html#LN559"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../../include/executor/executor.h.html#LN460"><span class='Ref_to_Macro'>GetPerTupleMemoryContext</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN299"><span class='Ref_to_Func'>slot_store_cstrings</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN558"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN555"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN33"><span class='Ref_to_Member'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN219"><span class='Ref_to_Func'>slot_fill_defaults</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN558"><span class='Ref_To_Local'>remoteslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN559"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execIndexing.c.html#LN147"><span class='Ref_to_Func'>ExecOpenIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do the insert. */ 
</span>    <a href="../../executor/execReplication.c.html#LN362"><span class='Ref_to_Func'>ExecSimpleRelationInsert</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN558"><span class='Ref_To_Local'>remoteslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Cleanup. */ 
</span>    <a href="../../executor/execIndexing.c.html#LN222"><span class='Ref_to_Func'>ExecCloseIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Handle queued AFTER triggers. */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN188"><span class='Ref_to_Proto'>AfterTriggerEndQuery</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN143"><span class='Ref_to_Proto'>ExecResetTupleTable</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN449"><span class='Ref_to_Member'>es_tupleTable</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execUtils.c.html#LN176"><span class='Ref_to_Func'>FreeExecutorState</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN557"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN554"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end apply_handle_insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if the logical replication relation is updatable and throw 
 * appropriate error if it isn't. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN612"></a><span class='Declare_Function'>check_relation_updatable</span><span class='Parentheses'>(</span><a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Updatable, no error. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN24"><span class='Ref_to_Member'>updatable</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We are in error mode so it's fine this is somewhat slow. It's better to 
     * give user correct error. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN535"><span class='Ref_to_Func'>GetRelationIdentityOrPK</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"publisher does not send replica identity column "</span> 
             <span class='String'>"expected by the logical replication target relation \"%s.%s\""</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN45"><span class='Ref_to_Member'>nspname</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN46"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication target relation \"%s.%s\" has "</span> 
                    <span class='String'>"neither REPLICA IDENTITY index nor PRIMARY "</span> 
                    <span class='String'>"KEY and published relation does not have "</span> 
                    <span class='String'>"REPLICA IDENTITY FULL"</span><span class='Delimiter'>, 
</span>                    <a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN45"><span class='Ref_to_Member'>nspname</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN612"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN46"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_relation_updatable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle UPDATE message. 
 * 
 * TODO: FDW support 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN646"></a><span class='Declare_Function'>apply_handle_update</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN648"></a>    <a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN649"></a>    <a href="../../../include/replication/logicalproto.h.html#LN38"><span class='Ref_to_Typedef'>LogicalRepRelId</span></a> <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN650"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>idxoid</span><span class='Delimiter'>; 
</span><a name="LN651"></a>    <a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>estate</span><span class='Delimiter'>; 
</span><a name="LN652"></a>    <a href="../../../include/nodes/execnodes.h.html#LN873"><span class='Ref_to_Struct'>EPQState</span></a>    <span class='Declare_Local'>epqstate</span><span class='Delimiter'>; 
</span><a name="LN653"></a>    <a href="../../../include/replication/logicalproto.h.html#LN30"><span class='Ref_to_Struct'>LogicalRepTupleData</span></a> <span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN654"></a>    <a href="../../../include/replication/logicalproto.h.html#LN30"><span class='Ref_to_Struct'>LogicalRepTupleData</span></a> <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN655"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_oldtup</span><span class='Delimiter'>; 
</span><a name="LN656"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>localslot</span><span class='Delimiter'>; 
</span><a name="LN657"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>remoteslot</span><span class='Delimiter'>; 
</span><a name="LN658"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN659"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN154"><span class='Ref_to_Func'>ensure_transaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN649"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalproto.h.html#LN93"><span class='Ref_to_Proto'>logicalrep_read_update</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN646"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN655"><span class='Ref_To_Local'>has_oldtup</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN653"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="worker.c.html#LN654"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalrelation.h.html#LN33"><span class='Ref_to_Proto'>logicalrep_rel_open</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN649"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN138"><span class='Ref_to_Func'>should_apply_changes_for_rel</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The relation can't become interesting in the middle of the 
         * transaction so it's safe to unlock it. 
         */ 
</span>        <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check if we can do the update. */ 
</span>    <a href="worker.c.html#LN611"><span class='Ref_to_Func'>check_relation_updatable</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the executor state. */ 
</span>    <a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN180"><span class='Ref_to_Func'>create_estate_for_relation</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN146"><span class='Ref_to_Proto'>ExecSetSlotDescriptor</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN146"><span class='Ref_to_Proto'>ExecSetSlotDescriptor</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/executor.h.html#LN201"><span class='Ref_to_Proto'>EvalPlanQualInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN652"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execIndexing.c.html#LN147"><span class='Ref_to_Func'>ExecOpenIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build the search tuple. */ 
</span>    <a href="worker.c.html#LN659"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../../include/executor/executor.h.html#LN460"><span class='Ref_to_Macro'>GetPerTupleMemoryContext</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN299"><span class='Ref_to_Func'>slot_store_cstrings</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN655"><span class='Ref_To_Local'>has_oldtup</span></a> <span class='Operator'>? </span><a href="worker.c.html#LN653"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN33"><span class='Ref_to_Member'>values</span></a> <span class='Operator'>: </span><a href="worker.c.html#LN654"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN33"><span class='Ref_to_Member'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN659"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to find tuple using either replica identity index, primary key or 
     * if needed, sequential scan. 
     */ 
</span>    <a href="worker.c.html#LN650"><span class='Ref_To_Local'>idxoid</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN535"><span class='Ref_to_Func'>GetRelationIdentityOrPK</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN650"><span class='Ref_To_Local'>idxoid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>           <span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN50"><span class='Ref_to_Member'>replident</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN178"><span class='Ref_to_Const'>REPLICA_IDENTITY_FULL</span></a> <span class='Operator'>&& </span><a href="worker.c.html#LN655"><span class='Ref_To_Local'>has_oldtup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN650"><span class='Ref_To_Local'>idxoid</span></a><span class='Parentheses'>))</span> 
        <a href="worker.c.html#LN658"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><a href="../../executor/execReplication.c.html#LN112"><span class='Ref_to_Func'>RelationFindReplTupleByIndex</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN650"><span class='Ref_To_Local'>idxoid</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                             <a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="worker.c.html#LN658"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><a href="../../executor/execReplication.c.html#LN265"><span class='Ref_to_Func'>RelationFindReplTupleSeq</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                         <a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Tuple found. 
     * 
     * Note this will fail if there are other conflicting unique indexes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN658"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Process and store remote tuple in the slot */ 
</span>        <a href="worker.c.html#LN659"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../../include/executor/executor.h.html#LN460"><span class='Ref_to_Macro'>GetPerTupleMemoryContext</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/executor/tuptable.h.html#LN147"><span class='Ref_to_Proto'>ExecStoreTuple</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN119"><span class='Ref_to_Member'>tts_tuple</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/buf.h.html#LN24"><span class='Ref_to_Const'>InvalidBuffer</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN363"><span class='Ref_to_Func'>slot_modify_cstrings</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN654"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN33"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN654"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN35"><span class='Ref_to_Member'>changed</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN659"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/executor/executor.h.html#LN219"><span class='Ref_to_Macro'>EvalPlanQualSetSlot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN652"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do the actual update. */ 
</span>        <a href="../../executor/execReplication.c.html#LN418"><span class='Ref_to_Func'>ExecSimpleRelationUpdate</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN652"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN656"><span class='Ref_To_Local'>localslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN657"><span class='Ref_To_Local'>remoteslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The tuple to be updated could not be found. 
         * 
         * TODO what to do here, change the log level to LOG perhaps? 
         */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"logical replication did not find row for update "</span> 
             <span class='String'>"in replication target relation \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Cleanup. */ 
</span>    <a href="../../executor/execIndexing.c.html#LN222"><span class='Ref_to_Func'>ExecCloseIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Handle queued AFTER triggers. */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN188"><span class='Ref_to_Proto'>AfterTriggerEndQuery</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/executor.h.html#LN223"><span class='Ref_to_Proto'>EvalPlanQualEnd</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN652"><span class='Ref_To_Local'>epqstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN143"><span class='Ref_to_Proto'>ExecResetTupleTable</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN449"><span class='Ref_to_Member'>es_tupleTable</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execUtils.c.html#LN176"><span class='Ref_to_Func'>FreeExecutorState</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN651"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN648"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end apply_handle_update &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Handle DELETE message. 
 * 
 * TODO: FDW support 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN767"></a><span class='Declare_Function'>apply_handle_delete</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN769"></a>    <a href="../../../include/replication/logicalrelation.h.html#LN16"><span class='Ref_to_Struct'>LogicalRepRelMapEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN770"></a>    <a href="../../../include/replication/logicalproto.h.html#LN30"><span class='Ref_to_Struct'>LogicalRepTupleData</span></a> <span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN771"></a>    <a href="../../../include/replication/logicalproto.h.html#LN38"><span class='Ref_to_Typedef'>LogicalRepRelId</span></a> <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN772"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>idxoid</span><span class='Delimiter'>; 
</span><a name="LN773"></a>    <a href="../../../include/nodes/execnodes.h.html#LN402"><span class='Ref_to_Struct'>EState</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>estate</span><span class='Delimiter'>; 
</span><a name="LN774"></a>    <a href="../../../include/nodes/execnodes.h.html#LN873"><span class='Ref_to_Struct'>EPQState</span></a>    <span class='Declare_Local'>epqstate</span><span class='Delimiter'>; 
</span><a name="LN775"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>remoteslot</span><span class='Delimiter'>; 
</span><a name="LN776"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>localslot</span><span class='Delimiter'>; 
</span><a name="LN777"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN778"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN154"><span class='Ref_to_Func'>ensure_transaction</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN771"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalproto.h.html#LN98"><span class='Ref_to_Proto'>logicalrep_read_delete</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN767"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN770"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../../include/replication/logicalrelation.h.html#LN33"><span class='Ref_to_Proto'>logicalrep_rel_open</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN771"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN138"><span class='Ref_to_Func'>should_apply_changes_for_rel</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The relation can't become interesting in the middle of the 
         * transaction so it's safe to unlock it. 
         */ 
</span>        <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check if we can do the delete. */ 
</span>    <a href="worker.c.html#LN611"><span class='Ref_to_Func'>check_relation_updatable</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the executor state. */ 
</span>    <a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN180"><span class='Ref_to_Func'>create_estate_for_relation</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN775"><span class='Ref_To_Local'>remoteslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN146"><span class='Ref_to_Proto'>ExecSetSlotDescriptor</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN775"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN402"><span class='Ref_to_Proto'>ExecInitExtraTupleSlot</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN146"><span class='Ref_to_Proto'>ExecSetSlotDescriptor</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/executor.h.html#LN201"><span class='Ref_to_Proto'>EvalPlanQualInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN774"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execIndexing.c.html#LN147"><span class='Ref_to_Func'>ExecOpenIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find the tuple using the replica identity index. */ 
</span>    <a href="worker.c.html#LN778"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../../include/executor/executor.h.html#LN460"><span class='Ref_to_Macro'>GetPerTupleMemoryContext</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN299"><span class='Ref_to_Func'>slot_store_cstrings</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN775"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN770"><span class='Ref_To_Local'>oldtup</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN33"><span class='Ref_to_Member'>values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN778"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try to find tuple using either replica identity index, primary key or 
     * if needed, sequential scan. 
     */ 
</span>    <a href="worker.c.html#LN772"><span class='Ref_To_Local'>idxoid</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN535"><span class='Ref_to_Func'>GetRelationIdentityOrPK</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN772"><span class='Ref_To_Local'>idxoid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>           <span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN18"><span class='Ref_to_Member'>remoterel</span></a><span class='Operator'>.</span><a href="../../../include/replication/logicalproto.h.html#LN50"><span class='Ref_to_Member'>replident</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN178"><span class='Ref_to_Const'>REPLICA_IDENTITY_FULL</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN772"><span class='Ref_To_Local'>idxoid</span></a><span class='Parentheses'>))</span> 
        <a href="worker.c.html#LN777"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><a href="../../executor/execReplication.c.html#LN112"><span class='Ref_to_Func'>RelationFindReplTupleByIndex</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN772"><span class='Ref_To_Local'>idxoid</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                             <a href="worker.c.html#LN775"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="worker.c.html#LN777"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><a href="../../executor/execReplication.c.html#LN265"><span class='Ref_to_Func'>RelationFindReplTupleSeq</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Delimiter'>, </span><a href="../../../include/access/heapam.h.html#LN46"><span class='Ref_to_EnumConst'>LockTupleExclusive</span></a><span class='Delimiter'>, 
</span>                                         <a href="worker.c.html#LN775"><span class='Ref_To_Local'>remoteslot</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* If found delete it. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN777"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/executor/executor.h.html#LN219"><span class='Ref_to_Macro'>EvalPlanQualSetSlot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN774"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do the actual delete. */ 
</span>        <a href="../../executor/execReplication.c.html#LN480"><span class='Ref_to_Func'>ExecSimpleRelationDelete</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN774"><span class='Ref_To_Local'>epqstate</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN776"><span class='Ref_To_Local'>localslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The tuple to be deleted could not be found. */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication could not find row for delete "</span> 
                        <span class='String'>"in replication target %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/logicalrelation.h.html#LN22"><span class='Ref_to_Member'>localrel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Cleanup. */ 
</span>    <a href="../../executor/execIndexing.c.html#LN222"><span class='Ref_to_Func'>ExecCloseIndices</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN422"><span class='Ref_to_Member'>es_result_relation_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Handle queued AFTER triggers. */ 
</span>    <a href="../../../include/commands/trigger.h.html#LN188"><span class='Ref_to_Proto'>AfterTriggerEndQuery</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/executor.h.html#LN223"><span class='Ref_to_Proto'>EvalPlanQualEnd</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN774"><span class='Ref_To_Local'>epqstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN143"><span class='Ref_to_Proto'>ExecResetTupleTable</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN449"><span class='Ref_to_Member'>es_tupleTable</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../executor/execUtils.c.html#LN176"><span class='Ref_to_Func'>FreeExecutorState</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN773"><span class='Ref_To_Local'>estate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/logicalrelation.h.html#LN35"><span class='Ref_to_Proto'>logicalrep_rel_close</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN769"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end apply_handle_delete &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Logical replication protocol message dispatcher. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN866"></a><span class='Declare_Function'>apply_dispatch</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN868"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>action</span> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN37"><span class='Ref_to_Proto'>pq_getmsgbyte</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN868"><span class='Ref_To_Local'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* BEGIN */ 
</span>        <span class='Control'>case</span> <span class='String'>'B'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN421"><span class='Ref_to_Func'>apply_handle_begin</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* COMMIT */ 
</span>        <span class='Control'>case</span> <span class='String'>'C'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN440"><span class='Ref_to_Func'>apply_handle_commit</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* INSERT */ 
</span>        <span class='Control'>case</span> <span class='String'>'I'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN551"><span class='Ref_to_Func'>apply_handle_insert</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* UPDATE */ 
</span>        <span class='Control'>case</span> <span class='String'>'U'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN645"><span class='Ref_to_Func'>apply_handle_update</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* DELETE */ 
</span>        <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN766"><span class='Ref_to_Func'>apply_handle_delete</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* RELATION */ 
</span>        <span class='Control'>case</span> <span class='String'>'R'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN506"><span class='Ref_to_Func'>apply_handle_relation</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* TYPE */ 
</span>        <span class='Control'>case</span> <span class='String'>'Y'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN521"><span class='Ref_to_Func'>apply_handle_type</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* ORIGIN */ 
</span>        <span class='Control'>case</span> <span class='String'>'O'</span><span class='Operator'>: 
</span>            <a href="worker.c.html#LN484"><span class='Ref_to_Func'>apply_handle_origin</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN866"><span class='Ref_to_Parameter'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROTOCOL_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid logical replication message type %c"</span><span class='Delimiter'>, </span><a href="worker.c.html#LN868"><span class='Ref_To_Local'>action</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch action &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end apply_dispatch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Figure out which write/flush positions to report to the walsender process. 
 * 
 * We can't simply report back the last LSN the walsender sent us because the 
 * local transaction might not yet be flushed to disk locally. Instead we 
 * build a list that associates local with remote LSNs for every commit. When 
 * reporting back the flush position to the sender we iterate that list and 
 * check which entries on it are already locally flushed. Those we can report 
 * as having been flushed. 
 * 
 * The have_pending_txes is true if there are outstanding transactions that 
 * need to be flushed. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN925"></a><span class='Declare_Function'>get_flush_position</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>write</span><span class='Delimiter'>, </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>flush</span><span class='Delimiter'>, 
</span><a name="LN926"></a>                   <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>have_pending_txes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN928"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span><a name="LN929"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>local_flush</span> <span class='Operator'>= </span><a href="../../../include/access/xlog.h.html#LN275"><span class='Ref_to_Proto'>GetFlushRecPtr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="worker.c.html#LN925"><span class='Ref_to_Parameter'>write</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="worker.c.html#LN925"><span class='Ref_to_Parameter'>flush</span></a> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN928"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN97"><span class='Ref_to_Global_Var'>lsn_mapping</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN936"></a>        <a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pos</span> <span class='Operator'>= 
</span>        <a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN928"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="worker.c.html#LN925"><span class='Ref_to_Parameter'>write</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN94"><span class='Ref_to_Member'>remote_end</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN93"><span class='Ref_to_Member'>local_end</span></a> <span class='Operator'>&LT;= </span><a href="worker.c.html#LN929"><span class='Ref_To_Local'>local_flush</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="worker.c.html#LN925"><span class='Ref_to_Parameter'>flush</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN94"><span class='Ref_to_Member'>remote_end</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN928"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Don't want to uselessly iterate over the rest of the list which 
             * could potentially be long. Instead get the last element and 
             * grab the write position from there. 
             */ 
</span>            <a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN495"><span class='Ref_to_Macro'>dlist_tail_element</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a><span class='Delimiter'>, </span><a href="../repl_gram.y.html#LN52"><span class='Ref_to_Global_Var'>node</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="worker.c.html#LN97"><span class='Ref_to_Global_Var'>lsn_mapping</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="worker.c.html#LN925"><span class='Ref_to_Parameter'>write</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN936"><span class='Ref_To_Local'>pos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN94"><span class='Ref_to_Member'>remote_end</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="worker.c.html#LN926"><span class='Ref_to_Parameter'>have_pending_txes</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Operator'>*</span><a href="worker.c.html#LN926"><span class='Ref_to_Parameter'>have_pending_txes</span></a> <span class='Operator'>= !</span><a href="../../../include/lib/ilist.h.html#LN287"><span class='Ref_to_Func'>dlist_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN97"><span class='Ref_to_Global_Var'>lsn_mapping</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_flush_position &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Store current remote/local lsn pair in the tracking list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN969"></a><span class='Declare_Function'>store_flush_position</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>remote_lsn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN971"></a>    <a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a> <span class='Operator'>*</span><span class='Declare_Local'>flushpos</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Need to do this in permanent context */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Track commit lsn  */ 
</span>    <a href="worker.c.html#LN971"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="worker.c.html#LN90"><span class='Ref_to_Struct'>FlushPosition</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN971"><span class='Ref_To_Local'>flushpos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN93"><span class='Ref_to_Member'>local_end</span></a> <span class='Operator'>= </span><a href="../../access/transam/xlog.c.html#LN337"><span class='Ref_to_Global_Var'>XactLastCommitEnd</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN971"><span class='Ref_To_Local'>flushpos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN94"><span class='Ref_to_Member'>remote_end</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN969"><span class='Ref_to_Parameter'>remote_lsn</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN97"><span class='Ref_to_Global_Var'>lsn_mapping</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN971"><span class='Ref_To_Local'>flushpos</span></a><span class='Operator'>-&GT;</span><a href="worker.c.html#LN92"><span class='Ref_to_Member'>node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* Update statistics of the worker. */ 
</span><span class='Keyword'>static void 
</span><a name="LN988"></a><span class='Declare_Function'>UpdateWorkerStats</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>last_lsn</span><span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>send_time</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>reply</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN51"><span class='Ref_to_Member'>last_lsn</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN988"><span class='Ref_to_Parameter'>last_lsn</span></a><span class='Delimiter'>; 
</span>    <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN52"><span class='Ref_to_Member'>last_send_time</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN988"><span class='Ref_to_Parameter'>send_time</span></a><span class='Delimiter'>; 
</span>    <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN53"><span class='Ref_to_Member'>last_recv_time</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN988"><span class='Ref_to_Parameter'>reply</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN54"><span class='Ref_to_Member'>reply_lsn</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN988"><span class='Ref_to_Parameter'>last_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN55"><span class='Ref_to_Member'>reply_time</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN988"><span class='Ref_to_Parameter'>send_time</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Apply main loop. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1004"></a><span class='Declare_Function'>LogicalRepApplyLoop</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>last_received</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Init the ApplyMessageContext which we clean up after each replication 
     * protocol message. 
     */ 
</span>    <a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Delimiter'>, 
</span>                                                <span class='String'>"ApplyMessageContext"</span><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* mark as idle, before starting to loop */ 
</span>    <a href="../../../include/pgstat.h.html#LN1168"><span class='Ref_to_Proto'>pgstat_report_activity</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN723"><span class='Ref_to_EnumConst'>STATE_IDLE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1019"></a>        <a href="../../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a>    <span class='Declare_Local'>fd</span> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span><a name="LN1020"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN1021"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN1022"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1023"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>endofstream</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1024"></a>        <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>last_recv_timestamp</span> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1025"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>ping_sent</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN255"><span class='Ref_to_Macro'>walrcv_receive</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1022"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1019"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Process the data */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"data stream from publisher has ended"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="worker.c.html#LN1023"><span class='Ref_To_Local'>endofstream</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN1053"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN1054"></a>                    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Reset timeout. */ 
</span>                    <a href="worker.c.html#LN1024"><span class='Ref_To_Local'>last_recv_timestamp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <a href="worker.c.html#LN1025"><span class='Ref_To_Local'>ping_sent</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Ensure we are reading the data into our memory context. */ 
</span>                    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1022"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                    <a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>                    <a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN39"><span class='Ref_to_Member'>cursor</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN38"><span class='Ref_to_Member'>maxlen</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
                    <a href="worker.c.html#LN1053"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN37"><span class='Ref_to_Proto'>pq_getmsgbyte</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1053"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'w'</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span><a name="LN1072"></a>                        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>start_lsn</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>                        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>end_lsn</span><span class='Delimiter'>; 
</span><a name="LN1074"></a>                        <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>send_time</span><span class='Delimiter'>; 
</span> 
                        <a href="worker.c.html#LN1072"><span class='Ref_To_Local'>start_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN39"><span class='Ref_to_Proto'>pq_getmsgint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN1073"><span class='Ref_To_Local'>end_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN39"><span class='Ref_to_Proto'>pq_getmsgint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN1074"><span class='Ref_To_Local'>send_time</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN39"><span class='Ref_to_Proto'>pq_getmsgint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1072"><span class='Ref_To_Local'>start_lsn</span></a><span class='Parentheses'>) 
</span>                            <a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1072"><span class='Ref_To_Local'>start_lsn</span></a><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1073"><span class='Ref_To_Local'>end_lsn</span></a><span class='Parentheses'>) 
</span>                            <a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1073"><span class='Ref_To_Local'>end_lsn</span></a><span class='Delimiter'>; 
</span> 
                        <a href="worker.c.html#LN987"><span class='Ref_to_Func'>UpdateWorkerStats</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1074"><span class='Ref_To_Local'>send_time</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="worker.c.html#LN865"><span class='Ref_to_Func'>apply_dispatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if c=='w' &raquo; </span> 
                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1053"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>== </span><span class='String'>'k'</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span><a name="LN1092"></a>                        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>end_lsn</span><span class='Delimiter'>; 
</span><a name="LN1093"></a>                        <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>timestamp</span><span class='Delimiter'>; 
</span><a name="LN1094"></a>                        <span class='Keyword'>bool</span>        <span class='Declare_Local'>reply_requested</span><span class='Delimiter'>; 
</span> 
                        <a href="worker.c.html#LN1092"><span class='Ref_To_Local'>end_lsn</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN39"><span class='Ref_to_Proto'>pq_getmsgint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN1093"><span class='Ref_To_Local'>timestamp</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN39"><span class='Ref_to_Proto'>pq_getmsgint64</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN1094"><span class='Ref_To_Local'>reply_requested</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN37"><span class='Ref_to_Proto'>pq_getmsgbyte</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1054"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1092"><span class='Ref_To_Local'>end_lsn</span></a><span class='Parentheses'>) 
</span>                            <a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1092"><span class='Ref_To_Local'>end_lsn</span></a><span class='Delimiter'>; 
</span> 
                        <a href="worker.c.html#LN116"><span class='Ref_to_Proto'>send_feedback</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1094"><span class='Ref_To_Local'>reply_requested</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN987"><span class='Ref_to_Func'>UpdateWorkerStats</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1093"><span class='Ref_To_Local'>timestamp</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Comment_Multi_Line'>/* other message types are purposefully ignored */ 
</span> 
                    <a href="../../../include/utils/memutils.h.html#LN73"><span class='Ref_to_Proto'>MemoryContextReset</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
                <a href="worker.c.html#LN1021"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN255"><span class='Ref_to_Macro'>walrcv_receive</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1022"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1019"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* confirm all writes at once */ 
</span>            <a href="worker.c.html#LN116"><span class='Ref_to_Proto'>send_feedback</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if len!=0 &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN113"><span class='Ref_to_Global_Var'>in_remote_transaction</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If we didn't get any transactions for a while there might be 
             * unconsumed invalidation messages in the queue, consume them 
             * now. 
             */ 
</span>            <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="worker.c.html#LN120"><span class='Ref_to_Proto'>maybe_reread_subscription</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Process any table synchronization changes. */ 
</span>            <a href="../../../include/replication/worker_internal.h.html#LN82"><span class='Ref_to_Proto'>process_syncing_tables</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Cleanup the memory. */ 
</span>        <a href="../../../include/utils/memutils.h.html#LN66"><span class='Ref_to_Macro'>MemoryContextResetAndDeleteChildren</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN105"><span class='Ref_to_Global_Var'>ApplyMessageContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check if we need to exit the streaming loop. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1023"><span class='Ref_To_Local'>endofstream</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1139"></a>            <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>tli</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/replication/walreceiver.h.html#LN253"><span class='Ref_to_Macro'>walrcv_endstreaming</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1139"><span class='Ref_To_Local'>tli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wait for more data or latch. 
         */ 
</span>        <a href="worker.c.html#LN1020"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| 
</span>                               <a href="../../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, 
</span>                               <a href="worker.c.html#LN1019"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="../walreceiver.c.html#LN81"><span class='Ref_to_Const'>NAPTIME_PER_CYCLE</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/pgstat.h.html#LN769"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOGICAL_APPLY_MAIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Emergency bailout if postmaster has died */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1020"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>            <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1020"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../postmaster/startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../postmaster/startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../../utils/misc/guc-file.l.html#LN107"><span class='Ref_to_Func'>ProcessConfigFile</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/guc.h.html#LN71"><span class='Ref_to_EnumConst'>PGC_SIGHUP</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1020"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We didn't receive anything new. If we haven't heard anything 
             * from the server for more than wal_receiver_timeout / 2, ping 
             * the server. Also, if it's been longer than 
             * wal_receiver_status_interval since the last update we sent, 
             * send a status update to the master anyway, to report any 
             * progress in applying WAL. 
             */ 
</span><a name="LN1180"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>requestReply</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check if time since last receive from standby has reached the 
             * configured limit. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN74"><span class='Ref_to_Global_Var'>wal_receiver_timeout</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1188"></a>                <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1189"></a>                <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>timeout</span><span class='Delimiter'>; 
</span> 
                <a href="worker.c.html#LN1189"><span class='Ref_To_Local'>timeout</span></a> <span class='Operator'>= 
</span>                    <a href="../../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1024"><span class='Ref_To_Local'>last_recv_timestamp</span></a><span class='Delimiter'>, 
</span>                                                <a href="../walreceiver.c.html#LN74"><span class='Ref_to_Global_Var'>wal_receiver_timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1188"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>&GT;= </span><a href="worker.c.html#LN1189"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"terminating logical replication worker due to timeout"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * We didn't receive anything new, for half of receiver 
                 * replication timeout. Ping the server. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1025"><span class='Ref_To_Local'>ping_sent</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="worker.c.html#LN1189"><span class='Ref_To_Local'>timeout</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN55"><span class='Ref_to_Macro'>TimestampTzPlusMilliseconds</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1024"><span class='Ref_To_Local'>last_recv_timestamp</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN74"><span class='Ref_to_Global_Var'>wal_receiver_timeout</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1188"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>&GT;= </span><a href="worker.c.html#LN1189"><span class='Ref_To_Local'>timeout</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="worker.c.html#LN1180"><span class='Ref_To_Local'>requestReply</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                        <a href="worker.c.html#LN1025"><span class='Ref_To_Local'>ping_sent</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if wal_receiver_timeout&GT;... &raquo; </span> 
 
            <a href="worker.c.html#LN116"><span class='Ref_to_Proto'>send_feedback</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1004"><span class='Ref_to_Parameter'>last_received</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1180"><span class='Ref_To_Local'>requestReply</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1180"><span class='Ref_To_Local'>requestReply</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rc&WL_TIMEOUT &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LogicalRepApplyLoop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Send a Standby Status Update message to server. 
 * 
 * 'recvpos' is the latest LSN we've received data to, force is set if we need 
 * to send a response to avoid timeouts. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1227"></a><span class='Declare_Function'>send_feedback</span><span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>recvpos</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>requestReply</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1229"></a>    <span class='Keyword'>static </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Local'>reply_message</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1230"></a>    <span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>send_time</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN1232"></a>    <span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Local'>last_recvpos</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN1233"></a>    <span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Local'>last_writepos</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN1234"></a>    <span class='Keyword'>static </span><a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Local'>last_flushpos</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
<a name="LN1236"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>writepos</span><span class='Delimiter'>; 
</span><a name="LN1237"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>flushpos</span><span class='Delimiter'>; 
</span><a name="LN1238"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span><a name="LN1239"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_pending_txes</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the user doesn't want status to be reported to the publisher, be 
     * sure to exit before doing anything at all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>force</span></a> <span class='Operator'>&& </span><a href="../walreceiver.c.html#LN73"><span class='Ref_to_Global_Var'>wal_receiver_status_interval</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* It's legal to not pass a recvpos */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1232"><span class='Ref_To_Local'>last_recvpos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1232"><span class='Ref_To_Local'>last_recvpos</span></a><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN924"><span class='Ref_to_Func'>get_flush_position</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1239"><span class='Ref_To_Local'>have_pending_txes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No outstanding transactions to flush, we can report the latest received 
     * position. This is important for synchronous replication. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1239"><span class='Ref_To_Local'>have_pending_txes</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1233"><span class='Ref_To_Local'>last_writepos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1233"><span class='Ref_To_Local'>last_writepos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>&LT; </span><a href="worker.c.html#LN1234"><span class='Ref_To_Local'>last_flushpos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1234"><span class='Ref_To_Local'>last_flushpos</span></a><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN1238"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if we've already reported everything we're good */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>force</span></a> <span class='Operator'>&& 
</span>        <a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>== </span><a href="worker.c.html#LN1233"><span class='Ref_To_Local'>last_writepos</span></a> <span class='Operator'>&& 
</span>        <a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>== </span><a href="worker.c.html#LN1234"><span class='Ref_To_Local'>last_flushpos</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/utils/timestamp.h.html#LN74"><span class='Ref_to_Proto'>TimestampDifferenceExceeds</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1230"><span class='Ref_To_Local'>send_time</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1238"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>, 
</span>                                    <a href="../walreceiver.c.html#LN73"><span class='Ref_to_Global_Var'>wal_receiver_status_interval</span></a> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1230"><span class='Ref_To_Local'>send_time</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1238"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1280"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a> <span class='Operator'>= </span><a href="../../lib/stringinfo.c.html#LN26"><span class='Ref_to_Func'>makeStringInfo</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1280"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/libpq/pqformat.h.html#LN18"><span class='Ref_to_Proto'>pq_sendbyte</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><span class='String'>'r'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN26"><span class='Ref_to_Proto'>pq_sendint64</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* write */ 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN26"><span class='Ref_to_Proto'>pq_sendint64</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* flush */ 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN26"><span class='Ref_to_Proto'>pq_sendint64</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* apply */ 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN26"><span class='Ref_to_Proto'>pq_sendint64</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1238"><span class='Ref_To_Local'>now</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* sendTime */ 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN18"><span class='Ref_to_Proto'>pq_sendbyte</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>requestReply</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* replyRequested */ 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"sending feedback (force %d) to recv %X/%X, write %X/%X, flush %X/%X"</span><span class='Delimiter'>, 
</span>         <a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>force</span></a><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> 
        <span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/replication/walreceiver.h.html#LN257"><span class='Ref_to_Macro'>walrcv_send</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1229"><span class='Ref_To_Local'>reply_message</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a> <span class='Operator'>&GT; </span><a href="worker.c.html#LN1232"><span class='Ref_To_Local'>last_recvpos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1232"><span class='Ref_To_Local'>last_recvpos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1227"><span class='Ref_to_Parameter'>recvpos</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a> <span class='Operator'>&GT; </span><a href="worker.c.html#LN1233"><span class='Ref_To_Local'>last_writepos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1233"><span class='Ref_To_Local'>last_writepos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1236"><span class='Ref_To_Local'>writepos</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a> <span class='Operator'>&GT; </span><a href="worker.c.html#LN1234"><span class='Ref_To_Local'>last_flushpos</span></a><span class='Parentheses'>) 
</span>        <a href="worker.c.html#LN1234"><span class='Ref_To_Local'>last_flushpos</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1237"><span class='Ref_To_Local'>flushpos</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end send_feedback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Reread subscription info if needed. Most changes will be exit. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1316"></a><span class='Declare_Function'>maybe_reread_subscription</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1318"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span><a name="LN1319"></a>    <a href="../../../include/catalog/pg_subscription.h.html#LN74"><span class='Ref_to_Struct'>Subscription</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newsub</span><span class='Delimiter'>; 
</span><a name="LN1320"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>started_tx</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* When cache state is valid there is nothing to do here. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN111"><span class='Ref_to_Global_Var'>MySubscriptionValid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This function might be called inside or outside of transaction. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN329"><span class='Ref_to_Proto'>IsTransactionState</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN1320"><span class='Ref_To_Local'>started_tx</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Ensure allocations in permanent context. */ 
</span>    <a href="worker.c.html#LN1318"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a> <span class='Operator'>= </span><a href="../../catalog/pg_subscription.c.html#LN43"><span class='Ref_to_Func'>GetSubscription</span></a><span class='Parentheses'>(</span><a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN42"><span class='Ref_to_Member'>subid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Exit if the subscription was removed. This normally should not happen 
     * as the worker gets killed during DROP SUBSCRIPTION. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                        <span class='String'>"stop because the subscription was removed"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Exit if the subscription was disabled. This normally should not happen 
     * as the worker gets killed during ALTER SUBSCRIPTION ... DISABLE. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN81"><span class='Ref_to_Member'>enabled</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                        <span class='String'>"stop because the subscription was disabled"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Exit if connection string was changed. The launcher will start new 
     * worker. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN82"><span class='Ref_to_Member'>conninfo</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN82"><span class='Ref_to_Member'>conninfo</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                    <span class='String'>"restart because the connection information was changed"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Exit if subscription name was changed (it's used for 
     * fallback_application_name). The launcher will start new worker. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                        <span class='String'>"restart because subscription was renamed"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* !slotname should never happen when enabled is true. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN83"><span class='Ref_to_Member'>slotname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to make new connection to new slot if slot name has changed so 
     * exit here as well if that's the case. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN83"><span class='Ref_to_Member'>slotname</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN83"><span class='Ref_to_Member'>slotname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                     <span class='String'>"restart because the replication slot name was changed"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Exit if publication list was changed. The launcher will start new 
     * worker. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/nodes/nodes.h.html#LN626"><span class='Ref_to_Proto'>equal</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN85"><span class='Ref_to_Member'>publications</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN85"><span class='Ref_to_Member'>publications</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will "</span> 
                  <span class='String'>"restart because subscription's publications were changed"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check for other changes that should never happen too. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN77"><span class='Ref_to_Member'>dbid</span></a> <span class='Operator'>!= </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN77"><span class='Ref_to_Member'>dbid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"subscription %u changed unexpectedly"</span><span class='Delimiter'>, 
</span>             <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN42"><span class='Ref_to_Member'>subid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Clean old subscription info and switch to new one. */ 
</span>    <a href="../../../include/catalog/pg_subscription.h.html#LN89"><span class='Ref_to_Proto'>FreeSubscription</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1319"><span class='Ref_To_Local'>newsub</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1318"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Change synchronous commit according to the user's wishes */ 
</span>    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"synchronous_commit"</span><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN84"><span class='Ref_to_Member'>synccommit</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN73"><span class='Ref_to_EnumConst'>PGC_BACKEND</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="worker.c.html#LN1320"><span class='Ref_To_Local'>started_tx</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="worker.c.html#LN111"><span class='Ref_to_Global_Var'>MySubscriptionValid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end maybe_reread_subscription &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Callback from subscription syscache invalidation. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1452"></a><span class='Declare_Function'>subscription_change_cb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="worker.c.html#LN111"><span class='Ref_to_Global_Var'>MySubscriptionValid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* SIGHUP: set flag to reload configuration at next convenient time */ 
</span><span class='Keyword'>static void 
</span><a name="LN1459"></a><span class='Declare_Function'>logicalrep_worker_sighup</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN1078"><span class='Ref_to_Const'>SIGNAL_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1461"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <a href="../../postmaster/startup.c.html#LN40"><span class='Ref_to_Global_Var'>got_SIGHUP</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Waken anything waiting on the process latch */ 
</span>    <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><a href="worker.c.html#LN1461"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Logical Replication Apply worker entry point */ 
</span><span class='Keyword'>void 
</span><a name="LN1473"></a><span class='Declare_Function'>ApplyWorkerMain</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>main_arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1475"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>worker_slot</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1473"><span class='Ref_to_Parameter'>main_arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1476"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span><a name="LN1477"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>originname</span><span class='Delimiter'>[</span><a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1478"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>origin_startpos</span><span class='Delimiter'>; 
</span><a name="LN1479"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>myslotname</span><span class='Delimiter'>; 
</span><a name="LN1480"></a>    <a href="../../../include/replication/walreceiver.h.html#LN139"><span class='Ref_to_Typedef'>WalRcvStreamOptions</span></a> <span class='Declare_Local'>options</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Attach to slot */ 
</span>    <a href="../../../include/replication/worker_internal.h.html#LN70"><span class='Ref_to_Proto'>logicalrep_worker_attach</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1475"><span class='Ref_To_Local'>worker_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Setup signal handling */ 
</span>    <a href="../../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN187"><span class='Ref_to_Const'>SIGHUP</span></a><span class='Delimiter'>, </span><a href="worker.c.html#LN1458"><span class='Ref_to_Func'>logicalrep_worker_sighup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGTERM<span class='Delimiter'>, </span><a href="../../../include/tcop/tcopprot.h.html#LN67"><span class='Ref_to_Proto'>die</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postmaster/bgworker.h.html#LN149"><span class='Ref_to_Proto'>BackgroundWorkerUnblockSignals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialise stats to a sanish value */ 
</span>    <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN52"><span class='Ref_to_Member'>last_send_time</span></a> <span class='Operator'>= </span><a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN53"><span class='Ref_to_Member'>last_recv_time</span></a> <span class='Operator'>= 
</span>        <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN55"><span class='Ref_to_Member'>reply_time</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the libpq-specific functions */ 
</span>    <a href="../../utils/fmgr/dfmgr.c.html#LN135"><span class='Ref_to_Func'>load_file</span></a><span class='Parentheses'>(</span><span class='String'>"libpqwalreceiver"</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                               <span class='String'>"logical replication apply"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Run as replica session replication role. */ 
</span>    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"session_replication_role"</span><span class='Delimiter'>, </span><span class='String'>"replica"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN74"><span class='Ref_to_EnumConst'>PGC_SUSET</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to our database. */ 
</span>    <a href="../../../include/postmaster/bgworker.h.html#LN145"><span class='Ref_to_Proto'>BackgroundWorkerInitializeConnectionByOid</span></a><span class='Parentheses'>(</span><a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN36"><span class='Ref_to_Member'>dbid</span></a><span class='Delimiter'>, 
</span>                                              <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN39"><span class='Ref_to_Member'>userid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the subscription into persistent memory context. */ 
</span>    <a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <span class='String'>"ApplyContext"</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1476"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a> <span class='Operator'>= </span><a href="../../catalog/pg_subscription.c.html#LN43"><span class='Ref_to_Func'>GetSubscription</span></a><span class='Parentheses'>(</span><a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN42"><span class='Ref_to_Member'>subid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN111"><span class='Ref_to_Global_Var'>MySubscriptionValid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1476"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Setup synchronous commit according to the user's wishes */ 
</span>    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"synchronous_commit"</span><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN84"><span class='Ref_to_Member'>synccommit</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN73"><span class='Ref_to_EnumConst'>PGC_BACKEND</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN81"><span class='Ref_to_Member'>enabled</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" will not "</span> 
                <span class='String'>"start because the subscription was disabled during startup"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Keep us informed about subscription changes. */ 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN92"><span class='Ref_to_EnumConst'>SUBSCRIPTIONOID</span></a><span class='Delimiter'>, 
</span>                                  <a href="worker.c.html#LN1451"><span class='Ref_to_Func'>subscription_change_cb</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/replication/worker_internal.h.html#LN86"><span class='Ref_to_Func'>am_tablesync_worker</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication table synchronization worker for subscription \"%s\", table \"%s\" has started"</span><span class='Delimiter'>, 
</span>            <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/replication/worker_internal.h.html#LN45"><span class='Ref_to_Member'>relid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"logical replication apply worker for subscription \"%s\" has started"</span><span class='Delimiter'>, 
</span>                        <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Connect to the origin and start the replication. */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"connecting to publisher using connection string \"%s\""</span><span class='Delimiter'>, 
</span>         <a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN82"><span class='Ref_to_Member'>conninfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/replication/worker_internal.h.html#LN86"><span class='Ref_to_Func'>am_tablesync_worker</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1555"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>syncslotname</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This is table synchroniation worker, call initial sync. */ 
</span>        <a href="worker.c.html#LN1555"><span class='Ref_To_Local'>syncslotname</span></a> <span class='Operator'>= </span><a href="../../../include/replication/worker_internal.h.html#LN81"><span class='Ref_to_Proto'>LogicalRepSyncTableStart</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="worker.c.html#LN1478"><span class='Ref_To_Local'>origin_startpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The slot name needs to be allocated in permanent memory context. */ 
</span>        <a href="worker.c.html#LN1476"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN106"><span class='Ref_to_Global_Var'>ApplyContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN1479"><span class='Ref_To_Local'>myslotname</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1555"><span class='Ref_To_Local'>syncslotname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1476"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1555"><span class='Ref_To_Local'>syncslotname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* This is main apply worker */ 
</span><a name="LN1570"></a>        <a href="../../../include/access/xlogdefs.h.html#LN50"><span class='Ref_to_Typedef'>RepOriginId</span></a> <span class='Declare_Local'>originid</span><span class='Delimiter'>; 
</span><a name="LN1571"></a>        <a href="../../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>startpointTLI</span><span class='Delimiter'>; 
</span><a name="LN1572"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>err</span><span class='Delimiter'>; 
</span><a name="LN1573"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>server_version</span><span class='Delimiter'>; 
</span> 
        <a href="worker.c.html#LN1479"><span class='Ref_To_Local'>myslotname</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN83"><span class='Ref_to_Member'>slotname</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * This shouldn't happen if the subscription is enabled, but guard 
         * against DDL bugs or manual catalog changes.  (libpqwalreceiver will 
         * crash if slot is NULL.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="worker.c.html#LN1479"><span class='Ref_To_Local'>myslotname</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"subscription has no replication slot set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Setup replication origin tracking. */ 
</span>        <a href="../../../include/access/xact.h.html#LN348"><span class='Ref_to_Proto'>StartTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1477"><span class='Ref_To_Local'>originname</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="worker.c.html#LN1477"><span class='Ref_To_Local'>originname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_%u"</span><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN76"><span class='Ref_to_Member'>oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN1570"><span class='Ref_To_Local'>originid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/origin.h.html#LN41"><span class='Ref_to_Proto'>replorigin_by_name</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1477"><span class='Ref_To_Local'>originname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1570"><span class='Ref_To_Local'>originid</span></a><span class='Parentheses'>))</span> 
            <a href="worker.c.html#LN1570"><span class='Ref_To_Local'>originid</span></a> <span class='Operator'>= </span><a href="../../../include/replication/origin.h.html#LN42"><span class='Ref_to_Proto'>replorigin_create</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1477"><span class='Ref_To_Local'>originname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/replication/origin.h.html#LN56"><span class='Ref_to_Proto'>replorigin_session_setup</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1570"><span class='Ref_To_Local'>originid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="origin.c.html#LN149"><span class='Ref_to_Global_Var'>replorigin_session_origin</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1570"><span class='Ref_To_Local'>originid</span></a><span class='Delimiter'>; 
</span>        <a href="worker.c.html#LN1478"><span class='Ref_To_Local'>origin_startpos</span></a> <span class='Operator'>= </span><a href="../../../include/replication/origin.h.html#LN58"><span class='Ref_to_Proto'>replorigin_session_get_progress</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/xact.h.html#LN349"><span class='Ref_to_Proto'>CommitTransactionCommand</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a> <span class='Operator'>= </span><a href="../../../include/replication/walreceiver.h.html#LN241"><span class='Ref_to_Macro'>walrcv_connect</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN82"><span class='Ref_to_Member'>conninfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN79"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, 
</span>                                <span class='Operator'>&</span><a href="worker.c.html#LN1572"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not connect to the publisher: %s"</span><span class='Delimiter'>, </span><a href="worker.c.html#LN1572"><span class='Ref_To_Local'>err</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't really use the output identify_system for anything but it 
         * does some initializations on the upstream so let's still call it. 
         */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/replication/walreceiver.h.html#LN247"><span class='Ref_to_Macro'>walrcv_identify_system</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1571"><span class='Ref_To_Local'>startpointTLI</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="worker.c.html#LN1573"><span class='Ref_To_Local'>server_version</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Setup callback for syscache so that we know when something changes in 
     * the subscription relation state. 
     */ 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN93"><span class='Ref_to_EnumConst'>SUBSCRIPTIONRELMAP</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/replication/worker_internal.h.html#LN83"><span class='Ref_to_Proto'>invalidate_syncing_table_states</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build logical replication streaming options. */ 
</span>    <a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Operator'>.</span><a href="../../../include/replication/walreceiver.h.html#LN141"><span class='Ref_to_Member'>logical</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Operator'>.</span><a href="../../../include/replication/walreceiver.h.html#LN144"><span class='Ref_to_Member'>startpoint</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1478"><span class='Ref_To_Local'>origin_startpos</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Operator'>.</span><a href="../../../include/replication/walreceiver.h.html#LN143"><span class='Ref_to_Member'>slotname</span></a> <span class='Operator'>= </span><a href="worker.c.html#LN1479"><span class='Ref_To_Local'>myslotname</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Operator'>.</span><a href="../../../include/replication/walreceiver.h.html#LN157"><span class='Ref_to_Member'>proto</span></a><span class='Operator'>.</span>logical<span class='Operator'>.</span>proto_version <span class='Operator'>= </span><a href="../../../include/replication/logicalproto.h.html#LN27"><span class='Ref_to_Const'>LOGICALREP_PROTO_VERSION_NUM</span></a><span class='Delimiter'>; 
</span>    <a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Operator'>.</span><a href="../../../include/replication/walreceiver.h.html#LN157"><span class='Ref_to_Member'>proto</span></a><span class='Operator'>.</span>logical<span class='Operator'>.</span>publication_names <span class='Operator'>= </span><a href="worker.c.html#LN110"><span class='Ref_to_Global_Var'>MySubscription</span></a><span class='Operator'>-&GT;</span><a href="../../../include/catalog/pg_subscription.h.html#LN85"><span class='Ref_to_Member'>publications</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Start normal logical streaming replication. */ 
</span>    <a href="../../../include/replication/walreceiver.h.html#LN251"><span class='Ref_to_Macro'>walrcv_startstreaming</span></a><span class='Parentheses'>(</span><a href="../walreceiver.c.html#LN78"><span class='Ref_to_Global_Var'>wrconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="worker.c.html#LN1480"><span class='Ref_To_Local'>options</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Run the main loop. */ 
</span>    <a href="worker.c.html#LN1003"><span class='Ref_to_Func'>LogicalRepApplyLoop</span></a><span class='Parentheses'>(</span><a href="worker.c.html#LN1478"><span class='Ref_To_Local'>origin_startpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/ipc/ipc.c.html#LN97"><span class='Ref_to_Func'>proc_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ApplyWorkerMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Is current process a logical replication worker? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1640"></a><span class='Declare_Function'>IsLogicalWorker</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="launcher.c.html#LN62"><span class='Ref_to_Global_Var'>MyLogicalRepWorker</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>