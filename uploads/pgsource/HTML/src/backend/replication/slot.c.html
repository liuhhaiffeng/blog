<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\replication\slot.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\replication\slot.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:46 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * slot.c 
 *     Replication slot management. 
 * 
 * 
 * Copyright (c) 2012-2017, PostgreSQL Global Development Group 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/replication/slot.c 
 * 
 * NOTES 
 * 
 * Replication slots are used to keep state about replication streams 
 * originating from this cluster.  Their primary purpose is to prevent the 
 * premature removal of WAL or of old tuple versions in a manner that would 
 * interfere with replication; they are also useful for monitoring purposes. 
 * Slots need to be permanent (to allow restarts), crash-safe, and allocatable 
 * on standbys (to support cascading setups).  The requirement that slots be 
 * usable on standbys precludes storing them in the system catalogs. 
 * 
 * Each replication slot gets its own directory inside the $PGDATA/pg_replslot 
 * directory. Inside that directory the state file will contain the slot's 
 * own data. Additional data can be stored alongside that file if required. 
 * While the server is running, the state data is also cached in memory for 
 * efficiency. 
 * 
 * ReplicationSlotAllocationLock must be taken in exclusive mode to allocate 
 * or free a slot. ReplicationSlotControlLock must be taken in shared mode 
 * to iterate over the slots, and in exclusive mode to change the in_use flag 
 * of a slot.  The remaining data in each slot is protected by its mutex. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/string.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/slot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Replication slot on-disk data structure. 
 */ 
</span><a name="LN55"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ReplicationSlotOnDisk</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* first part of this struct needs to be version independent */ 
</span> 
    <span class='Comment_Multi_Line'>/* data not covered by checksum */ 
</span><a name="LN60"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>magic</span><span class='Delimiter'>; 
</span><a name="LN61"></a>    <a href="../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Member'>checksum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* data covered by checksum */ 
</span><a name="LN64"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>version</span><span class='Delimiter'>; 
</span><a name="LN65"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>length</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The actual data in the slot that follows can differ based on the above 
     * 'version'. 
     */ 
</span> 
<a name="LN72"></a>    <a href="../../include/replication/slot.h.html#LN37"><span class='Ref_to_Struct'>ReplicationSlotPersistentData</span></a> <span class='Declare_Member'>slotdata</span><span class='Delimiter'>; 
</span><a name="LN73"></a>} <span class='Declare_Typedef'>ReplicationSlotOnDisk</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* size of version independent data */ 
</span><a name="LN76"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ReplicationSlotOnDiskConstantSize</span> <span class='Operator'>\ 
</span>    <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a><span class='Delimiter'>, </span>slotdata<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* size of the part of the slot not covered by the checksum */ 
</span><a name="LN79"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SnapBuildOnDiskNotChecksummedSize</span> <span class='Operator'>\ 
</span>    <a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a><span class='Delimiter'>, </span>version<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* size of the part covered by the checksum */ 
</span><a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SnapBuildOnDiskChecksummedSize</span> <span class='Operator'>\ 
</span>    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a> 
<span class='Comment_Multi_Line'>/* size of the slot data that is version dependent */ 
</span><a name="LN85"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ReplicationSlotOnDiskV2Size</span> <span class='Operator'>\ 
</span>    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="slot.c.html#LN76"><span class='Ref_to_Const'>ReplicationSlotOnDiskConstantSize</span></a> 
 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SLOT_MAGIC</span>      <span class='Number'>0x1051CA1</span>       <span class='Comment_Single_Line'>/* format identifier */ 
</span><a name="LN89"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SLOT_VERSION</span>    <span class='Number'>2</span>       <span class='Comment_Single_Line'>/* version for new files */ 
</span> 
<span class='Comment_Multi_Line'>/* Control array for replication slot management */ 
</span><a name="LN92"></a><a href="../../include/replication/slot.h.html#LN138"><span class='Ref_to_Struct'>ReplicationSlotCtlData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ReplicationSlotCtl</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* My backend's replication slot in the shared memory array */ 
</span><a name="LN95"></a><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Var'>MyReplicationSlot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* GUCs */ 
</span><a name="LN98"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>max_replication_slots</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>  <span class='Comment_Multi_Line'>/* the maximum number of replication 
                                         * slots */ 
</span> 
<a name="LN101"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReplicationSlotDropAcquired</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN102"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReplicationSlotDropPtr</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* internal persistency functions */ 
</span><a name="LN105"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RestoreSlotFromDisk</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN106"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CreateSlotOnDisk</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN107"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SaveSlotToPath</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Report shared-memory space needed by ReplicationSlotShmemInit. 
 */ 
</span><a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN113"></a><span class='Declare_Function'>ReplicationSlotsShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN115"></a>    <a href="../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="slot.c.html#LN115"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN115"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN138"><span class='Ref_to_Struct'>ReplicationSlotCtlData</span></a><span class='Delimiter'>, </span>replication_slots<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN115"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN115"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                    <a href="../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="slot.c.html#LN115"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Allocate and initialize walsender-related shared memory. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN131"></a><span class='Declare_Function'>ReplicationSlotsShmemInit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN133"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN138"><span class='Ref_to_Struct'>ReplicationSlotCtlData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"ReplicationSlot Ctl"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN112"><span class='Ref_to_Func'>ReplicationSlotsShmemSize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        <span class='Operator'>&</span><a href="slot.c.html#LN133"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN186"><span class='Ref_to_Proto'>LWLockRegisterTranche</span></a><span class='Parentheses'>(</span><a href="../../include/storage/lwlock.h.html#LN208"><span class='Ref_to_EnumConst'>LWTRANCHE_REPLICATION_SLOT_IO_IN_PROGRESS</span></a><span class='Delimiter'>, 
</span>                          <span class='String'>"replication_slot_io"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN133"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN147"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* First time through, so initialize */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="slot.c.html#LN112"><span class='Ref_to_Func'>ReplicationSlotsShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN147"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN147"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN147"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN154"></a>            <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN147"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* everything else is zeroed by the memset above */ 
</span>            <a href="../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN154"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/storage/lwlock.h.html#LN187"><span class='Ref_to_Proto'>LWLockInitialize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN154"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN117"><span class='Ref_to_Member'>io_in_progress_lock</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN208"><span class='Ref_to_EnumConst'>LWTRANCHE_REPLICATION_SLOT_IO_IN_PROGRESS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsShmemInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check whether the passed slot name is valid and report errors at elevel. 
 * 
 * Slot names may consist out of [a-z0-9_]{1,NAMEDATALEN-1} which should allow 
 * the name to be used as a directory name on every supported OS. 
 * 
 * Returns whether the directory name is valid or not if elevel &LT; ERROR. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN172"></a><span class='Declare_Function'>ReplicationSlotValidateName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN174"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>cp</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot name \"%s\" is too short"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NAME_TOO_LONG<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot name \"%s\" is too long"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>((</span><span class='Operator'>*</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>&GT;= </span><span class='String'>'a'</span> <span class='Operator'>&& *</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>&LT;= </span><span class='String'>'z'</span><span class='Parentheses'>) 
</span>              <span class='Operator'>|| </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>&GT;= </span><span class='String'>'0'</span> <span class='Operator'>&& *</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>&LT;= </span><span class='String'>'9'</span><span class='Parentheses'>) 
</span>              <span class='Operator'>|| </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="slot.c.html#LN174"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>== </span><span class='String'>'_'</span><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot name \"%s\" contains invalid character"</span><span class='Delimiter'>, 
</span>                   <a href="slot.c.html#LN172"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Replication slot names may only contain lower case letters, numbers, and the underscore character."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotValidateName &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a new replication slot and mark it as used by this backend. 
 * 
 * name: Name of the slot 
 * db_specific: logical decoding is db specific; if the slot is going to 
 *     be used for that pass true, otherwise false. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN219"></a><span class='Declare_Function'>ReplicationSlotCreate</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>db_specific</span><span class='Delimiter'>, 
</span><a name="LN220"></a>                      <a href="../../include/replication/slot.h.html#LN27"><span class='Ref_to_Enum'>ReplicationSlotPersistency</span></a> <span class='Declare_Parameter'>persistency</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN222"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN223"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN171"><span class='Ref_to_Func'>ReplicationSlotValidateName</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN219"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If some other backend ran this code concurrently with us, we'd likely 
     * both allocate the same slot, and that would be bad.  We'd also be at 
     * risk of missing a name collision.  Also, we don't want to try to create 
     * a new slot while somebody's busy cleaning up an old one, because we 
     * might both be monkeying with the same directory. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for name collision, and identify an allocatable slot.  We need to 
     * hold ReplicationSlotControlLock in shared mode for this, so that nobody 
     * else can change the in_use flags while we're looking at them. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN223"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN223"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN223"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN246"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN223"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN246"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="slot.c.html#LN219"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN246"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN219"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN246"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>&& </span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN246"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If all slots are in use, we're out of luck. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIGURATION_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"all replication slots are in use"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Free one or increase max_replication_slots."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since this slot is not in use, nobody should be looking at any part of 
     * it other than the in_use field unless they're trying to allocate it. 
     * And since we hold ReplicationSlotAllocationLock, nobody except us can 
     * be doing that.  So it's safe to initialize the slot. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* first initialize persistent data */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN37"><span class='Ref_to_Struct'>ReplicationSlotPersistentData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="slot.c.html#LN219"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN43"><span class='Ref_to_Member'>database</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN219"><span class='Ref_to_Parameter'>db_specific</span></a> <span class='Operator'>? </span><a href="../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>: </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN220"><span class='Ref_to_Parameter'>persistency</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and then data only present in shared memory */ 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN96"><span class='Ref_to_Member'>just_dirtied</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN97"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN110"><span class='Ref_to_Member'>effective_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN111"><span class='Ref_to_Member'>effective_catalog_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN126"><span class='Ref_to_Member'>candidate_catalog_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN127"><span class='Ref_to_Member'>candidate_xmin_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN128"><span class='Ref_to_Member'>candidate_restart_valid</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN129"><span class='Ref_to_Member'>candidate_restart_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the slot on disk.  We haven't actually marked the slot allocated 
     * yet, so no special cleanup is required if this errors out. 
     */ 
</span>    <a href="slot.c.html#LN106"><span class='Ref_to_Proto'>CreateSlotOnDisk</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to briefly prevent any other backend from iterating over the 
     * slots while we flip the in_use flag. We also need to set the active 
     * flag while holding the ControlLock as otherwise a concurrent 
     * SlotAcquire() could acquire the slot as well. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can now mark the slot active, and that makes it our slot. */ 
</span>    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN222"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that the slot has been marked as in_use and in_active, it's safe to 
     * let somebody else try to allocate a slot. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find a previously created slot and mark it as used by this backend. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN325"></a><span class='Declare_Function'>ReplicationSlotAcquire</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN327"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN328"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN329"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>active_pid</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Keep compiler quiet */ 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search for the named slot and mark it active if we find it. */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN328"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN328"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN328"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN337"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN328"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="slot.c.html#LN325"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="slot.c.html#LN329"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN329"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="slot.c.html#LN329"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>            <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="slot.c.html#LN327"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN337"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we did not find the slot or it was already active, error out. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN327"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN325"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN329"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>!= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot \"%s\" is active for PID %d"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN325"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN329"><span class='Ref_To_Local'>active_pid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We made this slot active, so it's ours now. */ 
</span>    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN327"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotAcquire &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Release a replication slot, this or another backend can ReAcquire it 
 * later. Resources this slot requires will be preserved. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN372"></a><span class='Declare_Function'>ReplicationSlotRelease</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN374"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>== </span><a href="../../include/replication/slot.h.html#LN30"><span class='Ref_to_EnumConst'>RS_EPHEMERAL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Delete the slot. There is no !PANIC case where this is allowed to 
         * fail, all that may happen is an incomplete cleanup of the on-disk 
         * data. 
         */ 
</span>        <a href="slot.c.html#LN101"><span class='Ref_to_Proto'>ReplicationSlotDropAcquired</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>== </span><a href="../../include/replication/slot.h.html#LN29"><span class='Ref_to_EnumConst'>RS_PERSISTENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Mark persistent slot inactive.  We're not freeing it, just 
         * disconnecting. 
         */ 
</span>        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If slot needed to temporarily restrain both data and catalog xmin to 
     * create the catalog snapshot, remove that temporary constraint. 
     * Snapshots can only be exported while the initial snapshot is still 
     * acquired. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN56"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN110"><span class='Ref_to_Member'>effective_xmin</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN110"><span class='Ref_to_Member'>effective_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN374"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/replication/slot.h.html#LN175"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredXmin</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* might not have been set when we've been a plain slot */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../include/storage/proc.h.html#LN217"><span class='Ref_to_Member'>vacuumFlags</span></a> <span class='Operator'>&= ~</span><a href="../../include/storage/proc.h.html#LN55"><span class='Ref_to_Const'>PROC_IN_LOGICAL_DECODING</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotRelease &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Cleanup all temporary slots created in current session. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN426"></a><span class='Declare_Function'>ReplicationSlotCleanup</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN428"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need for locking as we are only interested in slots active in 
     * current process and those are not touched by other processes. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN428"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN428"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN428"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN438"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN428"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN438"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>== </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN438"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>&& </span><a href="slot.c.html#LN438"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>== </span><a href="../../include/replication/slot.h.html#LN31"><span class='Ref_to_EnumConst'>RS_TEMPORARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="slot.c.html#LN102"><span class='Ref_to_Proto'>ReplicationSlotDropPtr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN438"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Permanently drop replication slot identified by the passed in name. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN453"></a><span class='Declare_Function'>ReplicationSlotDrop</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/replication/slot.h.html#LN166"><span class='Ref_to_Proto'>ReplicationSlotAcquire</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN453"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN101"><span class='Ref_to_Proto'>ReplicationSlotDropAcquired</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Permanently drop the currently acquired replication slot. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN466"></a><span class='Declare_Function'>ReplicationSlotDropAcquired</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN468"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* slot isn't acquired anymore */ 
</span>    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN102"><span class='Ref_to_Proto'>ReplicationSlotDropPtr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN468"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Permanently drop the replication slot which will be released by the point 
 * this function returns. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN483"></a><span class='Declare_Function'>ReplicationSlotDropPtr</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN485"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN486"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If some other backend ran this code concurrently with us, we might try 
     * to delete a slot with a certain name while someone else was trying to 
     * create a slot with the same name. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate pathnames. */ 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN485"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s.tmp"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Rename the slot directory on disk, so that we'll no longer recognize 
     * this as a valid slot.  Note that if this fails, we've got to mark the 
     * slot inactive before bailing out.  If we're dropping an ephemeral or a 
     * temporary slot, we better never fail hard as the caller won't expect 
     * the slot to survive and this might get called during error handling. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN485"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We need to fsync() the directory we just renamed and its parent to 
         * make sure that our changes are on disk in a crash-safe fashion.  If 
         * fsync() fails, we can't be sure whether the changes are on disk or 
         * not.  For now, we handle that by panicking; 
         * StartupReplicationSlots() will try to straighten it out after 
         * restart. 
         */ 
</span>        <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN523"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>fail_softly</span> <span class='Operator'>= </span><a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>!= </span><a href="../../include/replication/slot.h.html#LN29"><span class='Ref_to_EnumConst'>RS_PERSISTENT</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN523"><span class='Ref_To_Local'>fail_softly</span></a> <span class='Operator'>? </span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a> <span class='Operator'>: </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN485"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The slot is definitely gone.  Lock out concurrent scans of the array 
     * long enough to kill it.  It's OK to clear the active flag here without 
     * grabbing the mutex because nobody else can be scanning the array here, 
     * and nobody can be attached to this slot and thus access it without 
     * scanning the array. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN483"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Slot is dead and doesn't prevent resource removal anymore, recompute 
     * limits. 
     */ 
</span>    <a href="../../include/replication/slot.h.html#LN175"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredXmin</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/replication/slot.h.html#LN176"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredLSN</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If removing the directory fails, the worst thing that will happen is 
     * that the user won't be able to create a new slot with the same name 
     * until the next server restart.  We warn about it, but that's all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\""</span><span class='Delimiter'>, </span><a href="slot.c.html#LN486"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We release this at the very end, so that nobody starts trying to create 
     * a slot while we're still cleaning up the detritus of the old one. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotDropPtr &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Serialize the currently acquired slot's state from memory to disk, thereby 
 * guaranteeing the current state will survive a crash. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN576"></a><span class='Declare_Function'>ReplicationSlotSave</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN578"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN578"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN107"><span class='Ref_to_Proto'>SaveSlotToPath</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN578"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Signal that it would be useful if the currently acquired slot would be 
 * flushed out to disk. 
 * 
 * Note that the actual flush to disk can be delayed for a long time, if 
 * required for correctness explicitly do a ReplicationSlotSave(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN594"></a><span class='Declare_Function'>ReplicationSlotMarkDirty</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN596"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN596"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN96"><span class='Ref_to_Member'>just_dirtied</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN97"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN596"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Convert a slot that's marked as RS_EPHEMERAL to a RS_PERSISTENT slot, 
 * guaranteeing it will be there after an eventual crash. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN611"></a><span class='Declare_Function'>ReplicationSlotPersist</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN613"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN613"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN613"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>!= </span><a href="../../include/replication/slot.h.html#LN29"><span class='Ref_to_EnumConst'>RS_PERSISTENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN613"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN613"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>= </span><a href="../../include/replication/slot.h.html#LN29"><span class='Ref_to_EnumConst'>RS_PERSISTENT</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN613"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/replication/slot.h.html#LN170"><span class='Ref_to_Proto'>ReplicationSlotMarkDirty</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/replication/slot.h.html#LN169"><span class='Ref_to_Proto'>ReplicationSlotSave</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compute the oldest xmin across all slots and store it in the ProcArray. 
 * 
 * If already_locked is true, ProcArrayLock has already been acquired 
 * exclusively. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN633"></a><span class='Declare_Function'>ReplicationSlotsComputeRequiredXmin</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>already_locked</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN635"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN636"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>agg_xmin</span> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN637"></a>    <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>agg_catalog_xmin</span> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN635"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN645"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN635"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN646"></a>        <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>effective_xmin</span><span class='Delimiter'>; 
</span><a name="LN647"></a>        <a href="../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>effective_catalog_xmin</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN645"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN645"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN646"><span class='Ref_To_Local'>effective_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN645"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN110"><span class='Ref_to_Member'>effective_xmin</span></a><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN647"><span class='Ref_To_Local'>effective_catalog_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN645"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN111"><span class='Ref_to_Member'>effective_catalog_xmin</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN645"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check the data xmin */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN646"><span class='Ref_To_Local'>effective_xmin</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN636"><span class='Ref_To_Local'>agg_xmin</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>             <a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN646"><span class='Ref_To_Local'>effective_xmin</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN636"><span class='Ref_To_Local'>agg_xmin</span></a><span class='Parentheses'>)))</span> 
            <a href="slot.c.html#LN636"><span class='Ref_To_Local'>agg_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN646"><span class='Ref_To_Local'>effective_xmin</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* check the catalog xmin */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN647"><span class='Ref_To_Local'>effective_catalog_xmin</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN637"><span class='Ref_To_Local'>agg_catalog_xmin</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>             <a href="../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN647"><span class='Ref_To_Local'>effective_catalog_xmin</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN637"><span class='Ref_To_Local'>agg_catalog_xmin</span></a><span class='Parentheses'>)))</span> 
            <a href="slot.c.html#LN637"><span class='Ref_To_Local'>agg_catalog_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN647"><span class='Ref_To_Local'>effective_catalog_xmin</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_replication... &raquo; </span> 
 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/procarray.h.html#LN121"><span class='Ref_to_Proto'>ProcArraySetReplicationSlotXmin</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN636"><span class='Ref_To_Local'>agg_xmin</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN637"><span class='Ref_To_Local'>agg_catalog_xmin</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN633"><span class='Ref_to_Parameter'>already_locked</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsComputeRequiredXmin &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute the oldest restart LSN across all slots and inform xlog module. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN679"></a><span class='Declare_Function'>ReplicationSlotsComputeRequiredLSN</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN681"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN682"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>min_required</span> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN681"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN681"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN681"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN689"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN681"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN690"></a>        <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>restart_lsn</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN689"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN689"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN690"><span class='Ref_To_Local'>restart_lsn</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN689"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN689"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN690"><span class='Ref_To_Local'>restart_lsn</span></a> <span class='Operator'>!= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="slot.c.html#LN682"><span class='Ref_To_Local'>min_required</span></a> <span class='Operator'>== </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>|| 
</span>             <a href="slot.c.html#LN690"><span class='Ref_To_Local'>restart_lsn</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN682"><span class='Ref_To_Local'>min_required</span></a><span class='Parentheses'>))</span> 
            <a href="slot.c.html#LN682"><span class='Ref_To_Local'>min_required</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN690"><span class='Ref_To_Local'>restart_lsn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/xlog.h.html#LN234"><span class='Ref_to_Proto'>XLogSetReplicationSlotMinimumLSN</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN682"><span class='Ref_To_Local'>min_required</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsComputeRequiredLSN &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute the oldest WAL LSN required by *logical* decoding slots.. 
 * 
 * Returns InvalidXLogRecPtr if logical decoding is disabled or no logical 
 * slots exist. 
 * 
 * NB: this returns a value &GT;= ReplicationSlotsComputeRequiredLSN(), since it 
 * ignores physical replication slots. 
 * 
 * The results aren't required frequently, so we don't maintain a precomputed 
 * value like we do for ComputeRequiredLSN() and ComputeRequiredXmin(). 
 */ 
</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN722"></a><span class='Declare_Function'>ReplicationSlotsComputeLogicalRestartLSN</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN724"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span><a name="LN725"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN725"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN725"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN725"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN734"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN735"></a>        <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>restart_lsn</span><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN725"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* cannot change while ReplicationSlotCtlLock is held */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we're only interested in logical slots */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/replication/slot.h.html#LN133"><span class='Ref_to_Macro'>SlotIsLogical</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* read once, it's ok if it increases while we're checking */ 
</span>        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN735"><span class='Ref_To_Local'>restart_lsn</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN734"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN724"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a> <span class='Operator'>|| 
</span>            <a href="slot.c.html#LN735"><span class='Ref_To_Local'>restart_lsn</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN724"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>            <a href="slot.c.html#LN724"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN735"><span class='Ref_To_Local'>restart_lsn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_replication... &raquo; </span> 
 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="slot.c.html#LN724"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsComputeLogicalRestartLSN &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReplicationSlotsCountDBSlots -- count the number of slots that refer to the 
 * passed database oid. 
 * 
 * Returns true if there are any slots referencing the database. *nslots will 
 * be set to the absolute number of slots in the database, *nactive to ones 
 * currently active. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN771"></a><span class='Declare_Function'>ReplicationSlotsCountDBSlots</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dboid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nslots</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nactive</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN773"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>nslots</span></a> <span class='Operator'>= *</span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>nactive</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN773"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN773"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN773"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN783"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN773"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* cannot change while ReplicationSlotCtlLock is held */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only logical slots are database specific, skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/replication/slot.h.html#LN133"><span class='Ref_to_Macro'>SlotIsLogical</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* not our database, skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN43"><span class='Ref_to_Member'>database</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>dboid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* count slots with spinlock held */ 
</span>        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>nslots</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>nactive</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN783"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_replication... &raquo; </span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="slot.c.html#LN771"><span class='Ref_to_Parameter'>nslots</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsCountDBSlots &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReplicationSlotsDropDBSlots -- Drop all db-specific slots relating to the 
 * passed database oid. The caller should hold an exclusive lock on the 
 * pg_database oid for the database to prevent creation of new slots on the db 
 * or replay from existing slots. 
 * 
 * Another session that concurrently acquires an existing slot on the target DB 
 * (most likely to drop it) may cause this function to ERROR. If that happens 
 * it may have dropped some but not all slots. 
 * 
 * This routine isn't as efficient as it could be - but we don't drop 
 * databases often, especially databases with lots of slots. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN827"></a><span class='Declare_Function'>ReplicationSlotsDropDBSlots</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dboid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN829"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
<a name="LN834"></a><span class='Label'>restart</span><span class='Operator'>: 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN829"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN829"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN829"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN838"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span><a name="LN839"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>slotname</span><span class='Delimiter'>; 
</span><a name="LN840"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>active_pid</span><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN829"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* cannot change while ReplicationSlotCtlLock is held */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only logical slots are database specific, skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/replication/slot.h.html#LN133"><span class='Ref_to_Macro'>SlotIsLogical</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* not our database, skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN43"><span class='Ref_to_Member'>database</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN827"><span class='Ref_to_Parameter'>dboid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* acquire slot, so ReplicationSlotDropAcquired can be reused  */ 
</span>        <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* can't change while ReplicationSlotControlLock is held */ 
</span>        <a href="slot.c.html#LN839"><span class='Ref_To_Local'>slotname</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN840"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN840"><span class='Ref_To_Local'>active_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>            <a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><a href="../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN838"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Even though we hold an exclusive lock on the database object a 
         * logical slot for that DB can still be active, e.g. if it's 
         * concurrently being dropped by a backend connected to another DB. 
         * 
         * That's fairly unlikely in practice, so we'll just bail out. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN840"><span class='Ref_To_Local'>active_pid</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_IN_USE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot \"%s\" is active for PID %d"</span><span class='Delimiter'>, 
</span>                            <a href="slot.c.html#LN839"><span class='Ref_To_Local'>slotname</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN840"><span class='Ref_To_Local'>active_pid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * To avoid duplicating ReplicationSlotDropAcquired() and to avoid 
         * holding ReplicationSlotControlLock over filesystem operations, 
         * release ReplicationSlotControlLock and use 
         * ReplicationSlotDropAcquired. 
         * 
         * As that means the set of slots could change, restart scan from the 
         * beginning each time we release the lock. 
         */ 
</span>        <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN101"><span class='Ref_to_Proto'>ReplicationSlotDropAcquired</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="slot.c.html#LN834"><span class='Ref_to_Label'>restart</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_replication... &raquo; </span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotControlLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotsDropDBSlots &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Check whether the server's configuration supports using replication 
 * slots. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN903"></a><span class='Declare_Function'>CheckSlotRequirements</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slots can only be used if max_replication_slots &GT; 0"</span><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../access/transam/xlog.c.html#LN103"><span class='Ref_to_Global_Var'>wal_level</span></a> <span class='Operator'>&LT; </span><a href="../../include/access/xlog.h.html#LN126"><span class='Ref_to_EnumConst'>WAL_LEVEL_REPLICA</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slots can only be used if wal_level &GT;= replica"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Reserve WAL for the currently active slot. 
 * 
 * Compute and set restart_lsn in a manner that's appropriate for the type of 
 * the slot and concurrency safe. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN923"></a><span class='Declare_Function'>ReplicationSlotReserveWal</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN925"></a>    <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span> <span class='Operator'>= </span><a href="slot.c.html#LN95"><span class='Ref_to_Global_Var'>MyReplicationSlot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a> <span class='Operator'>== </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The replication slot mechanism is used to prevent removal of required 
     * WAL. As there is no interlock between this routine and checkpoints, WAL 
     * segments could concurrently be removed when a now stale return value of 
     * ReplicationSlotsComputeRequiredLSN() is used. In the unlikely case that 
     * this happens we'll just retry. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN939"></a>        <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * For logical slots log a standby snapshot and start logical decoding 
         * at exactly that position. That allows the slot to start up more 
         * quickly. 
         * 
         * That's not needed (or indeed helpful) for physical slots as they'll 
         * start replay at the last logged checkpoint anyway. Instead return 
         * the location of the last redo LSN. While that slightly increases 
         * the chance that we have to retry, it's where a base backup has to 
         * start replay at. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="../../include/replication/slot.h.html#LN133"><span class='Ref_to_Macro'>SlotIsLogical</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN954"></a>            <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>flushptr</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* start at current insert position */ 
</span>            <a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlog.h.html#LN248"><span class='Ref_to_Proto'>GetXLogInsertRecPtr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* make sure we have enough information to start */ 
</span>            <a href="slot.c.html#LN954"><span class='Ref_To_Local'>flushptr</span></a> <span class='Operator'>= </span><a href="../../include/storage/standby.h.html#LN86"><span class='Ref_to_Proto'>LogStandbySnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* and make sure it's fsynced to disk */ 
</span>            <a href="../../include/access/xlog.h.html#LN225"><span class='Ref_to_Proto'>XLogFlush</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN954"><span class='Ref_To_Local'>flushptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlog.h.html#LN273"><span class='Ref_to_Proto'>GetRedoRecPtr</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* prevent WAL removal as fast as possible */ 
</span>        <a href="../../include/replication/slot.h.html#LN176"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredLSN</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If all required WAL is still there, great, otherwise retry. The 
         * slot should prevent further removal of WAL, unless there's a 
         * concurrent ReplicationSlotsComputeRequiredLSN() after we've written 
         * the new restart_lsn above, so normally we should never need to loop 
         * more than twice. 
         */ 
</span>        <a href="../../include/access/xlog_internal.h.html#LN105"><span class='Ref_to_Macro'>XLByteToSeg</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN925"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN67"><span class='Ref_to_Member'>restart_lsn</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN939"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog.h.html#LN232"><span class='Ref_to_Proto'>XLogGetLastRemovedSegno</span></a><span class='Parentheses'>() </span><span class='Operator'>&LT; </span><a href="slot.c.html#LN939"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ReplicationSlotReserveWal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Flush all replication slots to disk. 
 * 
 * This needn't actually be part of a checkpoint, but it's a convenient 
 * location. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN993"></a><span class='Declare_Function'>CheckPointReplicationSlots</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN995"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"performing replication slot checkpoint"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prevent any slot from being created/dropped while we're active. As we 
     * explicitly do *not* want to block iterating over replication_slots or 
     * acquiring a slot we cannot take the control lock - but that's OK, 
     * because holding ReplicationSlotAllocationLock is strictly stronger, and 
     * enough to guarantee that nobody can change the in_use bits on us. 
     */ 
</span>    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN995"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN995"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1010"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s</span> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN995"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1011"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN1010"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* save the slot to disk, locking is handled in SaveSlotToPath() */ 
</span>        <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1011"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1010"><span class='Ref_To_Local'>s</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN107"><span class='Ref_to_Proto'>SaveSlotToPath</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1010"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1011"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ReplicationSlotAllocationLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckPointReplicationSlots &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load all replication slots from disk into memory at server startup. This 
 * needs to be run before we start crash recovery. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1028"></a><span class='Declare_Function'>StartupReplicationSlots</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1030"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>replication_dir</span><span class='Delimiter'>; 
</span><a name="LN1031"></a>    <span class='Control'>struct</span> <a href="../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>replication_de</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"starting up replication slots"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore all slots by iterating over all on-disk entries */ 
</span>    <a href="slot.c.html#LN1030"><span class='Ref_To_Local'>replication_dir</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1030"><span class='Ref_To_Local'>replication_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1039"></a>        <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN1040"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Number'>12</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1040"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN1040"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we're only creating directories here, skip if it's not our's */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1040"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1039"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1039"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* we crashed while a slot was being setup or deleted, clean up */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/common/string.h.html#LN12"><span class='Ref_to_Proto'>pg_str_endswith</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".tmp"</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1040"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\""</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1040"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* looks like a slot in a normal state, restore */ 
</span>        <a href="slot.c.html#LN105"><span class='Ref_to_Proto'>RestoreSlotFromDisk</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1031"><span class='Ref_To_Local'>replication_de</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (replication_de=ReadD... &raquo; </span> 
    <a href="../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1030"><span class='Ref_To_Local'>replication_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* currently no slots exist, we're done. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now that we have recovered all the data, compute replication xmin */ 
</span>    <a href="../../include/replication/slot.h.html#LN175"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredXmin</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/replication/slot.h.html#LN176"><span class='Ref_to_Proto'>ReplicationSlotsComputeRequiredLSN</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StartupReplicationSlots &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---- 
 * Manipulation of on-disk state of replication slots 
 * 
 * NB: none of the routines below should take any notice whether a slot is the 
 * current one or not, that's all handled a layer above. 
 * ---- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1088"></a><span class='Declare_Function'>CreateSlotOnDisk</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1090"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1091"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1092"></a>    <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No need to take out the io_in_progress_lock, nobody else can see this 
     * slot yet, so nobody else will write. We're reusing SaveSlotToPath which 
     * takes out the lock, if we'd take the lock here, we'd deadlock. 
     */ 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1091"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1088"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s.tmp"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1088"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN40"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's just barely possible that some previous effort to create or drop a 
     * slot with this name left a temp directory lying around. If that seems 
     * to be the case, try to remove it.  If the rmtree() fails, we'll error 
     * out at the mkdir() below, so we don't bother checking success. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1092"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1092"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
        <a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create and fsync the temporary slot directory. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Write the actual state file. */ 
</span>    <a href="slot.c.html#LN1088"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN97"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* signal that we really need to write */ 
</span>    <a href="slot.c.html#LN107"><span class='Ref_to_Proto'>SaveSlotToPath</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1088"><span class='Ref_to_Parameter'>slot</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Rename the directory into place. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1091"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1090"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1091"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we'd now fail - really unlikely - we wouldn't know whether this slot 
     * would persist after an OS crash or not - so, force a restart. The 
     * restart would try to fsync this again till it works. 
     */ 
</span>    <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1091"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateSlotOnDisk &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Shared functionality between saving and creating a replication slot. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1148"></a><span class='Declare_Function'>SaveSlotToPath</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1150"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tmppath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1151"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1152"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1153"></a>    <a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a> <span class='Declare_Local'>cp</span><span class='Delimiter'>; 
</span><a name="LN1154"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>was_dirty</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* first check whether there's something to write out */ 
</span>    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1154"><span class='Ref_To_Local'>was_dirty</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN97"><span class='Ref_to_Member'>dirty</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN96"><span class='Ref_to_Member'>just_dirtied</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and don't do anything if there's nothing to write */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN1154"><span class='Ref_To_Local'>was_dirty</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN117"><span class='Ref_to_Member'>io_in_progress_lock</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* silence valgrind :( */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><span class='String'>"%s/state.tmp"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1151"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"%s/state"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, 
</span>                           O_CREAT <span class='Operator'>| </span>O_EXCL <span class='Operator'>| </span>O_WRONLY <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/port/win32.h.html#LN424"><span class='Ref_to_Const'>S_IRUSR</span></a> <span class='Operator'>| </span><a href="../../include/port/win32.h.html#LN425"><span class='Ref_to_Const'>S_IWUSR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN60"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN88"><span class='Ref_to_Const'>SLOT_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN61"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN64"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN89"><span class='Ref_to_Const'>SLOT_VERSION</span></a><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN85"><span class='Ref_to_Const'>ReplicationSlotOnDiskV2Size</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN72"><span class='Ref_to_Member'>slotdata</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN37"><span class='Ref_to_Struct'>ReplicationSlotPersistentData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN61"><span class='Ref_to_Member'>checksum</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Delimiter'>, 
</span>                <a href="slot.c.html#LN82"><span class='Ref_to_Const'>SnapBuildOnDiskChecksummedSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN61"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN878"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>)))</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="slot.c.html#LN1153"><span class='Ref_To_Local'>cp</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1205"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="slot.c.html#LN1205"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fsync the temporary file */ 
</span>    <a href="../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN877"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1222"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="slot.c.html#LN1222"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1152"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* rename to permanent file, fsync file and directory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1151"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1150"><span class='Ref_To_Local'>tmppath</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1151"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check CreateSlot() for the reasoning of using a crit. section. */ 
</span>    <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1151"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Successfully wrote, unset dirty bit, unless somebody dirtied again 
     * already. 
     */ 
</span>    <a href="../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN96"><span class='Ref_to_Member'>just_dirtied</span></a><span class='Parentheses'>) 
</span>        <a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN97"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN87"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1148"><span class='Ref_to_Parameter'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN117"><span class='Ref_to_Member'>io_in_progress_lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SaveSlotToPath &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load a single slot from disk into memory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1272"></a><span class='Declare_Function'>RestoreSlotFromDisk</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1274"></a>    <a href="slot.c.html#LN55"><span class='Ref_to_Struct'>ReplicationSlotOnDisk</span></a> <span class='Declare_Local'>cp</span><span class='Delimiter'>; 
</span><a name="LN1275"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1276"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Number'>22</span><span class='Delimiter'>]; 
</span><a name="LN1277"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1278"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>restored</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1279"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>readBytes</span><span class='Delimiter'>; 
</span><a name="LN1280"></a>    <a href="../../include/port/pg_crc32c.h.html#LN37"><span class='Ref_to_Typedef'>pg_crc32c</span></a>   <span class='Declare_Local'>checksum</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no need to lock here, no concurrent access allowed yet */ 
</span> 
    <span class='Comment_Multi_Line'>/* delete temp file if it exists */ 
</span>    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/state.tmp"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1272"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>)</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s/state"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1272"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"restoring replication slot from \"%s\""</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do not need to handle this as we are rename()ing the directory into 
     * place only after we fsync()ed the state file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Sync state file before we're reading from it. We might have crashed 
     * while it wasn't synced yet and we shouldn't continue on that basis. 
     */ 
</span>    <a href="../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN876"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_RESTORE_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Also sync the parent directory */ 
</span>    <a href="../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* read part of statefile that's guaranteed to be version independent */ 
</span>    <a href="../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN875"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN76"><span class='Ref_to_Const'>ReplicationSlotOnDiskConstantSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN76"><span class='Ref_to_Const'>ReplicationSlotOnDiskConstantSize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1332"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>saved_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="slot.c.html#LN1332"><span class='Ref_To_Local'>saved_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %u: %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="slot.c.html#LN76"><span class='Ref_to_Const'>ReplicationSlotOnDiskConstantSize</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* verify magic */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN60"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN88"><span class='Ref_to_Const'>SLOT_MAGIC</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot file \"%s\" has wrong magic number: %u instead of %u"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN60"><span class='Ref_to_Member'>magic</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN88"><span class='Ref_to_Const'>SLOT_MAGIC</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* verify version */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN64"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN89"><span class='Ref_to_Const'>SLOT_VERSION</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>            <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot file \"%s\" has unsupported version %u"</span><span class='Delimiter'>, 
</span>                   <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN64"><span class='Ref_to_Member'>version</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* boundary check on length */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN85"><span class='Ref_to_Const'>ReplicationSlotOnDiskV2Size</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"replication slot file \"%s\" has corrupted length %u"</span><span class='Delimiter'>, 
</span>                      <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now that we know the size, read the entire file */ 
</span>    <a href="../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../include/pgstat.h.html#LN875"><span class='Ref_to_EnumConst'>WAIT_EVENT_REPLICATION_SLOT_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>+ </span><a href="slot.c.html#LN76"><span class='Ref_to_Const'>ReplicationSlotOnDiskConstantSize</span></a><span class='Delimiter'>, 
</span>                     <a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a> <span class='Operator'>!= </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1372"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>saved_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="slot.c.html#LN1372"><span class='Ref_To_Local'>saved_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read file \"%s\", read %d of %u: %m"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1279"><span class='Ref_To_Local'>readBytes</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN65"><span class='Ref_to_Member'>length</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1277"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* now verify the CRC */ 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN40"><span class='Ref_to_Macro'>INIT_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1280"><span class='Ref_To_Local'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN45"><span class='Ref_to_Macro'>COMP_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1280"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a> <span class='Operator'>+ </span><a href="slot.c.html#LN79"><span class='Ref_to_Const'>SnapBuildOnDiskNotChecksummedSize</span></a><span class='Delimiter'>, 
</span>                <a href="slot.c.html#LN82"><span class='Ref_to_Const'>SnapBuildOnDiskChecksummedSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port/pg_crc32c.h.html#LN47"><span class='Ref_to_Macro'>FIN_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1280"><span class='Ref_To_Local'>checksum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port/pg_crc32c.h.html#LN41"><span class='Ref_to_Macro'>EQ_CRC32C</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1280"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN61"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"checksum mismatch for replication slot file \"%s\": is %u, should be %u"</span><span class='Delimiter'>, 
</span>                        <a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1280"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN61"><span class='Ref_to_Member'>checksum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we crashed with an ephemeral slot active, don't restore but delete 
     * it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN72"><span class='Ref_to_Member'>slotdata</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN48"><span class='Ref_to_Member'>persistency</span></a> <span class='Operator'>!= </span><a href="../../include/replication/slot.h.html#LN29"><span class='Ref_to_EnumConst'>RS_PERSISTENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='String'>"pg_replslot/%s"</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1272"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove directory \"%s\""</span><span class='Delimiter'>, </span><a href="slot.c.html#LN1276"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><span class='String'>"pg_replslot"</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* nothing can be active yet, don't lock anything */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1275"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="slot.c.html#LN1275"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="slot.c.html#LN98"><span class='Ref_to_Global_Var'>max_replication_slots</span></a><span class='Delimiter'>; </span><a href="slot.c.html#LN1275"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1417"></a>        <a href="../../include/replication/slot.h.html#LN84"><span class='Ref_to_Struct'>ReplicationSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= &</span><a href="slot.c.html#LN92"><span class='Ref_to_Global_Var'>ReplicationSlotCtl</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN144"><span class='Ref_to_Member'>replication_slots</span></a><span class='Delimiter'>[</span><a href="slot.c.html#LN1275"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* restore the entire set of persistent data */ 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN114"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN72"><span class='Ref_to_Member'>slotdata</span></a><span class='Delimiter'>, 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/replication/slot.h.html#LN37"><span class='Ref_to_Struct'>ReplicationSlotPersistentData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* initialize in memory state */ 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN110"><span class='Ref_to_Member'>effective_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN72"><span class='Ref_to_Member'>slotdata</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN56"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN111"><span class='Ref_to_Member'>effective_catalog_xmin</span></a> <span class='Operator'>= </span><a href="slot.c.html#LN1274"><span class='Ref_To_Local'>cp</span></a><span class='Operator'>.</span><a href="slot.c.html#LN72"><span class='Ref_to_Member'>slotdata</span></a><span class='Operator'>.</span><a href="../../include/replication/slot.h.html#LN64"><span class='Ref_to_Member'>catalog_xmin</span></a><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN126"><span class='Ref_to_Member'>candidate_catalog_xmin</span></a> <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN127"><span class='Ref_to_Member'>candidate_xmin_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN129"><span class='Ref_to_Member'>candidate_restart_lsn</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN128"><span class='Ref_to_Member'>candidate_restart_valid</span></a> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN90"><span class='Ref_to_Member'>in_use</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="slot.c.html#LN1417"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../include/replication/slot.h.html#LN93"><span class='Ref_to_Member'>active_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="slot.c.html#LN1278"><span class='Ref_To_Local'>restored</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;max_replication... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="slot.c.html#LN1278"><span class='Ref_To_Local'>restored</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"too many replication slots active before shutdown"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Increase max_replication_slots and try again."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RestoreSlotFromDisk &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>