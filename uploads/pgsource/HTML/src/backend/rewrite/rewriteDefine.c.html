<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\rewrite\rewriteDefine.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\rewrite\rewriteDefine.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:47 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * rewriteDefine.c 
 *    routines for defining a rewrite rule 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/rewrite/rewriteDefine.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/heap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_rewrite.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/storage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/policy.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_utilcmd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteDefine.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteManip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteSupport.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<a name="LN46"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>checkRuleResultList</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetList</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>resultDesc</span><span class='Delimiter'>, 
</span><a name="LN47"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>isSelect</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>requireColumnNameMatch</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN48"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>setRuleCheckAsUser_walker</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>setRuleCheckAsUser_Query</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qry</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * InsertRule - 
 *    takes the arguments and inserts them as a row into the system 
 *    relation "pg_rewrite" 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN58"></a><span class='Declare_Function'>InsertRule</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rulname</span><span class='Delimiter'>, 
</span><a name="LN59"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>evtype</span><span class='Delimiter'>, 
</span><a name="LN60"></a>           <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>eventrel_oid</span><span class='Delimiter'>, 
</span><a name="LN61"></a>           <span class='Keyword'>bool </span><span class='Declare_Parameter'>evinstead</span><span class='Delimiter'>, 
</span><a name="LN62"></a>           <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event_qual</span><span class='Delimiter'>, 
</span><a name="LN63"></a>           <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Delimiter'>, 
</span><a name="LN64"></a>           <span class='Keyword'>bool </span><span class='Declare_Parameter'>replace</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN66"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>evqual</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN62"><span class='Ref_to_Parameter'>event_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>actiontree</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN598"><span class='Ref_to_Proto'>nodeToString</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN63"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a>    <a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN58"><span class='Ref_to_Const'>Natts_pg_rewrite</span></a><span class='Delimiter'>]; 
</span><a name="LN69"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN58"><span class='Ref_to_Const'>Natts_pg_rewrite</span></a><span class='Delimiter'>]; 
</span><a name="LN70"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replaces</span><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN58"><span class='Ref_to_Const'>Natts_pg_rewrite</span></a><span class='Delimiter'>]; 
</span><a name="LN71"></a>    <a href="../../include/c.h.html#LN492"><span class='Ref_to_Typedef'>NameData</span></a>    <span class='Declare_Local'>rname</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_rewrite_desc</span><span class='Delimiter'>; 
</span><a name="LN73"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>, 
</span><a name="LN74"></a>                <span class='Declare_Local'>oldtup</span><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>rewriteObjectId</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>myself</span><span class='Delimiter'>, 
</span><a name="LN77"></a>                <span class='Declare_Local'>referenced</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_update</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up *nulls and *values arrays 
     */ 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN69"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN69"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN71"><span class='Ref_To_Local'>rname</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN58"><span class='Ref_to_Parameter'>rulname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN59"><span class='Ref_to_Const'>Anum_pg_rewrite_rulename</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN600"><span class='Ref_to_Macro'>NameGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN71"><span class='Ref_To_Local'>rname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN60"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_class</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN60"><span class='Ref_to_Parameter'>eventrel_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN61"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_type</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN59"><span class='Ref_to_Parameter'>evtype</span></a> <span class='Operator'>+ </span><span class='String'>'0'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN62"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_enabled</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteDefine.h.html#LN20"><span class='Ref_to_Const'>RULE_FIRES_ON_ORIGIN</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_rewrite_is_instead</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN61"><span class='Ref_to_Parameter'>evinstead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN64"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_qual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN66"><span class='Ref_To_Local'>evqual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN65"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_action</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN67"><span class='Ref_To_Local'>actiontree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ready to store new pg_rewrite tuple 
     */ 
</span>    <a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to see if we are replacing an existing tuple 
     */ 
</span>    <a href="rewriteDefine.c.html#LN74"><span class='Ref_To_Local'>oldtup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN157"><span class='Ref_to_Macro'>SearchSysCache2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN86"><span class='Ref_to_EnumConst'>RULERELNAME</span></a><span class='Delimiter'>, 
</span>                             <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN60"><span class='Ref_to_Parameter'>eventrel_oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN58"><span class='Ref_to_Parameter'>rulname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN74"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteDefine.c.html#LN64"><span class='Ref_to_Parameter'>replace</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule \"%s\" for relation \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN58"><span class='Ref_to_Parameter'>rulname</span></a><span class='Delimiter'>, </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN60"><span class='Ref_to_Parameter'>eventrel_oid</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * When replacing, we don't need to replace every attribute 
         */ 
</span>        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN61"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_type</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN63"><span class='Ref_to_Const'>Anum_pg_rewrite_is_instead</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN64"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_qual</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Delimiter'>[</span><a href="../../include/catalog/pg_rewrite.h.html#LN65"><span class='Ref_to_Const'>Anum_pg_rewrite_ev_action</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN74"><span class='Ref_To_Local'>oldtup</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN69"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN70"><span class='Ref_To_Local'>replaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN74"><span class='Ref_To_Local'>oldtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN78"><span class='Ref_To_Local'>is_update</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HeapTupleIsValid(oldt... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN68"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN69"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/indexing.h.html#LN32"><span class='Ref_to_Proto'>CatalogTupleInsert</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN73"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If replacing, get rid of old dependencies and make new ones */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN78"><span class='Ref_To_Local'>is_update</span></a><span class='Parentheses'>) 
</span>        <a href="../catalog/pg_depend.c.html#LN189"><span class='Ref_to_Func'>deleteDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Install dependency on rule's relation to ensure it will go away on 
     * relation deletion.  If the rule is ON SELECT, make the dependency 
     * implicit --- this prevents deleting a view's SELECT rule.  Other kinds 
     * of rules can be AUTO. 
     */ 
</span>    <a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteDefine.c.html#LN77"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN77"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN60"><span class='Ref_to_Parameter'>eventrel_oid</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN77"><span class='Ref_To_Local'>referenced</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../catalog/pg_depend.c.html#LN42"><span class='Ref_to_Func'>recordDependencyOn</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN77"><span class='Ref_To_Local'>referenced</span></a><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN59"><span class='Ref_to_Parameter'>evtype</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../include/catalog/dependency.h.html#LN76"><span class='Ref_to_EnumConst'>DEPENDENCY_INTERNAL</span></a> <span class='Operator'>: </span><a href="../../include/catalog/dependency.h.html#LN75"><span class='Ref_to_EnumConst'>DEPENDENCY_AUTO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also install dependencies on objects referenced in action and qual. 
     */ 
</span>    <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN63"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN62"><span class='Ref_to_Parameter'>event_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Find query containing OLD/NEW rtable entries */ 
</span><a name="LN173"></a>        <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>qry</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN63"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN173"><span class='Ref_To_Local'>qry</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN52"><span class='Ref_to_Proto'>getInsertSelectQuery</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN173"><span class='Ref_To_Local'>qry</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/dependency.h.html#LN188"><span class='Ref_to_Proto'>recordDependencyOnExpr</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN76"><span class='Ref_To_Local'>myself</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN62"><span class='Ref_to_Parameter'>event_qual</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN173"><span class='Ref_To_Local'>qry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Delimiter'>, 
</span>                               <a href="../../include/catalog/dependency.h.html#LN74"><span class='Ref_to_EnumConst'>DEPENDENCY_NORMAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Post creation hook for new rule */ 
</span>    <a href="../../include/catalog/objectaccess.h.html#LN144"><span class='Ref_to_Macro'>InvokeObjectPostCreateHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN72"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteDefine.c.html#LN75"><span class='Ref_To_Local'>rewriteObjectId</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InsertRule &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DefineRule 
 *      Execute a CREATE RULE command. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN193"></a><span class='Declare_Function'>DefineRule</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN2841"><span class='Ref_to_Struct'>RuleStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>queryString</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN195"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>actions</span><span class='Delimiter'>; 
</span><a name="LN196"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>whereClause</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relId</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse analysis. */ 
</span>    <a href="../../include/parser/parse_utilcmd.h.html#LN24"><span class='Ref_to_Proto'>transformRuleStmt</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>queryString</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN195"><span class='Ref_To_Local'>actions</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN196"><span class='Ref_To_Local'>whereClause</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find and lock the relation.  Lock level should match 
     * DefineQueryRewrite. 
     */ 
</span>    <a href="rewriteDefine.c.html#LN197"><span class='Ref_To_Local'>relId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN52"><span class='Ref_to_Macro'>RangeVarGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2844"><span class='Ref_to_Member'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ... and execute */ 
</span>    <span class='Control'>return</span> <a href="../../include/rewrite/rewriteDefine.h.html#LN27"><span class='Ref_to_Proto'>DefineQueryRewrite</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2845"><span class='Ref_to_Member'>rulename</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN197"><span class='Ref_To_Local'>relId</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN196"><span class='Ref_To_Local'>whereClause</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2847"><span class='Ref_to_Member'>event</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2848"><span class='Ref_to_Member'>instead</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN193"><span class='Ref_to_Parameter'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN2850"><span class='Ref_to_Member'>replace</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteDefine.c.html#LN195"><span class='Ref_To_Local'>actions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DefineRule &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * DefineQueryRewrite 
 *      Create a rule 
 * 
 * This is essentially the same as DefineRule() except that the rule's 
 * action and qual have already been passed through parse analysis. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN227"></a><span class='Declare_Function'>DefineQueryRewrite</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rulename</span><span class='Delimiter'>, 
</span><a name="LN228"></a>                   <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>event_relid</span><span class='Delimiter'>, 
</span><a name="LN229"></a>                   <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event_qual</span><span class='Delimiter'>, 
</span><a name="LN230"></a>                   <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event_type</span><span class='Delimiter'>, 
</span><a name="LN231"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>is_instead</span><span class='Delimiter'>, 
</span><a name="LN232"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>replace</span><span class='Delimiter'>, 
</span><a name="LN233"></a>                   <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN235"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>event_relation</span><span class='Delimiter'>; 
</span><a name="LN236"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN237"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span><span class='Delimiter'>; 
</span><a name="LN238"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>RelisBecomingView</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN239"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>ruleId</span> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN240"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are installing an ON SELECT rule, we had better grab 
     * AccessExclusiveLock to ensure no SELECTs are currently running on the 
     * event relation. For other types of rules, it would be sufficient to 
     * grab ShareRowExclusiveLock to lock out insert/update/delete actions and 
     * to ensure that we lock out current CREATE RULE statements; but because 
     * of race conditions in access to catalog entries, we can't do that yet. 
     * 
     * Note that this lock level should match the one used in DefineRule. 
     */ 
</span>    <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify relation is of a type that rules can sensibly be applied to. 
     * Internal callers can target materialized views, but transformRuleStmt() 
     * blocks them for users.  Don't mention them in the error message. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table or view"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN29"><span class='Ref_to_Proto'>IsSystemRelation</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied: \"%s\" is a system catalog"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check user has permission to apply rules to this relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No rule actions that modify OLD or NEW 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN236"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN236"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Don't be fooled by INSERT/SELECT */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>!= </span><a href="../../include/rewrite/rewriteManip.h.html#LN52"><span class='Ref_to_Proto'>getInsertSelectQuery</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>== </span><a href="../../include/nodes/primnodes.h.html#LN159"><span class='Ref_to_Const'>PRS2_OLD_VARNO</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule actions on OLD are not implemented"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use views or triggers instead."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>== </span><a href="../../include/nodes/primnodes.h.html#LN160"><span class='Ref_to_Const'>PRS2_NEW_VARNO</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule actions on NEW are not implemented"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use triggers instead."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN230"><span class='Ref_to_Parameter'>event_type</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Rules ON SELECT are restricted to view definitions 
         * 
         * So there cannot be INSTEAD NOTHING, ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"INSTEAD NOTHING rules on SELECT are not implemented"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use views instead."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... there cannot be multiple actions, ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multiple actions for rules on SELECT are not implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... the one action must be a SELECT, ... 
         */ 
</span>        <a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteDefine.c.html#LN231"><span class='Ref_to_Parameter'>is_instead</span></a> <span class='Operator'>|| 
</span>            <a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rules on SELECT must have action INSTEAD SELECT"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... it cannot contain data-modifying WITH ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN128"><span class='Ref_to_Member'>hasModifyingCTE</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rules on SELECT must not contain data-modifying statements in WITH"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... there can be no rule qual, ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN229"><span class='Ref_to_Parameter'>event_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"event qualifications are not implemented for rules on SELECT"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... the targetlist of the SELECT action must exactly match the 
         * event relation, ... 
         */ 
</span>        <a href="rewriteDefine.c.html#LN46"><span class='Ref_to_Proto'>checkRuleResultList</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= 
</span>                            <a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... there must not be another ON SELECT rule already ... 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteDefine.c.html#LN232"><span class='Ref_to_Parameter'>replace</span></a> <span class='Operator'>&& </span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN366"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN366"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="rewriteDefine.c.html#LN366"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a><span class='Delimiter'>; </span><a href="rewriteDefine.c.html#LN366"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN370"></a>                <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rule</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteDefine.c.html#LN370"><span class='Ref_To_Local'>rule</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteDefine.c.html#LN366"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN370"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is already a view"</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * ... and finally the rule must be named _RETURN. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN227"><span class='Ref_to_Parameter'>rulename</span></a><span class='Delimiter'>, </span><a href="../../include/rewrite/rewriteSupport.h.html#LN17"><span class='Ref_to_Const'>ViewSelectRuleName</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * In versions before 7.3, the expected name was _RETviewname. For 
             * backwards compatibility with old pg_dump output, accept that 
             * and silently change it to _RETURN.  Since this is just a quick 
             * backwards-compatibility hack, limit the number of characters 
             * checked to a few less than NAMEDATALEN; this saves having to 
             * worry about where a multibyte character might have gotten 
             * truncated. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN227"><span class='Ref_to_Parameter'>rulename</span></a><span class='Delimiter'>, </span><span class='String'>"_RET"</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                strncmp<span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN227"><span class='Ref_to_Parameter'>rulename</span></a> <span class='Operator'>+ </span><span class='Number'>4</span><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>- </span><span class='Number'>4</span> <span class='Operator'>- </span><span class='Number'>4</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"view rule for \"%s\" must be named \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../../include/rewrite/rewriteSupport.h.html#LN17"><span class='Ref_to_Const'>ViewSelectRuleName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN227"><span class='Ref_to_Parameter'>rulename</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteSupport.h.html#LN17"><span class='Ref_to_Const'>ViewSelectRuleName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(rulename,ViewS... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Are we converting a relation to a view? 
         * 
         * If so, check that the relation is empty because the storage for the 
         * relation is going to be deleted.  Also insist that the rel not have 
         * any triggers, indexes, child tables, policies, or RLS enabled. 
         * (Note: these tests are too strict, because they will reject 
         * relations that once had such but don't anymore.  But we don't 
         * really care, because this whole business of converting relations to 
         * views is just a kluge to allow dump/reload of views that 
         * participate in circular dependencies.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>            <a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN421"></a>            <a href="../../include/access/heapam.h.html#LN99"><span class='Ref_to_Typedef'>HeapScanDesc</span></a> <span class='Declare_Local'>scanDesc</span><span class='Delimiter'>; 
</span><a name="LN422"></a>            <a href="../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert partitioned table \"%s\" to a view"</span><span class='Delimiter'>, 
</span>                       <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteDefine.c.html#LN422"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../include/utils/snapmgr.h.html#LN80"><span class='Ref_to_Proto'>RegisterSnapshot</span></a><span class='Parentheses'>(</span><a href="../../include/utils/snapmgr.h.html#LN64"><span class='Ref_to_Proto'>GetLatestSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN421"><span class='Ref_To_Local'>scanDesc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN108"><span class='Ref_to_Proto'>heap_beginscan</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN422"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/heapam.h.html#LN127"><span class='Ref_to_Proto'>heap_getnext</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN421"><span class='Ref_To_Local'>scanDesc</span></a><span class='Delimiter'>, </span><a href="../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it is not empty"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <a href="../../include/access/heapam.h.html#LN126"><span class='Ref_to_Proto'>heap_endscan</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN421"><span class='Ref_To_Local'>scanDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/utils/snapmgr.h.html#LN81"><span class='Ref_to_Proto'>UnregisterSnapshot</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN422"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhastriggers<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it has triggers"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"In particular, the table cannot be involved in any foreign key relationships."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhasindex<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it has indexes"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relhassubclass<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it has child tables"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relrowsecurity<span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it has row security enabled"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/commands/policy.h.html#LN35"><span class='Ref_to_Proto'>relation_has_policies</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))</span> 
                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not convert table \"%s\" to a view because it has row security policies"</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteDefine.c.html#LN238"><span class='Ref_To_Local'>RelisBecomingView</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if event_relation-&GT;rd_re... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if event_type==CMD_SELEC... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * For non-SELECT rules, a RETURNING list can appear in at most one of 
         * the actions ... and there can't be any RETURNING list at all in a 
         * conditional or non-INSTEAD rule.  (Actually, there can be at most 
         * one RETURNING list across all rules on the same event, but it seems 
         * best to enforce that at rule expansion time.)  If there is a 
         * RETURNING list, it must match the event relation. 
         */ 
</span><a name="LN484"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveReturning</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN236"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN236"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN484"><span class='Ref_To_Local'>haveReturning</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                  <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot have multiple RETURNING lists in a rule"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN484"><span class='Ref_To_Local'>haveReturning</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN229"><span class='Ref_to_Parameter'>event_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING lists are not supported in conditional rules"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteDefine.c.html#LN231"><span class='Ref_to_Parameter'>is_instead</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING lists are not supported in non-INSTEAD rules"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN46"><span class='Ref_to_Proto'>checkRuleResultList</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN237"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * This rule is allowed - prepare to install it. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* discard rule if it's null action and not INSTEAD; it's a no-op */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>|| </span><a href="rewriteDefine.c.html#LN231"><span class='Ref_to_Parameter'>is_instead</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="rewriteDefine.c.html#LN239"><span class='Ref_To_Local'>ruleId</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN57"><span class='Ref_to_Func'>InsertRule</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN227"><span class='Ref_to_Parameter'>rulename</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN230"><span class='Ref_to_Parameter'>event_type</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN231"><span class='Ref_to_Parameter'>is_instead</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN229"><span class='Ref_to_Parameter'>event_qual</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN233"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN232"><span class='Ref_to_Parameter'>replace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Set pg_class 'relhasrules' field TRUE for event relation. 
         * 
         * Important side effect: an SI notice is broadcast to force all 
         * backends (including me!) to update relcache entries with the new 
         * rule. 
         */ 
</span>        <a href="../../include/rewrite/rewriteSupport.h.html#LN21"><span class='Ref_to_Proto'>SetRelationRuleStatus</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* --------------------------------------------------------------------- 
     * If the relation is becoming a view: 
     * - delete the associated storage files 
     * - get rid of any system attributes in pg_attribute; a view shouldn't 
     *   have any of those 
     * - remove the toast table; there is no need for it anymore, and its 
     *   presence would make vacuum slightly more complicated 
     * - set relkind to RELKIND_VIEW, and adjust other pg_class fields 
     *   to be appropriate for a view 
     * 
     * NB: we had better have AccessExclusiveLock to do this ... 
     * --------------------------------------------------------------------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN238"><span class='Ref_To_Local'>RelisBecomingView</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN551"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>relationRelation</span><span class='Delimiter'>; 
</span><a name="LN552"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>toastrelid</span><span class='Delimiter'>; 
</span><a name="LN553"></a>        <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>classTup</span><span class='Delimiter'>; 
</span><a name="LN554"></a>        <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classForm</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN551"><span class='Ref_To_Local'>relationRelation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN552"><span class='Ref_To_Local'>toastrelid</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>reltoastrelid<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* drop storage while table still looks like a table  */ 
</span>        <a href="../../include/catalog/storage.h.html#LN21"><span class='Ref_to_Proto'>RelationDropStorage</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/heap.h.html#LN115"><span class='Ref_to_Proto'>DeleteSystemAttributeTuples</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Drop the toast table if any.  (This won't take care of updating the 
         * toast fields in the relation's own pg_class entry; we handle that 
         * below.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN552"><span class='Ref_To_Local'>toastrelid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN570"></a>            <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>toastobject</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Delete the dependency of the toast relation on the main 
             * relation so we can drop the former without dropping the latter. 
             */ 
</span>            <a href="../catalog/pg_depend.c.html#LN189"><span class='Ref_to_Func'>deleteDependencyRecordsFor</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN552"><span class='Ref_To_Local'>toastrelid</span></a><span class='Delimiter'>, 
</span>                                       <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Make deletion of dependency record visible */ 
</span>            <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Now drop toast table, including its index */ 
</span>            <a href="rewriteDefine.c.html#LN570"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN570"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN552"><span class='Ref_To_Local'>toastrelid</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteDefine.c.html#LN570"><span class='Ref_To_Local'>toastobject</span></a><span class='Operator'>.</span><a href="../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../include/catalog/dependency.h.html#LN182"><span class='Ref_to_Proto'>performDeletion</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN570"><span class='Ref_To_Local'>toastobject</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN1654"><span class='Ref_to_EnumConst'>DROP_RESTRICT</span></a><span class='Delimiter'>, 
</span>                            <a href="../../include/catalog/dependency.h.html#LN173"><span class='Ref_to_Const'>PERFORM_DELETION_INTERNAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OidIsValid(toastrelid... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * SetRelationRuleStatus may have updated the pg_class row, so we must 
         * advance the command counter before trying to update it again. 
         */ 
</span>        <a href="../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fix pg_class entry to look like a normal view's, including setting 
         * the correct relkind and removal of reltoastrelid of the toast table 
         * we potentially removed above. 
         */ 
</span>        <a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN164"><span class='Ref_to_Macro'>SearchSysCacheCopy1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>))</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN228"><span class='Ref_to_Parameter'>event_relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>reltablespace <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relpages <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>reltuples <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relallvisible <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>reltoastrelid <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relhasindex <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relhasoids <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relhaspkey <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relfrozenxid <span class='Operator'>= </span><a href="../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relminmxid <span class='Operator'>= </span><a href="../../include/access/multixact.h.html#LN22"><span class='Ref_to_Const'>InvalidMultiXactId</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN554"><span class='Ref_To_Local'>classForm</span></a><span class='Operator'>-&GT;</span>relreplident <span class='Operator'>= </span><a href="../../include/catalog/pg_class.h.html#LN176"><span class='Ref_to_Const'>REPLICA_IDENTITY_NOTHING</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN551"><span class='Ref_To_Local'>relationRelation</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN553"><span class='Ref_To_Local'>classTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN551"><span class='Ref_To_Local'>relationRelation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelisBecomingView &raquo; </span> 
 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN240"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN239"><span class='Ref_To_Local'>ruleId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close rel, but keep lock till commit... */ 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN235"><span class='Ref_To_Local'>event_relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteDefine.c.html#LN240"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DefineQueryRewrite &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * checkRuleResultList 
 *      Verify that targetList produces output compatible with a tupledesc 
 * 
 * The targetList might be either a SELECT targetlist, or a RETURNING list; 
 * isSelect tells which.  This is used for choosing error messages. 
 * 
 * A SELECT targetlist may optionally require that column names match. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN643"></a><span class='Declare_Function'>checkRuleResultList</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetList</span><span class='Delimiter'>, </span><a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>resultDesc</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isSelect</span><span class='Delimiter'>, 
</span><a name="LN644"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>requireColumnNameMatch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN646"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>tllist</span><span class='Delimiter'>; 
</span><a name="LN647"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Only a SELECT may require a column name match. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>|| !</span><a href="rewriteDefine.c.html#LN644"><span class='Ref_to_Parameter'>requireColumnNameMatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN646"><span class='Ref_To_Local'>tllist</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>targetList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN655"></a>        <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN646"><span class='Ref_To_Local'>tllist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN656"></a>        <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tletypid</span><span class='Delimiter'>; 
</span><a name="LN657"></a>        <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tletypmod</span><span class='Delimiter'>; 
</span><a name="LN658"></a>        <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>attr</span><span class='Delimiter'>; 
</span><a name="LN659"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attname</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* resjunk entries may be ignored */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN655"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>resultDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                   <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT rule's target list has too many entries"</span><span class='Parentheses'>) </span><span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list has too many entries"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>resultDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>        <a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a> <span class='Operator'>= </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Disallow dropped columns in the relation.  This is not really 
         * expected to happen when creating an ON SELECT rule.  It'd be 
         * possible if someone tried to convert a relation with dropped 
         * columns to a view, but the only case we care about supporting 
         * table-to-view conversion for is pg_dump, and pg_dump won't do that. 
         * 
         * Unfortunately, the situation is also possible when adding a rule 
         * with RETURNING to a regular table, and rejecting that case is 
         * altogether more annoying.  In principle we could support it by 
         * modifying the targetlist to include dummy NULL columns 
         * corresponding to the dropped columns in the tupdesc.  However, 
         * places like ruleutils.c would have to be fixed to not process such 
         * entries, and that would take an uncertain and possibly rather large 
         * amount of work.  (Note we could not dodge that by marking the dummy 
         * columns resjunk, since it's precisely the non-resjunk tlist columns 
         * that are expected to correspond to table columns.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot convert relation containing dropped columns to view"</span><span class='Parentheses'>) </span><span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot create a RETURNING list for a relation containing dropped columns"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check name match if required; no need for two error texts here */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN644"><span class='Ref_to_Parameter'>requireColumnNameMatch</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN655"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1368"><span class='Ref_to_Member'>resname</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT rule's target entry %d has different column name from column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT target entry is named \"%s\"."</span><span class='Delimiter'>, 
</span>                               <a href="rewriteDefine.c.html#LN655"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1368"><span class='Ref_to_Member'>resname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check type match. */ 
</span>        <a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN655"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT rule's target entry %d has different type from column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list's entry %d has different type from column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT target entry has type %s, but column has type %s."</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>))</span> <span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list entry has type %s, but column has type %s."</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allow typmods to be different only if one of them is -1, ie, 
         * "unspecified".  This is necessary for cases like "numeric", where 
         * the table will have a filled-in default length but the select 
         * rule's expression will probably have typmod = -1. 
         */ 
</span>        <a href="rewriteDefine.c.html#LN657"><span class='Ref_To_Local'>tletypmod</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN32"><span class='Ref_to_Proto'>exprTypmod</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN655"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypmod <span class='Operator'>!= </span><a href="rewriteDefine.c.html#LN657"><span class='Ref_To_Local'>tletypmod</span></a> <span class='Operator'>&& 
</span>            <a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypmod <span class='Operator'>!= -</span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="rewriteDefine.c.html#LN657"><span class='Ref_To_Local'>tletypmod</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT rule's target entry %d has different size from column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list's entry %d has different size from column \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN659"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT target entry has type %s, but column has type %s."</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN657"><span class='Ref_To_Local'>tletypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                        <a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>))</span> <span class='Operator'>: 
</span>                     <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list entry has type %s, but column has type %s."</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN656"><span class='Ref_To_Local'>tletypid</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN657"><span class='Ref_To_Local'>tletypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                               <a href="../utils/adt/format_type.c.html#LN111"><span class='Ref_to_Func'>format_type_with_typemod</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                        <a href="rewriteDefine.c.html#LN658"><span class='Ref_To_Local'>attr</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>!= </span><a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>resultDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="rewriteDefine.c.html#LN643"><span class='Ref_to_Parameter'>isSelect</span></a> <span class='Operator'>? 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SELECT rule's target list has too few entries"</span><span class='Parentheses'>) </span><span class='Operator'>: 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"RETURNING list has too few entries"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end checkRuleResultList &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * setRuleCheckAsUser 
 *      Recursively scan a query or expression tree and set the checkAsUser 
 *      field to the given userid in all rtable entries. 
 * 
 * Note: for a view (ON SELECT rule), the checkAsUser field of the OLD 
 * RTE entry will be overridden when the view rule is expanded, and the 
 * checkAsUser field of the NEW entry is irrelevant because that entry's 
 * requiredPerms bits will always be zero.  However, for other types of rules 
 * it's important to set these fields to match the rule owner.  So we just set 
 * them always. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN775"></a><span class='Declare_Function'>setRuleCheckAsUser</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN48"><span class='Ref_to_Proto'>setRuleCheckAsUser_walker</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN775"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN775"><span class='Ref_to_Parameter'>userid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN781"></a><span class='Declare_Function'>setRuleCheckAsUser_walker</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>node</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="rewriteDefine.c.html#LN49"><span class='Ref_to_Proto'>setRuleCheckAsUser_Query</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN48"><span class='Ref_to_Proto'>setRuleCheckAsUser_walker</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteDefine.c.html#LN781"><span class='Ref_to_Parameter'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN795"></a><span class='Declare_Function'>setRuleCheckAsUser_Query</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qry</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN797"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set all the RTEs in this query node */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN797"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>qry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN802"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN797"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN802"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Recurse into subquery in FROM */ 
</span>            <a href="rewriteDefine.c.html#LN49"><span class='Ref_to_Proto'>setRuleCheckAsUser_Query</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN802"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>userid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="rewriteDefine.c.html#LN802"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a> <span class='Operator'>= </span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Recurse into subquery-in-WITH */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN797"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>qry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN816"></a>        <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN797"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN49"><span class='Ref_to_Proto'>setRuleCheckAsUser_Query</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN575"><span class='Ref_to_Macro'>castNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN816"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>userid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If there are sublinks, search for them and process their RTEs */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>qry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/nodes/nodeFuncs.h.html#LN57"><span class='Ref_to_Proto'>query_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN48"><span class='Ref_to_Proto'>setRuleCheckAsUser_walker</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN795"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/nodes/nodeFuncs.h.html#LN21"><span class='Ref_to_Const'>QTW_IGNORE_RC_SUBQUERIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end setRuleCheckAsUser_Query &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Change the firing semantics of an existing rule. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN832"></a><span class='Declare_Function'>EnableDisableRule</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rulename</span><span class='Delimiter'>, 
</span><a name="LN833"></a>                  <span class='Keyword'>char </span><span class='Declare_Parameter'>fires_when</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN835"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_rewrite_desc</span><span class='Delimiter'>; 
</span><a name="LN836"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>owningRel</span> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN832"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN837"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>eventRelationOid</span><span class='Delimiter'>; 
</span><a name="LN838"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>ruletup</span><span class='Delimiter'>; 
</span><a name="LN839"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>changed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find the rule tuple to change. 
     */ 
</span>    <a href="rewriteDefine.c.html#LN835"><span class='Ref_To_Local'>pg_rewrite_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN166"><span class='Ref_to_Macro'>SearchSysCacheCopy2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN86"><span class='Ref_to_EnumConst'>RULERELNAME</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN836"><span class='Ref_To_Local'>owningRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN832"><span class='Ref_to_Parameter'>rulename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule \"%s\" for relation \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="rewriteDefine.c.html#LN832"><span class='Ref_to_Parameter'>rulename</span></a><span class='Delimiter'>, </span><a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN836"><span class='Ref_To_Local'>owningRel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify that the user has appropriate permissions. 
     */ 
</span>    <a href="rewriteDefine.c.html#LN837"><span class='Ref_To_Local'>eventRelationOid</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/catalog/pg_rewrite.h.html#LN52"><span class='Ref_to_Typedef'>Form_pg_rewrite</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>ev_class<span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN837"><span class='Ref_To_Local'>eventRelationOid</span></a> <span class='Operator'>== </span><a href="rewriteDefine.c.html#LN836"><span class='Ref_To_Local'>owningRel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN837"><span class='Ref_To_Local'>eventRelationOid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, 
</span>                       <a href="../../include/utils/lsyscache.h.html#LN124"><span class='Ref_to_Proto'>get_rel_name</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN837"><span class='Ref_To_Local'>eventRelationOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Change ev_enabled if it is different from the desired new state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN414"><span class='Ref_to_Macro'>DatumGetChar</span></a><span class='Parentheses'>(((</span><a href="../../include/catalog/pg_rewrite.h.html#LN52"><span class='Ref_to_Typedef'>Form_pg_rewrite</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>ev_enabled<span class='Parentheses'>)</span> <span class='Operator'>!= 
</span>        <a href="rewriteDefine.c.html#LN833"><span class='Ref_to_Parameter'>fires_when</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>((</span><a href="../../include/catalog/pg_rewrite.h.html#LN52"><span class='Ref_to_Typedef'>Form_pg_rewrite</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>ev_enabled <span class='Operator'>= 
</span>            <a href="../../include/postgres.h.html#LN421"><span class='Ref_to_Macro'>CharGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN833"><span class='Ref_to_Parameter'>fires_when</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN835"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteDefine.c.html#LN839"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/catalog/objectaccess.h.html#LN162"><span class='Ref_to_Macro'>InvokeObjectPostAlterHook</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN838"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN835"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we changed anything, broadcast a SI inval message to force each 
     * backend (including our own!) to rebuild relation's relcache entry. 
     * Otherwise they will fail to apply the change promptly. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN839"><span class='Ref_To_Local'>changed</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN832"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end EnableDisableRule &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Perform permissions and integrity checks before acquiring a relation lock. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN896"></a><span class='Declare_Function'>RangeVarCallbackForRenameRule</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rv</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>oldrelid</span><span class='Delimiter'>, 
</span><a name="LN897"></a>                              <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN899"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN900"></a>    <a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>form</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteDefine.c.html#LN899"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN899"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* concurrently dropped */ 
</span>    <a href="rewriteDefine.c.html#LN900"><span class='Ref_To_Local'>form</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN899"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* only tables and views can have rules */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN900"><span class='Ref_To_Local'>form</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteDefine.c.html#LN900"><span class='Ref_To_Local'>form</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteDefine.c.html#LN900"><span class='Ref_To_Local'>form</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_WRONG_OBJECT_TYPE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a table or view"</span><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../utils/init/globals.c.html#LN111"><span class='Ref_to_Global_Var'>allowSystemTableMods</span></a> <span class='Operator'>&& </span><a href="../../include/catalog/catalog.h.html#LN33"><span class='Ref_to_Proto'>IsSystemClass</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN900"><span class='Ref_To_Local'>form</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied: \"%s\" is a system catalog"</span><span class='Delimiter'>, 
</span>                        <a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* you must own the table to rename one of its rules */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>, </span><a href="../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> 
        <a href="../../include/utils/acl.h.html#LN295"><span class='Ref_to_Proto'>aclcheck_error</span></a><span class='Parentheses'>(</span><a href="../../include/utils/acl.h.html#LN173"><span class='Ref_to_EnumConst'>ACLCHECK_NOT_OWNER</span></a><span class='Delimiter'>, </span><a href="../../include/utils/acl.h.html#LN181"><span class='Ref_to_EnumConst'>ACL_KIND_CLASS</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN896"><span class='Ref_to_Parameter'>rv</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN67"><span class='Ref_to_Member'>relname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN899"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RangeVarCallbackForRenameRule &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rename an existing rewrite rule. 
 */ 
</span><a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> 
<a name="LN932"></a><span class='Declare_Function'>RenameRewriteRule</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN62"><span class='Ref_to_Struct'>RangeVar</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldName</span><span class='Delimiter'>, 
</span><a name="LN933"></a>                  <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN935"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span><a name="LN936"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>targetrel</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_rewrite_desc</span><span class='Delimiter'>; 
</span><a name="LN938"></a>    <a href="../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>ruletup</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <a href="../../include/catalog/pg_rewrite.h.html#LN52"><span class='Ref_to_Typedef'>Form_pg_rewrite</span></a> <span class='Declare_Local'>ruleform</span><span class='Delimiter'>; 
</span><a name="LN940"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>ruleOid</span><span class='Delimiter'>; 
</span><a name="LN941"></a>    <a href="../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>address</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up name, check permissions, and acquire lock (which we will NOT 
     * release until end of transaction). 
     */ 
</span>    <a href="rewriteDefine.c.html#LN935"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/namespace.h.html#LN55"><span class='Ref_to_Proto'>RangeVarGetRelidExtended</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN932"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>, 
</span>                                     <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                     <a href="rewriteDefine.c.html#LN895"><span class='Ref_to_Func'>RangeVarCallbackForRenameRule</span></a><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Have lock already, so just need to build relcache entry. */ 
</span>    <a href="rewriteDefine.c.html#LN936"><span class='Ref_To_Local'>targetrel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN84"><span class='Ref_to_Proto'>relation_open</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN935"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare to modify pg_rewrite */ 
</span>    <a href="rewriteDefine.c.html#LN937"><span class='Ref_To_Local'>pg_rewrite_desc</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch the rule's entry (it had better exist) */ 
</span>    <a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a> <span class='Operator'>= </span><a href="../../include/utils/syscache.h.html#LN166"><span class='Ref_to_Macro'>SearchSysCacheCopy2</span></a><span class='Parentheses'>(</span><a href="../../include/utils/syscache.h.html#LN86"><span class='Ref_to_EnumConst'>RULERELNAME</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN935"><span class='Ref_To_Local'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                  <a href="../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN932"><span class='Ref_to_Parameter'>oldName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule \"%s\" for relation \"%s\" does not exist"</span><span class='Delimiter'>, 
</span>                        <a href="rewriteDefine.c.html#LN932"><span class='Ref_to_Parameter'>oldName</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN936"><span class='Ref_To_Local'>targetrel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN939"><span class='Ref_To_Local'>ruleform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/catalog/pg_rewrite.h.html#LN52"><span class='Ref_to_Typedef'>Form_pg_rewrite</span></a><span class='Parentheses'>) </span><a href="../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteDefine.c.html#LN940"><span class='Ref_To_Local'>ruleOid</span></a> <span class='Operator'>= </span><a href="../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* rule with the new name should not already exist */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteSupport.h.html#LN19"><span class='Ref_to_Proto'>IsDefinedRewriteRule</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN935"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN933"><span class='Ref_to_Parameter'>newName</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span><a href="../../bin/pg_basebackup/streamutil.c.html#LN30"><span class='Ref_to_Const'>ERRCODE_DUPLICATE_OBJECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"rule \"%s\" for relation \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                        <a href="rewriteDefine.c.html#LN933"><span class='Ref_to_Parameter'>newName</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN936"><span class='Ref_To_Local'>targetrel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We disallow renaming ON SELECT rules, because they should always be 
     * named "_RETURN". 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN939"><span class='Ref_To_Local'>ruleform</span></a><span class='Operator'>-&GT;</span>ev_type <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a> <span class='Operator'>+ </span><span class='String'>'0'</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"renaming an ON SELECT rule is not allowed"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, do the update */ 
</span>    <a href="../../include/utils/builtins.h.html#LN40"><span class='Ref_to_Proto'>namestrcpy</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN939"><span class='Ref_To_Local'>ruleform</span></a><span class='Operator'>-&GT;</span>rulename<span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN933"><span class='Ref_to_Parameter'>newName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/indexing.h.html#LN35"><span class='Ref_to_Proto'>CatalogTupleUpdate</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN937"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN938"><span class='Ref_To_Local'>ruletup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN937"><span class='Ref_To_Local'>pg_rewrite_desc</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Invalidate relation's relcache entry so that other backends (and this 
     * one too!) are sent SI message to make them rebuild relcache entries. 
     * (Ideally this should happen automatically...) 
     */ 
</span>    <a href="../../include/utils/inval.h.html#LN43"><span class='Ref_to_Proto'>CacheInvalidateRelcache</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN936"><span class='Ref_To_Local'>targetrel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/catalog/objectaddress.h.html#LN39"><span class='Ref_to_Macro'>ObjectAddressSet</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN941"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>, </span><a href="../../include/catalog/pg_rewrite.h.html#LN31"><span class='Ref_to_Const'>RewriteRelationId</span></a><span class='Delimiter'>, </span><a href="rewriteDefine.c.html#LN940"><span class='Ref_To_Local'>ruleOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close rel, but keep exclusive lock! 
     */ 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteDefine.c.html#LN936"><span class='Ref_To_Local'>targetrel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteDefine.c.html#LN941"><span class='Ref_To_Local'>address</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RenameRewriteRule &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>