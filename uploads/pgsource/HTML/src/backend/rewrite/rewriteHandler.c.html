<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\rewrite\rewriteHandler.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\rewrite\rewriteHandler.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:47 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * rewriteHandler.c 
 *      Primary module of query rewriter. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/rewrite/rewriteHandler.c 
 * 
 * NOTES 
 *    Some of the terms used in this file are of historic nature: "retrieve" 
 *    was the PostQUEL keyword for what today is SELECT. "RIR" stands for 
 *    "Retrieve-Instead-Retrieve", that is an ON SELECT DO INSTEAD SELECT rule 
 *    (which has to be unconditional and where only one rule can exist on each 
 *    relation). 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"foreign/fdwapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/makefuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/analyze.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_coerce.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parsetree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteDefine.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteHandler.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rewriteManip.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"rewrite/rowsecurity.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* We use a list of these to detect recursion in RewriteQuery */ 
</span><a name="LN42"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>rewrite_event</span> 
<span class='Delimiter'>{ 
</span><a name="LN44"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>relation</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* OID of relation having rules */ 
</span><a name="LN45"></a>    <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a>     <span class='Declare_Member'>event</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* type of rule being fired */ 
</span><a name="LN46"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>rewrite_event</span><span class='Delimiter'>; 
</span> 
<a name="LN48"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>acquireLocksOnSubLinks_context</span> 
<span class='Delimiter'>{ 
</span><a name="LN50"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>for_execute</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* AcquireRewriteLocks' forExecute param */ 
</span><a name="LN51"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>acquireLocksOnSubLinks_context</span><span class='Delimiter'>; 
</span> 
<a name="LN53"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>acquireLocksOnSubLinks</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, 
</span><a name="LN54"></a>                       <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN55"></a><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>rewriteRuleAction</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN56"></a>                  <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule_action</span><span class='Delimiter'>, 
</span><a name="LN57"></a>                  <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule_qual</span><span class='Delimiter'>, 
</span><a name="LN58"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Delimiter'>, 
</span><a name="LN59"></a>                  <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN60"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>returning_flag</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>adjustJoinTreeList</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>removert</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN62"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>rewriteTargetListIU</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetList</span><span class='Delimiter'>, 
</span><a name="LN63"></a>                    <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>commandType</span><span class='Delimiter'>, 
</span><a name="LN64"></a>                    <a href="../../include/nodes/parsenodes.h.html#LN29"><span class='Ref_to_Enum'>OverridingKind</span></a> <span class='Declare_Parameter'>override</span><span class='Delimiter'>, 
</span><a name="LN65"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Delimiter'>, 
</span><a name="LN66"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>result_rti</span><span class='Delimiter'>, 
</span><a name="LN67"></a>                    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>attrno_list</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static </span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>process_matched_tle</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>src_tle</span><span class='Delimiter'>, 
</span><a name="LN69"></a>                    <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prior_tle</span><span class='Delimiter'>, 
</span><a name="LN70"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attrName</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_assignment_input</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN72"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>rewriteValuesRTE</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rte</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                 <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attrnos</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>rewriteTargetListUD</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>target_rte</span><span class='Delimiter'>, 
</span><a name="LN75"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN76"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>markQueryForLocking</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qry</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>jtnode</span><span class='Delimiter'>, 
</span><a name="LN77"></a>                    <a href="../../include/nodes/lockoptions.h.html#LN20"><span class='Ref_to_Enum'>LockClauseStrength</span></a> <span class='Declare_Parameter'>strength</span><span class='Delimiter'>, </span><a href="../../include/nodes/lockoptions.h.html#LN35"><span class='Ref_to_Enum'>LockWaitPolicy</span></a> <span class='Declare_Parameter'>waitPolicy</span><span class='Delimiter'>, 
</span><a name="LN78"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>pushedDown</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>matchLocks</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, </span><a href="../../include/rewrite/prs2lock.h.html#LN39"><span class='Ref_to_Struct'>RuleLock</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rulelocks</span><span class='Delimiter'>, 
</span><a name="LN80"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>varno</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>hasUpdate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>fireRIRrules</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>activeRIRs</span><span class='Delimiter'>, 
</span><a name="LN82"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>forUpdatePushedDown</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN83"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>view_has_instead_trigger</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>view</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN84"></a><span class='Keyword'>static </span><a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>adjust_view_column_set</span><span class='Parentheses'>(</span><a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cols</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetlist</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * AcquireRewriteLocks - 
 *    Acquire suitable locks on all the relations mentioned in the Query. 
 *    These locks will ensure that the relation schemas don't change under us 
 *    while we are rewriting and planning the query. 
 * 
 * forExecute indicates that the query is about to be executed. 
 * If so, we'll acquire RowExclusiveLock on the query's resultRelation, 
 * RowShareLock on any relation accessed FOR [KEY] UPDATE/SHARE, and 
 * AccessShareLock on all other relations mentioned. 
 * 
 * If forExecute is false, AccessShareLock is acquired on all relations. 
 * This case is suitable for ruleutils.c, for example, where we only need 
 * schema stability and we don't intend to actually modify any relations. 
 * 
 * forUpdatePushedDown indicates that a pushed-down FOR [KEY] UPDATE/SHARE 
 * applies to the current subquery, requiring all rels to be opened with at 
 * least RowShareLock.  This should always be false at the top of the 
 * recursion.  This flag is ignored if forExecute is false. 
 * 
 * A secondary purpose of this routine is to fix up JOIN RTE references to 
 * dropped columns (see details below).  Because the RTEs are modified in 
 * place, it is generally appropriate for the caller of this routine to have 
 * first done a copyObject() to make a writable copy of the querytree in the 
 * current memory context. 
 * 
 * This processing can, and for efficiency's sake should, be skipped when the 
 * querytree has just been built by the parser: parse analysis already got 
 * all the same locks we'd get here, and the parser will have omitted dropped 
 * columns from JOINs to begin with.  But we must do this whenever we are 
 * dealing with a querytree produced earlier than the current command. 
 * 
 * About JOINs and dropped columns: although the parser never includes an 
 * already-dropped column in a JOIN RTE's alias var list, it is possible for 
 * such a list in a stored rule to include references to dropped columns. 
 * (If the column is not explicitly referenced anywhere else in the query, 
 * the dependency mechanism won't consider it used by the rule and so won't 
 * prevent the column drop.)  To support get_rte_attribute_is_dropped(), we 
 * replace join alias vars that reference dropped columns with null pointers. 
 * 
 * (In PostgreSQL 8.0, we did not do this processing but instead had 
 * get_rte_attribute_is_dropped() recurse to detect dropped columns in joins. 
 * That approach had horrible performance unfortunately; in particular 
 * construction of a nested join was O(N^2) in the nesting depth.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN133"></a><span class='Declare_Function'>AcquireRewriteLocks</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN134"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>forExecute</span><span class='Delimiter'>, 
</span><a name="LN135"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>forUpdatePushedDown</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN137"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rt_index</span><span class='Delimiter'>; 
</span><a name="LN139"></a>    <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN139"><span class='Ref_To_Local'>context</span></a><span class='Operator'>.</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN134"><span class='Ref_to_Parameter'>forExecute</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, process RTEs of the current query level. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN137"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN149"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN137"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN150"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN151"></a>        <a href="../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN152"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newaliasvars</span><span class='Delimiter'>; 
</span><a name="LN153"></a>        <a href="../../include/c.h.html#LN364"><span class='Ref_to_Typedef'>Index</span></a>       <span class='Declare_Local'>curinputvarno</span><span class='Delimiter'>; 
</span><a name="LN154"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>curinputrte</span><span class='Delimiter'>; 
</span><a name="LN155"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>ll</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>++</span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Grab the appropriate lock type for the relation, and do not 
                 * release it until end of transaction. This protects the 
                 * rewriter and planner against schema changes mid-query. 
                 * 
                 * Assuming forExecute is true, this logic must match what the 
                 * executor will do, else we risk lock-upgrade deadlocks. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN134"><span class='Ref_to_Parameter'>forExecute</span></a><span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN151"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN151"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN135"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a> <span class='Operator'>|| 
</span>                         <a href="../../include/parser/parsetree.h.html#LN76"><span class='Ref_to_Proto'>get_parse_rowmark</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <a href="rewriteHandler.c.html#LN151"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="rewriteHandler.c.html#LN151"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN150"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN151"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * While we have the relation open, update the RTE's relkind, 
                 * just in case it changed since this rule was made. 
                 */ 
</span>                <a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN150"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span> 
                <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN150"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN924"><span class='Ref_to_EnumConst'>RTE_JOIN</span></a><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Scan the join's alias var list to see if any columns have 
                 * been dropped, and if so replace those Vars with null 
                 * pointers. 
                 * 
                 * Since a join has only two inputs, we can expect to see 
                 * multiple references to the same input RTE; optimize away 
                 * multiple fetches. 
                 */ 
</span>                <a href="rewriteHandler.c.html#LN152"><span class='Ref_To_Local'>newaliasvars</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN154"><span class='Ref_To_Local'>curinputrte</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN155"><span class='Ref_To_Local'>ll</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN975"><span class='Ref_to_Member'>joinaliasvars</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN207"></a>                    <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>aliasitem</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN155"><span class='Ref_To_Local'>ll</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN208"></a>                    <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>aliasvar</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN207"><span class='Ref_To_Local'>aliasitem</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Look through any implicit coercion */ 
</span>                    <a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/nodeFuncs.h.html#LN35"><span class='Ref_to_Proto'>strip_implicit_coercions</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * If the list item isn't a simple Var, then it must 
                     * represent a merged column, ie a USING column, and so it 
                     * couldn't possibly be dropped, since it's referenced in 
                     * the join clause.  (Conceivably it could also be a null 
                     * pointer already?  But that's OK too.) 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a> <span class='Operator'>&& </span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * The elements of an alias list have to refer to 
                         * earlier RTEs of the same rtable, because that's the 
                         * order the planner builds things in.  So we already 
                         * processed the referenced RTE, and so it's safe to 
                         * use get_rte_attribute_is_dropped on it. (This might 
                         * not hold after rewriting or planning, but it's OK 
                         * to assume here.) 
                         */ 
</span>                        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN172"><span class='Ref_to_Member'>varlevelsup</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN165"><span class='Ref_to_Member'>varno</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a><span class='Parentheses'>) 
</span>                        <span class='Delimiter'>{ 
</span>                            <a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN165"><span class='Ref_to_Member'>varno</span></a><span class='Delimiter'>; 
</span>                            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a> <span class='Operator'>&GT;= </span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) 
</span>                                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected varno %d in JOIN RTE %d"</span><span class='Delimiter'>, 
</span>                                     <a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                            <a href="rewriteHandler.c.html#LN154"><span class='Ref_To_Local'>curinputrte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN153"><span class='Ref_To_Local'>curinputvarno</span></a><span class='Delimiter'>, 
</span>                                                   <a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/parser/parsetree.h.html#LN60"><span class='Ref_to_Proto'>get_rte_attribute_is_dropped</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN154"><span class='Ref_To_Local'>curinputrte</span></a><span class='Delimiter'>, 
</span>                                                         <a href="rewriteHandler.c.html#LN208"><span class='Ref_To_Local'>aliasvar</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a><span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <span class='Comment_Multi_Line'>/* Replace the join alias item with a NULL */ 
</span>                            <a href="rewriteHandler.c.html#LN207"><span class='Ref_To_Local'>aliasitem</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if aliasvar&&IsA(aliasva... &raquo; </span> 
                    <a href="rewriteHandler.c.html#LN152"><span class='Ref_To_Local'>newaliasvars</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN152"><span class='Ref_To_Local'>newaliasvars</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN207"><span class='Ref_To_Local'>aliasitem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN975"><span class='Ref_to_Member'>joinaliasvars</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN152"><span class='Ref_To_Local'>newaliasvars</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * The subquery RTE itself is all right, but we have to 
                 * recurse to process the represented subquery. 
                 */ 
</span>                <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN149"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN134"><span class='Ref_to_Parameter'>forExecute</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN135"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a> <span class='Operator'>|| 
</span>                            <a href="../../include/parser/parsetree.h.html#LN76"><span class='Ref_to_Proto'>get_parse_rowmark</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN138"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* ignore other types of RTEs */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch rte-&GT;rtekind &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Recurse into subqueries in WITH */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN137"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN274"></a>        <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN137"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN274"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN134"><span class='Ref_to_Parameter'>forExecute</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recurse into sublink subqueries, too.  But we already did the ones in 
     * the rtable and cteList. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/nodes/nodeFuncs.h.html#LN57"><span class='Ref_to_Proto'>query_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN133"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN139"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/nodes/nodeFuncs.h.html#LN21"><span class='Ref_to_Const'>QTW_IGNORE_RC_SUBQUERIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AcquireRewriteLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Walker to find sublink subqueries for AcquireRewriteLocks 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN292"></a><span class='Declare_Function'>acquireLocksOnSubLinks</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>node</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN298"></a>        <a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>sub</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do what we came for */ 
</span>        <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN298"><span class='Ref_To_Local'>sub</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN636"><span class='Ref_to_Member'>subselect</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>context</span></a><span class='Operator'>-&GT;</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a><span class='Delimiter'>, 
</span>                            <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Fall through to process lefthand args of SubLink */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do NOT recurse into Query nodes, because AcquireRewriteLocks already 
     * processed subselects of subselects for us. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN292"><span class='Ref_to_Parameter'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end acquireLocksOnSubLinks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * rewriteRuleAction - 
 *    Rewrite the rule action with appropriate qualifiers (taken from 
 *    the triggering query). 
 * 
 * Input arguments: 
 *  parsetree - original query 
 *  rule_action - one action (query) of a rule 
 *  rule_qual - WHERE condition of rule, or NULL if unconditional 
 *  rt_index - RT index of result relation in original query 
 *  event - type of rule event 
 * Output arguments: 
 *  *returning_flag - set TRUE if we rewrite RETURNING clause in rule_action 
 *                  (must be initialized to FALSE) 
 * Return value: 
 *  rewritten form of rule_action 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN333"></a><span class='Declare_Function'>rewriteRuleAction</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN334"></a>                  <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule_action</span><span class='Delimiter'>, 
</span><a name="LN335"></a>                  <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule_qual</span><span class='Delimiter'>, 
</span><a name="LN336"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Delimiter'>, 
</span><a name="LN337"></a>                  <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN338"></a>                  <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>returning_flag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN340"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>current_varno</span><span class='Delimiter'>, 
</span><a name="LN341"></a>                <span class='Declare_Local'>new_varno</span><span class='Delimiter'>; 
</span><a name="LN342"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rt_length</span><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>sub_action</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>     <span class='Operator'>**</span><span class='Declare_Local'>sub_action_ptr</span><span class='Delimiter'>; 
</span><a name="LN345"></a>    <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN345"><span class='Ref_To_Local'>context</span></a><span class='Operator'>.</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make modifiable copies of rule action and qual (what we're passed are 
     * the stored versions in the relcache; don't touch 'em!). 
     */ 
</span>    <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire necessary locks and fix any deleted JOIN RTE entries. 
     */ 
</span>    <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN345"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN340"><span class='Ref_To_Local'>current_varno</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN341"><span class='Ref_To_Local'>new_varno</span></a> <span class='Operator'>= </span><a href="../../include/nodes/primnodes.h.html#LN160"><span class='Ref_to_Const'>PRS2_NEW_VARNO</span></a> <span class='Operator'>+ </span><a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adjust rule action and qual to offset its varnos, so that we can merge 
     * its rtable with the main parsetree's rtable. 
     * 
     * If the rule action is an INSERT...SELECT, the OLD/NEW rtable entries 
     * will be in the SELECT part, and we have to modify that rather than the 
     * top-level INSERT (kluge!). 
     */ 
</span>    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN52"><span class='Ref_to_Proto'>getInsertSelectQuery</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN344"><span class='Ref_To_Local'>sub_action_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/rewrite/rewriteManip.h.html#LN41"><span class='Ref_to_Proto'>OffsetVarNodes</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN41"><span class='Ref_to_Proto'>OffsetVarNodes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* but references to OLD should point at original rt_index */ 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>, 
</span>                   <a href="../../include/nodes/primnodes.h.html#LN159"><span class='Ref_to_Const'>PRS2_OLD_VARNO</span></a> <span class='Operator'>+ </span><a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Delimiter'>, 
</span>                   <a href="../../include/nodes/primnodes.h.html#LN159"><span class='Ref_to_Const'>PRS2_OLD_VARNO</span></a> <span class='Operator'>+ </span><a href="rewriteHandler.c.html#LN342"><span class='Ref_To_Local'>rt_length</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate expanded rtable consisting of main parsetree's rtable plus 
     * rule action's rtable; this becomes the complete rtable for the rule 
     * action.  Some of the entries may be unused after we finish rewriting, 
     * but we leave them all in place for two reasons: 
     * 
     * We'd have a much harder job to adjust the query's varnos if we 
     * selectively removed RT entries. 
     * 
     * If the rule is INSTEAD, then the original query won't be executed at 
     * all, and so its rtable must be preserved so that the executor will do 
     * the correct permissions checks on it. 
     * 
     * RT entries that are not referenced in the completed jointree will be 
     * ignored by the planner, so they do not affect query semantics.  But any 
     * permissions checks specified in them will be applied during executor 
     * startup (see ExecCheckRTEPerms()).  This allows us to check that the 
     * caller has, say, insert-permission on a view, when the view is not 
     * semantically referenced at all in the resulting query. 
     * 
     * When a rule is not INSTEAD, the permissions checks done on its copied 
     * RT entries will be redundant with those done during execution of the 
     * original query, but we don't bother to treat that case differently. 
     * 
     * NOTE: because planner will destructively alter rtable, we must ensure 
     * that rule action's rtable is separate and shares no substructure with 
     * the main rtable.  Hence do a deep copy here. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                     <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There could have been some SubLinks in parsetree's rtable, in which 
     * case we'd better mark the sub_action correctly. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN421"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN421"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN425"></a>            <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN421"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN425"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Operator'>: 
</span>                    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                        <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN425"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN949"><span class='Ref_to_Member'>tablesample</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN925"><span class='Ref_to_EnumConst'>RTE_FUNCTION</span></a><span class='Operator'>: 
</span>                    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                        <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN425"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN985"><span class='Ref_to_Member'>functions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN926"><span class='Ref_to_EnumConst'>RTE_TABLEFUNC</span></a><span class='Operator'>: 
</span>                    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                        <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN425"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN991"><span class='Ref_to_Member'>tablefunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/parsenodes.h.html#LN927"><span class='Ref_to_EnumConst'>RTE_VALUES</span></a><span class='Operator'>: 
</span>                    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                        <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN425"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN996"><span class='Ref_to_Member'>values_lists</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <span class='Comment_Multi_Line'>/* other RTE types don't contain bare expressions */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch rte-&GT;rtekind &raquo; </span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* no need to keep scanning rtable */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;hasSubLink... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Also, we might have absorbed some RTEs with RLS conditions into the 
     * sub_action.  If so, mark it as hasRowSecurity, whether or not those 
     * RTEs will be referenced after we finish rewriting.  (Note: currently 
     * this is a no-op because RLS conditions aren't added till later, but it 
     * seems like good future-proofing to do this anyway.) 
     */ 
</span>    <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN130"><span class='Ref_to_Member'>hasRowSecurity</span></a> <span class='Operator'>|= </span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN130"><span class='Ref_to_Member'>hasRowSecurity</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Each rule action's jointree should be the main parsetree's jointree 
     * plus that rule's jointree, but usually *without* the original rtindex 
     * that we're replacing (if present, which it won't be for INSERT). Note 
     * that if the rule action refers to OLD, its jointree will add a 
     * reference to rt_index.  If the rule action doesn't refer to OLD, but 
     * either the rule_qual or the user query quals do, then we need to keep 
     * the original rtindex in the jointree to provide data for the quals.  We 
     * don't want the original rtindex to be joined twice, however, so avoid 
     * keeping it if the rule action mentions it. 
     * 
     * As above, the action's jointree must not share substructure with the 
     * main parsetree's. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN479"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>keeporig</span><span class='Delimiter'>; 
</span><a name="LN480"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newjointree</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN479"><span class='Ref_To_Local'>keeporig</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/rewrite/rewriteManip.h.html#LN49"><span class='Ref_to_Proto'>rangeTableEntry_used</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Delimiter'>, 
</span>                                          <a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteManip.h.html#LN49"><span class='Ref_to_Proto'>rangeTableEntry_used</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>             <a href="../../include/rewrite/rewriteManip.h.html#LN49"><span class='Ref_to_Proto'>rangeTableEntry_used</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN480"><span class='Ref_To_Local'>newjointree</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN61"><span class='Ref_to_Proto'>adjustJoinTreeList</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN479"><span class='Ref_To_Local'>keeporig</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN336"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN480"><span class='Ref_To_Local'>newjointree</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If sub_action is a setop, manipulating its jointree will do no 
             * good at all, because the jointree is dummy.  (Perhaps someday 
             * we could push the joining and quals down to the member 
             * statements of the setop?) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN162"><span class='Ref_to_Member'>setOperations</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conditional UNION/INTERSECT/EXCEPT statements are not implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a> <span class='Operator'>= 
</span>                <a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN480"><span class='Ref_To_Local'>newjointree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * There could have been some SubLinks in newjointree, in which 
             * case we'd better mark the sub_action correctly. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                    <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN480"><span class='Ref_To_Local'>newjointree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if newjointree!=NIL &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if sub_action-&GT;commandTy... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If the original query has any CTEs, copy them into the rule action. But 
     * we don't need them for a utility action. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN520"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Annoying implementation restriction: because CTEs are identified by 
         * name within a cteList, we can't merge a CTE from the original query 
         * if it has the same name as any CTE in the rule action. 
         * 
         * This could possibly be fixed by using some sort of internally 
         * generated ID, instead of names, to link CTE RTEs to their CTEs. 
         */ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN520"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN532"></a>            <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN520"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN533"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN533"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN537"></a>                <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte2</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN533"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN532"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1342"><span class='Ref_to_Member'>ctename</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN537"><span class='Ref_To_Local'>cte2</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1342"><span class='Ref_to_Member'>ctename</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"WITH query name \"%s\" appears in both a rule action and the query being rewritten"</span><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN532"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1342"><span class='Ref_to_Member'>ctename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* OK, it's safe to combine the CTE lists */ 
</span>        <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;cteList!=N... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Event Qualification forces copying of parsetree and splitting into two 
     * queries one w/rule_qual, one w/NOT rule_qual. Also add user query qual 
     * onto rule action 
     */ 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN54"><span class='Ref_to_Proto'>AddQual</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN335"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/rewrite/rewriteManip.h.html#LN54"><span class='Ref_to_Proto'>AddQual</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Rewrite new.attribute with right hand side of target-list entry for 
     * appropriate field name in insert/update. 
     * 
     * KLUGE ALERT: since ReplaceVarsFromTargetList returns a mutated copy, we 
     * can't just apply it to sub_action; we have to remember to update the 
     * sublink inside rule_action, too. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="rewriteHandler.c.html#LN337"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN337"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/rewrite/rewriteManip.h.html#LN76"><span class='Ref_to_Proto'>ReplaceVarsFromTargetList</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN341"><span class='Ref_To_Local'>new_varno</span></a><span class='Delimiter'>, 
</span>                                      <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                      <a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN341"><span class='Ref_To_Local'>new_varno</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN337"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) </span><span class='Operator'>? 
</span>                                      <a href="../../include/rewrite/rewriteManip.h.html#LN36"><span class='Ref_to_EnumConst'>REPLACEVARS_CHANGE_VARNO</span></a> <span class='Operator'>: 
</span>                                      <a href="../../include/rewrite/rewriteManip.h.html#LN37"><span class='Ref_to_EnumConst'>REPLACEVARS_SUBSTITUTE_NULL</span></a><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN340"><span class='Ref_To_Local'>current_varno</span></a><span class='Delimiter'>, 
</span>                                      <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN344"><span class='Ref_To_Local'>sub_action_ptr</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN344"><span class='Ref_To_Local'>sub_action_ptr</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN343"><span class='Ref_To_Local'>sub_action</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If rule_action has a RETURNING clause, then either throw it away if the 
     * triggering query has no RETURNING clause, or rewrite it to emit what 
     * the triggering query's RETURNING clause asks for.  Throw an error if 
     * more than one rule has a RETURNING clause. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>) 
</span>        <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="rewriteHandler.c.html#LN338"><span class='Ref_to_Parameter'>returning_flag</span></a><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot have RETURNING lists in multiple rules"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN338"><span class='Ref_to_Parameter'>returning_flag</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../include/rewrite/rewriteManip.h.html#LN76"><span class='Ref_to_Proto'>ReplaceVarsFromTargetList</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                      <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                      <a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                               <a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/rewrite/rewriteManip.h.html#LN35"><span class='Ref_to_EnumConst'>REPLACEVARS_REPORT_ERROR</span></a><span class='Delimiter'>, 
</span>                                      <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There could have been some SubLinks in parsetree's returningList, 
         * in which case we'd better mark the rule_action correctly. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN333"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= 
</span>                <a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rule_action-&GT;returnin... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN334"><span class='Ref_to_Parameter'>rule_action</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rewriteRuleAction &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Copy the query's jointree list, and optionally attempt to remove any 
 * occurrence of the given rt_index as a top-level join item (we do not look 
 * for it within join items; this is OK because we are only expecting to find 
 * it as an UPDATE or DELETE target relation, which will be at the top level 
 * of the join).  Returns modified jointree list --- this is a separate copy 
 * sharing no nodes with the original. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN636"></a><span class='Declare_Function'>adjustJoinTreeList</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>removert</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN638"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newjointree</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN636"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN639"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN636"><span class='Ref_to_Parameter'>removert</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN639"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN638"><span class='Ref_To_Local'>newjointree</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN645"></a>            <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN639"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN645"><span class='Ref_To_Local'>rtr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <a href="rewriteHandler.c.html#LN645"><span class='Ref_To_Local'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN636"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN638"><span class='Ref_To_Local'>newjointree</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN234"><span class='Ref_to_Proto'>list_delete_ptr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN638"><span class='Ref_To_Local'>newjointree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN645"><span class='Ref_To_Local'>rtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * foreach is safe because we exit loop after list_delete... 
                 */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN638"><span class='Ref_To_Local'>newjointree</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end adjustJoinTreeList &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * rewriteTargetListIU - rewrite INSERT/UPDATE targetlist into standard form 
 * 
 * This has the following responsibilities: 
 * 
 * 1. For an INSERT, add tlist entries to compute default values for any 
 * attributes that have defaults and are not assigned to in the given tlist. 
 * (We do not insert anything for default-less attributes, however.  The 
 * planner will later insert NULLs for them, but there's no reason to slow 
 * down rewriter processing with extra tlist nodes.)  Also, for both INSERT 
 * and UPDATE, replace explicit DEFAULT specifications with column default 
 * expressions. 
 * 
 * 2. For an UPDATE on a trigger-updatable view, add tlist entries for any 
 * unassigned-to attributes, assigning them their old values.  These will 
 * later get expanded to the output values of the view.  (This is equivalent 
 * to what the planner's expand_targetlist() will do for UPDATE on a regular 
 * table, but it's more convenient to do it here while we still have easy 
 * access to the view's original RT index.)  This is only necessary for 
 * trigger-updatable views, for which the view remains the result relation of 
 * the query.  For auto-updatable views we must not do this, since it might 
 * add assignments to non-updatable view columns.  For rule-updatable views it 
 * is unnecessary extra work, since the query will be rewritten with a 
 * different result relation which will be processed when we recurse via 
 * RewriteQuery. 
 * 
 * 3. Merge multiple entries for the same target attribute, or declare error 
 * if we can't.  Multiple entries are only allowed for INSERT/UPDATE of 
 * portions of an array or record field, for example 
 *          UPDATE table SET foo[2] = 42, foo[4] = 43; 
 * We can merge such operations into a single assignment op.  Essentially, 
 * the expression we want to produce in this case is like 
 *      foo = array_set_element(array_set_element(foo, 2, 42), 4, 43) 
 * 
 * 4. Sort the tlist into standard order: non-junk fields in order by resno, 
 * then junk fields (these in no particular order). 
 * 
 * We must do items 1,2,3 before firing rewrite rules, else rewritten 
 * references to NEW.foo will produce wrong or incomplete results.  Item 4 
 * is not needed for rewriting, but will be needed by the planner, and we 
 * can do it essentially for free while handling the other items. 
 * 
 * If attrno_list isn't NULL, we return an additional output besides the 
 * rewritten targetlist: an integer list of the assigned-to attnums, in 
 * order of the original tlist's non-junk entries.  This is needed for 
 * processing VALUES RTEs. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN711"></a><span class='Declare_Function'>rewriteTargetListIU</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetList</span><span class='Delimiter'>, 
</span><a name="LN712"></a>                    <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>commandType</span><span class='Delimiter'>, 
</span><a name="LN713"></a>                    <a href="../../include/nodes/parsenodes.h.html#LN29"><span class='Ref_to_Enum'>OverridingKind</span></a> <span class='Declare_Parameter'>override</span><span class='Delimiter'>, 
</span><a name="LN714"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Delimiter'>, 
</span><a name="LN715"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>result_rti</span><span class='Delimiter'>, 
</span><a name="LN716"></a>                    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>attrno_list</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN718"></a>    <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>**</span><span class='Declare_Local'>new_tles</span><span class='Delimiter'>; 
</span><a name="LN719"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>new_tlist</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN720"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>junk_tlist</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN721"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att_tup</span><span class='Delimiter'>; 
</span><a name="LN722"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>attrno</span><span class='Delimiter'>, 
</span><a name="LN723"></a>                <span class='Declare_Local'>next_junk_attrno</span><span class='Delimiter'>, 
</span><a name="LN724"></a>                <span class='Declare_Local'>numattrs</span><span class='Delimiter'>; 
</span><a name="LN725"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>temp</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN716"><span class='Ref_to_Parameter'>attrno_list</span></a><span class='Parentheses'>)</span>            <span class='Comment_Single_Line'>/* initialize optional result list */ 
</span>        <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN716"><span class='Ref_to_Parameter'>attrno_list</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We process the normal (non-junk) attributes by scanning the input tlist 
     * once and transferring TLEs into an array, then scanning the array to 
     * build an output tlist.  This avoids O(N^2) behavior for large numbers 
     * of attributes. 
     * 
     * Junk attributes are tossed into a separate list during the same tlist 
     * scan, then appended to the reconstructed tlist. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN724"><span class='Ref_To_Local'>numattrs</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN422"><span class='Ref_to_Macro'>RelationGetNumberOfAttributes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN718"><span class='Ref_To_Local'>new_tles</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN724"><span class='Ref_To_Local'>numattrs</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN723"><span class='Ref_To_Local'>next_junk_attrno</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN724"><span class='Ref_To_Local'>numattrs</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN725"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN711"><span class='Ref_to_Parameter'>targetList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN745"></a>        <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old_tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN725"><span class='Ref_To_Local'>temp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Normal attr: stash it into new_tles[] */ 
</span>            <a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>&LT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>&GT; </span><a href="rewriteHandler.c.html#LN724"><span class='Ref_To_Local'>numattrs</span></a><span class='Parentheses'>) 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"bogus resno %d in targetlist"</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* put attrno into attrno_list even if it's dropped */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN716"><span class='Ref_to_Parameter'>attrno_list</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN716"><span class='Ref_to_Parameter'>attrno_list</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN144"><span class='Ref_to_Func'>lappend_int</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="rewriteHandler.c.html#LN716"><span class='Ref_to_Parameter'>attrno_list</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We can (and must) ignore deleted attributes */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Merge with any prior assignment to same attribute */ 
</span>            <a href="rewriteHandler.c.html#LN718"><span class='Ref_To_Local'>new_tles</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span>                <a href="rewriteHandler.c.html#LN68"><span class='Ref_to_Proto'>process_matched_tle</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN718"><span class='Ref_To_Local'>new_tles</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                                    <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !old_tle-&GT;resjunk &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Copy all resjunk tlist entries to junk_tlist, and assign them 
             * resnos above the last real resno. 
             * 
             * Typical junk entries include ORDER BY or GROUP BY expressions 
             * (are these actually possible in an INSERT or UPDATE?), system 
             * attribute references, etc. 
             */ 
</span> 
            <span class='Comment_Multi_Line'>/* Get the resno right, but don't copy unnecessarily */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN723"><span class='Ref_To_Local'>next_junk_attrno</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN45"><span class='Ref_to_Proto'>flatCopyTargetEntry</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN723"><span class='Ref_To_Local'>next_junk_attrno</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="rewriteHandler.c.html#LN720"><span class='Ref_To_Local'>junk_tlist</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN720"><span class='Ref_To_Local'>junk_tlist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN745"><span class='Ref_To_Local'>old_tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN723"><span class='Ref_To_Local'>next_junk_attrno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>&LT;= </span><a href="rewriteHandler.c.html#LN724"><span class='Ref_To_Local'>numattrs</span></a><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN793"></a>        <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_tle</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN718"><span class='Ref_To_Local'>new_tles</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN794"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>apply_default</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* We can (and must) ignore deleted attributes */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Handle the two cases where we need to insert a default expression: 
         * it's an INSERT and there's no tlist entry for the column, or the 
         * tlist entry is a DEFAULT placeholder node. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN794"><span class='Ref_To_Local'>apply_default</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN712"><span class='Ref_to_Parameter'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>             <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a> <span class='Operator'>&& </span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1251"><span class='Ref_to_Struct'>SetToDefault</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN712"><span class='Ref_to_Parameter'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attidentity <span class='Operator'>== </span><a href="../../include/catalog/pg_attribute.h.html#LN227"><span class='Ref_to_Const'>ATTRIBUTE_IDENTITY_ALWAYS</span></a> <span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN794"><span class='Ref_To_Local'>apply_default</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>override </span><span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN33"><span class='Ref_to_EnumConst'>OVERRIDING_SYSTEM_VALUE</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_GENERATED_ALWAYS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot insert into column \"%s\""</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Column \"%s\" is an identity column defined as GENERATED ALWAYS."</span><span class='Delimiter'>, 
</span>                                       <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                       <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Use OVERRIDING SYSTEM VALUE to override."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attidentity <span class='Operator'>== </span><a href="../../include/catalog/pg_attribute.h.html#LN228"><span class='Ref_to_Const'>ATTRIBUTE_IDENTITY_BY_DEFAULT</span></a> <span class='Operator'>&& </span><span class='Keyword'>override </span><span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN32"><span class='Ref_to_EnumConst'>OVERRIDING_USER_VALUE</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN794"><span class='Ref_To_Local'>apply_default</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN712"><span class='Ref_to_Parameter'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attidentity <span class='Operator'>== </span><a href="../../include/catalog/pg_attribute.h.html#LN227"><span class='Ref_to_Const'>ATTRIBUTE_IDENTITY_ALWAYS</span></a> <span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN794"><span class='Ref_To_Local'>apply_default</span></a><span class='Parentheses'>) 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_GENERATED_ALWAYS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" can only be updated to DEFAULT"</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Column \"%s\" is an identity column defined as GENERATED ALWAYS."</span><span class='Delimiter'>, 
</span>                                   <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN794"><span class='Ref_To_Local'>apply_default</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN839"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>new_expr</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attidentity<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN843"></a>                <a href="../../include/nodes/primnodes.h.html#LN1302"><span class='Ref_to_Struct'>NextValueExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nve</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1302"><span class='Ref_to_Struct'>NextValueExpr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN843"><span class='Ref_To_Local'>nve</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1305"><span class='Ref_to_Member'>seqid</span></a> <span class='Operator'>= </span><a href="../../include/catalog/dependency.h.html#LN242"><span class='Ref_to_Proto'>getOwnedSequence</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN843"><span class='Ref_To_Local'>nve</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1306"><span class='Ref_to_Member'>typeId</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN843"><span class='Ref_To_Local'>nve</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteHandler.h.html#LN24"><span class='Ref_to_Proto'>build_column_default</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If there is no default (ie, default is effectively NULL), we 
             * can omit the tlist entry in the INSERT case, since the planner 
             * can insert a NULL for itself, and there's no point in spending 
             * any more rewriter cycles on the entry.  But in the UPDATE case 
             * we've got to explicitly set the column to NULL. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN712"><span class='Ref_to_Parameter'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/makefuncs.h.html#LN49"><span class='Ref_to_Proto'>makeConst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                  <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attlen<span class='Delimiter'>, 
</span>                                                  <span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                  <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* isnull */ 
</span>                                                  <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attbyval<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* this is to catch a NOT NULL domain constraint */ 
</span>                    <a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN48"><span class='Ref_to_Proto'>coerce_to_domain</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                <a href="../../include/nodes/primnodes.h.html#LN438"><span class='Ref_to_EnumConst'>COERCE_IMPLICIT_CAST</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !new_expr &raquo; </span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN40"><span class='Ref_to_Proto'>makeTargetEntry</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="rewriteHandler.c.html#LN839"><span class='Ref_To_Local'>new_expr</span></a><span class='Delimiter'>, 
</span>                                          <a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                          <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if apply_default &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * For an UPDATE on a trigger-updatable view, provide a dummy entry 
         * whenever there is no explicit assignment. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN712"><span class='Ref_to_Parameter'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a> <span class='Operator'>&& 
</span>            <a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>            <a href="rewriteHandler.c.html#LN83"><span class='Ref_to_Proto'>view_has_instead_trigger</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN714"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN899"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>new_expr</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN899"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/makefuncs.h.html#LN25"><span class='Ref_to_Proto'>makeVar</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN715"><span class='Ref_to_Parameter'>result_rti</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                                        <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN40"><span class='Ref_to_Proto'>makeTargetEntry</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="rewriteHandler.c.html#LN899"><span class='Ref_To_Local'>new_expr</span></a><span class='Delimiter'>, 
</span>                                      <a href="rewriteHandler.c.html#LN722"><span class='Ref_To_Local'>attrno</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN721"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                                      <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN719"><span class='Ref_To_Local'>new_tlist</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN719"><span class='Ref_To_Local'>new_tlist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN793"><span class='Ref_To_Local'>new_tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for attrno=1;attrno&LT;=numa... &raquo; </span> 
 
    <a href="../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN718"><span class='Ref_To_Local'>new_tles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN719"><span class='Ref_To_Local'>new_tlist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN720"><span class='Ref_To_Local'>junk_tlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rewriteTargetListIU &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Convert a matched TLE from the original tlist into a correct new TLE. 
 * 
 * This routine detects and handles multiple assignments to the same target 
 * attribute.  (The attribute name is needed only for error messages.) 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>* 
</span><a name="LN931"></a><span class='Declare_Function'>process_matched_tle</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>src_tle</span><span class='Delimiter'>, 
</span><a name="LN932"></a>                    <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>prior_tle</span><span class='Delimiter'>, 
</span><a name="LN933"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>attrName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN935"></a>    <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN936"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>src_expr</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>prior_expr</span><span class='Delimiter'>; 
</span><a name="LN938"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>src_input</span><span class='Delimiter'>; 
</span><a name="LN939"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>prior_input</span><span class='Delimiter'>; 
</span><a name="LN940"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>priorbottom</span><span class='Delimiter'>; 
</span><a name="LN941"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newexpr</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN932"><span class='Ref_to_Parameter'>prior_tle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Normal case where this is the first assignment to the attribute. 
         */ 
</span>        <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN931"><span class='Ref_to_Parameter'>src_tle</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Multiple assignments to same attribute.  Allow only if all are 
     * FieldStore or ArrayRef assignment operations.  This is a bit 
     * tricky because what we may actually be looking at is a nest of 
     * such nodes; consider 
     *      UPDATE tab SET col.fld1.subfld1 = x, col.fld2.subfld2 = y 
     * The two expressions produced by the parser will look like 
     *      FieldStore(col, fld1, FieldStore(placeholder, subfld1, x)) 
     *      FieldStore(col, fld2, FieldStore(placeholder, subfld2, y)) 
     * However, we can ignore the substructure and just consider the top 
     * FieldStore or ArrayRef from each assignment, because it works to 
     * combine these as 
     *      FieldStore(FieldStore(col, fld1, 
     *                            FieldStore(placeholder, subfld1, x)), 
     *                 fld2, FieldStore(placeholder, subfld2, y)) 
     * Note the leftmost expression goes on the inside so that the 
     * assignments appear to occur left-to-right. 
     * 
     * For FieldStore, instead of nesting we can generate a single 
     * FieldStore with multiple target fields.  We must nest when 
     * ArrayRefs are involved though. 
     *---------- 
     */ 
</span>    <a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN931"><span class='Ref_to_Parameter'>src_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN932"><span class='Ref_to_Parameter'>prior_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN938"><span class='Ref_To_Local'>src_input</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN71"><span class='Ref_to_Proto'>get_assignment_input</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN939"><span class='Ref_To_Local'>prior_input</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN71"><span class='Ref_to_Proto'>get_assignment_input</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN938"><span class='Ref_To_Local'>src_input</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN939"><span class='Ref_To_Local'>prior_input</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>        <a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multiple assignments to same column \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="rewriteHandler.c.html#LN933"><span class='Ref_to_Parameter'>attrName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prior TLE could be a nest of assignments if we do this more than once. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN940"><span class='Ref_To_Local'>priorbottom</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN939"><span class='Ref_To_Local'>prior_input</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN992"></a>        <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newbottom</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN71"><span class='Ref_to_Proto'>get_assignment_input</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN940"><span class='Ref_To_Local'>priorbottom</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN992"><span class='Ref_To_Local'>newbottom</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* found the original Var reference */ 
</span>        <a href="rewriteHandler.c.html#LN940"><span class='Ref_To_Local'>priorbottom</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN992"><span class='Ref_To_Local'>newbottom</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/nodes.h.html#LN626"><span class='Ref_to_Proto'>equal</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN940"><span class='Ref_To_Local'>priorbottom</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN938"><span class='Ref_To_Local'>src_input</span></a><span class='Parentheses'>))</span> 
        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multiple assignments to same column \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="rewriteHandler.c.html#LN933"><span class='Ref_to_Parameter'>attrName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Looks OK to nest 'em. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1009"></a>        <a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fstore</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* combine the two */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN767"><span class='Ref_to_Member'>newvals</span></a> <span class='Operator'>= 
</span>                <a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN268"><span class='Ref_to_Proto'>list_copy</span></a><span class='Parentheses'>(((</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>newvals<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../../include/nodes/pg_list.h.html#LN268"><span class='Ref_to_Proto'>list_copy</span></a><span class='Parentheses'>(((</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>newvals<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN768"><span class='Ref_to_Member'>fieldnums</span></a> <span class='Operator'>= 
</span>                <a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN268"><span class='Ref_to_Proto'>list_copy</span></a><span class='Parentheses'>(((</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fieldnums<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../../include/nodes/pg_list.h.html#LN268"><span class='Ref_to_Proto'>list_copy</span></a><span class='Parentheses'>(((</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fieldnums<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* general case, just nest 'em */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN766"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="rewriteHandler.c.html#LN941"><span class='Ref_To_Local'>newexpr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1009"><span class='Ref_To_Local'>fstore</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsA(src_expr,FieldSto... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1032"></a>        <a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>aref</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1032"><span class='Ref_To_Local'>aref</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN936"><span class='Ref_To_Local'>src_expr</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN1032"><span class='Ref_To_Local'>aref</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN406"><span class='Ref_to_Member'>refexpr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN937"><span class='Ref_To_Local'>prior_expr</span></a><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN941"><span class='Ref_To_Local'>newexpr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1032"><span class='Ref_To_Local'>aref</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot happen"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN941"><span class='Ref_To_Local'>newexpr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="rewriteHandler.c.html#LN935"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN45"><span class='Ref_to_Proto'>flatCopyTargetEntry</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN931"><span class='Ref_to_Parameter'>src_tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN935"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN941"><span class='Ref_To_Local'>newexpr</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN935"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end process_matched_tle &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * If node is an assignment node, return its input; else return NULL 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>* 
</span><a name="LN1053"></a><span class='Declare_Function'>get_assignment_input</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1053"><span class='Ref_to_Parameter'>node</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1053"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1059"></a>        <a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fstore</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN763"><span class='Ref_to_Struct'>FieldStore</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1053"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1059"><span class='Ref_To_Local'>fstore</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN766"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1053"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1065"></a>        <a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>aref</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN395"><span class='Ref_to_Struct'>ArrayRef</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1053"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1065"><span class='Ref_To_Local'>aref</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN408"><span class='Ref_to_Member'>refassgnexpr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1065"><span class='Ref_To_Local'>aref</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN406"><span class='Ref_to_Member'>refexpr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_assignment_input &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make an expression tree for the default value for a column. 
 * 
 * If there is no default, return a NULL instead. 
 */ 
</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>* 
</span><a name="LN1080"></a><span class='Declare_Function'>build_column_default</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>attrno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1082"></a>    <a href="../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>rd_att</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1080"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span><a name="LN1083"></a>    <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att_tup</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1082"><span class='Ref_To_Local'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1080"><span class='Ref_to_Parameter'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN1084"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>atttype</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1083"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>; 
</span><a name="LN1085"></a>    <a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>atttypmod</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1083"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypmod<span class='Delimiter'>; 
</span><a name="LN1086"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>expr</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1087"></a>    <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>exprtype</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan to see if relation has a default for this column. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1082"><span class='Ref_To_Local'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN75"><span class='Ref_to_Member'>constr</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN1082"><span class='Ref_To_Local'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN75"><span class='Ref_to_Member'>constr</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN40"><span class='Ref_to_Member'>num_defval</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1094"></a>        <a href="../../include/access/tupdesc.h.html#LN21"><span class='Ref_to_Typedef'>AttrDefault</span></a> <span class='Operator'>*</span><span class='Declare_Local'>defval</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1082"><span class='Ref_To_Local'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN75"><span class='Ref_to_Member'>constr</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN38"><span class='Ref_to_Member'>defval</span></a><span class='Delimiter'>; 
</span><a name="LN1095"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ndef</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1082"><span class='Ref_To_Local'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN75"><span class='Ref_to_Member'>constr</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN40"><span class='Ref_to_Member'>num_defval</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="rewriteHandler.c.html#LN1095"><span class='Ref_To_Local'>ndef</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1080"><span class='Ref_to_Parameter'>attrno</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN1094"><span class='Ref_To_Local'>defval</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1095"><span class='Ref_To_Local'>ndef</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/tupdesc.h.html#LN23"><span class='Ref_to_Member'>adnum</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Found it, convert string representation to node tree. 
                 */ 
</span>                <a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../nodes/read.c.html#LN36"><span class='Ref_to_Func'>stringToNode</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1094"><span class='Ref_To_Local'>defval</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1095"><span class='Ref_To_Local'>ndef</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../include/access/tupdesc.h.html#LN24"><span class='Ref_to_Member'>adbin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * No per-column default, so look for a default for the type itself. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/utils/lsyscache.h.html#LN148"><span class='Ref_to_Proto'>get_typdefault</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1084"><span class='Ref_To_Local'>atttype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* No default anywhere */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure the value is coerced to the target column type; this will 
     * generally be true already, but there seem to be some corner cases 
     * involving domain defaults where it might not be true. This should match 
     * the parser's processing of non-defaulted expressions --- see 
     * transformAssignedExpr(). 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1087"><span class='Ref_To_Local'>exprtype</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN37"><span class='Ref_to_Proto'>coerce_to_target_type</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* no UNKNOWN params here */ 
</span>                                 <a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1087"><span class='Ref_To_Local'>exprtype</span></a><span class='Delimiter'>, 
</span>                                 <a href="rewriteHandler.c.html#LN1084"><span class='Ref_To_Local'>atttype</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1085"><span class='Ref_To_Local'>atttypmod</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/nodes/primnodes.h.html#LN421"><span class='Ref_to_EnumConst'>COERCION_ASSIGNMENT</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../include/nodes/primnodes.h.html#LN438"><span class='Ref_to_EnumConst'>COERCE_IMPLICIT_CAST</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATATYPE_MISMATCH<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"column \"%s\" is of type %s"</span> 
                        <span class='String'>" but default expression is of type %s"</span><span class='Delimiter'>, 
</span>                        <a href="../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1083"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1084"><span class='Ref_To_Local'>atttype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../utils/adt/format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1087"><span class='Ref_To_Local'>exprtype</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>               <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You will need to rewrite or cast the expression."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1086"><span class='Ref_To_Local'>expr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end build_column_default &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* Does VALUES RTE contain any SetToDefault items? */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1152"></a><span class='Declare_Function'>searchForDefault</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rte</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1154"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1154"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1152"><span class='Ref_to_Parameter'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN996"><span class='Ref_to_Member'>values_lists</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1158"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>sublist</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1154"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1159"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1159"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1158"><span class='Ref_To_Local'>sublist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1163"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>col</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1159"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1163"><span class='Ref_To_Local'>col</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1251"><span class='Ref_to_Struct'>SetToDefault</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end searchForDefault &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * When processing INSERT ... VALUES with a VALUES RTE (ie, multiple VALUES 
 * lists), we have to replace any DEFAULT items in the VALUES lists with 
 * the appropriate default expressions.  The other aspects of targetlist 
 * rewriting need be applied only to the query's targetlist proper. 
 * 
 * Note that we currently can't support subscripted or field assignment 
 * in the multi-VALUES case.  The targetlist will contain simple Vars 
 * referencing the VALUES RTE, and therefore process_matched_tle() will 
 * reject any such attempt with "multiple assignments to same column". 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1184"></a><span class='Declare_Function'>rewriteValuesRTE</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rte</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>attrnos</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1186"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newValues</span><span class='Delimiter'>; 
</span><a name="LN1187"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Rebuilding all the lists is a pretty expensive proposition in a big 
     * VALUES list, and it's a waste of time if there aren't any DEFAULT 
     * placeholders.  So first scan to see if there are any. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN1151"><span class='Ref_to_Func'>searchForDefault</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>rte</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Comment_Multi_Line'>/* Check list lengths (we can assume all the VALUES sublists are alike) */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>attrnos</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN996"><span class='Ref_to_Member'>values_lists</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN1186"><span class='Ref_To_Local'>newValues</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1187"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN996"><span class='Ref_to_Member'>values_lists</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1203"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>sublist</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1187"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1204"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newList</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1205"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc3</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN179"><span class='Ref_to_Macro'>forboth</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1205"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1203"><span class='Ref_To_Local'>sublist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1206"><span class='Ref_To_Local'>lc3</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>attrnos</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1210"></a>            <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>col</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1205"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1211"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>attrno</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN106"><span class='Ref_to_Macro'>lfirst_int</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1206"><span class='Ref_To_Local'>lc3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1210"><span class='Ref_To_Local'>col</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1251"><span class='Ref_to_Struct'>SetToDefault</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1215"></a>                <a href="../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>att_tup</span><span class='Delimiter'>; 
</span><a name="LN1216"></a>                <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>new_expr</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Operator'>-&GT;</span><a href="../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1211"><span class='Ref_To_Local'>attrno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteHandler.h.html#LN24"><span class='Ref_to_Proto'>build_column_default</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1211"><span class='Ref_To_Local'>attrno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* force a NULL if dropped */ 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If there is no default (ie, default is effectively NULL), 
                 * we've got to explicitly set the column to NULL. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/makefuncs.h.html#LN49"><span class='Ref_to_Proto'>makeConst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                  <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attcollation<span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attlen<span class='Delimiter'>, 
</span>                                                  <span class='Parentheses'>(</span><a href="../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                  <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Comment_Single_Line'>/* isnull */ 
</span>                                                  <a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>attbyval<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* this is to catch a NOT NULL domain constraint */ 
</span>                    <a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a> <span class='Operator'>= </span><a href="../../include/parser/parse_coerce.h.html#LN48"><span class='Ref_to_Proto'>coerce_to_domain</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                <a href="rewriteHandler.c.html#LN1215"><span class='Ref_To_Local'>att_tup</span></a><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                                <a href="../../include/nodes/primnodes.h.html#LN438"><span class='Ref_to_EnumConst'>COERCE_IMPLICIT_CAST</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                                <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="rewriteHandler.c.html#LN1204"><span class='Ref_To_Local'>newList</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1204"><span class='Ref_To_Local'>newList</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1216"><span class='Ref_To_Local'>new_expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsA(col,SetToDefault) &raquo; </span> 
            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN1204"><span class='Ref_To_Local'>newList</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1204"><span class='Ref_To_Local'>newList</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1210"><span class='Ref_To_Local'>col</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="rewriteHandler.c.html#LN1186"><span class='Ref_To_Local'>newValues</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1186"><span class='Ref_To_Local'>newValues</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1204"><span class='Ref_To_Local'>newList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="rewriteHandler.c.html#LN1184"><span class='Ref_to_Parameter'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN996"><span class='Ref_to_Member'>values_lists</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1186"><span class='Ref_To_Local'>newValues</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rewriteValuesRTE &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * rewriteTargetListUD - rewrite UPDATE/DELETE targetlist as needed 
 * 
 * This function adds a "junk" TLE that is needed to allow the executor to 
 * find the original row for the update or delete.  When the target relation 
 * is a regular table, the junk TLE emits the ctid attribute of the original 
 * row.  When the target relation is a view, there is no ctid, so we instead 
 * emit a whole-row Var that will contain the "old" values of the view row. 
 * If it's a foreign table, we let the FDW decide what to add. 
 * 
 * For UPDATE queries, this is applied after rewriteTargetListIU.  The 
 * ordering isn't actually critical at the moment. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1272"></a><span class='Declare_Function'>rewriteTargetListUD</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>target_rte</span><span class='Delimiter'>, 
</span><a name="LN1273"></a>                    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>target_relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1275"></a>    <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>var</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1276"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>attrname</span><span class='Delimiter'>; 
</span><a name="LN1277"></a>    <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a> <span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Emit CTID so that executor can find the row to update or delete. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN1275"><span class='Ref_To_Local'>var</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN25"><span class='Ref_to_Proto'>makeVar</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                      <a href="../../include/access/sysattr.h.html#LN20"><span class='Ref_to_Const'>SelfItemPointerAttributeNumber</span></a><span class='Delimiter'>, 
</span>                      <a href="../../interfaces/ecpg/ecpglib/pg_type.h.html#LN28"><span class='Ref_to_Const'>TIDOID</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                      <a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                      <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1276"><span class='Ref_To_Local'>attrname</span></a> <span class='Operator'>= </span><span class='String'>"ctid"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Let the foreign table's FDW add whatever junk TLEs it wants. 
         */ 
</span><a name="LN1300"></a>        <a href="../../include/foreign/fdwapi.h.html#LN168"><span class='Ref_to_Struct'>FdwRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fdwroutine</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1300"><span class='Ref_To_Local'>fdwroutine</span></a> <span class='Operator'>= </span><a href="../../include/foreign/fdwapi.h.html#LN236"><span class='Ref_to_Proto'>GetFdwRoutineForRelation</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1300"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN193"><span class='Ref_to_Member'>AddForeignUpdateTargets</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN1300"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN193"><span class='Ref_to_Member'>AddForeignUpdateTargets</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>target_rte</span></a><span class='Delimiter'>, 
</span>                                                <a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we have a row-level trigger corresponding to the operation, emit 
         * a whole-row Var so that executor will have the "old" row to pass to 
         * the trigger.  Alas, this misses system columns. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>((</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a> <span class='Operator'>&& 
</span>              <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN60"><span class='Ref_to_Member'>trig_update_after_row</span></a> <span class='Operator'>|| 
</span>               <a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN59"><span class='Ref_to_Member'>trig_update_before_row</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>             <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a> <span class='Operator'>&& 
</span>              <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN65"><span class='Ref_to_Member'>trig_delete_after_row</span></a> <span class='Operator'>|| 
</span>               <a href="rewriteHandler.c.html#LN1273"><span class='Ref_to_Parameter'>target_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN64"><span class='Ref_to_Member'>trig_delete_before_row</span></a><span class='Parentheses'>))))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="rewriteHandler.c.html#LN1275"><span class='Ref_To_Local'>var</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN35"><span class='Ref_to_Proto'>makeWholeRowVar</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>target_rte</span></a><span class='Delimiter'>, 
</span>                                  <a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN1276"><span class='Ref_To_Local'>attrname</span></a> <span class='Operator'>= </span><span class='String'>"wholerow"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if target_relation-&GT;rd_r... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Emit whole-row Var so that executor will have the "old" view row to 
         * pass to the INSTEAD OF trigger. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN1275"><span class='Ref_To_Local'>var</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN35"><span class='Ref_to_Proto'>makeWholeRowVar</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>target_rte</span></a><span class='Delimiter'>, 
</span>                              <a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                              <span class='Number'>0</span><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1276"><span class='Ref_To_Local'>attrname</span></a> <span class='Operator'>= </span><span class='String'>"wholerow"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1275"><span class='Ref_To_Local'>var</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="rewriteHandler.c.html#LN1277"><span class='Ref_To_Local'>tle</span></a> <span class='Operator'>= </span><a href="../../include/nodes/makefuncs.h.html#LN40"><span class='Ref_to_Proto'>makeTargetEntry</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN131"><span class='Ref_to_Struct'>Expr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1275"><span class='Ref_To_Local'>var</span></a><span class='Delimiter'>, 
</span>                              <a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                              <a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1276"><span class='Ref_To_Local'>attrname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                              <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1272"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1277"><span class='Ref_To_Local'>tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end rewriteTargetListUD &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * matchLocks - 
 *    match the list of locks and returns the matching rules 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN1360"></a><span class='Declare_Function'>matchLocks</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN1361"></a>           <a href="../../include/rewrite/prs2lock.h.html#LN39"><span class='Ref_to_Struct'>RuleLock</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rulelocks</span><span class='Delimiter'>, 
</span><a name="LN1362"></a>           <span class='Keyword'>int </span><span class='Declare_Parameter'>varno</span><span class='Delimiter'>, 
</span><a name="LN1363"></a>           <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN1364"></a>           <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>hasUpdate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1366"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>matching_locks</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN1367"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nlocks</span><span class='Delimiter'>; 
</span><a name="LN1368"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1361"><span class='Ref_to_Parameter'>rulelocks</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1363"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1363"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN1362"><span class='Ref_to_Parameter'>varno</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="rewriteHandler.c.html#LN1367"><span class='Ref_To_Local'>nlocks</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1361"><span class='Ref_to_Parameter'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN1368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="rewriteHandler.c.html#LN1367"><span class='Ref_To_Local'>nlocks</span></a><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN1368"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1383"></a>        <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oneLock</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1361"><span class='Ref_to_Parameter'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN1364"><span class='Ref_to_Parameter'>hasUpdate</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Suppress ON INSERT/UPDATE/DELETE rules that are disabled or 
         * configured to not fire during the current sessions replication 
         * role. ON SELECT rules will always be applied in order to keep views 
         * working even in LOCAL or REPLICA role. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../commands/trigger.c.html#LN63"><span class='Ref_to_Global_Var'>SessionReplicationRole</span></a> <span class='Operator'>== </span><a href="../../include/commands/trigger.h.html#LN100"><span class='Ref_to_Const'>SESSION_REPLICATION_ROLE_REPLICA</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN29"><span class='Ref_to_Member'>enabled</span></a> <span class='Operator'>== </span><a href="../../include/rewrite/rewriteDefine.h.html#LN20"><span class='Ref_to_Const'>RULE_FIRES_ON_ORIGIN</span></a> <span class='Operator'>|| 
</span>                    <a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN29"><span class='Ref_to_Member'>enabled</span></a> <span class='Operator'>== </span><a href="../../include/rewrite/rewriteDefine.h.html#LN23"><span class='Ref_to_Const'>RULE_DISABLED</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span>    <span class='Comment_Single_Line'>/* ORIGIN or LOCAL ROLE */ 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN29"><span class='Ref_to_Member'>enabled</span></a> <span class='Operator'>== </span><a href="../../include/rewrite/rewriteDefine.h.html#LN22"><span class='Ref_to_Const'>RULE_FIRES_ON_REPLICA</span></a> <span class='Operator'>|| 
</span>                    <a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN29"><span class='Ref_to_Member'>enabled</span></a> <span class='Operator'>== </span><a href="../../include/rewrite/rewriteDefine.h.html#LN23"><span class='Ref_to_Const'>RULE_DISABLED</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN1360"><span class='Ref_to_Parameter'>event</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1363"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a> <span class='Operator'>|| 
</span>                <a href="../../include/rewrite/rewriteManip.h.html#LN49"><span class='Ref_to_Proto'>rangeTableEntry_used</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1363"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1362"><span class='Ref_to_Parameter'>varno</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
                <a href="rewriteHandler.c.html#LN1366"><span class='Ref_To_Local'>matching_locks</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1366"><span class='Ref_To_Local'>matching_locks</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1383"><span class='Ref_To_Local'>oneLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nlocks;i++ &raquo; </span> 
 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1366"><span class='Ref_To_Local'>matching_locks</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end matchLocks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ApplyRetrieveRule - expand an ON SELECT rule 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN1426"></a><span class='Declare_Function'>ApplyRetrieveRule</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN1427"></a>                  <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule</span><span class='Delimiter'>, 
</span><a name="LN1428"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Delimiter'>, 
</span><a name="LN1429"></a>                  <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN1430"></a>                  <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>activeRIRs</span><span class='Delimiter'>, 
</span><a name="LN1431"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>forUpdatePushedDown</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1433"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>rule_action</span><span class='Delimiter'>; 
</span><a name="LN1434"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>, 
</span><a name="LN1435"></a>               <span class='Operator'>*</span><span class='Declare_Local'>subrte</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>    <a href="../../include/nodes/parsenodes.h.html#LN1278"><span class='Ref_to_Struct'>RowMarkClause</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1427"><span class='Ref_to_Parameter'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"expected just one rule action"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1427"><span class='Ref_to_Parameter'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN27"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot handle qualified ON SELECT rule"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1428"><span class='Ref_to_Parameter'>rt_index</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We have a view as the result relation of the query, and it wasn't 
         * rewritten by any rule.  This case is supported if there is an 
         * INSTEAD OF trigger that will trap attempts to insert/update/delete 
         * view rows.  The executor will check that; for the moment just plow 
         * ahead.  We have two cases: 
         * 
         * For INSERT, we needn't do anything.  The unmodified RTE will serve 
         * fine as the result relation. 
         * 
         * For UPDATE/DELETE, we need to expand the view so as to have source 
         * data for the operation.  But we also need an unmodified RTE to 
         * serve as the target.  So, copy the RTE and add the copy to the 
         * rangetable.  Note that the copy does not get added to the jointree. 
         * Also note that there's a hack in fireRIRrules to avoid calling this 
         * function again when it arrives at the copied RTE. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a> <span class='Operator'>|| 
</span>                 <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1467"></a>            <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newrte</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1428"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1467"><span class='Ref_To_Local'>newrte</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1467"><span class='Ref_To_Local'>newrte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * There's no need to do permissions checks twice, so wipe out the 
             * permissions info for the original RTE (we prefer to keep the 
             * bits set on the result RTE). 
             */ 
</span>            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * For the most part, Vars referencing the view should remain as 
             * they are, meaning that they implicitly represent OLD values. 
             * But in the RETURNING list if any, we want such Vars to 
             * represent NEW values, so change them to reference the new RTE. 
             * 
             * Since ChangeVarNodes scribbles on the tree in-place, copy the 
             * RETURNING list first for safety. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1428"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, 
</span>                           <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Now, continue with expanding the original view RTE */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;commandTyp... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized commandType: %d"</span><span class='Delimiter'>, 
</span>                 <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rt_index==parsetree-&GT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If FOR [KEY] UPDATE/SHARE of view, be sure we get right initial lock on 
     * the relations it references. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1436"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN76"><span class='Ref_to_Proto'>get_parse_rowmark</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1428"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1431"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1436"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a modifiable copy of the view query, and acquire needed locks on 
     * the relations it mentions. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1427"><span class='Ref_to_Parameter'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/rewrite/rewriteHandler.h.html#LN20"><span class='Ref_to_Proto'>AcquireRewriteLocks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1431"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recursively expand any view references inside the view. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN81"><span class='Ref_to_Proto'>fireRIRrules</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1430"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1431"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now, plug the view query in as a subselect, replacing the relation's 
     * original RTE. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1428"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN955"><span class='Ref_to_Member'>security_barrier</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN347"><span class='Ref_to_Macro'>RelationIsSecurityView</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1429"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1025"><span class='Ref_to_Member'>inh</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* must not be set for a subquery */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We move the view's permission check data down to its rangetable. The 
     * checks will actually be done against the OLD entry therein. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN159"><span class='Ref_to_Const'>PRS2_OLD_VARNO</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN1429"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1435"><span class='Ref_To_Local'>subrte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* no permission check on subquery itself */ 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a> <span class='Operator'>= </span><a href="../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN1434"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If FOR [KEY] UPDATE/SHARE of view, mark all the contained tables as 
     * implicit FOR [KEY] UPDATE/SHARE, the same as the parser would have done 
     * if the view's subquery had been written out explicitly. 
     * 
     * Note: we don't consider forUpdatePushedDown here; such marks will be 
     * made by recursing from the upper level in markQueryForLocking. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1436"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="rewriteHandler.c.html#LN76"><span class='Ref_to_Proto'>markQueryForLocking</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1433"><span class='Ref_To_Local'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteHandler.c.html#LN1436"><span class='Ref_To_Local'>rc</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1282"><span class='Ref_to_Member'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1436"><span class='Ref_To_Local'>rc</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1283"><span class='Ref_to_Member'>waitPolicy</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1426"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ApplyRetrieveRule &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Recursively mark all relations used by a view as FOR [KEY] UPDATE/SHARE. 
 * 
 * This may generate an invalid query, eg if some sub-query uses an 
 * aggregate.  We leave it to the planner to detect that. 
 * 
 * NB: this must agree with the parser's transformLockingClause() routine. 
 * However, unlike the parser we have to be careful not to mark a view's 
 * OLD and NEW rels for updating.  The best way to handle that seems to be 
 * to scan the jointree to determine which rels are used. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1582"></a><span class='Declare_Function'>markQueryForLocking</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qry</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>jtnode</span><span class='Delimiter'>, 
</span><a name="LN1583"></a>                    <a href="../../include/nodes/lockoptions.h.html#LN20"><span class='Ref_to_Enum'>LockClauseStrength</span></a> <span class='Declare_Parameter'>strength</span><span class='Delimiter'>, </span><a href="../../include/nodes/lockoptions.h.html#LN35"><span class='Ref_to_Enum'>LockWaitPolicy</span></a> <span class='Declare_Parameter'>waitPolicy</span><span class='Delimiter'>, 
</span><a name="LN1584"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>pushedDown</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1590"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rti</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>rtindex<span class='Delimiter'>; 
</span><a name="LN1591"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1590"><span class='Ref_To_Local'>rti</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1591"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/parser/analyze.h.html#LN41"><span class='Ref_to_Proto'>applyLockingClause</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1590"><span class='Ref_To_Local'>rti</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1584"><span class='Ref_to_Parameter'>pushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN1591"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>|= </span><a href="../../include/nodes/parsenodes.h.html#LN87"><span class='Ref_to_Const'>ACL_SELECT_FOR_UPDATE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1591"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/parser/analyze.h.html#LN41"><span class='Ref_to_Proto'>applyLockingClause</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1590"><span class='Ref_To_Local'>rti</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1584"><span class='Ref_to_Parameter'>pushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* FOR UPDATE/SHARE of subquery is propagated to subquery's rels */ 
</span>            <a href="rewriteHandler.c.html#LN76"><span class='Ref_to_Proto'>markQueryForLocking</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1591"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1591"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Delimiter'>, 
</span>                                <a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* other RTE types are unaffected by FOR UPDATE */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1466"><span class='Ref_to_Struct'>FromExpr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1609"></a>        <a href="../../include/nodes/primnodes.h.html#LN1466"><span class='Ref_to_Struct'>FromExpr</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>f</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1466"><span class='Ref_to_Struct'>FromExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Delimiter'>; 
</span><a name="LN1610"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1610"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1609"><span class='Ref_To_Local'>f</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>) 
</span><a name="LN1613"></a>            <span class='Declare_Local'>markQueryForLocking</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1610"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1584"><span class='Ref_to_Parameter'>pushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1444"><span class='Ref_to_Struct'>JoinExpr</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1617"></a>        <a href="../../include/nodes/primnodes.h.html#LN1444"><span class='Ref_to_Struct'>JoinExpr</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>j</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1444"><span class='Ref_to_Struct'>JoinExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN76"><span class='Ref_to_Proto'>markQueryForLocking</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1617"><span class='Ref_To_Local'>j</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1449"><span class='Ref_to_Member'>larg</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1584"><span class='Ref_to_Parameter'>pushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN76"><span class='Ref_to_Proto'>markQueryForLocking</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>qry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1617"><span class='Ref_To_Local'>j</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1450"><span class='Ref_to_Member'>rarg</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>strength</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1583"><span class='Ref_to_Parameter'>waitPolicy</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1584"><span class='Ref_to_Parameter'>pushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized node type: %d"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../include/nodes/nodes.h.html#LN513"><span class='Ref_to_Macro'>nodeTag</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1582"><span class='Ref_to_Parameter'>jtnode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end markQueryForLocking &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * fireRIRonSubLink - 
 *  Apply fireRIRrules() to each SubLink (subselect in expression) found 
 *  in the given tree. 
 * 
 * NOTE: although this has the form of a walker, we cheat and modify the 
 * SubLink nodes in-place.  It is caller's responsibility to ensure that 
 * no unwanted side-effects occur! 
 * 
 * This is unlike most of the other routines that recurse into subselects, 
 * because we must take control at the SubLink node in order to replace 
 * the SubLink's subselect link with the possibly-rewritten subquery. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1642"></a><span class='Declare_Function'>fireRIRonSubLink</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>activeRIRs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>node</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1648"></a>        <a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>sub</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do what we came for */ 
</span>        <a href="rewriteHandler.c.html#LN1648"><span class='Ref_To_Local'>sub</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN636"><span class='Ref_to_Member'>subselect</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN81"><span class='Ref_to_Proto'>fireRIRrules</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1648"><span class='Ref_To_Local'>sub</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN636"><span class='Ref_to_Member'>subselect</span></a><span class='Delimiter'>, 
</span>                                               <a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Fall through to process lefthand args of SubLink */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do NOT recurse into Query nodes, because fireRIRrules already processed 
     * subselects of subselects for us. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1641"><span class='Ref_to_Func'>fireRIRonSubLink</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1642"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fireRIRonSubLink &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * fireRIRrules - 
 *  Apply all RIR rules on each rangetable entry in a query 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN1670"></a><span class='Declare_Function'>fireRIRrules</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>activeRIRs</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>forUpdatePushedDown</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1672"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>origResultRelation</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>; 
</span><a name="LN1673"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rt_index</span><span class='Delimiter'>; 
</span><a name="LN1674"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * don't try to convert this into a foreach loop, because rtable list can 
     * get changed each time through... 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>&LT; </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1683"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span><span class='Delimiter'>; 
</span><a name="LN1684"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1685"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>locks</span><span class='Delimiter'>; 
</span><a name="LN1686"></a>        <a href="../../include/rewrite/prs2lock.h.html#LN39"><span class='Ref_to_Struct'>RuleLock</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>rules</span><span class='Delimiter'>; 
</span><a name="LN1687"></a>        <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rule</span><span class='Delimiter'>; 
</span><a name="LN1688"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>++</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * A subquery RTE can't have associated rules, so there's nothing to 
         * do to this level of the query, but we must recurse into the 
         * subquery to expand any rule references in it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN81"><span class='Ref_to_Proto'>fireRIRrules</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a> <span class='Operator'>|| 
</span>                            <a href="../../include/parser/parsetree.h.html#LN76"><span class='Ref_to_Proto'>get_parse_rowmark</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Joins and other non-relation RTEs can be ignored completely. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Always ignore RIR rules for materialized views referenced in 
         * queries.  (This does not prevent refreshing MVs, since they aren't 
         * referenced in their own query definitions.) 
         * 
         * Note: in the future we might want to allow MVs to be conditionally 
         * expanded as if they were regular views, if they are not scannable. 
         * In that case this test would need to be postponed till after we've 
         * opened the rel, so that we could check its state. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN164"><span class='Ref_to_Const'>RELKIND_MATVIEW</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the table is not referenced in the query, then we ignore it. 
         * This prevents infinite expansion loop due to new rtable entries 
         * inserted by expansion of a rule. A table is referenced if it is 
         * part of the join set (a source table), or is referenced by any Var 
         * nodes, or is the result table. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../include/rewrite/rewriteManip.h.html#LN49"><span class='Ref_to_Proto'>rangeTableEntry_used</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Also, if this is a new result relation introduced by 
         * ApplyRetrieveRule, we don't want to do anything more with it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>&& 
</span>            <a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN1672"><span class='Ref_To_Local'>origResultRelation</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can use NoLock here since either the parser or 
         * AcquireRewriteLocks should have locked the rel already. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1683"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Collect the RIR rules that we must apply 
         */ 
</span>        <a href="rewriteHandler.c.html#LN1686"><span class='Ref_To_Local'>rules</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1686"><span class='Ref_To_Local'>rules</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="rewriteHandler.c.html#LN1685"><span class='Ref_To_Local'>locks</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1688"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN1688"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="rewriteHandler.c.html#LN1686"><span class='Ref_To_Local'>rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN1688"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN1687"><span class='Ref_To_Local'>rule</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1686"><span class='Ref_To_Local'>rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN1688"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1687"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN1685"><span class='Ref_To_Local'>locks</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1685"><span class='Ref_To_Local'>locks</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1687"><span class='Ref_To_Local'>rule</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we found any, apply them --- but first check for recursion! 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1685"><span class='Ref_To_Local'>locks</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1772"></a>                <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)))</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"infinite recursion detected in rules for relation \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN217"><span class='Ref_to_Proto'>lcons_oid</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1772"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1685"><span class='Ref_To_Local'>locks</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="rewriteHandler.c.html#LN1687"><span class='Ref_To_Local'>rule</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1772"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1425"><span class='Ref_to_Func'>ApplyRetrieveRule</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1687"><span class='Ref_To_Local'>rule</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>forUpdatePushedDown</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if locks!=NIL &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rules!=NULL &raquo; </span> 
 
        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1684"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while rt_index&LT;list_length(... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Recurse into subqueries in WITH */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1674"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1803"></a>        <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1674"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1803"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN81"><span class='Ref_to_Proto'>fireRIRrules</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1803"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recurse into sublink subqueries, too.  But we already did the ones in 
     * the rtable and cteList. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>        <a href="../../include/nodes/nodeFuncs.h.html#LN57"><span class='Ref_to_Proto'>query_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1641"><span class='Ref_to_Func'>fireRIRonSubLink</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/nodes/nodeFuncs.h.html#LN21"><span class='Ref_to_Const'>QTW_IGNORE_RC_SUBQUERIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Apply any row level security policies.  We do this last because it 
     * requires special recursion detection if the new quals have sublink 
     * subqueries, and if we did it in the loop above query_tree_walker would 
     * then recurse into those quals a second time. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1674"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1826"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1674"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1827"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN1828"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>securityQuals</span><span class='Delimiter'>; 
</span><a name="LN1829"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>withCheckOptions</span><span class='Delimiter'>; 
</span><a name="LN1830"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>hasRowSecurity</span><span class='Delimiter'>; 
</span><a name="LN1831"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>hasSubLinks</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>++</span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Only normal relations can have RLS policies */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>             <a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN1827"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fetch any new security quals that must be applied to this RTE. 
         */ 
</span>        <a href="../../include/rewrite/rowsecurity.h.html#LN43"><span class='Ref_to_Proto'>get_row_security_policies</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1673"><span class='Ref_To_Local'>rt_index</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1828"><span class='Ref_To_Local'>securityQuals</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1829"><span class='Ref_To_Local'>withCheckOptions</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1830"><span class='Ref_To_Local'>hasRowSecurity</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1831"><span class='Ref_To_Local'>hasSubLinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1828"><span class='Ref_To_Local'>securityQuals</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN1829"><span class='Ref_To_Local'>withCheckOptions</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1831"><span class='Ref_To_Local'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1854"></a>                <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Recursively process the new quals, checking for infinite 
                 * recursion. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Delimiter'>, </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1827"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)))</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"infinite recursion detected in policy for relation \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1827"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN217"><span class='Ref_to_Proto'>lcons_oid</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1827"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * get_row_security_policies just passed back securityQuals 
                 * and/or withCheckOptions, and there were SubLinks, make sure 
                 * we lock any relations which are referenced. 
                 * 
                 * These locks would normally be acquired by the parser, but 
                 * securityQuals and withCheckOptions are added post-parsing. 
                 */ 
</span>                <a href="rewriteHandler.c.html#LN1854"><span class='Ref_To_Local'>context</span></a><span class='Operator'>.</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1828"><span class='Ref_To_Local'>securityQuals</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1854"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1829"><span class='Ref_To_Local'>withCheckOptions</span></a><span class='Delimiter'>, 
</span>                                              <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1854"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Now that we have the locks on anything added by 
                 * get_row_security_policies, fire any RIR rules for them. 
                 */ 
</span>                <a href="../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1828"><span class='Ref_To_Local'>securityQuals</span></a><span class='Delimiter'>, 
</span>                                       <a href="rewriteHandler.c.html#LN1641"><span class='Ref_to_Func'>fireRIRonSubLink</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1829"><span class='Ref_To_Local'>withCheckOptions</span></a><span class='Delimiter'>, 
</span>                                       <a href="rewriteHandler.c.html#LN1641"><span class='Ref_to_Func'>fireRIRonSubLink</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>activeRIRs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if hasSubLinks &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * Add the new security barrier quals to the start of the RTE's 
             * list so that they get applied before any existing barrier quals 
             * (which would have come from a security-barrier view, and should 
             * get lower priority than RLS conditions on the table itself). 
             */ 
</span>            <a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1828"><span class='Ref_To_Local'>securityQuals</span></a><span class='Delimiter'>, 
</span>                                             <a href="rewriteHandler.c.html#LN1826"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1829"><span class='Ref_To_Local'>withCheckOptions</span></a><span class='Delimiter'>, 
</span>                                                <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if securityQuals!=NIL||w... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Make sure the query is marked correctly if row level security 
         * applies, or if the new quals had sublinks. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1830"><span class='Ref_To_Local'>hasRowSecurity</span></a><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN130"><span class='Ref_to_Member'>hasRowSecurity</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1831"><span class='Ref_To_Local'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1827"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fireRIRrules &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Modify the given query by adding 'AND rule_qual IS NOT TRUE' to its 
 * qualification.  This is used to generate suitable "else clauses" for 
 * conditional INSTEAD rules.  (Unfortunately we must use "x IS NOT TRUE", 
 * not just "NOT x" which the planner is much smarter about, else we will 
 * do the wrong thing when the qual evaluates to NULL.) 
 * 
 * The rule_qual may contain references to OLD or NEW.  OLD references are 
 * replaced by references to the specified rt_index (the relation that the 
 * rule applies to).  NEW references are only possible for INSERT and UPDATE 
 * queries on the relation itself, and so they should be replaced by copies 
 * of the related entries in the query's own targetlist. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN1937"></a><span class='Declare_Function'>CopyAndAddInvertedQual</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN1938"></a>                       <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rule_qual</span><span class='Delimiter'>, 
</span><a name="LN1939"></a>                       <span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Delimiter'>, 
</span><a name="LN1940"></a>                       <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Don't scribble on the passed qual (it's in the relcache!) */ 
</span><a name="LN1943"></a>    <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>new_qual</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1938"><span class='Ref_to_Parameter'>rule_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1944"></a>    <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN1944"><span class='Ref_To_Local'>context</span></a><span class='Operator'>.</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In case there are subqueries in the qual, acquire necessary locks and 
     * fix any deleted JOIN RTE entries.  (This is somewhat redundant with 
     * rewriteRuleAction, but not entirely ... consider restructuring so that 
     * we only need to process the qual this way once.) 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1943"><span class='Ref_To_Local'>new_qual</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1944"><span class='Ref_To_Local'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fix references to OLD */ 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1943"><span class='Ref_To_Local'>new_qual</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN159"><span class='Ref_to_Const'>PRS2_OLD_VARNO</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1939"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Fix references to NEW */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1940"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN1940"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) 
</span>        <a href="rewriteHandler.c.html#LN1943"><span class='Ref_To_Local'>new_qual</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN76"><span class='Ref_to_Proto'>ReplaceVarsFromTargetList</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1943"><span class='Ref_To_Local'>new_qual</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../include/nodes/primnodes.h.html#LN160"><span class='Ref_to_Const'>PRS2_NEW_VARNO</span></a><span class='Delimiter'>, 
</span>                                             <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                             <a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1939"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, 
</span>                                                      <a href="rewriteHandler.c.html#LN1937"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="rewriteHandler.c.html#LN1937"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                                             <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1940"><span class='Ref_to_Parameter'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) </span><span class='Operator'>? 
</span>                                             <a href="../../include/rewrite/rewriteManip.h.html#LN36"><span class='Ref_to_EnumConst'>REPLACEVARS_CHANGE_VARNO</span></a> <span class='Operator'>: 
</span>                                             <a href="../../include/rewrite/rewriteManip.h.html#LN37"><span class='Ref_to_EnumConst'>REPLACEVARS_SUBSTITUTE_NULL</span></a><span class='Delimiter'>, 
</span>                                             <a href="rewriteHandler.c.html#LN1939"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, 
</span>                                             <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN1937"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* And attach the fixed qual */ 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN55"><span class='Ref_to_Proto'>AddInvertedQual</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN1937"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN1943"><span class='Ref_To_Local'>new_qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN1937"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CopyAndAddInvertedQual &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  fireRules - 
 *     Iterate through rule locks applying rules. 
 * 
 * Input arguments: 
 *  parsetree - original query 
 *  rt_index - RT index of result relation in original query 
 *  event - type of rule event 
 *  locks - list of rules to fire 
 * Output arguments: 
 *  *instead_flag - set TRUE if any unqualified INSTEAD rule is found 
 *                  (must be initialized to FALSE) 
 *  *returning_flag - set TRUE if we rewrite RETURNING clause in any rule 
 *                  (must be initialized to FALSE) 
 *  *qual_product - filled with modified original query if any qualified 
 *                  INSTEAD rule is found (must be initialized to NULL) 
 * Return value: 
 *  list of rule actions adjusted for use with this query 
 * 
 * Qualified INSTEAD rules generate their action with the qualification 
 * condition added.  They also generate a modified version of the original 
 * query with the negated qualification added, so that it will run only for 
 * rows that the qualified action doesn't act on.  (If there are multiple 
 * qualified INSTEAD rules, we AND all the negated quals onto a single 
 * modified original query.)  We won't execute the original, unmodified 
 * query if we find either qualified or unqualified INSTEAD rules.  If 
 * we find both, the modified original query is discarded too. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN2007"></a><span class='Declare_Function'>fireRules</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, 
</span><a name="LN2008"></a>          <span class='Keyword'>int </span><span class='Declare_Parameter'>rt_index</span><span class='Delimiter'>, 
</span><a name="LN2009"></a>          <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Delimiter'>, 
</span><a name="LN2010"></a>          <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locks</span><span class='Delimiter'>, 
</span><a name="LN2011"></a>          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>instead_flag</span><span class='Delimiter'>, 
</span><a name="LN2012"></a>          <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>returning_flag</span><span class='Delimiter'>, 
</span><a name="LN2013"></a>          <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>qual_product</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2015"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>results</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN2016"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2016"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2010"><span class='Ref_to_Parameter'>locks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2020"></a>        <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rule_lock</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2016"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2021"></a>        <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>event_qual</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2020"><span class='Ref_To_Local'>rule_lock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN27"><span class='Ref_to_Member'>qual</span></a><span class='Delimiter'>; 
</span><a name="LN2022"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>actions</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2020"><span class='Ref_To_Local'>rule_lock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Delimiter'>; 
</span><a name="LN2023"></a>        <a href="../../include/nodes/parsenodes.h.html#LN37"><span class='Ref_to_Enum'>QuerySource</span></a> <span class='Declare_Local'>qsrc</span><span class='Delimiter'>; 
</span><a name="LN2024"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Determine correct QuerySource value for actions */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2020"><span class='Ref_To_Local'>rule_lock</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN30"><span class='Ref_to_Member'>isInstead</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2021"><span class='Ref_To_Local'>event_qual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2023"><span class='Ref_To_Local'>qsrc</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN42"><span class='Ref_to_EnumConst'>QSRC_QUAL_INSTEAD_RULE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN2023"><span class='Ref_To_Local'>qsrc</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN41"><span class='Ref_to_EnumConst'>QSRC_INSTEAD_RULE</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2011"><span class='Ref_to_Parameter'>instead_flag</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* report unqualified INSTEAD */ 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="rewriteHandler.c.html#LN2023"><span class='Ref_To_Local'>qsrc</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN43"><span class='Ref_to_EnumConst'>QSRC_NON_INSTEAD_RULE</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2023"><span class='Ref_To_Local'>qsrc</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN42"><span class='Ref_to_EnumConst'>QSRC_QUAL_INSTEAD_RULE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * If there are INSTEAD rules with qualifications, the original 
             * query is still performed. But all the negated rule 
             * qualifications of the INSTEAD rules are added so it does its 
             * actions only in cases where the rule quals of all INSTEAD rules 
             * are false. Think of it as the default action in a case. We save 
             * this in *qual_product so RewriteQuery() can add it to the query 
             * list after we mangled it up enough. 
             * 
             * If we have already found an unqualified INSTEAD rule, then 
             * *qual_product won't be used, so don't bother building it. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!*</span><a href="rewriteHandler.c.html#LN2011"><span class='Ref_to_Parameter'>instead_flag</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2013"><span class='Ref_to_Parameter'>qual_product</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2013"><span class='Ref_to_Parameter'>qual_product</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2007"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2013"><span class='Ref_to_Parameter'>qual_product</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN1936"><span class='Ref_to_Func'>CopyAndAddInvertedQual</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2013"><span class='Ref_to_Parameter'>qual_product</span></a><span class='Delimiter'>, 
</span>                                                       <a href="rewriteHandler.c.html#LN2021"><span class='Ref_To_Local'>event_qual</span></a><span class='Delimiter'>, 
</span>                                                       <a href="rewriteHandler.c.html#LN2008"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, 
</span>                                                       <a href="rewriteHandler.c.html#LN2009"><span class='Ref_to_Parameter'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if qsrc==QSRC_QUAL_INSTE... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Now process the rule's actions and add them to the result list */ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2024"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2022"><span class='Ref_To_Local'>actions</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2068"></a>            <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>rule_action</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2024"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN656"><span class='Ref_to_EnumConst'>CMD_NOTHING</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN55"><span class='Ref_to_Proto'>rewriteRuleAction</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2007"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a><span class='Delimiter'>, 
</span>                                            <a href="rewriteHandler.c.html#LN2021"><span class='Ref_To_Local'>event_qual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2008"><span class='Ref_to_Parameter'>rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2009"><span class='Ref_to_Parameter'>event</span></a><span class='Delimiter'>, 
</span>                                            <a href="rewriteHandler.c.html#LN2012"><span class='Ref_to_Parameter'>returning_flag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2023"><span class='Ref_To_Local'>qsrc</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* might change later */ 
</span> 
            <a href="rewriteHandler.c.html#LN2015"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2015"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2068"><span class='Ref_To_Local'>rule_action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2015"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fireRules &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * get_view_query - get the Query from a view's _RETURN rule. 
 * 
 * Caller should have verified that the relation is a view, and therefore 
 * we should find an ON SELECT action. 
 * 
 * Note that the pointer returned is into the relcache and therefore must 
 * be treated as read-only to the caller and not modified or scribbled on. 
 */ 
</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN2098"></a><span class='Declare_Function'>get_view_query</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>view</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2100"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2098"><span class='Ref_to_Parameter'>view</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2100"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN2100"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="rewriteHandler.c.html#LN2098"><span class='Ref_to_Parameter'>view</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN2100"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2106"></a>        <a href="../../include/rewrite/prs2lock.h.html#LN23"><span class='Ref_to_Struct'>RewriteRule</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rule</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2098"><span class='Ref_to_Parameter'>view</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN2100"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2106"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* A _RETURN rule should have only one action */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2106"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid _RETURN rule action specification"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2106"><span class='Ref_To_Local'>rule</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN28"><span class='Ref_to_Member'>actions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to find _RETURN rule for view"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end get_view_query &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * view_has_instead_trigger - does view have an INSTEAD OF trigger for event? 
 * 
 * If it does, we don't want to treat it as auto-updatable.  This test can't 
 * be folded into view_query_is_auto_updatable because it's not an error 
 * condition. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2131"></a><span class='Declare_Function'>view_has_instead_trigger</span><span class='Parentheses'>(</span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>view</span><span class='Delimiter'>, </span><a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a> <span class='Declare_Parameter'>event</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2133"></a>    <a href="../../include/utils/reltrigger.h.html#LN45"><span class='Ref_to_Struct'>TriggerDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigDesc</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2131"><span class='Ref_to_Parameter'>view</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2131"><span class='Ref_to_Parameter'>event</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN56"><span class='Ref_to_Member'>trig_insert_instead_row</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN61"><span class='Ref_to_Member'>trig_update_instead_row</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN2133"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN66"><span class='Ref_to_Member'>trig_delete_instead_row</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized CmdType: %d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2131"><span class='Ref_to_Parameter'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end view_has_instead_trigger &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * view_col_is_auto_updatable - test whether the specified column of a view 
 * is auto-updatable. Returns NULL (if the column can be updated) or a message 
 * string giving the reason that it cannot be. 
 * 
 * Note that the checks performed here are local to this view. We do not check 
 * whether the referenced column of the underlying base relation is updatable. 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN2166"></a><span class='Declare_Function'>view_col_is_auto_updatable</span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rtr</span><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2168"></a>    <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>var</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2166"><span class='Ref_to_Parameter'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For now, the only updatable columns we support are those that are Vars 
     * referring to user columns of the underlying base relation. 
     * 
     * The view targetlist may contain resjunk columns (e.g., a view defined 
     * like "SELECT * FROM t ORDER BY a+b" is auto-updatable) but such columns 
     * are not auto-updatable, and in fact should never appear in the outer 
     * query's targetlist. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2166"><span class='Ref_to_Parameter'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Junk view columns are not updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2168"><span class='Ref_To_Local'>var</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN2168"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN165"><span class='Ref_to_Member'>varno</span></a> <span class='Operator'>!= </span><a href="rewriteHandler.c.html#LN2166"><span class='Ref_to_Parameter'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a> <span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN2168"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN172"><span class='Ref_to_Member'>varlevelsup</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"View columns that are not columns of their base relation are not updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2168"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"View columns that refer to system columns are not updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2168"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"View columns that return whole-row references are not updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* the view column is updatable */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end view_col_is_auto_updatable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * view_query_is_auto_updatable - test whether the specified view definition 
 * represents an auto-updatable view. Returns NULL (if the view can be updated) 
 * or a message string giving the reason that it cannot be. 
 * 
 * If check_cols is true, the view is required to have at least one updatable 
 * column (necessary for INSERT/UPDATE). Otherwise the view's columns are not 
 * checked for updatability. See also view_cols_are_auto_updatable. 
 * 
 * Note that the checks performed here are only based on the view definition. 
 * We do not check whether any base relations referred to by the view are 
 * updatable. 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN2211"></a><span class='Declare_Function'>view_query_is_auto_updatable</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>viewquery</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>check_cols</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2213"></a>    <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span><span class='Delimiter'>; 
</span><a name="LN2214"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>base_rte</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Check if the view is simply updatable.  According to SQL-92 this means: 
     *  - No DISTINCT clause. 
     *  - Each TLE is a column reference, and each column appears at most once. 
     *  - FROM contains exactly one base relation. 
     *  - No GROUP BY or HAVING clauses. 
     *  - No set operations (UNION, INTERSECT or EXCEPT). 
     *  - No sub-queries in the WHERE clause that reference the target table. 
     * 
     * We ignore that last restriction since it would be complex to enforce 
     * and there isn't any actual benefit to disallowing sub-queries.  (The 
     * semantic issues that the standard is presumably concerned about don't 
     * arise in Postgres, since any such sub-query will not see any updates 
     * executed by the outer query anyway, thanks to MVCC snapshotting.) 
     * 
     * We also relax the second restriction by supporting part of SQL:1999 
     * feature T111, which allows for a mix of updatable and non-updatable 
     * columns, provided that an INSERT or UPDATE doesn't attempt to assign to 
     * a non-updatable column. 
     * 
     * In addition we impose these constraints, involving features that are 
     * not part of SQL-92: 
     *  - No CTEs (WITH clauses). 
     *  - No OFFSET or LIMIT clauses (this matches a SQL:2008 restriction). 
     *  - No system columns (including whole-row references) in the tlist. 
     *  - No window functions in the tlist. 
     *  - No set-returning functions in the tlist. 
     * 
     * Note that we do these checks without recursively expanding the view. 
     * If the base relation is a view, we'll recursively deal with it later. 
     *---------- 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN153"><span class='Ref_to_Member'>distinctClause</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing DISTINCT are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN145"><span class='Ref_to_Member'>groupClause</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN147"><span class='Ref_to_Member'>groupingSets</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing GROUP BY are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN149"><span class='Ref_to_Member'>havingQual</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing HAVING are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN162"><span class='Ref_to_Member'>setOperations</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing UNION, INTERSECT, or EXCEPT are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing WITH are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN157"><span class='Ref_to_Member'>limitOffset</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN158"><span class='Ref_to_Member'>limitCount</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing LIMIT or OFFSET are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must not allow window functions or set returning functions in the 
     * targetlist. Otherwise we might end up inserting them into the quals of 
     * the main query. We must also check for aggregates in the targetlist in 
     * case they appear without a GROUP BY. 
     * 
     * These restrictions ensure that each row of the view corresponds to a 
     * unique row in the underlying base relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN122"><span class='Ref_to_Member'>hasAggs</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that return aggregate functions are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN123"><span class='Ref_to_Member'>hasWindowFuncs</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that return window functions are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN124"><span class='Ref_to_Member'>hasTargetSRFs</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that return set-returning functions are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The view query should select from a single base relation, which must be 
     * a table or another view. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that do not select from a single table or view are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2213"><span class='Ref_To_Local'>rtr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2213"><span class='Ref_To_Local'>rtr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that do not select from a single table or view are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2213"><span class='Ref_To_Local'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>         <a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a> <span class='Operator'>&& 
</span>         <a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>         <a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that do not select from a single table or view are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2214"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN949"><span class='Ref_to_Member'>tablesample</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views containing TABLESAMPLE are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the view has at least one updatable column. This is required 
     * for INSERT/UPDATE but not for DELETE. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>check_cols</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2312"></a>        <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span><a name="LN2313"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN2313"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2312"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2211"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2318"></a>            <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2312"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2165"><span class='Ref_to_Func'>view_col_is_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2213"><span class='Ref_To_Local'>rtr</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2318"><span class='Ref_To_Local'>tle</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN2313"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN2313"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"Views that have no updatable columns are not automatically updatable."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if check_cols &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* the view is updatable */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end view_query_is_auto_updatable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * view_cols_are_auto_updatable - test whether all of the required columns of 
 * an auto-updatable view are actually updatable. Returns NULL (if all the 
 * required columns can be updated) or a message string giving the reason that 
 * they cannot be. 
 * 
 * This should be used for INSERT/UPDATE to ensure that we don't attempt to 
 * assign to any non-updatable columns. 
 * 
 * Additionally it may be used to retrieve the set of updatable columns in the 
 * view, or if one or more of the required columns is not updatable, the name 
 * of the first offending non-updatable column. 
 * 
 * The caller must have already verified that this is an auto-updatable view 
 * using view_query_is_auto_updatable. 
 * 
 * Note that the checks performed here are only based on the view definition. 
 * We do not check whether the referenced columns of the base relation are 
 * updatable. 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN2356"></a><span class='Declare_Function'>view_cols_are_auto_updatable</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>viewquery</span><span class='Delimiter'>, 
</span><a name="LN2357"></a>                             <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>required_cols</span><span class='Delimiter'>, 
</span><a name="LN2358"></a>                             <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>updatable_cols</span><span class='Delimiter'>, 
</span><a name="LN2359"></a>                             <span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>non_updatable_col</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2361"></a>    <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span><span class='Delimiter'>; 
</span><a name="LN2362"></a>    <a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>col</span><span class='Delimiter'>; 
</span><a name="LN2363"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The caller should have verified that this view is auto-updatable and so 
     * there should be a single base relation. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2356"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2361"><span class='Ref_To_Local'>rtr</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2356"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the optional return values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2358"><span class='Ref_to_Parameter'>updatable_cols</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2358"><span class='Ref_to_Parameter'>updatable_cols</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2359"><span class='Ref_to_Parameter'>non_updatable_col</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2359"><span class='Ref_to_Parameter'>non_updatable_col</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Test each view column for updatability */ 
</span>    <a href="rewriteHandler.c.html#LN2362"><span class='Ref_To_Local'>col</span></a> <span class='Operator'>= -</span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2363"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2356"><span class='Ref_to_Parameter'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2382"></a>        <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2363"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2383"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>col_update_detail</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN2362"><span class='Ref_To_Local'>col</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN2383"><span class='Ref_To_Local'>col_update_detail</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2165"><span class='Ref_to_Func'>view_col_is_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2361"><span class='Ref_To_Local'>rtr</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2382"><span class='Ref_To_Local'>tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2383"><span class='Ref_To_Local'>col_update_detail</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* The column is updatable */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2358"><span class='Ref_to_Parameter'>updatable_cols</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2358"><span class='Ref_to_Parameter'>updatable_cols</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2358"><span class='Ref_to_Parameter'>updatable_cols</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2362"><span class='Ref_To_Local'>col</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/bitmapset.h.html#LN75"><span class='Ref_to_Proto'>bms_is_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2362"><span class='Ref_To_Local'>col</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2357"><span class='Ref_to_Parameter'>required_cols</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* The required column is not updatable */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2359"><span class='Ref_to_Parameter'>non_updatable_col</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="rewriteHandler.c.html#LN2359"><span class='Ref_to_Parameter'>non_updatable_col</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2382"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1368"><span class='Ref_to_Member'>resname</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2383"><span class='Ref_To_Local'>col_update_detail</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* all the required view columns are updatable */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end view_cols_are_auto_updatable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * relation_is_updatable - determine which update events the specified 
 * relation supports. 
 * 
 * Note that views may contain a mix of updatable and non-updatable columns. 
 * For a view to support INSERT/UPDATE it must have at least one updatable 
 * column, but there is no such restriction for DELETE. If include_cols is 
 * non-NULL, then only the specified columns are considered when testing for 
 * updatability. 
 * 
 * This is used for the information_schema views, which have separate concepts 
 * of "updatable" and "trigger updatable".  A relation is "updatable" if it 
 * can be updated without the need for triggers (either because it has a 
 * suitable RULE, or because it is simple enough to be automatically updated). 
 * A relation is "trigger updatable" if it has a suitable INSTEAD OF trigger. 
 * The SQL standard regards this as not necessarily updatable, presumably 
 * because there is no way of knowing what the trigger will actually do. 
 * The information_schema views therefore call this function with 
 * include_triggers = false.  However, other callers might only care whether 
 * data-modifying SQL will work, so they can pass include_triggers = true 
 * to have trigger updatability included in the result. 
 * 
 * The return value is a bitmask of rule event numbers indicating which of 
 * the INSERT, UPDATE and DELETE operations are supported.  (We do it this way 
 * so that we can test for UPDATE plus DELETE support in a single call.) 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2434"></a><span class='Declare_Function'>relation_is_updatable</span><span class='Parentheses'>(</span><a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>reloid</span><span class='Delimiter'>, 
</span><a name="LN2435"></a>                      <span class='Keyword'>bool </span><span class='Declare_Parameter'>include_triggers</span><span class='Delimiter'>, 
</span><a name="LN2436"></a>                      <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>include_cols</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2438"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>events</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2439"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rel</span><span class='Delimiter'>; 
</span><a name="LN2440"></a>    <a href="../../include/rewrite/prs2lock.h.html#LN39"><span class='Ref_to_Struct'>RuleLock</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>rulelocks</span><span class='Delimiter'>; 
</span> 
<a name="LN2442"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALL_EVENTS</span> <span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>))</span> 
 
    <a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN85"><span class='Ref_to_Proto'>try_relation_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2434"><span class='Ref_to_Parameter'>reloid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the relation doesn't exist, return zero rather than throwing an 
     * error.  This is helpful since scanning an information_schema view under 
     * MVCC rules can result in referencing rels that have actually been 
     * deleted already. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the relation is a table, it is always updatable */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>|| 
</span>        <a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2442"><span class='Ref_to_Const'>ALL_EVENTS</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Look for unconditional DO INSTEAD rules, and note supported events */ 
</span>    <a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2467"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN41"><span class='Ref_to_Member'>numLocks</span></a><span class='Delimiter'>; </span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN30"><span class='Ref_to_Member'>isInstead</span></a> <span class='Operator'>&& 
</span>                <a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN27"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="rewriteHandler.c.html#LN2440"><span class='Ref_To_Local'>rulelocks</span></a><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN42"><span class='Ref_to_Member'>rules</span></a><span class='Delimiter'>[</span><a href="rewriteHandler.c.html#LN2467"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../include/rewrite/prs2lock.h.html#LN26"><span class='Ref_to_Member'>event</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="rewriteHandler.c.html#LN2442"><span class='Ref_to_Const'>ALL_EVENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If we have rules for all events, we're done */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN2442"><span class='Ref_to_Const'>ALL_EVENTS</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rulelocks!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Similarly look for INSTEAD OF triggers, if they are to be included */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2435"><span class='Ref_to_Parameter'>include_triggers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2489"></a>        <a href="../../include/utils/reltrigger.h.html#LN45"><span class='Ref_to_Struct'>TriggerDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigDesc</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN119"><span class='Ref_to_Member'>trigdesc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2489"><span class='Ref_To_Local'>trigDesc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2489"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN56"><span class='Ref_to_Member'>trig_insert_instead_row</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2489"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN61"><span class='Ref_to_Member'>trig_update_instead_row</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2489"><span class='Ref_To_Local'>trigDesc</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/reltrigger.h.html#LN66"><span class='Ref_to_Member'>trig_delete_instead_row</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we have triggers for all events, we're done */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN2442"><span class='Ref_to_Const'>ALL_EVENTS</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if include_triggers &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If this is a foreign table, check which update events it supports */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN166"><span class='Ref_to_Const'>RELKIND_FOREIGN_TABLE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2512"></a>        <a href="../../include/foreign/fdwapi.h.html#LN168"><span class='Ref_to_Struct'>FdwRoutine</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fdwroutine</span> <span class='Operator'>= </span><a href="../../include/foreign/fdwapi.h.html#LN236"><span class='Ref_to_Proto'>GetFdwRoutineForRelation</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2512"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN200"><span class='Ref_to_Member'>IsForeignRelUpdatable</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><a href="rewriteHandler.c.html#LN2512"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN200"><span class='Ref_to_Member'>IsForeignRelUpdatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Assume presence of executor functions is sufficient */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2512"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN196"><span class='Ref_to_Member'>ExecForeignInsert</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2512"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN197"><span class='Ref_to_Member'>ExecForeignUpdate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2512"><span class='Ref_To_Local'>fdwroutine</span></a><span class='Operator'>-&GT;</span><a href="../../include/foreign/fdwapi.h.html#LN198"><span class='Ref_to_Member'>ExecForeignDelete</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rel-&GT;rd_rel-&GT;relkind=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Check if this is an automatically updatable view */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2534"></a>        <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>viewquery</span> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteHandler.h.html#LN25"><span class='Ref_to_Proto'>get_view_query</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteHandler.h.html#LN26"><span class='Ref_to_Proto'>view_query_is_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2534"><span class='Ref_To_Local'>viewquery</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2538"></a>            <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>updatable_cols</span><span class='Delimiter'>; 
</span><a name="LN2539"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>auto_events</span><span class='Delimiter'>; 
</span><a name="LN2540"></a>            <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span><span class='Delimiter'>; 
</span><a name="LN2541"></a>            <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>base_rte</span><span class='Delimiter'>; 
</span><a name="LN2542"></a>            <a href="../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>baseoid</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Determine which of the view's columns are updatable. If there 
             * are none within the set of columns we are looking at, then the 
             * view doesn't support INSERT/UPDATE, but it may still support 
             * DELETE. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN2355"><span class='Ref_to_Func'>view_cols_are_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2534"><span class='Ref_To_Local'>viewquery</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN2538"><span class='Ref_To_Local'>updatable_cols</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2436"><span class='Ref_to_Parameter'>include_cols</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2538"><span class='Ref_To_Local'>updatable_cols</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN92"><span class='Ref_to_Proto'>bms_int_members</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2538"><span class='Ref_To_Local'>updatable_cols</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2436"><span class='Ref_to_Parameter'>include_cols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/bitmapset.h.html#LN85"><span class='Ref_to_Proto'>bms_is_empty</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2538"><span class='Ref_To_Local'>updatable_cols</span></a><span class='Parentheses'>))</span> 
                <a href="rewriteHandler.c.html#LN2539"><span class='Ref_To_Local'>auto_events</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* May support DELETE */ 
</span>            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN2539"><span class='Ref_To_Local'>auto_events</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2442"><span class='Ref_to_Const'>ALL_EVENTS</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* May support all events */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The base relation must also support these update commands. 
             * Tables are always updatable, but for any other kind of base 
             * relation we must do a recursive check limited to the columns 
             * referenced by the locally updatable columns in this view. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN2540"><span class='Ref_To_Local'>rtr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2534"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN2541"><span class='Ref_To_Local'>base_rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2540"><span class='Ref_To_Local'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2534"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2541"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2541"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN159"><span class='Ref_to_Const'>RELKIND_RELATION</span></a> <span class='Operator'>&& 
</span>                <a href="rewriteHandler.c.html#LN2541"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>!= </span><a href="../../include/catalog/pg_class.h.html#LN167"><span class='Ref_to_Const'>RELKIND_PARTITIONED_TABLE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN2542"><span class='Ref_To_Local'>baseoid</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2541"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN2436"><span class='Ref_to_Parameter'>include_cols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN84"><span class='Ref_to_Proto'>adjust_view_column_set</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2538"><span class='Ref_To_Local'>updatable_cols</span></a><span class='Delimiter'>, 
</span>                                                      <a href="rewriteHandler.c.html#LN2534"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN2539"><span class='Ref_To_Local'>auto_events</span></a> <span class='Operator'>&= </span><a href="../../include/rewrite/rewriteHandler.h.html#LN28"><span class='Ref_to_Proto'>relation_is_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2542"><span class='Ref_To_Local'>baseoid</span></a><span class='Delimiter'>, 
</span>                                                     <a href="rewriteHandler.c.html#LN2435"><span class='Ref_to_Parameter'>include_triggers</span></a><span class='Delimiter'>, 
</span>                                                     <a href="rewriteHandler.c.html#LN2436"><span class='Ref_to_Parameter'>include_cols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a> <span class='Operator'>|= </span><a href="rewriteHandler.c.html#LN2539"><span class='Ref_To_Local'>auto_events</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if view_query_is_auto_up... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rel-&GT;rd_rel-&GT;relkind=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If we reach here, the relation may support some update commands */ 
</span>    <a href="../../include/access/heapam.h.html#LN89"><span class='Ref_to_Proto'>relation_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2439"><span class='Ref_To_Local'>rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2438"><span class='Ref_To_Local'>events</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end relation_is_updatable &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * adjust_view_column_set - map a set of column numbers according to targetlist 
 * 
 * This is used with simply-updatable views to map column-permissions sets for 
 * the view columns onto the matching columns in the underlying base relation. 
 * The targetlist is expected to be a list of plain Vars of the underlying 
 * relation (as per the checks above in view_query_is_auto_updatable). 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>* 
</span><a name="LN2600"></a><span class='Declare_Function'>adjust_view_column_set</span><span class='Parentheses'>(</span><a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cols</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>targetlist</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2602"></a>    <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2603"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>col</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2603"><span class='Ref_To_Local'>col</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="rewriteHandler.c.html#LN2603"><span class='Ref_To_Local'>col</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN98"><span class='Ref_to_Proto'>bms_next_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2600"><span class='Ref_to_Parameter'>cols</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2603"><span class='Ref_To_Local'>col</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* bit numbers are offset by FirstLowInvalidHeapAttributeNumber */ 
</span><a name="LN2609"></a>        <a href="../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a>  <span class='Declare_Local'>attno</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2603"><span class='Ref_To_Local'>col</span></a> <span class='Operator'>+ </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2609"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>== </span><a href="../../include/access/attnum.h.html#LN22"><span class='Ref_to_Const'>InvalidAttrNumber</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There's a whole-row reference to the view.  For permissions 
             * purposes, treat it as a reference to each column available from 
             * the view.  (We should *not* convert this to a whole-row 
             * reference to the base relation, since the view may not touch 
             * all columns of the base relation.) 
             */ 
</span><a name="LN2620"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2620"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2600"><span class='Ref_to_Parameter'>targetlist</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2624"></a>                <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2620"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2625"></a>                <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>var</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2624"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN2625"><span class='Ref_To_Local'>var</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN575"><span class='Ref_to_Macro'>castNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2624"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN2602"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2602"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, 
</span>                         <a href="rewriteHandler.c.html#LN2625"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a> <span class='Operator'>- </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if attno==InvalidAttrNum... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Views do not have system columns, so we do not expect to see 
             * any other system attnos here.  If we do find one, the error 
             * case will apply. 
             */ 
</span><a name="LN2641"></a>            <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN69"><span class='Ref_to_Proto'>get_tle_by_resno</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2600"><span class='Ref_to_Parameter'>targetlist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2609"><span class='Ref_To_Local'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2641"><span class='Ref_To_Local'>tle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN2641"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a> <span class='Operator'>&& </span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2641"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN2645"></a>                <a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>var</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2641"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN2602"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2602"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, 
</span>                         <a href="rewriteHandler.c.html#LN2645"><span class='Ref_To_Local'>var</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN167"><span class='Ref_to_Member'>varattno</span></a> <span class='Operator'>- </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"attribute number %d not found in view targetlist"</span><span class='Delimiter'>, 
</span>                     <a href="rewriteHandler.c.html#LN2609"><span class='Ref_To_Local'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (col=bms_next_member(... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2602"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end adjust_view_column_set &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * rewriteTargetView - 
 *    Attempt to rewrite a query where the target relation is a view, so that 
 *    the view's base relation becomes the target relation. 
 * 
 * Note that the base relation here may itself be a view, which may or may not 
 * have INSTEAD OF triggers or rules to handle the update.  That is handled by 
 * the recursion in RewriteQuery. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN2670"></a><span class='Declare_Function'>rewriteTargetView</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>view</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2672"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>viewquery</span><span class='Delimiter'>; 
</span><a name="LN2673"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>auto_update_detail</span><span class='Delimiter'>; 
</span><a name="LN2674"></a>    <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span><span class='Delimiter'>; 
</span><a name="LN2675"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>base_rt_index</span><span class='Delimiter'>; 
</span><a name="LN2676"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>new_rt_index</span><span class='Delimiter'>; 
</span><a name="LN2677"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>base_rte</span><span class='Delimiter'>; 
</span><a name="LN2678"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>view_rte</span><span class='Delimiter'>; 
</span><a name="LN2679"></a>    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>new_rte</span><span class='Delimiter'>; 
</span><a name="LN2680"></a>    <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>base_rel</span><span class='Delimiter'>; 
</span><a name="LN2681"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>view_targetlist</span><span class='Delimiter'>; 
</span><a name="LN2682"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the Query from the view's ON SELECT rule.  We're going to munge the 
     * Query to change the view's base relation into the target relation, 
     * along with various other changes along the way, so we need to make a 
     * copy of it (get_view_query() returns a pointer into the relcache, so we 
     * have to treat it as read-only). 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="../../include/rewrite/rewriteHandler.h.html#LN25"><span class='Ref_to_Proto'>get_view_query</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The view must be updatable, else fail */ 
</span>    <a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a> <span class='Operator'>= 
</span>        <a href="../../include/rewrite/rewriteHandler.h.html#LN26"><span class='Ref_to_Proto'>view_query_is_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Delimiter'>, 
</span>                                     <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* messages here should match execMain.c's CheckValidResultRel */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot insert into view \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"To enable inserting into the view, provide an INSTEAD OF INSERT trigger or an unconditional ON INSERT DO INSTEAD rule."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot update view \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"To enable updating the view, provide an INSTEAD OF UPDATE trigger or an unconditional ON UPDATE DO INSTEAD rule."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Operator'>: 
</span>                <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot delete from view \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"To enable deleting from the view, provide an INSTEAD OF DELETE trigger or an unconditional ON DELETE DO INSTEAD rule."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized CmdType: %d"</span><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch parsetree-&GT;commandTyp... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if auto_update_detail &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * For INSERT/UPDATE the modified columns must all be updatable. Note that 
     * we get the modified columns from the query's targetlist, not from the 
     * result RTE's insertedCols and/or updatedCols set, since 
     * rewriteTargetListIU may have added additional targetlist entries for 
     * view defaults, and these must also be updatable. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2743"></a>        <a href="../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>modified_cols</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2744"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>non_updatable_col</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2748"></a>            <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN2748"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2743"><span class='Ref_To_Local'>modified_cols</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2743"><span class='Ref_To_Local'>modified_cols</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteHandler.c.html#LN2748"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a> <span class='Operator'>- </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1494"><span class='Ref_to_Member'>onConflictSet</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2759"></a>                <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN2759"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN2743"><span class='Ref_To_Local'>modified_cols</span></a> <span class='Operator'>= </span><a href="../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2743"><span class='Ref_To_Local'>modified_cols</span></a><span class='Delimiter'>, 
</span>                            <a href="rewriteHandler.c.html#LN2759"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a> <span class='Operator'>- </span><a href="../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2355"><span class='Ref_to_Func'>view_cols_are_auto_updatable</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Delimiter'>, 
</span>                                                          <a href="rewriteHandler.c.html#LN2743"><span class='Ref_To_Local'>modified_cols</span></a><span class='Delimiter'>, 
</span>                                                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                                          <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN2744"><span class='Ref_To_Local'>non_updatable_col</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This is a different error, caused by an attempt to update a 
             * non-updatable column in an otherwise updatable view. 
             */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot insert into column \"%s\" of view \"%s\""</span><span class='Delimiter'>, 
</span>                           <a href="rewriteHandler.c.html#LN2744"><span class='Ref_To_Local'>non_updatable_col</span></a><span class='Delimiter'>, 
</span>                           <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                           <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot update column \"%s\" of view \"%s\""</span><span class='Delimiter'>, 
</span>                                <a href="rewriteHandler.c.html#LN2744"><span class='Ref_To_Local'>non_updatable_col</span></a><span class='Delimiter'>, 
</span>                                <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                           <a href="../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2673"><span class='Ref_To_Local'>auto_update_detail</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized CmdType: %d"</span><span class='Delimiter'>, 
</span>                         <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch parsetree-&GT;commandTyp... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if auto_update_detail &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;commandTyp... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Locate RTE describing the view in the outer query */ 
</span>    <a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we get here, view_query_is_auto_updatable() has verified that the 
     * view contains a single base relation. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2674"><span class='Ref_To_Local'>rtr</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2675"><span class='Ref_To_Local'>base_rt_index</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2674"><span class='Ref_To_Local'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2677"><span class='Ref_To_Local'>base_rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2675"><span class='Ref_To_Local'>base_rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2677"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Up to now, the base relation hasn't been touched at all in our query. 
     * We need to acquire lock on it before we try to do anything with it. 
     * (The subsequent recursive call of RewriteQuery will suppose that we 
     * already have the right lock!)  Since it will become the query target 
     * relation, RowExclusiveLock is always the right thing. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2680"><span class='Ref_To_Local'>base_rel</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2677"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * While we have the relation open, update the RTE's relkind, just in case 
     * it changed since this view was made (cf. AcquireRewriteLocks). 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2677"><span class='Ref_To_Local'>base_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2680"><span class='Ref_To_Local'>base_rel</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span> 
    <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2680"><span class='Ref_To_Local'>base_rel</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the view query contains any sublink subqueries then we need to also 
     * acquire locks on any relations they refer to.  We know that there won't 
     * be any subqueries in the range table or CTEs, so we can skip those, as 
     * in AcquireRewriteLocks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2842"></a>        <a href="rewriteHandler.c.html#LN48"><span class='Ref_to_Struct'>acquireLocksOnSubLinks_context</span></a> <span class='Declare_Local'>context</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN2842"><span class='Ref_To_Local'>context</span></a><span class='Operator'>.</span><a href="rewriteHandler.c.html#LN50"><span class='Ref_to_Member'>for_execute</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="../../include/nodes/nodeFuncs.h.html#LN57"><span class='Ref_to_Proto'>query_tree_walker</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN53"><span class='Ref_to_Proto'>acquireLocksOnSubLinks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN2842"><span class='Ref_To_Local'>context</span></a><span class='Delimiter'>, 
</span>                          <a href="../../include/nodes/nodeFuncs.h.html#LN21"><span class='Ref_to_Const'>QTW_IGNORE_RC_SUBQUERIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a new target RTE describing the base relation, and add it to the 
     * outer query's rangetable.  (What's happening in the next few steps is 
     * very much like what the planner would do to "pull up" the view into the 
     * outer query.  Perhaps someday we should refactor things enough so that 
     * we can share code with the planner.) 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2677"><span class='Ref_To_Local'>base_rte</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * INSERTs never inherit.  For UPDATE/DELETE, we use the view query's 
     * inheritance flag for the base relation. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>        <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1025"><span class='Ref_to_Member'>inh</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adjust the view's targetlist Vars to reference the new target RTE, ie 
     * make their varnos be new_rt_index instead of base_rt_index.  There can 
     * be no Vars for other rels in the tlist, so this is sufficient to pull 
     * up the tlist expressions for use in the outer query.  The tlist will 
     * provide the replacement expressions used by ReplaceVarsFromTargetList 
     * below. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a><span class='Delimiter'>, 
</span>                   <a href="rewriteHandler.c.html#LN2675"><span class='Ref_To_Local'>base_rt_index</span></a><span class='Delimiter'>, 
</span>                   <a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Delimiter'>, 
</span>                   <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mark the new target RTE for the permissions checks that we want to 
     * enforce against the view owner, as distinct from the query caller.  At 
     * the relation level, require the same INSERT/UPDATE/DELETE permissions 
     * that the query caller needs against the view.  We drop the ACL_SELECT 
     * bit that is presumably in new_rte-&GT;requiredPerms initially. 
     * 
     * Note: the original view RTE remains in the query's rangetable list. 
     * Although it will be unused in the query plan, we need it there so that 
     * the executor still performs appropriate permissions checks for the 
     * query caller's use of the view. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1028"><span class='Ref_to_Member'>checkAsUser</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relowner<span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now for the per-column permissions bits. 
     * 
     * Initially, new_rte contains selectedCols permission check bits for all 
     * base-rel columns referenced by the view, but since the view is a SELECT 
     * query its insertedCols/updatedCols is empty.  We set insertedCols and 
     * updatedCols to include all the columns the outer query is trying to 
     * modify, adjusting the column numbers as needed.  But we leave 
     * selectedCols as-is, so the view owner must have read permission for all 
     * columns used in the view definition, even if some of them are not read 
     * by the outer query.  We could try to limit selectedCols to only columns 
     * used in the transformed query, but that does not correspond to what 
     * happens in ordinary SELECT usage of a view: all referenced columns must 
     * have read permission, even if optimization finds that some of them can 
     * be discarded during query transformation.  The flattening we're doing 
     * here is an optional optimization, too.  (If you are unpersuaded and 
     * want to change this, note that applying adjust_view_column_set to 
     * view_rte-&GT;selectedCols is clearly *not* the right answer, since that 
     * neglects base-rel columns used in the view's WHERE quals.) 
     * 
     * This step needs the modified view targetlist, so we have to do things 
     * in this order. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/bitmapset.h.html#LN85"><span class='Ref_to_Proto'>bms_is_empty</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>           <a href="../../include/nodes/bitmapset.h.html#LN85"><span class='Ref_to_Proto'>bms_is_empty</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN84"><span class='Ref_to_Proto'>adjust_view_column_set</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1030"><span class='Ref_to_Member'>insertedCols</span></a><span class='Delimiter'>, 
</span>                                                   <a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN84"><span class='Ref_to_Proto'>adjust_view_column_set</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1031"><span class='Ref_to_Member'>updatedCols</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Move any security barrier quals from the view RTE onto the new target 
     * RTE.  Any such quals should now apply to the new target RTE and will 
     * not reference the original view RTE in the rewritten query. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For UPDATE/DELETE, rewriteTargetListUD will have added a wholerow junk 
     * TLE for the view to the end of the targetlist, which we no longer need. 
     * Remove it to avoid unnecessary work when we process the targetlist. 
     * Note that when we recurse through rewriteQuery a new junk TLE will be 
     * added to allow the executor to find the proper row in the new target 
     * relation.  (So, if we failed to do this, we might have multiple junk 
     * TLEs with the same name, which would be disastrous.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2948"></a>        <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN130"><span class='Ref_to_Macro'>llast</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2948"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2948"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>               <span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2948"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>varno <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>&& 
</span>               <span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2948"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>varattno <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN234"><span class='Ref_to_Proto'>list_delete_ptr</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2948"><span class='Ref_To_Local'>tle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now update all Vars in the outer query that reference the view to 
     * reference the appropriate column of the base relation instead. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../include/rewrite/rewriteManip.h.html#LN76"><span class='Ref_to_Proto'>ReplaceVarsFromTargetList</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, 
</span>                                  <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <a href="rewriteHandler.c.html#LN2678"><span class='Ref_To_Local'>view_rte</span></a><span class='Delimiter'>, 
</span>                                  <a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../include/rewrite/rewriteManip.h.html#LN35"><span class='Ref_to_EnumConst'>REPLACEVARS_REPORT_ERROR</span></a><span class='Delimiter'>, 
</span>                                  <span class='Number'>0</span><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update all other RTI references in the query that point to the view 
     * (for example, parsetree-&GT;resultRelation itself) to point to the new 
     * base relation instead.  Vars will not be affected since none of them 
     * reference parsetree-&GT;resultRelation any longer. 
     */ 
</span>    <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>((</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, 
</span>                   <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                   <a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Delimiter'>, 
</span>                   <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For INSERT/UPDATE we must also update resnos in the targetlist to refer 
     * to columns of the base relation, since those indicate the target 
     * columns to be affected. 
     * 
     * Note that this destroys the resno ordering of the targetlist, but that 
     * will be fixed when we recurse through rewriteQuery, which will invoke 
     * rewriteTargetListIU again on the updated targetlist. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2996"></a>            <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2682"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2997"></a>            <a href="../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>view_tle</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2996"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN2997"><span class='Ref_To_Local'>view_tle</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN69"><span class='Ref_to_Proto'>get_tle_by_resno</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2681"><span class='Ref_To_Local'>view_targetlist</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2996"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2997"><span class='Ref_To_Local'>view_tle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& !</span><a href="rewriteHandler.c.html#LN2997"><span class='Ref_To_Local'>view_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1373"><span class='Ref_to_Member'>resjunk</span></a> <span class='Operator'>&& </span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2997"><span class='Ref_To_Local'>view_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a><span class='Parentheses'>))</span> 
                <a href="rewriteHandler.c.html#LN2996"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/nodes/primnodes.h.html#LN162"><span class='Ref_to_Struct'>Var</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2997"><span class='Ref_To_Local'>view_tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>varattno<span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"attribute number %d not found in view targetlist"</span><span class='Delimiter'>, 
</span>                     <a href="rewriteHandler.c.html#LN2996"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For UPDATE/DELETE, pull up any WHERE quals from the view.  We know that 
     * any Vars in the quals must reference the one base relation, so we need 
     * only adjust their varnos to reference the new target (just the same as 
     * we did with the view targetlist). 
     * 
     * If it's a security-barrier view, its WHERE quals must be applied before 
     * quals from the outer query, so we attach them to the RTE as security 
     * barrier quals rather than adding them to the main WHERE clause. 
     * 
     * For INSERT, the view's quals can be ignored in the main query. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a> <span class='Operator'>&& 
</span>        <a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3026"></a>        <a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>viewqual</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Even though we copied viewquery already at the top of this 
         * function, we must duplicate the viewqual again here, because we may 
         * need to use the quals again below for a WithCheckOption clause. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2675"><span class='Ref_To_Local'>base_rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN347"><span class='Ref_to_Macro'>RelationIsSecurityView</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The view's quals go in front of existing barrier quals: those 
             * would have come from an outer level of security-barrier view, 
             * and so must get evaluated later. 
             * 
             * Note: the parsetree has been mutated, so the new_rte pointer is 
             * stale and needs to be re-computed. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2679"><span class='Ref_To_Local'>new_rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1032"><span class='Ref_to_Member'>securityQuals</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Do not set parsetree-&GT;hasRowSecurity, because these aren't RLS 
             * conditions (they aren't affected by enabling/disabling RLS). 
             */ 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Make sure that the query is marked correctly if the added qual 
             * has sublinks. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if RelationIsSecurityVie... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="../../include/rewrite/rewriteManip.h.html#LN54"><span class='Ref_to_Proto'>AddQual</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN3026"><span class='Ref_To_Local'>viewqual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;commandTyp... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * For INSERT/UPDATE, if the view has the WITH CHECK OPTION, or any parent 
     * view specified WITH CASCADED CHECK OPTION, add the quals from the view 
     * to the query's withCheckOptions list. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3073"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_wco</span> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN356"><span class='Ref_to_Macro'>RelationHasCheckOption</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3074"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>cascaded</span> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN377"><span class='Ref_to_Macro'>RelationHasCascadedCheckOption</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the parent view has a cascaded check option, treat this view as 
         * if it also had a cascaded check option. 
         * 
         * New WithCheckOptions are added to the start of the list, so if 
         * there is a cascaded check option, it will be the first item in the 
         * list. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3086"></a>            <a href="../../include/nodes/parsenodes.h.html#LN1093"><span class='Ref_to_Struct'>WithCheckOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent_wco</span> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1093"><span class='Ref_to_Struct'>WithCheckOption</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3086"><span class='Ref_To_Local'>parent_wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1100"><span class='Ref_to_Member'>cascaded</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN3073"><span class='Ref_To_Local'>has_wco</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN3074"><span class='Ref_To_Local'>cascaded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Add the new WithCheckOption to the start of the list, so that 
         * checks on inner views are run before checks on outer views, as 
         * required by the SQL standard. 
         * 
         * If the new check is CASCADED, we need to add it even if this view 
         * has no quals, since there may be quals on child views.  A LOCAL 
         * check can be omitted if this view has no quals. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3073"><span class='Ref_To_Local'>has_wco</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3074"><span class='Ref_To_Local'>cascaded</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN3107"></a>            <a href="../../include/nodes/parsenodes.h.html#LN1093"><span class='Ref_to_Struct'>WithCheckOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>wco</span><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1093"><span class='Ref_to_Struct'>WithCheckOption</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1096"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>= </span><a href="../../include/nodes/parsenodes.h.html#LN1087"><span class='Ref_to_EnumConst'>WCO_VIEW_CHECK</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1097"><span class='Ref_to_Member'>relname</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>view</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1098"><span class='Ref_to_Member'>polname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1099"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1100"><span class='Ref_to_Member'>cascaded</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3074"><span class='Ref_To_Local'>cascaded</span></a><span class='Delimiter'>; 
</span> 
            <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Delimiter'>, 
</span>                                                <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN168"><span class='Ref_to_Member'>withCheckOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1099"><span class='Ref_to_Member'>qual</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN2672"><span class='Ref_To_Local'>viewquery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1470"><span class='Ref_to_Member'>quals</span></a><span class='Delimiter'>; 
</span>                <a href="../../include/rewrite/rewriteManip.h.html#LN42"><span class='Ref_to_Proto'>ChangeVarNodes</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1099"><span class='Ref_to_Member'>qual</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2675"><span class='Ref_To_Local'>base_rt_index</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN2676"><span class='Ref_To_Local'>new_rt_index</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Make sure that the query is marked correctly if the added 
                 * qual has sublinks.  We can skip this check if the query is 
                 * already marked, or if the command is an UPDATE, in which 
                 * case the same qual will have already been added, and this 
                 * check will already have been done. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>&& 
</span>                    <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) 
</span>                    <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a> <span class='Operator'>= </span><a href="../../include/rewrite/rewriteManip.h.html#LN61"><span class='Ref_to_Proto'>checkExprHasSubLink</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3107"><span class='Ref_To_Local'>wco</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1099"><span class='Ref_to_Member'>qual</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if has_wco&&(cascaded||v... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parsetree-&GT;commandTyp... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN2670"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rewriteTargetView &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * RewriteQuery - 
 *    rewrites the query and apply the rules again on the queries rewritten 
 * 
 * rewrite_events is a list of open query-rewrite actions, so we can detect 
 * infinite recursion. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN3150"></a><span class='Declare_Function'>RewriteQuery</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rewrite_events</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3152"></a>    <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a>     <span class='Declare_Local'>event</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Delimiter'>; 
</span><a name="LN3153"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>instead</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3154"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>returning</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3155"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>updatableview</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN3156"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>qual_product</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN3157"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>rewritten</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN3158"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, recursively process any insert/update/delete statements in WITH 
     * clauses.  (We have to do this first because the WITH clauses may get 
     * copied into rule actions below.) 
     */ 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3158"><span class='Ref_To_Local'>lc1</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3167"></a>        <a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3158"><span class='Ref_To_Local'>lc1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3168"></a>        <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>ctequery</span> <span class='Operator'>= </span><a href="../../include/nodes/nodes.h.html#LN575"><span class='Ref_to_Macro'>castNode</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3167"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3169"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newstuff</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3168"><span class='Ref_To_Local'>ctequery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3169"><span class='Ref_To_Local'>newstuff</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3149"><span class='Ref_to_Func'>RewriteQuery</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3168"><span class='Ref_To_Local'>ctequery</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Currently we can only handle unconditional, single-statement DO 
         * INSTEAD rules correctly; we have to get exactly one Query out of 
         * the rewrite operation to stuff back into the CTE node. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3169"><span class='Ref_To_Local'>newstuff</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Push the single Query back into the CTE node */ 
</span>            <a href="rewriteHandler.c.html#LN3168"><span class='Ref_To_Local'>ctequery</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3169"><span class='Ref_To_Local'>newstuff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* WITH queries should never be canSetTag */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3168"><span class='Ref_To_Local'>ctequery</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3167"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN3168"><span class='Ref_To_Local'>ctequery</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3169"><span class='Ref_To_Local'>newstuff</span></a> <span class='Operator'>== </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"DO INSTEAD NOTHING rules are not supported for data-modifying statements in WITH"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN3197"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* examine queries to determine which error message to issue */ 
</span>            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3197"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3169"><span class='Ref_To_Local'>newstuff</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3202"></a>                <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>q</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3197"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3202"><span class='Ref_To_Local'>q</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN42"><span class='Ref_to_EnumConst'>QSRC_QUAL_INSTEAD_RULE</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"conditional DO INSTEAD rules are not supported for data-modifying statements in WITH"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3202"><span class='Ref_To_Local'>q</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN43"><span class='Ref_to_EnumConst'>QSRC_NON_INSTEAD_RULE</span></a><span class='Parentheses'>) 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"DO ALSO rules are not supported for data-modifying statements in WITH"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"multi-statement DO INSTEAD rules are not supported for data-modifying statements in WITH"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the statement is an insert, update, or delete, adjust its targetlist 
     * as needed, and then fire INSERT/UPDATE/DELETE rules on it. 
     * 
     * SELECT rules are handled later when we have all the queries that should 
     * get executed.  Also, utilities aren't rewritten at all (do we still 
     * need that check?) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN650"><span class='Ref_to_EnumConst'>CMD_SELECT</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3230"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>result_relation</span><span class='Delimiter'>; 
</span><a name="LN3231"></a>        <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rt_entry</span><span class='Delimiter'>; 
</span><a name="LN3232"></a>        <a href="../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>rt_entry_relation</span><span class='Delimiter'>; 
</span><a name="LN3233"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>locks</span><span class='Delimiter'>; 
</span><a name="LN3234"></a>        <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>product_queries</span><span class='Delimiter'>; 
</span><a name="LN3235"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>hasUpdate</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3230"><span class='Ref_To_Local'>result_relation</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3230"><span class='Ref_To_Local'>result_relation</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="rewriteHandler.c.html#LN3231"><span class='Ref_To_Local'>rt_entry</span></a> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3230"><span class='Ref_To_Local'>result_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3231"><span class='Ref_To_Local'>rt_entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can use NoLock here since either the parser or 
         * AcquireRewriteLocks should have locked the rel already. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a> <span class='Operator'>= </span><a href="../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3231"><span class='Ref_To_Local'>rt_entry</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Rewrite the targetlist as needed for the command type. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3253"></a>            <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>values_rte</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If it's an INSERT ... VALUES (...), (...), ... there will be a 
             * single RTE for the VALUES targetlists. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN3261"></a>                <a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rtr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN135"><span class='Ref_to_Member'>jointree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1469"><span class='Ref_to_Member'>fromlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3261"><span class='Ref_To_Local'>rtr</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/primnodes.h.html#LN1415"><span class='Ref_to_Struct'>RangeTblRef</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN3265"></a>                    <a href="../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><a href="../../include/parser/parsetree.h.html#LN30"><span class='Ref_to_Macro'>rt_fetch</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3261"><span class='Ref_To_Local'>rtr</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1418"><span class='Ref_to_Member'>rtindex</span></a><span class='Delimiter'>, 
</span>                                                  <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3265"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN927"><span class='Ref_to_EnumConst'>RTE_VALUES</span></a><span class='Parentheses'>) 
</span>                        <a href="rewriteHandler.c.html#LN3253"><span class='Ref_To_Local'>values_rte</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3265"><span class='Ref_To_Local'>rte</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3253"><span class='Ref_To_Local'>values_rte</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3275"></a>                <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>attrnos</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Process the main targetlist ... */ 
</span>                <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN62"><span class='Ref_to_Proto'>rewriteTargetListIU</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                                                      <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Delimiter'>, 
</span>                                                         <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>override</span><span class='Delimiter'>, 
</span>                                                            <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, 
</span>                                                   <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                                            <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN3275"><span class='Ref_To_Local'>attrnos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* ... and the VALUES expression lists */ 
</span>                <a href="rewriteHandler.c.html#LN72"><span class='Ref_to_Proto'>rewriteValuesRTE</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3253"><span class='Ref_To_Local'>values_rte</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3275"><span class='Ref_To_Local'>attrnos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Process just the main targetlist */ 
</span>                <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a> <span class='Operator'>= 
</span>                    <a href="rewriteHandler.c.html#LN62"><span class='Ref_to_Proto'>rewriteTargetListIU</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>override</span><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a> <span class='Operator'>&& 
</span>                <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1485"><span class='Ref_to_Member'>action</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN801"><span class='Ref_to_EnumConst'>ONCONFLICT_UPDATE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1494"><span class='Ref_to_Member'>onConflictSet</span></a> <span class='Operator'>= 
</span>                    <a href="rewriteHandler.c.html#LN62"><span class='Ref_to_Proto'>rewriteTargetListIU</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/primnodes.h.html#LN1494"><span class='Ref_to_Member'>onConflictSet</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>override</span><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, 
</span>                                        <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, 
</span>                                        <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if event==CMD_INSERT &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a> <span class='Operator'>= 
</span>                <a href="rewriteHandler.c.html#LN62"><span class='Ref_to_Proto'>rewriteTargetListIU</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><span class='Keyword'>override</span><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN74"><span class='Ref_to_Proto'>rewriteTargetListUD</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3231"><span class='Ref_To_Local'>rt_entry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="rewriteHandler.c.html#LN74"><span class='Ref_to_Proto'>rewriteTargetListUD</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3231"><span class='Ref_To_Local'>rt_entry</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized commandType: %d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Collect and apply the appropriate rules. 
         */ 
</span>        <a href="rewriteHandler.c.html#LN3233"><span class='Ref_To_Local'>locks</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN79"><span class='Ref_to_Proto'>matchLocks</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN117"><span class='Ref_to_Member'>rd_rules</span></a><span class='Delimiter'>, 
</span>                           <a href="rewriteHandler.c.html#LN3230"><span class='Ref_To_Local'>result_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="rewriteHandler.c.html#LN3235"><span class='Ref_To_Local'>hasUpdate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2006"><span class='Ref_to_Func'>fireRules</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3230"><span class='Ref_To_Local'>result_relation</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>, 
</span>                                    <a href="rewriteHandler.c.html#LN3233"><span class='Ref_To_Local'>locks</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN3153"><span class='Ref_To_Local'>instead</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN3154"><span class='Ref_To_Local'>returning</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If there were no INSTEAD rules, and the target relation is a view 
         * without any INSTEAD OF triggers, see if the view can be 
         * automatically updated.  If so, we perform the necessary query 
         * transformation here and add the resulting query to the 
         * product_queries list, so that it gets recursively rewritten if 
         * necessary. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3153"><span class='Ref_To_Local'>instead</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Operator'>-&GT;</span><a href="../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind <span class='Operator'>== </span><a href="../../include/catalog/pg_class.h.html#LN163"><span class='Ref_to_Const'>RELKIND_VIEW</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="rewriteHandler.c.html#LN83"><span class='Ref_to_Proto'>view_has_instead_trigger</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This throws an error if the view can't be automatically 
             * updated, but that's OK since the query would fail at runtime 
             * anyway. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN2669"><span class='Ref_to_Func'>rewriteTargetView</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * At this point product_queries contains any DO ALSO rule 
             * actions. Add the rewritten query before or after those.  This 
             * must match the handling the original query would have gotten 
             * below, if we allowed it to be included again. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Set the "instead" flag, as if there had been an unqualified 
             * INSTEAD, to prevent the original query from being included a 
             * second time below.  The transformation will have rewritten any 
             * RETURNING list, so we can also set "returning" to forestall 
             * throwing an error below. 
             */ 
</span>            <a href="rewriteHandler.c.html#LN3153"><span class='Ref_To_Local'>instead</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3154"><span class='Ref_To_Local'>returning</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3155"><span class='Ref_To_Local'>updatableview</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !instead&&qual_produc... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If we got any product queries, recursively rewrite them --- but 
         * first check for recursion! 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3389"></a>            <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN3390"></a>            <a href="rewriteHandler.c.html#LN42"><span class='Ref_to_Struct'>rewrite_event</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rev</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3389"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN42"><span class='Ref_to_Struct'>rewrite_event</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3389"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a><span class='Operator'>-&GT;</span><a href="rewriteHandler.c.html#LN44"><span class='Ref_to_Member'>relation</span></a> <span class='Operator'>== </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                    <a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a><span class='Operator'>-&GT;</span><a href="rewriteHandler.c.html#LN45"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span> 
                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"infinite recursion detected in rules for relation \"%s\""</span><span class='Delimiter'>, 
</span>                               <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN42"><span class='Ref_to_Struct'>rewrite_event</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN42"><span class='Ref_to_Struct'>rewrite_event</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a><span class='Operator'>-&GT;</span><a href="rewriteHandler.c.html#LN44"><span class='Ref_to_Member'>relation</span></a> <span class='Operator'>= </span><a href="../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a><span class='Operator'>-&GT;</span><a href="rewriteHandler.c.html#LN45"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3390"><span class='Ref_To_Local'>rev</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3389"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3410"></a>                <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>pt</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3389"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3411"></a>                <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>newstuff</span><span class='Delimiter'>; 
</span> 
                <a href="rewriteHandler.c.html#LN3411"><span class='Ref_To_Local'>newstuff</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3149"><span class='Ref_to_Func'>RewriteQuery</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3410"><span class='Ref_To_Local'>pt</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN219"><span class='Ref_to_Proto'>list_concat</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3411"><span class='Ref_To_Local'>newstuff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>rewrite_events</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if product_queries!=NIL &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If there is an INSTEAD, and the original query has a RETURNING, we 
         * have to have found a RETURNING in the rule(s), else fail. (Because 
         * DefineQueryRewrite only allows RETURNING in unconditional INSTEAD 
         * rules, there's no need to worry whether the substituted RETURNING 
         * will actually be executed --- it must be.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="rewriteHandler.c.html#LN3153"><span class='Ref_To_Local'>instead</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3154"><span class='Ref_To_Local'>returning</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot perform INSERT RETURNING on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You need an unconditional ON INSERT DO INSTEAD rule with a RETURNING clause."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN651"><span class='Ref_to_EnumConst'>CMD_UPDATE</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot perform UPDATE RETURNING on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You need an unconditional ON UPDATE DO INSTEAD rule with a RETURNING clause."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="../../include/nodes/nodes.h.html#LN653"><span class='Ref_to_EnumConst'>CMD_DELETE</span></a><span class='Operator'>: 
</span>                    <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot perform DELETE RETURNING on relation \"%s\""</span><span class='Delimiter'>, 
</span>                                 <a href="../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You need an unconditional ON DELETE DO INSTEAD rule with a RETURNING clause."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized commandType: %d"</span><span class='Delimiter'>, 
</span>                         <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="rewriteHandler.c.html#LN3152"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch event &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (instead||qual_produc... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Updatable views are supported by ON CONFLICT, so don't prevent that 
         * case from proceeding 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN141"><span class='Ref_to_Member'>onConflict</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3234"><span class='Ref_To_Local'>product_queries</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>|| </span><a href="rewriteHandler.c.html#LN3235"><span class='Ref_To_Local'>hasUpdate</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3155"><span class='Ref_To_Local'>updatableview</span></a><span class='Parentheses'>)</span> 
            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"INSERT with ON CONFLICT clause cannot be used with table that has INSERT or UPDATE rules"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3232"><span class='Ref_To_Local'>rt_entry_relation</span></a><span class='Delimiter'>, </span><a href="../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if event!=CMD_SELECT&&ev... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * For INSERTs, the original query is done first; for UPDATE/DELETE, it is 
     * done last.  This is needed because update and delete rule actions might 
     * not do anything if they are invoked after the update or delete is 
     * performed. The command counter increment between the query executions 
     * makes the deleted (and maybe the updated) tuples disappear so the scans 
     * for them in the rule actions cannot find them. 
     * 
     * If we found any unqualified INSTEAD, the original query is not done at 
     * all, in any form.  Otherwise, we add the modified form if qualified 
     * INSTEADs were found, else the unmodified form. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3153"><span class='Ref_To_Local'>instead</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../include/nodes/nodes.h.html#LN652"><span class='Ref_to_EnumConst'>CMD_INSERT</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3156"><span class='Ref_To_Local'>qual_product</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the original query has a CTE list, and we generated more than one 
     * non-utility result query, we have to fail because we'll have copied the 
     * CTE list into each result query.  That would break the expectation of 
     * single evaluation of CTEs.  This could possibly be fixed by 
     * restructuring so that a CTE list can be shared across multiple Query 
     * and PlannableStatement nodes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3150"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3515"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>qcount</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3158"><span class='Ref_To_Local'>lc1</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3519"></a>            <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>q</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3158"><span class='Ref_To_Local'>lc1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3519"><span class='Ref_To_Local'>q</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>                <a href="rewriteHandler.c.html#LN3515"><span class='Ref_To_Local'>qcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3515"><span class='Ref_To_Local'>qcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"WITH cannot be used in a query that is rewritten by rules into multiple queries"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN3157"><span class='Ref_To_Local'>rewritten</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RewriteQuery &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * QueryRewrite - 
 *    Primary entry point to the query rewriter. 
 *    Rewrite one query via query rewrite system, possibly returning 0 
 *    or many queries. 
 * 
 * NOTE: the parsetree must either have come straight from the parser, 
 * or have been scanned by AcquireRewriteLocks to acquire suitable locks. 
 */ 
</span><a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN3544"></a><span class='Declare_Function'>QueryRewrite</span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3546"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>input_query_id</span> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3544"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN113"><span class='Ref_to_Member'>queryId</span></a><span class='Delimiter'>; 
</span><a name="LN3547"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>querylist</span><span class='Delimiter'>; 
</span><a name="LN3548"></a>    <a href="../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>results</span><span class='Delimiter'>; 
</span><a name="LN3549"></a>    <a href="../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span><a name="LN3550"></a>    <a href="../../include/nodes/nodes.h.html#LN647"><span class='Ref_to_Enum'>CmdType</span></a>     <span class='Declare_Local'>origCmdType</span><span class='Delimiter'>; 
</span><a name="LN3551"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>foundOriginalQuery</span><span class='Delimiter'>; 
</span><a name="LN3552"></a>    <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>lastInstead</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This function is only applied to top-level original queries 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3544"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN39"><span class='Ref_to_EnumConst'>QSRC_ORIGINAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3544"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Step 1 
     * 
     * Apply all non-SELECT rules possibly getting 0 or many queries 
     */ 
</span>    <a href="rewriteHandler.c.html#LN3547"><span class='Ref_To_Local'>querylist</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3149"><span class='Ref_to_Func'>RewriteQuery</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3544"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Step 2 
     * 
     * Apply all the RIR rules on each query 
     * 
     * This is also a handy place to mark each query with the original queryId 
     */ 
</span>    <a href="rewriteHandler.c.html#LN3548"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>= </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3549"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3547"><span class='Ref_To_Local'>querylist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3577"></a>        <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3549"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3577"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN81"><span class='Ref_to_Proto'>fireRIRrules</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3577"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><a href="../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3577"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN113"><span class='Ref_to_Member'>queryId</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3546"><span class='Ref_To_Local'>input_query_id</span></a><span class='Delimiter'>; 
</span> 
        <a href="rewriteHandler.c.html#LN3548"><span class='Ref_To_Local'>results</span></a> <span class='Operator'>= </span><a href="../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3548"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3577"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Step 3 
     * 
     * Determine which, if any, of the resulting queries is supposed to set 
     * the command-result tag; and update the canSetTag fields accordingly. 
     * 
     * If the original query is still in the list, it sets the command tag. 
     * Otherwise, the last INSTEAD query of the same kind as the original is 
     * allowed to set the tag.  (Note these rules can leave us with no query 
     * setting the tag.  The tcop code has to cope with this by setting up a 
     * default tag based on the original un-rewritten query.) 
     * 
     * The Asserts verify that at most one query in the result list is marked 
     * canSetTag.  If we aren't checking asserts, we can fall out of the loop 
     * as soon as we find the original query. 
     */ 
</span>    <a href="rewriteHandler.c.html#LN3550"><span class='Ref_To_Local'>origCmdType</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3544"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN3551"><span class='Ref_To_Local'>foundOriginalQuery</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="rewriteHandler.c.html#LN3552"><span class='Ref_To_Local'>lastInstead</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3549"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="rewriteHandler.c.html#LN3548"><span class='Ref_To_Local'>results</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3608"></a>        <a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3549"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN39"><span class='Ref_to_EnumConst'>QSRC_ORIGINAL</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3551"><span class='Ref_To_Local'>foundOriginalQuery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="rewriteHandler.c.html#LN3551"><span class='Ref_To_Local'>foundOriginalQuery</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> USE_ASSERT_CHECKING 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="rewriteHandler.c.html#LN3550"><span class='Ref_To_Local'>origCmdType</span></a> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN41"><span class='Ref_to_EnumConst'>QSRC_INSTEAD_RULE</span></a> <span class='Operator'>|| 
</span>                 <a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN111"><span class='Ref_to_Member'>querySource</span></a> <span class='Operator'>== </span><a href="../../include/nodes/parsenodes.h.html#LN42"><span class='Ref_to_EnumConst'>QSRC_QUAL_INSTEAD_RULE</span></a><span class='Parentheses'>))</span> 
                <a href="rewriteHandler.c.html#LN3552"><span class='Ref_To_Local'>lastInstead</span></a> <span class='Operator'>= </span><a href="rewriteHandler.c.html#LN3608"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="rewriteHandler.c.html#LN3551"><span class='Ref_To_Local'>foundOriginalQuery</span></a> <span class='Operator'>&& </span><a href="rewriteHandler.c.html#LN3552"><span class='Ref_To_Local'>lastInstead</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="rewriteHandler.c.html#LN3552"><span class='Ref_To_Local'>lastInstead</span></a><span class='Operator'>-&GT;</span><a href="../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="rewriteHandler.c.html#LN3548"><span class='Ref_To_Local'>results</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end QueryRewrite &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>