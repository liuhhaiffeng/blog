<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\buffer\localbuf.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\buffer\localbuf.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:48 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * localbuf.c 
 *    local buffer manager. Fast buffer manager for temporary tables, 
 *    which never need to be WAL-logged or checkpointed, etc. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994-5, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/buffer/localbuf.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/parallel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/instrument.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/buf_internals.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner_private.h"</span> 
 
 
<span class='Comment_Multi_Line'>/*#define LBDEBUG*/ 
</span> 
<span class='Comment_Multi_Line'>/* entry for buffer lookup hashtable */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN32"></a>    <a href="../../../include/storage/buf_internals.h.html#LN90"><span class='Ref_to_Typedef'>BufferTag</span></a>   <span class='Declare_Member'>key</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* Tag of a disk page */ 
</span><a name="LN33"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>id</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* Associated local buffer's index */ 
</span><a name="LN34"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>LocalBufferLookupEnt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Note: this macro only works on local buffers, not shared ones! */ 
</span><a name="LN37"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>LocalBufHdrGetBlock</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>bufHdr</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="localbuf.c.html#LN43"><span class='Ref_to_Global_Var'>LocalBufferBlockPointers</span></a><span class='Delimiter'>[</span><span class='Operator'>-</span><span class='Parentheses'>((</span><a href="localbuf.c.html#LN37"><span class='Ref_to_Parameter'>bufHdr</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>buf_id <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>] 
</span> 
<a name="LN40"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>NLocBuffer</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* until buffers are initialized */ 
</span> 
<a name="LN42"></a><a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Var'>LocalBufferDescriptors</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN43"></a><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a>      <span class='Operator'>*</span><span class='Declare_Var'>LocalBufferBlockPointers</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN44"></a><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>      <span class='Operator'>*</span><span class='Declare_Var'>LocalRefCount</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN46"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nextFreeLocalBuf</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN48"></a><span class='Keyword'>static </span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>LocalBufHash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<a name="LN51"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>InitLocalBuffers</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN52"></a><span class='Keyword'>static </span><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a> <span class='Declare_Prototype'>GetLocalBufferStorage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * LocalPrefetchBuffer - 
 *    initiate asynchronous read of a block of a relation 
 * 
 * Do PrefetchBuffer's work for temporary relations. 
 * No-op if prefetching isn't compiled in. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN63"></a><span class='Declare_Function'>LocalPrefetchBuffer</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>smgr</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, 
</span><a name="LN64"></a>                    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blockNum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN145"><span class='Ref_to_Const'>USE_PREFETCH</span></a> 
<a name="LN67"></a>    <a href="../../../include/storage/buf_internals.h.html#LN90"><span class='Ref_to_Typedef'>BufferTag</span></a>   <span class='Declare_Local'>newTag</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* identity of requested block */ 
</span><a name="LN68"></a>    <a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hresult</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/buf_internals.h.html#LN106"><span class='Ref_to_Macro'>INIT_BUFFERTAG</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN67"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN63"><span class='Ref_to_Parameter'>smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN63"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN64"><span class='Ref_to_Parameter'>blockNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize local buffers if first request in this session */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="localbuf.c.html#LN51"><span class='Ref_to_Proto'>InitLocalBuffers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See if the desired buffer already exists */ 
</span>    <a href="localbuf.c.html#LN68"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN67"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN68"><span class='Ref_To_Local'>hresult</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Yes, so nothing to do */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Not in buffers, so initiate prefetch */ 
</span>    <a href="../../../include/storage/smgr.h.html#LN96"><span class='Ref_to_Proto'>smgrprefetch</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN63"><span class='Ref_to_Parameter'>smgr</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN63"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN64"><span class='Ref_to_Parameter'>blockNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_PREFETCH */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LocalPrefetchBuffer &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * LocalBufferAlloc - 
 *    Find or create a local buffer for the given page of the given relation. 
 * 
 * API is similar to bufmgr.c's BufferAlloc, except that we do not need 
 * to do any locking since this is all local.   Also, IO_IN_PROGRESS 
 * does not get set.  Lastly, we support only default access strategy 
 * (hence, usage_count is always advanced). 
 */ 
</span><a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>* 
</span><a name="LN102"></a><span class='Declare_Function'>LocalBufferAlloc</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>smgr</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blockNum</span><span class='Delimiter'>, 
</span><a name="LN103"></a>                 <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>foundPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN105"></a>    <a href="../../../include/storage/buf_internals.h.html#LN90"><span class='Ref_to_Typedef'>BufferTag</span></a>   <span class='Declare_Local'>newTag</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* identity of requested block */ 
</span><a name="LN106"></a>    <a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hresult</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bufHdr</span><span class='Delimiter'>; 
</span><a name="LN108"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>b</span><span class='Delimiter'>; 
</span><a name="LN109"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>trycounter</span><span class='Delimiter'>; 
</span><a name="LN110"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN111"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>buf_state</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/buf_internals.h.html#LN106"><span class='Ref_to_Macro'>INIT_BUFFERTAG</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN105"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>blockNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize local buffers if first request in this session */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="localbuf.c.html#LN51"><span class='Ref_to_Proto'>InitLocalBuffers</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See if the desired buffer already exists */ 
</span>    <a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN105"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a><span class='Operator'>-&GT;</span><a href="localbuf.c.html#LN33"><span class='Ref_to_Member'>id</span></a><span class='Delimiter'>; 
</span>        <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN113"><span class='Ref_to_Macro'>BUFFERTAGS_EQUAL</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN105"><span class='Ref_To_Local'>newTag</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> LBDEBUG 
        <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"LB ALLOC (%u,%d,%d) %d\n"</span><span class='Delimiter'>, 
</span>                <a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>blockNum</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>= </span><a href="../../../include/port/atomics.h.html#LN250"><span class='Ref_to_Func'>pg_atomic_read_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* this part is equivalent to PinBuffer for a shared buffer */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN49"><span class='Ref_to_Macro'>BUF_STATE_GET_USAGECOUNT</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../../include/storage/buf_internals.h.html#LN76"><span class='Ref_to_Const'>BM_MAX_USAGE_COUNT</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>+= </span><a href="../../../include/storage/buf_internals.h.html#LN43"><span class='Ref_to_Const'>BUF_USAGECOUNT_ONE</span></a><span class='Delimiter'>; 
</span>                <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN29"><span class='Ref_to_Proto'>ResourceOwnerRememberBuffer</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/buf_internals.h.html#LN222"><span class='Ref_to_Macro'>BufferDescriptorGetBuffer</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN59"><span class='Ref_to_Const'>BM_VALID</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="localbuf.c.html#LN103"><span class='Ref_to_Parameter'>foundPtr</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Previous read attempt must have failed; try again */ 
</span>            <span class='Operator'>*</span><a href="localbuf.c.html#LN103"><span class='Ref_to_Parameter'>foundPtr</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if hresult &raquo; </span> 
 
<span class='Directive'>#ifdef</span> LBDEBUG 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"LB ALLOC (%u,%d,%d) %d\n"</span><span class='Delimiter'>, 
</span>            <a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>smgr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN102"><span class='Ref_to_Parameter'>blockNum</span></a><span class='Delimiter'>, 
</span>            <span class='Operator'>-</span><a href="localbuf.c.html#LN46"><span class='Ref_to_Global_Var'>nextFreeLocalBuf</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Need to get a new buffer.  We use a clock sweep algorithm (essentially 
     * the same as what freelist.c does now...) 
     */ 
</span>    <a href="localbuf.c.html#LN109"><span class='Ref_To_Local'>trycounter</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN46"><span class='Ref_to_Global_Var'>nextFreeLocalBuf</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="localbuf.c.html#LN46"><span class='Ref_to_Global_Var'>nextFreeLocalBuf</span></a> <span class='Operator'>&GT;= </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Parentheses'>) 
</span>            <a href="localbuf.c.html#LN46"><span class='Ref_to_Global_Var'>nextFreeLocalBuf</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>= </span><a href="../../../include/port/atomics.h.html#LN250"><span class='Ref_to_Func'>pg_atomic_read_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN49"><span class='Ref_to_Macro'>BUF_STATE_GET_USAGECOUNT</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>-= </span><a href="../../../include/storage/buf_internals.h.html#LN43"><span class='Ref_to_Const'>BUF_USAGECOUNT_ONE</span></a><span class='Delimiter'>; 
</span>                <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="localbuf.c.html#LN109"><span class='Ref_To_Local'>trycounter</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Found a usable buffer */ 
</span>                <a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="../../../include/utils/resowner_private.h.html#LN29"><span class='Ref_to_Proto'>ResourceOwnerRememberBuffer</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/storage/buf_internals.h.html#LN222"><span class='Ref_to_Macro'>BufferDescriptorGetBuffer</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="localbuf.c.html#LN109"><span class='Ref_To_Local'>trycounter</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no empty local buffer available"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * this buffer is not referenced but it might still be dirty. if that's 
     * the case, write it out before reusing it! 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN58"><span class='Ref_to_Const'>BM_DIRTY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN207"></a>        <a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Local'>oreln</span><span class='Delimiter'>; 
</span><a name="LN208"></a>        <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>localpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="localbuf.c.html#LN37"><span class='Ref_to_Macro'>LocalBufHdrGetBlock</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find smgr relation for buffer */ 
</span>        <a href="localbuf.c.html#LN207"><span class='Ref_To_Local'>oreln</span></a> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN83"><span class='Ref_to_Proto'>smgropen</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/bufpage.h.html#LN436"><span class='Ref_to_Proto'>PageSetChecksumInplace</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN208"><span class='Ref_To_Local'>localpage</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN94"><span class='Ref_to_Member'>blockNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And write... */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN100"><span class='Ref_to_Proto'>smgrwrite</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN207"><span class='Ref_To_Local'>oreln</span></a><span class='Delimiter'>, 
</span>                  <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN93"><span class='Ref_to_Member'>forkNum</span></a><span class='Delimiter'>, 
</span>                  <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN94"><span class='Ref_to_Member'>blockNum</span></a><span class='Delimiter'>, 
</span>                  <a href="localbuf.c.html#LN208"><span class='Ref_To_Local'>localpage</span></a><span class='Delimiter'>, 
</span>                  <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark not-dirty now in case we error out below */ 
</span>        <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN58"><span class='Ref_to_Const'>BM_DIRTY</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../executor/instrument.c.html#LN19"><span class='Ref_to_Global_Var'>pgBufferUsage</span></a><span class='Operator'>.</span><a href="../../../include/executor/instrument.h.html#LN27"><span class='Ref_to_Member'>local_blks_written</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if buf_state&BM_DIRTY &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * lazy memory allocation: allocate space on first use of a buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN37"><span class='Ref_to_Macro'>LocalBufHdrGetBlock</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Set pointer for use by BufferGetBlock() macro */ 
</span>        <a href="localbuf.c.html#LN37"><span class='Ref_to_Macro'>LocalBufHdrGetBlock</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="localbuf.c.html#LN52"><span class='Ref_to_Proto'>GetLocalBufferStorage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the hash table: remove old entry, if any, and make new one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN60"><span class='Ref_to_Const'>BM_TAG_VALID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a><span class='Parentheses'>)</span>           <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"local buffer hash table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* mark buffer invalid just in case hash insert fails */ 
</span>        <a href="../../../include/storage/buf_internals.h.html#LN97"><span class='Ref_to_Macro'>CLEAR_BUFFERTAG</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN59"><span class='Ref_to_Const'>BM_VALID</span></a> <span class='Operator'>| </span><a href="../../../include/storage/buf_internals.h.html#LN60"><span class='Ref_to_Const'>BM_TAG_VALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN105"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="localbuf.c.html#LN110"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN110"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span>                  <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"local buffer hash table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN106"><span class='Ref_To_Local'>hresult</span></a><span class='Operator'>-&GT;</span><a href="localbuf.c.html#LN33"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN108"><span class='Ref_To_Local'>b</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * it's all ours now. 
     */ 
</span>    <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN105"><span class='Ref_To_Local'>newTag</span></a><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN59"><span class='Ref_to_Const'>BM_VALID</span></a> <span class='Operator'>| </span><a href="../../../include/storage/buf_internals.h.html#LN58"><span class='Ref_to_Const'>BM_DIRTY</span></a> <span class='Operator'>| </span><a href="../../../include/storage/buf_internals.h.html#LN63"><span class='Ref_to_Const'>BM_JUST_DIRTIED</span></a> <span class='Operator'>| </span><a href="../../../include/storage/buf_internals.h.html#LN62"><span class='Ref_to_Const'>BM_IO_ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/buf_internals.h.html#LN60"><span class='Ref_to_Const'>BM_TAG_VALID</span></a><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN42"><span class='Ref_to_Const'>BUF_USAGECOUNT_MASK</span></a><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>+= </span><a href="../../../include/storage/buf_internals.h.html#LN43"><span class='Ref_to_Const'>BUF_USAGECOUNT_ONE</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN111"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="localbuf.c.html#LN103"><span class='Ref_to_Parameter'>foundPtr</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="localbuf.c.html#LN107"><span class='Ref_To_Local'>bufHdr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LocalBufferAlloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MarkLocalBufferDirty - 
 *    mark a local buffer dirty 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN279"></a><span class='Declare_Function'>MarkLocalBufferDirty</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN281"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>bufid</span><span class='Delimiter'>; 
</span><a name="LN282"></a>    <a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bufHdr</span><span class='Delimiter'>; 
</span><a name="LN283"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>buf_state</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN36"><span class='Ref_to_Macro'>BufferIsLocal</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN279"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LBDEBUG 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"LB DIRTY %d\n"</span><span class='Delimiter'>, </span><a href="localbuf.c.html#LN279"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="localbuf.c.html#LN281"><span class='Ref_To_Local'>bufid</span></a> <span class='Operator'>= -</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN279"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN281"><span class='Ref_To_Local'>bufid</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="localbuf.c.html#LN282"><span class='Ref_To_Local'>bufHdr</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN281"><span class='Ref_To_Local'>bufid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="localbuf.c.html#LN283"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>= </span><a href="../../../include/port/atomics.h.html#LN250"><span class='Ref_to_Func'>pg_atomic_read_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN282"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN283"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN58"><span class='Ref_to_Const'>BM_DIRTY</span></a><span class='Parentheses'>))</span> 
        <a href="../../executor/instrument.c.html#LN19"><span class='Ref_to_Global_Var'>pgBufferUsage</span></a><span class='Operator'>.</span><a href="../../../include/executor/instrument.h.html#LN26"><span class='Ref_to_Member'>local_blks_dirtied</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="localbuf.c.html#LN283"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/buf_internals.h.html#LN58"><span class='Ref_to_Const'>BM_DIRTY</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN282"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN283"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MarkLocalBufferDirty &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DropRelFileNodeLocalBuffers 
 *      This function removes from the buffer pool all the pages of the 
 *      specified relation that have block numbers &GT;= firstDelBlock. 
 *      (In particular, with firstDelBlock = 0, all pages are removed.) 
 *      Dirty pages are simply dropped, without bothering to write them 
 *      out first.  Therefore, this is NOT rollback-able, and so should be 
 *      used only with extreme caution! 
 * 
 *      See DropRelFileNodeBuffers in bufmgr.c for more notes. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN319"></a><span class='Declare_Function'>DropRelFileNodeLocalBuffers</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, 
</span><a name="LN320"></a>                            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>firstDelBlock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN322"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Delimiter'>; </span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN326"></a>        <a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bufHdr</span> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN327"></a>        <a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hresult</span><span class='Delimiter'>; 
</span><a name="LN328"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>buf_state</span><span class='Delimiter'>; 
</span> 
        <a href="localbuf.c.html#LN328"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>= </span><a href="../../../include/port/atomics.h.html#LN250"><span class='Ref_to_Func'>pg_atomic_read_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="localbuf.c.html#LN328"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN60"><span class='Ref_to_Const'>BM_TAG_VALID</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/storage/relfilenode.h.html#LN87"><span class='Ref_to_Macro'>RelFileNodeEquals</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN319"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN93"><span class='Ref_to_Member'>forkNum</span></a> <span class='Operator'>== </span><a href="localbuf.c.html#LN319"><span class='Ref_to_Parameter'>forkNum</span></a> <span class='Operator'>&& 
</span>            <a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN94"><span class='Ref_to_Member'>blockNum</span></a> <span class='Operator'>&GT;= </span><a href="localbuf.c.html#LN320"><span class='Ref_to_Parameter'>firstDelBlock</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"block %u of %s is still referenced (local %u)"</span><span class='Delimiter'>, 
</span>                     <a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN94"><span class='Ref_to_Member'>blockNum</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/common/relpath.h.html#LN61"><span class='Ref_to_Macro'>relpathbackend</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>, 
</span>                                    <a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN93"><span class='Ref_to_Member'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN322"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Remove entry from hashtable */ 
</span>            <a href="localbuf.c.html#LN327"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="localbuf.c.html#LN327"><span class='Ref_To_Local'>hresult</span></a><span class='Parentheses'>)</span>       <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"local buffer hash table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Mark buffer invalid */ 
</span>            <a href="../../../include/storage/buf_internals.h.html#LN97"><span class='Ref_to_Macro'>CLEAR_BUFFERTAG</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="localbuf.c.html#LN328"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN45"><span class='Ref_to_Const'>BUF_FLAG_MASK</span></a><span class='Delimiter'>; 
</span>            <a href="localbuf.c.html#LN328"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN42"><span class='Ref_to_Const'>BUF_USAGECOUNT_MASK</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN326"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN328"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (buf_state&BM_TAG_VAL... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;NLocBuffer;i++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DropRelFileNodeLocalBuffers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DropRelFileNodeAllLocalBuffers 
 *      This function removes from the buffer pool all pages of all forks 
 *      of the specified relation. 
 * 
 *      See DropRelFileNodeAllBuffers in bufmgr.c for more notes. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN366"></a><span class='Declare_Function'>DropRelFileNodeAllLocalBuffers</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN368"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Delimiter'>; </span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN372"></a>        <a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bufHdr</span> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN373"></a>        <a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hresult</span><span class='Delimiter'>; 
</span><a name="LN374"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>buf_state</span><span class='Delimiter'>; 
</span> 
        <a href="localbuf.c.html#LN374"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>= </span><a href="../../../include/port/atomics.h.html#LN250"><span class='Ref_to_Func'>pg_atomic_read_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="localbuf.c.html#LN374"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>& </span><a href="../../../include/storage/buf_internals.h.html#LN60"><span class='Ref_to_Const'>BM_TAG_VALID</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="../../../include/storage/relfilenode.h.html#LN87"><span class='Ref_to_Macro'>RelFileNodeEquals</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN366"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"block %u of %s is still referenced (local %u)"</span><span class='Delimiter'>, 
</span>                     <a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN94"><span class='Ref_to_Member'>blockNum</span></a><span class='Delimiter'>, 
</span>                     <a href="../../../include/common/relpath.h.html#LN61"><span class='Ref_to_Macro'>relpathbackend</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>, 
</span>                                    <a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/buf_internals.h.html#LN93"><span class='Ref_to_Member'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN368"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Remove entry from hashtable */ 
</span>            <a href="localbuf.c.html#LN373"><span class='Ref_To_Local'>hresult</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="localbuf.c.html#LN373"><span class='Ref_To_Local'>hresult</span></a><span class='Parentheses'>)</span>       <span class='Comment_Single_Line'>/* shouldn't happen */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"local buffer hash table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Mark buffer invalid */ 
</span>            <a href="../../../include/storage/buf_internals.h.html#LN97"><span class='Ref_to_Macro'>CLEAR_BUFFERTAG</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN179"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="localbuf.c.html#LN374"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN45"><span class='Ref_to_Const'>BUF_FLAG_MASK</span></a><span class='Delimiter'>; 
</span>            <a href="localbuf.c.html#LN374"><span class='Ref_To_Local'>buf_state</span></a> <span class='Operator'>&= ~</span><a href="../../../include/storage/buf_internals.h.html#LN42"><span class='Ref_to_Const'>BUF_USAGECOUNT_MASK</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/port/atomics.h.html#LN286"><span class='Ref_to_Func'>pg_atomic_unlocked_write_u32</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN372"><span class='Ref_To_Local'>bufHdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN183"><span class='Ref_to_Member'>state</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN374"><span class='Ref_To_Local'>buf_state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (buf_state&BM_TAG_VAL... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;NLocBuffer;i++ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DropRelFileNodeAllLocalBuffers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * InitLocalBuffers - 
 *    init the local buffer cache. Since most queries (esp. multi-user ones) 
 *    don't involve local buffers, we delay allocating actual memory for the 
 *    buffers until we need them; just make the buffer headers here. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN409"></a><span class='Declare_Function'>InitLocalBuffers</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN411"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbufs</span> <span class='Operator'>= </span><a href="../../utils/misc/guc.c.html#LN458"><span class='Ref_to_Global_Var'>num_temp_buffers</span></a><span class='Delimiter'>; 
</span><a name="LN412"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span><a name="LN413"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Parallel workers can't access data in temporary tables, because they 
     * have no visibility into the local buffers of their leader.  This is a 
     * convenient, low-cost place to provide a backstop check for that.  Note 
     * that we don't wish to prevent a parallel worker from accessing catalog 
     * metadata about a temp table, so checks at higher levels would be 
     * inappropriate. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/parallel.h.html#LN51"><span class='Ref_to_Macro'>IsParallelWorker</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TRANSACTION_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot access temporary tables during a parallel operation"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate and zero buffer headers and auxiliary arrays */ 
</span>    <a href="localbuf.c.html#LN42"><span class='Ref_to_Global_Var'>LocalBufferDescriptors</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN43"><span class='Ref_to_Global_Var'>LocalBufferBlockPointers</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN54"><span class='Ref_to_Macro'>calloc</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="localbuf.c.html#LN42"><span class='Ref_to_Global_Var'>LocalBufferDescriptors</span></a> <span class='Operator'>|| !</span><a href="localbuf.c.html#LN43"><span class='Ref_to_Global_Var'>LocalBufferBlockPointers</span></a> <span class='Operator'>|| !</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="localbuf.c.html#LN46"><span class='Ref_to_Global_Var'>nextFreeLocalBuf</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize fields that need to start off nonzero */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="localbuf.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>; </span><a href="localbuf.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN442"></a>        <a href="../../../include/storage/buf_internals.h.html#LN177"><span class='Ref_to_Struct'>BufferDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/storage/buf_internals.h.html#LN220"><span class='Ref_to_Macro'>GetLocalBufferDescriptor</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN413"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * negative to indicate local buffer. This is tricky: shared buffers 
         * start with 0. We have to start with -2. (Note that the routine 
         * BufferDescriptorGetBuffer adds 1 to buf_id so our first buffer id 
         * is -1.) 
         */ 
</span>        <a href="localbuf.c.html#LN442"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/buf_internals.h.html#LN180"><span class='Ref_to_Member'>buf_id</span></a> <span class='Operator'>= -</span><a href="localbuf.c.html#LN413"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Intentionally do not initialize the buffer's atomic variable 
         * (besides zeroing the underlying memory above). That way we get 
         * errors on platforms without atomics, if somebody (re-)introduces 
         * atomic operations for local buffers. 
         */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create the lookup hash table */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="localbuf.c.html#LN412"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN412"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN412"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf_internals.h.html#LN90"><span class='Ref_to_Typedef'>BufferTag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN412"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN30"><span class='Ref_to_Typedef'>LocalBufferLookupEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Local Buffer Lookup Table"</span><span class='Delimiter'>, 
</span>                               <a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="localbuf.c.html#LN412"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="localbuf.c.html#LN48"><span class='Ref_to_Global_Var'>LocalBufHash</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not initialize local buffer hash table"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialization done, mark buffers allocated */ 
</span>    <a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN411"><span class='Ref_To_Local'>nbufs</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitLocalBuffers &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetLocalBufferStorage - allocate memory for a local buffer 
 * 
 * The idea of this function is to aggregate our requests for storage 
 * so that the memory manager doesn't see a whole lot of relatively small 
 * requests.  Since we'll never give back a local buffer once it's created 
 * within a particular process, no point in burdening memmgr with separately 
 * managed chunks. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a> 
<a name="LN487"></a><span class='Declare_Function'>GetLocalBufferStorage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN489"></a>    <span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Local'>cur_block</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>next_buf_in_block</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN491"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>num_bufs_in_block</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN492"></a>    <span class='Keyword'>static int</span>  <span class='Declare_Local'>total_bufs_allocated</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN493"></a>    <span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>LocalBufferContext</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN495"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>this_buf</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN492"><span class='Ref_To_Local'>total_bufs_allocated</span></a> <span class='Operator'>&LT; </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN490"><span class='Ref_To_Local'>next_buf_in_block</span></a> <span class='Operator'>&GT;= </span><a href="localbuf.c.html#LN491"><span class='Ref_To_Local'>num_bufs_in_block</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need to make a new request to memmgr */ 
</span><a name="LN502"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>num_bufs</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We allocate local buffers in a context of their own, so that the 
         * space eaten for them is easily recognizable in MemoryContextStats 
         * output.  Create the context on first use. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN493"><span class='Ref_To_Local'>LocalBufferContext</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="localbuf.c.html#LN493"><span class='Ref_To_Local'>LocalBufferContext</span></a> <span class='Operator'>= 
</span>                <a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                      <span class='String'>"LocalBufferContext"</span><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Start with a 16-buffer request; subsequent ones double each time */ 
</span>        <a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN491"><span class='Ref_To_Local'>num_bufs_in_block</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* But not more than what we need for all remaining local bufs */ 
</span>        <a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a><span class='Delimiter'>, </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a> <span class='Operator'>- </span><a href="localbuf.c.html#LN492"><span class='Ref_To_Local'>total_bufs_allocated</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* And don't overflow MaxAllocSize, either */ 
</span>        <a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a><span class='Delimiter'>, </span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a> <span class='Operator'>/ </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="localbuf.c.html#LN489"><span class='Ref_To_Local'>cur_block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN493"><span class='Ref_To_Local'>LocalBufferContext</span></a><span class='Delimiter'>, 
</span>                                                <a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a> <span class='Operator'>* </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="localbuf.c.html#LN490"><span class='Ref_To_Local'>next_buf_in_block</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="localbuf.c.html#LN491"><span class='Ref_To_Local'>num_bufs_in_block</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN502"><span class='Ref_To_Local'>num_bufs</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if next_buf_in_block&GT;=nu... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Allocate next buffer in current memory block */ 
</span>    <a href="localbuf.c.html#LN495"><span class='Ref_To_Local'>this_buf</span></a> <span class='Operator'>= </span><a href="localbuf.c.html#LN489"><span class='Ref_To_Local'>cur_block</span></a> <span class='Operator'>+ </span><a href="localbuf.c.html#LN490"><span class='Ref_To_Local'>next_buf_in_block</span></a> <span class='Operator'>* </span>BLCKSZ<span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN490"><span class='Ref_To_Local'>next_buf_in_block</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="localbuf.c.html#LN492"><span class='Ref_To_Local'>total_bufs_allocated</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufmgr.h.html#LN24"><span class='Ref_to_Typedef'>Block</span></a><span class='Parentheses'>) </span><a href="localbuf.c.html#LN495"><span class='Ref_To_Local'>this_buf</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetLocalBufferStorage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CheckForLocalBufferLeaks - ensure this backend holds no local buffer pins 
 * 
 * This is just like CheckBufferLeaks(), but for local buffers. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN542"></a><span class='Declare_Function'>CheckForLocalBufferLeaks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN547"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>RefCountErrors</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN548"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN548"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="localbuf.c.html#LN548"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="localbuf.c.html#LN40"><span class='Ref_to_Global_Var'>NLocBuffer</span></a><span class='Delimiter'>; </span><a href="localbuf.c.html#LN548"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="localbuf.c.html#LN44"><span class='Ref_to_Global_Var'>LocalRefCount</span></a><span class='Delimiter'>[</span><a href="localbuf.c.html#LN548"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN554"></a>                <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>b</span> <span class='Operator'>= -</span><a href="localbuf.c.html#LN548"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/bufmgr.h.html#LN185"><span class='Ref_to_Proto'>PrintBufferLeakWarning</span></a><span class='Parentheses'>(</span><a href="localbuf.c.html#LN554"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="localbuf.c.html#LN547"><span class='Ref_To_Local'>RefCountErrors</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="localbuf.c.html#LN547"><span class='Ref_To_Local'>RefCountErrors</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end CheckForLocalBufferLeaks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOXact_LocalBuffers - clean up at end of transaction. 
 * 
 * This is just like AtEOXact_Buffers, but for local buffers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN571"></a><span class='Declare_Function'>AtEOXact_LocalBuffers</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="localbuf.c.html#LN541"><span class='Ref_to_Func'>CheckForLocalBufferLeaks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtProcExit_LocalBuffers - ensure we have dropped pins during backend exit. 
 * 
 * This is just like AtProcExit_Buffers, but for local buffers. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN582"></a><span class='Declare_Function'>AtProcExit_LocalBuffers</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We shouldn't be holding any remaining pins; if we are, and assertions 
     * aren't enabled, we'll fail later in DropRelFileNodeBuffers while trying 
     * to drop the temp rels. 
     */ 
</span>    <a href="localbuf.c.html#LN541"><span class='Ref_to_Func'>CheckForLocalBufferLeaks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>