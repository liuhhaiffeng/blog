<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\file\fd.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\file\fd.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:48 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fd.c 
 *    Virtual file descriptor code. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/file/fd.c 
 * 
 * NOTES: 
 * 
 * This code manages a cache of 'virtual' file descriptors (VFDs). 
 * The server opens many file descriptors for a variety of reasons, 
 * including base tables, scratch files (e.g., sort and hash spool 
 * files), and random calls to C library routines like system(3); it 
 * is quite easy to exceed system limits on the number of open files a 
 * single process can have.  (This is around 256 on many modern 
 * operating systems, but can be as low as 32 on others.) 
 * 
 * VFDs are managed as an LRU pool, with actual OS file descriptors 
 * being opened and closed as needed.  Obviously, if a routine is 
 * opened using these interfaces, all subsequent operations must also 
 * be through these interfaces (the File type is not a real file 
 * descriptor). 
 * 
 * For this scheme to work, most (if not all) routines throughout the 
 * server should use these interfaces instead of calling the C library 
 * routines (e.g., open(2) and fopen(3)) themselves.  Otherwise, we 
 * may find ourselves short of real file descriptors anyway. 
 * 
 * INTERFACE ROUTINES 
 * 
 * PathNameOpenFile and OpenTemporaryFile are used to open virtual files. 
 * A File opened with OpenTemporaryFile is automatically deleted when the 
 * File is closed, either explicitly or implicitly at end of transaction or 
 * process exit. PathNameOpenFile is intended for files that are held open 
 * for a long time, like relation files. It is the caller's responsibility 
 * to close them, there is no automatic mechanism in fd.c for that. 
 * 
 * AllocateFile, AllocateDir, OpenPipeStream and OpenTransientFile are 
 * wrappers around fopen(3), opendir(3), popen(3) and open(2), respectively. 
 * They behave like the corresponding native functions, except that the handle 
 * is registered with the current subtransaction, and will be automatically 
 * closed at abort. These are intended mainly for short operations like 
 * reading a configuration file; there is a limit on the number of files that 
 * can be opened using these functions at any one time. 
 * 
 * Finally, BasicOpenFile is just a thin wrapper around open() that can 
 * release file descriptors in use by the virtual file descriptors if 
 * necessary. There is no automatic cleanup of file descriptors returned by 
 * BasicOpenFile, it is solely the caller's responsibility to close the file 
 * descriptor by calling close(2). 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/file.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/mman.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_RESOURCE_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/resource.h&GT;</span>       <span class='Comment_Single_Line'>/* for getrlimit */ 
</span><span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_tablespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"portability/mem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner_private.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Define PG_FLUSH_DATA_WORKS if we have an implementation for pg_flush_data */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_SYNC_FILE_RANGE<span class='Parentheses'>) 
</span><a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_FLUSH_DATA_WORKS</span> <span class='Number'>1</span> 
<span class='Directive'>#elif</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>MS_ASYNC<span class='Parentheses'>) 
</span><a name="LN90"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_FLUSH_DATA_WORKS</span> <span class='Number'>1</span> 
<span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN136"><span class='Ref_to_Const'>USE_POSIX_FADVISE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>POSIX_FADV_DONTNEED<span class='Parentheses'>) 
</span><a name="LN92"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PG_FLUSH_DATA_WORKS</span> <span class='Number'>1</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * We must leave some file descriptors free for system(), the dynamic loader, 
 * and other code that tries to open files without consulting fd.c.  This 
 * is the number left free.  (While we can be pretty sure we won't get 
 * EMFILE, there's never any guarantee that we won't get ENFILE due to 
 * other processes chewing up FDs.  So it's a bad idea to try to open files 
 * without consulting fd.c.  Nonetheless we cannot control all code.) 
 * 
 * Because this is just a fixed setting, we are effectively assuming that 
 * no such code will leave FDs open over the long term; otherwise the slop 
 * is likely to be insufficient.  Note in particular that we expect that 
 * loading a shared library does not result in any permanent increase in 
 * the number of open files.  (This appears to be true on most if not 
 * all platforms as of Feb 2004.) 
 */ 
</span><a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NUM_RESERVED_FDS</span>        <span class='Number'>10</span> 
 
<span class='Comment_Multi_Line'>/* 
 * If we have fewer than this many usable FDs after allowing for the reserved 
 * ones, choke. 
 */ 
</span><a name="LN116"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FD_MINFREE</span>              <span class='Number'>10</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * A number of platforms allow individual processes to open many more files 
 * than they can really support when *many* processes do the same thing. 
 * This GUC parameter lets the DBA limit max_safe_fds to something less than 
 * what the postmaster's initial probe suggests will work. 
 */ 
</span><a name="LN125"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>max_files_per_process</span> <span class='Operator'>= </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Maximum number of file descriptors to open for either VFD entries or 
 * AllocateFile/AllocateDir/OpenTransientFile operations.  This is initialized 
 * to a conservative value, and remains that way indefinitely in bootstrap or 
 * standalone-backend cases.  In normal postmaster operation, the postmaster 
 * calls set_max_safe_fds() late in initialization to update the value, and 
 * that value is then inherited by forked subprocesses. 
 * 
 * Note: the value of max_files_per_process is taken into account while 
 * setting this variable, and so need not be tested separately. 
 */ 
</span><a name="LN138"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>max_safe_fds</span> <span class='Operator'>= </span><span class='Number'>32</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* default if not changed */ 
</span> 
 
<span class='Comment_Multi_Line'>/* Debugging.... */ 
</span> 
<span class='Directive'>#ifdef</span> FDDEBUG 
<a name="LN144"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DO_DB</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>A</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <span class='Keyword'>int</span>         _do_db_save_errno <span class='Operator'>= </span>errno<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <a href="fd.c.html#LN144"><span class='Ref_to_Parameter'>A</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        errno <span class='Operator'>= </span>_do_db_save_errno<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<a name="LN151"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DO_DB</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>A</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
 
<a name="LN155"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>VFD_CLOSED</span> <span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>) 
</span> 
<a name="LN157"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FileIsValid</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>file</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="fd.c.html#LN157"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>&& </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN157"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
 
<a name="LN160"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FileIsNotOpen</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>file</span><span class='Parentheses'>) (</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN160"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Note: a VFD's seekPos is normally always valid, but if for some reason 
 * an lseek() fails, it might become set to FileUnknownPos.  We can struggle 
 * along without knowing the seek position in many cases, but in some places 
 * we have to fail if we don't have it. 
 */ 
</span><a name="LN168"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FileUnknownPos</span> <span class='Parentheses'>((</span>off_t<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<a name="LN169"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FilePosIsUnknown</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>pos</span><span class='Parentheses'>) ((</span><a href="fd.c.html#LN169"><span class='Ref_to_Parameter'>pos</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* these are the assigned bits in fdstate below: */ 
</span><a name="LN172"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FD_TEMPORARY</span>        <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* T = delete when closed */ 
</span><a name="LN173"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FD_XACT_TEMPORARY</span>   <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* T = delete at eoXact */ 
</span> 
<a name="LN175"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>vfd</span> 
<span class='Delimiter'>{ 
</span><a name="LN177"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fd</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* current FD, or VFD_CLOSED if none */ 
</span><a name="LN178"></a>    <span class='Keyword'>unsigned short </span><span class='Declare_Member'>fdstate</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* bitflags for VFD's state */ 
</span><a name="LN179"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Member'>resowner</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* owner, for automatic cleanup */ 
</span><a name="LN180"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Member'>nextFree</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* link to next free VFD, if in freelist */ 
</span><a name="LN181"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Member'>lruMoreRecently</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* doubly linked recency-of-use list */ 
</span><a name="LN182"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Member'>lruLessRecently</span><span class='Delimiter'>; 
</span><a name="LN183"></a>    off_t       <span class='Declare_Member'>seekPos</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* current logical file position, or -1 */ 
</span><a name="LN184"></a>    off_t       <span class='Declare_Member'>fileSize</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* current size of file (0 if not temporary) */ 
</span><a name="LN185"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>fileName</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* name of file, or NULL for unused VFD */ 
</span>    <span class='Comment_Multi_Line'>/* NB: fileName is malloc'd, and must be free'd when closing the VFD */ 
</span><a name="LN187"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fileFlags</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* open(2) flags for (re)opening the file */ 
</span><a name="LN188"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>fileMode</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* mode to pass to open(2) */ 
</span><a name="LN189"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>Vfd</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Virtual File Descriptor array pointer and size.  This grows as 
 * needed.  'File' values are indexes into this array. 
 * Note that VfdCache[0] is not a usable VFD, just a list header. 
 */ 
</span><a name="LN196"></a><span class='Keyword'>static </span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a> <span class='Operator'>*</span><span class='Declare_Var'>VfdCache</span><span class='Delimiter'>; 
</span><a name="LN197"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>SizeVfdCache</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Number of file descriptors known to be in use by VFD entries. 
 */ 
</span><a name="LN202"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nfile</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Flag to tell whether it's worth scanning VfdCache looking for temp files 
 * to close 
 */ 
</span><a name="LN208"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>have_xact_temporary_files</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Tracks the total size of all temporary files.  Note: when temp_file_limit 
 * is being enforced, this cannot overflow since the limit cannot be more 
 * than INT_MAX kilobytes.  When not enforcing, it could theoretically 
 * overflow, but we don't care. 
 */ 
</span><a name="LN216"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Var'>temporary_files_size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of OS handles opened with AllocateFile, AllocateDir and 
 * OpenTransientFile. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN224"></a>    <span class='Declare_Enum_Const'>AllocateDescFile</span><span class='Delimiter'>, 
</span><a name="LN225"></a>    <span class='Declare_Enum_Const'>AllocateDescPipe</span><span class='Delimiter'>, 
</span><a name="LN226"></a>    <span class='Declare_Enum_Const'>AllocateDescDir</span><span class='Delimiter'>, 
</span><a name="LN227"></a>    <span class='Declare_Enum_Const'>AllocateDescRawFD</span> 
<a name="LN228"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>AllocateDescKind</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN232"></a>    <a href="fd.c.html#LN222"><span class='Ref_to_Typedef'>AllocateDescKind</span></a> <span class='Declare_Member'>kind</span><span class='Delimiter'>; 
</span><a name="LN233"></a>    <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Member'>create_subid</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN236"></a>        FILE       <span class='Operator'>*</span><span class='Declare_Member'>file</span><span class='Delimiter'>; 
</span><a name="LN237"></a>        <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>dir</span><span class='Delimiter'>; 
</span><a name="LN238"></a>        <span class='Keyword'>int</span>         <span class='Declare_Member'>fd</span><span class='Delimiter'>; 
</span><a name="LN239"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Member'>desc</span><span class='Delimiter'>; 
</span><a name="LN240"></a>} <span class='Declare_Typedef'>AllocateDesc</span><span class='Delimiter'>; 
</span> 
<a name="LN242"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>numAllocatedDescs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN243"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>maxAllocatedDescs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN244"></a><span class='Keyword'>static </span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Var'>allocatedDescs</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Number of temporary files opened during the current session; 
 * this is used in generation of tempfile names. 
 */ 
</span><a name="LN250"></a><span class='Keyword'>static long </span><span class='Declare_Var'>tempFileCounter</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Array of OIDs of temp tablespaces.  When numTempTableSpaces is -1, 
 * this has not been set in the current transaction. 
 */ 
</span><a name="LN256"></a><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Var'>tempTableSpaces</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN257"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>numTempTableSpaces</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN258"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nextTempTableSpace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/*-------------------- 
 * 
 * Private Routines 
 * 
 * Delete          - delete a file from the Lru ring 
 * LruDelete       - remove a file from the Lru ring and close its FD 
 * Insert          - put a file at the front of the Lru ring 
 * LruInsert       - put a file at the front of the Lru ring and open it 
 * ReleaseLruFile  - Release an fd by closing the last entry in the Lru ring 
 * ReleaseLruFiles - Release fd(s) until we're under the max_safe_fds limit 
 * AllocateVfd     - grab a free (or new) file record (from VfdArray) 
 * FreeVfd         - free a file record 
 * 
 * The Least Recently Used ring is a doubly linked list that begins and 
 * ends on element zero.  Element zero is special -- it doesn't represent 
 * a file and its "fd" field always == VFD_CLOSED.  Element zero is just an 
 * anchor that shows us the beginning/end of the ring. 
 * Only VFD elements that are currently really open (have an FD assigned) are 
 * in the Lru ring.  Elements that are "virtually" open can be recognized 
 * by having a non-null fileName field. 
 * 
 * example: 
 * 
 *     /--less----\                /---------\ 
 *     v           \              v           \ 
 *   #0 --more---&GT; LeastRecentlyUsed --more-\ \ 
 *    ^\                                    | | 
 *     \\less--&GT; MostRecentlyUsedFile   &LT;---/ | 
 *      \more---/                    \--less--/ 
 * 
 *-------------------- 
 */ 
</span><a name="LN293"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>Delete</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN294"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>LruDelete</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN295"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>Insert</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN296"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>LruInsert</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN297"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ReleaseLruFile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN298"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReleaseLruFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN299"></a><span class='Keyword'>static </span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Prototype'>AllocateVfd</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN300"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreeVfd</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN302"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>FileAccess</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN303"></a><span class='Keyword'>static </span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Prototype'>OpenTemporaryFileInTablespace</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tblspcOid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rejectError</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN304"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>reserveAllocatedDesc</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN305"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>FreeDesc</span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN306"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ReadDirExtended</span><span class='Parentheses'>(</span><a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN308"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AtProcExit_Files</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN309"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CleanupTempFiles</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isProcExit</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN310"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemovePgTempFilesInDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tmpdirname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN311"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemovePgTempRelationFiles</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tsdirname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN312"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemovePgTempRelationFilesInDbspace</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbspacedirname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN313"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>looks_like_temp_rel_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN315"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>walkdir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, 
</span><a name="LN316"></a>        <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) (</span><span class='Keyword'>const char </span><span class='Operator'>*</span>fname<span class='Delimiter'>, </span><span class='Keyword'>bool </span>isdir<span class='Delimiter'>, </span><span class='Keyword'>int </span><a href="fd.c.html#LN318"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span><a name="LN317"></a>        <span class='Keyword'>bool </span><span class='Declare_Parameter'>process_symlinks</span><span class='Delimiter'>, 
</span><a name="LN318"></a>        <span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../common/file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
<a name="LN320"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>pre_sync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<a name="LN322"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>datadir_fsync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN324"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>fsync_fname_ext</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>ignore_perm</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN325"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>fsync_parent_path</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_fsync --- do fsync with or without writethrough 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN332"></a><span class='Declare_Function'>pg_fsync</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* #if is to skip the sync_method test if there's no need for it */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../../include/port/darwin.h.html#LN5"><span class='Ref_to_Const'>HAVE_FSYNC_WRITETHROUGH</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN69"><span class='Ref_to_Const'>FSYNC_WRITETHROUGH_IS_FSYNC</span></a><span class='Parentheses'>) 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../access/transam/xlog.c.html#LN102"><span class='Ref_to_Global_Var'>sync_method</span></a> <span class='Operator'>== </span><a href="../../../include/access/xlog.h.html#LN27"><span class='Ref_to_Const'>SYNC_METHOD_FSYNC_WRITETHROUGH</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../bin/pg_test_fsync/pg_test_fsync.c.html#LN90"><span class='Ref_to_Proto'>pg_fsync_writethrough</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN332"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/fd.h.html#LN115"><span class='Ref_to_Proto'>pg_fsync_no_writethrough</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN332"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_fsync_no_writethrough --- same as fsync except does nothing if 
 *  enableFsync is off 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN349"></a><span class='Declare_Function'>pg_fsync_no_writethrough</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN349"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_fsync_writethrough 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN361"></a><span class='Declare_Function'>pg_fsync_writethrough</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>return</span> _commit<span class='Parentheses'>(</span><a href="fd.c.html#LN361"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>F_FULLFSYNC<span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="fd.c.html#LN361"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span>F_FULLFSYNC<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>? -</span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        errno <span class='Operator'>= </span>ENOSYS<span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_fdatasync --- same as fdatasync except does nothing if enableFsync is off 
 * 
 * Not all platforms have fdatasync; treat as fsync if not available. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN384"></a><span class='Declare_Function'>pg_fdatasync</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_FDATASYNC 
        <span class='Control'>return</span> <a href="../../../include/c.h.html#LN1093"><span class='Ref_to_Proto'>fdatasync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN384"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <span class='Control'>return</span> <a href="../../../include/port/win32.h.html#LN61"><span class='Ref_to_Macro'>fsync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN384"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_flush_data --- advise OS that the described dirty data should be flushed 
 * 
 * offset of 0 with nbytes 0 means that the entire file should be flushed; 
 * in this case, this function may have side-effects on the file's 
 * seek position! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN406"></a><span class='Declare_Function'>pg_flush_data</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Right now file flushing is primarily used to avoid making later 
     * fsync()/fdatasync() calls have less impact. Thus don't trigger flushes 
     * if fsyncs are disabled - that's a decision we might want to make 
     * configurable at some point. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We compile all alternatives that are supported on the current platform, 
     * to find portability problems more easily. 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>HAVE_SYNC_FILE_RANGE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN423"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * sync_file_range(SYNC_FILE_RANGE_WRITE), currently linux specific, 
         * tells the OS that writeback for the specified blocks should be 
         * started, but that we don't want to wait for completion.  Note that 
         * this call might block if too much dirty data exists in the range. 
         * This is the preferable method on OSs supporting it, as it works 
         * reliably when available (contrast to msync()) and doesn't flush out 
         * clean data (like FADV_DONTNEED). 
         */ 
</span>        <a href="fd.c.html#LN423"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>sync_file_range<span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>, 
</span>                             SYNC_FILE_RANGE_WRITE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* don't error out, this is just a performance optimization */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN423"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not flush dirty data: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> <span class='Operator'>!</span>defined<span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>MS_ASYNC<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN450"></a>        <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN451"></a>        <span class='Keyword'>static int</span>  <span class='Declare_Local'>pagesize</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * On several OSs msync(MS_ASYNC) on a mmap'ed file triggers 
         * writeback. On linux it only does so if MS_SYNC is specified, but 
         * then it does the writeback synchronously. Luckily all common linux 
         * systems have sync_file_range().  This is preferable over 
         * FADV_DONTNEED because it doesn't flush out clean data. 
         * 
         * We map the file (mmap()), tell the kernel to sync back the contents 
         * (msync()), and then remove the mapping again (munmap()). 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* mmap() needs actual length if we want to map whole file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_END<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine dirty data size: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Some platforms reject partial-page mmap() attempts.  To deal with 
         * that, just truncate the request to a page boundary.  If any extra 
         * bytes don't get flushed, well, it's only a hint anyway. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* fetch pagesize only once */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN451"><span class='Ref_To_Local'>pagesize</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN451"><span class='Ref_To_Local'>pagesize</span></a> <span class='Operator'>= </span>sysconf<span class='Parentheses'>(</span>_SC_PAGESIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* align length to pagesize, dropping any fractional page */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN451"><span class='Ref_To_Local'>pagesize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>/ </span><a href="fd.c.html#LN451"><span class='Ref_To_Local'>pagesize</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="fd.c.html#LN451"><span class='Ref_To_Local'>pagesize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* fractional-page request is a no-op */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * mmap could well fail, particularly on 32-bit platforms where there 
         * may simply not be enough address space.  If so, silently fall 
         * through to the next implementation. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>SSIZE_MAX<span class='Parentheses'>)</span> 
            <a href="fd.c.html#LN450"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span>mmap<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>, </span>PROT_READ<span class='Delimiter'>, </span>MAP_SHARED<span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="fd.c.html#LN450"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/portability/mem.h.html#LN44"><span class='Ref_to_Const'>MAP_FAILED</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN450"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>!= </span><a href="../../../include/portability/mem.h.html#LN44"><span class='Ref_to_Const'>MAP_FAILED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN507"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
            <a href="fd.c.html#LN507"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>msync<span class='Parentheses'>(</span><a href="fd.c.html#LN450"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>) </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>, </span>MS_ASYNC<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN507"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not flush dirty data: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* NB: need to fall through to munmap()! */ 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="fd.c.html#LN507"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>munmap<span class='Parentheses'>(</span><a href="fd.c.html#LN450"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>) </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN507"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* FATAL error because mapping would remain */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                      <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not munmap() while flushing data: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if p!=MAP_FAILED &raquo; </span> 
    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN136"><span class='Ref_to_Const'>USE_POSIX_FADVISE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>POSIX_FADV_DONTNEED<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN533"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Signal the kernel that the passed in range should not be cached 
         * anymore. This has the, desired, side effect of writing out dirty 
         * data, and the, undesired, side effect of likely discarding useful 
         * clean cached blocks.  For the latter reason this is the least 
         * preferable method. 
         */ 
</span> 
        <a href="fd.c.html#LN533"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>posix_fadvise<span class='Parentheses'>(</span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN406"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>, </span>POSIX_FADV_DONTNEED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN533"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* don't error out, this is just a performance optimization */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not flush dirty data: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end pg_flush_data &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * fsync_fname -- fsync a file or directory, handling errors properly 
 * 
 * Try to fsync a file or directory. When doing the latter, ignore errors that 
 * indicate the OS just doesn't allow/require fsyncing directories. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN566"></a><span class='Declare_Function'>fsync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN566"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN566"><span class='Ref_to_Parameter'>isdir</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * durable_rename -- rename(2) wrapper, issuing fsyncs required for durability 
 * 
 * This routine ensures that, after returning, the effect of renaming file 
 * persists in case of a crash. A crash while this routine is running will 
 * leave you with either the pre-existing or the moved file in place of the 
 * new file; no mixed state or truncated files are possible. 
 * 
 * It does so by using fsync on the old filename and the possibly existing 
 * target filename before the rename, and the target file and directory after. 
 * 
 * Note that rename() cannot be used across arbitrary directories, as they 
 * might not be on the same filesystem. Therefore this routine does not 
 * support renaming across directories. 
 * 
 * Log errors with the caller specified severity. 
 * 
 * Returns 0 if the operation succeeded, -1 otherwise. Note that errno is not 
 * valid upon return. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN592"></a><span class='Declare_Function'>durable_rename</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldfile</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newfile</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN594"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First fsync the old and target path (if it exists), to ensure that they 
     * are properly persistent on disk. Syncing the target file is not 
     * strictly necessary, but it makes it easier to reason about crashes; 
     * because it's then guaranteed that either source or target file exists 
     * after a crash. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN594"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a> <span class='Operator'>| </span>O_RDWR<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN594"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN594"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN621"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* close file upon error, might not be in transaction context */ 
</span>            <a href="fd.c.html#LN621"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN594"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="fd.c.html#LN621"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN594"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Time to do the real deal... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To guarantee renaming the file is persistent, fsync the file with its 
     * new name, and its containing directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN592"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end durable_rename &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * durable_unlink -- remove a file in a durable manner 
 * 
 * This routine ensures that, after returning, the effect of removing file 
 * persists in case of a crash. A crash while this routine is running will 
 * leave the system in no mixed state. 
 * 
 * It does so by using fsync on the parent directory of the file after the 
 * actual removal is done. 
 * 
 * Log errors with the severity specified by caller. 
 * 
 * Returns 0 if the operation succeeded, -1 otherwise. Note that errno is not 
 * valid upon return. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN675"></a><span class='Declare_Function'>durable_unlink</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN675"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN675"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN675"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To guarantee that the removal of the file is persistent, fsync its 
     * parent directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN675"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN675"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end durable_unlink &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * durable_link_or_rename -- rename a file in a durable manner. 
 * 
 * Similar to durable_rename(), except that this routine tries (but does not 
 * guarantee) not to overwrite the target file. 
 * 
 * Note that a crash in an unfortunate moment can leave you with two links to 
 * the target file. 
 * 
 * Log errors with the caller specified severity. 
 * 
 * Returns 0 if the operation succeeded, -1 otherwise. Note that errno is not 
 * valid upon return. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN711"></a><span class='Declare_Function'>durable_link_or_rename</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>oldfile</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newfile</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Ensure that, if we crash directly after the rename/link, a file with 
     * valid contents is moved into place. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> <a href="../../../include/pg_config_manual.h.html#LN126"><span class='Ref_to_Const'>HAVE_WORKING_LINK</span></a> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/zic.c.html#LN109"><span class='Ref_to_Proto'>link</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not link file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* XXX: Add racy file existence check? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>oldfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Make change persistent in case of an OS crash, both the new entry and 
     * its parent directory need to be flushed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Same for parent directory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/common/file_utils.h.html#LN24"><span class='Ref_to_Proto'>fsync_parent_path</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>newfile</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN711"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end durable_link_or_rename &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * InitFileAccess --- initialize this module during backend startup 
 * 
 * This is called during either normal or standalone backend start. 
 * It is *not* called in the postmaster. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN763"></a><span class='Declare_Function'>InitFileAccess</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* call me only once */ 
</span> 
    <span class='Comment_Multi_Line'>/* initialize cache header entry */ 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* register proc-exit hook to ensure temp files are dropped at exit */ 
</span>    <a href="../../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN308"><span class='Ref_to_Proto'>AtProcExit_Files</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitFileAccess &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * count_usable_fds --- count how many FDs the system will let us open, 
 *      and estimate how many are already open. 
 * 
 * We stop counting if usable_fds reaches max_to_probe.  Note: a small 
 * value of max_to_probe might result in an underestimate of already_open; 
 * we must fill in any "gaps" in the set of used FDs before the calculation 
 * of already_open will give the right answer.  In practice, max_to_probe 
 * of a couple of dozen should be enough to ensure good results. 
 * 
 * We assume stdin (FD 0) is available for dup'ing 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN796"></a><span class='Declare_Function'>count_usable_fds</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>max_to_probe</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>usable_fds</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>already_open</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN798"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN799"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN800"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>used</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN801"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>highestfd</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN802"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_GETRLIMIT 
<a name="LN805"></a>    <span class='Control'>struct</span> rlimit <span class='Declare_Local'>rlim</span><span class='Delimiter'>; 
</span><a name="LN806"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>getrlimit_status</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="fd.c.html#LN799"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Number'>1024</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN799"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_GETRLIMIT 
<span class='Directive'>#ifdef</span> RLIMIT_NOFILE            <span class='Comment_Single_Line'>/* most platforms use RLIMIT_NOFILE */ 
</span>    <a href="fd.c.html#LN806"><span class='Ref_To_Local'>getrlimit_status</span></a> <span class='Operator'>= </span>getrlimit<span class='Parentheses'>(</span>RLIMIT_NOFILE<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN805"><span class='Ref_To_Local'>rlim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* but BSD doesn't ... */ 
</span>    <a href="fd.c.html#LN806"><span class='Ref_To_Local'>getrlimit_status</span></a> <span class='Operator'>= </span>getrlimit<span class='Parentheses'>(</span>RLIMIT_OFILE<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN805"><span class='Ref_To_Local'>rlim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* RLIMIT_NOFILE */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN806"><span class='Ref_To_Local'>getrlimit_status</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"getrlimit failed: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_GETRLIMIT */ 
</span> 
    <span class='Comment_Multi_Line'>/* dup until failure or probe limit reached */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN825"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>thisfd</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_GETRLIMIT 
 
        <span class='Comment_Multi_Line'>/* 
         * don't go beyond RLIMIT_NOFILE; causes irritating kernel logs on 
         * some platforms 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN806"><span class='Ref_To_Local'>getrlimit_status</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN801"><span class='Ref_To_Local'>highestfd</span></a> <span class='Operator'>&GT;= </span><a href="fd.c.html#LN805"><span class='Ref_To_Local'>rlim</span></a><span class='Operator'>.</span>rlim_cur <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="fd.c.html#LN825"><span class='Ref_To_Local'>thisfd</span></a> <span class='Operator'>= </span>dup<span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN825"><span class='Ref_To_Local'>thisfd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Expect EMFILE or ENFILE, else it's fishy */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>EMFILE <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENFILE<span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"dup(0) failed after %d successes: %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&GT;= </span><a href="fd.c.html#LN799"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fd.c.html#LN799"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>            <a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN799"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="fd.c.html#LN825"><span class='Ref_To_Local'>thisfd</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN801"><span class='Ref_To_Local'>highestfd</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN825"><span class='Ref_To_Local'>thisfd</span></a><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN801"><span class='Ref_To_Local'>highestfd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN825"><span class='Ref_To_Local'>thisfd</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&GT;= </span><a href="fd.c.html#LN796"><span class='Ref_to_Parameter'>max_to_probe</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* release the files we opened */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN802"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fd.c.html#LN802"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN802"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN802"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN798"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return results.  usable_fds is just the number of successful dups. We 
     * assume that the system limit is highestfd+1 (remember 0 is a legal FD 
     * number) and so already_open is highestfd+1 - usable_fds. 
     */ 
</span>    <span class='Operator'>*</span><a href="fd.c.html#LN796"><span class='Ref_to_Parameter'>usable_fds</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fd.c.html#LN796"><span class='Ref_to_Parameter'>already_open</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN801"><span class='Ref_To_Local'>highestfd</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>- </span><a href="fd.c.html#LN800"><span class='Ref_To_Local'>used</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end count_usable_fds &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * set_max_safe_fds 
 *      Determine number of filedescriptors that fd.c is allowed to use 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN880"></a><span class='Declare_Function'>set_max_safe_fds</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN882"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>usable_fds</span><span class='Delimiter'>; 
</span><a name="LN883"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>already_open</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * We want to set max_safe_fds to 
     *          MIN(usable_fds, max_files_per_process - already_open) 
     * less the slop factor for files that are opened without consulting 
     * fd.c.  This ensures that we won't exceed either max_files_per_process 
     * or the experimentally-determined EMFILE limit. 
     *---------- 
     */ 
</span>    <a href="fd.c.html#LN795"><span class='Ref_to_Func'>count_usable_fds</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN125"><span class='Ref_to_Global_Var'>max_files_per_process</span></a><span class='Delimiter'>, 
</span>                     <span class='Operator'>&</span><a href="fd.c.html#LN882"><span class='Ref_To_Local'>usable_fds</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN883"><span class='Ref_To_Local'>already_open</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN882"><span class='Ref_To_Local'>usable_fds</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN125"><span class='Ref_to_Global_Var'>max_files_per_process</span></a> <span class='Operator'>- </span><a href="fd.c.html#LN883"><span class='Ref_To_Local'>already_open</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Take off the FDs reserved for system() etc. 
     */ 
</span>    <a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>-= </span><a href="fd.c.html#LN110"><span class='Ref_to_Const'>NUM_RESERVED_FDS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure we still have enough to get by. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN116"><span class='Ref_to_Const'>FD_MINFREE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"insufficient file descriptors available to start server process"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"System allows %d, we need at least %d."</span><span class='Delimiter'>, 
</span>                           <a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN110"><span class='Ref_to_Const'>NUM_RESERVED_FDS</span></a><span class='Delimiter'>, 
</span>                           <a href="fd.c.html#LN116"><span class='Ref_to_Const'>FD_MINFREE</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN110"><span class='Ref_to_Const'>NUM_RESERVED_FDS</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"max_safe_fds = %d, usable_fds = %d, already_open = %d"</span><span class='Delimiter'>, 
</span>         <a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN882"><span class='Ref_To_Local'>usable_fds</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN883"><span class='Ref_To_Local'>already_open</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end set_max_safe_fds &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BasicOpenFile --- same as open(2) except can free other FDs if needed 
 * 
 * This is exported for use by places that really want a plain kernel FD, 
 * but need to be proof against running out of FDs.  Once an FD has been 
 * successfully returned, it is the caller's responsibility to ensure that 
 * it will not be leaked on ereport()!  Most users should *not* call this 
 * routine directly, but instead use the VFD abstraction level, which 
 * provides protection against descriptor leaks as well as management of 
 * files that need to be open for more than a short period of time. 
 * 
 * Ideally this should be the *only* direct call of open() in the backend. 
 * In practice, the postmaster calls open() directly, and there are some 
 * direct open() calls done early in backend startup.  Those are OK since 
 * this module wouldn't have any open files to close at that point anyway. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN935"></a><span class='Declare_Function'>BasicOpenFile</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN48"><span class='Ref_to_Typedef'>FileName</span></a> <span class='Declare_Parameter'>fileName</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileFlags</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileMode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN937"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
<a name="LN939"></a><span class='Label'>tryAgain</span><span class='Operator'>: 
</span>    <a href="fd.c.html#LN937"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN935"><span class='Ref_to_Parameter'>fileName</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN935"><span class='Ref_to_Parameter'>fileFlags</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN935"><span class='Ref_to_Parameter'>fileMode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN937"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN937"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* success! */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EMFILE <span class='Operator'>|| </span>errno <span class='Operator'>== </span>ENFILE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN947"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of file descriptors: %m; release and retry"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN297"><span class='Ref_to_Proto'>ReleaseLruFile</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN939"><span class='Ref_to_Label'>tryAgain</span></a><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN947"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* failure */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end BasicOpenFile &raquo; </span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>FDDEBUG<span class='Parentheses'>) 
</span> 
<span class='Keyword'>static void 
</span><a name="LN964"></a><span class='Declare_Function'>_dump_lru</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN966"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mru</span> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>; 
</span><a name="LN967"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a><span class='Delimiter'>]; 
</span><a name="LN968"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>2048</span><span class='Delimiter'>]; 
</span> 
    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"LRU: MOST %d "</span><span class='Delimiter'>, </span><a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN967"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN967"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a><span class='Delimiter'>]; 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d "</span><span class='Delimiter'>, </span><a href="fd.c.html#LN966"><span class='Ref_To_Local'>mru</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span>strlen<span class='Parentheses'>(</span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"LEAST"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN968"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* FDDEBUG */ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN983"></a><span class='Declare_Function'>Delete</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN985"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN983"><span class='Ref_to_Parameter'>file</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"Delete %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN983"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN983"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN963"><span class='Ref_to_Func'>_dump_lru</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN985"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN983"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN985"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN985"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN985"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN985"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN963"><span class='Ref_to_Func'>_dump_lru</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1002"></a><span class='Declare_Function'>LruDelete</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1004"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1002"><span class='Ref_to_Parameter'>file</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LruDelete %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1002"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1002"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1002"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normally we should know the seek position, but if for some reason we 
     * have lost track of it, try again to get it.  If we still can't get it, 
     * we have a problem: we will be unable to restore the file seek position 
     * when and if the file is re-opened.  But we can't really throw an error 
     * and refuse to close the file, or activities such as transaction cleanup 
     * will be broken. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_CUR<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not seek file \"%s\" before closing: %m"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Close the file.  We aren't expecting this to fail; if it does, better 
     * to leak the FD than to mess up our internal state. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not close file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1004"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>--</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* delete the vfd record from the LRU ring */ 
</span>    <a href="fd.c.html#LN293"><span class='Ref_to_Proto'>Delete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1002"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LruDelete &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1043"></a><span class='Declare_Function'>Insert</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1045"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"Insert %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN963"><span class='Ref_to_Func'>_dump_lru</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1045"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN1045"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1045"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1045"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1043"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN963"><span class='Ref_to_Func'>_dump_lru</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end Insert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* returns 0 on success, -1 on re-open failure (with errno set) */ 
</span><span class='Keyword'>static int 
</span><a name="LN1065"></a><span class='Declare_Function'>LruInsert</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1067"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LruInsert %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>        <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The open could still fail for lack of file descriptors, eg due to 
         * overall system file table being full.  So, be prepared to release 
         * another FD if necessary... 
         */ 
</span>        <a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN100"><span class='Ref_to_Proto'>BasicOpenFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN187"><span class='Ref_to_Member'>fileFlags</span></a><span class='Delimiter'>, 
</span>                                 <a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN188"><span class='Ref_to_Member'>fileMode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"re-open failed: %m"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>++</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Seek to the right position.  We need no special case for seekPos 
         * equal to FileUnknownPos, as lseek() will certainly reject that 
         * (thus completing the logic noted in LruDelete() that we will fail 
         * to re-open a file if we couldn't get its seek position before 
         * closing). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * If we fail to restore the seek position, treat it like an 
                 * open() failure. 
                 */ 
</span><a name="LN1113"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not seek file \"%s\" after re-opening: %m"</span><span class='Delimiter'>, 
</span>                     <a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fd.c.html#LN1067"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>--</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Delimiter'>; 
</span>                errno <span class='Operator'>= </span><a href="fd.c.html#LN1113"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if FileIsNotOpen(file) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * put it at the head of the Lru ring 
     */ 
</span> 
    <a href="fd.c.html#LN295"><span class='Ref_to_Proto'>Insert</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1065"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LruInsert &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Release one kernel FD by closing the least-recently-used VFD. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1139"></a><span class='Declare_Function'>ReleaseLruFile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"ReleaseLruFile. Opened %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * There are opened files and so there should be at least one used vfd 
         * in the ring. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN294"><span class='Ref_to_Proto'>LruDelete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN181"><span class='Ref_to_Member'>lruMoreRecently</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* freed a file */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* no files available to free */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Release kernel FDs as needed to get under the max_safe_fds limit. 
 * After calling this, it's OK to try to open another file. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1161"></a><span class='Declare_Function'>ReleaseLruFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a> <span class='Operator'>&GT;= </span><a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN297"><span class='Ref_to_Proto'>ReleaseLruFile</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Keyword'>static </span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> 
<a name="LN1171"></a><span class='Declare_Function'>AllocateVfd</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1173"></a>    <a href="../../../include/c.h.html#LN364"><span class='Ref_to_Typedef'>Index</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1174"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"AllocateVfd. Size %zu"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* InitFileAccess not called? */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The free list is empty so it is time to increase the size of the 
         * array.  We choose to double it each time this happens. However, 
         * there's not much point in starting *real* small. 
         */ 
</span><a name="LN1187"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newCacheSize</span> <span class='Operator'>= </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
</span><a name="LN1188"></a>        <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>newVfdCache</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a> <span class='Operator'>&LT; </span><span class='Number'>32</span><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a> <span class='Operator'>= </span><span class='Number'>32</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Be careful not to clobber VfdCache ptr if realloc fails. 
         */ 
</span>        <a href="fd.c.html#LN1188"><span class='Ref_To_Local'>newVfdCache</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN59"><span class='Ref_to_Macro'>realloc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1188"><span class='Ref_To_Local'>newVfdCache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1188"><span class='Ref_To_Local'>newVfdCache</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Initialize the new entries and link them into the free list. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1173"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Record the new size 
         */ 
</span>        <a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1187"><span class='Ref_To_Local'>newCacheSize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if VfdCache[0].nextFree=... &raquo; </span> 
 
    <a href="fd.c.html#LN1174"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1174"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1174"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocateVfd &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1229"></a><span class='Declare_Function'>FreeVfd</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1231"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1229"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FreeVfd: %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1229"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>? </span><a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>= </span><span class='Number'>0x0</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1231"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN180"><span class='Ref_to_Member'>nextFree</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1229"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* returns 0 on success, -1 on re-open failure (with errno set) */ 
</span><span class='Keyword'>static int 
</span><a name="LN1249"></a><span class='Declare_Function'>FileAccess</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1251"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnValue</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileAccess %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Is the file open?  If not, open it and put it at the head of the LRU 
     * ring (possibly closing the least recently used file to get an FD). 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN1251"><span class='Ref_To_Local'>returnValue</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN296"><span class='Ref_to_Proto'>LruInsert</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1251"><span class='Ref_To_Local'>returnValue</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="fd.c.html#LN1251"><span class='Ref_To_Local'>returnValue</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN182"><span class='Ref_to_Member'>lruLessRecently</span></a> <span class='Operator'>!= </span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We now know that the file is open and that it is not the last one 
         * accessed, so we need to move it to the head of the Lru ring. 
         */ 
</span> 
        <a href="fd.c.html#LN293"><span class='Ref_to_Proto'>Delete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN295"><span class='Ref_to_Proto'>Insert</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1249"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileAccess &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  Called when we get a shared invalidation message on some relation. 
 */ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
<span class='Keyword'>void 
</span><a name="LN1286"></a><span class='Declare_Function'>FileInvalidate</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1286"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1286"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span> 
        <a href="fd.c.html#LN294"><span class='Ref_to_Proto'>LruDelete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1286"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * open a file in an arbitrary directory 
 * 
 * NB: if the passed pathname is relative (which it usually is), 
 * it will be interpreted relative to the process' working directory 
 * (which should always be $PGDATA when this code is running). 
 */ 
</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> 
<a name="LN1302"></a><span class='Declare_Function'>PathNameOpenFile</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN48"><span class='Ref_to_Typedef'>FileName</span></a> <span class='Declare_Parameter'>fileName</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileFlags</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileMode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1304"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fnamecopy</span><span class='Delimiter'>; 
</span><a name="LN1305"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span><a name="LN1306"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"PathNameOpenFile: %s %x %o"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileName</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileFlags</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileMode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need a malloc'd copy of the file name; fail cleanly if no room. 
     */ 
</span>    <a href="fd.c.html#LN1304"><span class='Ref_To_Local'>fnamecopy</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1304"><span class='Ref_To_Local'>fnamecopy</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1305"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN299"><span class='Ref_to_Proto'>AllocateVfd</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1305"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>    <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN100"><span class='Ref_to_Proto'>BasicOpenFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileName</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileFlags</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileMode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1330"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="fd.c.html#LN300"><span class='Ref_to_Proto'>FreeVfd</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1305"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1304"><span class='Ref_To_Local'>fnamecopy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN1330"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>++</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"PathNameOpenFile: success %d"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN295"><span class='Ref_to_Proto'>Insert</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1305"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1304"><span class='Ref_To_Local'>fnamecopy</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Saved flags are adjusted to be OK for re-opening file */ 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN187"><span class='Ref_to_Member'>fileFlags</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileFlags</span></a> <span class='Operator'>& ~</span><span class='Parentheses'>(</span>O_CREAT <span class='Operator'>| </span>O_TRUNC <span class='Operator'>| </span>O_EXCL<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN188"><span class='Ref_to_Member'>fileMode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1302"><span class='Ref_to_Parameter'>fileMode</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>= </span><span class='Number'>0x0</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1306"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN179"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1305"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PathNameOpenFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Open a temporary file that will disappear when we close it. 
 * 
 * This routine takes care of generating an appropriate tempfile name. 
 * There's no need to pass in fileFlags or fileMode either, since only 
 * one setting makes any sense for a temp file. 
 * 
 * Unless interXact is true, the file is remembered by CurrentResourceOwner 
 * to ensure it's closed and deleted when it's no longer needed, typically at 
 * the end-of-transaction. In most cases, you don't want temporary files to 
 * outlive the transaction that created them, so this should be false -- but 
 * if you need "somewhat" temporary storage, this might be useful. In either 
 * case, the file is removed when the File is explicitly closed. 
 */ 
</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> 
<a name="LN1370"></a><span class='Declare_Function'>OpenTemporaryFile</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>interXact</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1372"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>file</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If some temp tablespace(s) have been given to us, try to use the next 
     * one.  If a given tablespace can't be found, we silently fall back to 
     * the database's default tablespace. 
     * 
     * BUT: if the temp file is slated to outlive the current transaction, 
     * force it into the database's default tablespace, so that it will not 
     * pose a threat to possible tablespace drop attempts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="fd.c.html#LN1370"><span class='Ref_to_Parameter'>interXact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1385"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tblspcOid</span> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN108"><span class='Ref_to_Proto'>GetNextTempTableSpace</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1385"><span class='Ref_To_Local'>tblspcOid</span></a><span class='Parentheses'>))</span> 
            <a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN303"><span class='Ref_to_Proto'>OpenTemporaryFileInTablespace</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1385"><span class='Ref_To_Local'>tblspcOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not, or if tablespace is bad, create in database's default 
     * tablespace.  MyDatabaseTableSpace should normally be set before we get 
     * here, but just in case it isn't, fall back to pg_default tablespace. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN303"><span class='Ref_to_Proto'>OpenTemporaryFileInTablespace</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a> <span class='Operator'>? 
</span>                                             <a href="../../utils/init/globals.c.html#LN78"><span class='Ref_to_Global_Var'>MyDatabaseTableSpace</span></a> <span class='Operator'>: 
</span>                                             <a href="../../../include/catalog/pg_tablespace.h.html#LN62"><span class='Ref_to_Const'>DEFAULTTABLESPACE_OID</span></a><span class='Delimiter'>, 
</span>                                             <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark it for deletion at close */ 
</span>    <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>|= </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Register it with the current resource owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN1370"><span class='Ref_to_Parameter'>interXact</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>|= </span><a href="fd.c.html#LN173"><span class='Ref_to_Const'>FD_XACT_TEMPORARY</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/resowner_private.h.html#LN77"><span class='Ref_to_Proto'>ResourceOwnerEnlargeFiles</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN78"><span class='Ref_to_Proto'>ResourceOwnerRememberFile</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN179"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ensure cleanup happens at eoxact */ 
</span>        <a href="fd.c.html#LN208"><span class='Ref_to_Global_Var'>have_xact_temporary_files</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1372"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end OpenTemporaryFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Open a temporary file in a specific tablespace. 
 * Subroutine for OpenTemporaryFile, which see for details. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> 
<a name="LN1426"></a><span class='Declare_Function'>OpenTemporaryFileInTablespace</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tblspcOid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rejectError</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1428"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tempdirpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1429"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tempfilepath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1430"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Identify the tempfile directory for this tablespace. 
     * 
     * If someone tries to specify pg_global, use pg_default instead. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1426"><span class='Ref_to_Parameter'>tblspcOid</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_tablespace.h.html#LN62"><span class='Ref_to_Const'>DEFAULTTABLESPACE_OID</span></a> <span class='Operator'>|| 
</span>        <a href="fd.c.html#LN1426"><span class='Ref_to_Parameter'>tblspcOid</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_tablespace.h.html#LN63"><span class='Ref_to_Const'>GLOBALTABLESPACE_OID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* The default tablespace is {datadir}/base */ 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"base/%s"</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* All other tablespaces are accessed via symlinks */ 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_tblspc/%u/%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN1426"><span class='Ref_to_Parameter'>tblspcOid</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate a tempfile name that should be unique within the current 
     * database instance. 
     */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1429"><span class='Ref_To_Local'>tempfilepath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN1429"><span class='Ref_To_Local'>tempfilepath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%d.%ld"</span><span class='Delimiter'>, 
</span>             <a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Delimiter'>, </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN250"><span class='Ref_to_Global_Var'>tempFileCounter</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Open the file.  Note: we don't use O_EXCL, in case there is an orphaned 
     * temp file that can be reused. 
     */ 
</span>    <a href="fd.c.html#LN1430"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1429"><span class='Ref_To_Local'>tempfilepath</span></a><span class='Delimiter'>, 
</span>                            O_RDWR <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span>O_TRUNC <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                            <span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1430"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We might need to create the tablespace's tempfile directory, if no 
         * one has yet done so. 
         * 
         * Don't check for error from mkdir; it could fail if someone else 
         * just did the same thing.  If it doesn't work then we'll bomb out on 
         * the second create attempt, instead. 
         */ 
</span>        <a href="../../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1428"><span class='Ref_To_Local'>tempdirpath</span></a><span class='Delimiter'>, </span><a href="../../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="fd.c.html#LN1430"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1429"><span class='Ref_To_Local'>tempfilepath</span></a><span class='Delimiter'>, 
</span>                                O_RDWR <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span>O_TRUNC <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, 
</span>                                <span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1430"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN1426"><span class='Ref_to_Parameter'>rejectError</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not create temporary file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN1429"><span class='Ref_To_Local'>tempfilepath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1430"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end OpenTemporaryFileInTablespace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * close a file when done with it 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1492"></a><span class='Declare_Function'>FileClose</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1494"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileClose: %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* close the file */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not close file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>--</span><a href="fd.c.html#LN202"><span class='Ref_to_Global_Var'>nfile</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN155"><span class='Ref_to_Const'>VFD_CLOSED</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* remove the file from the lru ring */ 
</span>        <a href="fd.c.html#LN293"><span class='Ref_to_Proto'>Delete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete the file if it was temporary, and make a log entry if wanted 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1521"></a>        <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>filestats</span><span class='Delimiter'>; 
</span><a name="LN1522"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>stat_errno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we get an error, as could happen within the ereport/elog calls, 
         * we'll come right back here during transaction abort.  Reset the 
         * flag to ensure that we can't get into an infinite loop.  This code 
         * is arranged to ensure that the worst-case consequence is failing to 
         * emit log message(s), not failing to attempt the unlink. 
         */ 
</span>        <a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>&= ~</span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Subtract its size from current usage (do first in case of error) */ 
</span>        <a href="fd.c.html#LN216"><span class='Ref_to_Global_Var'>temporary_files_size</span></a> <span class='Operator'>-= </span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* first try the stat() */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN1521"><span class='Ref_To_Local'>filestats</span></a><span class='Parentheses'>))</span> 
            <a href="fd.c.html#LN1522"><span class='Ref_To_Local'>stat_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="fd.c.html#LN1522"><span class='Ref_To_Local'>stat_errno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* in any case do the unlink */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not unlink file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* and last report the stat results */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1522"><span class='Ref_To_Local'>stat_errno</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/pgstat.h.html#LN1169"><span class='Ref_to_Proto'>pgstat_report_tempfile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1521"><span class='Ref_To_Local'>filestats</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/guc.c.html#LN453"><span class='Ref_to_Global_Var'>log_temp_files</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN1521"><span class='Ref_To_Local'>filestats</span></a><span class='Operator'>.</span>st_size <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="../../utils/misc/guc.c.html#LN453"><span class='Ref_to_Global_Var'>log_temp_files</span></a><span class='Parentheses'>)</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"temporary file: path \"%s\", size %lu"</span><span class='Delimiter'>, 
</span>                                    <a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>                                    <span class='Parentheses'>(</span><span class='Keyword'>unsigned long</span><span class='Parentheses'>) </span><a href="fd.c.html#LN1521"><span class='Ref_To_Local'>filestats</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            errno <span class='Operator'>= </span><a href="fd.c.html#LN1522"><span class='Ref_To_Local'>stat_errno</span></a><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if vfdP-&GT;fdstate&FD_TEMP... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Unregister it from the resource owner */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN179"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN80"><span class='Ref_to_Proto'>ResourceOwnerForgetFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1494"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN179"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Return the Vfd slot to the free list 
     */ 
</span>    <a href="fd.c.html#LN300"><span class='Ref_to_Proto'>FreeVfd</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1492"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileClose &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FilePrefetch - initiate asynchronous read of a given range of the file. 
 * The logical seek position is unaffected. 
 * 
 * Currently the only implementation of this function is using posix_fadvise 
 * which is the simplest standardized interface that accomplishes this. 
 * We could add an implementation using libaio in the future; but note that 
 * this API is inappropriate for libaio, which wants to have a buffer provided 
 * to read into. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1589"></a><span class='Declare_Function'>FilePrefetch</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>amount</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../../include/pg_config_manual.h.html#LN136"><span class='Ref_to_Const'>USE_POSIX_FADVISE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>POSIX_FADV_WILLNEED<span class='Parentheses'>) 
</span><a name="LN1592"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FilePrefetch: %d (%s) "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" %d"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>amount</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1592"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1592"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN1592"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1592"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span>posix_fadvise<span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>amount</span></a><span class='Delimiter'>, 
</span>                               POSIX_FADV_WILLNEED<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1592"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1589"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end FilePrefetch &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN1617"></a><span class='Declare_Function'>FileWriteback</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>nbytes</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1619"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileWriteback: %d (%s) "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Caution: do not call pg_flush_data with nbytes = 0, it could trash the 
     * file's seek position.  We prefer to define that as a no-op here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1619"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1619"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/fd.h.html#LN118"><span class='Ref_to_Proto'>pg_flush_data</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1617"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileWriteback &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1644"></a><span class='Declare_Function'>FileRead</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>amount</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1646"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span><a name="LN1647"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileRead: %d (%s) "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" %d %p"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>amount</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1647"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
<a name="LN1662"></a><span class='Label'>retry</span><span class='Operator'>: 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1647"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1644"><span class='Ref_to_Parameter'>amount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* if seekPos is unknown, leave it that way */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1647"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
            <a href="fd.c.html#LN1647"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Windows may run out of kernel buffers and return "Insufficient 
         * system resources" error.  Wait a bit and retry to solve it. 
         * 
         * It is rumored that EINTR is also possible on some Unix filesystems, 
         * in which case immediate retry is indicated. 
         */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN1683"></a>        <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>error</span> <span class='Operator'>= </span>GetLastError<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1683"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> ERROR_NO_SYSTEM_RESOURCES<span class='Operator'>: 
</span>                <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                errno <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../../port/win32error.c.html#LN169"><span class='Ref_to_Func'>_dosmaperr</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1683"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
        <span class='Comment_Multi_Line'>/* OK to retry if interrupted */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN1662"><span class='Ref_to_Label'>retry</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Trouble, so assume we don't know the file position anymore */ 
</span>        <a href="fd.c.html#LN1647"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN168"><span class='Ref_to_Const'>FileUnknownPos</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="fd.c.html#LN1646"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileRead &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1708"></a><span class='Declare_Function'>FileWrite</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>amount</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1710"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span><a name="LN1711"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileWrite: %d (%s) "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" %d %p"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>amount</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If enforcing temp_file_limit and it's a temp file, check to see if the 
     * write would overrun temp_file_limit, and throw error if so.  Note: it's 
     * really a modularity violation to throw error here; we should set errno 
     * and return -1.  However, there's no way to report a suitable error 
     * message if we do that.  All current callers would just throw error 
     * immediately anyway, so this is safe at present. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/guc.c.html#LN456"><span class='Ref_to_Global_Var'>temp_file_limit</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1736"></a>        off_t       <span class='Declare_Local'>newPos</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Normally we should know the seek position, but if for some reason 
         * we have lost track of it, try again to get it.  Here, it's fine to 
         * throw an error if we still can't get it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_CUR<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not seek file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="fd.c.html#LN1736"><span class='Ref_To_Local'>newPos</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>amount</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1736"><span class='Ref_To_Local'>newPos</span></a> <span class='Operator'>&GT; </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1753"></a>            <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>newTotal</span> <span class='Operator'>= </span><a href="fd.c.html#LN216"><span class='Ref_to_Global_Var'>temporary_files_size</span></a><span class='Delimiter'>; 
</span> 
            <a href="fd.c.html#LN1753"><span class='Ref_To_Local'>newTotal</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN1736"><span class='Ref_To_Local'>newPos</span></a> <span class='Operator'>- </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1753"><span class='Ref_To_Local'>newTotal</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="../../utils/misc/guc.c.html#LN456"><span class='Ref_to_Global_Var'>temp_file_limit</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><span class='Number'>1024</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CONFIGURATION_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"temporary file size exceeds temp_file_limit (%dkB)"</span><span class='Delimiter'>, 
</span>                        <a href="../../utils/misc/guc.c.html#LN456"><span class='Ref_to_Global_Var'>temp_file_limit</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if temp_file_limit&GT;=0&&(... &raquo; </span> 
 
<a name="LN1764"></a><span class='Label'>retry</span><span class='Operator'>: 
</span>    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>amount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if write didn't set errno, assume problem is no disk space */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>!= </span><a href="fd.c.html#LN1708"><span class='Ref_to_Parameter'>amount</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        errno <span class='Operator'>= </span>ENOSPC<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* if seekPos is unknown, leave it that way */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
            <a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Maintain fileSize and temporary_files_size if it's a temp file. 
         * 
         * If seekPos is -1 (unknown), this will do nothing; but we could only 
         * get here in that state if we're not enforcing temporary_files_size, 
         * so we don't care. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1789"></a>            off_t       <span class='Declare_Local'>newPos</span> <span class='Operator'>= </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1789"><span class='Ref_To_Local'>newPos</span></a> <span class='Operator'>&GT; </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="fd.c.html#LN216"><span class='Ref_to_Global_Var'>temporary_files_size</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN1789"><span class='Ref_To_Local'>newPos</span></a> <span class='Operator'>- </span><a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a><span class='Delimiter'>; 
</span>                <a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1789"><span class='Ref_To_Local'>newPos</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if returnCode&GT;=0 &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * See comments in FileRead() 
         */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN1804"></a>        <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>error</span> <span class='Operator'>= </span>GetLastError<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1804"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> ERROR_NO_SYSTEM_RESOURCES<span class='Operator'>: 
</span>                <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>1000L</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                errno <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../../port/win32error.c.html#LN169"><span class='Ref_to_Func'>_dosmaperr</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1804"><span class='Ref_To_Local'>error</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
        <span class='Comment_Multi_Line'>/* OK to retry if interrupted */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN1764"><span class='Ref_to_Label'>retry</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Trouble, so assume we don't know the file position anymore */ 
</span>        <a href="fd.c.html#LN1711"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN168"><span class='Ref_to_Const'>FileUnknownPos</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="fd.c.html#LN1710"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileWrite &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN1829"></a><span class='Declare_Function'>FileSync</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1831"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileSync: %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1831"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1831"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN1831"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1831"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1829"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1831"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileSync &raquo; </span> 
 
off_t 
<a name="LN1850"></a><span class='Declare_Function'>FileSeek</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>whence</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1852"></a>    <a href="fd.c.html#LN175"><span class='Ref_to_Typedef'>Vfd</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>vfdP</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileSeek: %d (%s) "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a> <span class='String'>" %d"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>, 
</span>               <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a> <span class='Operator'>= &</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> SEEK_SET<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    errno <span class='Operator'>= </span>EINVAL<span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SEEK_CUR<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                    <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    errno <span class='Operator'>= </span>EINVAL<span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SEEK_END<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Control'>return</span> <span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid whence: %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch whence &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if FileIsNotOpen(file) &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> SEEK_SET<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    errno <span class='Operator'>= </span>EINVAL<span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>!= </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>) 
</span>                    <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SEEK_CUR<span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="fd.c.html#LN169"><span class='Ref_to_Macro'>FilePosIsUnknown</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Parentheses'>))</span> 
                    <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> SEEK_END<span class='Operator'>: 
</span>                <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a> <span class='Operator'>= </span>lseek<span class='Parentheses'>(</span><a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid whence: %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN1850"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch whence &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="fd.c.html#LN1852"><span class='Ref_To_Local'>vfdP</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileSeek &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * XXX not actually used but here for completeness 
 */ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
off_t 
<a name="LN1928"></a><span class='Declare_Function'>FileTell</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1928"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileTell %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1928"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1928"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1928"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN183"><span class='Ref_to_Member'>seekPos</span></a><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Keyword'>int 
</span><a name="LN1938"></a><span class='Declare_Function'>FileTruncate</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Delimiter'>, </span>off_t <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1940"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returnCode</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FileTruncate %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN302"><span class='Ref_to_Proto'>FileAccess</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32.h.html#LN58"><span class='Ref_to_Macro'>ftruncate</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>&GT; </span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* adjust our state for truncation of a temp file */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN216"><span class='Ref_to_Global_Var'>temporary_files_size</span></a> <span class='Operator'>-= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>- </span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN184"><span class='Ref_to_Member'>fileSize</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN1938"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN1940"><span class='Ref_To_Local'>returnCode</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FileTruncate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the pathname associated with an open file. 
 * 
 * The returned string points to an internal buffer, which is valid until 
 * the file is closed. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1973"></a><span class='Declare_Function'>FilePathName</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1973"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1973"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Return the raw file descriptor of an opened file. 
 * 
 * The returned file descriptor will be valid until the file is closed, but 
 * there are a lot of things that can make that happen.  So the caller should 
 * be careful not to do much of anything else before it finishes using the 
 * returned file descriptor. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1989"></a><span class='Declare_Function'>FileGetRawDesc</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1989"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1989"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN177"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * FileGetRawFlags - returns the file flags on open(2) 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1999"></a><span class='Declare_Function'>FileGetRawFlags</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN1999"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN1999"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN187"><span class='Ref_to_Member'>fileFlags</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * FileGetRawMode - returns the mode bitmask passed to open(2) 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2009"></a><span class='Declare_Function'>FileGetRawMode</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a> <span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN157"><span class='Ref_to_Macro'>FileIsValid</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2009"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2009"><span class='Ref_to_Parameter'>file</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN188"><span class='Ref_to_Member'>fileMode</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Make room for another allocatedDescs[] array entry if needed and possible. 
 * Returns true if an array element is available. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2020"></a><span class='Declare_Function'>reserveAllocatedDesc</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2022"></a>    <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newDescs</span><span class='Delimiter'>; 
</span><a name="LN2023"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>newMax</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick out if array already has a free slot. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the array hasn't yet been created in the current process, initialize 
     * it with FD_MINFREE / 2 elements.  In many scenarios this is as many as 
     * we will ever need, anyway.  We don't want to look at max_safe_fds 
     * immediately because set_max_safe_fds() may not have run yet. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN116"><span class='Ref_to_Const'>FD_MINFREE</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Out of memory already?  Treat as fatal error. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Consider enlarging the array beyond the initial allocation used above. 
     * By the time this happens, max_safe_fds should be known accurately. 
     * 
     * We mustn't let allocated descriptors hog all the available FDs, and in 
     * practice we'd better leave a reasonable number of FDs for VFD use.  So 
     * set the maximum to max_safe_fds / 2.  (This should certainly be at 
     * least as large as the initial size, FD_MINFREE / 2.) 
     */ 
</span>    <a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN138"><span class='Ref_to_Global_Var'>max_safe_fds</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a> <span class='Operator'>&GT; </span><a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN59"><span class='Ref_to_Macro'>realloc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>, 
</span>                                            <a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Treat out-of-memory as a non-fatal error. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2022"><span class='Ref_To_Local'>newDescs</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2023"><span class='Ref_To_Local'>newMax</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Can't enlarge allocatedDescs[] any more. */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end reserveAllocatedDesc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Routines that want to use stdio (ie, FILE*) should use AllocateFile 
 * rather than plain fopen().  This lets fd.c deal with freeing FDs if 
 * necessary to open the file.  When done, call FreeFile rather than fclose. 
 * 
 * Note that files that will be open for any significant length of time 
 * should NOT be handled this way, since they cannot share kernel file 
 * descriptors with other files; there is grave risk of running out of FDs 
 * if anyone locks down too many FDs.  Most callers of this routine are 
 * simply reading a config file that they will read and close immediately. 
 * 
 * fd.c will automatically close all files opened with AllocateFile at 
 * transaction commit or abort; this prevents FD leakage if a routine 
 * that calls AllocateFile is terminated prematurely by ereport(ERROR). 
 * 
 * Ideally this should be the *only* direct call of fopen() in the backend. 
 */ 
</span>FILE <span class='Operator'>* 
</span><a name="LN2093"></a><span class='Declare_Function'>AllocateFile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2095"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"AllocateFile: Allocated %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2093"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can we allocate another non-virtual FD? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN304"><span class='Ref_to_Proto'>reserveAllocatedDesc</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"exceeded maxAllocatedDescs (%d) while trying to open file \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2093"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>    <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<a name="LN2110"></a><span class='Label'>TryAgain</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2095"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2093"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2093"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2113"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>]; 
</span> 
        <a href="fd.c.html#LN2113"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN224"><span class='Ref_to_EnumConst'>AllocateDescFile</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2113"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2095"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2113"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN2113"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EMFILE <span class='Operator'>|| </span>errno <span class='Operator'>== </span>ENFILE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2124"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of file descriptors: %m; release and retry"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN297"><span class='Ref_to_Proto'>ReleaseLruFile</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN2110"><span class='Ref_to_Label'>TryAgain</span></a><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN2124"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocateFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Like AllocateFile, but returns an unbuffered fd like open(2) 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2143"></a><span class='Declare_Function'>OpenTransientFile</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN48"><span class='Ref_to_Typedef'>FileName</span></a> <span class='Declare_Parameter'>fileName</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileFlags</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fileMode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2145"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"OpenTransientFile: Allocated %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2143"><span class='Ref_to_Parameter'>fileName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can we allocate another non-virtual FD? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN304"><span class='Ref_to_Proto'>reserveAllocatedDesc</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"exceeded maxAllocatedDescs (%d) while trying to open file \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2143"><span class='Ref_to_Parameter'>fileName</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>    <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN2145"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN100"><span class='Ref_to_Proto'>BasicOpenFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2143"><span class='Ref_to_Parameter'>fileName</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2143"><span class='Ref_to_Parameter'>fileFlags</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2143"><span class='Ref_to_Parameter'>fileMode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2145"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2164"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>]; 
</span> 
        <a href="fd.c.html#LN2164"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN227"><span class='Ref_to_EnumConst'>AllocateDescRawFD</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2164"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN238"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2145"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2164"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="fd.c.html#LN2145"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* failure */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end OpenTransientFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Routines that want to initiate a pipe stream should use OpenPipeStream 
 * rather than plain popen().  This lets fd.c deal with freeing FDs if 
 * necessary.  When done, call ClosePipeStream rather than pclose. 
 */ 
</span>FILE <span class='Operator'>* 
</span><a name="LN2183"></a><span class='Declare_Function'>OpenPipeStream</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>command</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2185"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"OpenPipeStream: Allocated %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2183"><span class='Ref_to_Parameter'>command</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can we allocate another non-virtual FD? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN304"><span class='Ref_to_Proto'>reserveAllocatedDesc</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"exceeded maxAllocatedDescs (%d) while trying to execute command \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2183"><span class='Ref_to_Parameter'>command</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>    <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<a name="LN2200"></a><span class='Label'>TryAgain</span><span class='Operator'>: 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2185"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN313"><span class='Ref_to_Macro'>popen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2183"><span class='Ref_to_Parameter'>command</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2183"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2206"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>]; 
</span> 
        <a href="fd.c.html#LN2206"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN225"><span class='Ref_to_EnumConst'>AllocateDescPipe</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2206"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2185"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2206"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN2206"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EMFILE <span class='Operator'>|| </span>errno <span class='Operator'>== </span>ENFILE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2217"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of file descriptors: %m; release and retry"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN297"><span class='Ref_to_Proto'>ReleaseLruFile</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN2200"><span class='Ref_to_Label'>TryAgain</span></a><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN2217"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end OpenPipeStream &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free an AllocateDesc of any type. 
 * 
 * The argument *must* point into the allocatedDescs[] array. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN2237"></a><span class='Declare_Function'>FreeDesc</span><span class='Parentheses'>(</span><a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2239"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close the underlying object */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="fd.c.html#LN224"><span class='Ref_to_EnumConst'>AllocateDescFile</span></a><span class='Operator'>: 
</span>            <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>fclose<span class='Parentheses'>(</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="fd.c.html#LN225"><span class='Ref_to_EnumConst'>AllocateDescPipe</span></a><span class='Operator'>: 
</span>            <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN314"><span class='Ref_to_Macro'>pclose</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="fd.c.html#LN226"><span class='Ref_to_EnumConst'>AllocateDescDir</span></a><span class='Operator'>: 
</span>            <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32_msvc/dirent.h.html#LN20"><span class='Ref_to_Proto'>closedir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN237"><span class='Ref_to_Member'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="fd.c.html#LN227"><span class='Ref_to_EnumConst'>AllocateDescRawFD</span></a><span class='Operator'>: 
</span>            <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN238"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"AllocateDesc kind not recognized"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Compact storage in the allocatedDescs array */ 
</span>    <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="fd.c.html#LN2237"><span class='Ref_to_Parameter'>desc</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>return</span> <a href="fd.c.html#LN2239"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreeDesc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close a file returned by AllocateFile. 
 * 
 * Note we do not check fclose's return value --- it is up to the caller 
 * to handle close errors. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2276"></a><span class='Declare_Function'>FreeFile</span><span class='Parentheses'>(</span>FILE <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2278"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FreeFile: Allocated %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove file from list of allocated files, if it's present */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2278"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="fd.c.html#LN2278"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2285"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2278"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2285"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN224"><span class='Ref_to_EnumConst'>AllocateDescFile</span></a> <span class='Operator'>&& </span><a href="fd.c.html#LN2285"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2276"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2285"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Only get here if someone passes us a file not in allocatedDescs */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"file passed to FreeFile was not obtained from AllocateFile"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> fclose<span class='Parentheses'>(</span><a href="fd.c.html#LN2276"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreeFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close a file returned by OpenTransientFile. 
 * 
 * Note we do not check close's return value --- it is up to the caller 
 * to handle close errors. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2304"></a><span class='Declare_Function'>CloseTransientFile</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>fd</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2306"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"CloseTransientFile: Allocated %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove fd from list of allocated files, if it's present */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2306"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="fd.c.html#LN2306"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2313"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2306"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2313"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN227"><span class='Ref_to_EnumConst'>AllocateDescRawFD</span></a> <span class='Operator'>&& </span><a href="fd.c.html#LN2313"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN238"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2304"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2313"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Only get here if someone passes us a file not in allocatedDescs */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"fd passed to CloseTransientFile was not obtained from OpenTransientFile"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2304"><span class='Ref_to_Parameter'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CloseTransientFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Routines that want to use &LT;dirent.h&GT; (ie, DIR*) should use AllocateDir 
 * rather than plain opendir().  This lets fd.c deal with freeing FDs if 
 * necessary to open the directory, and with closing it after an elog. 
 * When done, call FreeDir rather than closedir. 
 * 
 * Ideally this should be the *only* direct call of opendir() in the backend. 
 */ 
</span><a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>* 
</span><a name="LN2334"></a><span class='Declare_Function'>AllocateDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2336"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"AllocateDir: Allocated %d (%s)"</span><span class='Delimiter'>, 
</span>               <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2334"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can we allocate another non-virtual FD? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN304"><span class='Ref_to_Proto'>reserveAllocatedDesc</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"exceeded maxAllocatedDescs (%d) while trying to open directory \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN243"><span class='Ref_to_Global_Var'>maxAllocatedDescs</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2334"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Close excess kernel FDs. */ 
</span>    <a href="fd.c.html#LN298"><span class='Ref_to_Proto'>ReleaseLruFiles</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<a name="LN2351"></a><span class='Label'>TryAgain</span><span class='Operator'>: 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2336"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32_msvc/dirent.h.html#LN18"><span class='Ref_to_Proto'>opendir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2334"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2354"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>]; 
</span> 
        <a href="fd.c.html#LN2354"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN226"><span class='Ref_to_EnumConst'>AllocateDescDir</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2354"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN237"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2336"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2354"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN2354"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN237"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EMFILE <span class='Operator'>|| </span>errno <span class='Operator'>== </span>ENFILE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2365"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_RESOURCES<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of file descriptors: %m; release and retry"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN297"><span class='Ref_to_Proto'>ReleaseLruFile</span></a><span class='Parentheses'>())</span> 
            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fd.c.html#LN2351"><span class='Ref_to_Label'>TryAgain</span></a><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN2365"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocateDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read a directory opened with AllocateDir, ereport'ing any error. 
 * 
 * This is easier to use than raw readdir() since it takes care of some 
 * otherwise rather tedious and error-prone manipulation of errno.  Also, 
 * if you are happy with a generic error message for AllocateDir failure, 
 * you can just do 
 * 
 *      dir = AllocateDir(path); 
 *      while ((dirent = ReadDir(dir, path)) != NULL) 
 *          process dirent; 
 *      FreeDir(dir); 
 * 
 * since a NULL dir parameter is taken as indicating AllocateDir failed. 
 * (Make sure errno hasn't been changed since AllocateDir if you use this 
 * shortcut.) 
 * 
 * The pathname passed to AllocateDir must be passed to this routine too, 
 * but it is only used for error reporting. 
 */ 
</span><span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>* 
</span><a name="LN2400"></a><span class='Declare_Function'>ReadDir</span><span class='Parentheses'>(</span><a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="fd.c.html#LN306"><span class='Ref_to_Proto'>ReadDirExtended</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2400"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2400"><span class='Ref_to_Parameter'>dirname</span></a><span class='Delimiter'>, </span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Alternate version that allows caller to specify the elevel for any 
 * error report.  If elevel &LT; ERROR, returns NULL on any error. 
 */ 
</span><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>* 
</span><a name="LN2410"></a><span class='Declare_Function'>ReadDirExtended</span><span class='Parentheses'>(</span><a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2412"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dent</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Give a generic message for AllocateDir failure, if caller didn't */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2412"><span class='Ref_To_Local'>dent</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32_msvc/dirent.h.html#LN19"><span class='Ref_to_Proto'>readdir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="fd.c.html#LN2412"><span class='Ref_To_Local'>dent</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno<span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="fd.c.html#LN2410"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReadDirExtended &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close a directory opened with AllocateDir. 
 * 
 * Note we do not check closedir's return value --- it is up to the caller 
 * to handle close errors. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2443"></a><span class='Declare_Function'>FreeDir</span><span class='Parentheses'>(</span><a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2445"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"FreeDir: Allocated %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove dir from list of allocated dirs, if it's present */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="fd.c.html#LN2445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2452"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2452"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN226"><span class='Ref_to_EnumConst'>AllocateDescDir</span></a> <span class='Operator'>&& </span><a href="fd.c.html#LN2452"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN237"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2443"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2452"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Only get here if someone passes us a dir not in allocatedDescs */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"dir passed to FreeDir was not obtained from AllocateDir"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN20"><span class='Ref_to_Proto'>closedir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2443"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreeDir &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Close a pipe stream returned by OpenPipeStream. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN2469"></a><span class='Declare_Function'>ClosePipeStream</span><span class='Parentheses'>(</span>FILE <span class='Operator'>*</span><span class='Declare_Parameter'>file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2471"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN144"><span class='Ref_to_Macro'>DO_DB</span></a><span class='Parentheses'>(</span><a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"ClosePipeStream: Allocated %d"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove file from list of allocated files, if it's present */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2471"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="fd.c.html#LN2471"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2478"></a>        <a href="fd.c.html#LN230"><span class='Ref_to_Typedef'>AllocateDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>desc</span> <span class='Operator'>= &</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2471"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2478"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN232"><span class='Ref_to_Member'>kind</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN225"><span class='Ref_to_EnumConst'>AllocateDescPipe</span></a> <span class='Operator'>&& </span><a href="fd.c.html#LN2478"><span class='Ref_To_Local'>desc</span></a><span class='Operator'>-&GT;</span><a href="fd.c.html#LN239"><span class='Ref_to_Member'>desc</span></a><span class='Operator'>.</span><a href="fd.c.html#LN236"><span class='Ref_to_Member'>file</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2469"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2478"><span class='Ref_To_Local'>desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Only get here if someone passes us a file not in allocatedDescs */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"file passed to ClosePipeStream was not obtained from OpenPipeStream"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/port.h.html#LN314"><span class='Ref_to_Macro'>pclose</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2469"><span class='Ref_to_Parameter'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ClosePipeStream &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * closeAllVfds 
 * 
 * Force all VFDs into the physically-closed state, so that the fewest 
 * possible number of kernel file descriptors are in use.  There is no 
 * change in the logical state of the VFDs. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2498"></a><span class='Declare_Function'>closeAllVfds</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2500"></a>    <a href="../../../include/c.h.html#LN364"><span class='Ref_to_Typedef'>Index</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Make sure ring not corrupted */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2500"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="fd.c.html#LN2500"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN2500"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2500"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                <a href="fd.c.html#LN294"><span class='Ref_to_Proto'>LruDelete</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2500"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * SetTempTablespaces 
 * 
 * Define a list (actually an array) of OIDs of tablespaces to use for 
 * temporary files.  This list will be used until end of transaction, 
 * unless this function is called again before then.  It is caller's 
 * responsibility that the passed-in array has adequate lifespan (typically 
 * it'd be allocated in TopTransactionContext). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2524"></a><span class='Declare_Function'>SetTempTablespaces</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tableSpaces</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>numSpaces</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2524"><span class='Ref_to_Parameter'>numSpaces</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN256"><span class='Ref_to_Global_Var'>tempTableSpaces</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2524"><span class='Ref_to_Parameter'>tableSpaces</span></a><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2524"><span class='Ref_to_Parameter'>numSpaces</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select a random starting point in the list.  This is to minimize 
     * conflicts between backends that are most likely sharing the same list 
     * of temp tablespaces.  Note that if we create multiple temp files in the 
     * same transaction, we'll advance circularly through the list --- this 
     * ensures that large temporary sort files are nicely spread across all 
     * available tablespaces. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2524"><span class='Ref_to_Parameter'>numSpaces</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="fd.c.html#LN258"><span class='Ref_to_Global_Var'>nextTempTableSpace</span></a> <span class='Operator'>= </span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>() </span><span class='Operator'>% </span><a href="fd.c.html#LN2524"><span class='Ref_to_Parameter'>numSpaces</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="fd.c.html#LN258"><span class='Ref_to_Global_Var'>nextTempTableSpace</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetTempTablespaces &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * TempTablespacesAreSet 
 * 
 * Returns TRUE if SetTempTablespaces has been called in current transaction. 
 * (This is just so that tablespaces.c doesn't need its own per-transaction 
 * state.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN2552"></a><span class='Declare_Function'>TempTablespacesAreSet</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GetNextTempTableSpace 
 * 
 * Select the next temp tablespace to use.  A result of InvalidOid means 
 * to use the current database's default tablespace. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN2564"></a><span class='Declare_Function'>GetNextTempTableSpace</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Advance nextTempTableSpace counter with wraparound */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="fd.c.html#LN258"><span class='Ref_to_Global_Var'>nextTempTableSpace</span></a> <span class='Operator'>&GT;= </span><a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN258"><span class='Ref_to_Global_Var'>nextTempTableSpace</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="fd.c.html#LN256"><span class='Ref_to_Global_Var'>tempTableSpaces</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN258"><span class='Ref_to_Global_Var'>nextTempTableSpace</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOSubXact_Files 
 * 
 * Take care of subtransaction commit/abort.  At abort, we close temp files 
 * that the subtransaction may have opened.  At commit, we reassign the 
 * files that were opened to the parent subtransaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2585"></a><span class='Declare_Function'>AtEOSubXact_Files</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Delimiter'>, 
</span><a name="LN2586"></a>                  <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>parentSubid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2588"></a>    <a href="../../../include/c.h.html#LN364"><span class='Ref_to_Typedef'>Index</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2585"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2585"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>                <a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN233"><span class='Ref_to_Member'>create_subid</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN2586"><span class='Ref_to_Parameter'>parentSubid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* have to recheck the item after FreeDesc (ugly) */ 
</span>                <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2588"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AtEOSubXact_Files &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOXact_Files 
 * 
 * This routine is called during transaction commit or abort (it doesn't 
 * particularly care which).  All still-open per-transaction temporary file 
 * VFDs are closed, which also causes the underlying files to be deleted 
 * (although they should've been closed already by the ResourceOwner 
 * cleanup). Furthermore, all "allocated" stdio files are closed. We also 
 * forget any transaction-local temp tablespace list. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2616"></a><span class='Declare_Function'>AtEOXact_Files</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="fd.c.html#LN309"><span class='Ref_to_Proto'>CleanupTempFiles</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN256"><span class='Ref_to_Global_Var'>tempTableSpaces</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN257"><span class='Ref_to_Global_Var'>numTempTableSpaces</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtProcExit_Files 
 * 
 * on_proc_exit hook to clean up temp files during backend shutdown. 
 * Here, we want to clean up *all* temp files including interXact ones. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2630"></a><span class='Declare_Function'>AtProcExit_Files</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="fd.c.html#LN309"><span class='Ref_to_Proto'>CleanupTempFiles</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Close temporary files and delete their underlying files. 
 * 
 * isProcExit: if true, this is being called as the backend process is 
 * exiting. If that's the case, we should remove all temporary files; if 
 * that's not the case, we are being called for transaction commit/abort 
 * and should only remove transaction-local temp files.  In either case, 
 * also clean up "allocated" stdio files, dirs and fds. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2645"></a><span class='Declare_Function'>CleanupTempFiles</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isProcExit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2647"></a>    <a href="../../../include/c.h.html#LN364"><span class='Ref_to_Typedef'>Index</span></a>       <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Careful here: at proc_exit we need extra cleanup, not just 
     * xact_temporary files. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2645"><span class='Ref_to_Parameter'>isProcExit</span></a> <span class='Operator'>|| </span><a href="fd.c.html#LN208"><span class='Ref_to_Global_Var'>have_xact_temporary_files</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fd.c.html#LN160"><span class='Ref_to_Macro'>FileIsNotOpen</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Make sure ring not corrupted */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="fd.c.html#LN197"><span class='Ref_to_Global_Var'>SizeVfdCache</span></a><span class='Delimiter'>; </span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2658"></a>            <span class='Keyword'>unsigned short </span><span class='Declare_Local'>fdstate</span> <span class='Operator'>= </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN178"><span class='Ref_to_Member'>fdstate</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2658"><span class='Ref_To_Local'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN172"><span class='Ref_to_Const'>FD_TEMPORARY</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * If we're in the process of exiting a backend process, close 
                 * all temporary files. Otherwise, only close temporary files 
                 * local to the current transaction. They should be closed by 
                 * the ResourceOwner mechanism already, so this is just a 
                 * debugging cross-check. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2645"><span class='Ref_to_Parameter'>isProcExit</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/storage/fd.h.html#LN69"><span class='Ref_to_Proto'>FileClose</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2658"><span class='Ref_To_Local'>fdstate</span></a> <span class='Operator'>& </span><a href="fd.c.html#LN173"><span class='Ref_to_Const'>FD_XACT_TEMPORARY</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"temporary file %s not closed at end-of-transaction"</span><span class='Delimiter'>, 
</span>                         <a href="fd.c.html#LN196"><span class='Ref_to_Global_Var'>VfdCache</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="fd.c.html#LN185"><span class='Ref_to_Member'>fileName</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/fd.h.html#LN69"><span class='Ref_to_Proto'>FileClose</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2647"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;SizeVfdCache;i+... &raquo; </span> 
 
        <a href="fd.c.html#LN208"><span class='Ref_to_Global_Var'>have_xact_temporary_files</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isProcExit||have_xact... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Clean up "allocated" stdio files, dirs and fds. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN242"><span class='Ref_to_Global_Var'>numAllocatedDescs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="fd.c.html#LN305"><span class='Ref_to_Proto'>FreeDesc</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fd.c.html#LN244"><span class='Ref_to_Global_Var'>allocatedDescs</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CleanupTempFiles &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Remove temporary and temporary relation files left over from a prior 
 * postmaster session 
 * 
 * This should be called during postmaster startup.  It will forcibly 
 * remove any leftover files created by OpenTemporaryFile and any leftover 
 * temporary relation files created by mdcreate. 
 * 
 * NOTE: we could, but don't, call this during a post-backend-crash restart 
 * cycle.  The argument for not doing it is that someone might want to examine 
 * the temp files for debugging purposes.  This does however mean that 
 * OpenTemporaryFile had better allow for collision with an existing temp 
 * file name. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2705"></a><span class='Declare_Function'>RemovePgTempFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2707"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>temp_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Number'>10</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]; 
</span><a name="LN2708"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>spc_dir</span><span class='Delimiter'>; 
</span><a name="LN2709"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spc_de</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First process temp files in pg_default ($PGDATA/base) 
     */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"base/%s"</span><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN310"><span class='Ref_to_Proto'>RemovePgTempFilesInDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="fd.c.html#LN311"><span class='Ref_to_Proto'>RemovePgTempRelationFiles</span></a><span class='Parentheses'>(</span><span class='String'>"base"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Cycle through temp directories for all non-default tablespaces. 
     */ 
</span>    <a href="fd.c.html#LN2708"><span class='Ref_To_Local'>spc_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2709"><span class='Ref_To_Local'>spc_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2708"><span class='Ref_To_Local'>spc_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN2709"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN2709"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_tblspc/%s/%s/%s"</span><span class='Delimiter'>, 
</span>            <a href="fd.c.html#LN2709"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN310"><span class='Ref_to_Proto'>RemovePgTempFilesInDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_tblspc/%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2709"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN311"><span class='Ref_to_Proto'>RemovePgTempRelationFiles</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2707"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2708"><span class='Ref_To_Local'>spc_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In EXEC_BACKEND case there is a pgsql_tmp directory at the top level of 
     * DataDir as well. 
     */ 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
    <a href="fd.c.html#LN310"><span class='Ref_to_Proto'>RemovePgTempFilesInDir</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN126"><span class='Ref_to_Const'>PG_TEMP_FILES_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end RemovePgTempFiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one pgsql_tmp directory for RemovePgTempFiles */ 
</span><span class='Keyword'>static void 
</span><a name="LN2751"></a><span class='Declare_Function'>RemovePgTempFilesInDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tmpdirname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2753"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>temp_dir</span><span class='Delimiter'>; 
</span><a name="LN2754"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>temp_de</span><span class='Delimiter'>; 
</span><a name="LN2755"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>rm_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN2753"><span class='Ref_To_Local'>temp_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2751"><span class='Ref_to_Parameter'>tmpdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2753"><span class='Ref_To_Local'>temp_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* anything except ENOENT is fishy */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open temporary-files directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2751"><span class='Ref_to_Parameter'>tmpdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2754"><span class='Ref_To_Local'>temp_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2753"><span class='Ref_To_Local'>temp_dir</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2751"><span class='Ref_to_Parameter'>tmpdirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN2754"><span class='Ref_To_Local'>temp_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN2754"><span class='Ref_To_Local'>temp_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2755"><span class='Ref_To_Local'>rm_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2755"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2751"><span class='Ref_to_Parameter'>tmpdirname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2754"><span class='Ref_To_Local'>temp_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="fd.c.html#LN2754"><span class='Ref_To_Local'>temp_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Delimiter'>, 
</span>                    strlen<span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN127"><span class='Ref_to_Const'>PG_TEMP_FILE_PREFIX</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2755"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* note we ignore any error */ 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"unexpected file found in temporary-files directory: \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2755"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2753"><span class='Ref_To_Local'>temp_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemovePgTempFilesInDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one tablespace directory, look for per-DB subdirectories */ 
</span><span class='Keyword'>static void 
</span><a name="LN2792"></a><span class='Declare_Function'>RemovePgTempRelationFiles</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tsdirname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2794"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>ts_dir</span><span class='Delimiter'>; 
</span><a name="LN2795"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN2796"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>dbspace_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN2794"><span class='Ref_To_Local'>ts_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2792"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2794"><span class='Ref_To_Local'>ts_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* anything except ENOENT is fishy */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open tablespace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2792"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2795"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2794"><span class='Ref_To_Local'>ts_dir</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2792"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2811"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're only interested in the per-database directories, which have 
         * numeric names.  Note that this code will also (properly) ignore "." 
         * and "..". 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="fd.c.html#LN2795"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2811"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Operator'>++</span><a href="fd.c.html#LN2811"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2795"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2811"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>|| </span><a href="fd.c.html#LN2811"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2796"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2796"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2792"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2795"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN312"><span class='Ref_to_Proto'>RemovePgTempRelationFilesInDbspace</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2796"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2794"><span class='Ref_To_Local'>ts_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemovePgTempRelationFiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one per-dbspace directory for RemovePgTempRelationFiles */ 
</span><span class='Keyword'>static void 
</span><a name="LN2833"></a><span class='Declare_Function'>RemovePgTempRelationFilesInDbspace</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbspacedirname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2835"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dbspace_dir</span><span class='Delimiter'>; 
</span><a name="LN2836"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN2837"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>rm_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="fd.c.html#LN2835"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2833"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2835"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we just saw this directory, so it really ought to be there */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"could not open dbspace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>             <a href="fd.c.html#LN2833"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN2836"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2835"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2833"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN313"><span class='Ref_to_Proto'>looks_like_temp_rel_name</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2836"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2837"><span class='Ref_To_Local'>rm_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN2837"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="fd.c.html#LN2833"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN2836"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2837"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* note we ignore any error */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN2835"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemovePgTempRelationFilesInDbspace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* t&LT;digits&GT;_&LT;digits&GT;, or t&LT;digits&GT;_&LT;digits&GT;_&LT;forkname&GT; */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2865"></a><span class='Declare_Function'>looks_like_temp_rel_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2867"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pos</span><span class='Delimiter'>; 
</span><a name="LN2868"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>savepos</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must start with "t". */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'t'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Followed by a non-empty string of digits and then an underscore. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'_'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Followed by another nonempty string of digits. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2868"><span class='Ref_To_Local'>savepos</span></a> <span class='Operator'>= ++</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>; </span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2868"><span class='Ref_To_Local'>savepos</span></a> <span class='Operator'>== </span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We might have _forkname or .segment or both. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'_'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2889"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>forkchar</span> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN45"><span class='Ref_to_Proto'>forkname_chars</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2889"><span class='Ref_To_Local'>forkchar</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN2889"><span class='Ref_To_Local'>forkchar</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'.'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2897"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>segchar</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2897"><span class='Ref_To_Local'>segchar</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><a href="fd.c.html#LN2897"><span class='Ref_To_Local'>segchar</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="fd.c.html#LN2897"><span class='Ref_To_Local'>segchar</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2897"><span class='Ref_To_Local'>segchar</span></a> <span class='Operator'>&LT;= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="fd.c.html#LN2897"><span class='Ref_To_Local'>segchar</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now we should be at the end. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2865"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="fd.c.html#LN2867"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end looks_like_temp_rel_name &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Issue fsync recursively on PGDATA and all its contents. 
 * 
 * We fsync regular files and directories wherever they are, but we 
 * follow symlinks only for pg_wal and immediately under pg_tblspc. 
 * Other symlinks are presumed to point at files we're not responsible 
 * for fsyncing, and might not have privileges to write at all. 
 * 
 * Errors are logged but not considered fatal; that's because this is used 
 * only during database startup, to deal with the possibility that there are 
 * issued-but-unsynced writes pending against the data directory.  We want to 
 * ensure that such writes reach disk before anything that's done in the new 
 * run.  However, aborting on error would result in failure to start for 
 * harmless cases such as read-only files in the data directory, and that's 
 * not good either. 
 * 
 * Note we assume we're chdir'd into PGDATA to begin with. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2932"></a><span class='Declare_Function'>SyncDataDirectory</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2934"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>xlog_is_symlink</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can skip this whole thing if fsync is disabled. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If pg_wal is a symlink, we'll need to recurse into it separately, 
     * because the first walkdir below will ignore it. 
     */ 
</span>    <a href="fd.c.html#LN2934"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Delimiter'>{ 
</span><a name="LN2948"></a>        <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><span class='String'>"pg_wal"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN2948"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <span class='String'>"pg_wal"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>S_ISLNK<span class='Parentheses'>(</span><a href="fd.c.html#LN2948"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <a href="fd.c.html#LN2934"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN253"><span class='Ref_to_Proto'>pgwin32_is_junction</span></a><span class='Parentheses'>(</span><span class='String'>"pg_wal"</span><span class='Parentheses'>))</span> 
        <a href="fd.c.html#LN2934"><span class='Ref_To_Local'>xlog_is_symlink</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If possible, hint to the kernel that we're soon going to fsync the data 
     * directory and its contents.  Errors in this step are even less 
     * interesting than normal, so log them only at DEBUG1. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../common/file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
    <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><a href="../../../common/file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2934"><span class='Ref_To_Local'>xlog_is_symlink</span></a><span class='Parentheses'>) 
</span>        <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_wal"</span><span class='Delimiter'>, </span><a href="../../../common/file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc"</span><span class='Delimiter'>, </span><a href="../../../common/file_utils.c.html#LN37"><span class='Ref_to_Proto'>pre_sync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now we do the fsync()s in the same order. 
     * 
     * The main call ignores symlinks, so in addition to specially processing 
     * pg_wal if it's a symlink, pg_tblspc has to be visited separately with 
     * process_symlinks = true.  Note that if there are any plain directories 
     * in pg_tblspc, they'll get fsync'd twice.  That's not an expected case 
     * so we don't worry about optimizing it. 
     */ 
</span>    <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"."</span><span class='Delimiter'>, </span><a href="fd.c.html#LN322"><span class='Ref_to_Proto'>datadir_fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN2934"><span class='Ref_To_Local'>xlog_is_symlink</span></a><span class='Parentheses'>) 
</span>        <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_wal"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN322"><span class='Ref_to_Proto'>datadir_fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN322"><span class='Ref_to_Proto'>datadir_fsync_fname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SyncDataDirectory &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * walkdir: recursively walk a directory, applying the action to each 
 * regular file and directory (including the named directory itself). 
 * 
 * If process_symlinks is true, the action and recursion are also applied 
 * to regular files and directories that are pointed to by symlinks in the 
 * given directory; otherwise symlinks are ignored.  Symlinks are always 
 * ignored in subdirectories, ie we intentionally don't pass down the 
 * process_symlinks flag to recursive calls. 
 * 
 * Errors are reported at level elevel, which might be ERROR or less. 
 * 
 * See also walkdir in initdb.c, which is a frontend version of this logic. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3005"></a><span class='Declare_Function'>walkdir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, 
</span><a name="LN3006"></a>        <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) (</span><span class='Keyword'>const char </span><span class='Operator'>*</span>fname<span class='Delimiter'>, </span><span class='Keyword'>bool </span>isdir<span class='Delimiter'>, </span><span class='Keyword'>int </span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span><a name="LN3007"></a>        <span class='Keyword'>bool </span><span class='Declare_Parameter'>process_symlinks</span><span class='Delimiter'>, 
</span><a name="LN3008"></a>        <span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>)</span> 
<span class='Delimiter'>{ 
</span><a name="LN3010"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN3011"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN3010"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3005"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3010"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3005"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="fd.c.html#LN3011"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="fd.c.html#LN306"><span class='Ref_to_Proto'>ReadDirExtended</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3010"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3005"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3024"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>subpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN3025"></a>        <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>fst</span><span class='Delimiter'>; 
</span><a name="LN3026"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>sret</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN3011"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="fd.c.html#LN3011"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3005"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3011"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3007"><span class='Ref_to_Parameter'>process_symlinks</span></a><span class='Parentheses'>) 
</span>            <a href="fd.c.html#LN3026"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN3025"><span class='Ref_To_Local'>fst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="fd.c.html#LN3026"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32.h.html#LN261"><span class='Ref_to_Macro'>lstat</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fd.c.html#LN3025"><span class='Ref_To_Local'>fst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3026"><span class='Ref_To_Local'>sret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN430"><span class='Ref_to_Macro'>S_ISREG</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3025"><span class='Ref_To_Local'>fst</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fd.c.html#LN3006"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) (</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3025"><span class='Ref_To_Local'>fst</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>))</span> 
            <a href="../../../common/file_utils.c.html#LN40"><span class='Ref_to_Proto'>walkdir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3024"><span class='Ref_To_Local'>subpath</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3006"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDirExtended(d... &raquo; </span> 
 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3010"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* we ignore any error here */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's important to fsync the destination directory itself as individual 
     * file fsyncs don't guarantee that the directory entry for the file is 
     * synced. 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fd.c.html#LN3006"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) (</span><a href="fd.c.html#LN3005"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3008"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end walkdir &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Hint to the OS that it should get ready to fsync() this file. 
 * 
 * Ignores errors trying to open unreadable files, and logs other errors at a 
 * caller-specified level. 
 */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../common/file_utils.c.html#LN26"><span class='Ref_to_Const'>PG_FLUSH_DATA_WORKS</span></a> 
 
<span class='Keyword'>static void 
</span><a name="LN3075"></a><span class='Declare_Function'>pre_sync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3077"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't try to flush directories, it'll likely just fail */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3075"><span class='Ref_to_Parameter'>isdir</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN3077"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fd.c.html#LN3075"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3077"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EACCES<span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3075"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3075"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * pg_flush_data() ignores errors, which is ok because this is only a 
     * hint. 
     */ 
</span>    <a href="../../../include/storage/fd.h.html#LN118"><span class='Ref_to_Proto'>pg_flush_data</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3077"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3077"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pre_sync_fname &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* PG_FLUSH_DATA_WORKS */ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN3107"></a><span class='Declare_Function'>datadir_fsync_fname</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We want to silently ignoring errors about unreadable files.  Pass that 
     * desire on to fsync_fname_ext(). 
     */ 
</span>    <a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3107"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3107"><span class='Ref_to_Parameter'>isdir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3107"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * fsync_fname_ext -- Try to fsync a file or directory 
 * 
 * If ignore_perm is true, ignore errors upon trying to open unreadable 
 * files. Logs other errors at a caller-specified level. 
 * 
 * Returns 0 if the operation succeeded, -1 otherwise. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN3125"></a><span class='Declare_Function'>fsync_fname_ext</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isdir</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>ignore_perm</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3127"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN3128"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span><span class='Delimiter'>; 
</span><a name="LN3129"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returncode</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some OSs require directories to be opened read-only whereas other 
     * systems don't allow us to fsync files opened read-only; so we need both 
     * cases here.  Using O_RDWR will cause us to fail to fsync files that are 
     * not writable by our userid, but we assume that's OK. 
     */ 
</span>    <a href="fd.c.html#LN3128"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>isdir</span></a><span class='Parentheses'>) 
</span>        <a href="fd.c.html#LN3128"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>O_RDWR<span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="fd.c.html#LN3128"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>O_RDONLY<span class='Delimiter'>; 
</span> 
    <a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3128"><span class='Ref_To_Local'>flags</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some OSs don't allow us to open directories at all (Windows returns 
     * EACCES), just ignore the error in that case.  If desired also silently 
     * ignoring errors about unreadable files. Log others. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>isdir</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span>errno <span class='Operator'>== </span>EISDIR <span class='Operator'>|| </span>errno <span class='Operator'>== </span>EACCES<span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>ignore_perm</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>EACCES<span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="fd.c.html#LN3129"><span class='Ref_To_Local'>returncode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Some OSes don't allow us to fsync directories at all, so we can ignore 
     * those errors. Anything else needs to be logged. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN3129"><span class='Ref_To_Local'>returncode</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& !</span><span class='Parentheses'>(</span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>isdir</span></a> <span class='Operator'>&& </span>errno <span class='Operator'>== </span>EBADF<span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3170"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* close file upon error, might not be in transaction context */ 
</span>        <a href="fd.c.html#LN3170"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="fd.c.html#LN3170"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>elevel</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3125"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3127"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsync_fname_ext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * fsync_parent_path -- fsync the parent path of a file or directory 
 * 
 * This is aimed at making file operations persistent on disk in case of 
 * an OS crash or power failure. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN3195"></a><span class='Declare_Function'>fsync_parent_path</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>elevel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3197"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>parentpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3197"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><a href="fd.c.html#LN3195"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/port.h.html#LN62"><span class='Ref_to_Proto'>get_parent_directory</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3197"><span class='Ref_To_Local'>parentpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * get_parent_directory() returns an empty string if the input argument is 
     * just a file name (see comments in path.c), so handle that as being the 
     * current directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="fd.c.html#LN3197"><span class='Ref_To_Local'>parentpath</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3197"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Delimiter'>, </span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fd.c.html#LN324"><span class='Ref_to_Proto'>fsync_fname_ext</span></a><span class='Parentheses'>(</span><a href="fd.c.html#LN3197"><span class='Ref_To_Local'>parentpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="fd.c.html#LN3195"><span class='Ref_to_Parameter'>elevel</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsync_parent_path &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>