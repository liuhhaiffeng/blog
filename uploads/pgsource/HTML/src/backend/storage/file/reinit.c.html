<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\file\reinit.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\file\reinit.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * reinit.c 
 *    Reinitialization of unlogged relations 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/file/reinit.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/relpath.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/copydir.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/reinit.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
<a name="LN26"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ResetUnloggedRelationsInTablespaceDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tsdirname</span><span class='Delimiter'>, 
</span><a name="LN27"></a>                                      <span class='Keyword'>int </span><span class='Declare_Parameter'>op</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN28"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ResetUnloggedRelationsInDbspaceDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbspacedirname</span><span class='Delimiter'>, 
</span><a name="LN29"></a>                                   <span class='Keyword'>int </span><span class='Declare_Parameter'>op</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN30"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>parse_filename_for_nontemp_relation</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, 
</span><a name="LN31"></a>                                    <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>oidchars</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fork</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN35"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>oid</span><span class='Delimiter'>[</span><a href="../../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN36"></a>} <span class='Declare_Typedef'>unlogged_relation_entry</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Reset unlogged relations from before the last restart. 
 * 
 * If op includes UNLOGGED_RELATION_CLEANUP, we remove all forks of any 
 * relation with an "init" fork, except for the "init" fork itself. 
 * 
 * If op includes UNLOGGED_RELATION_INIT, we copy the "init" fork to the main 
 * fork. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN48"></a><span class='Declare_Function'>ResetUnloggedRelations</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>op</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN50"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>temp_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Number'>10</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]; 
</span><a name="LN51"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>spc_dir</span><span class='Delimiter'>; 
</span><a name="LN52"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>spc_de</span><span class='Delimiter'>; 
</span><a name="LN53"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpctx</span><span class='Delimiter'>, 
</span><a name="LN54"></a>                <span class='Declare_Local'>oldctx</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Log it. */ 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"resetting unlogged relations: cleanup %d init %d"</span><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="reinit.c.html#LN48"><span class='Ref_to_Parameter'>op</span></a> <span class='Operator'>& </span><a href="../../../include/storage/reinit.h.html#LN19"><span class='Ref_to_Const'>UNLOGGED_RELATION_CLEANUP</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="reinit.c.html#LN48"><span class='Ref_to_Parameter'>op</span></a> <span class='Operator'>& </span><a href="../../../include/storage/reinit.h.html#LN20"><span class='Ref_to_Const'>UNLOGGED_RELATION_INIT</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Just to be sure we don't leak any memory, let's create a temporary 
     * memory context for this operation. 
     */ 
</span>    <a href="reinit.c.html#LN53"><span class='Ref_To_Local'>tmpctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"ResetUnloggedRelations"</span><span class='Delimiter'>, 
</span>                                   <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="reinit.c.html#LN54"><span class='Ref_To_Local'>oldctx</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN53"><span class='Ref_To_Local'>tmpctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First process unlogged files in pg_default ($PGDATA/base) 
     */ 
</span>    <a href="reinit.c.html#LN26"><span class='Ref_to_Proto'>ResetUnloggedRelationsInTablespaceDir</span></a><span class='Parentheses'>(</span><span class='String'>"base"</span><span class='Delimiter'>, </span><a href="reinit.c.html#LN48"><span class='Ref_to_Parameter'>op</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Cycle through directories for all non-default tablespaces. 
     */ 
</span>    <a href="reinit.c.html#LN51"><span class='Ref_To_Local'>spc_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN52"><span class='Ref_To_Local'>spc_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN51"><span class='Ref_To_Local'>spc_dir</span></a><span class='Delimiter'>, </span><span class='String'>"pg_tblspc"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="reinit.c.html#LN52"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="reinit.c.html#LN52"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN50"><span class='Ref_To_Local'>temp_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN50"><span class='Ref_To_Local'>temp_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"pg_tblspc/%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN52"><span class='Ref_To_Local'>spc_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/catalog.h.html#LN25"><span class='Ref_to_Const'>TABLESPACE_VERSION_DIRECTORY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN26"><span class='Ref_to_Proto'>ResetUnloggedRelationsInTablespaceDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN50"><span class='Ref_To_Local'>temp_path</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN48"><span class='Ref_to_Parameter'>op</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN51"><span class='Ref_To_Local'>spc_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Restore memory context. 
     */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN54"><span class='Ref_To_Local'>oldctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN53"><span class='Ref_To_Local'>tmpctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ResetUnloggedRelations &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one tablespace directory for ResetUnloggedRelations */ 
</span><span class='Keyword'>static void 
</span><a name="LN102"></a><span class='Declare_Function'>ResetUnloggedRelationsInTablespaceDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tsdirname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>op</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN104"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>ts_dir</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>dbspace_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <a href="reinit.c.html#LN104"><span class='Ref_To_Local'>ts_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN102"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN104"><span class='Ref_To_Local'>ts_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* anything except ENOENT is fishy */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open tablespace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN102"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN105"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN104"><span class='Ref_To_Local'>ts_dir</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN102"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN121"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We're only interested in the per-database directories, which have 
         * numeric names.  Note that this code will also (properly) ignore "." 
         * and "..". 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="reinit.c.html#LN105"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN121"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Operator'>++</span><a href="reinit.c.html#LN121"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN105"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN121"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>|| </span><a href="reinit.c.html#LN121"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN106"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN106"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN102"><span class='Ref_to_Parameter'>tsdirname</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN105"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN28"><span class='Ref_to_Proto'>ResetUnloggedRelationsInDbspaceDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN106"><span class='Ref_To_Local'>dbspace_path</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN102"><span class='Ref_to_Parameter'>op</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN104"><span class='Ref_To_Local'>ts_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ResetUnloggedRelationsInTablespaceDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Process one per-dbspace directory for ResetUnloggedRelations */ 
</span><span class='Keyword'>static void 
</span><a name="LN143"></a><span class='Declare_Function'>ResetUnloggedRelationsInDbspaceDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dbspacedirname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>op</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN145"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dbspace_dir</span><span class='Delimiter'>; 
</span><a name="LN146"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>de</span><span class='Delimiter'>; 
</span><a name="LN147"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>rm_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Caller must specify at least one operation. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>op</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/reinit.h.html#LN19"><span class='Ref_to_Const'>UNLOGGED_RELATION_CLEANUP</span></a> <span class='Operator'>| </span><a href="../../../include/storage/reinit.h.html#LN20"><span class='Ref_to_Const'>UNLOGGED_RELATION_INIT</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Cleanup is a two-pass operation.  First, we go through and identify all 
     * the files with init forks.  Then, we go through again and nuke 
     * everything with the same OID except the init fork. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>op</span></a> <span class='Operator'>& </span><a href="../../../include/storage/reinit.h.html#LN19"><span class='Ref_to_Const'>UNLOGGED_RELATION_CLEANUP</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN159"></a>        <a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>hash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN160"></a>        <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Open the directory. */ 
</span>        <a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open dbspace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It's possible that someone could create a ton of unlogged relations 
         * in the same database & tablespace, so we'd better use a hash table 
         * rather than an array or linked list to keep track of which files 
         * need to be reset.  Otherwise, this cleanup operation would be 
         * O(n^2). 
         */ 
</span>        <a href="reinit.c.html#LN160"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN33"><span class='Ref_to_Typedef'>unlogged_relation_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN160"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN33"><span class='Ref_to_Typedef'>unlogged_relation_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"unlogged hash"</span><span class='Delimiter'>, </span><span class='Number'>32</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN160"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan the directory. */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN186"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forkNum</span><span class='Delimiter'>; 
</span><a name="LN187"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>oidchars</span><span class='Delimiter'>; 
</span><a name="LN188"></a>            <a href="reinit.c.html#LN33"><span class='Ref_to_Typedef'>unlogged_relation_entry</span></a> <span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip anything that doesn't look like a relation data file. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reinit.c.html#LN30"><span class='Ref_to_Proto'>parse_filename_for_nontemp_relation</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN187"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="reinit.c.html#LN186"><span class='Ref_To_Local'>forkNum</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Also skip it unless this is the init fork. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN186"><span class='Ref_To_Local'>forkNum</span></a> <span class='Operator'>!= </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Put the OID portion of the name into the hash table, if it 
             * isn't already. 
             */ 
</span>            memset<span class='Parentheses'>(</span><a href="reinit.c.html#LN188"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN188"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="reinit.c.html#LN188"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN187"><span class='Ref_To_Local'>oidchars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN188"><span class='Ref_To_Local'>ent</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dbspace_d... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Done with the first pass. */ 
</span>        <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we didn't find any init forks, there's no point in continuing; 
         * we can bail out now. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now, make a second pass and remove anything that matches. First, 
         * reopen the directory. 
         */ 
</span>        <a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open dbspace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Scan the directory. */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN238"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forkNum</span><span class='Delimiter'>; 
</span><a name="LN239"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>oidchars</span><span class='Delimiter'>; 
</span><a name="LN240"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN241"></a>            <a href="reinit.c.html#LN33"><span class='Ref_to_Typedef'>unlogged_relation_entry</span></a> <span class='Declare_Local'>ent</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip anything that doesn't look like a relation data file. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reinit.c.html#LN30"><span class='Ref_to_Proto'>parse_filename_for_nontemp_relation</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN239"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="reinit.c.html#LN238"><span class='Ref_To_Local'>forkNum</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* We never remove the init fork. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN238"><span class='Ref_To_Local'>forkNum</span></a> <span class='Operator'>== </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * See whether the OID portion of the name shows up in the hash 
             * table. 
             */ 
</span>            memset<span class='Parentheses'>(</span><a href="reinit.c.html#LN241"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN241"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="reinit.c.html#LN241"><span class='Ref_To_Local'>ent</span></a><span class='Operator'>.</span><a href="reinit.c.html#LN35"><span class='Ref_to_Member'>oid</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN239"><span class='Ref_To_Local'>oidchars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN241"><span class='Ref_To_Local'>ent</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN240"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If so, nuke it! */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN240"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN147"><span class='Ref_To_Local'>rm_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN147"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                         <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * It's tempting to actually throw an error here, but since 
                 * this code gets run during database startup, that could 
                 * result in the database failing to start.  (XXX Should we do 
                 * it anyway?) 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN147"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not unlink file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="reinit.c.html#LN147"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"unlinked file \"%s\""</span><span class='Delimiter'>, </span><a href="reinit.c.html#LN147"><span class='Ref_To_Local'>rm_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dbspace_d... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Cleanup is complete. */ 
</span>        <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN159"><span class='Ref_To_Local'>hash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (op&UNLOGGED_RELATION... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Initialization happens after cleanup is complete: we copy each init 
     * fork file to the corresponding main fork file.  Note that if we are 
     * asked to do both cleanup and init, we may never get here: if the 
     * cleanup code determines that there are no init forks in this dbspace, 
     * it will return before we get to this point. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>op</span></a> <span class='Operator'>& </span><a href="../../../include/storage/reinit.h.html#LN20"><span class='Ref_to_Const'>UNLOGGED_RELATION_INIT</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Open the directory. */ 
</span>        <a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we just saw this directory, so it really ought to be there */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open dbspace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Scan the directory. */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN307"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forkNum</span><span class='Delimiter'>; 
</span><a name="LN308"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>oidchars</span><span class='Delimiter'>; 
</span><a name="LN309"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>oidbuf</span><span class='Delimiter'>[</span><a href="../../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN310"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>srcpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN311"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>dstpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip anything that doesn't look like a relation data file. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reinit.c.html#LN30"><span class='Ref_to_Proto'>parse_filename_for_nontemp_relation</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN308"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="reinit.c.html#LN307"><span class='Ref_To_Local'>forkNum</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Also skip it unless this is the init fork. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN307"><span class='Ref_To_Local'>forkNum</span></a> <span class='Operator'>!= </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Construct source pathname. */ 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN310"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN310"><span class='Ref_To_Local'>srcpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>                     <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Construct destination pathname. */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="reinit.c.html#LN309"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN308"><span class='Ref_To_Local'>oidchars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reinit.c.html#LN309"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN308"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN311"><span class='Ref_To_Local'>dstpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN311"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s"</span><span class='Delimiter'>, 
</span>                     <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN309"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><a href="reinit.c.html#LN308"><span class='Ref_To_Local'>oidchars</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ 
</span>                     strlen<span class='Parentheses'>(</span><a href="../../../common/relpath.c.html#LN33"><span class='Ref_to_Global_Var'>forkNames</span></a><span class='Delimiter'>[</span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* OK, we're ready to perform the actual copy. */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN23"><span class='Ref_to_Const'>DEBUG2</span></a><span class='Delimiter'>, </span><span class='String'>"copying %s to %s"</span><span class='Delimiter'>, </span><a href="reinit.c.html#LN310"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN311"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/copydir.h.html#LN16"><span class='Ref_to_Proto'>copy_file</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN310"><span class='Ref_To_Local'>srcpath</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN311"><span class='Ref_To_Local'>dstpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dbspace_d... &raquo; </span> 
 
        <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * copy_file() above has already called pg_flush_data() on the files 
         * it created. Now we need to fsync those files, because a checkpoint 
         * won't do it for us while we're in recovery. We do this in a 
         * separate pass to allow the kernel to perform all the flushes 
         * (especially the metadata ones) at once. 
         */ 
</span>        <a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we just saw this directory, so it really ought to be there */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"could not open dbspace directory \"%s\": %m"</span><span class='Delimiter'>, 
</span>                 <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN359"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forkNum</span><span class='Delimiter'>; 
</span><a name="LN360"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>oidchars</span><span class='Delimiter'>; 
</span><a name="LN361"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>oidbuf</span><span class='Delimiter'>[</span><a href="../../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN362"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>mainpath</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip anything that doesn't look like a relation data file. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="reinit.c.html#LN30"><span class='Ref_to_Proto'>parse_filename_for_nontemp_relation</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="reinit.c.html#LN360"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="reinit.c.html#LN359"><span class='Ref_To_Local'>forkNum</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Also skip it unless this is the init fork. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN359"><span class='Ref_To_Local'>forkNum</span></a> <span class='Operator'>!= </span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Construct main fork pathname. */ 
</span>            memcpy<span class='Parentheses'>(</span><a href="reinit.c.html#LN361"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN360"><span class='Ref_To_Local'>oidchars</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="reinit.c.html#LN361"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN360"><span class='Ref_To_Local'>oidchars</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN362"><span class='Ref_To_Local'>mainpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="reinit.c.html#LN362"><span class='Ref_To_Local'>mainpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s%s"</span><span class='Delimiter'>, 
</span>                     <a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN361"><span class='Ref_To_Local'>oidbuf</span></a><span class='Delimiter'>, </span><a href="reinit.c.html#LN146"><span class='Ref_To_Local'>de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a> <span class='Operator'>+ </span><a href="reinit.c.html#LN360"><span class='Ref_To_Local'>oidchars</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ 
</span>                     strlen<span class='Parentheses'>(</span><a href="../../../common/relpath.c.html#LN33"><span class='Ref_to_Global_Var'>forkNames</span></a><span class='Delimiter'>[</span><a href="../../../include/common/relpath.h.html#LN29"><span class='Ref_to_EnumConst'>INIT_FORKNUM</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN362"><span class='Ref_To_Local'>mainpath</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (de=ReadDir(dbspace_d... &raquo; </span> 
 
        <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN145"><span class='Ref_To_Local'>dbspace_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="reinit.c.html#LN143"><span class='Ref_to_Parameter'>dbspacedirname</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (op&UNLOGGED_RELATION... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ResetUnloggedRelationsInDbspaceDir &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Basic parsing of putative relation filenames. 
 * 
 * This function returns true if the file appears to be in the correct format 
 * for a non-temporary relation and false otherwise. 
 * 
 * NB: If this function returns true, the caller is entitled to assume that 
 * *oidchars has been set to the a value no more than OIDCHARS, and thus 
 * that a buffer of OIDCHARS+1 characters is sufficient to hold the OID 
 * portion of the filename.  This is critical to protect against a possible 
 * buffer overrun. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN402"></a><span class='Declare_Function'>parse_filename_for_nontemp_relation</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>oidchars</span><span class='Delimiter'>, 
</span><a name="LN403"></a>                                    <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fork</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN405"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pos</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look for a non-empty string of digits (that isn't too long). */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>&GT; </span><a href="../../../include/catalog/catalog.h.html#LN24"><span class='Ref_to_Const'>OIDCHARS</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>oidchars</span></a> <span class='Operator'>= </span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for a fork name. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'_'</span><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="reinit.c.html#LN403"><span class='Ref_to_Parameter'>fork</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN419"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>forkchar</span><span class='Delimiter'>; 
</span> 
        <a href="reinit.c.html#LN419"><span class='Ref_To_Local'>forkchar</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN45"><span class='Ref_to_Proto'>forkname_chars</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="reinit.c.html#LN403"><span class='Ref_to_Parameter'>fork</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN419"><span class='Ref_To_Local'>forkchar</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="reinit.c.html#LN419"><span class='Ref_To_Local'>forkchar</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Check for a segment number. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'.'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN430"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>segchar</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN430"><span class='Ref_To_Local'>segchar</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span>isdigit<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+ </span><a href="reinit.c.html#LN430"><span class='Ref_To_Local'>segchar</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="reinit.c.html#LN430"><span class='Ref_To_Local'>segchar</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN430"><span class='Ref_To_Local'>segchar</span></a> <span class='Operator'>&LT;= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="reinit.c.html#LN430"><span class='Ref_To_Local'>segchar</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now we should be at the end. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="reinit.c.html#LN402"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><a href="reinit.c.html#LN405"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parse_filename_for_nontemp_relation &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>