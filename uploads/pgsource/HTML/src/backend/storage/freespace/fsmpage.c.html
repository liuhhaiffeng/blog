<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\freespace\fsmpage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\freespace\fsmpage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * fsmpage.c 
 *    routines to search and manipulate one FSM page. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/freespace/fsmpage.c 
 * 
 * NOTES: 
 * 
 *  The public functions in this file form an API that hides the internal 
 *  structure of a FSM page. This allows freespace.c to treat each FSM page 
 *  as a black box with SlotsPerPage "slots". fsm_set_avail() and 
 *  fsm_get_avail() let you get/set the value of a slot, and 
 *  fsm_search_avail() lets you search for a slot with value &GT;= X. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fsm_internals.h"</span> 
 
<span class='Comment_Multi_Line'>/* Macros to navigate the tree within a page. Root has index zero. */ 
</span><a name="LN28"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>leftchild</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>    <span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN28"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<a name="LN29"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>rightchild</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>   <span class='Parentheses'>(</span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN29"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
<a name="LN30"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>parentof</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Parentheses'>)</span>     <span class='Parentheses'>(((</span><a href="fsmpage.c.html#LN30"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find right neighbor of x, wrapping around within the level 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN36"></a><span class='Declare_Function'>rightneighbor</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>x</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Move right. This might wrap around, stepping to the leftmost node at 
     * the next level. 
     */ 
</span>    <a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check if we stepped to the leftmost node at next level, and correct if 
     * so. The leftmost nodes at each level are numbered x = 2^level - 1, so 
     * check if (x + 1) is a power of two, using a standard 
     * twos-complement-arithmetic trick. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN30"><span class='Ref_to_Macro'>parentof</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN36"><span class='Ref_to_Parameter'>x</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end rightneighbor &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Sets the value of a slot on page. Returns true if the page was modified. 
 * 
 * The caller must hold an exclusive lock on the page. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN62"></a><span class='Declare_Function'>fsm_set_avail</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>slot</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>value</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN64"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nodeno</span> <span class='Operator'>= </span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a> <span class='Operator'>+ </span><a href="fsmpage.c.html#LN62"><span class='Ref_to_Parameter'>slot</span></a><span class='Delimiter'>; 
</span><a name="LN65"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN62"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN66"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>oldvalue</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN62"><span class='Ref_to_Parameter'>slot</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN54"><span class='Ref_to_Const'>LeafNodesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="fsmpage.c.html#LN66"><span class='Ref_To_Local'>oldvalue</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* If the value hasn't changed, we don't need to do anything */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN66"><span class='Ref_To_Local'>oldvalue</span></a> <span class='Operator'>== </span><span class='Keyword'>value </span><span class='Operator'>&& </span><span class='Keyword'>value </span><span class='Operator'>&LT;= </span><a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Keyword'>value</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Propagate up, until we hit the root or a node that doesn't need to be 
     * updated. 
     */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN84"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>newvalue</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN85"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>lchild</span><span class='Delimiter'>; 
</span><a name="LN86"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rchild</span><span class='Delimiter'>; 
</span> 
        <a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN30"><span class='Ref_to_Macro'>parentof</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fsmpage.c.html#LN85"><span class='Ref_To_Local'>lchild</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN28"><span class='Ref_to_Macro'>leftchild</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="fsmpage.c.html#LN86"><span class='Ref_To_Local'>rchild</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN85"><span class='Ref_To_Local'>lchild</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="fsmpage.c.html#LN84"><span class='Ref_To_Local'>newvalue</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN85"><span class='Ref_To_Local'>lchild</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN86"><span class='Ref_To_Local'>rchild</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a><span class='Parentheses'>) 
</span>            <a href="fsmpage.c.html#LN84"><span class='Ref_To_Local'>newvalue</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN84"><span class='Ref_To_Local'>newvalue</span></a><span class='Delimiter'>, 
</span>                           <a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN86"><span class='Ref_To_Local'>rchild</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="fsmpage.c.html#LN66"><span class='Ref_To_Local'>oldvalue</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN66"><span class='Ref_To_Local'>oldvalue</span></a> <span class='Operator'>== </span><a href="fsmpage.c.html#LN84"><span class='Ref_To_Local'>newvalue</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="fsmpage.c.html#LN84"><span class='Ref_To_Local'>newvalue</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN64"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * sanity check: if the new value is (still) higher than the value at the 
     * top, the tree is corrupt.  If so, rebuild. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>value </span><span class='Operator'>&GT; </span><a href="fsmpage.c.html#LN65"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/fsm_internals.h.html#LN69"><span class='Ref_to_Proto'>fsm_rebuild_page</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN62"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsm_set_avail &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns the value of given slot on page. 
 * 
 * Since this is just a read-only access of a single byte, the page doesn't 
 * need to be locked. 
 */ 
</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> 
<a name="LN121"></a><span class='Declare_Function'>fsm_get_avail</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>slot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN123"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN121"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN121"><span class='Ref_to_Parameter'>slot</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN54"><span class='Ref_to_Const'>LeafNodesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN123"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a> <span class='Operator'>+ </span><a href="fsmpage.c.html#LN121"><span class='Ref_to_Parameter'>slot</span></a><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Returns the value at the root of a page. 
 * 
 * Since this is just a read-only access of a single byte, the page doesn't 
 * need to be locked. 
 */ 
</span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> 
<a name="LN137"></a><span class='Declare_Function'>fsm_get_max_avail</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN137"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN139"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Searches for a slot with category at least minvalue. 
 * Returns slot number, or -1 if none found. 
 * 
 * The caller must hold at least a shared lock on the page, and this 
 * function can unlock and lock the page again in exclusive mode if it 
 * needs to be updated. exclusive_lock_held should be set to true if the 
 * caller is already holding an exclusive lock, to avoid extra work. 
 * 
 * If advancenext is false, fp_next_slot is set to point to the returned 
 * slot, and if it's true, to the slot after the returned slot. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN157"></a><span class='Declare_Function'>fsm_search_avail</span><span class='Parentheses'>(</span><a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a> <span class='Declare_Parameter'>minvalue</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>advancenext</span><span class='Delimiter'>, 
</span><a name="LN158"></a>                 <span class='Keyword'>bool </span><span class='Declare_Parameter'>exclusive_lock_held</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN160"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>page</span> <span class='Operator'>= </span><a href="../../../include/storage/bufmgr.h.html#LN159"><span class='Ref_to_Macro'>BufferGetPage</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN161"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN160"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN162"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nodeno</span><span class='Delimiter'>; 
</span><a name="LN163"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>target</span><span class='Delimiter'>; 
</span><a name="LN164"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span> 
<a name="LN166"></a><span class='Label'>restart</span><span class='Operator'>: 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check the root first, and exit quickly if there's no leaf with enough 
     * free space 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>minvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start search using fp_next_slot.  It's just a hint, so check that it's 
     * sane.  (This also handles wrapping around when the prior call returned 
     * the last slot on the page.) 
     */ 
</span>    <a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN34"><span class='Ref_to_Member'>fp_next_slot</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/fsm_internals.h.html#LN54"><span class='Ref_to_Const'>LeafNodesPerPage</span></a><span class='Parentheses'>) 
</span>        <a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a> <span class='Operator'>+= </span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Start the search from the target slot.  At every step, move one 
     * node to the right, then climb up to the parent.  Stop when we reach 
     * a node with enough free space (as we must, since the root has enough 
     * space). 
     * 
     * The idea is to gradually expand our "search triangle", that is, all 
     * nodes covered by the current node, and to be sure we search to the 
     * right from the start point.  At the first step, only the target slot 
     * is examined.  When we move up from a left child to its parent, we are 
     * adding the right-hand subtree of that parent to the search triangle. 
     * When we move right then up from a right child, we are dropping the 
     * current search triangle (which we know doesn't contain any suitable 
     * page) and instead looking at the next-larger-size triangle to its 
     * right.  So we never look left from our original start point, and at 
     * each step the size of the search triangle doubles, ensuring it takes 
     * only log2(N) work to search N pages. 
     * 
     * The "move right" operation will wrap around if it hits the right edge 
     * of the tree, so the behavior is still good if we start near the right. 
     * Note also that the move-and-climb behavior ensures that we can't end 
     * up on one of the missing nodes at the right of the leaf level. 
     * 
     * For example, consider this tree: 
     * 
     *         7 
     *     7       6 
     *   5   7   6   5 
     *  4 5 5 7 2 6 5 2 
     *              T 
     * 
     * Assume that the target node is the node indicated by the letter T, 
     * and we're searching for a node with value of 6 or higher. The search 
     * begins at T. At the first iteration, we move to the right, then to the 
     * parent, arriving at the rightmost 5. At the second iteration, we move 
     * to the right, wrapping around, then climb up, arriving at the 7 on the 
     * third level.  7 satisfies our search, so we descend down to the bottom, 
     * following the path of sevens.  This is in fact the first suitable page 
     * to the right of (allowing for wraparound) our start point. 
     *---------- 
     */ 
</span>    <a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN163"><span class='Ref_To_Local'>target</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>minvalue</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Move to the right, wrapping around on same level if necessary, then 
         * climb up. 
         */ 
</span>        <a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN30"><span class='Ref_to_Macro'>parentof</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN35"><span class='Ref_to_Func'>rightneighbor</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We're now at a node with enough free space, somewhere in the middle of 
     * the tree. Descend to the bottom, following a path with enough free 
     * space, preferring to move left if there's a choice. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN246"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>childnodeno</span> <span class='Operator'>= </span><a href="fsmpage.c.html#LN28"><span class='Ref_to_Macro'>leftchild</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a> <span class='Operator'>&& 
</span>            <a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>minvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* point to right child */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a> <span class='Operator'>&& 
</span>            <a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>minvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN246"><span class='Ref_To_Local'>childnodeno</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Oops. The parent node promised that either left or right child 
             * has enough space, but neither actually did. This can happen in 
             * case of a "torn page", IOW if we crashed earlier while writing 
             * the page to disk, and only part of the page made it to disk. 
             * 
             * Fix the corruption and restart. 
             */ 
</span><a name="LN270"></a>            <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span><a name="LN271"></a>            <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forknum</span><span class='Delimiter'>; 
</span><a name="LN272"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>blknum</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/bufmgr.h.html#LN208"><span class='Ref_to_Proto'>BufferGetTag</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fsmpage.c.html#LN270"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fsmpage.c.html#LN271"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="fsmpage.c.html#LN272"><span class='Ref_To_Local'>blknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"fixing corrupt FSM block %u, relation %u/%u/%u"</span><span class='Delimiter'>, 
</span>                 <a href="fsmpage.c.html#LN272"><span class='Ref_To_Local'>blknum</span></a><span class='Delimiter'>, </span><a href="fsmpage.c.html#LN270"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, </span><a href="fsmpage.c.html#LN270"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, </span><a href="fsmpage.c.html#LN270"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* make sure we hold an exclusive lock */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="fsmpage.c.html#LN158"><span class='Ref_to_Parameter'>exclusive_lock_held</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN88"><span class='Ref_to_Const'>BUFFER_LOCK_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="fsmpage.c.html#LN158"><span class='Ref_to_Parameter'>exclusive_lock_held</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/storage/fsm_internals.h.html#LN69"><span class='Ref_to_Proto'>fsm_rebuild_page</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN160"><span class='Ref_To_Local'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/bufmgr.h.html#LN211"><span class='Ref_to_Proto'>MarkBufferDirtyHint</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="fsmpage.c.html#LN166"><span class='Ref_to_Label'>restart</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while nodeno&LT;NonLeafNodesPe... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* We're now at the bottom level, at a node with enough space. */ 
</span>    <a href="fsmpage.c.html#LN164"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN162"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>- </span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Update the next-target pointer. Note that we do this even if we're only 
     * holding a shared lock, on the grounds that it's better to use a shared 
     * lock and get a garbled next pointer every now and then, than take the 
     * concurrency hit of an exclusive lock. 
     * 
     * Wrap-around is handled at the beginning of this function. 
     */ 
</span>    <a href="fsmpage.c.html#LN161"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN34"><span class='Ref_to_Member'>fp_next_slot</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN164"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN157"><span class='Ref_to_Parameter'>advancenext</span></a> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN164"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsm_search_avail &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Sets the available space to zero for all slots numbered &GT;= nslots. 
 * Returns true if the page was modified. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN312"></a><span class='Declare_Function'>fsm_truncate_avail</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nslots</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN314"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN312"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN315"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span><a name="LN316"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>changed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN312"><span class='Ref_to_Parameter'>nslots</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="fsmpage.c.html#LN312"><span class='Ref_to_Parameter'>nslots</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN54"><span class='Ref_to_Const'>LeafNodesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clear all truncated leaf nodes */ 
</span>    <a href="fsmpage.c.html#LN315"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= &</span><a href="fsmpage.c.html#LN314"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a> <span class='Operator'>+ </span><a href="fsmpage.c.html#LN312"><span class='Ref_to_Parameter'>nslots</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="fsmpage.c.html#LN315"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>&LT; &</span><a href="fsmpage.c.html#LN314"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a><span class='Delimiter'>]; </span><a href="fsmpage.c.html#LN315"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="fsmpage.c.html#LN315"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="fsmpage.c.html#LN316"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="fsmpage.c.html#LN315"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Fix upper nodes. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN316"><span class='Ref_To_Local'>changed</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/fsm_internals.h.html#LN69"><span class='Ref_to_Proto'>fsm_rebuild_page</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN312"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN316"><span class='Ref_To_Local'>changed</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsm_truncate_avail &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Reconstructs the upper levels of a page. Returns true if the page 
 * was modified. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN341"></a><span class='Declare_Function'>fsm_rebuild_page</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN343"></a>    <a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a>     <span class='Declare_Local'>fsmpage</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/fsm_internals.h.html#LN44"><span class='Ref_to_Typedef'>FSMPage</span></a><span class='Parentheses'>) </span><a href="../../../include/storage/bufpage.h.html#LN242"><span class='Ref_to_Macro'>PageGetContents</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN341"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>changed</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN345"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nodeno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start from the lowest non-leaf level, at last node, working our way 
     * backwards, through all non-leaf nodes at all levels, up to the root. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fsm_internals.h.html#LN53"><span class='Ref_to_Const'>NonLeafNodesPerPage</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN353"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>lchild</span> <span class='Operator'>= </span><a href="fsmpage.c.html#LN28"><span class='Ref_to_Macro'>leftchild</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN354"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rchild</span> <span class='Operator'>= </span><a href="fsmpage.c.html#LN353"><span class='Ref_To_Local'>lchild</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN355"></a>        <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Local'>newvalue</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The first few nodes we examine might have zero or one child. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN353"><span class='Ref_To_Local'>lchild</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a><span class='Parentheses'>) 
</span>            <a href="fsmpage.c.html#LN355"><span class='Ref_To_Local'>newvalue</span></a> <span class='Operator'>= </span><a href="fsmpage.c.html#LN343"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN353"><span class='Ref_To_Local'>lchild</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN354"><span class='Ref_To_Local'>rchild</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/fsm_internals.h.html#LN50"><span class='Ref_to_Const'>NodesPerPage</span></a><span class='Parentheses'>) 
</span>            <a href="fsmpage.c.html#LN355"><span class='Ref_To_Local'>newvalue</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="fsmpage.c.html#LN355"><span class='Ref_To_Local'>newvalue</span></a><span class='Delimiter'>, 
</span>                           <a href="fsmpage.c.html#LN343"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN354"><span class='Ref_To_Local'>rchild</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="fsmpage.c.html#LN343"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="fsmpage.c.html#LN355"><span class='Ref_To_Local'>newvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="fsmpage.c.html#LN343"><span class='Ref_To_Local'>fsmpage</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/fsm_internals.h.html#LN41"><span class='Ref_to_Member'>fp_nodes</span></a><span class='Delimiter'>[</span><a href="fsmpage.c.html#LN345"><span class='Ref_To_Local'>nodeno</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="fsmpage.c.html#LN355"><span class='Ref_To_Local'>newvalue</span></a><span class='Delimiter'>; 
</span>            <a href="fsmpage.c.html#LN344"><span class='Ref_To_Local'>changed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for nodeno=NonLeafNodesPe... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="fsmpage.c.html#LN344"><span class='Ref_To_Local'>changed</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end fsm_rebuild_page &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>