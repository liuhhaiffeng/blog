<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\ipc\ipci.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\ipc\ipci.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * ipci.c 
 *    POSTGRES inter-process communication initialization code. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/ipc/ipci.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/clog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/commit_ts.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/multixact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/nbtree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/subtrans.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/async.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgworker_internals.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgwriter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/logicallauncher.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/slot.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walreceiver.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/walsender.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/origin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pmsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/backend_random.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
 
 
<a name="LN50"></a><a href="../../../include/storage/ipc.h.html#LN21"><span class='Ref_to_Typedef'>shmem_startup_hook_type</span></a> <span class='Declare_Var'>shmem_startup_hook</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN52"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Var'>total_addin_request</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN53"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>addin_request_allowed</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * RequestAddinShmemSpace 
 *      Request that extra shmem space be allocated for use by 
 *      a loadable module. 
 * 
 * This is only useful if called from the _PG_init hook of a library that 
 * is loaded into the postmaster via shared_preload_libraries.  Once 
 * shared memory has been allocated, calls will be ignored.  (We could 
 * raise an error, but it seems better to make it a no-op, so that 
 * libraries containing such calls can be reloaded if needed.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN68"></a><span class='Declare_Function'>RequestAddinShmemSpace</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>|| !</span><a href="ipci.c.html#LN53"><span class='Ref_to_Global_Var'>addin_request_allowed</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* too late */ 
</span>    <a href="ipci.c.html#LN52"><span class='Ref_to_Global_Var'>total_addin_request</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN52"><span class='Ref_to_Global_Var'>total_addin_request</span></a><span class='Delimiter'>, </span><a href="ipci.c.html#LN68"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CreateSharedMemoryAndSemaphores 
 *      Creates and initializes shared memory and semaphores. 
 * 
 * This is called by the postmaster or by a standalone backend. 
 * It is also called by a backend forked from the postmaster in the 
 * EXEC_BACKEND case.  In the latter case, the shared memory segment 
 * already exists and has been physically attached to, but we have to 
 * initialize pointers in local memory that reference the shared structures, 
 * because we didn't inherit the correct pointer values from the postmaster 
 * as we do in the fork() scenario.  The easiest way to do that is to run 
 * through the same code as before.  (Note that the called routines mostly 
 * check IsUnderPostmaster, rather than EXEC_BACKEND, to detect this case. 
 * This is a bit code-wasteful and could be cleaned up.) 
 * 
 * If "makePrivate" is true then we only need private memory, not shared 
 * memory.  This is true for a standalone backend, false for a postmaster. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN95"></a><span class='Declare_Function'>CreateSharedMemoryAndSemaphores</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>makePrivate</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>port</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN97"></a>    <a href="../../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>shim</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN101"></a>        <a href="../../../include/storage/pg_shmem.h.html#LN28"><span class='Ref_to_Struct'>PGShmemHeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>seghdr</span><span class='Delimiter'>; 
</span><a name="LN102"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN103"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>numSemas</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Compute number of semaphores we'll need */ 
</span>        <a href="ipci.c.html#LN103"><span class='Ref_To_Local'>numSemas</span></a> <span class='Operator'>= </span><a href="../lmgr/proc.c.html#LN126"><span class='Ref_to_Func'>ProcGlobalSemas</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN103"><span class='Ref_To_Local'>numSemas</span></a> <span class='Operator'>+= </span><a href="../lmgr/spin.c.html#LN48"><span class='Ref_to_Func'>SpinlockSemas</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Size of the Postgres shared-memory block is estimated via 
         * moderately-accurate estimates for the big hogs, plus 100K for the 
         * stuff that's too small to bother with estimating. 
         * 
         * We take some care during this phase to ensure that the total size 
         * request doesn't overflow size_t.  If this gets through, we don't 
         * need to be so careful during the actual allocation phase. 
         */ 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Number'>100000</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../port/win32_sema.c.html#LN29"><span class='Ref_to_Func'>PGSemaphoreShmemSize</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN103"><span class='Ref_To_Local'>numSemas</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../lmgr/spin.c.html#LN37"><span class='Ref_to_Func'>SpinlockSemaSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN138"><span class='Ref_to_Proto'>hash_estimate_size</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN54"><span class='Ref_to_Const'>SHMEM_INDEX_SIZE</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN57"><span class='Ref_to_Typedef'>ShmemIndexEnt</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../buffer/buf_init.c.html#LN159"><span class='Ref_to_Func'>BufferShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN551"><span class='Ref_to_Proto'>LockShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/predicate.h.html#LN38"><span class='Ref_to_Proto'>PredicateLockShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../lmgr/proc.c.html#LN100"><span class='Ref_to_Func'>ProcGlobalShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xlog.h.html#LN261"><span class='Ref_to_Proto'>XLOGShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/clog.h.html#LN42"><span class='Ref_to_Proto'>CLOGShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/commit_ts.h.html#LN33"><span class='Ref_to_Proto'>CommitTsShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/subtrans.h.html#LN20"><span class='Ref_to_Proto'>SUBTRANSShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/twophase.h.html#LN29"><span class='Ref_to_Proto'>TwoPhaseShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/postmaster/bgworker_internals.h.html#LN46"><span class='Ref_to_Proto'>BackgroundWorkerShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/multixact.h.html#LN122"><span class='Ref_to_Proto'>MultiXactShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN157"><span class='Ref_to_Proto'>LWLockShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/procarray.h.html#LN58"><span class='Ref_to_Proto'>ProcArrayShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN1127"><span class='Ref_to_Proto'>BackendStatusShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/sinvaladt.h.html#LN30"><span class='Ref_to_Proto'>SInvalShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/pmsignal.h.html#LN43"><span class='Ref_to_Proto'>PMSignalShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/procsignal.h.html#LN51"><span class='Ref_to_Proto'>ProcSignalShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/postmaster/bgwriter.h.html#LN37"><span class='Ref_to_Proto'>CheckpointerShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/postmaster/autovacuum.h.html#LN77"><span class='Ref_to_Proto'>AutoVacuumShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../replication/slot.c.html#LN112"><span class='Ref_to_Func'>ReplicationSlotsShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/replication/origin.h.html#LN70"><span class='Ref_to_Proto'>ReplicationOriginShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/replication/walsender.h.html#LN43"><span class='Ref_to_Proto'>WalSndShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../replication/walreceiverfuncs.c.html#LN40"><span class='Ref_to_Func'>WalRcvShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/replication/logicallauncher.h.html#LN20"><span class='Ref_to_Proto'>ApplyLauncherShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/snapmgr.h.html#LN51"><span class='Ref_to_Proto'>SnapMgrShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/access/nbtree.h.html#LN534"><span class='Ref_to_Proto'>BTreeShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../access/heap/syncscan.c.html#LN124"><span class='Ref_to_Func'>SyncScanShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/commands/async.h.html#LN27"><span class='Ref_to_Proto'>AsyncShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/backend_random.h.html#LN14"><span class='Ref_to_Proto'>BackendRandomShmemSize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/postmaster/postmaster.h.html#LN60"><span class='Ref_to_Proto'>ShmemBackendArraySize</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* freeze the addin request size and include it */ 
</span>        <a href="ipci.c.html#LN53"><span class='Ref_to_Global_Var'>addin_request_allowed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="ipci.c.html#LN52"><span class='Ref_to_Global_Var'>total_addin_request</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* might as well round it off to a multiple of a typical page size */ 
</span>        <a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><span class='Number'>8192</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>% </span><span class='Number'>8192</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"invoking IpcMemoryCreate(size=%zu)"</span><span class='Delimiter'>, </span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create the shmem segment 
         */ 
</span>        <a href="ipci.c.html#LN101"><span class='Ref_To_Local'>seghdr</span></a> <span class='Operator'>= </span><a href="../../../include/storage/pg_shmem.h.html#LN66"><span class='Ref_to_Proto'>PGSharedMemoryCreate</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN102"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="ipci.c.html#LN95"><span class='Ref_to_Parameter'>makePrivate</span></a><span class='Delimiter'>, </span><a href="ipci.c.html#LN95"><span class='Ref_to_Parameter'>port</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ipci.c.html#LN97"><span class='Ref_To_Local'>shim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/shmem.h.html#LN34"><span class='Ref_to_Proto'>InitShmemAccess</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN101"><span class='Ref_To_Local'>seghdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create semaphores 
         */ 
</span>        <a href="../../../include/storage/pg_sema.h.html#LN43"><span class='Ref_to_Proto'>PGReserveSemaphores</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN103"><span class='Ref_To_Local'>numSemas</span></a><span class='Delimiter'>, </span><a href="ipci.c.html#LN95"><span class='Ref_to_Parameter'>port</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If spinlocks are disabled, initialize emulation layer (which 
         * depends on semaphores, so the order is important here). 
         */ 
</span><span class='Directive'>#ifndef</span> HAVE_SPINLOCKS 
        <a href="../../../include/storage/spin.h.html#LN72"><span class='Ref_to_Proto'>SpinlockSemaInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !IsUnderPostmaster &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We are reattaching to an existing shared memory segment. This 
         * should only be reached in the EXEC_BACKEND case, and even then only 
         * with makePrivate == false. 
         */ 
</span><span class='Directive'>#ifdef</span> EXEC_BACKEND 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ipci.c.html#LN95"><span class='Ref_to_Parameter'>makePrivate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"should be attached to shared memory already"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up shared memory allocation mechanism 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/shmem.h.html#LN35"><span class='Ref_to_Proto'>InitShmemAllocation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now initialize LWLocks, which do shared memory allocation and are 
     * needed for InitShmemIndex. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN158"><span class='Ref_to_Proto'>CreateLWLocks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up shmem.c index hashtable 
     */ 
</span>    <a href="../../../include/storage/shmem.h.html#LN40"><span class='Ref_to_Proto'>InitShmemIndex</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up xlog, clog, and buffers 
     */ 
</span>    <a href="../../../include/access/xlog.h.html#LN262"><span class='Ref_to_Proto'>XLOGShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/clog.h.html#LN43"><span class='Ref_to_Proto'>CLOGShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/commit_ts.h.html#LN34"><span class='Ref_to_Proto'>CommitTsShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/subtrans.h.html#LN21"><span class='Ref_to_Proto'>SUBTRANSShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/multixact.h.html#LN123"><span class='Ref_to_Proto'>MultiXactShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../buffer/buf_init.c.html#LN66"><span class='Ref_to_Func'>InitBufferPool</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up lock manager 
     */ 
</span>    <a href="../lmgr/lock.c.html#LN375"><span class='Ref_to_Func'>InitLocks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up predicate lock manager 
     */ 
</span>    <a href="../../../include/storage/predicate.h.html#LN37"><span class='Ref_to_Proto'>InitPredicateLocks</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up process table 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../lmgr/proc.c.html#LN160"><span class='Ref_to_Func'>InitProcGlobal</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/procarray.h.html#LN59"><span class='Ref_to_Proto'>CreateSharedProcArray</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1128"><span class='Ref_to_Proto'>CreateSharedBackendStatus</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/twophase.h.html#LN30"><span class='Ref_to_Proto'>TwoPhaseShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postmaster/bgworker_internals.h.html#LN47"><span class='Ref_to_Proto'>BackgroundWorkerShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up shared-inval messaging 
     */ 
</span>    <a href="../../../include/storage/sinvaladt.h.html#LN31"><span class='Ref_to_Proto'>CreateSharedInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up interprocess signaling mechanisms 
     */ 
</span>    <a href="../../../include/storage/pmsignal.h.html#LN44"><span class='Ref_to_Proto'>PMSignalShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/procsignal.h.html#LN52"><span class='Ref_to_Proto'>ProcSignalShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postmaster/bgwriter.h.html#LN38"><span class='Ref_to_Proto'>CheckpointerShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/postmaster/autovacuum.h.html#LN78"><span class='Ref_to_Proto'>AutoVacuumShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../replication/slot.c.html#LN130"><span class='Ref_to_Func'>ReplicationSlotsShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/origin.h.html#LN71"><span class='Ref_to_Proto'>ReplicationOriginShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/walsender.h.html#LN44"><span class='Ref_to_Proto'>WalSndShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../replication/walreceiverfuncs.c.html#LN51"><span class='Ref_to_Func'>WalRcvShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/replication/logicallauncher.h.html#LN21"><span class='Ref_to_Proto'>ApplyLauncherShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up other modules that need some shared memory space 
     */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN52"><span class='Ref_to_Proto'>SnapMgrInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/nbtree.h.html#LN535"><span class='Ref_to_Proto'>BTreeShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../access/heap/syncscan.c.html#LN133"><span class='Ref_to_Func'>SyncScanShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/commands/async.h.html#LN28"><span class='Ref_to_Proto'>AsyncShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/backend_random.h.html#LN15"><span class='Ref_to_Proto'>BackendRandomShmemInit</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> EXEC_BACKEND 
 
    <span class='Comment_Multi_Line'>/* 
     * Alloc the win32 shared backend array 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/postmaster/postmaster.h.html#LN61"><span class='Ref_to_Proto'>ShmemBackendArrayAllocation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Initialize dynamic shared memory facilities. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/dsm.h.html#LN27"><span class='Ref_to_Proto'>dsm_postmaster_startup</span></a><span class='Parentheses'>(</span><a href="ipci.c.html#LN97"><span class='Ref_To_Local'>shim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now give loadable modules a chance to set up their shmem allocations 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ipci.c.html#LN50"><span class='Ref_to_Global_Var'>shmem_startup_hook</span></a><span class='Parentheses'>) 
</span>        <a href="ipci.c.html#LN50"><span class='Ref_to_Global_Var'>shmem_startup_hook</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateSharedMemoryAndSemaphores &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>