<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\ipc\latch.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\ipc\latch.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * latch.c 
 *    Routines for inter-process latches 
 * 
 * The Unix implementation uses the so-called self-pipe trick to overcome the 
 * race condition involved with poll() (or epoll_wait() on linux) and setting 
 * a global flag in the signal handler. When a latch is set and the current 
 * process is waiting for it, the signal handler wakes up the poll() in 
 * WaitLatch by writing a byte to a pipe. A signal by itself doesn't interrupt 
 * poll() on all platforms, and even on platforms where it does, a signal that 
 * arrives just before the poll() call does not prevent poll() from entering 
 * sleep. An incoming byte on a pipe however reliably interrupts the sleep, 
 * and causes poll() to return immediately even if the signal arrives before 
 * poll() begins. 
 * 
 * When SetLatch is called from the same process that owns the latch, 
 * SetLatch writes the byte directly to the pipe. If it's owned by another 
 * process, SIGUSR1 is sent and the signal handler in the waiting process 
 * writes the byte to the pipe on behalf of the signaling process. 
 * 
 * The Windows implementation uses Windows events that are inherited by all 
 * postmaster child processes. There's no need for the self-pipe trick there. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/ipc/latch.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_EPOLL_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/epoll.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> HAVE_POLL_H 
<span class='Keyword'>#include </span><span class='String'>&LT;poll.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"port/atomics.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"portability/instr_time.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pmsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shmem.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select the fd readiness primitive to use. Normally the "most modern" 
 * primitive supported by the OS will be used, but for testing it can be 
 * useful to manually specify the used primitive.  If desired, just add a 
 * define somewhere before this block. 
 */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span>defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) </span><span class='Operator'>|| \ 
</span>    defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* don't overwrite manual choice */ 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>HAVE_SYS_EPOLL_H<span class='Parentheses'>) 
</span><a name="LN64"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WAIT_USE_EPOLL</span> 
<span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>HAVE_POLL<span class='Parentheses'>) 
</span><a name="LN66"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WAIT_USE_POLL</span> 
<span class='Directive'>#elif</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN68"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>WAIT_USE_WIN32</span> 
<span class='Directive'>#else</span> 
#error <span class='String'>"no wait set implementation available"</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* typedef in latch.h */ 
</span><a name="LN74"></a><span class='Control'>struct</span> <span class='Declare_Struct'>WaitEventSet</span> 
<span class='Delimiter'>{ 
</span><a name="LN76"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nevents</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* number of registered events */ 
</span><a name="LN77"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nevents_space</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* maximum number of events in this set */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Array, of nevents_space length, storing the definition of events this 
     * set is waiting for. 
     */ 
</span><a name="LN83"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>events</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If WL_LATCH_SET is specified in any wait event, latch is a pointer to 
     * said latch, and latch_pos the offset in the -&GT;events array. This is 
     * useful because we check the state of the latch before performing doing 
     * syscalls related to waiting. 
     */ 
</span><a name="LN91"></a>    <a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a>      <span class='Operator'>*</span><span class='Declare_Member'>latch</span><span class='Delimiter'>; 
</span><a name="LN92"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>latch_pos</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span><a name="LN95"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>epoll_fd</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* epoll_wait returns events in a user provided arrays, allocate once */ 
</span><a name="LN97"></a>    <span class='Control'>struct</span> epoll_event <span class='Operator'>*</span><span class='Declare_Member'>epoll_ret_events</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span>    <span class='Comment_Multi_Line'>/* poll expects events to be waited on every poll() call, prepare once */ 
</span><a name="LN100"></a>    <span class='Control'>struct</span> pollfd <span class='Operator'>*</span><span class='Declare_Member'>pollfds</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Array of windows events. The first element always contains 
     * pgwin32_signal_event, so the remaining elements are offset by one (i.e. 
     * event-&GT;pos + 1). 
     */ 
</span><a name="LN108"></a>    HANDLE     <span class='Operator'>*</span><span class='Declare_Member'>handles</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitEventSet &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* Are we currently in WaitLatch? The signal handler would like to know. */ 
</span><a name="LN114"></a><span class='Keyword'>static volatile </span>sig_atomic_t <span class='Declare_Var'>waiting</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Read and write ends of the self-pipe */ 
</span><a name="LN117"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>selfpipe_readfd</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN118"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>selfpipe_writefd</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Process owning the self-pipe --- needed for checking purposes */ 
</span><a name="LN121"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>selfpipe_owner_pid</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Private function prototypes */ 
</span><a name="LN124"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>sendSelfPipeByte</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN125"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>drainSelfPipe</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span><a name="LN129"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitEventAdjustEpoll</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>action</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span><a name="LN131"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitEventAdjustPoll</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span><a name="LN133"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitEventAdjustWin32</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN136"></a><span class='Keyword'>static inline int </span><span class='Declare_Prototype'>WaitEventSetWaitBlock</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_timeout</span><span class='Delimiter'>, 
</span><a name="LN137"></a>                      <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>occurred_events</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize the process-local latch infrastructure. 
 * 
 * This must be called once during startup of any process that can wait on 
 * latches, before it issues any InitLatch() or OwnLatch() calls. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN146"></a><span class='Declare_Function'>InitializeLatchSupport</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN149"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pipefd</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We might have inherited connections to a self-pipe created by the 
         * postmaster.  It's critical that child processes create their own 
         * self-pipes, of course, and we really want them to close the 
         * inherited FDs for safety's sake. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Assert we go through here but once in a child process */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>!= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Release postmaster's pipe FDs; ignore any error */ 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN118"><span class='Ref_to_Global_Var'>selfpipe_writefd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Clean up, just for safety's sake; we'll set these below */ 
</span>            <a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN118"><span class='Ref_to_Global_Var'>selfpipe_writefd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Postmaster didn't create a self-pipe ... or else we're in an 
             * EXEC_BACKEND build, in which case it doesn't matter since the 
             * postmaster's pipe FDs were closed by the action of FD_CLOEXEC. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsUnderPostmaster &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* In postmaster or standalone backend, assert we do this but once */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up the self-pipe that allows a signal handler to wake up the 
     * poll()/epoll_wait() in WaitLatch. Make the write-end non-blocking, so 
     * that SetLatch won't block if the event has already been set many times 
     * filling the kernel buffer. Make the read-end non-blocking too, so that 
     * we can easily clear the pipe by reading until EAGAIN or EWOULDBLOCK. 
     * Also, make both FDs close-on-exec, since we surely do not want any 
     * child processes messing with them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>pipe<span class='Parentheses'>(</span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"pipe() failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span>F_SETFL<span class='Delimiter'>, </span>O_NONBLOCK<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"fcntl(F_SETFL) failed on read-end of self-pipe: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span>F_SETFL<span class='Delimiter'>, </span>O_NONBLOCK<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"fcntl(F_SETFL) failed on write-end of self-pipe: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span>F_SETFD<span class='Delimiter'>, </span>FD_CLOEXEC<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"fcntl(F_SETFD) failed on read-end of self-pipe: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span>F_SETFD<span class='Delimiter'>, </span>FD_CLOEXEC<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"fcntl(F_SETFD) failed on write-end of self-pipe: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="latch.c.html#LN118"><span class='Ref_to_Global_Var'>selfpipe_writefd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN149"><span class='Ref_To_Local'>pipefd</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* currently, nothing to do here for Windows */ 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end InitializeLatchSupport &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a process-local latch. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN219"></a><span class='Declare_Function'>InitLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="latch.c.html#LN219"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN219"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN219"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN112"><span class='Ref_to_Member'>is_shared</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Assert InitializeLatchSupport has been called in this process */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <a href="latch.c.html#LN219"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>= </span>CreateEvent<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN219"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"CreateEvent failed: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize a shared latch that can be set from other processes. The latch 
 * is initially owned by no-one; use OwnLatch to associate it with the 
 * current process. 
 * 
 * InitSharedLatch needs to be called in postmaster before forking child 
 * processes, usually right after allocating the shared memory block 
 * containing the latch with ShmemInitStruct. (The Unix implementation 
 * doesn't actually require that, but the Windows one does.) Because of 
 * this restriction, we have no concurrency issues to worry about here. 
 * 
 * Note that other handles created in this module are never marked as 
 * inheritable.  Thus we do not need to worry about cleaning up child 
 * process references to postmaster-private latches or WaitEventSets. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN251"></a><span class='Declare_Function'>InitSharedLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN254"></a>    SECURITY_ATTRIBUTES <span class='Declare_Local'>sa</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up security attributes to specify that the events are inherited. 
     */ 
</span>    ZeroMemory<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>nLength <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Operator'>.</span>bInheritHandle <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN251"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>= </span>CreateEvent<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="latch.c.html#LN254"><span class='Ref_To_Local'>sa</span></a><span class='Delimiter'>, </span><span class='Boolean'>TRUE</span><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN251"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"CreateEvent failed: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="latch.c.html#LN251"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN251"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN251"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN112"><span class='Ref_to_Member'>is_shared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitSharedLatch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Associate a shared latch with the current process, allowing it to 
 * wait on the latch. 
 * 
 * Although there is a sanity check for latch-already-owned, we don't do 
 * any sort of locking here, meaning that we could fail to detect the error 
 * if two processes try to own the same latch at about the same time.  If 
 * there is any risk of that, caller must provide an interlock to prevent it. 
 * 
 * In any process that calls OwnLatch(), make sure that 
 * latch_sigusr1_handler() is called from the SIGUSR1 signal handler, 
 * as shared latches use SIGUSR1 for inter-process communication. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN287"></a><span class='Declare_Function'>OwnLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Sanity checks */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN287"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN112"><span class='Ref_to_Member'>is_shared</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Assert InitializeLatchSupport has been called in this process */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="latch.c.html#LN121"><span class='Ref_to_Global_Var'>selfpipe_owner_pid</span></a> <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN287"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"latch already owned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN287"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Disown a shared latch currently owned by the current process. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN307"></a><span class='Declare_Function'>DisownLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN307"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN112"><span class='Ref_to_Member'>is_shared</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN307"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN307"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Wait for a given latch to be set, or for postmaster death, or until timeout 
 * is exceeded. 'wakeEvents' is a bitmask that specifies which of those events 
 * to wait for. If the latch is already set (and WL_LATCH_SET is given), the 
 * function returns immediately. 
 * 
 * The "timeout" is given in milliseconds. It must be &GT;= 0 if WL_TIMEOUT flag 
 * is given.  Although it is declared as "long", we don't actually support 
 * timeouts longer than INT_MAX milliseconds.  Note that some extra overhead 
 * is incurred when WL_TIMEOUT is given, so avoid using a timeout if possible. 
 * 
 * The latch must be owned by the current process, ie. it must be a 
 * process-local latch initialized with InitLatch, or a shared latch 
 * associated with the current process by calling OwnLatch. 
 * 
 * Returns bit mask indicating which condition(s) caused the wake-up. Note 
 * that if multiple wake-up conditions are true, there is no guarantee that 
 * we return all of them in one call, but we will return at least one. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN335"></a><span class='Declare_Function'>WaitLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>wakeEvents</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout</span><span class='Delimiter'>, 
</span><a name="LN336"></a>          <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/latch.h.html#LN165"><span class='Ref_to_Proto'>WaitLatchOrSocket</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN335"><span class='Ref_to_Parameter'>latch</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN335"><span class='Ref_to_Parameter'>wakeEvents</span></a><span class='Delimiter'>, </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN335"><span class='Ref_to_Parameter'>timeout</span></a><span class='Delimiter'>, 
</span>                             <a href="latch.c.html#LN336"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Like WaitLatch, but with an extra socket argument for WL_SOCKET_* 
 * conditions. 
 * 
 * When waiting on a socket, EOF and error conditions are reported by 
 * returning the socket as readable/writable or both, depending on 
 * WL_SOCKET_READABLE/WL_SOCKET_WRITEABLE being specified. 
 * 
 * NB: These days this is just a wrapper around the WaitEventSet API. When 
 * using a latch very frequently, consider creating a longer living 
 * WaitEventSet instead; that's more efficient. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN355"></a><span class='Declare_Function'>WaitLatchOrSocket</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>wakeEvents</span><span class='Delimiter'>, </span><a href="../../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>sock</span><span class='Delimiter'>, 
</span><a name="LN356"></a>                  <span class='Keyword'>long </span><span class='Declare_Parameter'>timeout</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN358"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN359"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN360"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>   <span class='Declare_Local'>event</span><span class='Delimiter'>; 
</span><a name="LN361"></a>    <a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Local'>set</span> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN154"><span class='Ref_to_Proto'>CreateWaitEventSet</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>wakeEvents</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a><span class='Parentheses'>) 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN356"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="latch.c.html#LN356"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>wakeEvents</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN361"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>latch</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>wakeEvents</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>&& </span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN361"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>, </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>, 
</span>                          <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>wakeEvents</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN378"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>ev</span><span class='Delimiter'>; 
</span> 
        <a href="latch.c.html#LN378"><span class='Ref_To_Local'>ev</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>wakeEvents</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/latch.h.html#LN156"><span class='Ref_to_Proto'>AddWaitEventToSet</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN361"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN378"><span class='Ref_To_Local'>ev</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN355"><span class='Ref_to_Parameter'>sock</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="latch.c.html#LN359"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN160"><span class='Ref_to_Proto'>WaitEventSetWait</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN361"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN356"><span class='Ref_to_Parameter'>timeout</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN360"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="latch.c.html#LN356"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN359"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="latch.c.html#LN358"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN126"><span class='Ref_to_Const'>WL_TIMEOUT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN358"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>|= </span><a href="latch.c.html#LN360"><span class='Ref_To_Local'>event</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>| 
</span>                               <a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>| 
</span>                               <a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| 
</span>                               <a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/latch.h.html#LN155"><span class='Ref_to_Proto'>FreeWaitEventSet</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN361"><span class='Ref_To_Local'>set</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="latch.c.html#LN358"><span class='Ref_To_Local'>ret</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitLatchOrSocket &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Sets a latch and wakes up anyone waiting on it. 
 * 
 * This is cheap if the latch is already set, otherwise not so much. 
 * 
 * NB: when calling this in a signal handler, be sure to save and restore 
 * errno around it.  (That's standard practice in most signal handlers, of 
 * course, but we used to omit it in handlers that only set a flag.) 
 * 
 * NB: this function is called from critical sections and signal handlers so 
 * throwing an error is not a good idea. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN414"></a><span class='Declare_Function'>SetLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN417"></a>    <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>owner_pid</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN419"></a>    HANDLE      <span class='Declare_Local'>handle</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The memory barrier has to be placed here to ensure that any flag 
     * variables possibly changed by this process have been flushed to main 
     * memory, before we check/set is_set. 
     */ 
</span>    <a href="../../../include/port/atomics.h.html#LN147"><span class='Ref_to_Macro'>pg_memory_barrier</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick exit if already set */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN414"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN414"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * See if anyone's waiting for the latch. It can be the current process if 
     * we're in a signal handler. We use the self-pipe to wake up the 
     * poll()/epoll_wait() in that case. If it's another process, send a 
     * signal. 
     * 
     * Fetch owner_pid only once, in case the latch is concurrently getting 
     * owned or disowned. XXX: This assumes that pid_t is atomic, which isn't 
     * guaranteed to be true! In practice, the effective range of pid_t fits 
     * in a 32 bit integer, and so should be atomic. In the worst case, we 
     * might end up signaling the wrong process. Even then, you're very 
     * unlucky if a process with that bogus pid exists and belongs to 
     * Postgres; and PG database processes should handle excess SIGUSR1 
     * interrupts without a problem anyhow. 
     * 
     * Another sort of race condition that's possible here is for a new 
     * process to own the latch immediately after we look, so we don't signal 
     * it. This is okay so long as all callers of ResetLatch/WaitLatch follow 
     * the standard coding convention of waiting at the bottom of their loops, 
     * not the top, so that they'll correctly process latch-setting events 
     * that happen before they enter the loop. 
     */ 
</span>    <a href="latch.c.html#LN417"><span class='Ref_To_Local'>owner_pid</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN414"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN417"><span class='Ref_To_Local'>owner_pid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN417"><span class='Ref_To_Local'>owner_pid</span></a> <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN124"><span class='Ref_to_Proto'>sendSelfPipeByte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN417"><span class='Ref_To_Local'>owner_pid</span></a><span class='Delimiter'>, </span><a href="../../../include/port/win32.h.html#LN201"><span class='Ref_to_Const'>SIGUSR1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * See if anyone's waiting for the latch. It can be the current process if 
     * we're in a signal handler. 
     * 
     * Use a local variable here just in case somebody changes the event field 
     * concurrently (which really should not happen). 
     */ 
</span>    <a href="latch.c.html#LN419"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN414"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN419"><span class='Ref_To_Local'>handle</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        SetEvent<span class='Parentheses'>(</span><a href="latch.c.html#LN419"><span class='Ref_To_Local'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note that we silently ignore any errors. We might be in a signal 
         * handler or other critical path where it's not safe to call elog(). 
         */ 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end SetLatch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Clear the latch. Calling WaitLatch after this will sleep, unless 
 * the latch is set again before the WaitLatch call. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN497"></a><span class='Declare_Function'>ResetLatch</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Only the owner should reset the latch */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN497"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN497"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Ensure that the write to is_set gets flushed to main memory before we 
     * examine any flag variables.  Otherwise a concurrent SetLatch might 
     * falsely conclude that it needn't signal us, even though we have missed 
     * seeing some flag updates that SetLatch was supposed to inform us of. 
     */ 
</span>    <a href="../../../include/port/atomics.h.html#LN147"><span class='Ref_to_Macro'>pg_memory_barrier</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a WaitEventSet with space for nevents different events to wait for. 
 * 
 * These events can then be efficiently waited upon together, using 
 * WaitEventSetWait(). 
 */ 
</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>* 
</span><a name="LN520"></a><span class='Declare_Function'>CreateWaitEventSet</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN522"></a>    <a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Local'>set</span><span class='Delimiter'>; 
</span><a name="LN523"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN524"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sz</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use MAXALIGN size/alignment to guarantee that later uses of memory are 
     * aligned correctly. E.g. epoll_event might need 8 byte alignment on some 
     * platforms, but earlier allocations like WaitEventSet and WaitEvent 
     * might not sized to guarantee that when purely using sizeof(). 
     */ 
</span>    <a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> epoll_event<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> pollfd<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span>    <span class='Comment_Multi_Line'>/* need space for the pgwin32_signal_event */ 
</span>    <a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN524"><span class='Ref_To_Local'>sz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN97"><span class='Ref_to_Member'>epoll_ret_events</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> epoll_event <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> epoll_event<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN100"><span class='Ref_to_Member'>pollfds</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> pollfd <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> pollfd<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN523"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>+= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>HANDLE<span class='Parentheses'>) </span><span class='Operator'>* </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN77"><span class='Ref_to_Member'>nevents_space</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#ifdef</span> EPOLL_CLOEXEC 
    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a> <span class='Operator'>= </span>epoll_create1<span class='Parentheses'>(</span>EPOLL_CLOEXEC<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"epoll_create1 failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* cope with ancient glibc lacking epoll_create1 (e.g., RHEL5) */ 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a> <span class='Operator'>= </span>epoll_create<span class='Parentheses'>(</span><a href="latch.c.html#LN520"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"epoll_create failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fcntl<span class='Parentheses'>(</span><a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a><span class='Delimiter'>, </span>F_SETFD<span class='Delimiter'>, </span>FD_CLOEXEC<span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"fcntl(F_SETFD) failed on epoll descriptor: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* EPOLL_CLOEXEC */ 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To handle signals while waiting, we need to add a win32 specific event. 
     * We accounted for the additional event at the top of this routine. See 
     * port/win32/signal.c for more details. 
     * 
     * Note: pgwin32_signal_event should be first to ensure that it will be 
     * reported when multiple events are set.  We want to guarantee that 
     * pending signals are serviced. 
     */ 
</span>    <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../port/win32/signal.c.html#LN26"><span class='Ref_to_Global_Var'>pgwin32_signal_event</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span>WSA_INVALID_EVENT <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="latch.c.html#LN522"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateWaitEventSet &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free a previously created WaitEventSet. 
 * 
 * Note: preferably, this shouldn't have to free any resources that could be 
 * inherited across an exec().  If it did, we'd likely leak those resources in 
 * many scenarios.  For the epoll case, we ensure that by setting FD_CLOEXEC 
 * when the FD is created.  For the Windows case, we assume that the handles 
 * involved are non-inheritable. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN607"></a><span class='Declare_Function'>FreeWaitEventSet</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span>    <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span><a name="LN612"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>cur_event</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>+ </span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* uses the latch's HANDLE */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* uses PostmasterHandle */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Clean up the event object we created for the socket */ 
</span>            WSAEventSelect<span class='Parentheses'>(</span><a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            WSACloseEvent<span class='Parentheses'>(</span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN612"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN607"><span class='Ref_to_Parameter'>set</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreeWaitEventSet &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* --- 
 * Add an event to the set. Possible events are: 
 * - WL_LATCH_SET: Wait for the latch to be set 
 * - WL_POSTMASTER_DEATH: Wait for postmaster to die 
 * - WL_SOCKET_READABLE: Wait for socket to become readable 
 *   can be combined in one event with WL_SOCKET_WRITEABLE 
 * - WL_SOCKET_WRITEABLE: Wait for socket to become writeable 
 *   can be combined with WL_SOCKET_READABLE 
 * 
 * Returns the offset in WaitEventSet-&GT;events (starting from 0), which can be 
 * used to modify previously added wait events using ModifyWaitEvent(). 
 * 
 * In the WL_LATCH_SET case the latch must be owned by the current process, 
 * i.e. it must be a process-local latch initialized with InitLatch, or a 
 * shared latch associated with the current process by calling OwnLatch. 
 * 
 * In the WL_SOCKET_READABLE/WRITEABLE case, EOF and error conditions are 
 * reported by returning the socket as readable/writable or both, depending on 
 * WL_SOCKET_READABLE/WRITEABLE being specified. 
 * 
 * The user_data pointer specified here will be set for the events returned 
 * by WaitEventSetWait(), allowing to easily associate additional data with 
 * events. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN663"></a><span class='Declare_Function'>AddWaitEventToSet</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>events</span><span class='Delimiter'>, </span><a href="../../../include/port.h.html#LN25"><span class='Ref_to_Typedef'>pgsocket</span></a> <span class='Declare_Parameter'>fd</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Delimiter'>, 
</span><a name="LN664"></a>                  <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>user_data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN666"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>event</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* not enough space */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a> <span class='Operator'>&LT; </span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN77"><span class='Ref_to_Member'>nevents_space</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>latch</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN113"><span class='Ref_to_Member'>owner_pid</span></a> <span class='Operator'>!= </span><a href="../../utils/init/globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot wait on a latch owned by another process"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot wait on more than one latch"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"latch events only support being set"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot wait on latch without a specified latch"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* waiting for socket readiness without a socket indicates a bug */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>fd</span></a> <span class='Operator'>== </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot wait on socket event without a socket"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= &</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Delimiter'>]; 
</span>    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>fd</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN664"><span class='Ref_to_Parameter'>user_data</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN136"><span class='Ref_to_Member'>reset</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>latch</span></a><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN92"><span class='Ref_to_Member'>latch_pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../postmaster/postmaster.c.html#LN556"><span class='Ref_to_Global_Var'>postmaster_alive_fds</span></a><span class='Delimiter'>[</span><a href="../../../include/postmaster/postmaster.h.html#LN41"><span class='Ref_to_Const'>POSTMASTER_FD_WATCH</span></a><span class='Delimiter'>]; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* perform wait primitive specific initialization, if needed */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN129"><span class='Ref_to_Proto'>WaitEventAdjustEpoll</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>, </span>EPOLL_CTL_ADD<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN131"><span class='Ref_to_Proto'>WaitEventAdjustPoll</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN133"><span class='Ref_to_Proto'>WaitEventAdjustWin32</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN663"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>return</span> <a href="latch.c.html#LN666"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddWaitEventToSet &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Change the event mask and, in the WL_LATCH_SET case, the latch associated 
 * with the WaitEvent. 
 * 
 * 'pos' is the id returned by AddWaitEventToSet. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN734"></a><span class='Declare_Function'>ModifyWaitEvent</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>pos</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>events</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>latch</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN736"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>event</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>pos</span></a> <span class='Operator'>&LT; </span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a> <span class='Operator'>= &</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>pos</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If neither the event mask nor the associated latch changes, return 
     * early. That's an important optimization for some sockets, where 
     * ModifyWaitEvent is frequently used to switch from waiting for reads to 
     * waiting on writes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>== </span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>== </span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>latch</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>&& 
</span>        <a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>!= </span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we could allow to disable latch events for a while */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot modify latch event"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot modify postmaster death event"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* FIXME: validate event mask */ 
</span>    <a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>events</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>latch</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN129"><span class='Ref_to_Proto'>WaitEventAdjustEpoll</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Delimiter'>, </span>EPOLL_CTL_MOD<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN131"><span class='Ref_to_Proto'>WaitEventAdjustPoll</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span>    <a href="latch.c.html#LN133"><span class='Ref_to_Proto'>WaitEventAdjustWin32</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN734"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN736"><span class='Ref_To_Local'>event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ModifyWaitEvent &raquo; </span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * action can be one of EPOLL_CTL_ADD | EPOLL_CTL_MOD | EPOLL_CTL_DEL 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN786"></a><span class='Declare_Function'>WaitEventAdjustEpoll</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>action</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN788"></a>    <span class='Control'>struct</span> epoll_event <span class='Declare_Local'>epoll_ev</span><span class='Delimiter'>; 
</span><a name="LN789"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pointer to our event, returned by epoll_wait */ 
</span>    <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span>data<span class='Operator'>.</span>ptr <span class='Operator'>= </span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* always wait for errors */ 
</span>    <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span>EPOLLERR <span class='Operator'>| </span>EPOLLHUP<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepare pollfd entry once */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>EPOLLIN<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>EPOLLIN<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>!= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>EPOLLIN<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>EPOLLOUT<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Even though unused, we also pass epoll_ev as the data argument if 
     * EPOLL_CTL_DEL is passed as action.  There used to be an epoll bug 
     * requiring that, and actually it makes the code simpler... 
     */ 
</span>    <a href="latch.c.html#LN789"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>epoll_ctl<span class='Parentheses'>(</span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN786"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN788"><span class='Ref_To_Local'>epoll_ev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN789"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"epoll_ctl() failed: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventAdjustEpoll &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span><span class='Keyword'>static void 
</span><a name="LN833"></a><span class='Declare_Function'>WaitEventAdjustPoll</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN835"></a>    <span class='Control'>struct</span> <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pollfd</span> <span class='Operator'>= &</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN100"><span class='Ref_to_Member'>pollfds</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>]; 
</span> 
    <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepare pollfd entry once */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span>POLLIN<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span>POLLIN<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>POLLIN<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN835"><span class='Ref_To_Local'>pollfd</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span>POLLOUT<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN833"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>!= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventAdjustPoll &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span><span class='Keyword'>static void 
</span><a name="LN866"></a><span class='Declare_Function'>WaitEventAdjustWin32</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>event</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN868"></a>    HANDLE     <span class='Operator'>*</span><span class='Declare_Local'>handle</span> <span class='Operator'>= &</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span><a href="../../postmaster/postmaster.c.html#LN559"><span class='Ref_to_Global_Var'>PostmasterHandle</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN881"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span> <span class='Operator'>= </span>FD_CLOSE<span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* always check for errors/EOF */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN881"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>FD_READ<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) 
</span>            <a href="latch.c.html#LN881"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>|= </span>FD_WRITE<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>== </span>WSA_INVALID_EVENT<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span>WSACreateEvent<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>== </span>WSA_INVALID_EVENT<span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to create event for socket: error code %u"</span><span class='Delimiter'>, 
</span>                     WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>WSAEventSelect<span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="latch.c.html#LN868"><span class='Ref_To_Local'>handle</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN881"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to set up event for socket: error code %u"</span><span class='Delimiter'>, 
</span>                 WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN866"><span class='Ref_to_Parameter'>event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>!= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end WaitEventAdjustWin32 &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait for events added to the set to happen, or until the timeout is 
 * reached.  At most nevents occurred events are returned. 
 * 
 * If timeout = -1, block until an event occurs; if 0, check sockets for 
 * readiness, but don't block; if &GT; 0, block for at most timeout milliseconds. 
 * 
 * Returns the number of events occurred, or 0 if the timeout was reached. 
 * 
 * Returned events will have the fd, pos, user_data fields set to the 
 * values associated with the registered event. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN917"></a><span class='Declare_Function'>WaitEventSetWait</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>timeout</span><span class='Delimiter'>, 
</span><a name="LN918"></a>                 <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>occurred_events</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Delimiter'>, 
</span><a name="LN919"></a>                 <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>wait_event_info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN921"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returned_events</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN922"></a>    <a href="../../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>start_time</span><span class='Delimiter'>; 
</span><a name="LN923"></a>    <a href="../../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>cur_time</span><span class='Delimiter'>; 
</span><a name="LN924"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>cur_timeout</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>nevents</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize timeout if requested.  We must record the current time so 
     * that we can determine the remaining timeout if interrupted. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN922"><span class='Ref_To_Local'>start_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>&LT;= </span>INT_MAX<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN924"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN919"><span class='Ref_to_Parameter'>wait_event_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Comment_Multi_Line'>/* Ensure that signals are serviced even if latch is already set */ 
</span>    <a href="../../port/win32/signal.c.html#LN105"><span class='Ref_to_Func'>pgwin32_dispatch_queued_signals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN921"><span class='Ref_To_Local'>returned_events</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN949"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if the latch is set already. If so, leave the loop 
         * immediately, avoid blocking again. We don't attempt to report any 
         * other events that might also be satisfied. 
         * 
         * If someone sets the latch between this and the 
         * WaitEventSetWaitBlock() below, the setter will write a byte to the 
         * pipe (or signal us and the signal handler will do that), and the 
         * readiness routine will return immediately. 
         * 
         * On unix, If there's a pending byte in the self pipe, we'll notice 
         * whenever blocking. Only clearing the pipe in that case avoids 
         * having to drain it every time WaitLatchOrSocket() is used. Should 
         * the pipe-buffer fill up we're still ok, because the pipe is in 
         * nonblocking mode. It's unlikely for that to happen, because the 
         * self pipe isn't filled unless we're blocking (waiting = true), or 
         * from inside a signal handler in latch_sigusr1_handler(). 
         * 
         * On windows, we'll also notice if there's a pending event for the 
         * latch when blocking, but there's no danger of anything filling up, 
         * as "Setting an event that is already set has no effect.". 
         * 
         * Note: we assume that the kernel calls involved in latch management 
         * will provide adequate synchronization on machines with weak memory 
         * ordering, so that we cannot miss seeing is_set if a notification 
         * has already been queued. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a> <span class='Operator'>&& </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN92"><span class='Ref_to_Member'>latch_pos</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= 
</span>                <a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN92"><span class='Ref_to_Member'>latch_pos</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN921"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wait for events using the readiness primitive chosen at the top of 
         * this file. If -1 is returned, a timeout has occurred, if 0 we have 
         * to retry, everything &GT;= 1 is the number of returned events. 
         */ 
</span>        <a href="latch.c.html#LN949"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN136"><span class='Ref_to_Proto'>WaitEventSetWaitBlock</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN924"><span class='Ref_To_Local'>cur_timeout</span></a><span class='Delimiter'>, 
</span>                                   <a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN918"><span class='Ref_to_Parameter'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN949"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* timeout occurred */ 
</span>        <span class='Control'>else</span> 
            <a href="latch.c.html#LN921"><span class='Ref_To_Local'>returned_events</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN949"><span class='Ref_To_Local'>rc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we're not done, update cur_timeout for next iteration */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN921"><span class='Ref_To_Local'>returned_events</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN923"><span class='Ref_To_Local'>cur_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN923"><span class='Ref_To_Local'>cur_time</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN922"><span class='Ref_To_Local'>start_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN924"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN917"><span class='Ref_to_Parameter'>timeout</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="../../../include/portability/instr_time.h.html#LN134"><span class='Ref_to_Macro'>INSTR_TIME_GET_MILLISEC</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN923"><span class='Ref_To_Local'>cur_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN924"><span class='Ref_To_Local'>cur_timeout</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while returned_events==0 &raquo; </span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="latch.c.html#LN921"><span class='Ref_To_Local'>returned_events</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventSetWait &raquo; </span> 
 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN64"><span class='Ref_to_Const'>WAIT_USE_EPOLL</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Wait using linux's epoll_wait(2). 
 * 
 * This is the preferrable wait method, as several readiness notifications are 
 * delivered, without having to iterate through all of set-&GT;events. The return 
 * epoll_event struct contain a pointer to our events, making association 
 * easy. 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN1035"></a><span class='Declare_Function'>WaitEventSetWaitBlock</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_timeout</span><span class='Delimiter'>, 
</span><a name="LN1036"></a>                      <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>occurred_events</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1038"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returned_events</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1039"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN1040"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>cur_event</span><span class='Delimiter'>; 
</span><a name="LN1041"></a>    <span class='Control'>struct</span> epoll_event <span class='Operator'>*</span><span class='Declare_Local'>cur_epoll_event</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sleep */ 
</span>    <a href="latch.c.html#LN1039"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>epoll_wait<span class='Parentheses'>(</span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN95"><span class='Ref_to_Member'>epoll_fd</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN97"><span class='Ref_to_Member'>epoll_ret_events</span></a><span class='Delimiter'>, 
</span>                    <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>nevents</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>cur_timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check return code */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1039"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* EINTR is okay, otherwise complain */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"epoll_wait() failed: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1039"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* timeout exceeded */ 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * At least one event occurred, iterate over the returned epoll events 
     * until they're either all processed, or we've returned all the events 
     * the caller desired. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN97"><span class='Ref_to_Member'>epoll_ret_events</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN97"><span class='Ref_to_Member'>epoll_ret_events</span></a> <span class='Operator'>+ </span><a href="latch.c.html#LN1039"><span class='Ref_To_Local'>rc</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>         <a href="latch.c.html#LN1038"><span class='Ref_To_Local'>returned_events</span></a> <span class='Operator'>&LT; </span><a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>nevents</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* epoll's data pointer is set to the associated WaitEvent */ 
</span>        <a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>-&GT;</span>data<span class='Operator'>.</span>ptr<span class='Delimiter'>; 
</span> 
        <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>&& 
</span>            <a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>-&GT;</span>events <span class='Operator'>& </span><span class='Parentheses'>(</span>EPOLLIN <span class='Operator'>| </span>EPOLLERR <span class='Operator'>| </span>EPOLLHUP<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* There's data in the self-pipe, clear it. */ 
</span>            <a href="latch.c.html#LN125"><span class='Ref_to_Proto'>drainSelfPipe</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1035"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1038"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>&& 
</span>                 <a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>-&GT;</span>events <span class='Operator'>& </span><span class='Parentheses'>(</span>EPOLLIN <span class='Operator'>| </span>EPOLLERR <span class='Operator'>| </span>EPOLLHUP<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We expect an EPOLLHUP when the remote end is closed, but 
             * because we don't expect the pipe to become readable or to have 
             * any errors either, treat those cases as postmaster death, too. 
             * 
             * Be paranoid about a spurious event signalling the postmaster as 
             * being dead.  There have been reports about that happening with 
             * older primitives (select(2) to be specific), and a spurious 
             * WL_POSTMASTER_DEATH event would be painful. Re-checking doesn't 
             * cost much. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/pmsignal.h.html#LN53"><span class='Ref_to_Proto'>PostmasterIsAlive</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1038"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events==WL... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>!= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>-&GT;</span>events <span class='Operator'>& </span><span class='Parentheses'>(</span>EPOLLIN <span class='Operator'>| </span>EPOLLERR <span class='Operator'>| </span>EPOLLHUP<span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* data available in socket, or EOF */ 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="latch.c.html#LN1041"><span class='Ref_To_Local'>cur_epoll_event</span></a><span class='Operator'>-&GT;</span>events <span class='Operator'>& </span><span class='Parentheses'>(</span>EPOLLOUT <span class='Operator'>| </span>EPOLLERR <span class='Operator'>| </span>EPOLLHUP<span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* writable, or EOF */ 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1040"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1036"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1038"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events&(WL... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for cur_epoll_event=set-&GT;... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="latch.c.html#LN1038"><span class='Ref_To_Local'>returned_events</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventSetWaitBlock &raquo; </span> 
 
<span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN66"><span class='Ref_to_Const'>WAIT_USE_POLL</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Wait using poll(2). 
 * 
 * This allows to receive readiness notifications for several events at once, 
 * but requires iterating through all of set-&GT;pollfds. 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN1158"></a><span class='Declare_Function'>WaitEventSetWaitBlock</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_timeout</span><span class='Delimiter'>, 
</span><a name="LN1159"></a>                      <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>occurred_events</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1161"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returned_events</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1162"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN1163"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>cur_event</span><span class='Delimiter'>; 
</span><a name="LN1164"></a>    <span class='Control'>struct</span> pollfd <span class='Operator'>*</span><span class='Declare_Local'>cur_pollfd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sleep */ 
</span>    <a href="latch.c.html#LN1162"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>poll<span class='Parentheses'>(</span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN100"><span class='Ref_to_Member'>pollfds</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>cur_timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check return code */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1162"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* EINTR is okay, otherwise complain */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN133"><span class='Ref_to_Proto'>errcode_for_socket_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"poll() failed: %m"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1162"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* timeout exceeded */ 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN100"><span class='Ref_to_Member'>pollfds</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>+ </span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>         <a href="latch.c.html#LN1161"><span class='Ref_To_Local'>returned_events</span></a> <span class='Operator'>&LT; </span><a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>nevents</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* no activity on this FD, skip */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a><span class='Delimiter'>; 
</span>        <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>& </span><span class='Parentheses'>(</span>POLLIN <span class='Operator'>| </span>POLLHUP <span class='Operator'>| </span>POLLERR <span class='Operator'>| </span>POLLNVAL<span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* There's data in the self-pipe, clear it. */ 
</span>            <a href="latch.c.html#LN125"><span class='Ref_to_Proto'>drainSelfPipe</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1158"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1161"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a> <span class='Operator'>&& 
</span>             <span class='Parentheses'>(</span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>& </span><span class='Parentheses'>(</span>POLLIN <span class='Operator'>| </span>POLLHUP <span class='Operator'>| </span>POLLERR <span class='Operator'>| </span>POLLNVAL<span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We expect an POLLHUP when the remote end is closed, but because 
             * we don't expect the pipe to become readable or to have any 
             * errors either, treat those cases as postmaster death, too. 
             * 
             * Be paranoid about a spurious event signalling the postmaster as 
             * being dead.  There have been reports about that happening with 
             * older primitives (select(2) to be specific), and a spurious 
             * WL_POSTMASTER_DEATH event would be painful. Re-checking doesn't 
             * cost much. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/pmsignal.h.html#LN53"><span class='Ref_to_Proto'>PostmasterIsAlive</span></a><span class='Parentheses'>())</span> 
            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1161"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events==WL... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1239"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>errflags</span> <span class='Operator'>= </span>POLLHUP <span class='Operator'>| </span>POLLERR <span class='Operator'>| </span>POLLNVAL<span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>& </span><span class='Parentheses'>(</span>POLLIN <span class='Operator'>| </span><a href="latch.c.html#LN1239"><span class='Ref_To_Local'>errflags</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* data available in socket, or EOF */ 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                <span class='Parentheses'>(</span><a href="latch.c.html#LN1164"><span class='Ref_To_Local'>cur_pollfd</span></a><span class='Operator'>-&GT;</span>revents <span class='Operator'>& </span><span class='Parentheses'>(</span>POLLOUT <span class='Operator'>| </span><a href="latch.c.html#LN1239"><span class='Ref_To_Local'>errflags</span></a><span class='Parentheses'>)))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* writeable, or EOF */ 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1163"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1159"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1161"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events&(WL... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for cur_event=set-&GT;events... &raquo; </span> 
    <span class='Control'>return</span> <a href="latch.c.html#LN1161"><span class='Ref_To_Local'>returned_events</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventSetWaitBlock &raquo; </span> 
 
<span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span><a href="latch.c.html#LN68"><span class='Ref_to_Const'>WAIT_USE_WIN32</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Wait using Windows' WaitForMultipleObjects(). 
 * 
 * Unfortunately this will only ever return a single readiness notification at 
 * a time.  Note that while the official documentation for 
 * WaitForMultipleObjects is ambiguous about multiple events being "consumed" 
 * with a single bWaitAll = FALSE call, 
 * https://blogs.msdn.microsoft.com/oldnewthing/20150409-00/?p=44273 confirms 
 * that only one event is "consumed". 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN1281"></a><span class='Declare_Function'>WaitEventSetWaitBlock</span><span class='Parentheses'>(</span><a href="latch.c.html#LN74"><span class='Ref_to_Struct'>WaitEventSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>set</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cur_timeout</span><span class='Delimiter'>, 
</span><a name="LN1282"></a>                      <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>occurred_events</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nevents</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1284"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>returned_events</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1285"></a>    <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN1286"></a>    <a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>cur_event</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset any wait events that need it */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>+ </span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN136"><span class='Ref_to_Member'>reset</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN133"><span class='Ref_to_Proto'>WaitEventAdjustWin32</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN136"><span class='Ref_to_Member'>reset</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Windows does not guarantee to log an FD_WRITE network event 
         * indicating that more data can be sent unless the previous send() 
         * failed with WSAEWOULDBLOCK.  While our caller might well have made 
         * such a call, we cannot assume that here.  Therefore, if waiting for 
         * write-ready, force the issue by doing a dummy send().  If the dummy 
         * send() succeeds, assume that the socket is in fact write-ready, and 
         * return immediately.  Also, if it fails with something other than 
         * WSAEWOULDBLOCK, return a write-ready indication to let our caller 
         * deal with the error condition. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1312"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN1313"></a>            WSABUF      <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1314"></a>            <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>sent</span><span class='Delimiter'>; 
</span><a name="LN1315"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
            <a href="latch.c.html#LN1313"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>buf <span class='Operator'>= &</span><a href="latch.c.html#LN1312"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1313"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span>len <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <a href="latch.c.html#LN1315"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span>WSASend<span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN1313"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN1314"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1315"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>WSAGetLastError<span class='Parentheses'>() </span><span class='Operator'>!= </span>WSAEWOULDBLOCK<span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events&WL_... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for cur_event=set-&GT;events... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Sleep. 
     * 
     * Need to wait for -&GT;nevents + 1, because signal handle is in [0]. 
     */ 
</span>    <a href="latch.c.html#LN1285"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span>WaitForMultipleObjects<span class='Parentheses'>(</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN76"><span class='Ref_to_Member'>nevents</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a><span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Delimiter'>, 
</span>                                <a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>cur_timeout</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check return code */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1285"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span>WAIT_FAILED<span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"WaitForMultipleObjects() failed: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1285"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span>WAIT_TIMEOUT<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* timeout exceeded */ 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1285"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span>WAIT_OBJECT_0<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Service newly-arrived signals */ 
</span>        <a href="../../port/win32/signal.c.html#LN105"><span class='Ref_to_Func'>pgwin32_dispatch_queued_signals</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>;</span>               <span class='Comment_Single_Line'>/* retry */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * With an offset of one, due to the always present pgwin32_signal_event, 
     * the handle offset directly corresponds to a wait event. 
     */ 
</span>    <a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN129"><span class='Ref_to_Struct'>WaitEvent</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN83"><span class='Ref_to_Member'>events</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN1285"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>- </span>WAIT_OBJECT_0 <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN134"><span class='Ref_to_Member'>user_data</span></a><span class='Delimiter'>; 
</span>    <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>ResetEvent<span class='Parentheses'>(</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN115"><span class='Ref_to_Member'>event</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ResetEvent failed: error code %lu"</span><span class='Delimiter'>, </span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN91"><span class='Ref_to_Member'>latch</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN111"><span class='Ref_to_Member'>is_set</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1284"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>== </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Postmaster apparently died.  Since the consequences of falsely 
         * returning WL_POSTMASTER_DEATH could be pretty unpleasant, we take 
         * the trouble to positively verify this with PostmasterIsAlive(), 
         * even though there is no known reason to think that the event could 
         * be falsely set on Windows. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/pmsignal.h.html#LN53"><span class='Ref_to_Proto'>PostmasterIsAlive</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>= </span><a href="../../../include/storage/latch.h.html#LN127"><span class='Ref_to_Const'>WL_POSTMASTER_DEATH</span></a><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1284"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a> <span class='Operator'>| </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1399"></a>        WSANETWORKEVENTS <span class='Declare_Local'>resEvents</span><span class='Delimiter'>; 
</span><a name="LN1400"></a>        HANDLE      <span class='Declare_Local'>handle</span> <span class='Operator'>= </span><a href="latch.c.html#LN1281"><span class='Ref_to_Parameter'>set</span></a><span class='Operator'>-&GT;</span><a href="latch.c.html#LN108"><span class='Ref_to_Member'>handles</span></a><span class='Delimiter'>[</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN131"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a> <span class='Operator'>= </span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>; 
</span> 
        ZeroMemory<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>WSAEnumNetworkEvents<span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN133"><span class='Ref_to_Member'>fd</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1400"><span class='Ref_To_Local'>handle</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to enumerate network events: error code %u"</span><span class='Delimiter'>, 
</span>                 WSAGetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Operator'>.</span>lNetworkEvents <span class='Operator'>& </span>FD_READ<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* data available in socket */ 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/*------ 
             * WaitForMultipleObjects doesn't guarantee that a read event will 
             * be returned if the latch is set at the same time.  Even if it 
             * did, the caller might drop that event expecting it to reoccur 
             * on next call.  So, we must force the event to be reset if this 
             * WaitEventSet is used again in order to avoid an indefinite 
             * hang.  Refer https://msdn.microsoft.com/en-us/library/windows/desktop/ms741576(v=vs.85).aspx 
             * for the behavior of socket events. 
             *------ 
             */ 
</span>            <a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN136"><span class='Ref_to_Member'>reset</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Operator'>.</span>lNetworkEvents <span class='Operator'>& </span>FD_WRITE<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* writeable */ 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1399"><span class='Ref_To_Local'>resEvents</span></a><span class='Operator'>.</span>lNetworkEvents <span class='Operator'>& </span>FD_CLOSE<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* EOF */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Parentheses'>) 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN124"><span class='Ref_to_Const'>WL_SOCKET_READABLE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1286"><span class='Ref_To_Local'>cur_event</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>& </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Parentheses'>) 
</span>                <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/latch.h.html#LN125"><span class='Ref_to_Const'>WL_SOCKET_WRITEABLE</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/latch.h.html#LN132"><span class='Ref_to_Member'>events</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN1282"><span class='Ref_to_Parameter'>occurred_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="latch.c.html#LN1284"><span class='Ref_To_Local'>returned_events</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cur_event-&GT;events&(WL... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="latch.c.html#LN1284"><span class='Ref_To_Local'>returned_events</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitEventSetWaitBlock &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * SetLatch uses SIGUSR1 to wake up the process waiting on the latch. 
 * 
 * Wake up WaitLatch, if we're waiting.  (We might not be, since SIGUSR1 is 
 * overloaded for multiple purposes; or we might not have reached WaitLatch 
 * yet, in which case we don't need to fill the pipe either.) 
 * 
 * NB: when calling this in a signal handler, be sure to save and restore 
 * errno around it. 
 */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>void 
</span><a name="LN1466"></a><span class='Declare_Function'>latch_sigusr1_handler</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a><span class='Parentheses'>) 
</span>        <a href="latch.c.html#LN124"><span class='Ref_to_Proto'>sendSelfPipeByte</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* !WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* Send one byte to the self-pipe, to wake up WaitLatch */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static void 
</span><a name="LN1476"></a><span class='Declare_Function'>sendSelfPipeByte</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1478"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN1479"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>dummy</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN1481"></a><span class='Label'>retry</span><span class='Operator'>: 
</span>    <a href="latch.c.html#LN1478"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN118"><span class='Ref_to_Global_Var'>selfpipe_writefd</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="latch.c.html#LN1479"><span class='Ref_To_Local'>dummy</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1478"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If interrupted by signal, just retry */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&uarr;</span><a href="latch.c.html#LN1481"><span class='Ref_to_Label'>retry</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the pipe is full, we don't need to retry, the data that's there 
         * already is enough to wake up WaitLatch. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Oops, the write() failed for some other reason. We might be in a 
         * signal handler, so it's not safe to elog(). We have no choice but 
         * silently ignore the error. 
         */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rc&LT;0 &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end sendSelfPipeByte &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* !WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read all available data from the self-pipe 
 * 
 * Note: this is only called when waiting = true.  If it fails and doesn't 
 * return, it must reset that flag first (though ideally, this will never 
 * happen). 
 */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Keyword'>static void 
</span><a name="LN1515"></a><span class='Declare_Function'>drainSelfPipe</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * There shouldn't normally be more than one byte in the pipe, or maybe a 
     * few bytes if multiple processes run SetLatch at the same instant. 
     */ 
</span><a name="LN1521"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1522"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="latch.c.html#LN1522"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="latch.c.html#LN117"><span class='Ref_to_Global_Var'>selfpipe_readfd</span></a><span class='Delimiter'>, </span><a href="latch.c.html#LN1521"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1521"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1522"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../include/port/win32.h.html#LN282"><span class='Ref_to_Const'>EAGAIN</span></a> <span class='Operator'>|| </span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN19"><span class='Ref_to_Const'>EWOULDBLOCK</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* the pipe is empty */ 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><a href="../../../interfaces/libpq/win32.h.html#LN17"><span class='Ref_to_Const'>EINTR</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* retry */ 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"read() on self-pipe failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1522"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="latch.c.html#LN114"><span class='Ref_to_Global_Var'>waiting</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected EOF on self-pipe"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="latch.c.html#LN1522"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="latch.c.html#LN1521"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* we successfully drained the pipe; no need to read() again */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* else buffer wasn't big enough, so read again */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end drainSelfPipe &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* !WIN32 */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>