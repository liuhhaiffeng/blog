<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\ipc\shm_mq.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\ipc\shm_mq.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * shm_mq.c 
 *    single-reader, single-writer shared memory message queue 
 * 
 * Both the sender and the receiver must have a PGPROC; their respective 
 * process latches are used for synchronization.  Only the sender may send, 
 * and only the receiver may receive.  This is intended to allow a user 
 * backend to communicate with worker backends that it has registered. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * src/include/storage/shm_mq.h 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgworker.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procsignal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shm_mq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This structure represents the actual queue, stored in shared memory. 
 * 
 * Some notes on synchronization: 
 * 
 * mq_receiver and mq_bytes_read can only be changed by the receiver; and 
 * mq_sender and mq_bytes_written can only be changed by the sender.  However, 
 * because most of these fields are 8 bytes and we don't assume that 8 byte 
 * reads and writes are atomic, the spinlock must be taken whenever the field 
 * is updated, and whenever it is read by a process other than the one allowed 
 * to modify it. But the process that is allowed to modify it is also allowed 
 * to read it without the lock.  On architectures where 8-byte writes are 
 * atomic, we could replace these spinlocks with memory barriers, but 
 * testing found no performance benefit, so it seems best to keep things 
 * simple for now. 
 * 
 * mq_detached can be set by either the sender or the receiver, so the mutex 
 * must be held to read or write it.  Memory barriers could be used here as 
 * well, if needed. 
 * 
 * mq_ring_size and mq_ring_offset never change after initialization, and 
 * can therefore be read without the lock. 
 * 
 * Importantly, mq_ring can be safely read and written without a lock.  Were 
 * this not the case, we'd have to hold the spinlock for much longer 
 * intervals, and performance might suffer.  Fortunately, that's not 
 * necessary.  At any given time, the difference between mq_bytes_read and 
 * mq_bytes_written defines the number of bytes within mq_ring that contain 
 * unread data, and mq_bytes_read defines the position where those bytes 
 * begin.  The sender can increase the number of unread bytes at any time, 
 * but only the receiver can give license to overwrite those bytes, by 
 * incrementing mq_bytes_read.  Therefore, it's safe for the receiver to read 
 * the unread bytes it knows to be present without the lock.  Conversely, 
 * the sender can write to the unused portion of the ring buffer without 
 * the lock, because nobody else can be reading or writing those bytes.  The 
 * receiver could be making more bytes unused by incrementing mq_bytes_read, 
 * but that's OK.  Note that it would be unsafe for the receiver to read any 
 * data it's already marked as read, or to write any data; and it would be 
 * unsafe for the sender to reread any data after incrementing 
 * mq_bytes_written, but fortunately there's no need for any of that. 
 */ 
</span><a name="LN68"></a><span class='Control'>struct</span> <span class='Declare_Struct'>shm_mq</span> 
<span class='Delimiter'>{ 
</span><a name="LN70"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mq_mutex</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>mq_receiver</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>mq_sender</span><span class='Delimiter'>; 
</span><a name="LN73"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Member'>mq_bytes_read</span><span class='Delimiter'>; 
</span><a name="LN74"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Member'>mq_bytes_written</span><span class='Delimiter'>; 
</span><a name="LN75"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>mq_ring_size</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>mq_detached</span><span class='Delimiter'>; 
</span><a name="LN77"></a>    <a href="../../../include/c.h.html#LN265"><span class='Ref_to_Typedef'>uint8</span></a>       <span class='Declare_Member'>mq_ring_offset</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>mq_ring</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This structure is a backend-private handle for access to a queue. 
 * 
 * mqh_queue is a pointer to the queue we've attached, and mqh_segment is 
 * a pointer to the dynamic shared memory segment that contains it. 
 * 
 * If this queue is intended to connect the current process with a background 
 * worker that started it, the user can pass a pointer to the worker handle 
 * to shm_mq_attach(), and we'll store it in mqh_handle.  The point of this 
 * is to allow us to begin sending to or receiving from that queue before the 
 * process we'll be communicating with has even been started.  If it fails 
 * to start, the handle will allow us to notice that and fail cleanly, rather 
 * than waiting forever; see shm_mq_wait_internal.  This is mostly useful in 
 * simple cases - e.g. where there are just 2 processes communicating; in 
 * more complex scenarios, every process may not have a BackgroundWorkerHandle 
 * available, or may need to watch for the failure of more than one other 
 * process at a time. 
 * 
 * When a message exists as a contiguous chunk of bytes in the queue - that is, 
 * it is smaller than the size of the ring buffer and does not wrap around 
 * the end - we return the message to the caller as a pointer into the buffer. 
 * For messages that are larger or happen to wrap, we reassemble the message 
 * locally by copying the chunks into a backend-local buffer.  mqh_buffer is 
 * the buffer, and mqh_buflen is the number of bytes allocated for it. 
 * 
 * mqh_partial_bytes, mqh_expected_bytes, and mqh_length_word_complete 
 * are used to track the state of non-blocking operations.  When the caller 
 * attempts a non-blocking operation that returns SHM_MQ_WOULD_BLOCK, they 
 * are expected to retry the call at a later time with the same argument; 
 * we need to retain enough state to pick up where we left off. 
 * mqh_length_word_complete tracks whether we are done sending or receiving 
 * (whichever we're doing) the entire length word.  mqh_partial_bytes tracks 
 * the number of bytes read or written for either the length word or the 
 * message itself, and mqh_expected_bytes - which is used only for reads - 
 * tracks the expected total size of the payload. 
 * 
 * mqh_counterparty_attached tracks whether we know the counterparty to have 
 * attached to the queue at some previous point.  This lets us avoid some 
 * mutex acquisitions. 
 * 
 * mqh_context is the memory context in effect at the time we attached to 
 * the shm_mq.  The shm_mq_handle itself is allocated in this context, and 
 * we make sure any other allocations we do happen in this context as well, 
 * to avoid nasty surprises. 
 */ 
</span><a name="LN126"></a><span class='Control'>struct</span> <span class='Declare_Struct'>shm_mq_handle</span> 
<span class='Delimiter'>{ 
</span><a name="LN128"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>mqh_queue</span><span class='Delimiter'>; 
</span><a name="LN129"></a>    <a href="dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Member'>mqh_segment</span><span class='Delimiter'>; 
</span><a name="LN130"></a>    <a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Member'>mqh_handle</span><span class='Delimiter'>; 
</span><a name="LN131"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>mqh_buffer</span><span class='Delimiter'>; 
</span><a name="LN132"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>mqh_buflen</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>mqh_consume_pending</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>mqh_partial_bytes</span><span class='Delimiter'>; 
</span><a name="LN135"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>mqh_expected_bytes</span><span class='Delimiter'>; 
</span><a name="LN136"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>mqh_length_word_complete</span><span class='Delimiter'>; 
</span><a name="LN137"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>mqh_counterparty_attached</span><span class='Delimiter'>; 
</span><a name="LN138"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>mqh_context</span><span class='Delimiter'>; 
}; 
</span> 
<a name="LN141"></a><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Prototype'>shm_mq_send_bytes</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>nbytes</span><span class='Delimiter'>, 
</span><a name="LN142"></a>                  <span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bytes_written</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN143"></a><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Prototype'>shm_mq_receive_bytes</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>bytes_needed</span><span class='Delimiter'>, 
</span><a name="LN144"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nbytesp</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>datap</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN145"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>shm_mq_counterparty_gone</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, 
</span><a name="LN146"></a>                         <a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN147"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>shm_mq_wait_internal</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Operator'>* </span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, 
</span><a name="LN148"></a>                     <a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN149"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Prototype'>shm_mq_get_bytes_read</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>detached</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shm_mq_inc_bytes_read</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN151"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Prototype'>shm_mq_get_bytes_written</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>detached</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN152"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shm_mq_inc_bytes_written</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN153"></a><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Prototype'>shm_mq_notify_receiver</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN154"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>shm_mq_detach_callback</span><span class='Parentheses'>(</span><a href="dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Minimum queue size is enough for header and at least one chunk of data. */ 
</span><a name="LN157"></a><span class='Keyword'>const </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>  <span class='Declare_Var'>shm_mq_minimum_size</span> <span class='Operator'>= 
</span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a><span class='Delimiter'>, </span>mq_ring<span class='Parentheses'>))</span> <span class='Operator'>+ </span>MAXIMUM_ALIGNOF<span class='Delimiter'>; 
</span> 
<a name="LN160"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MQH_INITIAL_BUFSIZE</span>             <span class='Number'>8192</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a new shared message queue. 
 */ 
</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>* 
</span><a name="LN166"></a><span class='Declare_Function'>shm_mq_create</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>address</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN168"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN166"><span class='Ref_to_Parameter'>address</span></a><span class='Delimiter'>; 
</span><a name="LN169"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>data_offset</span> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a><span class='Delimiter'>, </span>mq_ring<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the size isn't MAXALIGN'd, just discard the odd bytes. */ 
</span>    <a href="shm_mq.c.html#LN166"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN599"><span class='Ref_to_Macro'>MAXALIGN_DOWN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN166"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Queue size must be large enough to hold some data. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN166"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="shm_mq.c.html#LN169"><span class='Ref_To_Local'>data_offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize queue header. */ 
</span>    <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN73"><span class='Ref_to_Member'>mq_bytes_read</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN75"><span class='Ref_to_Member'>mq_ring_size</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN166"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN169"><span class='Ref_To_Local'>data_offset</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN77"><span class='Ref_to_Member'>mq_ring_offset</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN169"><span class='Ref_To_Local'>data_offset</span></a> <span class='Operator'>- </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a><span class='Delimiter'>, </span>mq_ring<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN168"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set the identity of the process that will receive from a shared message 
 * queue. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN195"></a><span class='Declare_Function'>shm_mq_set_receiver</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN197"></a>    <span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vmq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN195"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span><a name="LN198"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>sender</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN195"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN197"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN197"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN195"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN198"><span class='Ref_To_Local'>sender</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN197"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN195"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN198"><span class='Ref_To_Local'>sender</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN198"><span class='Ref_To_Local'>sender</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set the identity of the process that will send to a shared message queue. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN214"></a><span class='Declare_Function'>shm_mq_set_sender</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN216"></a>    <span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vmq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN214"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span><a name="LN217"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>receiver</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN214"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN216"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN216"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN214"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN217"><span class='Ref_To_Local'>receiver</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN216"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN214"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN217"><span class='Ref_To_Local'>receiver</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN217"><span class='Ref_To_Local'>receiver</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the configured receiver. 
 */ 
</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>* 
</span><a name="LN233"></a><span class='Declare_Function'>shm_mq_get_receiver</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN235"></a>    <span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vmq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN233"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span><a name="LN236"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>receiver</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN233"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN236"><span class='Ref_To_Local'>receiver</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN235"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN233"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN236"><span class='Ref_To_Local'>receiver</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the configured sender. 
 */ 
</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>* 
</span><a name="LN249"></a><span class='Declare_Function'>shm_mq_get_sender</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN251"></a>    <span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vmq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN249"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span><a name="LN252"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>sender</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN249"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN252"><span class='Ref_To_Local'>sender</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN251"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN249"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN252"><span class='Ref_To_Local'>sender</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Attach to a shared message queue so we can send or receive messages. 
 * 
 * The memory context in effect at the time this function is called should 
 * be one which will last for at least as long as the message queue itself. 
 * We'll allocate the handle in that context, and future allocations that 
 * are needed to buffer incoming data will happen in that context as well. 
 * 
 * If seg != NULL, the queue will be automatically detached when that dynamic 
 * shared memory segment is detached. 
 * 
 * If handle != NULL, the queue can be read or written even before the 
 * other process has attached.  We'll wait for it to do so if needed.  The 
 * handle must be for a background worker initialized with bgw_notify_pid 
 * equal to our PID. 
 * 
 * shm_mq_detach() should be called when done.  This will free the 
 * shm_mq_handle and mark the queue itself as detached, so that our 
 * counterpart won't get stuck waiting for us to fill or drain the queue 
 * after we've already lost interest. 
 */ 
</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>* 
</span><a name="LN283"></a><span class='Declare_Function'>shm_mq_attach</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Delimiter'>, </span><a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN285"></a>    <a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Local'>mqh</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a> <span class='Operator'>|| </span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN129"><span class='Ref_to_Member'>mqh_segment</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>seg</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>handle</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN138"><span class='Ref_to_Member'>mqh_context</span></a> <span class='Operator'>= </span><a href="../../utils/mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN137"><span class='Ref_to_Member'>mqh_counterparty_attached</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/dsm.h.html#LN56"><span class='Ref_to_Proto'>on_dsm_detach</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>seg</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN154"><span class='Ref_to_Proto'>shm_mq_detach_callback</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN283"><span class='Ref_to_Parameter'>mq</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN285"><span class='Ref_To_Local'>mqh</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_attach &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Associate a BackgroundWorkerHandle with a shm_mq_handle just as if it had 
 * been passed to shm_mq_attach. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN310"></a><span class='Declare_Function'>shm_mq_set_handle</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Delimiter'>, </span><a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN310"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN310"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN310"><span class='Ref_to_Parameter'>handle</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write a message into a shared message queue. 
 */ 
</span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN320"></a><span class='Declare_Function'>shm_mq_send</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>nbytes</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN322"></a>    <a href="../../../include/storage/shm_mq.h.html#LN28"><span class='Ref_to_Typedef'>shm_mq_iovec</span></a> <span class='Declare_Local'>iov</span><span class='Delimiter'>; 
</span> 
    <a href="shm_mq.c.html#LN322"><span class='Ref_To_Local'>iov</span></a><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN30"><span class='Ref_to_Member'>data</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN320"><span class='Ref_to_Parameter'>data</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN322"><span class='Ref_To_Local'>iov</span></a><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN320"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN73"><span class='Ref_to_Proto'>shm_mq_sendv</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN320"><span class='Ref_to_Parameter'>mqh</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN322"><span class='Ref_To_Local'>iov</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN320"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write a message into a shared message queue, gathered from multiple 
 * addresses. 
 * 
 * When nowait = false, we'll wait on our process latch when the ring buffer 
 * fills up, and then continue writing once the receiver has drained some data. 
 * The process latch is reset after each wait. 
 * 
 * When nowait = true, we do not manipulate the state of the process latch; 
 * instead, if the buffer becomes full, we return SHM_MQ_WOULD_BLOCK.  In 
 * this case, the caller should call this function again, with the same 
 * arguments, each time the process latch is set.  (Once begun, the sending 
 * of a message cannot be aborted except by detaching from the queue; changing 
 * the length or payload will corrupt the queue.) 
 */ 
</span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN346"></a><span class='Declare_Function'>shm_mq_sendv</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Delimiter'>, </span><a href="../../../include/storage/shm_mq.h.html#LN28"><span class='Ref_to_Typedef'>shm_mq_iovec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>iov</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>iovcnt</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN348"></a>    <a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN349"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a><span class='Delimiter'>; 
</span><a name="LN350"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nbytes</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN351"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>bytes_written</span><span class='Delimiter'>; 
</span><a name="LN352"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN353"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>which_iov</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN354"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN349"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute total size of write. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN352"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="shm_mq.c.html#LN352"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iovcnt</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="shm_mq.c.html#LN352"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <a href="shm_mq.c.html#LN350"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN352"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Try to write, or finish writing, the length word into the buffer. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN141"><span class='Ref_to_Proto'>shm_mq_send_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN350"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span> <span class='Operator'>+</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>, 
</span>                                <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Reset state in case caller tries to send another message. */ 
</span>            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Length word can't be split unless bigger than required alignment. */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>|| </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span>MAXIMUM_ALIGNOF<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !mqh-&GT;mqh_length_word... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Write the actual data bytes into the buffer. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&LT;= </span><a href="shm_mq.c.html#LN350"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN399"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>chunksize</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Figure out which bytes need to be sent next. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>-= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>++</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iovcnt</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We want to avoid copying the data if at all possible, but every 
         * chunk of bytes we write into the queue has to be MAXALIGN'd, except 
         * the last.  Thus, if a chunk other than the last one ends on a 
         * non-MAXALIGN'd boundary, we have to combine the tail end of its 
         * data with data from one or more following chunks until we either 
         * reach the last chunk or accumulate a number of bytes which is 
         * MAXALIGN'd. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iovcnt</span></a> <span class='Operator'>&& 
</span>            <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span>MAXIMUM_ALIGNOF <span class='Operator'>&GT; </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN423"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>tmpbuf</span><span class='Delimiter'>[</span>MAXIMUM_ALIGNOF<span class='Delimiter'>]; 
</span><a name="LN424"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="shm_mq.c.html#LN423"><span class='Ref_To_Local'>tmpbuf</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN424"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN30"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>]; 
</span>                    <a href="shm_mq.c.html#LN424"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN424"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>== </span>MAXIMUM_ALIGNOF<span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>-= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span>                    <a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iovcnt</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN141"><span class='Ref_to_Proto'>shm_mq_send_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN424"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN423"><span class='Ref_To_Local'>tmpbuf</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Reset state in case caller tries to send another message. */ 
</span>                <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if which_iov+1&LT;iovcnt&&o... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If this is the last chunk, we can write all the data, even if it 
         * isn't a multiple of MAXIMUM_ALIGNOF.  Otherwise, we need to 
         * MAXALIGN_DOWN the write size. 
         */ 
</span>        <a href="shm_mq.c.html#LN399"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN31"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iovcnt</span></a><span class='Parentheses'>) 
</span>            <a href="shm_mq.c.html#LN399"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN599"><span class='Ref_to_Macro'>MAXALIGN_DOWN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN399"><span class='Ref_To_Local'>chunksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN141"><span class='Ref_to_Proto'>shm_mq_send_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN399"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>iov</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN353"><span class='Ref_To_Local'>which_iov</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/shm_mq.h.html#LN30"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>], 
</span>                                <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Reset state in case caller tries to send another message. */ 
</span>            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN354"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN351"><span class='Ref_To_Local'>bytes_written</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN348"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN350"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reset for next message. */ 
</span>    <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN346"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Notify receiver of the newly-written data, and return. */ 
</span>    <span class='Control'>return</span> <a href="shm_mq.c.html#LN153"><span class='Ref_to_Proto'>shm_mq_notify_receiver</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN349"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_sendv &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Receive a message from a shared message queue. 
 * 
 * We set *nbytes to the message length and *data to point to the message 
 * payload.  If the entire message exists in the queue as a single, 
 * contiguous chunk, *data will point directly into shared memory; otherwise, 
 * it will point to a temporary buffer.  This mostly avoids data copying in 
 * the hoped-for case where messages are short compared to the buffer size, 
 * while still allowing longer messages.  In either case, the return value 
 * remains valid until the next receive operation is performed on the queue. 
 * 
 * When nowait = false, we'll wait on our process latch when the ring buffer 
 * is empty and we have not yet received a full message.  The sender will 
 * set our process latch after more data has been written, and we'll resume 
 * processing.  Each call will therefore return a complete message 
 * (unless the sender detaches the queue). 
 * 
 * When nowait = true, we do not manipulate the state of the process latch; 
 * instead, whenever the buffer is empty and we need to read from it, we 
 * return SHM_MQ_WOULD_BLOCK.  In this case, the caller should call this 
 * function again after the process latch has been set. 
 */ 
</span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN517"></a><span class='Declare_Function'>shm_mq_receive</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nbytesp</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>datap</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN519"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a><span class='Delimiter'>; 
</span><a name="LN520"></a>    <a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN521"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>rb</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN522"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN523"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawdata</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can't receive data until the sender has attached. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN137"><span class='Ref_to_Member'>mqh_counterparty_attached</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN532"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>counterparty_gone</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We shouldn't return at this point at all unless the sender 
             * hasn't attached yet.  However, the correct return value depends 
             * on whether the sender is still attached.  If we first test 
             * whether the sender has ever attached and then test whether the 
             * sender has detached, there's a race condition: a sender that 
             * attaches and detaches very quickly might fool us into thinking 
             * the sender never attached at all.  So, test whether our 
             * counterparty is definitively gone first, and only afterwards 
             * check whether the sender ever attached in the first place. 
             */ 
</span>            <a href="shm_mq.c.html#LN532"><span class='Ref_To_Local'>counterparty_gone</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN145"><span class='Ref_to_Proto'>shm_mq_counterparty_gone</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/shm_mq.h.html#LN55"><span class='Ref_to_Proto'>shm_mq_get_sender</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN532"><span class='Ref_To_Local'>counterparty_gone</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN38"><span class='Ref_to_EnumConst'>SHM_MQ_WOULD_BLOCK</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nowait &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="shm_mq.c.html#LN147"><span class='Ref_to_Proto'>shm_mq_wait_internal</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a><span class='Parentheses'>) 
</span>                 <span class='Operator'>&& </span><a href="../../../include/storage/shm_mq.h.html#LN55"><span class='Ref_to_Proto'>shm_mq_get_sender</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN137"><span class='Ref_to_Member'>mqh_counterparty_attached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !mqh-&GT;mqh_counterpart... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Consume any zero-copy data from previous receive operation. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="shm_mq.c.html#LN150"><span class='Ref_to_Proto'>shm_mq_inc_bytes_read</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Try to read, or finish reading, the length word from the buffer. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Try to receive the message length word. */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&LT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN143"><span class='Ref_to_Proto'>shm_mq_receive_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>, 
</span>                                   <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Hopefully, we'll receive the entire message length word at once. 
         * But if sizeof(Size) &GT; MAXIMUM_ALIGNOF, then it might be split over 
         * multiple reads. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN587"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>needed</span><span class='Delimiter'>; 
</span> 
            <a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= *</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we've already got the whole message, we're done. */ 
</span>            <a href="shm_mq.c.html#LN587"><span class='Ref_To_Local'>needed</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN587"><span class='Ref_To_Local'>needed</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Technically, we could consume the message length 
                 * information at this point, but the extra write to shared 
                 * memory wouldn't be free and in most cases we would reap no 
                 * benefit. 
                 */ 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN587"><span class='Ref_To_Local'>needed</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nbytesp</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>datap</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We don't have the whole message, but we at least have the whole 
             * length word. 
             */ 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN135"><span class='Ref_to_Member'>mqh_expected_bytes</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN150"><span class='Ref_to_Proto'>shm_mq_inc_bytes_read</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>-= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mqh-&GT;mqh_partial_byte... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN618"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>lengthbytes</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Can't be split unless bigger than required alignment. */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span>MAXIMUM_ALIGNOF<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Message word is split; need buffer to reassemble. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN138"><span class='Ref_to_Member'>mqh_context</span></a><span class='Delimiter'>, 
</span>                                                     <a href="shm_mq.c.html#LN160"><span class='Ref_to_Const'>MQH_INITIAL_BUFSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN160"><span class='Ref_to_Const'>MQH_INITIAL_BUFSIZE</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Copy and consume partial length word. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&GT; </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span> 
                <a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>], </span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Delimiter'>, 
</span>                   <a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN150"><span class='Ref_to_Proto'>shm_mq_inc_bytes_read</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>-= </span><a href="shm_mq.c.html#LN618"><span class='Ref_To_Local'>lengthbytes</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we now have the whole word, we're ready to read payload. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&GT;= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN135"><span class='Ref_to_Member'>mqh_expected_bytes</span></a> <span class='Operator'>= *</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !mqh-&GT;mqh_length_word... &raquo; </span> 
    <a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN135"><span class='Ref_to_Member'>mqh_expected_bytes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Try to obtain the whole message in a single chunk.  If this works, 
         * we need not copy the data and can return a pointer directly into 
         * shared memory. 
         */ 
</span>        <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN143"><span class='Ref_to_Proto'>shm_mq_receive_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN133"><span class='Ref_to_Member'>mqh_consume_pending</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nbytesp</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>datap</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The message has wrapped the buffer.  We'll need to copy it in order 
         * to return it to the client in one chunk.  First, make sure we have 
         * a large enough buffer available. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN681"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newbuflen</span> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN160"><span class='Ref_to_Const'>MQH_INITIAL_BUFSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN681"><span class='Ref_To_Local'>newbuflen</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>) 
</span>                <a href="shm_mq.c.html#LN681"><span class='Ref_To_Local'>newbuflen</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN138"><span class='Ref_to_Member'>mqh_context</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN681"><span class='Ref_To_Local'>newbuflen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN132"><span class='Ref_to_Member'>mqh_buflen</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN681"><span class='Ref_To_Local'>newbuflen</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mqh-&GT;mqh_partial_byte... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Loop until we've copied the entire message. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN700"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>still_needed</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Copy as much as we can. */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&LT;= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>], </span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update count of bytes read, with alignment padding.  Note that this 
         * will never actually insert any padding except at the end of a 
         * message, because the buffer size is a multiple of MAXIMUM_ALIGNOF, 
         * and each read and write is as well. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>== </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>|| </span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN150"><span class='Ref_to_Proto'>shm_mq_inc_bytes_read</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we got all the data, exit the loop. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Wait for some more data. */ 
</span>        <a href="shm_mq.c.html#LN700"><span class='Ref_To_Local'>still_needed</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN143"><span class='Ref_to_Proto'>shm_mq_receive_bytes</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN519"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN700"><span class='Ref_To_Local'>still_needed</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nowait</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN523"><span class='Ref_To_Local'>rawdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="shm_mq.c.html#LN520"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>&GT; </span><a href="shm_mq.c.html#LN700"><span class='Ref_To_Local'>still_needed</span></a><span class='Parentheses'>) 
</span>            <a href="shm_mq.c.html#LN521"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN700"><span class='Ref_To_Local'>still_needed</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Return the complete message, and reset for next message. */ 
</span>    <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>nbytesp</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN522"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>datap</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN131"><span class='Ref_to_Member'>mqh_buffer</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN136"><span class='Ref_to_Member'>mqh_length_word_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN517"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN134"><span class='Ref_to_Member'>mqh_partial_bytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_receive &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait for the other process that's supposed to use this queue to attach 
 * to it. 
 * 
 * The return value is SHM_MQ_DETACHED if the worker has already detached or 
 * if it dies; it is SHM_MQ_SUCCESS if we detect that the worker has attached. 
 * Note that we will only be able to detect that the worker has died before 
 * attaching if a background worker handle was passed to shm_mq_attach(). 
 */ 
</span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN747"></a><span class='Declare_Function'>shm_mq_wait_for_attach</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN749"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN747"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a><span class='Delimiter'>; 
</span><a name="LN750"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>    <span class='Operator'>**</span><span class='Declare_Local'>victim</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/shm_mq.h.html#LN54"><span class='Ref_to_Proto'>shm_mq_get_receiver</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN749"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span> 
        <a href="shm_mq.c.html#LN750"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= &</span><a href="shm_mq.c.html#LN749"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/shm_mq.h.html#LN55"><span class='Ref_to_Proto'>shm_mq_get_sender</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN749"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN750"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= &</span><a href="shm_mq.c.html#LN749"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN147"><span class='Ref_to_Proto'>shm_mq_wait_internal</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN749"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN750"><span class='Ref_To_Local'>victim</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN747"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Detach a shared message queue. 
 * 
 * The purpose of this function is to make sure that the process 
 * with which we're communicating doesn't block forever waiting for us to 
 * fill or drain the queue once we've lost interest.  When the sender 
 * detaches, the receiver can read any messages remaining in the queue; 
 * further reads will return SHM_MQ_DETACHED.  If the receiver detaches, 
 * further attempts to send messages will likewise return SHM_MQ_DETACHED. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN777"></a><span class='Declare_Function'>shm_mq_detach</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN779"></a>    <span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vmq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN777"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>; 
</span><a name="LN780"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>victim</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN777"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN779"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>) 
</span>        <a href="shm_mq.c.html#LN780"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN779"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN779"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a> <span class='Operator'>== </span><a href="../lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN780"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN779"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="shm_mq.c.html#LN779"><span class='Ref_To_Local'>vmq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN777"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN780"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN780"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_detach &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get the shm_mq from handle. 
 */ 
</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>* 
</span><a name="LN801"></a><span class='Declare_Function'>shm_mq_get_queue</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="shm_mq.c.html#LN801"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write bytes into a shared message queue. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN810"></a><span class='Declare_Function'>shm_mq_send_bytes</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN126"><span class='Ref_to_Struct'>shm_mq_handle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mqh</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>nbytes</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Delimiter'>, 
</span><a name="LN811"></a>                  <span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>bytes_written</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN813"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN128"><span class='Ref_to_Member'>mqh_queue</span></a><span class='Delimiter'>; 
</span><a name="LN814"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sent</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN815"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>used</span><span class='Delimiter'>; 
</span><a name="LN816"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>ringsize</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN75"><span class='Ref_to_Member'>mq_ring_size</span></a><span class='Delimiter'>; 
</span><a name="LN817"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>available</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a> <span class='Operator'>&LT; </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN821"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>detached</span><span class='Delimiter'>; 
</span><a name="LN822"></a>        <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>rb</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Compute number of ring buffer bytes used and available. */ 
</span>        <a href="shm_mq.c.html#LN822"><span class='Ref_To_Local'>rb</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN149"><span class='Ref_to_Proto'>shm_mq_get_bytes_read</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN821"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN822"><span class='Ref_To_Local'>rb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN815"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN822"><span class='Ref_To_Local'>rb</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN815"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&LT;= </span><a href="shm_mq.c.html#LN816"><span class='Ref_To_Local'>ringsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN817"><span class='Ref_To_Local'>available</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN816"><span class='Ref_To_Local'>ringsize</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN815"><span class='Ref_To_Local'>used</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Bail out if the queue has been detached. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN821"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN817"><span class='Ref_To_Local'>available</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN137"><span class='Ref_to_Member'>mqh_counterparty_attached</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The queue is full, so if the receiver isn't yet known to be 
             * attached, we must wait for that to happen. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN145"><span class='Ref_to_Proto'>shm_mq_counterparty_gone</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/shm_mq.h.html#LN54"><span class='Ref_to_Proto'>shm_mq_get_receiver</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN38"><span class='Ref_to_EnumConst'>SHM_MQ_WOULD_BLOCK</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="shm_mq.c.html#LN147"><span class='Ref_to_Proto'>shm_mq_wait_internal</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>, 
</span>                                           <a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN130"><span class='Ref_to_Member'>mqh_handle</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>mqh</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN137"><span class='Ref_to_Member'>mqh_counterparty_attached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The receiver may have read some data after attaching, so we 
             * must not wait without rechecking the queue state. 
             */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if available==0&&!mqh-&GT;m... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN817"><span class='Ref_To_Local'>available</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN873"></a>            <a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Let the receiver know that we need them to read some data. */ 
</span>            <a href="shm_mq.c.html#LN873"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN153"><span class='Ref_to_Proto'>shm_mq_notify_receiver</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN873"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="shm_mq.c.html#LN873"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Skip manipulation of our latch if nowait = true. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN38"><span class='Ref_to_EnumConst'>SHM_MQ_WOULD_BLOCK</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Wait for our latch to be set.  It might already be set for some 
             * unrelated reason, but that'll just result in one extra trip 
             * through the loop.  It's worth it to avoid resetting the latch 
             * at top of loop, because setting an already-set latch is much 
             * cheaper than setting one that has been reset. 
             */ 
</span>            <a href="../../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN807"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_SEND</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Reset the latch so we don't spin. */ 
</span>            <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* An interrupt may have occurred while we were waiting. */ 
</span>            <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if available==0 &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN907"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>offset</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a> <span class='Operator'>% </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN816"><span class='Ref_To_Local'>ringsize</span></a><span class='Delimiter'>; 
</span><a name="LN908"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sendnow</span> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN817"><span class='Ref_To_Local'>available</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN816"><span class='Ref_To_Local'>ringsize</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN907"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Write as much data as we can via a single memcpy(). */ 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN78"><span class='Ref_to_Member'>mq_ring</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN77"><span class='Ref_to_Member'>mq_ring_offset</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN907"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>], 
</span>                   <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>data</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN908"><span class='Ref_To_Local'>sendnow</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN908"><span class='Ref_To_Local'>sendnow</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Update count of bytes written, with alignment padding.  Note 
             * that this will never actually insert any padding except at the 
             * end of a run of bytes, because the buffer size is a multiple of 
             * MAXIMUM_ALIGNOF, and each read is as well. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a> <span class='Operator'>== </span><a href="shm_mq.c.html#LN810"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>|| </span><a href="shm_mq.c.html#LN908"><span class='Ref_To_Local'>sendnow</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN908"><span class='Ref_To_Local'>sendnow</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN152"><span class='Ref_to_Proto'>shm_mq_inc_bytes_written</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN813"><span class='Ref_To_Local'>mq</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN908"><span class='Ref_To_Local'>sendnow</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * For efficiency, we don't set the reader's latch here.  We'll do 
             * that only when the buffer fills up or after writing an entire 
             * message. 
             */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while sent&LT;nbytes &raquo; </span> 
 
    <span class='Operator'>*</span><a href="shm_mq.c.html#LN811"><span class='Ref_to_Parameter'>bytes_written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN814"><span class='Ref_To_Local'>sent</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_send_bytes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Wait until at least *nbytesp bytes are available to be read from the 
 * shared message queue, or until the buffer wraps around.  If the queue is 
 * detached, returns SHM_MQ_DETACHED.  If nowait is specified and a wait 
 * would be required, returns SHM_MQ_WOULD_BLOCK.  Otherwise, *datap is set 
 * to the location at which data bytes can be read, *nbytesp is set to the 
 * number of bytes which can be read at that address, and the return value 
 * is SHM_MQ_SUCCESS. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN946"></a><span class='Declare_Function'>shm_mq_receive_bytes</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>bytes_needed</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>nowait</span><span class='Delimiter'>, 
</span><a name="LN947"></a>                     <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>nbytesp</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>datap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN949"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>ringsize</span> <span class='Operator'>= </span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN75"><span class='Ref_to_Member'>mq_ring_size</span></a><span class='Delimiter'>; 
</span><a name="LN950"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>used</span><span class='Delimiter'>; 
</span><a name="LN951"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>written</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN955"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN956"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>detached</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get bytes written, so we can compute what's available to read. */ 
</span>        <a href="shm_mq.c.html#LN951"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN151"><span class='Ref_to_Proto'>shm_mq_get_bytes_written</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN956"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN950"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN951"><span class='Ref_To_Local'>written</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN73"><span class='Ref_to_Member'>mq_bytes_read</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN950"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&LT;= </span><a href="shm_mq.c.html#LN949"><span class='Ref_To_Local'>ringsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN955"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN73"><span class='Ref_to_Member'>mq_bytes_read</span></a> <span class='Operator'>% </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="shm_mq.c.html#LN949"><span class='Ref_To_Local'>ringsize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we have enough data or buffer has wrapped, we're done. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN950"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>bytes_needed</span></a> <span class='Operator'>|| </span><a href="shm_mq.c.html#LN955"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN950"><span class='Ref_To_Local'>used</span></a> <span class='Operator'>&GT;= </span><a href="shm_mq.c.html#LN949"><span class='Ref_To_Local'>ringsize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="shm_mq.c.html#LN947"><span class='Ref_to_Parameter'>nbytesp</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN950"><span class='Ref_To_Local'>used</span></a><span class='Delimiter'>, </span><a href="shm_mq.c.html#LN949"><span class='Ref_To_Local'>ringsize</span></a> <span class='Operator'>- </span><a href="shm_mq.c.html#LN955"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="shm_mq.c.html#LN947"><span class='Ref_to_Parameter'>datap</span></a> <span class='Operator'>= &</span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN78"><span class='Ref_to_Member'>mq_ring</span></a><span class='Delimiter'>[</span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN77"><span class='Ref_to_Member'>mq_ring_offset</span></a> <span class='Operator'>+ </span><a href="shm_mq.c.html#LN955"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fall out before waiting if the queue has been detached. 
         * 
         * Note that we don't check for this until *after* considering whether 
         * the data already available is enough, since the receiver can finish 
         * receiving a message stored in the buffer even after the sender has 
         * detached. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN956"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Skip manipulation of our latch if nowait = true. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN946"><span class='Ref_to_Parameter'>nowait</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN38"><span class='Ref_to_EnumConst'>SHM_MQ_WOULD_BLOCK</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Wait for our latch to be set.  It might already be set for some 
         * unrelated reason, but that'll just result in one extra trip through 
         * the loop.  It's worth it to avoid resetting the latch at top of 
         * loop, because setting an already-set latch is much cheaper than 
         * setting one that has been reset. 
         */ 
</span>        <a href="../../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN806"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_RECEIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Reset the latch so we don't spin. */ 
</span>        <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* An interrupt may have occurred while we were waiting. */ 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end shm_mq_receive_bytes &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Test whether a counterparty who may not even be alive yet is definitely gone. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1008"></a><span class='Declare_Function'>shm_mq_counterparty_gone</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1010"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>detached</span><span class='Delimiter'>; 
</span><a name="LN1011"></a>    <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Acquire the lock just long enough to check the pointer. */ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1010"><span class='Ref_To_Local'>detached</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the queue has been detached, counterparty is definitely gone. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1010"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there's a handle, check worker status. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>handle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1025"></a>        <a href="../../../include/postmaster/bgworker.h.html#LN100"><span class='Ref_to_Enum'>BgwHandleStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for unexpected worker death. */ 
</span>        <a href="shm_mq.c.html#LN1025"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/postmaster/bgworker.h.html#LN119"><span class='Ref_to_Proto'>GetBackgroundWorkerPid</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>handle</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1011"><span class='Ref_To_Local'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1025"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/postmaster/bgworker.h.html#LN102"><span class='Ref_to_EnumConst'>BGWH_STARTED</span></a> <span class='Operator'>&& </span><a href="shm_mq.c.html#LN1025"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/postmaster/bgworker.h.html#LN103"><span class='Ref_to_EnumConst'>BGWH_NOT_YET_STARTED</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Mark it detached, just to make it official. */ 
</span>            <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1008"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Counterparty is not definitively gone. */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_counterparty_gone &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This is used when a process is waiting for its counterpart to attach to the 
 * queue.  We exit when the other process attaches as expected, or, if 
 * handle != NULL, when the referenced background process or the postmaster 
 * dies.  Note that if handle == NULL, and the process fails to attach, we'll 
 * potentially get stuck here forever waiting for a process that may never 
 * start.  We do check for interrupts, though. 
 * 
 * ptr is a pointer to the memory address that we're expecting to become 
 * non-NULL when our counterpart attaches to the queue. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1055"></a><span class='Declare_Function'>shm_mq_wait_internal</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Operator'>* </span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, 
</span><a name="LN1056"></a>                     <a href="../../postmaster/bgworker.c.html#LN104"><span class='Ref_to_Struct'>BackgroundWorkerHandle</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1058"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1062"></a>        <a href="../../../include/postmaster/bgworker.h.html#LN100"><span class='Ref_to_Enum'>BgwHandleStatus</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1063"></a>        <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>pid</span><span class='Delimiter'>; 
</span><a name="LN1064"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>detached</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Acquire the lock just long enough to check the pointer. */ 
</span>        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1055"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN1064"><span class='Ref_To_Local'>detached</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1055"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a><span class='Delimiter'>; 
</span>        <a href="shm_mq.c.html#LN1058"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="shm_mq.c.html#LN1055"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1055"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fail if detached; else succeed if initialized. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1064"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="shm_mq.c.html#LN1058"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1058"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1056"><span class='Ref_to_Parameter'>handle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Check for unexpected worker death. */ 
</span>            <a href="shm_mq.c.html#LN1062"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/postmaster/bgworker.h.html#LN119"><span class='Ref_to_Proto'>GetBackgroundWorkerPid</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1056"><span class='Ref_to_Parameter'>handle</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1063"><span class='Ref_To_Local'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1062"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/postmaster/bgworker.h.html#LN102"><span class='Ref_to_EnumConst'>BGWH_STARTED</span></a> <span class='Operator'>&& </span><a href="shm_mq.c.html#LN1062"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/postmaster/bgworker.h.html#LN103"><span class='Ref_to_EnumConst'>BGWH_NOT_YET_STARTED</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="shm_mq.c.html#LN1058"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Wait to be signalled. */ 
</span>        <a href="../../../include/storage/latch.h.html#LN163"><span class='Ref_to_Proto'>WaitLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN804"><span class='Ref_to_EnumConst'>WAIT_EVENT_MQ_INTERNAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Reset the latch so we don't spin. */ 
</span>        <a href="../../../include/storage/latch.h.html#LN152"><span class='Ref_to_Proto'>ResetLatch</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* An interrupt may have occurred while we were waiting. */ 
</span>        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN1058"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end shm_mq_wait_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get the number of bytes read.  The receiver need not use this to access 
 * the count of bytes read, but the sender must. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> 
<a name="LN1110"></a><span class='Declare_Function'>shm_mq_get_bytes_read</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>detached</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1112"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1110"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1112"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1110"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN73"><span class='Ref_to_Member'>mq_bytes_read</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="shm_mq.c.html#LN1110"><span class='Ref_to_Parameter'>detached</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1110"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1110"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN1112"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Increment the number of bytes read. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1126"></a><span class='Declare_Function'>shm_mq_inc_bytes_read</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1128"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>sender</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1126"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1126"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN73"><span class='Ref_to_Member'>mq_bytes_read</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN1126"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1128"><span class='Ref_To_Local'>sender</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1126"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN72"><span class='Ref_to_Member'>mq_sender</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1126"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We shouldn't have any bytes to read without a sender. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1128"><span class='Ref_To_Local'>sender</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1128"><span class='Ref_To_Local'>sender</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get the number of bytes written.  The sender need not use this to access 
 * the count of bytes written, but the receiver must. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> 
<a name="LN1145"></a><span class='Declare_Function'>shm_mq_get_bytes_written</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>detached</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1147"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1145"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1147"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1145"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="shm_mq.c.html#LN1145"><span class='Ref_to_Parameter'>detached</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1145"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1145"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="shm_mq.c.html#LN1147"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Increment the number of bytes written. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1161"></a><span class='Declare_Function'>shm_mq_inc_bytes_written</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1161"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1161"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN74"><span class='Ref_to_Member'>mq_bytes_written</span></a> <span class='Operator'>+= </span><a href="shm_mq.c.html#LN1161"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1161"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set receiver's latch, unless queue is detached. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/shm_mq.h.html#LN35"><span class='Ref_to_Typedef'>shm_mq_result</span></a> 
<a name="LN1172"></a><span class='Declare_Function'>shm_mq_notify_receiver</span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mq</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1174"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>receiver</span><span class='Delimiter'>; 
</span><a name="LN1175"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>detached</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1172"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1175"><span class='Ref_To_Local'>detached</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1172"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN76"><span class='Ref_to_Member'>mq_detached</span></a><span class='Delimiter'>; 
</span>    <a href="shm_mq.c.html#LN1174"><span class='Ref_To_Local'>receiver</span></a> <span class='Operator'>= </span><a href="shm_mq.c.html#LN1172"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN71"><span class='Ref_to_Member'>mq_receiver</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1172"><span class='Ref_to_Parameter'>mq</span></a><span class='Operator'>-&GT;</span><a href="shm_mq.c.html#LN70"><span class='Ref_to_Member'>mq_mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1175"><span class='Ref_To_Local'>detached</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN39"><span class='Ref_to_EnumConst'>SHM_MQ_DETACHED</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1174"><span class='Ref_To_Local'>receiver</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="shm_mq.c.html#LN1174"><span class='Ref_To_Local'>receiver</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/shm_mq.h.html#LN37"><span class='Ref_to_EnumConst'>SHM_MQ_SUCCESS</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Shim for on_dsm_callback. */ 
</span><span class='Keyword'>static void 
</span><a name="LN1191"></a><span class='Declare_Function'>shm_mq_detach_callback</span><span class='Parentheses'>(</span><a href="dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1193"></a>    <a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>mq</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN68"><span class='Ref_to_Struct'>shm_mq</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1191"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/shm_mq.h.html#LN65"><span class='Ref_to_Proto'>shm_mq_detach</span></a><span class='Parentheses'>(</span><a href="shm_mq.c.html#LN1193"><span class='Ref_To_Local'>mq</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>