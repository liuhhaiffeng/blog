<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\large_object\inv_api.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\large_object\inv_api.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * inv_api.c 
 *    routines for manipulating inversion fs large objects. This file 
 *    contains the user-level large object application interface routines. 
 * 
 * 
 * Note: we access pg_largeobject.data using its C struct declaration. 
 * This is safe because it immediately follows pageno which is an int4 field, 
 * and therefore the data field will always be 4-byte aligned, even if it 
 * is in the short 1-byte-header format.  We have to detoast it since it's 
 * quite likely to be in compressed or short format.  We also need to check 
 * for NULLs, since initdb will mark loid and pageno but not data as NOT NULL. 
 * 
 * Note: many of these routines leak memory in CurrentMemoryContext, as indeed 
 * does most of the backend code.  We expect that CurrentMemoryContext will 
 * be a short-lived context.  Data that must persist across function calls 
 * is kept either in CacheMemoryContext (the Relation structs) or in the 
 * memory context given to inv_open (for LargeObjectDesc structs). 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/large_object/inv_api.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/genam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/heapam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/tuptoaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/dependency.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/indexing.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/objectaccess.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_largeobject.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_largeobject_metadata.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq-fs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/large_object.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * All accesses to pg_largeobject and its index make use of a single Relation 
 * reference, so that we only need to open pg_relation once per transaction. 
 * To avoid problems when the first such reference occurs inside a 
 * subtransaction, we execute a slightly klugy maneuver to assign ownership of 
 * the Relation reference to TopTransactionResourceOwner. 
 */ 
</span><a name="LN60"></a><span class='Keyword'>static </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Var'>lo_heap_r</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Var'>lo_index_r</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Open pg_largeobject and its index, if not already done in current xact 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN68"></a><span class='Declare_Function'>open_lo_relation</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN70"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>currentOwner</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a> <span class='Operator'>&& </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* already open in current xact */ 
</span> 
    <span class='Comment_Multi_Line'>/* Arrange for the top xact to own these relation references */ 
</span>    <a href="inv_api.c.html#LN70"><span class='Ref_To_Local'>currentOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Use RowExclusiveLock since we might either read or write */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN129"><span class='Ref_to_Proto'>index_open</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/indexing.h.html#LN179"><span class='Ref_to_Const'>LargeObjectLOidPNIndexId</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Ensure CurrentResourceOwner is restored on error */ 
</span>        <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN70"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN70"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end open_lo_relation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Clean up at main transaction end 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN101"></a><span class='Declare_Function'>close_lo_relation</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a> <span class='Operator'>|| </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Only bother to close if committing; else abort cleanup will handle 
         * it 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN101"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN111"></a>            <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>currentOwner</span><span class='Delimiter'>; 
</span> 
            <a href="inv_api.c.html#LN111"><span class='Ref_To_Local'>currentOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/access/genam.h.html#LN130"><span class='Ref_to_Proto'>index_close</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Ensure CurrentResourceOwner is restored on error */ 
</span>                <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN111"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
</span>                <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN111"><span class='Ref_To_Local'>currentOwner</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isCommit &raquo; </span> 
        <a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lo_heap_r||lo_index_r &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end close_lo_relation &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Same as pg_largeobject.c's LargeObjectExists(), except snapshot to 
 * read with can be specified. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN143"></a><span class='Declare_Function'>myLargeObjectExists</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>loid</span><span class='Delimiter'>, </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN145"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pg_lo_meta</span><span class='Delimiter'>; 
</span><a name="LN146"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN147"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sd</span><span class='Delimiter'>; 
</span><a name="LN148"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN149"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>retval</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN146"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../../include/access/sysattr.h.html#LN21"><span class='Ref_to_Const'>ObjectIdAttributeNumber</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN143"><span class='Ref_to_Parameter'>loid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN145"><span class='Ref_To_Local'>pg_lo_meta</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject_metadata.h.html#LN28"><span class='Ref_to_Const'>LargeObjectMetadataRelationId</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN147"><span class='Ref_To_Local'>sd</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN189"><span class='Ref_to_Proto'>systable_beginscan</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN145"><span class='Ref_To_Local'>pg_lo_meta</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/catalog/indexing.h.html#LN182"><span class='Ref_to_Const'>LargeObjectMetadataOidIndexId</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                            <a href="inv_api.c.html#LN143"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN146"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN148"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN194"><span class='Ref_to_Proto'>systable_getnext</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN147"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN148"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
        <a href="inv_api.c.html#LN149"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/genam.h.html#LN196"><span class='Ref_to_Proto'>systable_endscan</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN147"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN145"><span class='Ref_To_Local'>pg_lo_meta</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN149"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end myLargeObjectExists &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Extract data field from a pg_largeobject tuple, detoasting if needed 
 * and verifying that the length is sane.  Returns data pointer (a bytea *), 
 * data length, and an indication of whether to pfree the data pointer. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN181"></a><span class='Declare_Function'>getdatafield</span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN182"></a>             <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>pdatafield</span><span class='Delimiter'>, 
</span><a name="LN183"></a>             <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>plen</span><span class='Delimiter'>, 
</span><a name="LN184"></a>             <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>pfreeit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN186"></a>    <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>datafield</span><span class='Delimiter'>; 
</span><a name="LN187"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN188"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>freeit</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN181"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span>data<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* see note at top of file */ 
</span>    <a href="inv_api.c.html#LN188"><span class='Ref_To_Local'>freeit</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN325"><span class='Ref_to_Macro'>VARATT_IS_EXTENDED</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/access/tuptoaster.h.html#LN163"><span class='Ref_to_Proto'>heap_tuple_untoast_attr</span></a><span class='Parentheses'>((</span><span class='Control'>struct</span> <a href="../../../include/c.h.html#LN438"><span class='Ref_to_Struct'>varlena</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN188"><span class='Ref_To_Local'>freeit</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="inv_api.c.html#LN187"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN187"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="inv_api.c.html#LN187"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pg_largeobject entry for OID %u, page %d has invalid data field size %d"</span><span class='Delimiter'>, 
</span>                        <a href="inv_api.c.html#LN181"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span>loid<span class='Delimiter'>, </span><a href="inv_api.c.html#LN181"><span class='Ref_to_Parameter'>tuple</span></a><span class='Operator'>-&GT;</span>pageno<span class='Delimiter'>, </span><a href="inv_api.c.html#LN187"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="inv_api.c.html#LN182"><span class='Ref_to_Parameter'>pdatafield</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN186"><span class='Ref_To_Local'>datafield</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="inv_api.c.html#LN183"><span class='Ref_to_Parameter'>plen</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN187"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="inv_api.c.html#LN184"><span class='Ref_to_Parameter'>pfreeit</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN188"><span class='Ref_To_Local'>freeit</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end getdatafield &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  inv_create -- create a new large object 
 * 
 *  Arguments: 
 *    lobjId - OID to use for new large object, or InvalidOid to pick one 
 * 
 *  Returns: 
 *    OID of new object 
 * 
 * If lobjId is not InvalidOid, then an error occurs if the OID is already 
 * in use. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN223"></a><span class='Declare_Function'>inv_create</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>lobjId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN225"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>lobjId_new</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create a new largeobject with empty data pages 
     */ 
</span>    <a href="inv_api.c.html#LN225"><span class='Ref_To_Local'>lobjId_new</span></a> <span class='Operator'>= </span><a href="../../catalog/pg_largeobject.c.html#LN38"><span class='Ref_to_Func'>LargeObjectCreate</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN223"><span class='Ref_to_Parameter'>lobjId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * dependency on the owner of largeobject 
     * 
     * The reason why we use LargeObjectRelationId instead of 
     * LargeObjectMetadataRelationId here is to provide backward compatibility 
     * to the applications which utilize a knowledge about internal layout of 
     * system catalogs. OID of pg_largeobject_metadata and loid of 
     * pg_largeobject are same value, so there are no actual differences here. 
     */ 
</span>    <a href="../../catalog/pg_shdepend.c.html#LN157"><span class='Ref_to_Func'>recordDependencyOnOwner</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Delimiter'>, 
</span>                            <a href="inv_api.c.html#LN225"><span class='Ref_To_Local'>lobjId_new</span></a><span class='Delimiter'>, </span><a href="../../utils/init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Post creation hook for new large object */ 
</span>    <a href="../../../include/catalog/objectaccess.h.html#LN144"><span class='Ref_to_Macro'>InvokeObjectPostCreateHook</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN225"><span class='Ref_To_Local'>lobjId_new</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance command counter to make new tuple visible to later operations. 
     */ 
</span>    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN225"><span class='Ref_To_Local'>lobjId_new</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  inv_open -- access an existing large object. 
 * 
 *      Returns: 
 *        Large object descriptor, appropriately filled in.  The descriptor 
 *        and subsidiary data are allocated in the specified memory context, 
 *        which must be suitably long-lived for the caller's purposes. 
 */ 
</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>* 
</span><a name="LN264"></a><span class='Declare_Function'>inv_open</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>lobjId</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Delimiter'>, </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>mcxt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN266"></a>    <a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span><a name="LN267"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN268"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>descflags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/libpq/libpq-fs.h.html#LN20"><span class='Ref_to_Const'>INV_WRITE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* instantaneous MVCC snapshot */ 
</span>        <a href="inv_api.c.html#LN268"><span class='Ref_To_Local'>descflags</span></a> <span class='Operator'>= </span><a href="../../../include/storage/large_object.h.html#LN48"><span class='Ref_to_Const'>IFS_WRLOCK</span></a> <span class='Operator'>| </span><a href="../../../include/storage/large_object.h.html#LN47"><span class='Ref_to_Const'>IFS_RDLOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/libpq/libpq-fs.h.html#LN21"><span class='Ref_to_Const'>INV_READ</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN77"><span class='Ref_to_Proto'>GetActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN268"><span class='Ref_To_Local'>descflags</span></a> <span class='Operator'>= </span><a href="../../../include/storage/large_object.h.html#LN47"><span class='Ref_to_Const'>IFS_RDLOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid flags for opening a large object: %d"</span><span class='Delimiter'>, 
</span>                        <a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>flags</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can't use LargeObjectExists here because we need to specify snapshot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="inv_api.c.html#LN142"><span class='Ref_to_Func'>myLargeObjectExists</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>lobjId</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"large object %u does not exist"</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>lobjId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must register the snapshot in TopTransaction's resowner, because it 
     * must stay alive until the LO is closed rather than until the current 
     * portal shuts down. Do this after checking that the LO exists, to avoid 
     * leaking the snapshot if an error is thrown. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>) 
</span>        <a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN82"><span class='Ref_to_Proto'>RegisterSnapshotOnOwner</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, 
</span>                                           <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* All set, create a descriptor */ 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>mcxt</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN264"><span class='Ref_to_Parameter'>lobjId</span></a><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN42"><span class='Ref_to_Member'>subid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN267"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN44"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN268"><span class='Ref_To_Local'>descflags</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN266"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_open &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Closes a large object descriptor previously made by inv_open(), and 
 * releases the long-term memory used by it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN319"></a><span class='Declare_Function'>inv_close</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN319"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN83"><span class='Ref_to_Proto'>UnregisterSnapshotFromOwner</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN319"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>, 
</span>                                <a href="../../utils/resowner/resowner.c.html#LN139"><span class='Ref_to_Global_Var'>TopTransactionResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN319"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Destroys an existing large object (not to be confused with a descriptor!) 
 * 
 * returns -1 if failed 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN335"></a><span class='Declare_Function'>inv_drop</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>lobjId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN337"></a>    <a href="../../../include/catalog/objectaddress.h.html#LN23"><span class='Ref_to_Struct'>ObjectAddress</span></a> <span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete any comments and dependencies on the large object 
     */ 
</span>    <a href="inv_api.c.html#LN337"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../../include/catalog/objectaddress.h.html#LN25"><span class='Ref_to_Member'>classId</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/pg_largeobject.h.html#LN28"><span class='Ref_to_Const'>LargeObjectRelationId</span></a><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN337"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../../include/catalog/objectaddress.h.html#LN26"><span class='Ref_to_Member'>objectId</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN335"><span class='Ref_to_Parameter'>lobjId</span></a><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN337"><span class='Ref_To_Local'>object</span></a><span class='Operator'>.</span><a href="../../../include/catalog/objectaddress.h.html#LN27"><span class='Ref_to_Member'>objectSubId</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/catalog/dependency.h.html#LN182"><span class='Ref_to_Proto'>performDeletion</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN337"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/parsenodes.h.html#LN1655"><span class='Ref_to_EnumConst'>DROP_CASCADE</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance command counter so that tuple removal will be seen by later 
     * large-object operations in this transaction. 
     */ 
</span>    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_drop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine size of a large object 
 * 
 * NOTE: LOs can contain gaps, just like Unix files.  We actually return 
 * the offset of the last byte + 1. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> 
<a name="LN363"></a><span class='Declare_Function'>inv_getsize</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN365"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>lastbyte</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN366"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN367"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sd</span><span class='Delimiter'>; 
</span><a name="LN368"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN363"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN67"><span class='Ref_to_Func'>open_lo_relation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN366"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN363"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN367"><span class='Ref_To_Local'>sd</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Delimiter'>, 
</span>                                    <a href="inv_api.c.html#LN363"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN366"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Because the pg_largeobject index is on both loid and pageno, but we 
     * constrain only loid, a backwards scan should visit all pages of the 
     * large object in reverse pageno order.  So, it's sufficient to examine 
     * the first valid tuple (== last valid page). 
     */ 
</span>    <a href="inv_api.c.html#LN368"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN367"><span class='Ref_To_Local'>sd</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN23"><span class='Ref_to_EnumConst'>BackwardScanDirection</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN368"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN391"></a>        <a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN392"></a>        <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>datafield</span><span class='Delimiter'>; 
</span><a name="LN393"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN394"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>pfreeit</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN661"><span class='Ref_to_Macro'>HeapTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN368"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span>   <span class='Comment_Single_Line'>/* paranoia */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null field found in pg_largeobject"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN391"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN368"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN180"><span class='Ref_to_Func'>getdatafield</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN391"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN392"><span class='Ref_To_Local'>datafield</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN393"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN394"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN365"><span class='Ref_To_Local'>lastbyte</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="inv_api.c.html#LN391"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>* </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN393"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN394"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN392"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN367"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN365"><span class='Ref_To_Local'>lastbyte</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_getsize &raquo; </span> 
 
<a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN411"></a><span class='Declare_Function'>inv_seek</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>offset</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>whence</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN413"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>newoffset</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: overflow in the additions is possible, but since we will reject 
     * negative results, we don't need any extra test for that. 
     */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> SEEK_SET<span class='Operator'>: 
</span>            <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SEEK_CUR<span class='Operator'>: 
</span>            <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> SEEK_END<span class='Operator'>: 
</span>            <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN362"><span class='Ref_to_Func'>inv_getsize</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid whence setting: %d"</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>whence</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * use errmsg_internal here because we don't want to expose INT64_FORMAT 
     * in translatable strings; doing better is not worth the trouble 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/large_object.h.html#LN77"><span class='Ref_to_Const'>MAX_LARGE_OBJECT_SIZE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"invalid large object seek target: "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, 
</span>                           <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN411"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="inv_api.c.html#LN413"><span class='Ref_To_Local'>newoffset</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_seek &raquo; </span> 
 
<a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN455"></a><span class='Declare_Function'>inv_tell</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN455"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN455"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>int 
</span><a name="LN463"></a><span class='Declare_Function'>inv_read</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN465"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nread</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN468"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN469"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pageno</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>/ </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN470"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>pageoff</span><span class='Delimiter'>; 
</span><a name="LN471"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN472"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sd</span><span class='Delimiter'>; 
</span><a name="LN473"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN67"><span class='Ref_to_Func'>open_lo_relation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN471"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN471"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_largeobject_pageno</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN31"><span class='Ref_to_Const'>BTGreaterEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4GE<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN469"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN472"><span class='Ref_To_Local'>sd</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Delimiter'>, 
</span>                                    <a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN471"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="inv_api.c.html#LN473"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN472"><span class='Ref_To_Local'>sd</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN498"></a>        <a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a> <span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN499"></a>        <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>datafield</span><span class='Delimiter'>; 
</span><a name="LN500"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>pfreeit</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN661"><span class='Ref_to_Macro'>HeapTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN473"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span>   <span class='Comment_Single_Line'>/* paranoia */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null field found in pg_largeobject"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN498"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN473"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We expect the indexscan will deliver pages in order.  However, 
         * there may be missing pages if the LO contains unwritten "holes". We 
         * want missing sections to read out as zeroes. 
         */ 
</span>        <a href="inv_api.c.html#LN470"><span class='Ref_To_Local'>pageoff</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="inv_api.c.html#LN498"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span>pageno<span class='Parentheses'>)</span> <span class='Operator'>* </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN470"><span class='Ref_To_Local'>pageoff</span></a> <span class='Operator'>&GT; </span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN470"><span class='Ref_To_Local'>pageoff</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a> <span class='Operator'>&LT; </span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>&GT;= </span><a href="inv_api.c.html#LN470"><span class='Ref_To_Local'>pageoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN470"><span class='Ref_To_Local'>pageoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="inv_api.c.html#LN180"><span class='Ref_to_Func'>getdatafield</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN498"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN499"><span class='Ref_To_Local'>datafield</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN468"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN500"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN468"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT; </span><a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN468"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>                <a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                memcpy<span class='Parentheses'>(</span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN499"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="inv_api.c.html#LN467"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>                <a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN466"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN500"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN499"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a> <span class='Operator'>&GT;= </span><a href="inv_api.c.html#LN463"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (tuple=systable_getne... &raquo; </span> 
 
    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN472"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN465"><span class='Ref_To_Local'>nread</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_read &raquo; </span> 
 
<span class='Keyword'>int 
</span><a name="LN550"></a><span class='Declare_Function'>inv_write</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN552"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nwritten</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN555"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN556"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pageno</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>/ </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN557"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN558"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sd</span><span class='Delimiter'>; 
</span><a name="LN559"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>oldtuple</span><span class='Delimiter'>; 
</span><a name="LN560"></a>    <a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a> <span class='Declare_Local'>olddata</span><span class='Delimiter'>; 
</span><a name="LN561"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>neednextpage</span><span class='Delimiter'>; 
</span><a name="LN562"></a>    <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>datafield</span><span class='Delimiter'>; 
</span><a name="LN563"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>pfreeit</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN566"></a>        <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>       <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* this is to make the union big enough for a LO data chunk: */ 
</span><a name="LN568"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>]; 
</span>        <span class='Comment_Multi_Line'>/* ensure union is aligned well enough: */ 
</span><a name="LN570"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>align_it</span><span class='Delimiter'>; 
</span><a name="LN571"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>workbuf</span><span class='Delimiter'>; 
</span><a name="LN572"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>workb</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN571"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN566"><span class='Ref_to_Member'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN573"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN574"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN575"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN576"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replace</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN577"></a>    <a href="../../../include/catalog/indexing.h.html#LN25"><span class='Ref_to_Typedef'>CatalogIndexState</span></a> <span class='Declare_Local'>indstate</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* enforce writability because snapshot is probably wrong otherwise */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN44"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/storage/large_object.h.html#LN48"><span class='Ref_to_Const'>IFS_WRLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* this addition can't overflow because nbytes is only int32 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../../include/storage/large_object.h.html#LN77"><span class='Ref_to_Const'>MAX_LARGE_OBJECT_SIZE</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid large object write request size: %d"</span><span class='Delimiter'>, 
</span>                        <a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN67"><span class='Ref_to_Func'>open_lo_relation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN577"><span class='Ref_To_Local'>indstate</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/indexing.h.html#LN30"><span class='Ref_to_Proto'>CatalogOpenIndexes</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN557"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN557"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_largeobject_pageno</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN31"><span class='Ref_to_Const'>BTGreaterEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4GE<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN556"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN558"><span class='Ref_To_Local'>sd</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Delimiter'>, 
</span>                                    <a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN557"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="inv_api.c.html#LN561"><span class='Ref_To_Local'>neednextpage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a> <span class='Operator'>&LT; </span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If possible, get next pre-existing page of the LO.  We expect the 
         * indexscan will deliver these in order --- but there may be holes. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN561"><span class='Ref_To_Local'>neednextpage</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN558"><span class='Ref_To_Local'>sd</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN661"><span class='Ref_to_Macro'>HeapTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a><span class='Parentheses'>))</span>        <span class='Comment_Single_Line'>/* paranoia */ 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null field found in pg_largeobject"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>&GT;= </span><a href="inv_api.c.html#LN556"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="inv_api.c.html#LN561"><span class='Ref_To_Local'>neednextpage</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we have a pre-existing page, see if it is the page we want to 
         * write, or a later one. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>== </span><a href="inv_api.c.html#LN556"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Update an existing page with fresh data. 
             * 
             * First, load old data into workbuf 
             */ 
</span>            <a href="inv_api.c.html#LN180"><span class='Ref_to_Func'>getdatafield</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN562"><span class='Ref_To_Local'>datafield</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN563"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="inv_api.c.html#LN572"><span class='Ref_To_Local'>workb</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN562"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN563"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN562"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fill any hole 
             */ 
</span>            <a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>% </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT; </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN572"><span class='Ref_To_Local'>workb</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Insert appropriate portion of new data 
             */ 
</span>            <a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="inv_api.c.html#LN572"><span class='Ref_To_Local'>workb</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* compute valid length of new page */ 
</span>            <a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&GT;= </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>: </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN571"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN566"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Form and insert updated tuple 
             */ 
</span>            memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN576"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN576"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN571"><span class='Ref_To_Local'>workbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN576"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN576"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/catalog/indexing.h.html#LN37"><span class='Ref_to_Proto'>CatalogTupleUpdateWithInfo</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, 
</span>                                       <a href="inv_api.c.html#LN577"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We're done with this old page. 
             */ 
</span>            <a href="inv_api.c.html#LN559"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN560"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN561"><span class='Ref_To_Local'>neednextpage</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if olddata!=NULL&&olddat... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Write a brand new page. 
             * 
             * First, fill any hole 
             */ 
</span>            <a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>% </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN572"><span class='Ref_To_Local'>workb</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Insert appropriate portion of new data 
             */ 
</span>            <a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Parentheses'>))</span> <span class='Operator'>? </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>nbytes</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            memcpy<span class='Parentheses'>(</span><a href="inv_api.c.html#LN572"><span class='Ref_To_Local'>workb</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN43"><span class='Ref_to_Member'>offset</span></a> <span class='Operator'>+= </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* compute valid length of new page */ 
</span>            <a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN554"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN553"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN571"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN566"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN555"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Form and insert updated tuple 
             */ 
</span>            memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN550"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_largeobject_pageno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN556"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN571"><span class='Ref_To_Local'>workbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN574"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN575"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/catalog/indexing.h.html#LN33"><span class='Ref_to_Proto'>CatalogTupleInsertWithInfo</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN577"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN573"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <a href="inv_api.c.html#LN556"><span class='Ref_To_Local'>pageno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while nwritten&LT;nbytes &raquo; </span> 
 
    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN558"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/catalog/indexing.h.html#LN31"><span class='Ref_to_Proto'>CatalogCloseIndexes</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN577"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance command counter so that my tuple updates will be seen by later 
     * large-object operations in this transaction. 
     */ 
</span>    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inv_api.c.html#LN552"><span class='Ref_To_Local'>nwritten</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_write &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN743"></a><span class='Declare_Function'>inv_truncate</span><span class='Parentheses'>(</span><a href="../../../include/storage/large_object.h.html#LN38"><span class='Ref_to_Struct'>LargeObjectDesc</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>obj_desc</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN745"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>pageno</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) (</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>/ </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN746"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>off</span><span class='Delimiter'>; 
</span><a name="LN747"></a>    <a href="../../../include/access/skey.h.html#LN63"><span class='Ref_to_Struct'>ScanKeyData</span></a> <span class='Declare_Local'>skey</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN748"></a>    <a href="../../../include/access/genam.h.html#LN86"><span class='Ref_to_Typedef'>SysScanDesc</span></a> <span class='Declare_Local'>sd</span><span class='Delimiter'>; 
</span><a name="LN749"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>oldtuple</span><span class='Delimiter'>; 
</span><a name="LN750"></a>    <a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a> <span class='Declare_Local'>olddata</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN753"></a>        <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>       <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* this is to make the union big enough for a LO data chunk: */ 
</span><a name="LN755"></a>        <span class='Keyword'>char</span>        <span class='Declare_Member'>data</span><span class='Delimiter'>[</span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Delimiter'>]; 
</span>        <span class='Comment_Multi_Line'>/* ensure union is aligned well enough: */ 
</span><a name="LN757"></a>        <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>align_it</span><span class='Delimiter'>; 
</span><a name="LN758"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Local'>workbuf</span><span class='Delimiter'>; 
</span><a name="LN759"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>workb</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN758"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN753"><span class='Ref_to_Member'>hdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN760"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>newtup</span><span class='Delimiter'>; 
</span><a name="LN761"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN762"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN763"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>replace</span><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN50"><span class='Ref_to_Const'>Natts_pg_largeobject</span></a><span class='Delimiter'>]; 
</span><a name="LN764"></a>    <a href="../../../include/catalog/indexing.h.html#LN25"><span class='Ref_to_Typedef'>CatalogIndexState</span></a> <span class='Declare_Local'>indstate</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* enforce writability because snapshot is probably wrong otherwise */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN44"><span class='Ref_to_Member'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/storage/large_object.h.html#LN48"><span class='Ref_to_Const'>IFS_WRLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * use errmsg_internal here because we don't want to expose INT64_FORMAT 
     * in translatable strings; doing better is not worth the trouble 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/large_object.h.html#LN77"><span class='Ref_to_Const'>MAX_LARGE_OBJECT_SIZE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"invalid large object truncation target: "</span> <a href="../../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, 
</span>                                 <a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN67"><span class='Ref_to_Func'>open_lo_relation</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN764"><span class='Ref_To_Local'>indstate</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/indexing.h.html#LN30"><span class='Ref_to_Proto'>CatalogOpenIndexes</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set up to find all pages with desired loid and pageno &GT;= target 
     */ 
</span>    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN747"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN30"><span class='Ref_to_Const'>BTEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_OIDEQ<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../access/common/scankey.c.html#LN74"><span class='Ref_to_Func'>ScanKeyInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN747"><span class='Ref_To_Local'>skey</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <a href="../../../include/catalog/pg_largeobject.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_largeobject_pageno</span></a><span class='Delimiter'>, 
</span>                <a href="../../../include/access/stratnum.h.html#LN31"><span class='Ref_to_Const'>BTGreaterEqualStrategyNumber</span></a><span class='Delimiter'>, </span>F_INT4GE<span class='Delimiter'>, 
</span>                <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN745"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inv_api.c.html#LN748"><span class='Ref_To_Local'>sd</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN197"><span class='Ref_to_Proto'>systable_beginscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN61"><span class='Ref_to_Global_Var'>lo_index_r</span></a><span class='Delimiter'>, 
</span>                                    <a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN41"><span class='Ref_to_Member'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN747"><span class='Ref_To_Local'>skey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If possible, get the page the truncation point is in. The truncation 
     * point may be beyond the end of the LO or in a hole. 
     */ 
</span>    <a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN748"><span class='Ref_To_Local'>sd</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN661"><span class='Ref_to_Macro'>HeapTupleHasNulls</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a><span class='Parentheses'>))</span>        <span class='Comment_Single_Line'>/* paranoia */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null field found in pg_largeobject"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_largeobject.h.html#LN44"><span class='Ref_to_Typedef'>Form_pg_largeobject</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>&GT;= </span><a href="inv_api.c.html#LN745"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we found the page of the truncation point we need to truncate the 
     * data in it.  Otherwise if we're in a hole, we need to create a page to 
     * mark the end of data. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>== </span><a href="inv_api.c.html#LN745"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* First, load old data into workbuf */ 
</span><a name="LN822"></a>        <a href="../../../include/c.h.html#LN451"><span class='Ref_to_Typedef'>bytea</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>datafield</span><span class='Delimiter'>; 
</span><a name="LN823"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>pagelen</span><span class='Delimiter'>; 
</span><a name="LN824"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>pfreeit</span><span class='Delimiter'>; 
</span> 
        <a href="inv_api.c.html#LN180"><span class='Ref_to_Func'>getdatafield</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN822"><span class='Ref_To_Local'>datafield</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN823"><span class='Ref_To_Local'>pagelen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN824"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="inv_api.c.html#LN759"><span class='Ref_To_Local'>workb</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN302"><span class='Ref_to_Macro'>VARDATA</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN822"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN823"><span class='Ref_To_Local'>pagelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN824"><span class='Ref_To_Local'>pfreeit</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN822"><span class='Ref_To_Local'>datafield</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Fill any hole 
         */ 
</span>        <a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>% </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT; </span><a href="inv_api.c.html#LN823"><span class='Ref_To_Local'>pagelen</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN759"><span class='Ref_To_Local'>workb</span></a> <span class='Operator'>+ </span><a href="inv_api.c.html#LN823"><span class='Ref_To_Local'>pagelen</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>- </span><a href="inv_api.c.html#LN823"><span class='Ref_To_Local'>pagelen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* compute length of new page */ 
</span>        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN758"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN753"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form and insert updated tuple 
         */ 
</span>        memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN763"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN763"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN758"><span class='Ref_To_Local'>workbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN763"><span class='Ref_To_Local'>replace</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../access/common/heaptuple.c.html#LN789"><span class='Ref_to_Func'>heap_modify_tuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                   <a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN763"><span class='Ref_To_Local'>replace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/indexing.h.html#LN37"><span class='Ref_to_Proto'>CatalogTupleUpdateWithInfo</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, 
</span>                                   <a href="inv_api.c.html#LN764"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if olddata!=NULL&&olddat... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the first page we found was after the truncation point, we're in 
         * a hole that we'll fill, but we need to delete the later page 
         * because the loop below won't visit it again. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a><span class='Operator'>-&GT;</span>pageno <span class='Operator'>&GT; </span><a href="inv_api.c.html#LN745"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Write a brand new page. 
         * 
         * Fill the hole up to the truncation point 
         */ 
</span>        <a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>= </span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>% </span><a href="../../../include/storage/large_object.h.html#LN71"><span class='Ref_to_Const'>LOBLKSIZE</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN759"><span class='Ref_To_Local'>workb</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* compute length of new page */ 
</span>        <a href="../../../include/postgres.h.html#LN327"><span class='Ref_to_Macro'>SET_VARSIZE</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN758"><span class='Ref_To_Local'>workbuf</span></a><span class='Operator'>.</span><a href="inv_api.c.html#LN753"><span class='Ref_to_Member'>hdr</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN746"><span class='Ref_To_Local'>off</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN444"><span class='Ref_to_Const'>VARHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form and insert new tuple 
         */ 
</span>        memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN51"><span class='Ref_to_Const'>Anum_pg_largeobject_loid</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN743"><span class='Ref_to_Parameter'>obj_desc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/large_object.h.html#LN40"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN52"><span class='Ref_to_Const'>Anum_pg_largeobject_pageno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN745"><span class='Ref_To_Local'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><a href="../../../include/catalog/pg_largeobject.h.html#LN53"><span class='Ref_to_Const'>Anum_pg_largeobject_data</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inv_api.c.html#LN758"><span class='Ref_To_Local'>workbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a> <span class='Operator'>= </span><a href="../../access/common/heaptuple.c.html#LN690"><span class='Ref_to_Func'>heap_form_tuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN761"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN762"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/catalog/indexing.h.html#LN33"><span class='Ref_to_Proto'>CatalogTupleInsertWithInfo</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a><span class='Delimiter'>, </span><a href="inv_api.c.html#LN764"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/access/htup_details.h.html#LN815"><span class='Ref_to_Proto'>heap_freetuple</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN760"><span class='Ref_To_Local'>newtup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Delete any pages after the truncation point.  If the initial search 
     * didn't find a page, then of course there's nothing more to do. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inv_api.c.html#LN750"><span class='Ref_To_Local'>olddata</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a> <span class='Operator'>= </span><a href="../../../include/access/genam.h.html#LN201"><span class='Ref_to_Proto'>systable_getnext_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN748"><span class='Ref_To_Local'>sd</span></a><span class='Delimiter'>, </span><a href="../../../include/access/sdir.h.html#LN25"><span class='Ref_to_EnumConst'>ForwardScanDirection</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/catalog/indexing.h.html#LN40"><span class='Ref_to_Proto'>CatalogTupleDelete</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN60"><span class='Ref_to_Global_Var'>lo_heap_r</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inv_api.c.html#LN749"><span class='Ref_To_Local'>oldtuple</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN64"><span class='Ref_to_Member'>t_self</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/access/genam.h.html#LN203"><span class='Ref_to_Proto'>systable_endscan_ordered</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN748"><span class='Ref_To_Local'>sd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/catalog/indexing.h.html#LN31"><span class='Ref_to_Proto'>CatalogCloseIndexes</span></a><span class='Parentheses'>(</span><a href="inv_api.c.html#LN764"><span class='Ref_To_Local'>indstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance command counter so that tuple updates will be seen by later 
     * large-object operations in this transaction. 
     */ 
</span>    <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end inv_truncate &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>