<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\lmgr\deadlock.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\lmgr\deadlock.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * deadlock.c 
 *    POSTGRES deadlock detection code 
 * 
 * See src/backend/storage/lmgr/README for a description of the deadlock 
 * detection and resolution algorithms. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/lmgr/deadlock.c 
 * 
 *  Interface: 
 * 
 *  DeadLockCheck() 
 *  DeadLockReport() 
 *  RememberSimpleDeadLock() 
 *  InitDeadLockChecking() 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * One edge in the waits-for graph. 
 * 
 * waiter and blocker may or may not be members of a lock group, but if either 
 * is, it will be the leader rather than any other member of the lock group. 
 * The group leaders act as representatives of the whole group even though 
 * those particular processes need not be waiting at all.  There will be at 
 * least one member of the waiter's lock group on the wait queue for the given 
 * lock, maybe more. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN47"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>waiter</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* the leader of the waiting lock group */ 
</span><a name="LN48"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>blocker</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* the leader of the group it is waiting for */ 
</span><a name="LN49"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>lock</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* the lock being waited for */ 
</span><a name="LN50"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pred</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* workspace for TopoSort */ 
</span><a name="LN51"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>link</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* workspace for TopoSort */ 
</span><a name="LN52"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>EDGE</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* One potential reordering of a lock's wait queue */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN57"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Member'>lock</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* the lock whose wait queue is described */ 
</span><a name="LN58"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>    <span class='Operator'>**</span><span class='Declare_Member'>procs</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* array of PGPROC *'s in new wait order */ 
</span><a name="LN59"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nProcs</span><span class='Delimiter'>; 
</span><a name="LN60"></a>} <span class='Declare_Typedef'>WAIT_ORDER</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Information saved about each edge in a detected deadlock cycle.  This 
 * is used to print a diagnostic message upon failure. 
 * 
 * Note: because we want to examine this info after releasing the lock 
 * manager's partition locks, we can't just store LOCK and PGPROC pointers; 
 * we must extract out all the info we want to be able to print. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN72"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Member'>locktag</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* ID of awaited lock object */ 
</span><a name="LN73"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Member'>lockmode</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* type of lock we're waiting for */ 
</span><a name="LN74"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pid</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* PID of blocked backend */ 
</span><a name="LN75"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>DEADLOCK_INFO</span><span class='Delimiter'>; 
</span> 
 
<a name="LN78"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>DeadLockCheckRecurse</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>TestConfiguration</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>startProc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN80"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FindLockCycle</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, 
</span><a name="LN81"></a>              <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FindLockCycleRecurse</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>depth</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                     <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN84"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FindLockCycleRecurseMember</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, 
</span><a name="LN85"></a>                           <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProcLeader</span><span class='Delimiter'>, 
</span><a name="LN86"></a>                           <span class='Keyword'>int </span><span class='Declare_Parameter'>depth</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ExpandConstraints</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>constraints</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nConstraints</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>TopoSort</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>constraints</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nConstraints</span><span class='Delimiter'>, 
</span><a name="LN89"></a>         <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>ordering</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> DEBUG_DEADLOCK 
<a name="LN92"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PrintLockQueue</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Working space for the deadlock detector 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* Workspace for FindLockCycle */ 
</span><a name="LN101"></a><span class='Keyword'>static </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Declare_Var'>visitedProcs</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Array of visited procs */ 
</span><a name="LN102"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nVisitedProcs</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Workspace for TopoSort */ 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Declare_Var'>topoProcs</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Array of not-yet-output procs */ 
</span><a name="LN106"></a><span class='Keyword'>static int </span><span class='Operator'>*</span><span class='Declare_Var'>beforeConstraints</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* Counts of remaining before-constraints */ 
</span><a name="LN107"></a><span class='Keyword'>static int </span><span class='Operator'>*</span><span class='Declare_Var'>afterConstraints</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* List head for after-constraints */ 
</span> 
<span class='Comment_Multi_Line'>/* Output area for ExpandConstraints */ 
</span><a name="LN110"></a><span class='Keyword'>static </span><a href="deadlock.c.html#LN55"><span class='Ref_to_Typedef'>WAIT_ORDER</span></a> <span class='Operator'>*</span><span class='Declare_Var'>waitOrders</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* Array of proposed queue rearrangements */ 
</span><a name="LN111"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nWaitOrders</span><span class='Delimiter'>; 
</span><a name="LN112"></a><span class='Keyword'>static </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Declare_Var'>waitOrderProcs</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Space for waitOrders queue contents */ 
</span> 
<span class='Comment_Multi_Line'>/* Current list of constraints being considered */ 
</span><a name="LN115"></a><span class='Keyword'>static </span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Var'>curConstraints</span><span class='Delimiter'>; 
</span><a name="LN116"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nCurConstraints</span><span class='Delimiter'>; 
</span><a name="LN117"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>maxCurConstraints</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Storage space for results from FindLockCycle */ 
</span><a name="LN120"></a><span class='Keyword'>static </span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Var'>possibleConstraints</span><span class='Delimiter'>; 
</span><a name="LN121"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nPossibleConstraints</span><span class='Delimiter'>; 
</span><a name="LN122"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>maxPossibleConstraints</span><span class='Delimiter'>; 
</span><a name="LN123"></a><span class='Keyword'>static </span><a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Var'>deadlockDetails</span><span class='Delimiter'>; 
</span><a name="LN124"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>nDeadlockDetails</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* PGPROC pointer of any blocking autovacuum worker found */ 
</span><a name="LN127"></a><span class='Keyword'>static </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Var'>blocking_autovacuum_proc</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * InitDeadLockChecking -- initialize deadlock checker during backend startup 
 * 
 * This does per-backend initialization of the deadlock checker; primarily, 
 * allocation of working memory for DeadLockCheck.  We do this per-backend 
 * since there's no percentage in making the kernel do copy-on-write 
 * inheritance of workspace from the postmaster.  We want to allocate the 
 * space at startup because (a) the deadlock checker might be invoked when 
 * there's no free memory left, and (b) the checker is normally run inside a 
 * signal handler, which is a very dangerous place to invoke palloc from. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN142"></a><span class='Declare_Function'>InitDeadLockChecking</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN144"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure allocations are permanent */ 
</span>    <a href="deadlock.c.html#LN144"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * FindLockCycle needs at most MaxBackends entries in visitedProcs[] and 
     * deadlockDetails[]. 
     */ 
</span>    <a href="deadlock.c.html#LN101"><span class='Ref_to_Global_Var'>visitedProcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * TopoSort needs to consider at most MaxBackends wait-queue entries, and 
     * it needn't run concurrently with FindLockCycle. 
     */ 
</span>    <a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN101"><span class='Ref_to_Global_Var'>visitedProcs</span></a><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* re-use this space */ 
</span>    <a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN107"><span class='Ref_to_Global_Var'>afterConstraints</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to consider rearranging at most MaxBackends/2 wait queues 
     * (since it takes at least two waiters in a queue to create a soft edge), 
     * and the expanded form of the wait queues can't involve more than 
     * MaxBackends total waiters. 
     */ 
</span>    <a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN55"><span class='Ref_to_Typedef'>WAIT_ORDER</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN55"><span class='Ref_to_Typedef'>WAIT_ORDER</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN112"><span class='Ref_to_Global_Var'>waitOrderProcs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow at most MaxBackends distinct constraints in a configuration. (Is 
     * this enough?  In practice it seems it should be, but I don't quite see 
     * how to prove it.  If we run out, we might fail to find a workable wait 
     * queue rearrangement even though one exists.)  NOTE that this number 
     * limits the maximum recursion depth of DeadLockCheckRecurse. Making it 
     * really big might potentially allow a stack-overflow problem. 
     */ 
</span>    <a href="deadlock.c.html#LN117"><span class='Ref_to_Global_Var'>maxCurConstraints</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN115"><span class='Ref_to_Global_Var'>curConstraints</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN117"><span class='Ref_to_Global_Var'>maxCurConstraints</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow up to 3*MaxBackends constraints to be saved without having to 
     * re-run TestConfiguration.  (This is probably more than enough, but we 
     * can survive if we run low on space by doing excess runs of 
     * TestConfiguration to re-compute constraint lists each time needed.) The 
     * last MaxBackends entries in possibleConstraints[] are reserved as 
     * output workspace for FindLockCycle. 
     */ 
</span>    <a href="deadlock.c.html#LN122"><span class='Ref_to_Global_Var'>maxPossibleConstraints</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>* </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN120"><span class='Ref_to_Global_Var'>possibleConstraints</span></a> <span class='Operator'>= 
</span>        <span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN122"><span class='Ref_to_Global_Var'>maxPossibleConstraints</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN144"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitDeadLockChecking &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DeadLockCheck -- Checks for deadlocks for a given process 
 * 
 * This code looks for deadlocks involving the given process.  If any 
 * are found, it tries to rearrange lock wait queues to resolve the 
 * deadlock.  If resolution is impossible, return DS_HARD_DEADLOCK --- 
 * the caller is then expected to abort the given proc's transaction. 
 * 
 * Caller must already have locked all partitions of the lock tables. 
 * 
 * On failure, deadlock details are recorded in deadlockDetails[] for 
 * subsequent printing by DeadLockReport().  That activity is separate 
 * because (a) we don't want to do it while holding all those LWLocks, 
 * and (b) we are typically invoked inside a signal handler. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN479"><span class='Ref_to_Typedef'>DeadLockState</span></a> 
<a name="LN216"></a><span class='Declare_Function'>DeadLockCheck</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN218"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN219"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize to "no constraints" */ 
</span>    <a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize to not blocked by an autovacuum worker */ 
</span>    <a href="deadlock.c.html#LN127"><span class='Ref_to_Global_Var'>blocking_autovacuum_proc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search for deadlocks and possible fixes */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN78"><span class='Ref_to_Proto'>DeadLockCheckRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN216"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Call FindLockCycle one more time, to record the correct 
         * deadlockDetails[] for the basic state with no rearrangements. 
         */ 
</span><a name="LN236"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nSoftEdges</span><span class='Delimiter'>; 
</span> 
        TRACE_POSTGRESQL_DEADLOCK_FOUND<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="deadlock.c.html#LN80"><span class='Ref_to_Proto'>FindLockCycle</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN216"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN120"><span class='Ref_to_Global_Var'>possibleConstraints</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN236"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"deadlock seems to have disappeared"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN484"><span class='Ref_to_EnumConst'>DS_HARD_DEADLOCK</span></a><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* cannot find a non-deadlocked state */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Apply any needed rearrangements of wait queues */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN250"></a>        <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN57"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>; 
</span><a name="LN251"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>    <span class='Operator'>**</span><span class='Declare_Local'>procs</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN58"><span class='Ref_to_Member'>procs</span></a><span class='Delimiter'>; 
</span><a name="LN252"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nProcs</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN218"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN59"><span class='Ref_to_Member'>nProcs</span></a><span class='Delimiter'>; 
</span><a name="LN253"></a>        <a href="../../../include/storage/lock.h.html#LN29"><span class='Ref_to_Struct'>PROC_QUEUE</span></a> <span class='Operator'>*</span><span class='Declare_Local'>waitQueue</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN250"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN252"><span class='Ref_To_Local'>nProcs</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN253"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> DEBUG_DEADLOCK 
        <a href="deadlock.c.html#LN92"><span class='Ref_to_Proto'>PrintLockQueue</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN250"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='String'>"DeadLockCheck:"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Reset the queue and re-add procs in the desired order */ 
</span>        <a href="../../../include/storage/proc.h.html#LN299"><span class='Ref_to_Proto'>ProcQueueInit</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN253"><span class='Ref_To_Local'>waitQueue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN219"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN219"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN252"><span class='Ref_To_Local'>nProcs</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN219"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN253"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN251"><span class='Ref_To_Local'>procs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN219"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="deadlock.c.html#LN253"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> DEBUG_DEADLOCK 
        <a href="deadlock.c.html#LN92"><span class='Ref_to_Proto'>PrintLockQueue</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN250"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='String'>"rearranged to:"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* See if any waiters for the lock can be woken up now */ 
</span>        <a href="../../../include/storage/proc.h.html#LN302"><span class='Ref_to_Proto'>ProcLockWakeup</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN458"><span class='Ref_to_Func'>GetLocksMethodTable</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN250"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN250"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nWaitOrders;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Return code tells caller if we had to escape a deadlock or not */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN483"><span class='Ref_to_EnumConst'>DS_SOFT_DEADLOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN127"><span class='Ref_to_Global_Var'>blocking_autovacuum_proc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN485"><span class='Ref_to_EnumConst'>DS_BLOCKED_BY_AUTOVACUUM</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN482"><span class='Ref_to_EnumConst'>DS_NO_DEADLOCK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeadLockCheck &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the PGPROC of the autovacuum that's blocking a process. 
 * 
 * We reset the saved pointer as soon as we pass it back. 
 */ 
</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>* 
</span><a name="LN292"></a><span class='Declare_Function'>GetBlockingAutoVacuumPgproc</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN294"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <a href="deadlock.c.html#LN294"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN127"><span class='Ref_to_Global_Var'>blocking_autovacuum_proc</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN127"><span class='Ref_to_Global_Var'>blocking_autovacuum_proc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="deadlock.c.html#LN294"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * DeadLockCheckRecurse -- recursively search for valid orderings 
 * 
 * curConstraints[] holds the current set of constraints being considered 
 * by an outer level of recursion.  Add to this each possible solution 
 * constraint for any cycle detected at this level. 
 * 
 * Returns TRUE if no solution exists.  Returns FALSE if a deadlock-free 
 * state is attainable, in which case waitOrders[] shows the required 
 * rearrangements of lock wait queues (if any). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN314"></a><span class='Declare_Function'>DeadLockCheckRecurse</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN316"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nEdges</span><span class='Delimiter'>; 
</span><a name="LN317"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>oldPossibleConstraints</span><span class='Delimiter'>; 
</span><a name="LN318"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>savedList</span><span class='Delimiter'>; 
</span><a name="LN319"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN79"><span class='Ref_to_Proto'>TestConfiguration</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN314"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* hard deadlock --- no solution */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* good configuration found */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a> <span class='Operator'>&GT;= </span><a href="deadlock.c.html#LN117"><span class='Ref_to_Global_Var'>maxCurConstraints</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* out of room for active constraints? */ 
</span>    <a href="deadlock.c.html#LN317"><span class='Ref_To_Local'>oldPossibleConstraints</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a> <span class='Operator'>+ </span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a> <span class='Operator'>+ </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>&LT;= </span><a href="deadlock.c.html#LN122"><span class='Ref_to_Global_Var'>maxPossibleConstraints</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We can save the edge list in possibleConstraints[] */ 
</span>        <a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a> <span class='Operator'>+= </span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN318"><span class='Ref_To_Local'>savedList</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Not room; will need to regenerate the edges on-the-fly */ 
</span>        <a href="deadlock.c.html#LN318"><span class='Ref_To_Local'>savedList</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Try each available soft edge as an addition to the configuration. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN319"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN319"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN319"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="deadlock.c.html#LN318"><span class='Ref_To_Local'>savedList</span></a> <span class='Operator'>&& </span><a href="deadlock.c.html#LN319"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Regenerate the list of possible added constraints */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN316"><span class='Ref_To_Local'>nEdges</span></a> <span class='Operator'>!= </span><a href="deadlock.c.html#LN79"><span class='Ref_to_Proto'>TestConfiguration</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN314"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"inconsistent results during deadlock check"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="deadlock.c.html#LN115"><span class='Ref_to_Global_Var'>curConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>            <a href="deadlock.c.html#LN120"><span class='Ref_to_Global_Var'>possibleConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN317"><span class='Ref_To_Local'>oldPossibleConstraints</span></a> <span class='Operator'>+ </span><a href="deadlock.c.html#LN319"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="deadlock.c.html#LN78"><span class='Ref_to_Proto'>DeadLockCheckRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN314"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* found a valid solution! */ 
</span>        <span class='Comment_Multi_Line'>/* give up on that added constraint, try again */ 
</span>        <a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN317"><span class='Ref_To_Local'>oldPossibleConstraints</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* no solution found */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DeadLockCheckRecurse &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*-------------------- 
 * Test a configuration (current set of constraints) for validity. 
 * 
 * Returns: 
 *      0: the configuration is good (no deadlocks) 
 *     -1: the configuration has a hard deadlock or is not self-consistent 
 *      &GT;0: the configuration has one or more soft deadlocks 
 * 
 * In the soft-deadlock case, one of the soft cycles is chosen arbitrarily 
 * and a list of its soft edges is returned beginning at 
 * possibleConstraints+nPossibleConstraints.  The return value is the 
 * number of soft edges. 
 *-------------------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN380"></a><span class='Declare_Function'>TestConfiguration</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>startProc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>softFound</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN383"></a>    <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>softEdges</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN120"><span class='Ref_to_Global_Var'>possibleConstraints</span></a> <span class='Operator'>+ </span><a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a><span class='Delimiter'>; 
</span><a name="LN384"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nSoftEdges</span><span class='Delimiter'>; 
</span><a name="LN385"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure we have room for FindLockCycle's output. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN121"><span class='Ref_to_Global_Var'>nPossibleConstraints</span></a> <span class='Operator'>+ </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>&GT; </span><a href="deadlock.c.html#LN122"><span class='Ref_to_Global_Var'>maxPossibleConstraints</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Expand current constraint set into wait orderings.  Fail if the 
     * constraint set is not self-consistent. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="deadlock.c.html#LN87"><span class='Ref_to_Proto'>ExpandConstraints</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN115"><span class='Ref_to_Global_Var'>curConstraints</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for cycles involving startProc or any of the procs mentioned in 
     * constraints.  We check startProc last because if it has a soft cycle 
     * still to be dealt with, we want to deal with that first. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN385"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN385"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN116"><span class='Ref_to_Global_Var'>nCurConstraints</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN385"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN80"><span class='Ref_to_Proto'>FindLockCycle</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN115"><span class='Ref_to_Global_Var'>curConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN385"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN47"><span class='Ref_to_Member'>waiter</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN383"><span class='Ref_To_Local'>softEdges</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* hard deadlock detected */ 
</span>            <a href="deadlock.c.html#LN382"><span class='Ref_To_Local'>softFound</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN80"><span class='Ref_to_Proto'>FindLockCycle</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN115"><span class='Ref_to_Global_Var'>curConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN385"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN48"><span class='Ref_to_Member'>blocker</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN383"><span class='Ref_To_Local'>softEdges</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* hard deadlock detected */ 
</span>            <a href="deadlock.c.html#LN382"><span class='Ref_To_Local'>softFound</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN80"><span class='Ref_to_Proto'>FindLockCycle</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN380"><span class='Ref_to_Parameter'>startProc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN383"><span class='Ref_To_Local'>softEdges</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* hard deadlock detected */ 
</span>        <a href="deadlock.c.html#LN382"><span class='Ref_To_Local'>softFound</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN384"><span class='Ref_To_Local'>nSoftEdges</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="deadlock.c.html#LN382"><span class='Ref_To_Local'>softFound</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TestConfiguration &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * FindLockCycle -- basic check for deadlock cycles 
 * 
 * Scan outward from the given proc to see if there is a cycle in the 
 * waits-for graph that includes this proc.  Return TRUE if a cycle 
 * is found, else FALSE.  If a cycle is found, we return a list of 
 * the "soft edges", if any, included in the cycle.  These edges could 
 * potentially be eliminated by rearranging wait queues.  We also fill 
 * deadlockDetails[] with information about the detected cycle; this info 
 * is not used by the deadlock algorithm itself, only to print a useful 
 * message after failing. 
 * 
 * Since we need to be able to check hypothetical configurations that would 
 * exist after wait queue rearrangement, the routine pays attention to the 
 * table of hypothetical queue orders in waitOrders[].  These orders will 
 * be believed in preference to the actual ordering seen in the locktable. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN448"></a><span class='Declare_Function'>FindLockCycle</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, 
</span><a name="LN449"></a>              <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>,</span>  <span class='Comment_Single_Line'>/* output argument */ 
</span><a name="LN450"></a>              <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span>  <span class='Comment_Single_Line'>/* output argument */ 
</span><span class='Delimiter'>{ 
</span>    <a href="deadlock.c.html#LN102"><span class='Ref_to_Global_Var'>nVisitedProcs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="deadlock.c.html#LN450"><span class='Ref_to_Parameter'>nSoftEdges</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="deadlock.c.html#LN82"><span class='Ref_to_Proto'>FindLockCycleRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN448"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN449"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN450"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static bool 
</span><a name="LN459"></a><span class='Declare_Function'>FindLockCycleRecurse</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, 
</span><a name="LN460"></a>                     <span class='Keyword'>int </span><span class='Declare_Parameter'>depth</span><span class='Delimiter'>, 
</span><a name="LN461"></a>                     <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* output argument */ 
</span><a name="LN462"></a>                     <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span>   <span class='Comment_Single_Line'>/* output argument */ 
</span><span class='Delimiter'>{ 
</span><a name="LN464"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN465"></a>    <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this process is a lock group member, check the leader instead. (Note 
     * that we might be the leader, in which case this is a no-op.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Have we already seen this proc? 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN464"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN464"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN102"><span class='Ref_to_Global_Var'>nVisitedProcs</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN464"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN101"><span class='Ref_to_Global_Var'>visitedProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN464"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* If we return to starting point, we have a deadlock cycle */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN464"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * record total length of cycle --- outer levels will now fill 
                 * deadlockDetails[] 
                 */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN460"><span class='Ref_to_Parameter'>depth</span></a> <span class='Operator'>&LT;= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN460"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Otherwise, we have a cycle but it does not include the start 
             * point, so say "no deadlock". 
             */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if visitedProcs[i]==chec... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nVisitedProcs;i... &raquo; </span> 
    <span class='Comment_Multi_Line'>/* Mark proc as seen */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN102"><span class='Ref_to_Global_Var'>nVisitedProcs</span></a> <span class='Operator'>&LT; </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN101"><span class='Ref_to_Global_Var'>visitedProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN102"><span class='Ref_to_Global_Var'>nVisitedProcs</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the process is waiting, there is an outgoing waits-for edge to each 
     * process that blocks it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="deadlock.c.html#LN84"><span class='Ref_to_Proto'>FindLockCycleRecurseMember</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN460"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN461"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, 
</span>                                   <a href="deadlock.c.html#LN462"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the process is not waiting, there could still be outgoing waits-for 
     * edges if it is part of a lock group, because other members of the lock 
     * group might be waiting even though this process is not.  (Given lock 
     * groups {A1, A2} and {B1, B2}, if A1 waits for B1 and B2 waits for A2, 
     * that is a deadlock even neither of B1 and A2 are waiting for anything.) 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN465"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN188"><span class='Ref_to_Member'>lockGroupMembers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN523"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>memberProc</span><span class='Delimiter'>; 
</span> 
        <a href="deadlock.c.html#LN523"><span class='Ref_To_Local'>memberProc</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a><span class='Delimiter'>, </span>lockGroupLink<span class='Delimiter'>, </span><a href="deadlock.c.html#LN465"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN523"><span class='Ref_To_Local'>memberProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="deadlock.c.html#LN523"><span class='Ref_To_Local'>memberProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="deadlock.c.html#LN523"><span class='Ref_To_Local'>memberProc</span></a> <span class='Operator'>!= </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a> <span class='Operator'>&& 
</span>          <a href="deadlock.c.html#LN84"><span class='Ref_to_Proto'>FindLockCycleRecurseMember</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN523"><span class='Ref_To_Local'>memberProc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN459"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN460"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN461"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, 
</span>                                     <a href="deadlock.c.html#LN462"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FindLockCycleRecurse &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN538"></a><span class='Declare_Function'>FindLockCycleRecurseMember</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProc</span><span class='Delimiter'>, 
</span><a name="LN539"></a>                           <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>checkProcLeader</span><span class='Delimiter'>, 
</span><a name="LN540"></a>                           <span class='Keyword'>int </span><span class='Declare_Parameter'>depth</span><span class='Delimiter'>, 
</span><a name="LN541"></a>                           <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>softEdges</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* output argument */ 
</span><a name="LN542"></a>                           <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nSoftEdges</span><span class='Parentheses'>)</span>     <span class='Comment_Single_Line'>/* output argument */ 
</span><span class='Delimiter'>{ 
</span><a name="LN544"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN545"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Delimiter'>; 
</span><a name="LN546"></a>    <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span><span class='Delimiter'>; 
</span><a name="LN547"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN548"></a>    <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span><span class='Delimiter'>; 
</span><a name="LN549"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN550"></a>    <a href="../../../include/storage/lock.h.html#LN29"><span class='Ref_to_Struct'>PROC_QUEUE</span></a> <span class='Operator'>*</span><span class='Declare_Local'>waitQueue</span><span class='Delimiter'>; 
</span><a name="LN551"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>queue_size</span><span class='Delimiter'>; 
</span><a name="LN552"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>conflictMask</span><span class='Delimiter'>; 
</span><a name="LN553"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN554"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numLockModes</span><span class='Delimiter'>, 
</span><a name="LN555"></a>                <span class='Declare_Local'>lm</span><span class='Delimiter'>; 
</span> 
    <a href="deadlock.c.html#LN549"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN458"><span class='Ref_to_Func'>GetLocksMethodTable</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN554"><span class='Ref_To_Local'>numLockModes</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN549"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN552"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN549"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan for procs that already hold conflicting locks.  These are "hard" 
     * edges in the waits-for graph. 
     */ 
</span>    <a href="deadlock.c.html#LN548"><span class='Ref_To_Local'>procLocks</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN548"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN548"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN572"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>leader</span><span class='Delimiter'>; 
</span> 
        <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN546"><span class='Ref_To_Local'>pgxact</span></a> <span class='Operator'>= &</span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN108"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span>        <a href="deadlock.c.html#LN572"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>? </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>: </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* A proc never blocks itself or any other lock group member */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN572"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>!= </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN555"><span class='Ref_To_Local'>lm</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN555"><span class='Ref_To_Local'>lm</span></a> <span class='Operator'>&LT;= </span><a href="deadlock.c.html#LN554"><span class='Ref_To_Local'>numLockModes</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN555"><span class='Ref_To_Local'>lm</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN555"><span class='Ref_To_Local'>lm</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>                    <span class='Parentheses'>(</span><a href="deadlock.c.html#LN552"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN555"><span class='Ref_To_Local'>lm</span></a><span class='Parentheses'>)))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* This proc hard-blocks checkProc */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN82"><span class='Ref_to_Proto'>FindLockCycleRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                             <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* fill deadlockDetails[] */ 
</span><a name="LN591"></a>                        <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>]; 
</span> 
                        <a href="deadlock.c.html#LN591"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>; 
</span>                        <a href="deadlock.c.html#LN591"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>                        <a href="deadlock.c.html#LN591"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
                        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No deadlock here, but see if this proc is an autovacuum 
                     * that is directly hard-blocking our own proc.  If so, 
                     * report it so that the caller can send a cancel signal 
                     * to it, if appropriate.  If there's more than one such 
                     * proc, it's indeterminate which one will be reported. 
                     * 
                     * We don't touch autovacuums that are indirectly blocking 
                     * us; it's up to the direct blockee to take action.  This 
                     * rule simplifies understanding the behavior and ensures 
                     * that an autovacuum won't be canceled with less than 
                     * deadlock_timeout grace period. 
                     * 
                     * Note we read vacuumFlags without any locking.  This is 
                     * OK only for checking the PROC_IS_AUTOVACUUM flag, 
                     * because that flag is set at process start and never 
                     * reset.  There is logic elsewhere to avoid canceling an 
                     * autovacuum that is working to prevent XID wraparound 
                     * problems (which needs to read a different vacuumFlag 
                     * bit), but we don't do that here to avoid grabbing 
                     * ProcArrayLock. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a> <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a> <span class='Operator'>&& 
</span>                        <a href="deadlock.c.html#LN546"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN217"><span class='Ref_to_Member'>vacuumFlags</span></a> <span class='Operator'>& </span><a href="../../../include/storage/proc.h.html#LN51"><span class='Ref_to_Const'>PROC_IS_AUTOVACUUM</span></a><span class='Parentheses'>) 
</span>                        <a href="deadlock.c.html#LN127"><span class='Ref_to_Global_Var'>blocking_autovacuum_proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* We're done looking at this proclock */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (proclock-&GT;holdMask&L... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for lm=1;lm&LT;=numLockModes... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if leader!=checkProcLead... &raquo; </span> 
 
        <a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN548"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN547"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while proclock &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Scan for procs that are ahead of this one in the lock's wait queue. 
     * Those that have conflicting requests soft-block this one.  This must be 
     * done after the hard-block search, since if another proc both hard- and 
     * soft-blocks this one, we want to call it a hard edge. 
     * 
     * If there is a proposed re-ordering of the lock's wait order, use that 
     * rather than the current wait order. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN57"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Use the given hypothetical wait queue order */ 
</span><a name="LN654"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>    <span class='Operator'>**</span><span class='Declare_Local'>procs</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN58"><span class='Ref_to_Member'>procs</span></a><span class='Delimiter'>; 
</span> 
        <a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN59"><span class='Ref_to_Member'>nProcs</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN660"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>leader</span><span class='Delimiter'>; 
</span> 
            <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN654"><span class='Ref_To_Local'>procs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN553"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <a href="deadlock.c.html#LN660"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>? </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>: 
</span>                <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * TopoSort will always return an ordering with group members 
             * adjacent to each other in the wait queue (see comments 
             * therein). So, as soon as we reach a process in the same lock 
             * group as checkProc, we know we've found all the conflicts that 
             * precede any member of the lock group lead by checkProcLeader. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN660"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Is there a conflict with this guy's request? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="deadlock.c.html#LN552"><span class='Ref_To_Local'>conflictMask</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* This proc soft-blocks checkProc */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN82"><span class='Ref_to_Proto'>FindLockCycleRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                         <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* fill deadlockDetails[] */ 
</span><a name="LN684"></a>                    <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>]; 
</span> 
                    <a href="deadlock.c.html#LN684"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN684"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN684"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Add this edge to the list of soft edges in the cycle 
                     */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a> <span class='Operator'>&LT; </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN47"><span class='Ref_to_Member'>waiter</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN48"><span class='Ref_to_Member'>blocker</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN660"><span class='Ref_To_Local'>leader</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN49"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>                    <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if FindLockCycleRecurse(... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (LOCKBIT_ON(proc-&GT;wai... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;queue_size;i++ &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if i&LT;nWaitOrders &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN705"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>lastGroupMember</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Use the true lock wait queue order */ 
</span>        <a href="deadlock.c.html#LN550"><span class='Ref_To_Local'>waitQueue</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Find the last member of the lock group that is present in the wait 
         * queue.  Anything after this is not a soft lock conflict. If group 
         * locking is not in use, then we know immediately which process we're 
         * looking for, but otherwise we've got to search the wait queue to 
         * find the last process actually present. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="deadlock.c.html#LN705"><span class='Ref_To_Local'>lastGroupMember</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN550"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN550"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a><span class='Operator'>-- &GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Parentheses'>) 
</span>                    <a href="deadlock.c.html#LN705"><span class='Ref_To_Local'>lastGroupMember</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span>                <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN705"><span class='Ref_To_Local'>lastGroupMember</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * OK, now rescan (or scan) the queue to identify the soft conflicts. 
         */ 
</span>        <a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN550"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN550"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN551"><span class='Ref_To_Local'>queue_size</span></a><span class='Operator'>-- &GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN739"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>leader</span><span class='Delimiter'>; 
</span> 
            <a href="deadlock.c.html#LN739"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>? </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>: 
</span>                <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Done when we reach the target proc */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN705"><span class='Ref_To_Local'>lastGroupMember</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Is there a conflict with this guy's request? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="deadlock.c.html#LN552"><span class='Ref_To_Local'>conflictMask</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                <a href="deadlock.c.html#LN739"><span class='Ref_To_Local'>leader</span></a> <span class='Operator'>!= </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* This proc soft-blocks checkProc */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN82"><span class='Ref_to_Proto'>FindLockCycleRecurse</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                         <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* fill deadlockDetails[] */ 
</span><a name="LN757"></a>                    <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN540"><span class='Ref_to_Parameter'>depth</span></a><span class='Delimiter'>]; 
</span> 
                    <a href="deadlock.c.html#LN757"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN757"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN757"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN538"><span class='Ref_to_Parameter'>checkProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Add this edge to the list of soft edges in the cycle 
                     */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a> <span class='Operator'>&LT; </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN47"><span class='Ref_to_Member'>waiter</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN539"><span class='Ref_to_Parameter'>checkProcLeader</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN48"><span class='Ref_to_Member'>blocker</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN739"><span class='Ref_To_Local'>leader</span></a><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN541"><span class='Ref_to_Parameter'>softEdges</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN49"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN545"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>                    <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="deadlock.c.html#LN542"><span class='Ref_to_Parameter'>nSoftEdges</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if FindLockCycleRecurse(... &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (LOCKBIT_ON(proc-&GT;wai... &raquo; </span> 
 
            <a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN544"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while queue_size--&GT;0 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * No conflict detected here. 
     */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FindLockCycleRecurseMember &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ExpandConstraints -- expand a list of constraints into a set of 
 *      specific new orderings for affected wait queues 
 * 
 * Input is a list of soft edges to be reversed.  The output is a list 
 * of nWaitOrders WAIT_ORDER structs in waitOrders[], with PGPROC array 
 * workspace in waitOrderProcs[]. 
 * 
 * Returns TRUE if able to build an ordering that satisfies all the 
 * constraints, FALSE if not (there are contradictory constraints). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN798"></a><span class='Declare_Function'>ExpandConstraints</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>constraints</span><span class='Delimiter'>, 
</span><a name="LN799"></a>                  <span class='Keyword'>int </span><span class='Declare_Parameter'>nConstraints</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN801"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nWaitOrderProcs</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN802"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN803"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan constraint list backwards.  This is because the last-added 
     * constraint is the only one that could fail, and so we want to test it 
     * for inconsistency first. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN802"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN799"><span class='Ref_to_Parameter'>nConstraints</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="deadlock.c.html#LN802"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN814"></a>        <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN798"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN802"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN49"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Did we already make a list for this lock? */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN803"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="deadlock.c.html#LN803"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN803"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN57"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN814"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN803"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* No, so allocate a new list */ 
</span>        <a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN57"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN814"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN58"><span class='Ref_to_Member'>procs</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN112"><span class='Ref_to_Global_Var'>waitOrderProcs</span></a> <span class='Operator'>+ </span><a href="deadlock.c.html#LN801"><span class='Ref_To_Local'>nWaitOrderProcs</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN59"><span class='Ref_to_Member'>nProcs</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN814"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN801"><span class='Ref_To_Local'>nWaitOrderProcs</span></a> <span class='Operator'>+= </span><a href="deadlock.c.html#LN814"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN801"><span class='Ref_To_Local'>nWaitOrderProcs</span></a> <span class='Operator'>&LT;= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Do the topo sort.  TopoSort need not examine constraints after this 
         * one, since they must be for different locks. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="deadlock.c.html#LN88"><span class='Ref_to_Proto'>TopoSort</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN814"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN798"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN802"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                      <a href="deadlock.c.html#LN110"><span class='Ref_to_Global_Var'>waitOrders</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN58"><span class='Ref_to_Member'>procs</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN111"><span class='Ref_to_Global_Var'>nWaitOrders</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=nConstraints;--i&GT;=0... &raquo; </span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExpandConstraints &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * TopoSort -- topological sort of a wait queue 
 * 
 * Generate a re-ordering of a lock's wait queue that satisfies given 
 * constraints about certain procs preceding others.  (Each such constraint 
 * is a fact of a partial ordering.)  Minimize rearrangement of the queue 
 * not needed to achieve the partial ordering. 
 * 
 * This is a lot simpler and slower than, for example, the topological sort 
 * algorithm shown in Knuth's Volume 1.  However, Knuth's method doesn't 
 * try to minimize the damage to the existing order.  In practice we are 
 * not likely to be working with more than a few constraints, so the apparent 
 * slowness of the algorithm won't really matter. 
 * 
 * The initial queue ordering is taken directly from the lock's wait queue. 
 * The output is an array of PGPROC pointers, of length equal to the lock's 
 * wait queue length (the caller is responsible for providing this space). 
 * The partial order is specified by an array of EDGE structs.  Each EDGE 
 * is one that we need to reverse, therefore the "waiter" must appear before 
 * the "blocker" in the output array.  The EDGE array may well contain 
 * edges associated with other locks; these should be ignored. 
 * 
 * Returns TRUE if able to build an ordering that satisfies all the 
 * constraints, FALSE if not (there are contradictory constraints). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN870"></a><span class='Declare_Function'>TopoSort</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, 
</span><a name="LN871"></a>         <a href="deadlock.c.html#LN45"><span class='Ref_to_Typedef'>EDGE</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>constraints</span><span class='Delimiter'>, 
</span><a name="LN872"></a>         <span class='Keyword'>int </span><span class='Declare_Parameter'>nConstraints</span><span class='Delimiter'>, 
</span><a name="LN873"></a>         <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>ordering</span><span class='Parentheses'>)</span>     <span class='Comment_Single_Line'>/* output argument */ 
</span><span class='Delimiter'>{ 
</span><a name="LN875"></a>    <a href="../../../include/storage/lock.h.html#LN29"><span class='Ref_to_Struct'>PROC_QUEUE</span></a> <span class='Operator'>*</span><span class='Declare_Local'>waitQueue</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN870"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN876"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>queue_size</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN875"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span><a name="LN877"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN878"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN879"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>, 
</span><a name="LN880"></a>                <span class='Declare_Local'>jj</span><span class='Delimiter'>, 
</span><a name="LN881"></a>                <span class='Declare_Local'>k</span><span class='Delimiter'>, 
</span><a name="LN882"></a>                <span class='Declare_Local'>kk</span><span class='Delimiter'>, 
</span><a name="LN883"></a>                <span class='Declare_Local'>last</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* First, fill topoProcs[] array with the procs in their current order */ 
</span>    <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN875"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the constraints, and for each proc in the array, generate a count 
     * of the number of constraints that say it must be before something else, 
     * plus a list of the constraints that say it must be after something 
     * else. The count for the j'th proc is stored in beforeConstraints[j], 
     * and the head of its list in afterConstraints[j].  Each constraint 
     * stores its list link in constraints[i].link (note any constraint will 
     * be in just one list). The array index for the before-proc of the i'th 
     * constraint is remembered in constraints[i].pred. 
     * 
     * Note that it's not necessarily the case that every constraint affects 
     * this particular wait queue.  Prior to group locking, a process could be 
     * waiting for at most one lock.  But a lock group can be waiting for 
     * zero, one, or multiple locks.  Since topoProcs[] is an array of the 
     * processes actually waiting, while constraints[] is an array of group 
     * leaders, we've got to scan through topoProcs[] for each constraint, 
     * checking whether both a waiter and a blocker for that group are 
     * present.  If so, the constraint is relevant to this wait queue; if not, 
     * it isn't. 
     */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN107"><span class='Ref_to_Global_Var'>afterConstraints</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN872"><span class='Ref_to_Parameter'>nConstraints</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Find a representative process that is on the lock queue and part of 
         * the waiting lock group.  This may or may not be the leader, which 
         * may or may not be waiting at all.  If there are any other processes 
         * in the same lock group on the queue, set their number of 
         * beforeConstraints to -1 to indicate that they should be emitted 
         * with their groupmates rather than considered separately. 
         */ 
</span>        <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN47"><span class='Ref_to_Member'>waiter</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN930"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>waiter</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN930"><span class='Ref_To_Local'>waiter</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>|| </span><a href="deadlock.c.html#LN930"><span class='Ref_To_Local'>waiter</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN930"><span class='Ref_To_Local'>waiter</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN870"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If no matching waiter, constraint is not relevant to this lock. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Similarly, find a representative process that is on the lock queue 
         * and waiting for the blocking lock group.  Again, this could be the 
         * leader but does not need to be. 
         */ 
</span>        <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN48"><span class='Ref_to_Member'>blocker</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN960"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>blocker</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN960"><span class='Ref_To_Local'>blocker</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>|| </span><a href="deadlock.c.html#LN960"><span class='Ref_To_Local'>blocker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN960"><span class='Ref_To_Local'>blocker</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN870"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                    <a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>] </span><span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If no matching blocker, constraint is not relevant to this lock. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* waiter must come before */ 
</span>        <span class='Comment_Multi_Line'>/* add this constraint to list of after-constraints for blocker */ 
</span>        <a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN50"><span class='Ref_to_Member'>pred</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN880"><span class='Ref_To_Local'>jj</span></a><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN51"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN107"><span class='Ref_to_Global_Var'>afterConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a><span class='Delimiter'>]; 
</span>        <a href="deadlock.c.html#LN107"><span class='Ref_to_Global_Var'>afterConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN882"><span class='Ref_To_Local'>kk</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nConstraints;i+... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/*-------------------- 
     * Now scan the topoProcs array backwards.  At each step, output the 
     * last proc that has no remaining before-constraints plus any other 
     * members of the same lock group; then decrease the beforeConstraints 
     * count of each of the procs it was constrained against. 
     * i = index of ordering[] entry we want to output this time 
     * j = search index for topoProcs[] 
     * k = temp for scanning constraint list for proc j 
     * last = last non-null index in topoProcs (avoid redundant searches) 
     *-------------------- 
     */ 
</span>    <a href="deadlock.c.html#LN883"><span class='Ref_To_Local'>last</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN876"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1000"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN1001"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nmatches</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find next candidate to output */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN883"><span class='Ref_To_Local'>last</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="deadlock.c.html#LN883"><span class='Ref_To_Local'>last</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN883"><span class='Ref_To_Local'>last</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* If no available candidate, topological sort fails */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Output everything in the lock group.  There's no point in 
         * outputting an ordering where members of the same lock group are not 
         * consecutive on the wait queue: if some other waiter is between two 
         * requests that belong to the same group, then either it conflicts 
         * with both of them and is certainly not a solution; or it conflicts 
         * with at most one of them and is thus isomorphic to an ordering 
         * where the group members are consecutive. 
         */ 
</span>        <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>&LT;= </span><a href="deadlock.c.html#LN883"><span class='Ref_To_Local'>last</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                                      <a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><a href="deadlock.c.html#LN877"><span class='Ref_To_Local'>proc</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="deadlock.c.html#LN873"><span class='Ref_to_Parameter'>ordering</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><a href="deadlock.c.html#LN1001"><span class='Ref_To_Local'>nmatches</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>]; 
</span>                <a href="deadlock.c.html#LN105"><span class='Ref_to_Global_Var'>topoProcs</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1000"><span class='Ref_To_Local'>c</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Operator'>++</span><a href="deadlock.c.html#LN1001"><span class='Ref_To_Local'>nmatches</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN1001"><span class='Ref_To_Local'>nmatches</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN878"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>-= </span><a href="deadlock.c.html#LN1001"><span class='Ref_To_Local'>nmatches</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update beforeConstraints counts of its predecessors */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN107"><span class='Ref_to_Global_Var'>afterConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN879"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; </span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN51"><span class='Ref_to_Member'>link</span></a><span class='Parentheses'>) 
</span>            <a href="deadlock.c.html#LN106"><span class='Ref_to_Global_Var'>beforeConstraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN871"><span class='Ref_to_Parameter'>constraints</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN881"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN50"><span class='Ref_to_Member'>pred</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=queue_size-1;i&GT;=0; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Done */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TopoSort &raquo; </span> 
 
<span class='Directive'>#ifdef</span> DEBUG_DEADLOCK 
<span class='Keyword'>static void 
</span><a name="LN1053"></a><span class='Declare_Function'>PrintLockQueue</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1055"></a>    <a href="../../../include/storage/lock.h.html#LN29"><span class='Ref_to_Struct'>PROC_QUEUE</span></a> <span class='Operator'>*</span><span class='Declare_Local'>waitQueue</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="deadlock.c.html#LN1053"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1056"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>queue_size</span> <span class='Operator'>= </span><a href="deadlock.c.html#LN1055"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span><a name="LN1057"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN1058"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"%s lock %p queue "</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1053"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1053"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1057"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN1055"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN1056"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>" %d"</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1057"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="deadlock.c.html#LN1057"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="deadlock.c.html#LN1057"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    fflush<span class='Parentheses'>(</span>stdout<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Report a detected deadlock, with available details. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1076"></a><span class='Declare_Function'>DeadLockReport</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1078"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>clientbuf</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* errdetail for client */ 
</span><a name="LN1079"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>logbuf</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* errdetail for server log */ 
</span><a name="LN1080"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>locktagbuf</span><span class='Delimiter'>; 
</span><a name="LN1081"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1078"><span class='Ref_To_Local'>clientbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1079"><span class='Ref_To_Local'>logbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1080"><span class='Ref_To_Local'>locktagbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate the "waits for" lines sent to the client */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1090"></a>        <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN1091"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>nextpid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* The last proc waits for the first one... */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="deadlock.c.html#LN1091"><span class='Ref_To_Local'>nextpid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1090"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="deadlock.c.html#LN1091"><span class='Ref_To_Local'>nextpid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* reset locktagbuf to hold next object description */ 
</span>        <a href="../../lib/stringinfo.c.html#LN60"><span class='Ref_to_Func'>resetStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1080"><span class='Ref_To_Local'>locktagbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lmgr.h.html#LN104"><span class='Ref_to_Proto'>DescribeLockTag</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1080"><span class='Ref_To_Local'>locktagbuf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="deadlock.c.html#LN1090"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1078"><span class='Ref_To_Local'>clientbuf</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1078"><span class='Ref_To_Local'>clientbuf</span></a><span class='Delimiter'>, 
</span>                  _<span class='Parentheses'>(</span><span class='String'>"Process %d waits for %s on %s; blocked by process %d."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="deadlock.c.html#LN1090"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/storage/lock.h.html#LN556"><span class='Ref_to_Proto'>GetLockmodeName</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN1090"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>, 
</span>                                         <a href="deadlock.c.html#LN1090"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="deadlock.c.html#LN1080"><span class='Ref_To_Local'>locktagbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, 
</span>                         <a href="deadlock.c.html#LN1091"><span class='Ref_To_Local'>nextpid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nDeadlockDetail... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Duplicate all the above for the server ... */ 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1079"><span class='Ref_To_Local'>logbuf</span></a><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1078"><span class='Ref_To_Local'>clientbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ... and add info about query strings */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a><span class='Delimiter'>; </span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1122"></a>        <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><a href="deadlock.c.html#LN1081"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1079"><span class='Ref_To_Local'>logbuf</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="deadlock.c.html#LN1079"><span class='Ref_To_Local'>logbuf</span></a><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"Process %d: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="deadlock.c.html#LN1122"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/pgstat.h.html#LN1174"><span class='Ref_to_Proto'>pgstat_get_backend_current_activity</span></a><span class='Parentheses'>(</span><a href="deadlock.c.html#LN1122"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/pgstat.h.html#LN1163"><span class='Ref_to_Proto'>pgstat_report_deadlock</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_T_R_DEADLOCK_DETECTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"deadlock detected"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1078"><span class='Ref_To_Local'>clientbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN919"><span class='Ref_to_Func'>errdetail_log</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="deadlock.c.html#LN1079"><span class='Ref_To_Local'>logbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"See server log for query details."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeadLockReport &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RememberSimpleDeadLock: set up info for DeadLockReport when ProcSleep 
 * detects a trivial (two-way) deadlock.  proc1 wants to block for lockmode 
 * on lock, but proc2 is already waiting and would be blocked by proc1. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1148"></a><span class='Declare_Function'>RememberSimpleDeadLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc1</span><span class='Delimiter'>, 
</span><a name="LN1149"></a>                       <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1150"></a>                       <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, 
</span><a name="LN1151"></a>                       <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1153"></a>    <a href="deadlock.c.html#LN70"><span class='Ref_to_Typedef'>DEADLOCK_INFO</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= &</span><a href="deadlock.c.html#LN123"><span class='Ref_to_Global_Var'>deadlockDetails</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1150"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1149"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1148"><span class='Ref_to_Parameter'>proc1</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN72"><span class='Ref_to_Member'>locktag</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1151"><span class='Ref_to_Parameter'>proc2</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN73"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1151"><span class='Ref_to_Parameter'>proc2</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN1153"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="deadlock.c.html#LN74"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="deadlock.c.html#LN1151"><span class='Ref_to_Parameter'>proc2</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>    <a href="deadlock.c.html#LN124"><span class='Ref_to_Global_Var'>nDeadlockDetails</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>