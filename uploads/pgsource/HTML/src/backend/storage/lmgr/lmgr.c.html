<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\lmgr\lmgr.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\lmgr\lmgr.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * lmgr.c 
 *    POSTGRES lock manager code 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/lmgr/lmgr.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/subtrans.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Per-backend counter for generating speculative insertion tokens. 
 * 
 * This may wrap around, but that's OK as it's only used for the short 
 * duration between inserting a tuple and checking that there are no (unique) 
 * constraint violations.  It's theoretically possible that a backend sees a 
 * tuple that was speculatively inserted by another backend, but before it has 
 * started waiting on the token, the other backend completes its insertion, 
 * and then performs 2^32 unrelated insertions.  And after all that, the 
 * first backend finally calls SpeculativeInsertionLockAcquire(), with the 
 * intention of waiting for the first insertion to complete, but ends up 
 * waiting for the latest unrelated insertion instead.  Even then, nothing 
 * particularly bad happens: in the worst case they deadlock, causing one of 
 * the transactions to abort. 
 */ 
</span><a name="LN42"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Var'>speculativeInsertionToken</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Struct to hold context info for transaction lock waits. 
 * 
 * 'oper' is the operation that needs to wait for the other transaction; 'rel' 
 * and 'ctid' specify the address of the tuple being waited for. 
 */ 
</span><a name="LN51"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>XactLockTableWaitInfo</span> 
<span class='Delimiter'>{ 
</span><a name="LN53"></a>    <a href="../../../include/storage/lmgr.h.html#LN23"><span class='Ref_to_Enum'>XLTW_Oper</span></a>   <span class='Declare_Member'>oper</span><span class='Delimiter'>; 
</span><a name="LN54"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Member'>rel</span><span class='Delimiter'>; 
</span><a name="LN55"></a>    <a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Member'>ctid</span><span class='Delimiter'>; 
</span><a name="LN56"></a>} <span class='Declare_Typedef'>XactLockTableWaitInfo</span><span class='Delimiter'>; 
</span> 
<a name="LN58"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>XactLockTableWaitErrorCb</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RelationInitLockInfo 
 *      Initializes the lock information in a relation descriptor. 
 * 
 *      relcache.c must call this during creation of any reldesc. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN67"></a><span class='Declare_Function'>RelationInitLockInfo</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN389"><span class='Ref_to_Macro'>RelationIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>) 
</span>        <a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="lmgr.c.html#LN67"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SetLocktagRelationOid 
 *      Set up a locktag for a relation, given only relation OID 
 */ 
</span><span class='Keyword'>static inline void 
</span><a name="LN85"></a><span class='Declare_Function'>SetLocktagRelationOid</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tag</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>dbid</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN42"><span class='Ref_to_Proto'>IsSharedRelation</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN85"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span> 
        <a href="lmgr.c.html#LN87"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="lmgr.c.html#LN87"><span class='Ref_To_Local'>dbid</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lmgr.c.html#LN85"><span class='Ref_to_Parameter'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN87"><span class='Ref_To_Local'>dbid</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN85"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockRelationOid 
 * 
 * Lock a relation given only its OID.  This should generally be used 
 * before attempting to open the relation's relcache entry. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN104"></a><span class='Declare_Function'>LockRelationOid</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN106"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN84"><span class='Ref_to_Func'>SetLocktagRelationOid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN106"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN104"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN107"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN106"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN104"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the lock, check for invalidation messages, so that we 
     * will update or flush any stale relcache entry before we try to use it. 
     * RangeVarGetRelid() specifically relies on us for this.  We can skip 
     * this in the not-uncommon case that we already had the same type of lock 
     * being requested, since then no one else could have modified the 
     * relcache entry in an undesirable way.  (In the case where our own xact 
     * modifies the rel, the relcache update happens via 
     * CommandCounterIncrement, not here.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN107"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN475"><span class='Ref_to_EnumConst'>LOCKACQUIRE_ALREADY_HELD</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockRelationOid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalLockRelationOid 
 * 
 * As above, but only lock if we can get the lock without blocking. 
 * Returns TRUE iff the lock was acquired. 
 * 
 * NOTE: we do not currently need conditional versions of all the 
 * LockXXX routines in this file, but they could easily be added if needed. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN137"></a><span class='Declare_Function'>ConditionalLockRelationOid</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN139"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN140"></a>    <a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN84"><span class='Ref_to_Func'>SetLocktagRelationOid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN139"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN137"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN140"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN139"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN137"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN140"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the lock, check for invalidation messages; see notes 
     * in LockRelationOid. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN140"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN475"><span class='Ref_to_EnumConst'>LOCKACQUIRE_ALREADY_HELD</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ConditionalLockRelationOid &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      UnlockRelationId 
 * 
 * Unlock, given a LockRelId.  This is preferred over UnlockRelationOid 
 * for speed reasons. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN166"></a><span class='Declare_Function'>UnlockRelationId</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN35"><span class='Ref_to_Struct'>LockRelId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN168"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN168"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN166"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN166"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN168"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN166"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockRelationOid 
 * 
 * Unlock, given only a relation Oid.  Use UnlockRelationId if you can. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN181"></a><span class='Declare_Function'>UnlockRelationOid</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN183"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN84"><span class='Ref_to_Func'>SetLocktagRelationOid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN183"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN181"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN183"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN181"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockRelation 
 * 
 * This is a convenience routine for acquiring an additional lock on an 
 * already-open relation.  Never try to do "relation_open(foo, NoLock)" 
 * and then lock with this. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN198"></a><span class='Declare_Function'>LockRelation</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN200"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN200"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN198"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN198"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN201"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN200"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN198"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the lock, check for invalidation messages; see notes 
     * in LockRelationOid. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN201"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN475"><span class='Ref_to_EnumConst'>LOCKACQUIRE_ALREADY_HELD</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalLockRelation 
 * 
 * This is a convenience routine for acquiring an additional lock on an 
 * already-open relation.  Never try to do "relation_open(foo, NoLock)" 
 * and then lock with this. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN225"></a><span class='Declare_Function'>ConditionalLockRelation</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN227"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN227"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN225"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN225"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN228"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN227"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN225"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN228"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have the lock, check for invalidation messages; see notes 
     * in LockRelationOid. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN228"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN475"><span class='Ref_to_EnumConst'>LOCKACQUIRE_ALREADY_HELD</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ConditionalLockRelation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      UnlockRelation 
 * 
 * This is a convenience routine for unlocking a relation without also 
 * closing it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN256"></a><span class='Declare_Function'>UnlockRelation</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN258"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN258"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN256"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN256"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN258"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN256"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockHasWaitersRelation 
 * 
 * This is a function to check whether someone else is waiting for a 
 * lock which we are currently holding. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN274"></a><span class='Declare_Function'>LockHasWaitersRelation</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN276"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN276"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN274"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                         <a href="lmgr.c.html#LN274"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN539"><span class='Ref_to_Proto'>LockHasWaiters</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN276"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN274"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockRelationIdForSession 
 * 
 * This routine grabs a session-level lock on the target relation.  The 
 * session lock persists across transaction boundaries.  It will be removed 
 * when UnlockRelationIdForSession() is called, or if an ereport(ERROR) occurs, 
 * or if the backend exits. 
 * 
 * Note that one should also grab a transaction-level lock on the rel 
 * in any transaction that actually uses the rel, to ensure that the 
 * relcache entry is up to date. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN298"></a><span class='Declare_Function'>LockRelationIdForSession</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN35"><span class='Ref_to_Struct'>LockRelId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN300"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN300"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN298"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN298"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN300"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN298"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockRelationIdForSession 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN311"></a><span class='Declare_Function'>UnlockRelationIdForSession</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN35"><span class='Ref_to_Struct'>LockRelId</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN313"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN313"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN311"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN311"><span class='Ref_to_Parameter'>relid</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN313"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN311"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockRelationForExtension 
 * 
 * This lock tag is used to interlock addition of pages to relations. 
 * We need such locking because bufmgr/smgr definition of P_NEW is not 
 * race-condition-proof. 
 * 
 * We assume the caller is already holding some type of regular lock on 
 * the relation, so no AcceptInvalidationMessages call is needed here. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN331"></a><span class='Declare_Function'>LockRelationForExtension</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN333"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN201"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION_EXTEND</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN333"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN331"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN331"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN333"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN331"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalLockRelationForExtension 
 * 
 * As above, but only lock if we can get the lock without blocking. 
 * Returns TRUE iff the lock was acquired. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN349"></a><span class='Declare_Function'>ConditionalLockRelationForExtension</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN351"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN201"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION_EXTEND</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN351"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN349"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN349"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN351"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN349"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      RelationExtensionLockWaiterCount 
 * 
 * Count the number of processes waiting for the given relation extension lock. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN366"></a><span class='Declare_Function'>RelationExtensionLockWaiterCount</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN368"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN201"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION_EXTEND</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN368"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN366"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN366"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN576"><span class='Ref_to_Proto'>LockWaiterCount</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN368"><span class='Ref_To_Local'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockRelationForExtension 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN381"></a><span class='Declare_Function'>UnlockRelationForExtension</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN383"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN201"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION_EXTEND</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN383"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN381"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                                <a href="lmgr.c.html#LN381"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN383"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN381"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockPage 
 * 
 * Obtain a page-level lock.  This is currently used by some index access 
 * methods to lock individual index pages. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN399"></a><span class='Declare_Function'>LockPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN401"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN209"><span class='Ref_to_Macro'>SET_LOCKTAG_PAGE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN401"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN399"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN399"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN399"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN401"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN399"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalLockPage 
 * 
 * As above, but only lock if we can get the lock without blocking. 
 * Returns TRUE iff the lock was acquired. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN418"></a><span class='Declare_Function'>ConditionalLockPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN420"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN209"><span class='Ref_to_Macro'>SET_LOCKTAG_PAGE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN420"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN418"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN418"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN418"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN420"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN418"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockPage 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN434"></a><span class='Declare_Function'>UnlockPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN436"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN209"><span class='Ref_to_Macro'>SET_LOCKTAG_PAGE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN436"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN434"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN434"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                     <a href="lmgr.c.html#LN434"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN436"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN434"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockTuple 
 * 
 * Obtain a tuple-level lock.  This is used in a less-than-intuitive fashion 
 * because we can't afford to keep a separate lock in shared memory for every 
 * tuple.  See heap_lock_tuple before using this! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN454"></a><span class='Declare_Function'>LockTuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN456"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN217"><span class='Ref_to_Macro'>SET_LOCKTAG_TUPLE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN456"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN454"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN454"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN454"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN454"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN456"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN454"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalLockTuple 
 * 
 * As above, but only lock if we can get the lock without blocking. 
 * Returns TRUE iff the lock was acquired. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN474"></a><span class='Declare_Function'>ConditionalLockTuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN476"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN217"><span class='Ref_to_Macro'>SET_LOCKTAG_TUPLE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN476"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN474"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN474"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN474"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN474"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN476"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN474"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockTuple 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN491"></a><span class='Declare_Function'>UnlockTuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>tid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN493"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN217"><span class='Ref_to_Macro'>SET_LOCKTAG_TUPLE</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN493"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN491"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN38"><span class='Ref_to_Member'>dbId</span></a><span class='Delimiter'>, 
</span>                      <a href="lmgr.c.html#LN491"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN116"><span class='Ref_to_Member'>rd_lockInfo</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN43"><span class='Ref_to_Member'>lockRelId</span></a><span class='Operator'>.</span><a href="../../../include/utils/rel.h.html#LN37"><span class='Ref_to_Member'>relId</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN491"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN491"><span class='Ref_to_Parameter'>tid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN493"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN491"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      XactLockTableInsert 
 * 
 * Insert a lock showing that the given transaction ID is running --- 
 * this is done when an XID is acquired by a transaction or subtransaction. 
 * The lock can then be used to wait for the transaction to finish. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN512"></a><span class='Declare_Function'>XactLockTableInsert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN514"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN225"><span class='Ref_to_Macro'>SET_LOCKTAG_TRANSACTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN514"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN512"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN514"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      XactLockTableDelete 
 * 
 * Delete the lock showing that the given transaction ID is running. 
 * (This is never used for main transaction IDs; those locks are only 
 * released implicitly at transaction end.  But we do use it for subtrans IDs.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN529"></a><span class='Declare_Function'>XactLockTableDelete</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN531"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN225"><span class='Ref_to_Macro'>SET_LOCKTAG_TRANSACTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN531"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN529"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN531"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      XactLockTableWait 
 * 
 * Wait for the specified transaction to commit or abort.  If an operation 
 * is specified, an error context callback is set up.  If 'oper' is passed as 
 * None, no error context callback is set up. 
 * 
 * Note that this does the right thing for subtransactions: if we wait on a 
 * subtransaction, we will exit as soon as it aborts or its top parent commits. 
 * It takes some extra work to ensure this, because to save on shared memory 
 * the XID lock of a subtransaction is released when it ends, whether 
 * successfully or unsuccessfully.  So we have to check if it's "still running" 
 * and if so wait for its parent. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN553"></a><span class='Declare_Function'>XactLockTableWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/storage/itemptr.h.html#LN47"><span class='Ref_to_Typedef'>ItemPointer</span></a> <span class='Declare_Parameter'>ctid</span><span class='Delimiter'>, 
</span><a name="LN554"></a>                  <a href="../../../include/storage/lmgr.h.html#LN23"><span class='Ref_to_Enum'>XLTW_Oper</span></a> <span class='Declare_Parameter'>oper</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN556"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN557"></a>    <a href="lmgr.c.html#LN51"><span class='Ref_to_Struct'>XactLockTableWaitInfo</span></a> <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span><a name="LN558"></a>    ErrorContextCallback <span class='Declare_Local'>callback</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If an operation is specified, set up our verbose error context 
     * callback. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN554"><span class='Ref_to_Parameter'>oper</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lmgr.h.html#LN25"><span class='Ref_to_EnumConst'>XLTW_None</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN389"><span class='Ref_to_Macro'>RelationIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>ctid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="lmgr.c.html#LN557"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="lmgr.c.html#LN54"><span class='Ref_to_Member'>rel</span></a> <span class='Operator'>= </span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN557"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="lmgr.c.html#LN55"><span class='Ref_to_Member'>ctid</span></a> <span class='Operator'>= </span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>ctid</span></a><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN557"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="lmgr.c.html#LN53"><span class='Ref_to_Member'>oper</span></a> <span class='Operator'>= </span><a href="lmgr.c.html#LN554"><span class='Ref_to_Parameter'>oper</span></a><span class='Delimiter'>; 
</span> 
        <a href="lmgr.c.html#LN558"><span class='Ref_To_Local'>callback</span></a><span class='Operator'>.</span>callback <span class='Operator'>= </span><a href="lmgr.c.html#LN58"><span class='Ref_to_Proto'>XactLockTableWaitErrorCb</span></a><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN558"><span class='Ref_To_Local'>callback</span></a><span class='Operator'>.</span>arg <span class='Operator'>= &</span><a href="lmgr.c.html#LN557"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN558"><span class='Ref_To_Local'>callback</span></a><span class='Operator'>.</span>previous <span class='Operator'>= </span><a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a><span class='Delimiter'>; 
</span>        <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= &</span><a href="lmgr.c.html#LN558"><span class='Ref_To_Local'>callback</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>()))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lock.h.html#LN225"><span class='Ref_to_Macro'>SET_LOCKTAG_TRANSACTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN556"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN556"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN556"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/subtrans.h.html#LN17"><span class='Ref_to_Proto'>SubTransGetParent</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN553"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN554"><span class='Ref_to_Parameter'>oper</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lmgr.h.html#LN25"><span class='Ref_to_EnumConst'>XLTW_None</span></a><span class='Parentheses'>) 
</span>        <a href="../../utils/error/elog.c.html#LN87"><span class='Ref_to_Global_Var'>error_context_stack</span></a> <span class='Operator'>= </span><a href="lmgr.c.html#LN558"><span class='Ref_To_Local'>callback</span></a><span class='Operator'>.</span>previous<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end XactLockTableWait &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      ConditionalXactLockTableWait 
 * 
 * As above, but only lock if we can get the lock without blocking. 
 * Returns TRUE if the lock was acquired. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN606"></a><span class='Declare_Function'>ConditionalXactLockTableWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN608"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>()))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lock.h.html#LN225"><span class='Ref_to_Macro'>SET_LOCKTAG_TRANSACTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN608"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN608"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN608"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/procarray.h.html#LN89"><span class='Ref_to_Proto'>TransactionIdIsInProgress</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/subtrans.h.html#LN17"><span class='Ref_to_Proto'>SubTransGetParent</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN606"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ConditionalXactLockTableWait &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      SpeculativeInsertionLockAcquire 
 * 
 * Insert a lock showing that the given transaction ID is inserting a tuple, 
 * but hasn't yet decided whether it's going to keep it.  The lock can then be 
 * used to wait for the decision to go ahead with the insertion, or aborting 
 * it. 
 * 
 * The token is used to distinguish multiple insertions by the same 
 * transaction.  It is returned to caller. 
 */ 
</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN642"></a><span class='Declare_Function'>SpeculativeInsertionLockAcquire</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN644"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check for wrap-around. Zero means no token is held, so don't use that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN241"><span class='Ref_to_Macro'>SET_LOCKTAG_SPECULATIVE_INSERTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN644"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN642"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN644"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      SpeculativeInsertionLockRelease 
 * 
 * Delete the lock showing that the given transaction is speculatively 
 * inserting a tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN668"></a><span class='Declare_Function'>SpeculativeInsertionLockRelease</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN670"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN241"><span class='Ref_to_Macro'>SET_LOCKTAG_SPECULATIVE_INSERTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN670"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN668"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN42"><span class='Ref_to_Global_Var'>speculativeInsertionToken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN670"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      SpeculativeInsertionWait 
 * 
 * Wait for the specified transaction to finish or abort the insertion of a 
 * tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN684"></a><span class='Declare_Function'>SpeculativeInsertionWait</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>token</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN686"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN241"><span class='Ref_to_Macro'>SET_LOCKTAG_SPECULATIVE_INSERTION</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN686"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN684"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN684"><span class='Ref_to_Parameter'>token</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN684"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lmgr.c.html#LN684"><span class='Ref_to_Parameter'>token</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN686"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN686"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * XactLockTableWaitErrorContextCb 
 *      Error context callback for transaction lock waits. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN702"></a><span class='Declare_Function'>XactLockTableWaitErrorCb</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN704"></a>    <a href="lmgr.c.html#LN51"><span class='Ref_to_Struct'>XactLockTableWaitInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>info</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="lmgr.c.html#LN51"><span class='Ref_to_Struct'>XactLockTableWaitInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lmgr.c.html#LN702"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We would like to print schema name too, but that would require a 
     * syscache lookup. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN53"><span class='Ref_to_Member'>oper</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/lmgr.h.html#LN25"><span class='Ref_to_EnumConst'>XLTW_None</span></a> <span class='Operator'>&& 
</span>        <a href="../../../include/storage/itemptr.h.html#LN58"><span class='Ref_to_Macro'>ItemPointerIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN55"><span class='Ref_to_Member'>ctid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/utils/rel.h.html#LN389"><span class='Ref_to_Macro'>RelationIsValid</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN54"><span class='Ref_to_Member'>rel</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN713"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>cxt</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN53"><span class='Ref_to_Member'>oper</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN26"><span class='Ref_to_EnumConst'>XLTW_Update</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while updating tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN27"><span class='Ref_to_EnumConst'>XLTW_Delete</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while deleting tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN28"><span class='Ref_to_EnumConst'>XLTW_Lock</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while locking tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN29"><span class='Ref_to_EnumConst'>XLTW_LockUpdated</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while locking updated version (%u,%u) of tuple in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN30"><span class='Ref_to_EnumConst'>XLTW_InsertIndex</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while inserting index tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN31"><span class='Ref_to_EnumConst'>XLTW_InsertIndexUnique</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while checking uniqueness of tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN32"><span class='Ref_to_EnumConst'>XLTW_FetchUpdated</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while rechecking updated tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/storage/lmgr.h.html#LN33"><span class='Ref_to_EnumConst'>XLTW_RecheckExclusionConstr</span></a><span class='Operator'>: 
</span>                <a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN138"><span class='Ref_to_Macro'>gettext_noop</span></a><span class='Parentheses'>(</span><span class='String'>"while checking exclusion constraint on tuple (%u,%u) in relation \"%s\""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch info-&GT;oper &raquo; </span> 
 
        errcontext<span class='Parentheses'>(</span><a href="lmgr.c.html#LN713"><span class='Ref_To_Local'>cxt</span></a><span class='Delimiter'>, 
</span>                   <a href="../../../include/storage/itemptr.h.html#LN74"><span class='Ref_to_Macro'>ItemPointerGetBlockNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN55"><span class='Ref_to_Member'>ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/storage/itemptr.h.html#LN93"><span class='Ref_to_Macro'>ItemPointerGetOffsetNumber</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN55"><span class='Ref_to_Member'>ctid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN704"><span class='Ref_To_Local'>info</span></a><span class='Operator'>-&GT;</span><a href="lmgr.c.html#LN54"><span class='Ref_to_Member'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if info-&GT;oper!=XLTW_None... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end XactLockTableWaitErrorCb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * WaitForLockersMultiple 
 *      Wait until no transaction holds locks that conflict with the given 
 *      locktags at the given lockmode. 
 * 
 * To do this, obtain the current list of lockers, and wait on their VXIDs 
 * until they are finished. 
 * 
 * Note we don't try to acquire the locks on the given locktags, only the VXIDs 
 * of its lock holders; if somebody grabs a conflicting lock on the objects 
 * after we obtained our initial list of lockers, we will not wait for them. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN766"></a><span class='Declare_Function'>WaitForLockersMultiple</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktags</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN768"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>holders</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN769"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Done if no locks to wait for */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN766"><span class='Ref_to_Parameter'>locktags</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Collect the transactions we need to wait on */ 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN769"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN766"><span class='Ref_to_Parameter'>locktags</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN778"></a>        <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>locktag</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN769"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lmgr.c.html#LN768"><span class='Ref_To_Local'>holders</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN768"><span class='Ref_To_Local'>holders</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN541"><span class='Ref_to_Proto'>GetLockConflicts</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN778"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN766"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: GetLockConflicts() never reports our own xid, hence we need not 
     * check for that.  Also, prepared xacts are not reported, which is fine 
     * since they certainly aren't going to do anything anymore. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Finally wait for each such transaction to complete */ 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN769"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN768"><span class='Ref_To_Local'>holders</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN792"></a>        <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockholders</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN769"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lmgr.c.html#LN792"><span class='Ref_To_Local'>lockholders</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lock.h.html#LN586"><span class='Ref_to_Proto'>VirtualXactLock</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lmgr.c.html#LN792"><span class='Ref_To_Local'>lockholders</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lmgr.c.html#LN792"><span class='Ref_To_Local'>lockholders</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN266"><span class='Ref_to_Proto'>list_free_deep</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN768"><span class='Ref_To_Local'>holders</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitForLockersMultiple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * WaitForLockers 
 * 
 * Same as WaitForLockersMultiple, for a single lock tag. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN810"></a><span class='Declare_Function'>WaitForLockers</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Declare_Parameter'>heaplocktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN812"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <a href="lmgr.c.html#LN812"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN138"><span class='Ref_to_Macro'>list_make1</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN810"><span class='Ref_to_Parameter'>heaplocktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lmgr.h.html#LN79"><span class='Ref_to_Proto'>WaitForLockersMultiple</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN812"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN810"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN812"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *      LockDatabaseObject 
 * 
 * Obtain a lock on a general object of the current database.  Don't use 
 * this for shared objects (such as tablespaces).  It's unwise to apply it 
 * to relations, also, since a lock taken this way will NOT conflict with 
 * locks taken via LockRelation and friends. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN829"></a><span class='Declare_Function'>LockDatabaseObject</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN830"></a>                   <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN832"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN832"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN829"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN829"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN829"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN832"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN830"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure syscaches are up-to-date with any changes we waited for */ 
</span>    <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockDatabaseObject 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN850"></a><span class='Declare_Function'>UnlockDatabaseObject</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN851"></a>                     <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN853"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN853"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN850"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN850"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN850"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN853"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN851"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockSharedObject 
 * 
 * Obtain a lock on a shared-across-databases object. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN870"></a><span class='Declare_Function'>LockSharedObject</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN871"></a>                 <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN873"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN873"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN870"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN870"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN870"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN873"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN871"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure syscaches are up-to-date with any changes we waited for */ 
</span>    <a href="../../../include/utils/inval.h.html#LN25"><span class='Ref_to_Proto'>AcceptInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockSharedObject 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN891"></a><span class='Declare_Function'>UnlockSharedObject</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN892"></a>                   <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN894"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN894"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN891"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN891"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN891"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN894"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN892"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      LockSharedObjectForSession 
 * 
 * Obtain a session-level lock on a shared-across-databases object. 
 * See LockRelationIdForSession for notes about session-level locks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN912"></a><span class='Declare_Function'>LockSharedObjectForSession</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN913"></a>                           <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN915"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN915"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN912"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN912"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN912"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN915"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN913"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      UnlockSharedObjectForSession 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN930"></a><span class='Declare_Function'>UnlockSharedObjectForSession</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>classid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>objid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>objsubid</span><span class='Delimiter'>, 
</span><a name="LN931"></a>                             <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN933"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN249"><span class='Ref_to_Macro'>SET_LOCKTAG_OBJECT</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN933"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, 
</span>                       <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN930"><span class='Ref_to_Parameter'>classid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN930"><span class='Ref_to_Parameter'>objid</span></a><span class='Delimiter'>, 
</span>                       <a href="lmgr.c.html#LN930"><span class='Ref_to_Parameter'>objsubid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lmgr.c.html#LN933"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lmgr.c.html#LN931"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Append a description of a lockable object to buf. 
 * 
 * Ideally we would print names for the numeric values, but that requires 
 * getting locks on system tables, which might cause problems since this is 
 * typically used to report deadlock situations. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN953"></a><span class='Declare_Function'>DescribeLockTag</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>((</span><a href="../../../include/storage/lock.h.html#LN138"><span class='Ref_to_Enum'>LockTagType</span></a><span class='Parentheses'>) </span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"relation %u of database %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN142"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION_EXTEND</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"extension of relation %u of database %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN144"><span class='Ref_to_EnumConst'>LOCKTAG_PAGE</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"page %u of relation %u of database %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN146"><span class='Ref_to_EnumConst'>LOCKTAG_TUPLE</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"tuple (%u,%u) of relation %u of database %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN183"><span class='Ref_to_Member'>locktag_field4</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN148"><span class='Ref_to_EnumConst'>LOCKTAG_TRANSACTION</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"transaction %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN150"><span class='Ref_to_EnumConst'>LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"virtual transaction %d/%u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN152"><span class='Ref_to_EnumConst'>LOCKTAG_SPECULATIVE_TOKEN</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"speculative token %u of transaction %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN154"><span class='Ref_to_EnumConst'>LOCKTAG_OBJECT</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"object %u of class %u of database %u"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN162"><span class='Ref_to_EnumConst'>LOCKTAG_USERLOCK</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* reserved for old contrib code, now on pgfoundry */ 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"user lock [%u,%u,%u]"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/storage/lock.h.html#LN163"><span class='Ref_to_EnumConst'>LOCKTAG_ADVISORY</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"advisory lock [%u,%u,%u,%u]"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                             <a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN183"><span class='Ref_to_Member'>locktag_field4</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, 
</span>                             _<span class='Parentheses'>(</span><span class='String'>"unrecognized locktag type %d"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="lmgr.c.html#LN953"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch (LockTagType)tag-&GT;loc... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DescribeLockTag &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetLockNameFromTagType 
 * 
 *  Given locktag type, return the corresponding lock name. 
 */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN1038"></a><span class='Declare_Function'>GetLockNameFromTagType</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>locktag_type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lmgr.c.html#LN1038"><span class='Ref_to_Parameter'>locktag_type</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/lock.h.html#LN166"><span class='Ref_to_Const'>LOCKTAG_LAST_TYPE</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='String'>"???"</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../utils/adt/lockfuncs.c.html#LN25"><span class='Ref_to_Global_Var'>LockTagTypeNames</span></a><span class='Delimiter'>[</span><a href="lmgr.c.html#LN1038"><span class='Ref_to_Parameter'>locktag_type</span></a><span class='Delimiter'>]; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>