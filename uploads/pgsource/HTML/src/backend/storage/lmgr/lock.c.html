<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\lmgr\lock.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\lmgr\lock.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * lock.c 
 *    POSTGRES primary lock mechanism 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/lmgr/lock.c 
 * 
 * NOTES 
 *    A lock table is a shared memory hash table.  When 
 *    a process tries to acquire a lock of a type that conflicts 
 *    with existing locks, it is put to sleep using the routines 
 *    in storage/lmgr/proc.c. 
 * 
 *    For the most part, this code should be invoked via lmgr.c 
 *    or another lock-management module, not directly. 
 * 
 *  Interface: 
 * 
 *  InitLocks(), GetLocksMethodTable(), GetLockTagsMethodTable(), 
 *  LockAcquire(), LockRelease(), LockReleaseAll(), 
 *  LockCheckConflicts(), GrantLock() 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/twophase_rmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinvaladt.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/standby.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/ps_status.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner_private.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* This configuration variable is used to set the lock table size */ 
</span><a name="LN53"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>max_locks_per_xact</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* set by guc.c */ 
</span> 
<a name="LN55"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>NLOCKENTS</span><span class='Parentheses'>() </span><span class='Operator'>\ 
</span>    <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN53"><span class='Ref_to_Global_Var'>max_locks_per_xact</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>, </span><a href="../../access/transam/twophase.c.html#LN116"><span class='Ref_to_Global_Var'>max_prepared_xacts</span></a><span class='Parentheses'>))</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Data structures defining the semantics of the standard lock methods. 
 * 
 * The conflict table defines the semantics of the various lock modes. 
 */ 
</span><a name="LN64"></a><span class='Keyword'>static const </span><a href="../../../include/storage/lockdefs.h.html#LN24"><span class='Ref_to_Typedef'>LOCKMASK</span></a> <span class='Declare_Var'>LockConflicts</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* AccessShareLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* RowShareLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* RowExclusiveLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* ShareUpdateExclusiveLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* ShareLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* ShareRowExclusiveLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* ExclusiveLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span> 
    <span class='Comment_Multi_Line'>/* AccessExclusiveLock */ 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN41"><span class='Ref_to_Const'>ShareRowExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| 
</span>    <a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>) 
</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Names of lock modes, for debug printouts */ 
</span><a name="LN107"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Keyword'>const </span><span class='Declare_Var'>lock_mode_names</span><span class='Delimiter'>[] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <span class='String'>"INVALID"</span><span class='Delimiter'>, 
</span>    <span class='String'>"AccessShareLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"RowShareLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"RowExclusiveLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"ShareUpdateExclusiveLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"ShareLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"ShareRowExclusiveLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"ExclusiveLock"</span><span class='Delimiter'>, 
</span>    <span class='String'>"AccessExclusiveLock"</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Directive'>#ifndef</span> LOCK_DEBUG 
<a name="LN121"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>Dummy_trace</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<a name="LN124"></a><span class='Keyword'>static const </span><a href="../../../include/storage/lock.h.html#LN111"><span class='Ref_to_Struct'>LockMethodData</span></a> <span class='Declare_Var'>default_lockmethod</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* highest valid lock mode number */ 
</span>    <a href="lock.c.html#LN64"><span class='Ref_to_Global_Var'>LockConflicts</span></a><span class='Delimiter'>, 
</span>    <a href="lock.c.html#LN107"><span class='Ref_to_Global_Var'>lock_mode_names</span></a><span class='Delimiter'>, 
</span><span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Operator'>&</span><a href="lock.c.html#LN283"><span class='Ref_to_Global_Var'>Trace_locks</span></a> 
<span class='Directive'>#else</span> 
    <span class='Operator'>&</span><a href="lock.c.html#LN121"><span class='Ref_to_Global_Var'>Dummy_trace</span></a> 
<span class='Directive'>#endif</span> 
<span class='Delimiter'>}; 
</span> 
<a name="LN135"></a><span class='Keyword'>static const </span><a href="../../../include/storage/lock.h.html#LN111"><span class='Ref_to_Struct'>LockMethodData</span></a> <span class='Declare_Var'>user_lockmethod</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* highest valid lock mode number */ 
</span>    <a href="lock.c.html#LN64"><span class='Ref_to_Global_Var'>LockConflicts</span></a><span class='Delimiter'>, 
</span>    <a href="lock.c.html#LN107"><span class='Ref_to_Global_Var'>lock_mode_names</span></a><span class='Delimiter'>, 
</span><span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Operator'>&</span><a href="lock.c.html#LN284"><span class='Ref_to_Global_Var'>Trace_userlocks</span></a> 
<span class='Directive'>#else</span> 
    <span class='Operator'>&</span><a href="lock.c.html#LN121"><span class='Ref_to_Global_Var'>Dummy_trace</span></a> 
<span class='Directive'>#endif</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * map from lock method id to the lock table data structures 
 */ 
</span><a name="LN149"></a><span class='Keyword'>static const </span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Var'>LockMethods</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>    <span class='Operator'>&</span><a href="lock.c.html#LN124"><span class='Ref_to_Global_Var'>default_lockmethod</span></a><span class='Delimiter'>, 
</span>    <span class='Operator'>&</span><a href="lock.c.html#LN135"><span class='Ref_to_Global_Var'>user_lockmethod</span></a> 
<span class='Delimiter'>}; 
</span> 
 
<span class='Comment_Multi_Line'>/* Record that's written to 2PC state file when a lock is persisted */ 
</span><a name="LN157"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TwoPhaseLockRecord</span> 
<span class='Delimiter'>{ 
</span><a name="LN159"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Member'>locktag</span><span class='Delimiter'>; 
</span><a name="LN160"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Member'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN161"></a>} <span class='Declare_Typedef'>TwoPhaseLockRecord</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Count of the number of fast path lock slots we believe to be used.  This 
 * might be higher than the real number if another backend has transferred 
 * our locks to the primary lock table, but it can never be lower than the 
 * real value, since only we can acquire locks on our own behalf. 
 */ 
</span><a name="LN170"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>FastPathLocalUseCount</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Macros for manipulating proc-&GT;fpLockBits */ 
</span><a name="LN173"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FAST_PATH_BITS_PER_SLOT</span>         <span class='Number'>3</span> 
<a name="LN174"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FAST_PATH_LOCKNUMBER_OFFSET</span>     <span class='Number'>1</span> 
<a name="LN175"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FAST_PATH_MASK</span>                  <span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN173"><span class='Ref_to_Const'>FAST_PATH_BITS_PER_SLOT</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<a name="LN176"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FAST_PATH_GET_BITS</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><a href="lock.c.html#LN176"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fpLockBits <span class='Operator'>&GT;&GT; </span><span class='Parentheses'>(</span><a href="lock.c.html#LN173"><span class='Ref_to_Const'>FAST_PATH_BITS_PER_SLOT</span></a> <span class='Operator'>* </span><a href="lock.c.html#LN176"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>))</span> <span class='Operator'>& </span><a href="lock.c.html#LN175"><span class='Ref_to_Const'>FAST_PATH_MASK</span></a><span class='Parentheses'>)</span> 
<a name="LN178"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FAST_PATH_BIT_POSITION</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>l</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN675"><span class='Ref_to_Macro'>AssertMacro</span></a><span class='Parentheses'>((</span><a href="lock.c.html#LN178"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>     <a href="../../../include/c.h.html#LN675"><span class='Ref_to_Macro'>AssertMacro</span></a><span class='Parentheses'>((</span><a href="lock.c.html#LN178"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="lock.c.html#LN173"><span class='Ref_to_Const'>FAST_PATH_BITS_PER_SLOT</span></a><span class='Operator'>+</span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>     <a href="../../../include/c.h.html#LN675"><span class='Ref_to_Macro'>AssertMacro</span></a><span class='Parentheses'>((</span><a href="lock.c.html#LN178"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>     <span class='Parentheses'>((</span><a href="lock.c.html#LN178"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a> <span class='Operator'>+ </span><a href="lock.c.html#LN173"><span class='Ref_to_Const'>FAST_PATH_BITS_PER_SLOT</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="lock.c.html#LN178"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)))</span> 
<a name="LN183"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FAST_PATH_SET_LOCKMODE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>l</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>     <span class='Parentheses'>(</span><a href="lock.c.html#LN183"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fpLockBits <span class='Operator'>|= </span><a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN178"><span class='Ref_to_Macro'>FAST_PATH_BIT_POSITION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN183"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN183"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>) 
</span><a name="LN185"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FAST_PATH_CLEAR_LOCKMODE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>l</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>     <span class='Parentheses'>(</span><a href="lock.c.html#LN185"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fpLockBits <span class='Operator'>&= ~</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN178"><span class='Ref_to_Macro'>FAST_PATH_BIT_POSITION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN185"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN185"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>))</span> 
<a name="LN187"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FAST_PATH_CHECK_LOCKMODE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>l</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>     <span class='Parentheses'>((</span><a href="lock.c.html#LN187"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>fpLockBits <span class='Operator'>& </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN307"><span class='Ref_to_Macro'>UINT64CONST</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN178"><span class='Ref_to_Macro'>FAST_PATH_BIT_POSITION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN187"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN187"><span class='Ref_to_Parameter'>l</span></a><span class='Parentheses'>)))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The fast-path lock mechanism is concerned only with relation locks on 
 * unshared relations by backends bound to a database.  The fast-path 
 * mechanism exists mostly to accelerate acquisition and release of locks 
 * that rarely conflict.  Because ShareUpdateExclusiveLock is 
 * self-conflicting, it can't use the fast-path mechanism; but it also does 
 * not conflict with any of the locks that do, so we can ignore it completely. 
 */ 
</span><a name="LN198"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>EligibleForRelationFastPath</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="lock.c.html#LN198"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_lockmethodid <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_type <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_field1 <span class='Operator'>== </span><a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>&& \ 
</span>    <a href="../../utils/init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span> 
<a name="LN204"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ConflictsWithRelationFastPath</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>mode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="lock.c.html#LN204"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_lockmethodid <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_type <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>locktag_field1 <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>&& \ 
</span>    <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Parameter'>mode</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="../../../include/storage/lockdefs.h.html#LN38"><span class='Ref_to_Const'>ShareUpdateExclusiveLock</span></a><span class='Parentheses'>)</span> 
 
<a name="LN210"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FastPathGrantRelationLock</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN211"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FastPathUnGrantRelationLock</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN212"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FastPathTransferRelationLocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, 
</span><a name="LN213"></a>                              <span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN214"></a><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>FastPathGetRelationLockEntry</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * To make the fast-path lock mechanism work, we must have some way of 
 * preventing the use of the fast-path when a conflicting lock might be 
 * present.  We partition* the locktag space into FAST_PATH_HASH_BUCKETS 
 * partitions, and maintain an integer count of the number of "strong" lockers 
 * in each partition.  When any "strong" lockers are present (which is 
 * hopefully not very often), the fast-path mechanism can't be used, and we 
 * must fall back to the slower method of pushing matching locks directly 
 * into the main lock tables. 
 * 
 * The deadlock detector does not know anything about the fast path mechanism, 
 * so any locks that might be involved in a deadlock must be transferred from 
 * the fast-path queues to the main lock table. 
 */ 
</span> 
<a name="LN231"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FAST_PATH_STRONG_LOCK_HASH_BITS</span>         <span class='Number'>10</span> 
<a name="LN232"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FAST_PATH_STRONG_LOCK_HASH_PARTITIONS</span> <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN231"><span class='Ref_to_Const'>FAST_PATH_STRONG_LOCK_HASH_BITS</span></a><span class='Parentheses'>) 
</span><a name="LN234"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FastPathStrongLockHashPartition</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="lock.c.html#LN234"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="lock.c.html#LN232"><span class='Ref_to_Const'>FAST_PATH_STRONG_LOCK_HASH_PARTITIONS</span></a><span class='Parentheses'>)</span> 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN239"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>count</span><span class='Delimiter'>[</span><a href="lock.c.html#LN232"><span class='Ref_to_Const'>FAST_PATH_STRONG_LOCK_HASH_PARTITIONS</span></a><span class='Delimiter'>]; 
</span><a name="LN241"></a>} <span class='Declare_Typedef'>FastPathStrongRelationLockData</span><span class='Delimiter'>; 
</span> 
<a name="LN243"></a><span class='Keyword'>static volatile </span><a href="lock.c.html#LN237"><span class='Ref_to_Typedef'>FastPathStrongRelationLockData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>FastPathStrongRelationLocks</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Pointers to hash tables containing lock state 
 * 
 * The LockMethodLockHash and LockMethodProcLockHash hash tables are in 
 * shared memory; LockMethodLocalHash is local to each backend. 
 */ 
</span><a name="LN252"></a><span class='Keyword'>static </span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>LockMethodLockHash</span><span class='Delimiter'>; 
</span><a name="LN253"></a><span class='Keyword'>static </span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>LockMethodProcLockHash</span><span class='Delimiter'>; 
</span><a name="LN254"></a><span class='Keyword'>static </span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>LockMethodLocalHash</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* private state for error cleanup */ 
</span><a name="LN258"></a><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Var'>StrongLockInProgress</span><span class='Delimiter'>; 
</span><a name="LN259"></a><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Var'>awaitedLock</span><span class='Delimiter'>; 
</span><a name="LN260"></a><span class='Keyword'>static </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Var'>awaitedOwner</span><span class='Delimiter'>; 
</span> 
 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
 
<span class='Comment_Multi_Line'>/*------ 
 * The following configuration options are available for lock debugging: 
 * 
 *     TRACE_LOCKS      -- give a bunch of output what's going on in this file 
 *     TRACE_USERLOCKS  -- same but for user locks 
 *     TRACE_LOCK_OIDMIN-- do not trace locks for tables below this oid 
 *                         (use to avoid output on system tables) 
 *     TRACE_LOCK_TABLE -- trace locks on this table (oid) unconditionally 
 *     DEBUG_DEADLOCKS  -- currently dumps locks at untimely occasions ;) 
 * 
 * Furthermore, but in storage/lmgr/lwlock.c: 
 *     TRACE_LWLOCKS    -- trace lightweight locks (pretty useless) 
 * 
 * Define LOCK_DEBUG at compile time to get all these enabled. 
 * -------- 
 */ 
</span> 
<a name="LN282"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Trace_lock_oidmin</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN93"><span class='Ref_to_Const'>FirstNormalObjectId</span></a><span class='Delimiter'>; 
</span><a name="LN283"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Trace_locks</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN284"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Trace_userlocks</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN285"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>Trace_lock_table</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN286"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>Debug_deadlocks</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
 
<span class='Keyword'>inline static bool 
</span><a name="LN290"></a><span class='Declare_Function'>LOCK_DEBUG_ENABLED</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> 
        <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN290"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN116"><span class='Ref_to_Member'>trace_flag</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>         <span class='Parentheses'>((</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>) </span><a href="lock.c.html#LN290"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>) </span><a href="lock.c.html#LN282"><span class='Ref_to_Global_Var'>Trace_lock_oidmin</span></a><span class='Parentheses'>))</span> 
        <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="lock.c.html#LN285"><span class='Ref_to_Global_Var'>Trace_lock_table</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="lock.c.html#LN290"><span class='Ref_to_Parameter'>tag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN285"><span class='Ref_to_Global_Var'>Trace_lock_table</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>inline static void 
</span><a name="LN301"></a><span class='Declare_Function'>LOCK_PRINT</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>where</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>type</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN289"><span class='Ref_to_Func'>LOCK_DEBUG_ENABLED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"%s: lock(%p) id(%u,%u,%u,%u,%u,%u) grantMask(%x) "</span> 
             <span class='String'>"req(%d,%d,%d,%d,%d,%d,%d)=%d "</span> 
             <span class='String'>"grant(%d,%d,%d,%d,%d,%d,%d)=%d wait(%d) type(%s)"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>where</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN183"><span class='Ref_to_Member'>locktag_field4</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>], </span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN300"><span class='Ref_to_Macro'>LOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN301"><span class='Ref_to_Parameter'>type</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LOCK_PRINT &raquo; </span> 
 
 
<span class='Keyword'>inline static void 
</span><a name="LN325"></a><span class='Declare_Function'>PROCLOCK_PRINT</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>where</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclockP</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN289"><span class='Ref_to_Func'>LOCK_DEBUG_ENABLED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Operator'>-&GT;</span>tag<span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"%s: proclock(%p) lock(%p) method(%u) proc(%p) hold(%x)"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>where</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>, 
</span>             <a href="../../../include/storage/lock.h.html#LN357"><span class='Ref_to_Macro'>PROCLOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <a href="lock.c.html#LN325"><span class='Ref_to_Parameter'>proclockP</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* not LOCK_DEBUG */ 
</span> 
<a name="LN336"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>LOCK_PRINT</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>where</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>type</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<a name="LN337"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PROCLOCK_PRINT</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>where</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>proclockP</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* not LOCK_DEBUG */ 
</span> 
 
<a name="LN341"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Prototype'>proclock_hash</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>keysize</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN342"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>RemoveLocalLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN343"></a><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>SetupLockInTable</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, 
</span><a name="LN344"></a>                 <span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN345"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>GrantLockLocal</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN346"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>BeginStrongLockAcquire</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>fasthashcode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN347"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FinishStrongLockAcquire</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN348"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WaitOnLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN349"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReleaseLockIfHeld</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN350"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>LockReassignOwner</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>parent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN351"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>UnGrantLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN352"></a>            <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN353"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>CleanUpLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Delimiter'>, 
</span><a name="LN354"></a>            <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Delimiter'>, 
</span><a name="LN355"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>wakeupNeeded</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN356"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>LockRefindAndRelease</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, 
</span><a name="LN357"></a>                     <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN358"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>decrement_strong_lock_count</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN359"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>GetSingleProcBlockerStatusData</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>blocked_proc</span><span class='Delimiter'>, 
</span><a name="LN360"></a>                               <a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * InitLocks -- Initialize the lock manager's data structures. 
 * 
 * This is called from CreateSharedMemoryAndSemaphores(), which see for 
 * more comments.  In the normal postmaster case, the shared hash tables 
 * are created here, as well as a locallock hash table that will remain 
 * unused and empty in the postmaster itself.  Backends inherit the pointers 
 * to the shared tables via fork(), and also inherit an image of the locallock 
 * hash table, which they proceed to use.  In the EXEC_BACKEND case, each 
 * backend re-executes this code to obtain pointers to the already existing 
 * shared hash tables and to create its locallock hash table. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN376"></a><span class='Declare_Function'>InitLocks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN378"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>info</span><span class='Delimiter'>; 
</span><a name="LN379"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>init_table_size</span><span class='Delimiter'>, 
</span><a name="LN380"></a>                <span class='Declare_Local'>max_table_size</span><span class='Delimiter'>; 
</span><a name="LN381"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute init/max size to request for lock hashtables.  Note these 
     * calculations must agree with LockShmemSize! 
     */ 
</span>    <a href="lock.c.html#LN380"><span class='Ref_To_Local'>max_table_size</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN55"><span class='Ref_to_Macro'>NLOCKENTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN379"><span class='Ref_To_Local'>init_table_size</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN380"><span class='Ref_To_Local'>max_table_size</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate hash table for LOCK structs.  This stores per-locked-object 
     * information. 
     */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN66"><span class='Ref_to_Member'>num_partitions</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN41"><span class='Ref_to_Proto'>ShmemInitHash</span></a><span class='Parentheses'>(</span><span class='String'>"LOCK hash"</span><span class='Delimiter'>, 
</span>                                       <a href="lock.c.html#LN379"><span class='Ref_To_Local'>init_table_size</span></a><span class='Delimiter'>, 
</span>                                       <a href="lock.c.html#LN380"><span class='Ref_To_Local'>max_table_size</span></a><span class='Delimiter'>, 
</span>                                       <span class='Operator'>&</span><a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN82"><span class='Ref_to_Const'>HASH_PARTITION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assume an average of 2 holders per lock */ 
</span>    <a href="lock.c.html#LN380"><span class='Ref_To_Local'>max_table_size</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN379"><span class='Ref_To_Local'>init_table_size</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate hash table for PROCLOCK structs.  This stores 
     * per-lock-per-holder information. 
     */ 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN73"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN341"><span class='Ref_to_Proto'>proclock_hash</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN66"><span class='Ref_to_Member'>num_partitions</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN41"><span class='Ref_to_Proto'>ShmemInitHash</span></a><span class='Parentheses'>(</span><span class='String'>"PROCLOCK hash"</span><span class='Delimiter'>, 
</span>                                           <a href="lock.c.html#LN379"><span class='Ref_To_Local'>init_table_size</span></a><span class='Delimiter'>, 
</span>                                           <a href="lock.c.html#LN380"><span class='Ref_To_Local'>max_table_size</span></a><span class='Delimiter'>, 
</span>                                           <span class='Operator'>&</span><a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN88"><span class='Ref_to_Const'>HASH_FUNCTION</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN82"><span class='Ref_to_Const'>HASH_PARTITION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate fast-path structures. 
     */ 
</span>    <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"Fast Path Strong Relation Lock Data"</span><span class='Delimiter'>, 
</span>                        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN237"><span class='Ref_to_Typedef'>FastPathStrongRelationLockData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN381"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN381"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate non-shared hash table for LOCALLOCK structs.  This stores lock 
     * counts and resource owner information. 
     * 
     * The non-shared table could already exist in this process (this occurs 
     * when the postmaster is recreating shared memory after a backend crash). 
     * If so, delete and recreate it.  (We could simply leave it, since it 
     * ought to be empty in the postmaster, but for safety let's zap it.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN383"><span class='Ref_to_Struct'>LOCALLOCKTAG</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"LOCALLOCK hash"</span><span class='Delimiter'>, 
</span>                                      <span class='Number'>16</span><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="lock.c.html#LN378"><span class='Ref_To_Local'>info</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitLocks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch the lock method table associated with a given lock 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> 
<a name="LN459"></a><span class='Declare_Function'>GetLocksMethodTable</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN461"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN300"><span class='Ref_to_Macro'>LOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN459"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Number'>0</span> <span class='Operator'>&LT; </span><a href="lock.c.html#LN461"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&& </span><a href="lock.c.html#LN461"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN461"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Fetch the lock method table associated with a given locktag 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> 
<a name="LN471"></a><span class='Declare_Function'>GetLockTagsMethodTable</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN473"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a><span class='Parentheses'>) </span><a href="lock.c.html#LN471"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Number'>0</span> <span class='Operator'>&LT; </span><a href="lock.c.html#LN473"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&& </span><a href="lock.c.html#LN473"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN473"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute the hash code associated with a LOCKTAG. 
 * 
 * To avoid unnecessary recomputations of the hash code, we try to do this 
 * just once per function, and then pass it around as needed.  Aside from 
 * passing the hashcode to hash_search_with_hash_value(), we can extract 
 * the lock partition number from the hashcode. 
 */ 
</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN489"></a><span class='Declare_Function'>LockTagHashCode</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/hsearch.h.html#LN127"><span class='Ref_to_Proto'>get_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN489"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compute the hash code associated with a PROCLOCKTAG. 
 * 
 * Because we want to use just one set of partition locks for both the 
 * LOCK and PROCLOCK hash tables, we have to make sure that PROCLOCKs 
 * fall into the same partition number as their associated LOCKs. 
 * dynahash.c expects the partition number to be the low-order bits of 
 * the hash code, and therefore a PROCLOCKTAG's hash code must have the 
 * same low-order bits as the associated LOCKTAG's hash code.  We achieve 
 * this with this specialized hash function. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN506"></a><span class='Declare_Function'>proclock_hash</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>keysize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN508"></a>    <span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Local'>proclocktag</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN506"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>; 
</span><a name="LN509"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockhash</span><span class='Delimiter'>; 
</span><a name="LN510"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>procptr</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN506"><span class='Ref_to_Parameter'>keysize</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look into the associated LOCK object, and compute its hash code */ 
</span>    <a href="lock.c.html#LN509"><span class='Ref_To_Local'>lockhash</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN508"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To make the hash code also depend on the PGPROC, we xor the proc 
     * struct's address into the hash code, left-shifted so that the 
     * partition-number bits don't change.  Since this is only a hash, we 
     * don't care if we lose high-order bits of the address; use an 
     * intermediate variable to suppress cast-pointer-to-int warnings. 
     */ 
</span>    <a href="lock.c.html#LN510"><span class='Ref_To_Local'>procptr</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN508"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN509"><span class='Ref_To_Local'>lockhash</span></a> <span class='Operator'>^= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="lock.c.html#LN510"><span class='Ref_To_Local'>procptr</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><a href="../../../include/storage/lwlock.h.html#LN115"><span class='Ref_to_Const'>LOG2_NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN509"><span class='Ref_To_Local'>lockhash</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end proclock_hash &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute the hash code associated with a PROCLOCKTAG, given the hashcode 
 * for its underlying LOCK. 
 * 
 * We use this just to avoid redundant calls of LockTagHashCode(). 
 */ 
</span><span class='Keyword'>static inline </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN537"></a><span class='Declare_Function'>ProcLockHashCode</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclocktag</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN539"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockhash</span> <span class='Operator'>= </span><a href="lock.c.html#LN537"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>; 
</span><a name="LN540"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>procptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This must match proclock_hash()! 
     */ 
</span>    <a href="lock.c.html#LN540"><span class='Ref_To_Local'>procptr</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN537"><span class='Ref_to_Parameter'>proclocktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN539"><span class='Ref_To_Local'>lockhash</span></a> <span class='Operator'>^= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="lock.c.html#LN540"><span class='Ref_To_Local'>procptr</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><a href="../../../include/storage/lwlock.h.html#LN115"><span class='Ref_to_Const'>LOG2_NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN539"><span class='Ref_To_Local'>lockhash</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Given two lock modes, return whether they would conflict. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN555"></a><span class='Declare_Function'>DoLockModesConflict</span><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>mode1</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>mode2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN557"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN557"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN555"><span class='Ref_to_Parameter'>mode1</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN555"><span class='Ref_to_Parameter'>mode2</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * LockHasWaiters -- look up 'locktag' and check if releasing this 
 *      lock would wake up other processes waiting for it. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN570"></a><span class='Declare_Function'>LockHasWaiters</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN572"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span><a name="LN573"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN574"></a>    <a href="../../../include/storage/lock.h.html#LN383"><span class='Ref_to_Struct'>LOCALLOCKTAG</span></a> <span class='Declare_Local'>localtag</span><span class='Delimiter'>; 
</span><a name="LN575"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span><a name="LN576"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN577"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN578"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN579"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>hasWaiters</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN572"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN572"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN572"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN572"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock mode: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN289"><span class='Ref_to_Func'>LOCK_DEBUG_ENABLED</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LockHasWaiters: lock [%u,%u] %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Find the LOCALLOCK entry for this lock and lockmode 
     */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN574"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN574"><span class='Ref_To_Local'>localtag</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* must clear padding */ 
</span>    <a href="lock.c.html#LN574"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN385"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= *</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN574"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN386"><span class='Ref_to_Member'>mode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN574"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * let the caller print its own error message, too. Do not ereport(ERROR). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>|| </span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check the shared lock table. 
     */ 
</span>    <a href="lock.c.html#LN578"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN578"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't need to re-find the lock or proclock, since we kept their 
     * addresses in the locallock table, and they couldn't have been removed 
     * while we were holding a lock on them. 
     */ 
</span>    <a href="lock.c.html#LN576"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockHasWaiters: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN576"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN577"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockHasWaiters: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN577"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Double-check that we are actually holding a lock of the type we want to 
     * release. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="lock.c.html#LN577"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockHasWaiters: WRONGTYPE"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN577"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN578"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN575"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the checking. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN573"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN570"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><a href="lock.c.html#LN576"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="lock.c.html#LN579"><span class='Ref_To_Local'>hasWaiters</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN578"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN579"><span class='Ref_To_Local'>hasWaiters</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockHasWaiters &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockAcquire -- Check for lock conflicts, sleep if conflict found, 
 *      set lock if/when no conflicts. 
 * 
 * Inputs: 
 *  locktag: unique identifier for the lockable object 
 *  lockmode: lock mode to acquire 
 *  sessionLock: if true, acquire lock for session not current transaction 
 *  dontWait: if true, don't wait to acquire lock 
 * 
 * Returns one of: 
 *      LOCKACQUIRE_NOT_AVAIL       lock not available, and dontWait=true 
 *      LOCKACQUIRE_OK              lock successfully acquired 
 *      LOCKACQUIRE_ALREADY_HELD    incremented count for lock already held 
 * 
 * In the normal case where dontWait=false and the caller doesn't need to 
 * distinguish a freshly acquired lock from one already taken earlier in 
 * this same transaction, there is no need to examine the return value. 
 * 
 * Side Effects: The lock is acquired and recorded in lock tables. 
 * 
 * NOTE: if we wait for the lock, there is no way to abort the wait 
 * short of aborting the transaction. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> 
<a name="LN682"></a><span class='Declare_Function'>LockAcquire</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, 
</span><a name="LN683"></a>            <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN684"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Delimiter'>, 
</span><a name="LN685"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>dontWait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN527"><span class='Ref_to_Proto'>LockAcquireExtended</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN682"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN683"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN684"><span class='Ref_to_Parameter'>sessionLock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN685"><span class='Ref_to_Parameter'>dontWait</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * LockAcquireExtended - allows us to specify additional options 
 * 
 * reportMemoryError specifies whether a lock request that fills the 
 * lock table should generate an ERROR or not. This allows a priority 
 * caller to note that the lock table is full and then begin taking 
 * extreme action to reduce the number of other lock holders before 
 * retrying the action. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN471"><span class='Ref_to_Typedef'>LockAcquireResult</span></a> 
<a name="LN700"></a><span class='Declare_Function'>LockAcquireExtended</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, 
</span><a name="LN701"></a>                    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN702"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Delimiter'>, 
</span><a name="LN703"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>dontWait</span><span class='Delimiter'>, 
</span><a name="LN704"></a>                    <span class='Keyword'>bool </span><span class='Declare_Parameter'>reportMemoryError</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN706"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span><a name="LN707"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN708"></a>    <a href="../../../include/storage/lock.h.html#LN383"><span class='Ref_to_Struct'>LOCALLOCKTAG</span></a> <span class='Declare_Local'>localtag</span><span class='Delimiter'>; 
</span><a name="LN709"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span><a name="LN710"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN711"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN712"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN713"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>owner</span><span class='Delimiter'>; 
</span><a name="LN714"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN716"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN717"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>log_lock</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN706"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN706"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN706"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN706"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock mode: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>() </span><span class='Operator'>&& !</span><a href="../../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN154"><span class='Ref_to_EnumConst'>LOCKTAG_OBJECT</span></a> <span class='Operator'>|| 
</span>         <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot acquire lock mode %s on database objects while recovery is in progress"</span><span class='Delimiter'>, 
</span>                        <a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Only RowExclusiveLock or less can be acquired on database objects during recovery."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN289"><span class='Ref_to_Func'>LOCK_DEBUG_ENABLED</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LockAcquire: lock [%u,%u] %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Identify owner for lock */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN702"><span class='Ref_to_Parameter'>sessionLock</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a LOCALLOCK entry for this lock and lockmode 
     */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* must clear padding */ 
</span>    <a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN385"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= *</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN386"><span class='Ref_to_Member'>mode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN712"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if it's a new locallock object, initialize it 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN712"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN708"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN385"><span class='Ref_to_Member'>lock</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a> <span class='Operator'>= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* in case next line fails */ 
</span>        <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                          <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Make sure there will be room to remember the lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>&GT;= </span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN781"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>newsize</span> <span class='Operator'>= </span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>, 
</span>                         <a href="lock.c.html#LN781"><span class='Ref_To_Local'>newsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN781"><span class='Ref_To_Local'>newsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we already hold the lock, we can just increase the count locally. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN345"><span class='Ref_to_Proto'>GrantLockLocal</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN475"><span class='Ref_to_EnumConst'>LOCKACQUIRE_ALREADY_HELD</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare to emit a WAL record if acquisition of this lock needs to be 
     * replayed in a standby server. 
     * 
     * Here we prepare to log; after lock is acquired we'll issue log record. 
     * This arrangement simplifies error recovery in case the preparation step 
     * fails. 
     * 
     * Only AccessExclusiveLocks can conflict with lock types that read-only 
     * transactions can acquire in a standby server. Make sure this definition 
     * matches the one in GetRunningTransactionLocks(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a> <span class='Operator'>&& 
</span>        <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/access/xlog.h.html#LN242"><span class='Ref_to_Proto'>RecoveryInProgress</span></a><span class='Parentheses'>() </span><span class='Operator'>&& 
</span>        <a href="../../../include/access/xlog.h.html#LN158"><span class='Ref_to_Macro'>XLogStandbyInfoActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/standby.h.html#LN84"><span class='Ref_to_Proto'>LogAccessExclusiveLockPrepare</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN717"><span class='Ref_To_Local'>log_lock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Attempt to take lock via fast path, if eligible.  But if we remember 
     * having filled up the fast path array, we don't attempt to make any 
     * further use of it until we release some locks.  It's possible that some 
     * other backend has transferred some of those locks to the shared hash 
     * table, leaving space free, but it's not worth acquiring the LWLock just 
     * to check.  It's also possible that we're acquiring a second or third 
     * lock type on a relation we have already locked using the fast-path, but 
     * for now we don't worry about that case either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Macro'>EligibleForRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="lock.c.html#LN170"><span class='Ref_to_Global_Var'>FastPathLocalUseCount</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN834"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN835"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>acquired</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * LWLockAcquire acts as a memory sequencing point, so it's safe to 
         * assume that any strong locker whose increment to 
         * FastPathStrongRelationLocks-&GT;counts becomes visible after we test 
         * it has yet to begin to transfer fast-path locks. 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN834"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN835"><span class='Ref_To_Local'>acquired</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="lock.c.html#LN835"><span class='Ref_To_Local'>acquired</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN210"><span class='Ref_to_Proto'>FastPathGrantRelationLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                                                 <a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN835"><span class='Ref_To_Local'>acquired</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The locallock might contain stale pointers to some old shared 
             * objects; we MUST reset these to null before considering the 
             * lock to be acquired via fast-path. 
             */ 
</span>            <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN345"><span class='Ref_to_Proto'>GrantLockLocal</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN474"><span class='Ref_to_EnumConst'>LOCKACQUIRE_OK</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if EligibleForRelationFa... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If this lock could potentially have been taken via the fast-path by 
     * some other backend, we must (temporarily) disable further use of the 
     * fast-path for this lock tag, and migrate any locks already taken via 
     * this method to the main lock table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Macro'>ConflictsWithRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN872"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN346"><span class='Ref_to_Proto'>BeginStrongLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN872"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN212"><span class='Ref_to_Proto'>FastPathTransferRelationLocks</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                           <a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lock.h.html#LN532"><span class='Ref_to_Proto'>AbortStrongLockAcquire</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN704"><span class='Ref_to_Parameter'>reportMemoryError</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We didn't find the lock in our LOCALLOCK table, and we didn't manage to 
     * take it via the fast-path, either, so we've got to mess with the shared 
     * lock table. 
     */ 
</span>    <a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create lock and proclock entries with this tag 
     * 
     * Note: if the locallock object already existed, it might have a pointer 
     * to the lock already ... but we should not assume that that pointer is 
     * valid, since a lock object with zero hold and request counts can go 
     * away anytime.  So we have to use SetupLockInTable() to recompute the 
     * lock and proclock pointers, even if they're already set. 
     */ 
</span>    <a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN343"><span class='Ref_to_Proto'>SetupLockInTable</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                <a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lock.h.html#LN532"><span class='Ref_to_Proto'>AbortStrongLockAcquire</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN704"><span class='Ref_to_Parameter'>reportMemoryError</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If lock requested conflicts with locks requested by waiters, must join 
     * wait queue.  Otherwise, check for conflict with already-held locks. 
     * (That's last because most complex check.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN716"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN977"><span class='Ref_to_Const'>STATUS_FOUND</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="lock.c.html#LN716"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN545"><span class='Ref_to_Proto'>LockCheckConflicts</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN707"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, 
</span>                                    <a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN716"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No conflict with held or previously requested locks */ 
</span>        <a href="../../../include/storage/lock.h.html#LN548"><span class='Ref_to_Proto'>GrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN345"><span class='Ref_to_Proto'>GrantLockLocal</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN716"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN977"><span class='Ref_to_Const'>STATUS_FOUND</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We can't acquire the lock immediately.  If caller specified no 
         * blocking, remove useless table entries and return NOT_AVAIL without 
         * waiting. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN703"><span class='Ref_to_Parameter'>dontWait</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lock.h.html#LN532"><span class='Ref_to_Proto'>AbortStrongLockAcquire</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN956"></a>                <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span> 
                <a href="lock.c.html#LN956"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN714"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                                 <a href="lock.c.html#LN956"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"proclock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: NOWAIT"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: conditional lock failed"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN473"><span class='Ref_to_EnumConst'>LOCKACQUIRE_NOT_AVAIL</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if dontWait &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Set bitmask of locks this process already holds on this object. 
         */ 
</span>        <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN137"><span class='Ref_to_Member'>heldLocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Sleep till someone wakes me up. 
         */ 
</span> 
        TRACE_POSTGRESQL_LOCK_WAIT_START<span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN183"><span class='Ref_to_Member'>locktag_field4</span></a><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN348"><span class='Ref_to_Proto'>WaitOnLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN709"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN713"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        TRACE_POSTGRESQL_LOCK_WAIT_DONE<span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN183"><span class='Ref_to_Member'>locktag_field4</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * NOTE: do not do any material change of state between here and 
         * return.  All required changes in locktable state must have been 
         * done when the lock was granted to us --- see notes in WaitOnLock. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check the proclock entry status, in case something in the ipc 
         * communication doesn't work correctly. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lock.h.html#LN532"><span class='Ref_to_Proto'>AbortStrongLockAcquire</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: INCONSISTENT"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: INCONSISTENT"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Should we retry ? */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"LockAcquire failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: granted"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN711"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: granted"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN710"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN701"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Lock state is fully up-to-date now; if we error out after this, no 
     * special error cleanup is required. 
     */ 
</span>    <a href="lock.c.html#LN347"><span class='Ref_to_Proto'>FinishStrongLockAcquire</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN715"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Emit a WAL record if acquisition of this lock needs to be replayed in a 
     * standby server. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN717"><span class='Ref_To_Local'>log_lock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Decode the locktag back to the original values, to avoid sending 
         * lots of empty bytes with every message.  See lock.h to check how a 
         * locktag is defined for LOCKTAG_RELATION 
         */ 
</span>        <a href="../../../include/storage/standby.h.html#LN83"><span class='Ref_to_Proto'>LogAccessExclusiveLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, 
</span>                               <a href="lock.c.html#LN700"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="../../../include/storage/lock.h.html#LN474"><span class='Ref_to_EnumConst'>LOCKACQUIRE_OK</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockAcquireExtended &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find or create LOCK and PROCLOCK objects as needed for a new lock 
 * request. 
 * 
 * Returns the PROCLOCK object, or NULL if we failed to create the objects 
 * for lack of shared memory. 
 * 
 * The appropriate partition lock must be held at entry, and will be 
 * held at exit. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>* 
</span><a name="LN1066"></a><span class='Declare_Function'>SetupLockInTable</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, 
</span><a name="LN1067"></a>                 <span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1069"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN1071"></a>    <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a lock with this tag. 
     */ 
</span>    <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="lock.c.html#LN1073"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if it's a new lock object, initialize it 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1073"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../ipc/shmqueue.c.html#LN34"><span class='Ref_to_Func'>SHMQueueInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/proc.h.html#LN299"><span class='Ref_to_Proto'>ProcQueueInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: new"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the hash key for the proclock table. 
     */ 
</span>    <a href="lock.c.html#LN1071"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1071"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN1072"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1071"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a proclock entry with this tag 
     */ 
</span>    <a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN1071"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, 
</span>                                                        <a href="lock.c.html#LN1072"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                                        <a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Operator'>&</span><a href="lock.c.html#LN1073"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Oops, not enough shmem for the proclock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There are no other requestors of this lock, so garbage-collect 
             * the lock object.  We *must* do this to avoid a permanent leak 
             * of shared memory, because there won't be anything to cause 
             * anyone to release the lock object later. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN76"><span class='Ref_to_Proto'>SHMQueueEmpty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                             <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                                             <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"lock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !proclock &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If new, initialize the new entry 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1073"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1152"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>partition</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN495"><span class='Ref_to_Macro'>LockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * It might seem unsafe to access proclock-&GT;groupLeader without a 
         * lock, but it's not really.  Either we are initializing a proclock 
         * on our own behalf, in which case our group leader isn't changing 
         * because the group leader for a process can only ever be changed by 
         * the process itself; or else we are transferring a fast-path lock to 
         * the main lock table, in which case that process can't change it's 
         * lock group leader without first releasing all of its locks (and in 
         * particular the one we are currently transferring). 
         */ 
</span>        <a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>? 
</span>            <a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>: </span><a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Add proclock to appropriate lists */ 
</span>        <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1152"><span class='Ref_To_Local'>partition</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: new"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !found &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockAcquire: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& ~</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> CHECK_DEADLOCK_RISK 
 
        <span class='Comment_Multi_Line'>/* 
         * Issue warning if we already hold a lower-level lock on this object 
         * and do not hold a lock of the requested level or higher. This 
         * indicates a deadlock-prone coding practice (eg, we'd have a 
         * deadlock if another backend were following the same code path at 
         * about the same time). 
         * 
         * This is not enabled by default, because it may generate log entries 
         * about user-level coding practices that are in fact safe in context. 
         * It can be enabled to help find system-level problems. 
         * 
         * XXX Doing numeric comparison on the lockmodes is a hack; it'd be 
         * better to use a table.  For now, though, this works. 
         */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1196"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span> 
                        <span class='Control'>break</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* safe: we have a lock &GT;= req level */ 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"deadlock risk: raising lock level"</span> 
                         <span class='String'>" from %s to %s on object %u/%u/%u"</span><span class='Delimiter'>, 
</span>                         <a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1196"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                         <a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>], 
</span>                         <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                         <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* CHECK_DEADLOCK_RISK */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * lock-&GT;nRequested and lock-&GT;requested[] count the total number of 
     * requests, whether granted or waiting, so increment those immediately. 
     * The other counts don't increment till we get the lock. 
     */ 
</span>    <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We shouldn't already hold the desired lock; else locallock table is 
     * broken. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"lock %s on object %u/%u/%u is already held"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1066"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1067"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1069"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN1070"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetupLockInTable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine to free a locallock entry 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1243"></a><span class='Declare_Function'>RemoveLocalLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1245"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1245"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1245"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1245"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1245"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/resowner_private.h.html#LN34"><span class='Ref_to_Proto'>ResourceOwnerForgetLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1245"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1259"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN1259"><span class='Ref_To_Local'>fasthashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1259"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1259"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1243"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"locallock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveLocalLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockCheckConflicts -- test whether requested lock conflicts 
 *      with those already granted 
 * 
 * Returns STATUS_FOUND if conflict, STATUS_OK if no conflict. 
 * 
 * NOTES: 
 *      Here's what makes this complicated: one process's locks don't 
 * conflict with one another, no matter what purpose they are held for 
 * (eg, session and transaction locks do not conflict).  Nor do the locks 
 * of one process in a lock group conflict with those of another process in 
 * the same group.  So, we must subtract off these locks when determining 
 * whether the requested new lock conflicts with those already held. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN1291"></a><span class='Declare_Function'>LockCheckConflicts</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, 
</span><a name="LN1292"></a>                   <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1293"></a>                   <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, 
</span><a name="LN1294"></a>                   <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1296"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numLockModes</span> <span class='Operator'>= </span><a href="lock.c.html#LN1291"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Delimiter'>; 
</span><a name="LN1297"></a>    <a href="../../../include/storage/lockdefs.h.html#LN24"><span class='Ref_to_Typedef'>LOCKMASK</span></a>    <span class='Declare_Local'>myLocks</span><span class='Delimiter'>; 
</span><a name="LN1298"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>conflictMask</span> <span class='Operator'>= </span><a href="lock.c.html#LN1291"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1292"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]; 
</span><a name="LN1299"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>conflictsRemaining</span><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Delimiter'>]; 
</span><a name="LN1300"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>totalConflictsRemaining</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1301"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1302"></a>    <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span><span class='Delimiter'>; 
</span><a name="LN1303"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>otherproclock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first check for global conflicts: If no locks conflict with my request, 
     * then I get the lock. 
     * 
     * Checking for conflict: lock-&GT;grantMask represents the types of 
     * currently held locks.  conflictTable[lockmode] has a bit set for each 
     * type of lock that conflicts with request.   Bitwise compare tells if 
     * there is a conflict. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1298"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>& </span><a href="lock.c.html#LN1293"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockCheckConflicts: no conflict"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Rats.  Something conflicts.  But it could still be my own lock, or a 
     * lock held by another member of my locking group.  First, figure out how 
     * many conflicts remain after subtracting out any locks I hold myself. 
     */ 
</span>    <a href="lock.c.html#LN1297"><span class='Ref_To_Local'>myLocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN1296"><span class='Ref_To_Local'>numLockModes</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN1298"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN1293"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1297"><span class='Ref_To_Local'>myLocks</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
            <span class='Operator'>--</span><a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="lock.c.html#LN1300"><span class='Ref_To_Local'>totalConflictsRemaining</span></a> <span class='Operator'>+= </span><a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If no conflicts remain, we get the lock. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1300"><span class='Ref_To_Local'>totalConflictsRemaining</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockCheckConflicts: resolved (simple)"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If no group locking, it's definitely a conflict. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a> <span class='Operator'>&& </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockCheckConflicts: conflicting (simple)"</span><span class='Delimiter'>, 
</span>                       <a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/c.h.html#LN977"><span class='Ref_to_Const'>STATUS_FOUND</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Locks held in conflicting modes by members of our own lock group are 
     * not real conflicts; we can subtract those out and see if we still have 
     * a conflict.  This is O(N) in the number of processes holding or 
     * awaiting locks on this object.  We could improve that by making the 
     * shared memory state more complex (and larger) but it doesn't seem worth 
     * it. 
     */ 
</span>    <a href="lock.c.html#LN1302"><span class='Ref_To_Local'>procLocks</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1293"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1302"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1302"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a> <span class='Operator'>&& 
</span>            <a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>&& 
</span>            <span class='Parentheses'>(</span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="lock.c.html#LN1298"><span class='Ref_To_Local'>conflictMask</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1372"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>intersectMask</span> <span class='Operator'>= </span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="lock.c.html#LN1298"><span class='Ref_To_Local'>conflictMask</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN1296"><span class='Ref_To_Local'>numLockModes</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN1372"><span class='Ref_To_Local'>intersectMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"proclocks held do not match lock"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="lock.c.html#LN1299"><span class='Ref_To_Local'>conflictsRemaining</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1301"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                    <a href="lock.c.html#LN1300"><span class='Ref_To_Local'>totalConflictsRemaining</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1300"><span class='Ref_To_Local'>totalConflictsRemaining</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockCheckConflicts: resolved (group)"</span><span class='Delimiter'>, 
</span>                               <a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proclock!=otherproclo... &raquo; </span> 
        <a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1302"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN1303"><span class='Ref_To_Local'>otherproclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while otherproclock!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Nope, it's a real conflict. */ 
</span>    <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockCheckConflicts: conflicting (group)"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1294"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/c.h.html#LN977"><span class='Ref_to_Const'>STATUS_FOUND</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockCheckConflicts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GrantLock -- update the lock and proclock data structures to show 
 *      the lock request has been granted. 
 * 
 * NOTE: if proc was blocked, it also needs to be removed from the wait list 
 * and have its waitLock/waitProcLock fields cleared.  That's not done here. 
 * 
 * NOTE: the lock grant also has to be recorded in the associated LOCALLOCK 
 * table entry; but since we may be awaking some other process, we can't do 
 * that here; it's done by GrantLockLocal, instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1414"></a><span class='Declare_Function'>GrantLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a> <span class='Operator'>&= </span><a href="../../../include/storage/lock.h.html#LN88"><span class='Ref_to_Macro'>LOCKBIT_OFF</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"GrantLock"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN1414"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * UnGrantLock -- opposite of GrantLock. 
 * 
 * Updates the lock and proclock data structures to show that the lock 
 * is no longer held nor requested by the current holder. 
 * 
 * Returns true if there were any waiters waiting on the lock that 
 * should now be woken up with ProcLockWakeup. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1437"></a><span class='Declare_Function'>UnGrantLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN1438"></a>            <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1440"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>wakeupNeeded</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * fix the general lock stats 
     */ 
</span>    <a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* change the conflict mask.  No more of this lock type. */ 
</span>        <a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a> <span class='Operator'>&= </span><a href="../../../include/storage/lock.h.html#LN88"><span class='Ref_to_Macro'>LOCKBIT_OFF</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"UnGrantLock: updated"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need only run ProcLockWakeup if the released lock conflicts with at 
     * least one of the lock types requested by waiter(s).  Otherwise whatever 
     * conflict made them wait must still exist.  NOTE: before MVCC, we could 
     * skip wakeup if lock-&GT;granted[lockmode] was still positive. But that's 
     * not true anymore, because the remaining granted locks might belong to 
     * some waiter, who could now be awakened because he doesn't conflict with 
     * his own locks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1438"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>& </span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN1440"><span class='Ref_To_Local'>wakeupNeeded</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now fix the per-proclock state. 
     */ 
</span>    <a href="lock.c.html#LN1438"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>&= </span><a href="../../../include/storage/lock.h.html#LN88"><span class='Ref_to_Macro'>LOCKBIT_OFF</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1437"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"UnGrantLock: updated"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1438"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN1440"><span class='Ref_To_Local'>wakeupNeeded</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end UnGrantLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CleanUpLock -- clean up after releasing a lock.  We garbage-collect the 
 * proclock and lock objects if possible, and call ProcLockWakeup if there 
 * are remaining requests and the caller says it's OK.  (Normally, this 
 * should be called after UnGrantLock, and wakeupNeeded is the result from 
 * UnGrantLock.) 
 * 
 * The appropriate partition lock must be held at entry, and will be 
 * held at exit. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1494"></a><span class='Declare_Function'>CleanUpLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lock</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proclock</span><span class='Delimiter'>, 
</span><a name="LN1495"></a>            <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Delimiter'>, 
</span><a name="LN1496"></a>            <span class='Keyword'>bool </span><span class='Declare_Parameter'>wakeupNeeded</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If this was my last hold on this lock, delete my entry in the proclock 
     * table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1504"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"CleanUpLock: deleting"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1504"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1495"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN1504"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                                         <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"proclock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The caller just released the last lock, so garbage-collect the lock 
         * object. 
         */ 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"CleanUpLock: deleting"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN76"><span class='Ref_to_Proto'>SHMQueueEmpty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                         <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="lock.c.html#LN1495"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                                         <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"lock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1496"><span class='Ref_to_Parameter'>wakeupNeeded</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* There are waiters on this lock, so wake them up. */ 
</span>        <a href="../../../include/storage/proc.h.html#LN302"><span class='Ref_to_Proto'>ProcLockWakeup</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1495"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1494"><span class='Ref_to_Parameter'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end CleanUpLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GrantLockLocal -- update the locallock data structures to show 
 *      the lock request has been granted. 
 * 
 * We expect that LockAcquire made sure there is room to add a new 
 * ResourceOwner entry. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1548"></a><span class='Declare_Function'>GrantLockLocal</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1550"></a>    <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span> <span class='Operator'>= </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span><a name="LN1551"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN412"><span class='Ref_to_Member'>maxLockOwners</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Count the total */ 
</span>    <a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Count the per-owner lock */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1550"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>owner</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN1550"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="lock.c.html#LN1550"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1550"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1551"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>owner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN33"><span class='Ref_to_Proto'>ResourceOwnerRememberLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1548"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GrantLockLocal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BeginStrongLockAcquire - inhibit use of fastpath for a given LOCALLOCK, 
 * and arrange for error cleanup if it fails 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1577"></a><span class='Declare_Function'>BeginStrongLockAcquire</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>fasthashcode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN258"><span class='Ref_to_Global_Var'>StrongLockInProgress</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1577"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>== </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Adding to a memory location is not atomic, so we take a spinlock to 
     * ensure we don't collide with someone else trying to bump the count at 
     * the same time. 
     * 
     * XXX: It might be worth considering using an atomic fetch-and-add 
     * instruction here, on architectures where that is supported. 
     */ 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1577"><span class='Ref_to_Parameter'>fasthashcode</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1577"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>= </span><span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN258"><span class='Ref_to_Global_Var'>StrongLockInProgress</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1577"><span class='Ref_to_Parameter'>locallock</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BeginStrongLockAcquire &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FinishStrongLockAcquire - cancel pending cleanup for a strong lock 
 * acquisition once it's no longer needed 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1603"></a><span class='Declare_Function'>FinishStrongLockAcquire</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="lock.c.html#LN258"><span class='Ref_to_Global_Var'>StrongLockInProgress</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AbortStrongLockAcquire - undo strong lock state changes performed by 
 * BeginStrongLockAcquire. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1613"></a><span class='Declare_Function'>AbortStrongLockAcquire</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1615"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span><span class='Delimiter'>; 
</span><a name="LN1616"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span> <span class='Operator'>= </span><a href="lock.c.html#LN258"><span class='Ref_to_Global_Var'>StrongLockInProgress</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1616"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN1615"><span class='Ref_To_Local'>fasthashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1616"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1616"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>== </span><span class='Boolean'>TRUE</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1615"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1615"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1616"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN258"><span class='Ref_to_Global_Var'>StrongLockInProgress</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GrantAwaitedLock -- call GrantLockLocal for the lock we are doing 
 *      WaitOnLock on. 
 * 
 * proc.c needs this for the case where we are booted off the lock by 
 * timeout, but discover that someone granted us the lock anyway. 
 * 
 * We could just export GrantLockLocal, but that would require including 
 * resowner.h in lock.h, which creates circularity. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1642"></a><span class='Declare_Function'>GrantAwaitedLock</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="lock.c.html#LN345"><span class='Ref_to_Proto'>GrantLockLocal</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN259"><span class='Ref_to_Global_Var'>awaitedLock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN260"><span class='Ref_to_Global_Var'>awaitedOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * WaitOnLock -- wait to acquire a lock 
 * 
 * Caller must have set MyProc-&GT;heldLocks to reflect locks already held 
 * on the lockable object by this process. 
 * 
 * The appropriate partition lock must be held at entry. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1656"></a><span class='Declare_Function'>WaitOnLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1658"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN417"><span class='Ref_to_Macro'>LOCALLOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1659"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1658"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span><a name="LN1660"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Keyword'>volatile </span><span class='Declare_Local'>new_status</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"WaitOnLock: sleeping on lock"</span><span class='Delimiter'>, 
</span>               <a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report change to waiting status */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1668"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>old_status</span><span class='Delimiter'>; 
</span><a name="LN1669"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN1668"><span class='Ref_To_Local'>old_status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/ps_status.h.html#LN23"><span class='Ref_to_Proto'>get_ps_display</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1669"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1668"><span class='Ref_To_Local'>old_status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a> <span class='Operator'>+ </span><a href="lock.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><span class='String'>" waiting"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/ps_status.h.html#LN21"><span class='Ref_to_Proto'>set_ps_display</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1669"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* truncate off " waiting" */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="lock.c.html#LN259"><span class='Ref_to_Global_Var'>awaitedLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN260"><span class='Ref_to_Global_Var'>awaitedOwner</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * NOTE: Think not to put any shared-state cleanup after the call to 
     * ProcSleep, in either the normal or failure path.  The lock state must 
     * be fully set by the lock grantor, or by CheckDeadLock if we give up 
     * waiting for the lock.  This is necessary because of the possibility 
     * that a cancel/die interrupt will interrupt ProcSleep after someone else 
     * grants us the lock, but before we've noticed it. Hence, after granting, 
     * the locktable state must fully reflect the fact that we own the lock; 
     * we can't do additional work on return. 
     * 
     * We can and do use a PG_TRY block to try to clean up after failure, but 
     * this still has a major limitation: elog(FATAL) can occur while waiting 
     * (eg, a "die" interrupt), and then control won't come back here. So all 
     * cleanup of essential state should happen in LockErrorCleanup, not here. 
     * We can use PG_TRY to clear the "waiting" status flags, since doing that 
     * is unimportant if the process exits. 
     */ 
</span>    <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN300"><span class='Ref_to_Proto'>ProcSleep</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1659"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/c.h.html#LN974"><span class='Ref_to_Const'>STATUS_OK</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We failed as a result of a deadlock, see CheckDeadLock(). Quit 
             * now. 
             */ 
</span>            <a href="lock.c.html#LN259"><span class='Ref_to_Global_Var'>awaitedLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"WaitOnLock: aborting on lock"</span><span class='Delimiter'>, 
</span>                       <a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Now that we aren't holding the partition lock, we can give an 
             * error report including details about the detected deadlock. 
             */ 
</span>            <a href="deadlock.c.html#LN1075"><span class='Ref_to_Func'>DeadLockReport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* not reached */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* In this path, awaitedLock remains set until LockErrorCleanup */ 
</span> 
        <span class='Comment_Multi_Line'>/* Report change to non-waiting status */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/ps_status.h.html#LN21"><span class='Ref_to_Proto'>set_ps_display</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* and propagate the error */ 
</span>        <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN259"><span class='Ref_to_Global_Var'>awaitedLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Report change to non-waiting status */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/misc/ps_status.c.html#LN34"><span class='Ref_to_Global_Var'>update_process_title</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/ps_status.h.html#LN21"><span class='Ref_to_Proto'>set_ps_display</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1660"><span class='Ref_To_Local'>new_status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"WaitOnLock: wakeup on lock"</span><span class='Delimiter'>, 
</span>               <a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1656"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WaitOnLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove a proc from the wait-queue it is on (caller must know it is on one). 
 * This is only used when the proc has failed to get the lock, so we set its 
 * waitStatus to STATUS_ERROR. 
 * 
 * Appropriate partition lock must be held by caller.  Also, caller is 
 * responsible for signaling the proc if needed. 
 * 
 * NB: this does not clean up any locallock object that may exist for the lock. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1760"></a><span class='Declare_Function'>RemoveFromWaitQueue</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1762"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>waitLock</span> <span class='Operator'>= </span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Delimiter'>; 
</span><a name="LN1763"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span> <span class='Operator'>= </span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN135"><span class='Ref_to_Member'>waitProcLock</span></a><span class='Delimiter'>; 
</span><a name="LN1764"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span> <span class='Operator'>= </span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span><a name="LN1765"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN300"><span class='Ref_to_Macro'>LOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure proc is waiting */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN100"><span class='Ref_to_Member'>waitStatus</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN978"><span class='Ref_to_Const'>STATUS_WAITING</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Number'>0</span> <span class='Operator'>&LT; </span><a href="lock.c.html#LN1765"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&& </span><a href="lock.c.html#LN1765"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove proc from lock's wait queue */ 
</span>    <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Undo increments of request counts by waiting process */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1764"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1764"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* don't forget to clear waitMask bit if appropriate */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1764"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1764"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a> <span class='Operator'>&= </span><a href="../../../include/storage/lock.h.html#LN88"><span class='Ref_to_Macro'>LOCKBIT_OFF</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1764"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up the proc's own state, and pass it the ok/fail signal */ 
</span>    <a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN135"><span class='Ref_to_Member'>waitProcLock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN100"><span class='Ref_to_Member'>waitStatus</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN975"><span class='Ref_to_Const'>STATUS_ERROR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete the proclock immediately if it represents no already-held locks. 
     * (This must happen now because if the owner of the lock decides to 
     * release it, and the requested/granted counts then go to zero, 
     * LockRelease expects there to be no remaining proclocks.) Then see if 
     * any other waiters for the lock can be woken up now. 
     */ 
</span>    <a href="lock.c.html#LN353"><span class='Ref_to_Proto'>CleanUpLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1762"><span class='Ref_To_Local'>waitLock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1763"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                <a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1765"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>], </span><a href="lock.c.html#LN1760"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>, 
</span>                <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RemoveFromWaitQueue &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockRelease -- look up 'locktag' and release one 'lockmode' lock on it. 
 *      Release a session lock if 'sessionLock' is true, else release a 
 *      regular transaction lock. 
 * 
 * Side Effects: find any waiting processes that are now wakable, 
 *      grant them their requested locks and awaken them. 
 *      (We have to grant the lock here to avoid a race between 
 *      the waking process and any new process to 
 *      come along and request the lock.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1817"></a><span class='Declare_Function'>LockRelease</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1819"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span><a name="LN1820"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN1821"></a>    <a href="../../../include/storage/lock.h.html#LN383"><span class='Ref_to_Struct'>LOCALLOCKTAG</span></a> <span class='Declare_Local'>localtag</span><span class='Delimiter'>; 
</span><a name="LN1822"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span><a name="LN1823"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN1824"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN1825"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN1826"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>wakeupNeeded</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1819"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN1819"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1819"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1819"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock mode: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN289"><span class='Ref_to_Func'>LOCK_DEBUG_ENABLED</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LockRelease: lock [%u,%u] %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Find the LOCALLOCK entry for this lock and lockmode 
     */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN1821"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1821"><span class='Ref_To_Local'>localtag</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* must clear padding */ 
</span>    <a href="lock.c.html#LN1821"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN385"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= *</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1821"><span class='Ref_To_Local'>localtag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN386"><span class='Ref_to_Member'>mode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Delimiter'>, 
</span>                                          <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN1821"><span class='Ref_To_Local'>localtag</span></a><span class='Delimiter'>, 
</span>                                          <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * let the caller print its own error message, too. Do not ereport(ERROR). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>|| </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decrease the count for the resource owner. 
     */ 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1866"></a>        <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span> <span class='Operator'>= </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span><a name="LN1867"></a>        <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>owner</span><span class='Delimiter'>; 
</span><a name="LN1868"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Identify owner for lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>sessionLock</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN1867"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="lock.c.html#LN1867"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1866"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN1867"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1866"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="lock.c.html#LN1866"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1867"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/utils/resowner_private.h.html#LN34"><span class='Ref_to_Proto'>ResourceOwnerForgetLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1867"><span class='Ref_To_Local'>owner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* compact out unused slot */ 
</span>                    <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Parentheses'>) 
</span>                        <a href="lock.c.html#LN1866"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN1866"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Delimiter'>]; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1868"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* don't release a lock belonging to another owner */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>                 <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decrease the total local count.  If we're still holding the lock, we're 
     * done. 
     */ 
</span>    <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Attempt fast release of any lock eligible for the fast path. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Macro'>EligibleForRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="lock.c.html#LN170"><span class='Ref_to_Global_Var'>FastPathLocalUseCount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1915"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>released</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We might not find the lock here, even if we originally entered it 
         * here.  Another backend may have moved it to the main table. 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1915"><span class='Ref_To_Local'>released</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN211"><span class='Ref_to_Proto'>FastPathUnGrantRelationLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>                                               <a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN1915"><span class='Ref_To_Local'>released</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>TRUE</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise we've got to mess with the shared lock table. 
     */ 
</span>    <a href="lock.c.html#LN1825"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1825"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normally, we don't need to re-find the lock or proclock, since we kept 
     * their addresses in the locallock table, and they couldn't have been 
     * removed while we were holding a lock on them.  But it's possible that 
     * the lock was taken fast-path and has since been moved to the main hash 
     * table by another backend, in which case we will need to look up the 
     * objects here.  We assume the lock field is NULL if so. 
     */ 
</span>    <a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1950"></a>        <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN198"><span class='Ref_to_Macro'>EligibleForRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                                    <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                    <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared lock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN1950"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1950"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN1950"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, 
</span>                                                       <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                       <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared proclock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !lock &raquo; </span> 
    <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockRelease: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockRelease: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Double-check that we are actually holding a lock of the type we want to 
     * release. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockRelease: WRONGTYPE"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1825"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the releasing.  CleanUpLock will waken any now-wakable waiters. 
     */ 
</span>    <a href="lock.c.html#LN1826"><span class='Ref_To_Local'>wakeupNeeded</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN351"><span class='Ref_to_Proto'>UnGrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1817"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN353"><span class='Ref_to_Proto'>CleanUpLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1823"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1824"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                <a href="lock.c.html#LN1820"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Delimiter'>, 
</span>                <a href="lock.c.html#LN1826"><span class='Ref_To_Local'>wakeupNeeded</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1825"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN1822"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>TRUE</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockRelease &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockReleaseAll -- Release all locks of the specified lock method that 
 *      are held by the current process. 
 * 
 * Well, not necessarily *all* locks.  The available behaviors are: 
 *      allLocks == true: release all locks including session locks. 
 *      allLocks == false: release all non-session locks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2013"></a><span class='Declare_Function'>LockReleaseAll</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Parameter'>lockmethodid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allLocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2015"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN2016"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN2017"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN2018"></a>                <span class='Declare_Local'>numLockModes</span><span class='Delimiter'>; 
</span><a name="LN2019"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span><a name="LN2020"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN2021"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN2022"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>partition</span><span class='Delimiter'>; 
</span><a name="LN2023"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_fast_path_lwlock</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Delimiter'>]; 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN116"><span class='Ref_to_Member'>trace_flag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LockReleaseAll: lockmethod=%d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Get rid of our fast-path VXID lock, if appropriate.  Note that this is 
     * the only way that the lock we hold on our own VXID can ever get 
     * released: it is always and only released when a toplevel transaction 
     * ends. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lock.h.html#LN585"><span class='Ref_to_Proto'>VirtualXactLockTableCleanup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2018"><span class='Ref_To_Local'>numLockModes</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First we run through the locallock table and get rid of unwanted 
     * entries, then we scan the process's proclocks and get rid of those. We 
     * do this separately because we may have multiple locallock entries 
     * pointing to the same proclock, and we daren't end up with any dangling 
     * pointers.  Fast-path locks are cleaned up during the locallock table 
     * scan, though. 
     */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2015"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2015"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the LOCALLOCK entry is unused, we must've run out of shared 
         * memory while trying to set up this lock.  Just forget the local 
         * entry. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore items that are not of the lockmethod to be removed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN417"><span class='Ref_to_Macro'>LOCALLOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are asked to release all locks, we can just zap the entry. 
         * Otherwise, must scan to see if there are session locks. We assume 
         * there is at most one lockOwners entry for session locks. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>allLocks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2079"></a>            <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span> <span class='Operator'>= </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If session lock is above array position 0, move it down to 0 */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>                <span class='Control'>else</span> 
                    <a href="../../../include/utils/resowner_private.h.html#LN34"><span class='Ref_to_Proto'>ResourceOwnerForgetLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>                <a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                <a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Fix the locallock to show just the session locks */ 
</span>                <a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2079"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* We aren't deleting this locallock, so done */ 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !allLocks &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * If the lock or proclock pointers are NULL, this lock was taken via 
         * the relation fast-path (and is not known to have been transferred). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2110"></a>            <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span> <span class='Operator'>= </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Delimiter'>; 
</span><a name="LN2111"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Verify that a fast-path lock is what we've got. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN198"><span class='Ref_to_Macro'>EligibleForRelationFastPath</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Delimiter'>, </span><a href="lock.c.html#LN2110"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"locallock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we don't currently hold the LWLock that protects our 
             * fast-path data structures, we must acquire it before attempting 
             * to release the lock via the fast-path.  We will continue to 
             * hold the LWLock until we're done scanning the locallock table, 
             * unless we hit a transferred fast-path lock.  (XXX is this 
             * really such a good idea?  There could be a lot of entries ...) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2023"><span class='Ref_To_Local'>have_fast_path_lwlock</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2023"><span class='Ref_To_Local'>have_fast_path_lwlock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Attempt fast-path release. */ 
</span>            <a href="lock.c.html#LN2111"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Operator'>.</span>locktag_field2<span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN211"><span class='Ref_to_Proto'>FastPathUnGrantRelationLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2111"><span class='Ref_To_Local'>relid</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2110"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Our lock, originally taken via the fast path, has been 
             * transferred to the main lock table.  That's going to require 
             * some extra work, so release our fast-path lock before starting. 
             */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN2023"><span class='Ref_To_Local'>have_fast_path_lwlock</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Now dump the lock.  We haven't got a pointer to the LOCK or 
             * PROCLOCK in this case, so we have to handle this a bit 
             * differently than a normal lock release.  Unfortunately, this 
             * requires an extra LWLock acquire-and-release cycle on the 
             * partitionLock, but hopefully it shouldn't happen often. 
             */ 
</span>            <a href="lock.c.html#LN356"><span class='Ref_to_Proto'>LockRefindAndRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Delimiter'>, </span><a href="lock.c.html#LN2110"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if locallock-&GT;proclock==... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Mark the proclock to show we need to release this lockmode */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And remove the locallock hashtable entry */ 
</span>        <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2019"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (locallock=(LOCALLOCK... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Done with the fast-path data structures */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2023"><span class='Ref_To_Local'>have_fast_path_lwlock</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now, scan each lock partition separately. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2022"><span class='Ref_To_Local'>partition</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2022"><span class='Ref_To_Local'>partition</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2022"><span class='Ref_To_Local'>partition</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2177"></a>        <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN2178"></a>        <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2022"><span class='Ref_To_Local'>partition</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2179"></a>        <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>nextplock</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN2177"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2022"><span class='Ref_To_Local'>partition</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the proclock list for this partition is empty, we can skip 
         * acquiring the partition lock.  This optimization is trickier than 
         * it looks, because another backend could be in process of adding 
         * something to our proclock list due to promoting one of our 
         * fast-path locks.  However, any such lock must be one that we 
         * decided not to delete above, so it's okay to skip it again now; 
         * we'd just decide not to delete it again.  We must, however, be 
         * careful to re-fetch the list header once we've acquired the 
         * partition lock, to be sure we have a valid, up-to-date pointer. 
         * (There is probably no significant risk if pointer fetch/store is 
         * atomic, but we don't wish to assume that.) 
         * 
         * XXX This argument assumes that the locallock table correctly 
         * represents all of our fast-path locks.  While allLocks mode 
         * guarantees to clean up all of our normal locks regardless of the 
         * locallock situation, we lose that guarantee for fast-path locks. 
         * This is not ideal. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2178"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2178"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* needn't examine this partition */ 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2177"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2178"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2178"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>             <a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>; 
</span>             <a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2179"><span class='Ref_To_Local'>nextplock</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN2213"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>wakeupNeeded</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get link first, since we may unlink/delete this proclock */ 
</span>            <a href="lock.c.html#LN2179"><span class='Ref_To_Local'>nextplock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2178"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Ignore items that are not of the lockmethod to be removed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN300"><span class='Ref_to_Macro'>LOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * In allLocks mode, force release of all locks even if locallock 
             * table had problems 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2013"><span class='Ref_to_Parameter'>allLocks</span></a><span class='Parentheses'>) 
</span>                <a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>& ~</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Ignore items that have nothing to be released, unless they have 
             * holdMask == 0 and are therefore recyclable 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockReleaseAll"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockReleaseAll"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& ~</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Release the previously-marked lock modes 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN2018"><span class='Ref_To_Local'>numLockModes</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                    <a href="lock.c.html#LN2213"><span class='Ref_To_Local'>wakeupNeeded</span></a> <span class='Operator'>|= </span><a href="lock.c.html#LN351"><span class='Ref_to_Proto'>UnGrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2017"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"LockReleaseAll: updated"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* CleanUpLock will wake up waiters if needed. */ 
</span>            <a href="lock.c.html#LN353"><span class='Ref_to_Proto'>CleanUpLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2021"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                        <a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, 
</span>                        <a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2020"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="lock.c.html#LN2213"><span class='Ref_To_Local'>wakeupNeeded</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for proclock=(PROCLOCK*)S... &raquo; </span>                       <span class='Comment_Single_Line'>/* loop over PROCLOCKs within this partition */ 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2177"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for partition=0;partition... &raquo; </span>                           <span class='Comment_Single_Line'>/* loop over partitions */ 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2016"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN116"><span class='Ref_to_Member'>trace_flag</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"LockReleaseAll done"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LockReleaseAll &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockReleaseSession -- Release all session locks of the specified lock method 
 *      that are held by the current process. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2287"></a><span class='Declare_Function'>LockReleaseSession</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Parameter'>lockmethodid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2289"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN2290"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2287"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN2287"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2287"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2289"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN2290"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2289"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Ignore items that are not of the specified lock method */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN417"><span class='Ref_to_Macro'>LOCALLOCK_LOCKMETHOD</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="lock.c.html#LN2290"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="lock.c.html#LN2287"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN349"><span class='Ref_to_Proto'>ReleaseLockIfHeld</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2290"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end LockReleaseSession &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockReleaseCurrentOwner 
 *      Release all locks belonging to CurrentResourceOwner 
 * 
 * If the caller knows what those locks are, it can pass them as an array. 
 * That speeds up the call significantly, when a lot of locks are held. 
 * Otherwise, pass NULL for locallocks, and we'll traverse through our hash 
 * table to find them. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2317"></a><span class='Declare_Function'>LockReleaseCurrentOwner</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>locallocks</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nlocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2317"><span class='Ref_to_Parameter'>locallocks</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2321"></a>        <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN2322"></a>        <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2321"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN2322"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2321"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="lock.c.html#LN349"><span class='Ref_to_Proto'>ReleaseLockIfHeld</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2322"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2331"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2331"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2317"><span class='Ref_to_Parameter'>nlocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2331"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2331"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN349"><span class='Ref_to_Proto'>ReleaseLockIfHeld</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2317"><span class='Ref_to_Parameter'>locallocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2331"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end LockReleaseCurrentOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReleaseLockIfHeld 
 *      Release any session-level locks on this lockable object if sessionLock 
 *      is true; else, release any locks held by CurrentResourceOwner. 
 * 
 * It is tempting to pass this a ResourceOwner pointer (or NULL for session 
 * locks), but without refactoring LockRelease() we cannot support releasing 
 * locks belonging to resource owners other than CurrentResourceOwner. 
 * If we were to refactor, it'd be a good idea to fix it so we don't have to 
 * do a hashtable lookup of the locallock, too.  However, currently this 
 * function isn't used heavily enough to justify refactoring for its 
 * convenience. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2352"></a><span class='Declare_Function'>ReleaseLockIfHeld</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sessionLock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2354"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>owner</span><span class='Delimiter'>; 
</span><a name="LN2355"></a>    <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span><span class='Delimiter'>; 
</span><a name="LN2356"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Identify owner for lock (must match LockRelease!) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>sessionLock</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN2354"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="lock.c.html#LN2354"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>= </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan to see if there are any locks belonging to the target owner */ 
</span>    <a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN2354"><span class='Ref_To_Local'>owner</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We will still hold this lock after forgetting this 
                 * ResourceOwner. 
                 */ 
</span>                <a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>-= </span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* compact out unused slot */ 
</span>                <a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2354"><span class='Ref_To_Local'>owner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/resowner_private.h.html#LN34"><span class='Ref_to_Proto'>ResourceOwnerForgetLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2354"><span class='Ref_To_Local'>owner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Parentheses'>) 
</span>                    <a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Delimiter'>]; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* We want to call LockRelease just once */ 
</span>                <a href="lock.c.html#LN2355"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2356"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Delimiter'>, 
</span>                                 <a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Delimiter'>, 
</span>                                 <a href="lock.c.html#LN2352"><span class='Ref_to_Parameter'>sessionLock</span></a><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"ReleaseLockIfHeld: failed??"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lockOwners[i].owner==... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=locallock-&GT;numLockO... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ReleaseLockIfHeld &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockReassignCurrentOwner 
 *      Reassign all locks belonging to CurrentResourceOwner to belong 
 *      to its parent resource owner. 
 * 
 * If the caller knows what those locks are, it can pass them as an array. 
 * That speeds up the call significantly, when a lot of locks are held 
 * (e.g pg_dump with a large schema).  Otherwise, pass NULL for locallocks, 
 * and we'll traverse through our hash table to find them. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2412"></a><span class='Declare_Function'>LockReassignCurrentOwner</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>locallocks</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nlocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2414"></a>    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Local'>parent</span> <span class='Operator'>= </span><a href="../../../include/utils/resowner.h.html#LN73"><span class='Ref_to_Proto'>ResourceOwnerGetParent</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2414"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2412"><span class='Ref_to_Parameter'>locallocks</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2420"></a>        <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN2421"></a>        <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2420"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN2421"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2420"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <a href="lock.c.html#LN350"><span class='Ref_to_Proto'>LockReassignOwner</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2421"><span class='Ref_To_Local'>locallock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2414"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2430"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2430"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2412"><span class='Ref_to_Parameter'>nlocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2430"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2430"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN350"><span class='Ref_to_Proto'>LockReassignOwner</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2412"><span class='Ref_to_Parameter'>locallocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2430"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="lock.c.html#LN2414"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end LockReassignCurrentOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subroutine of LockReassignCurrentOwner. Reassigns a given lock belonging to 
 * CurrentResourceOwner to its parent. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2442"></a><span class='Declare_Function'>LockReassignOwner</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>parent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2444"></a>    <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span><span class='Delimiter'>; 
</span><a name="LN2445"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2446"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ic</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN2447"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ip</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan to see if there are any locks belonging to current owner or its 
     * parent 
     */ 
</span>    <a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>parent</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN2447"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* no current locks */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2447"><span class='Ref_To_Local'>ip</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Parent has no slot, so just give it the child's slot */ 
</span>        <a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN33"><span class='Ref_to_Proto'>ResourceOwnerRememberLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Merge child's count with parent's */ 
</span>        <a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2447"><span class='Ref_To_Local'>ip</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>+= </span><a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN398"><span class='Ref_to_Member'>nLocks</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* compact out unused slot */ 
</span>        <a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2446"><span class='Ref_To_Local'>ic</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2444"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/resowner_private.h.html#LN34"><span class='Ref_to_Proto'>ResourceOwnerForgetLock</span></a><span class='Parentheses'>(</span><a href="../../utils/resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2442"><span class='Ref_to_Parameter'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockReassignOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FastPathGrantRelationLock 
 *      Grant lock using per-backend fast-path array, if there is space. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2488"></a><span class='Declare_Function'>FastPathGrantRelationLock</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2490"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN2491"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>unused_slot</span> <span class='Operator'>= </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan for existing entry for this relid, remembering empty slot. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="lock.c.html#LN2491"><span class='Ref_To_Local'>unused_slot</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="lock.c.html#LN2488"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN187"><span class='Ref_to_Macro'>FAST_PATH_CHECK_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2488"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN183"><span class='Ref_to_Macro'>FAST_PATH_SET_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2490"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2488"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If no existing entry, use any empty slot. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2491"><span class='Ref_To_Local'>unused_slot</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2491"><span class='Ref_To_Local'>unused_slot</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2488"><span class='Ref_to_Parameter'>relid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN183"><span class='Ref_to_Macro'>FAST_PATH_SET_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2491"><span class='Ref_To_Local'>unused_slot</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2488"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>++</span><a href="lock.c.html#LN170"><span class='Ref_to_Global_Var'>FastPathLocalUseCount</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* No existing entry, and no empty slot. */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FastPathGrantRelationLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FastPathUnGrantRelationLock 
 *      Release fast-path lock, if present.  Update backend-private local 
 *      use count, while we're at it. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2525"></a><span class='Declare_Function'>FastPathUnGrantRelationLock</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2527"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN2528"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN170"><span class='Ref_to_Global_Var'>FastPathLocalUseCount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="lock.c.html#LN2525"><span class='Ref_to_Parameter'>relid</span></a> 
            <span class='Operator'>&& </span><a href="lock.c.html#LN187"><span class='Ref_to_Macro'>FAST_PATH_CHECK_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2525"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2528"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN185"><span class='Ref_to_Macro'>FAST_PATH_CLEAR_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2525"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN2528"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* we continue iterating so as to update FastPathLocalUseCount */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2527"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Operator'>++</span><a href="lock.c.html#LN170"><span class='Ref_to_Global_Var'>FastPathLocalUseCount</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN2528"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FastPathUnGrantRelationLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FastPathTransferRelationLocks 
 *      Transfer locks matching the given lock tag from per-backend fast-path 
 *      arrays to the shared hash table. 
 * 
 * Returns true if successful, false if ran out of shared memory. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN2555"></a><span class='Declare_Function'>FastPathTransferRelationLocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, 
</span><a name="LN2556"></a>                              <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2558"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2556"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2559"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="lock.c.html#LN2555"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>; 
</span><a name="LN2560"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Every PGPROC that can potentially hold a fast-path lock is present in 
     * ProcGlobal-&GT;allProcs.  Prepared transactions are not, but any 
     * outstanding fast-path locks held by prepared transactions are 
     * transferred to the main lock table. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2560"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2560"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN235"><span class='Ref_to_Member'>allProcCount</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2560"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2570"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2560"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2571"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the target backend isn't referencing the same database as the 
         * lock, then we needn't examine the individual relation IDs at all; 
         * none of them can be relevant. 
         * 
         * proc-&GT;databaseId is set at backend startup time and never changes 
         * thereafter, so it might be safe to perform this test before 
         * acquiring &proc-&GT;backendLock.  In particular, it's certainly safe 
         * to assume that if the target backend holds any fast-path locks, it 
         * must have performed a memory-fencing operation (in particular, an 
         * LWLock acquisition) since setting proc-&GT;databaseId.  However, it's 
         * less clear that our backend is certain to have performed a memory 
         * fencing operation since the other backend set proc-&GT;databaseId.  So 
         * for now, we test it after acquiring the LWLock just to be safe. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN2555"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2598"></a>            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Look for an allocated slot matching the given relid. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2559"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Find or create lock object. */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2558"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a> <span class='Operator'>+ </span><a href="lock.c.html#LN173"><span class='Ref_to_Const'>FAST_PATH_BITS_PER_SLOT</span></a><span class='Delimiter'>; 
</span>                 <span class='Operator'>++</span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2610"></a>                <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN187"><span class='Ref_to_Macro'>FAST_PATH_CHECK_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2610"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN343"><span class='Ref_to_Proto'>SetupLockInTable</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2555"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2555"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                            <a href="lock.c.html#LN2556"><span class='Ref_to_Parameter'>hashcode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2610"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2558"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../include/storage/lock.h.html#LN548"><span class='Ref_to_Proto'>GrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2610"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>, </span><a href="lock.c.html#LN2610"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN185"><span class='Ref_to_Macro'>FAST_PATH_CLEAR_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2571"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2598"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2558"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* No need to examine remaining slots. */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for f=0;f&LT;FP_LOCK_SLOTS_P... &raquo; </span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2570"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ProcGlobal-&GT;all... &raquo; </span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FastPathTransferRelationLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FastPathGetLockEntry 
 *      Return the PROCLOCK for a lock originally taken via the fast-path, 
 *      transferring it to the primary lock table if necessary. 
 * 
 * Note: caller takes care of updating the locallock object. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>* 
</span><a name="LN2643"></a><span class='Declare_Function'>FastPathGetRelationLockEntry</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locallock</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2645"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a><span class='Delimiter'>]; 
</span><a name="LN2646"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>locktag</span> <span class='Operator'>= &</span><a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Delimiter'>; 
</span><a name="LN2647"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN2648"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2649"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="lock.c.html#LN2646"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>; 
</span><a name="LN2650"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2656"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Look for an allocated slot matching the given relid. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2649"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>!= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>] </span><span class='Operator'>|| </span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If we don't have a lock of the given mode, forget it! */ 
</span>        <a href="lock.c.html#LN2656"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN187"><span class='Ref_to_Macro'>FAST_PATH_CHECK_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2656"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find or create lock object. */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2648"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN343"><span class='Ref_to_Proto'>SetupLockInTable</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2645"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2646"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, 
</span>                                    <a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2656"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2648"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/lock.h.html#LN548"><span class='Ref_to_Proto'>GrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>, </span><a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2656"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN185"><span class='Ref_to_Macro'>FAST_PATH_CLEAR_LOCKMODE</span></a><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2650"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2656"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2648"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No need to examine remaining slots. */ 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for f=0;f&LT;FP_LOCK_SLOTS_P... &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Lock may have already been transferred by some other backend. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2695"></a>        <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN2696"></a>        <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span><a name="LN2697"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2648"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN2695"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN2646"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, 
</span>                                                    <a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                    <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                    <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2695"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared lock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN2696"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2695"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN2696"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN2697"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2696"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2643"><span class='Ref_to_Parameter'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN409"><span class='Ref_to_Member'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN2696"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN2697"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                        <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared proclock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2648"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proclock==NULL &raquo; </span> 
 
    <span class='Control'>return</span> <a href="lock.c.html#LN2647"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FastPathGetRelationLockEntry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetLockConflicts 
 *      Get an array of VirtualTransactionIds of xacts currently holding locks 
 *      that would conflict with the specified lock/lockmode. 
 *      xacts merely awaiting such a lock are NOT reported. 
 * 
 * The result array is palloc'd and is terminated with an invalid VXID. 
 * 
 * Of course, the result could be out of date by the time it's returned, 
 * so use of this function has to be thought about carefully. 
 * 
 * Note we never include the current xact's vxid in the result array, 
 * since an xact never blocks itself.  Also, prepared transactions are 
 * ignored, which is a bit more debatable but is appropriate for current 
 * uses of the result. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>* 
</span><a name="LN2744"></a><span class='Declare_Function'>GetLockConflicts</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2746"></a>    <span class='Keyword'>static </span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>vxids</span><span class='Delimiter'>; 
</span><a name="LN2747"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span><a name="LN2748"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span><a name="LN2749"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN2750"></a>    <a href="../../../include/storage/lockdefs.h.html#LN24"><span class='Ref_to_Typedef'>LOCKMASK</span></a>    <span class='Declare_Local'>conflictMask</span><span class='Delimiter'>; 
</span><a name="LN2751"></a>    <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span><span class='Delimiter'>; 
</span><a name="LN2752"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN2753"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN2754"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN2755"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN2756"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fast_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2747"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN2747"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2747"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2748"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2747"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>lockmode</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN2748"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock mode: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate memory to store results, and fill with InvalidVXID.  We only 
     * need enough space for MaxBackends + a terminator, since prepared xacts 
     * don't count. InHotStandby allocate once in TopMemoryContext. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN73"><span class='Ref_to_Const'>InHotStandby</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute hash code and partition lock, and look up conflicting modes. */ 
</span>    <a href="lock.c.html#LN2753"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2754"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2753"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2750"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2748"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN114"><span class='Ref_to_Member'>conflictTab</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fast path locks might not have been entered in the primary lock table. 
     * If the lock we're dealing with could conflict with such a lock, we must 
     * examine each backend's fast-path array for conflicts. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Macro'>ConflictsWithRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2792"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2793"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relid</span> <span class='Operator'>= </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>; 
</span><a name="LN2794"></a>        <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Local'>vxid</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Iterate over relevant PGPROCs.  Anything held by a prepared 
         * transaction will have been transferred to the primary lock table, 
         * so we need not worry about those.  This is all a bit fuzzy, because 
         * new locks could be taken after we've visited a particular 
         * partition, but the callers had better be prepared to deal with that 
         * anyway, since the locks could equally well be taken between the 
         * time we return the value and the time the caller does something 
         * with it. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN235"><span class='Ref_to_Member'>allProcCount</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2792"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2808"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN2809"></a>            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* A backend never blocks itself */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the target backend isn't referencing the same database as 
             * the lock, then we needn't examine the individual relation IDs 
             * at all; none of them can be relevant. 
             * 
             * See FastPathTransferLocks() for discussion of why we do this 
             * test after acquiring the lock. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2809"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2809"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN2809"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2833"></a>                <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockmask</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Look for an allocated slot matching the given relid. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2793"><span class='Ref_To_Local'>relid</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2809"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2833"><span class='Ref_To_Local'>lockmask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2809"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2833"><span class='Ref_To_Local'>lockmask</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN2833"><span class='Ref_To_Local'>lockmask</span></a> <span class='Operator'>&LT;&LT;= </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * There can only be one entry per relation, so if we found it 
                 * and it doesn't conflict, we can skip the rest of the slots. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN2833"><span class='Ref_To_Local'>lockmask</span></a> <span class='Operator'>& </span><a href="lock.c.html#LN2750"><span class='Ref_To_Local'>conflictMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Conflict! */ 
</span>                <a href="../../../include/storage/lock.h.html#LN80"><span class='Ref_to_Macro'>GET_VXID_FROM_PGPROC</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2794"><span class='Ref_To_Local'>vxid</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If we see an invalid VXID, then either the xact has already 
                 * committed (or aborted), or it's a prepared xact.  In either 
                 * case we may ignore it. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2794"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>))</span> 
                    <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2794"><span class='Ref_To_Local'>vxid</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* No need to examine remaining slots. */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for f=0;f&LT;FP_LOCK_SLOTS_P... &raquo; </span> 
 
            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2808"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ProcGlobal-&GT;all... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ConflictsWithRelation... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Remember how many fast-path conflicts we found. */ 
</span>    <a href="lock.c.html#LN2756"><span class='Ref_To_Local'>fast_count</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up the lock object matching the tag. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2754"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2749"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN2744"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN2753"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2749"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the lock object doesn't exist, there is nothing holding a lock 
         * on this lockable object. 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2754"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN69"><span class='Ref_to_Const'>InvalidLocalTransactionId</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Examine each existing holder (or awaiter) of the lock. 
     */ 
</span> 
    <a href="lock.c.html#LN2751"><span class='Ref_To_Local'>procLocks</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2749"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2751"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2751"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2750"><span class='Ref_To_Local'>conflictMask</span></a> <span class='Operator'>& </span><a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN2907"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* A backend never blocks itself */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2907"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>!= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN2912"></a>                <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Local'>vxid</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/lock.h.html#LN80"><span class='Ref_to_Macro'>GET_VXID_FROM_PGPROC</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2912"><span class='Ref_To_Local'>vxid</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="lock.c.html#LN2907"><span class='Ref_To_Local'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If we see an invalid VXID, then either the xact has already 
                 * committed (or aborted), or it's a prepared xact.  In either 
                 * case we may ignore it. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2912"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN2923"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Avoid duplicate entries. */ 
</span>                    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2923"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN2923"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN2756"><span class='Ref_To_Local'>fast_count</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="lock.c.html#LN2923"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN74"><span class='Ref_to_Macro'>VirtualTransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2923"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="lock.c.html#LN2912"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>))</span> 
                            <span class='Control'>break</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2923"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><a href="lock.c.html#LN2756"><span class='Ref_To_Local'>fast_count</span></a><span class='Parentheses'>) 
</span>                        <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN2912"><span class='Ref_To_Local'>vxid</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc!=MyProc &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if conflictMask&proclock... &raquo; </span> 
 
        <a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2751"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN2752"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while proclock &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2754"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&GT; </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Parentheses'>)</span>    <span class='Comment_Single_Line'>/* should never happen */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"too many conflicting locks found"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2755"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN69"><span class='Ref_to_Const'>InvalidLocalTransactionId</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN2746"><span class='Ref_To_Local'>vxids</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetLockConflicts &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find a lock in the shared lock table and release it.  It is the caller's 
 * responsibility to verify that this is a sane thing to do.  (For example, it 
 * would be bad to release a lock here if there might still be a LOCALLOCK 
 * object with pointers to it.) 
 * 
 * We currently use this in two situations: first, to release locks held by 
 * prepared transactions on commit (see lock_twophase_postcommit); and second, 
 * to release locks taken via the fast-path, transferred to the main hash 
 * table, and then released (see LockReleaseAll). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2961"></a><span class='Declare_Function'>LockRefindAndRelease</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a> <span class='Declare_Parameter'>lockMethodTable</span><span class='Delimiter'>, </span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Delimiter'>, 
</span><a name="LN2962"></a>                     <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>lockmode</span><span class='Delimiter'>, 
</span><a name="LN2963"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>decrement_strong_lock_count</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2965"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN2966"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN2967"></a>    <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span><a name="LN2968"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN2969"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span><a name="LN2970"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN2971"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>wakeupNeeded</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2970"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2970"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Re-find the lock object (it had better be there). 
     */ 
</span>    <a href="lock.c.html#LN2965"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2965"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared lock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Re-find the proclock object (ditto). 
     */ 
</span>    <a href="lock.c.html#LN2967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN2967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN2961"><span class='Ref_to_Parameter'>proc</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2969"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN2967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN2967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, 
</span>                                                        <a href="lock.c.html#LN2969"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                                        <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"failed to re-find shared proclock object"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Double-check that we are actually holding a lock of the type we want to 
     * release. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"lock_twophase_postcommit: WRONGTYPE"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2970"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"you don't own a lock of type %s"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN2961"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the releasing.  CleanUpLock will waken any now-wakable waiters. 
     */ 
</span>    <a href="lock.c.html#LN2971"><span class='Ref_To_Local'>wakeupNeeded</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN351"><span class='Ref_to_Proto'>UnGrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2961"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN353"><span class='Ref_to_Proto'>CleanUpLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2966"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                <a href="lock.c.html#LN2961"><span class='Ref_to_Parameter'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                <a href="lock.c.html#LN2971"><span class='Ref_To_Local'>wakeupNeeded</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2970"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Decrement strong lock count.  This logic is needed only for 2PC. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN2963"><span class='Ref_to_Parameter'>decrement_strong_lock_count</span></a> 
        <span class='Operator'>&& </span><a href="lock.c.html#LN204"><span class='Ref_to_Macro'>ConflictsWithRelationFastPath</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN2962"><span class='Ref_to_Parameter'>lockmode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3035"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN2968"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3035"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3035"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>]</span><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end LockRefindAndRelease &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtPrepare_Locks 
 *      Do the preparatory work for a PREPARE: make 2PC state file records 
 *      for all locks currently held. 
 * 
 * Session-level locks are ignored, as are VXID locks. 
 * 
 * There are some special cases that we error out on: we can't be holding any 
 * locks at both session and transaction level (since we must either keep or 
 * give away the PROCLOCK object), and we can't be holding any locks on 
 * temporary objects (since that would mess up the current backend if it tries 
 * to exit before the prepared xact is committed). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3058"></a><span class='Declare_Function'>AtPrepare_Locks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3060"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN3061"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For the most part, we don't need to touch shared memory for this --- 
     * all the necessary state information is in the locallock table. 
     * Fast-path locks are an exception, however: we move any such locks to 
     * the main table before allowing PREPARE TRANSACTION to succeed. 
     */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3060"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3060"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3073"></a>        <a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Declare_Local'>record</span><span class='Delimiter'>; 
</span><a name="LN3074"></a>        <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span> <span class='Operator'>= </span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span><a name="LN3075"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveSessionLock</span><span class='Delimiter'>; 
</span><a name="LN3076"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveXactLock</span><span class='Delimiter'>; 
</span><a name="LN3077"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Ignore VXID locks.  We don't want those to be held by prepared 
         * transactions, since they aren't meaningful after a restart. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Operator'>.</span>locktag_type <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN150"><span class='Ref_to_EnumConst'>LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore it if we don't actually hold the lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan to see whether we hold it at session or transaction level */ 
</span>        <a href="lock.c.html#LN3075"><span class='Ref_To_Local'>haveSessionLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3076"><span class='Ref_To_Local'>haveXactLock</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3077"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3077"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3077"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3074"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3077"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="lock.c.html#LN3075"><span class='Ref_To_Local'>haveSessionLock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="lock.c.html#LN3076"><span class='Ref_To_Local'>haveXactLock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore it if we have only session lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3076"><span class='Ref_To_Local'>haveXactLock</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we have both session- and transaction-level locks, fail.  This 
         * should never happen with regular locks, since we only take those at 
         * session level in some special operations like VACUUM.  It's 
         * possible to hit this with advisory locks, though. 
         * 
         * It would be nice if we could keep the session hold and give away 
         * the transactional hold to the prepared xact.  However, that would 
         * require two PROCLOCK objects, and we cannot be sure that another 
         * PROCLOCK will be available when it comes time for PostPrepare_Locks 
         * to do the deed.  So for now, we error out while we can still do so 
         * safely. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3075"><span class='Ref_To_Local'>haveSessionLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot PREPARE while holding both session-level and transaction-level locks on the same object"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the local lock was taken via the fast-path, we need to move it 
         * to the primary lock table, or just get a pointer to the existing 
         * primary lock table entry if by chance it's already been 
         * transferred. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN214"><span class='Ref_to_Proto'>FastPathGetRelationLockEntry</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Arrange to not release any strong lock count held by this lock 
         * entry.  We must retain the count until the prepared transaction is 
         * committed or rolled back. 
         */ 
</span>        <a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN413"><span class='Ref_to_Member'>holdsStrongLockCount</span></a> <span class='Operator'>= </span><span class='Boolean'>FALSE</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Create a 2PC record. 
         */ 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3073"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="lock.c.html#LN159"><span class='Ref_to_Member'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3073"><span class='Ref_To_Local'>record</span></a><span class='Operator'>.</span><a href="lock.c.html#LN160"><span class='Ref_to_Member'>lockmode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3061"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Delimiter'>; 
</span> 
        <a href="../../../include/access/twophase_rmgr.h.html#LN36"><span class='Ref_to_Proto'>RegisterTwoPhaseRecord</span></a><span class='Parentheses'>(</span><a href="../../../include/access/twophase_rmgr.h.html#LN24"><span class='Ref_to_Const'>TWOPHASE_RM_LOCK_ID</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="lock.c.html#LN3073"><span class='Ref_To_Local'>record</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (locallock=(LOCALLOCK... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtPrepare_Locks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PostPrepare_Locks 
 *      Clean up after successful PREPARE 
 * 
 * Here, we want to transfer ownership of our locks to a dummy PGPROC 
 * that's now associated with the prepared transaction, and we want to 
 * clean out the corresponding entries in the LOCALLOCK table. 
 * 
 * Note: by removing the LOCALLOCK entries, we are leaving dangling 
 * pointers in the transaction's resource owner.  This is OK at the 
 * moment since resowner.c doesn't try to free locks retail at a toplevel 
 * transaction commit or abort.  We could alternatively zero out nLocks 
 * and leave the LOCALLOCK entries to be garbage-collected by LockReleaseAll, 
 * but that probably costs more cycles. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3168"></a><span class='Declare_Function'>PostPrepare_Locks</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3170"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>newproc</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN35"><span class='Ref_to_Proto'>TwoPhaseGetDummyProc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3168"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3171"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN3172"></a>    <a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>locallock</span><span class='Delimiter'>; 
</span><a name="LN3173"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN3174"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3175"></a>    <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span><a name="LN3176"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>partition</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can't prepare a lock group follower. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>           <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This is a critical section: any error means big trouble */ 
</span>    <a href="../../../include/miscadmin.h.html#LN132"><span class='Ref_to_Macro'>START_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First we run through the locallock table and get rid of unwanted 
     * entries, then we scan the process's proclocks and transfer them to the 
     * target proc. 
     * 
     * We do this separately because we may have multiple locallock entries 
     * pointing to the same proclock, and we daren't end up with any dangling 
     * pointers. 
     */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3171"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN254"><span class='Ref_to_Global_Var'>LockMethodLocalHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN401"><span class='Ref_to_Struct'>LOCALLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3171"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3198"></a>        <a href="../../../include/storage/lock.h.html#LN389"><span class='Ref_to_Struct'>LOCALLOCKOWNER</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lockOwners</span> <span class='Operator'>= </span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN414"><span class='Ref_to_Member'>lockOwners</span></a><span class='Delimiter'>; 
</span><a name="LN3199"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveSessionLock</span><span class='Delimiter'>; 
</span><a name="LN3200"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>haveXactLock</span><span class='Delimiter'>; 
</span><a name="LN3201"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN407"><span class='Ref_to_Member'>lock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We must've run out of shared memory while trying to set up this 
             * lock.  Just forget the local entry. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore VXID locks */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>lock<span class='Operator'>.</span>locktag_type <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN150"><span class='Ref_to_EnumConst'>LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Scan to see whether we hold it at session or transaction level */ 
</span>        <a href="lock.c.html#LN3199"><span class='Ref_To_Local'>haveSessionLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3200"><span class='Ref_To_Local'>haveXactLock</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3201"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN411"><span class='Ref_to_Member'>numLockOwners</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3201"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3201"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3198"><span class='Ref_To_Local'>lockOwners</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3201"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN397"><span class='Ref_to_Member'>owner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="lock.c.html#LN3199"><span class='Ref_To_Local'>haveSessionLock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="lock.c.html#LN3200"><span class='Ref_To_Local'>haveXactLock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore it if we have only session lock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3200"><span class='Ref_To_Local'>haveXactLock</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* This can't happen, because we already checked it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3199"><span class='Ref_To_Local'>haveSessionLock</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot PREPARE while holding both session-level and transaction-level locks on the same object"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark the proclock to show we need to release this lockmode */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN410"><span class='Ref_to_Member'>nLocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN408"><span class='Ref_to_Member'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>|= </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN404"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>mode<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And remove the locallock hashtable entry */ 
</span>        <a href="lock.c.html#LN342"><span class='Ref_to_Proto'>RemoveLocalLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3172"><span class='Ref_To_Local'>locallock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (locallock=(LOCALLOCK... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now, scan each lock partition separately. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3251"></a>        <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN3252"></a>        <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3253"></a>        <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>nextplock</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN3251"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the proclock list for this partition is empty, we can skip 
         * acquiring the partition lock.  This optimization is safer than the 
         * situation in LockReleaseAll, because we got rid of any fast-path 
         * locks during AtPrepare_Locks, so there cannot be any case where 
         * another backend is adding something to our lists now.  For safety, 
         * though, we code this the same way as in LockReleaseAll. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3252"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3252"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* needn't examine this partition */ 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3251"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3252"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3252"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>             <a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>; 
</span>             <a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3253"><span class='Ref_To_Local'>nextplock</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Get link first, since we may unlink/relink this proclock */ 
</span>            <a href="lock.c.html#LN3253"><span class='Ref_To_Local'>nextplock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3252"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc <span class='Operator'>== </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Ignore VXID locks */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN150"><span class='Ref_to_EnumConst'>LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"PostPrepare_Locks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"PostPrepare_Locks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& ~</span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Ignore it if nothing to release (must be a session lock) */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Else we should be releasing all locks */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"we seem to have dropped a bit somewhere"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * We cannot simply modify proclock-&GT;tag.myProc to reassign 
             * ownership of the lock, because that's part of the hash key and 
             * the proclock would then be in the wrong hash chain.  Instead 
             * use hash_update_hash_key.  (We used to create a new hash entry, 
             * but that risks out-of-memory failure if other processes are 
             * busy making proclocks too.)  We must unlink the proclock from 
             * our procLink chain and put it into the new proc's chain, too. 
             * 
             * Note: the updated proclock hash key will still belong to the 
             * same hash partition, cf proclock_hash().  So the partition lock 
             * we already hold is sufficient for this. 
             */ 
</span>            <a href="../ipc/shmqueue.c.html#LN66"><span class='Ref_to_Func'>SHMQueueDelete</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Create the new hash key for the proclock. 
             */ 
</span>            <a href="lock.c.html#LN3175"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3173"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3175"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3170"><span class='Ref_To_Local'>newproc</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Update groupLeader pointer to point to the new proc.  (We'd 
             * better not be a member of somebody else's lock group!) 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3170"><span class='Ref_To_Local'>newproc</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Update the proclock.  We should not find any existing entry for 
             * the same hash key, since there can be only one entry for any 
             * given lock with my own proc. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN131"><span class='Ref_to_Proto'>hash_update_hash_key</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, 
</span>                                      <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN3175"><span class='Ref_To_Local'>proclocktag</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"duplicate entry found while reassigning a prepared transaction's locks"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Re-link into the new proc's proclock list */ 
</span>            <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3170"><span class='Ref_To_Local'>newproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3176"><span class='Ref_To_Local'>partition</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"PostPrepare_Locks: updated"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3174"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for proclock=(PROCLOCK*)S... &raquo; </span>                       <span class='Comment_Single_Line'>/* loop over PROCLOCKs within this partition */ 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3251"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for partition=0;partition... &raquo; </span>                           <span class='Comment_Single_Line'>/* loop over partitions */ 
</span> 
    <a href="../../../include/miscadmin.h.html#LN134"><span class='Ref_to_Macro'>END_CRIT_SECTION</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PostPrepare_Locks &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate shared-memory space used for lock tables 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN3360"></a><span class='Declare_Function'>LockShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3362"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN3363"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>max_table_size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* lock hash table */ 
</span>    <a href="lock.c.html#LN3363"><span class='Ref_To_Local'>max_table_size</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN55"><span class='Ref_to_Macro'>NLOCKENTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN138"><span class='Ref_to_Proto'>hash_estimate_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3363"><span class='Ref_To_Local'>max_table_size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* proclock hash table */ 
</span>    <a href="lock.c.html#LN3363"><span class='Ref_To_Local'>max_table_size</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN138"><span class='Ref_to_Proto'>hash_estimate_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3363"><span class='Ref_To_Local'>max_table_size</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since NLOCKENTS is only an estimate, add 10% safety margin. 
     */ 
</span>    <a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>/ </span><span class='Number'>10</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN3362"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockShmemSize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetLockStatusData - Return a summary of the lock manager's internal 
 * status, for use in a user-level reporting function. 
 * 
 * The return data consists of an array of LockInstanceData objects, 
 * which are a lightly abstracted version of the PROCLOCK data structures, 
 * i.e. there is one entry for each unique lock and interested PGPROC. 
 * It is the caller's responsibility to match up related items (such as 
 * references to the same lockable object or PGPROC) if wanted. 
 * 
 * The design goal is to hold the LWLocks for as short a time as possible; 
 * thus, this function simply makes a copy of the necessary data and releases 
 * the locks, allowing the caller to contemplate and format the data for as 
 * long as it pleases. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN437"><span class='Ref_to_Struct'>LockData</span></a> <span class='Operator'>* 
</span><a name="LN3397"></a><span class='Declare_Function'>GetLockStatusData</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3399"></a>    <a href="../../../include/storage/lock.h.html#LN437"><span class='Ref_to_Struct'>LockData</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN3400"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3401"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>seqstat</span><span class='Delimiter'>; 
</span><a name="LN3402"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>els</span><span class='Delimiter'>; 
</span><a name="LN3403"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>el</span><span class='Delimiter'>; 
</span><a name="LN3404"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN437"><span class='Ref_to_Struct'>LockData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN437"><span class='Ref_to_Struct'>LockData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Guess how much space we'll need. */ 
</span>    <a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, we iterate through the per-backend fast-path arrays, locking 
     * them one at a time.  This might produce an inconsistent picture of the 
     * system state, but taking all of those LWLocks at the same time seems 
     * impractical (in particular, note MAX_SIMUL_LWLOCKS).  It shouldn't 
     * matter too much, because none of these locks can be involved in lock 
     * conflicts anyway - anything that might must be present in the main lock 
     * table.  (For the same reason, we don't sweat about making leaderPid 
     * completely valid.  We cannot safely dereference another backend's 
     * lockGroupLeader field without holding all lock partition locks, and 
     * it's not worth that.) 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN235"><span class='Ref_to_Member'>allProcCount</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3427"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= &</span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN231"><span class='Ref_to_Member'>allProcs</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN3428"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3428"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3428"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/proc.h.html#LN69"><span class='Ref_to_Const'>FP_LOCK_SLOTS_PER_BACKEND</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="lock.c.html#LN3428"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3434"></a>            <a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>instance</span><span class='Delimiter'>; 
</span><a name="LN3435"></a>            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>lockbits</span> <span class='Operator'>= </span><a href="lock.c.html#LN176"><span class='Ref_to_Macro'>FAST_PATH_GET_BITS</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3428"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Skip unallocated slots. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3435"><span class='Ref_To_Local'>lockbits</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a> <span class='Operator'>&GT;= </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>+= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Delimiter'>]; 
</span>            <a href="../../../include/storage/lock.h.html#LN193"><span class='Ref_to_Macro'>SET_LOCKTAG_RELATION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN427"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN112"><span class='Ref_to_Member'>databaseId</span></a><span class='Delimiter'>, 
</span>                                 <a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN178"><span class='Ref_to_Member'>fpRelId</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3428"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN428"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3435"><span class='Ref_To_Local'>lockbits</span></a> <span class='Operator'>&LT;&LT; </span><a href="lock.c.html#LN174"><span class='Ref_to_Const'>FAST_PATH_LOCKNUMBER_OFFSET</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN430"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN431"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN432"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN433"><span class='Ref_to_Member'>leaderPid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3434"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN434"><span class='Ref_to_Member'>fastpath</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for f=0;f&LT;FP_LOCK_SLOTS_P... &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3464"></a>            <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Local'>vxid</span><span class='Delimiter'>; 
</span><a name="LN3465"></a>            <a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>instance</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a> <span class='Operator'>&GT;= </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>+= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="lock.c.html#LN3464"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3464"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Delimiter'>]; 
</span>            <a href="../../../include/storage/lock.h.html#LN233"><span class='Ref_to_Macro'>SET_LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN427"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3464"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN428"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN430"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN431"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN432"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN433"><span class='Ref_to_Member'>leaderPid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3465"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN434"><span class='Ref_to_Member'>fastpath</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc-&GT;fpVXIDLock &raquo; </span> 
 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3427"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;ProcGlobal-&GT;all... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Next, acquire lock on the entire shared lock data structure.  We do 
     * this so that, at least for locks in the primary lock table, the state 
     * will be self-consistent. 
     * 
     * Since this is a read-only operation, we take shared instead of 
     * exclusive lock.  There's not a whole lot of point to this, because all 
     * the normal operations require exclusive lock, but it doesn't hurt 
     * anything either. It will at least allow two backends to do 
     * GetLockStatusData in parallel. 
     * 
     * Must grab LWLocks in partition-number order to avoid LWLock deadlock. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can safely count the number of proclocks */ 
</span>    <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN439"><span class='Ref_to_Member'>nelements</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a> <span class='Operator'>+ </span><a href="../../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN439"><span class='Ref_to_Member'>nelements</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN439"><span class='Ref_to_Member'>nelements</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3402"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Now scan the tables to copy the data */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3401"><span class='Ref_To_Local'>seqstat</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3401"><span class='Ref_To_Local'>seqstat</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN3523"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Delimiter'>; 
</span><a name="LN3524"></a>        <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span><a name="LN3525"></a>        <a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>instance</span> <span class='Operator'>= &</span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN440"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Delimiter'>]; 
</span> 
        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN427"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3524"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN428"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3523"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3523"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN430"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3523"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN431"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3523"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN432"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3523"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN433"><span class='Ref_to_Member'>leaderPid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3400"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3525"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN434"><span class='Ref_to_Member'>fastpath</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (proclock=(PROCLOCK*)... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * And release locks.  We do this in reverse order for two reasons: (1) 
     * Anyone else who needs more than one of the locks will be trying to lock 
     * them in increasing order; we don't want to release the other process 
     * until it can get all the locks it needs. (2) This avoids O(N^2) 
     * behavior inside LWLockRelease. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3404"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3403"><span class='Ref_To_Local'>el</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN439"><span class='Ref_to_Member'>nelements</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN3399"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetLockStatusData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetBlockerStatusData - Return a summary of the lock manager's state 
 * concerning locks that are blocking the specified PID or any member of 
 * the PID's lock group, for use in a user-level reporting function. 
 * 
 * For each PID within the lock group that is awaiting some heavyweight lock, 
 * the return data includes an array of LockInstanceData objects, which are 
 * the same data structure used by GetLockStatusData; but unlike that function, 
 * this one reports only the PROCLOCKs associated with the lock that that PID 
 * is blocked on.  (Hence, all the locktags should be the same for any one 
 * blocked PID.)  In addition, we return an array of the PIDs of those backends 
 * that are ahead of the blocked PID in the lock's wait queue.  These can be 
 * compared with the PIDs in the LockInstanceData objects to determine which 
 * waiters are ahead of or behind the blocked PID in the queue. 
 * 
 * If blocked_pid isn't a valid backend PID or nothing in its lock group is 
 * waiting on any heavyweight lock, return empty arrays. 
 * 
 * The design goal is to hold the LWLocks for as short a time as possible; 
 * thus, this function simply makes a copy of the necessary data and releases 
 * the locks, allowing the caller to contemplate and format the data for as 
 * long as it pleases. 
 */ 
</span><a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a> <span class='Operator'>* 
</span><a name="LN3581"></a><span class='Declare_Function'>GetBlockerStatusData</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>blocked_pid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3583"></a>    <a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>data</span><span class='Delimiter'>; 
</span><a name="LN3584"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN3585"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Guess how much space we'll need, and preallocate.  Most of the time 
     * this will avoid needing to do repalloc while holding the LWLocks.  (We 
     * assume, but check with an Assert, that MaxBackends is enough entries 
     * for the procs[] array; the other two could need enlargement, though.) 
     */ 
</span>    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN461"><span class='Ref_to_Member'>nprocs</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN462"><span class='Ref_to_Member'>maxprocs</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN464"><span class='Ref_to_Member'>maxlocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN458"><span class='Ref_to_Member'>procs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN443"><span class='Ref_to_Struct'>BlockedProcData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN443"><span class='Ref_to_Struct'>BlockedProcData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN462"><span class='Ref_to_Member'>maxprocs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN459"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN464"><span class='Ref_to_Member'>maxlocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN460"><span class='Ref_to_Member'>waiter_pids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In order to search the ProcArray for blocked_pid and assume that that 
     * entry won't immediately disappear under us, we must hold ProcArrayLock. 
     * In addition, to examine the lock grouping fields of any other backend, 
     * we must hold all the hash partition locks.  (Only one of those locks is 
     * actually relevant for any one lock group, but we can't know which one 
     * ahead of time.)  It's fairly annoying to hold all those locks 
     * throughout this, but it's no worse than GetLockStatusData(), and it 
     * does have the advantage that we're guaranteed to return a 
     * self-consistent instantaneous state. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN3584"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN99"><span class='Ref_to_Proto'>BackendPidGetProcWithLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3581"><span class='Ref_to_Parameter'>blocked_pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to do if it's gone */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3584"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Acquire lock on the entire shared lock data structure.  See notes 
         * in GetLockStatusData(). 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3584"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Easy case, proc is not a lock group member */ 
</span>            <a href="lock.c.html#LN359"><span class='Ref_to_Proto'>GetSingleProcBlockerStatusData</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3584"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Examine all procs in proc's lock group */ 
</span><a name="LN3634"></a>            <a href="../../../include/lib/ilist.h.html#LN158"><span class='Ref_to_Struct'>dlist_iter</span></a>  <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/lib/ilist.h.html#LN506"><span class='Ref_to_Macro'>dlist_foreach</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3634"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3584"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN188"><span class='Ref_to_Member'>lockGroupMembers</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN3638"></a>                <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>memberProc</span><span class='Delimiter'>; 
</span> 
                <a href="lock.c.html#LN3638"><span class='Ref_To_Local'>memberProc</span></a> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a><span class='Delimiter'>, </span>lockGroupLink<span class='Delimiter'>, </span><a href="lock.c.html#LN3634"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN160"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="lock.c.html#LN359"><span class='Ref_to_Proto'>GetSingleProcBlockerStatusData</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3638"><span class='Ref_To_Local'>memberProc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * And release locks.  See notes in GetLockStatusData(). 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3585"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN461"><span class='Ref_to_Member'>nprocs</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN462"><span class='Ref_to_Member'>maxprocs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc!=NULL &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>ProcArrayLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN3583"><span class='Ref_To_Local'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetBlockerStatusData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Accumulate data about one possibly-blocked proc for GetBlockerStatusData */ 
</span><span class='Keyword'>static void 
</span><a name="LN3661"></a><span class='Declare_Function'>GetSingleProcBlockerStatusData</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>blocked_proc</span><span class='Delimiter'>, </span><a href="../../../include/storage/lock.h.html#LN456"><span class='Ref_to_Struct'>BlockedProcsData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3663"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>theLock</span> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>blocked_proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Delimiter'>; 
</span><a name="LN3664"></a>    <a href="../../../include/storage/lock.h.html#LN443"><span class='Ref_to_Struct'>BlockedProcData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bproc</span><span class='Delimiter'>; 
</span><a name="LN3665"></a>    <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span><span class='Delimiter'>; 
</span><a name="LN3666"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3667"></a>    <a href="../../../include/storage/lock.h.html#LN29"><span class='Ref_to_Struct'>PROC_QUEUE</span></a> <span class='Operator'>*</span><span class='Declare_Local'>waitQueue</span><span class='Delimiter'>; 
</span><a name="LN3668"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN3669"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>queue_size</span><span class='Delimiter'>; 
</span><a name="LN3670"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to do if this proc is not blocked */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3663"><span class='Ref_To_Local'>theLock</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up a procs[] element */ 
</span>    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN458"><span class='Ref_to_Member'>procs</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN461"><span class='Ref_to_Member'>nprocs</span></a><span class='Operator'>++</span><span class='Delimiter'>]; 
</span>    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN445"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>blocked_proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN448"><span class='Ref_to_Member'>first_lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN452"><span class='Ref_to_Member'>first_waiter</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We may ignore the proc's fast-path arrays, since nothing in those could 
     * be related to a contended lock. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Collect all PROCLOCKs associated with theLock */ 
</span>    <a href="lock.c.html#LN3665"><span class='Ref_To_Local'>procLocks</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3663"><span class='Ref_To_Local'>theLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3665"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3665"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3693"></a>        <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Delimiter'>; 
</span><a name="LN3694"></a>        <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span><a name="LN3695"></a>        <a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>instance</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a> <span class='Operator'>&GT;= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN464"><span class='Ref_to_Member'>maxlocks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN464"><span class='Ref_to_Member'>maxlocks</span></a> <span class='Operator'>+= </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN459"><span class='Ref_to_Member'>locks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN459"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN425"><span class='Ref_to_Struct'>LockInstanceData</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN464"><span class='Ref_to_Member'>maxlocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN459"><span class='Ref_to_Member'>locks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a><span class='Delimiter'>]; 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN427"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3694"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN428"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3693"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN3694"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3693"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN136"><span class='Ref_to_Member'>waitLockMode</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN429"><span class='Ref_to_Member'>waitLockMode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN33"><span class='Ref_to_Const'>NoLock</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN430"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3693"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN431"><span class='Ref_to_Member'>lxid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3693"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN104"><span class='Ref_to_Member'>lxid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN432"><span class='Ref_to_Member'>pid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3693"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN433"><span class='Ref_to_Member'>leaderPid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3695"><span class='Ref_To_Local'>instance</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN434"><span class='Ref_to_Member'>fastpath</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3665"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3666"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>lockLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while proclock &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Enlarge waiter_pids[] if it's too small to hold all wait queue PIDs */ 
</span>    <a href="lock.c.html#LN3667"><span class='Ref_To_Local'>waitQueue</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3663"><span class='Ref_To_Local'>theLock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3669"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3667"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN32"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3669"><span class='Ref_To_Local'>queue_size</span></a> <span class='Operator'>&GT; </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a> <span class='Operator'>- </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a> <span class='Operator'>+ </span><a href="../../utils/init/globals.c.html#LN126"><span class='Ref_to_Global_Var'>MaxBackends</span></a><span class='Delimiter'>, 
</span>                            <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a> <span class='Operator'>+ </span><a href="lock.c.html#LN3669"><span class='Ref_To_Local'>queue_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN460"><span class='Ref_to_Member'>waiter_pids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN460"><span class='Ref_to_Member'>waiter_pids</span></a><span class='Delimiter'>, 
</span>                                             <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN466"><span class='Ref_to_Member'>maxpids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Collect PIDs from the lock's wait queue, stopping at blocked_proc */ 
</span>    <a href="lock.c.html#LN3668"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN3667"><span class='Ref_To_Local'>waitQueue</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN31"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3670"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3670"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="lock.c.html#LN3669"><span class='Ref_To_Local'>queue_size</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3670"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3668"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>blocked_proc</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN460"><span class='Ref_to_Member'>waiter_pids</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="lock.c.html#LN3668"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN107"><span class='Ref_to_Member'>pid</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3668"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN3668"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN96"><span class='Ref_to_Member'>links</span></a><span class='Operator'>.</span><a href="../../../include/storage/shmem.h.html#LN30"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN449"><span class='Ref_to_Member'>num_locks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN463"><span class='Ref_to_Member'>nlocks</span></a> <span class='Operator'>- </span><a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN448"><span class='Ref_to_Member'>first_lock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN453"><span class='Ref_to_Member'>num_waiters</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3661"><span class='Ref_to_Parameter'>data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN465"><span class='Ref_to_Member'>npids</span></a> <span class='Operator'>- </span><a href="lock.c.html#LN3664"><span class='Ref_To_Local'>bproc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN452"><span class='Ref_to_Member'>first_waiter</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetSingleProcBlockerStatusData &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Returns a list of currently held AccessExclusiveLocks, for use by 
 * LogStandbySnapshot().  The result is a palloc'd array, 
 * with the number of elements returned into *nlocks. 
 * 
 * XXX This currently takes a lock on all partitions of the lock table, 
 * but it's possible to do better.  By reference counting locks and storing 
 * the value in the ProcArray entry for each backend we could tell if any 
 * locks need recording without having to acquire the partition locks and 
 * scan the lock table.  Whether that's worth the additional overhead 
 * is pretty dubious though. 
 */ 
</span><a href="../../../include/storage/lockdefs.h.html#LN48"><span class='Ref_to_Struct'>xl_standby_lock</span></a> <span class='Operator'>* 
</span><a name="LN3761"></a><span class='Declare_Function'>GetRunningTransactionLocks</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>nlocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3763"></a>    <a href="../../../include/storage/lockdefs.h.html#LN48"><span class='Ref_to_Struct'>xl_standby_lock</span></a> <span class='Operator'>*</span><span class='Declare_Local'>accessExclusiveLocks</span><span class='Delimiter'>; 
</span><a name="LN3764"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3765"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>seqstat</span><span class='Delimiter'>; 
</span><a name="LN3766"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3767"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN3768"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>els</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Acquire lock on the entire shared lock data structure. 
     * 
     * Must grab LWLocks in partition-number order to avoid LWLock deadlock. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now we can safely count the number of proclocks */ 
</span>    <a href="lock.c.html#LN3768"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocating enough space for all locks in the lock table is overkill, 
     * but it's more convenient and faster than having to enlarge the array. 
     */ 
</span>    <a href="lock.c.html#LN3763"><span class='Ref_To_Local'>accessExclusiveLocks</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3768"><span class='Ref_To_Local'>els</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN48"><span class='Ref_to_Struct'>xl_standby_lock</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now scan the tables to copy the data */ 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3765"><span class='Ref_To_Local'>seqstat</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If lock is a currently granted AccessExclusiveLock then it will have 
     * just one proclock holder, so locks are never accessed twice in this 
     * particular case. Don't copy this code for use elsewhere because in the 
     * general case this will give you duplicate locks when looking at 
     * non-exclusive lock types. 
     */ 
</span>    <a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3764"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3765"><span class='Ref_To_Local'>seqstat</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* make sure this definition matches the one used in LockAcquire */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3764"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>            <a href="lock.c.html#LN3764"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Operator'>-&GT;</span>tag<span class='Operator'>.</span>locktag_type <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN3804"></a>            <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="lock.c.html#LN3764"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc<span class='Delimiter'>; 
</span><a name="LN3805"></a>            <a href="../../../include/storage/proc.h.html#LN206"><span class='Ref_to_Struct'>PGXACT</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>pgxact</span> <span class='Operator'>= &</span><a href="proc.c.html#LN79"><span class='Ref_to_Global_Var'>ProcGlobal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN233"><span class='Ref_to_Member'>allPgXact</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3804"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN108"><span class='Ref_to_Member'>pgprocno</span></a><span class='Delimiter'>]; 
</span><a name="LN3806"></a>            <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span> <span class='Operator'>= </span><a href="lock.c.html#LN3764"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span><a name="LN3807"></a>            <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xid</span> <span class='Operator'>= </span><a href="lock.c.html#LN3805"><span class='Ref_To_Local'>pgxact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN208"><span class='Ref_to_Member'>xid</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Don't record locks for transactions if we know they have 
             * already issued their WAL record for commit but not yet released 
             * lock. It is still possible that we see locks held by already 
             * complete transactions, if they haven't yet zeroed their xids. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3807"><span class='Ref_To_Local'>xid</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3763"><span class='Ref_To_Local'>accessExclusiveLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lockdefs.h.html#LN50"><span class='Ref_to_Member'>xid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3807"><span class='Ref_To_Local'>xid</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3763"><span class='Ref_To_Local'>accessExclusiveLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lockdefs.h.html#LN51"><span class='Ref_to_Member'>dbOid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3806"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN3763"><span class='Ref_To_Local'>accessExclusiveLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="../../../include/storage/lockdefs.h.html#LN52"><span class='Ref_to_Member'>relOid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3806"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (proclock-&GT;holdMask&L... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (proclock=(PROCLOCK*)... &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN3768"><span class='Ref_To_Local'>els</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And release locks.  We do this in reverse order for two reasons: (1) 
     * Anyone else who needs more than one of the locks will be trying to lock 
     * them in increasing order; we don't want to release the other process 
     * until it can get all the locks it needs. (2) This avoids O(N^2) 
     * behavior inside LWLockRelease. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>;</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN500"><span class='Ref_to_Macro'>LockHashPartitionLockByIndex</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3766"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="lock.c.html#LN3761"><span class='Ref_to_Parameter'>nlocks</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3767"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN3763"><span class='Ref_To_Local'>accessExclusiveLocks</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetRunningTransactionLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Provide the textual name of any lock mode */ 
</span><span class='Keyword'>const char </span><span class='Operator'>* 
</span><a name="LN3844"></a><span class='Declare_Function'>GetLockmodeName</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Parameter'>lockmethodid</span><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a> <span class='Declare_Parameter'>mode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>lockmethodid</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>mode</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN113"><span class='Ref_to_Member'>numLockModes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>lockmethodid</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3844"><span class='Ref_to_Parameter'>mode</span></a><span class='Delimiter'>]; 
} 
</span> 
<span class='Directive'>#ifdef</span> LOCK_DEBUG 
<span class='Comment_Multi_Line'>/* 
 * Dump all locks in the given proc's myProcLocks lists. 
 * 
 * Caller is responsible for having acquired appropriate LWLocks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3858"></a><span class='Declare_Function'>DumpLocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>proc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3860"></a>    <a href="../../../include/storage/shmem.h.html#LN27"><span class='Ref_to_Struct'>SHM_QUEUE</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>procLocks</span><span class='Delimiter'>; 
</span><a name="LN3861"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3862"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN3863"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3858"><span class='Ref_to_Parameter'>proc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3858"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpLocks: waiting on"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3858"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3863"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="lock.c.html#LN3863"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/lwlock.h.html#LN116"><span class='Ref_to_Const'>NUM_LOCK_PARTITIONS</span></a><span class='Delimiter'>; </span><a href="lock.c.html#LN3863"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN3860"><span class='Ref_To_Local'>procLocks</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3858"><span class='Ref_to_Parameter'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3863"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3860"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3860"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myProc <span class='Operator'>== </span><a href="lock.c.html#LN3858"><span class='Ref_to_Parameter'>proc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3862"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpLocks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpLocks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3862"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/shmem.h.html#LN72"><span class='Ref_to_Proto'>SHMQueueNext</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3860"><span class='Ref_To_Local'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3861"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a><span class='Delimiter'>, </span>procLink<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;NUM_LOCK_PARTIT... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end DumpLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Dump all lmgr locks. 
 * 
 * Caller is responsible for having acquired appropriate LWLocks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3900"></a><span class='Declare_Function'>DumpAllLocks</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3902"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span><a name="LN3903"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3904"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN3905"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN3902"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3902"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>&& </span><a href="lock.c.html#LN3902"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Parentheses'>) 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpAllLocks: waiting on"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3902"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN134"><span class='Ref_to_Member'>waitLock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3905"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="lock.c.html#LN3903"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3905"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpAllLocks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3903"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN3904"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3903"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3904"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>            <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"DumpAllLocks"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3904"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"DumpAllLocks: proclock-&GT;tag.myLock = NULL"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end DumpAllLocks &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* LOCK_DEBUG */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * LOCK 2PC resource manager's routines 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Re-acquire a lock belonging to a transaction that was prepared. 
 * 
 * Because this function is run at db startup, re-acquiring the locks should 
 * never conflict with running transactions because there are none.  We 
 * assume that the lock state represented by the stored 2PC files is legal. 
 * 
 * When switching from Hot Standby mode to normal operation, the locks will 
 * be already held by the startup process. The locks are acquired for the new 
 * procs without checking for conflicts, so we don't get a conflict between the 
 * startup process and the dummy procs, even though we will momentarily have 
 * a situation where two procs are holding the same AccessExclusiveLock, 
 * which isn't normally possible because the conflict. If we're in standby 
 * mode, but a recovery snapshot hasn't been established yet, it's possible 
 * that some but not all of the locks are already held by the startup process. 
 * 
 * This approach is simple, but also a bit dangerous, because if there isn't 
 * enough shared memory to acquire the locks, an error will be thrown, which 
 * is promoted to FATAL and recovery will abort, bringing down postmaster. 
 * A safer approach would be to transfer the locks like we do in 
 * AtPrepare_Locks, but then again, in hot standby mode it's possible for 
 * read-only backends to use up all the shared lock memory anyway, so that 
 * replaying the WAL record that needs to acquire a lock will throw an error 
 * and PANIC anyway. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN3957"></a><span class='Declare_Function'>lock_twophase_recover</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN3958"></a>                      <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3960"></a>    <a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN3958"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>; 
</span><a name="LN3961"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN35"><span class='Ref_to_Proto'>TwoPhaseGetDummyProc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3957"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3962"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>locktag</span><span class='Delimiter'>; 
</span><a name="LN3963"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN3964"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span><span class='Delimiter'>; 
</span><a name="LN3965"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN3966"></a>    <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN3967"></a>    <a href="../../../include/storage/lock.h.html#LN337"><span class='Ref_to_Struct'>PROCLOCKTAG</span></a> <span class='Declare_Local'>proclocktag</span><span class='Delimiter'>; 
</span><a name="LN3968"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN3969"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN3970"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>proclock_hashcode</span><span class='Delimiter'>; 
</span><a name="LN3971"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>partition</span><span class='Delimiter'>; 
</span><a name="LN3972"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN3973"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3958"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3962"><span class='Ref_To_Local'>locktag</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN3960"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN159"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3960"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN160"><span class='Ref_to_Member'>lockmode</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3964"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3962"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3964"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN3964"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3964"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3973"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3964"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span> 
    <a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3962"><span class='Ref_To_Local'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3971"><span class='Ref_To_Local'>partition</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN495"><span class='Ref_to_Macro'>LockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3972"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3972"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a lock with this tag. 
     */ 
</span>    <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN3962"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="lock.c.html#LN3968"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3972"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * if it's a new lock object, initialize it 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3968"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN291"><span class='Ref_to_Member'>waitMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../ipc/shmqueue.c.html#LN34"><span class='Ref_to_Func'>SHMQueueInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/proc.h.html#LN299"><span class='Ref_to_Proto'>ProcQueueInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN293"><span class='Ref_to_Member'>waitProcs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="../../../include/storage/lock.h.html#LN85"><span class='Ref_to_Const'>MAX_LOCKMODES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"lock_twophase_recover: new"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN300"><span class='Ref_to_Func'>LOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"lock_twophase_recover: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN296"><span class='Ref_to_Member'>granted</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN297"><span class='Ref_to_Member'>nGranted</span></a> <span class='Operator'>&LT;= </span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the hash key for the proclock table. 
     */ 
</span>    <a href="lock.c.html#LN3967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN340"><span class='Ref_to_Member'>myLock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN341"><span class='Ref_to_Member'>myProc</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3961"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN3970"><span class='Ref_To_Local'>proclock_hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN536"><span class='Ref_to_Func'>ProcLockHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a proclock entry with this tag 
     */ 
</span>    <a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN253"><span class='Ref_to_Global_Var'>LockMethodProcLockHash</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="lock.c.html#LN3967"><span class='Ref_To_Local'>proclocktag</span></a><span class='Delimiter'>, 
</span>                                                        <a href="lock.c.html#LN3970"><span class='Ref_To_Local'>proclock_hashcode</span></a><span class='Delimiter'>, 
</span>                                                        <a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Delimiter'>, 
</span>                                                        <span class='Operator'>&</span><a href="lock.c.html#LN3968"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Oops, not enough shmem for the proclock */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There are no other requestors of this lock, so garbage-collect 
             * the lock object.  We *must* do this to avoid a permanent leak 
             * of shared memory, because there won't be anything to cause 
             * anyone to release the lock object later. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/shmem.h.html#LN76"><span class='Ref_to_Proto'>SHMQueueEmpty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                             <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, 
</span>                                             <span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"lock table corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3972"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !proclock &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If new, initialize the new entry 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN3968"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3961"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN187"><span class='Ref_to_Member'>lockGroupLeader</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN350"><span class='Ref_to_Member'>groupLeader</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN3961"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN352"><span class='Ref_to_Member'>releaseMask</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Add proclock to appropriate lists */ 
</span>        <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN292"><span class='Ref_to_Member'>procLocks</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN353"><span class='Ref_to_Member'>lockLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/shmem.h.html#LN70"><span class='Ref_to_Proto'>SHMQueueInsertBefore</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="lock.c.html#LN3961"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN155"><span class='Ref_to_Member'>myProcLocks</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3971"><span class='Ref_To_Local'>partition</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN354"><span class='Ref_to_Member'>procLink</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"lock_twophase_recover: new"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="lock.c.html#LN324"><span class='Ref_to_Func'>PROCLOCK_PRINT</span></a><span class='Parentheses'>(</span><span class='String'>"lock_twophase_recover: found"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& ~</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN290"><span class='Ref_to_Member'>grantMask</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * lock-&GT;nRequested and lock-&GT;requested[] count the total number of 
     * requests, whether granted or waiting, so increment those immediately. 
     */ 
</span>    <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN294"><span class='Ref_to_Member'>requested</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We shouldn't already hold the desired lock. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN351"><span class='Ref_to_Member'>holdMask</span></a> <span class='Operator'>& </span><a href="../../../include/storage/lock.h.html#LN87"><span class='Ref_to_Macro'>LOCKBIT_ON</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"lock %s on object %u/%u/%u is already held"</span><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN3973"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN115"><span class='Ref_to_Member'>lockModeNames</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Delimiter'>], 
</span>             <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a><span class='Delimiter'>, 
</span>             <a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN182"><span class='Ref_to_Member'>locktag_field3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We ignore any possible conflicts and just grant ourselves the lock. Not 
     * only because we don't bother, but also to avoid deadlocks when 
     * switching from standby to normal mode. See function comment. 
     */ 
</span>    <a href="../../../include/storage/lock.h.html#LN548"><span class='Ref_to_Proto'>GrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3966"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Bump strong lock count, to make sure any fast-path lock requests won't 
     * be granted without consulting the primary lock table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN204"><span class='Ref_to_Macro'>ConflictsWithRelationFastPath</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN3965"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN287"><span class='Ref_to_Member'>tag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN3963"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN4123"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>fasthashcode</span> <span class='Operator'>= </span><a href="lock.c.html#LN234"><span class='Ref_to_Macro'>FastPathStrongLockHashPartition</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3969"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN240"><span class='Ref_to_Member'>count</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN4123"><span class='Ref_To_Local'>fasthashcode</span></a><span class='Delimiter'>]</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN243"><span class='Ref_to_Global_Var'>FastPathStrongRelationLocks</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN239"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN3972"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lock_twophase_recover &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Re-acquire a lock belonging to a transaction that was prepared, when 
 * starting up into hot standby mode. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4138"></a><span class='Declare_Function'>lock_twophase_standby_recover</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN4139"></a>                              <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4141"></a>    <a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN4139"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>; 
</span><a name="LN4142"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>locktag</span><span class='Delimiter'>; 
</span><a name="LN4143"></a>    <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN4144"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN4139"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4142"><span class='Ref_To_Local'>locktag</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN4141"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN159"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4143"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4141"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN160"><span class='Ref_to_Member'>lockmode</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4144"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4142"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4144"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN4144"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN4144"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4143"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lockdefs.h.html#LN45"><span class='Ref_to_Const'>AccessExclusiveLock</span></a> <span class='Operator'>&& 
</span>        <a href="lock.c.html#LN4142"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN184"><span class='Ref_to_Member'>locktag_type</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN140"><span class='Ref_to_EnumConst'>LOCKTAG_RELATION</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/standby.h.html#LN48"><span class='Ref_to_Proto'>StandbyAcquireAccessExclusiveLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4138"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, 
</span>                                        <a href="lock.c.html#LN4142"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN180"><span class='Ref_to_Member'>locktag_field1</span></a> <span class='Comment_Multi_Line'>/* dboid */ </span><span class='Delimiter'>, 
</span>                                      <a href="lock.c.html#LN4142"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN181"><span class='Ref_to_Member'>locktag_field2</span></a> <span class='Comment_Multi_Line'>/* reloid */ </span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end lock_twophase_standby_recover &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * 2PC processing routine for COMMIT PREPARED case. 
 * 
 * Find and release the lock indicated by the 2PC record. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4170"></a><span class='Declare_Function'>lock_twophase_postcommit</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN4171"></a>                         <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4173"></a>    <a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rec</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN4171"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>; 
</span><a name="LN4174"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span> <span class='Operator'>= </span><a href="../../../include/access/twophase.h.html#LN35"><span class='Ref_to_Proto'>TwoPhaseGetDummyProc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4170"><span class='Ref_to_Parameter'>xid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN4175"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>locktag</span><span class='Delimiter'>; 
</span><a name="LN4176"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span><span class='Delimiter'>; 
</span><a name="LN4177"></a>    <a href="../../../include/storage/lock.h.html#LN119"><span class='Ref_to_Typedef'>LockMethod</span></a>  <span class='Declare_Local'>lockMethodTable</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN4171"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="lock.c.html#LN157"><span class='Ref_to_Struct'>TwoPhaseLockRecord</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4175"><span class='Ref_To_Local'>locktag</span></a> <span class='Operator'>= &</span><a href="lock.c.html#LN4173"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN159"><span class='Ref_to_Member'>locktag</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4176"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4175"><span class='Ref_To_Local'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4176"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN4176"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN4176"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4177"><span class='Ref_To_Local'>lockMethodTable</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="lock.c.html#LN4176"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Delimiter'>]; 
</span> 
    <a href="lock.c.html#LN356"><span class='Ref_to_Proto'>LockRefindAndRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4177"><span class='Ref_To_Local'>lockMethodTable</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4174"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4175"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4173"><span class='Ref_To_Local'>rec</span></a><span class='Operator'>-&GT;</span><a href="lock.c.html#LN160"><span class='Ref_to_Member'>lockmode</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lock_twophase_postcommit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * 2PC processing routine for ROLLBACK PREPARED case. 
 * 
 * This is actually just the same as the COMMIT case. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4196"></a><span class='Declare_Function'>lock_twophase_postabort</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>info</span><span class='Delimiter'>, 
</span><a name="LN4197"></a>                        <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>recdata</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lock.h.html#LN560"><span class='Ref_to_Proto'>lock_twophase_postcommit</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4196"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4196"><span class='Ref_to_Parameter'>info</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4197"><span class='Ref_to_Parameter'>recdata</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4197"><span class='Ref_to_Parameter'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      VirtualXactLockTableInsert 
 * 
 *      Take vxid lock via the fast-path.  There can't be any pre-existing 
 *      lockers, as we haven't advertised this vxid via the ProcArray yet. 
 * 
 *      Since MyProc-&GT;fpLocalTransactionId will normally contain the same data 
 *      as MyProc-&GT;lxid, you might wonder if we really need both.  The 
 *      difference is that MyProc-&GT;lxid is set and cleared unlocked, and 
 *      examined by procarray.c, while fpLocalTransactionId is protected by 
 *      backendLock and is used only by the locking subsystem.  Doing it this 
 *      way makes it easier to verify that there are no funny race conditions. 
 * 
 *      We don't bother recording this lock in the local lock table, since it's 
 *      only ever released at the end of a transaction.  Instead, 
 *      LockReleaseAll() calls VirtualXactLockTableCleanup(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4220"></a><span class='Declare_Function'>VirtualXactLockTableInsert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Parameter'>vxid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4220"><span class='Ref_to_Parameter'>vxid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>== </span><a href="lock.c.html#LN4220"><span class='Ref_to_Parameter'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a> <span class='Operator'>== </span><a href="../../../include/storage/lock.h.html#LN69"><span class='Ref_to_Const'>InvalidLocalTransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a> <span class='Operator'>== </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4220"><span class='Ref_to_Parameter'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *      VirtualXactLockTableCleanup 
 * 
 *      Check whether a VXID lock has been materialized; if so, release it, 
 *      unblocking waiters. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN4243"></a><span class='Declare_Function'>VirtualXactLockTableCleanup</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4245"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>fastpath</span><span class='Delimiter'>; 
</span><a name="LN4246"></a>    <a href="../../../include/c.h.html#LN398"><span class='Ref_to_Typedef'>LocalTransactionId</span></a> <span class='Declare_Local'>lxid</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clean up shared memory state. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN4245"><span class='Ref_To_Local'>fastpath</span></a> <span class='Operator'>= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4246"><span class='Ref_To_Local'>lxid</span></a> <span class='Operator'>= </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN69"><span class='Ref_to_Const'>InvalidLocalTransactionId</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If fpVXIDLock has been cleared without touching fpLocalTransactionId, 
     * that means someone transferred the lock to the main lock table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN4245"><span class='Ref_To_Local'>fastpath</span></a> <span class='Operator'>&& </span><a href="../../../include/storage/lock.h.html#LN70"><span class='Ref_to_Macro'>LocalTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4246"><span class='Ref_To_Local'>lxid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN4268"></a>        <a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Local'>vxid</span><span class='Delimiter'>; 
</span><a name="LN4269"></a>        <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>locktag</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN4268"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>= </span><a href="../../utils/init/globals.c.html#LN72"><span class='Ref_to_Global_Var'>MyBackendId</span></a><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN4268"><span class='Ref_To_Local'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4246"><span class='Ref_To_Local'>lxid</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lock.h.html#LN233"><span class='Ref_to_Macro'>SET_LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4269"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4268"><span class='Ref_To_Local'>vxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN356"><span class='Ref_to_Proto'>LockRefindAndRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a><span class='Delimiter'>], </span><a href="proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="lock.c.html#LN4269"><span class='Ref_To_Local'>locktag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end VirtualXactLockTableCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      VirtualXactLock 
 * 
 * If wait = true, wait until the given VXID has been released, and then 
 * return true. 
 * 
 * If wait = false, just check whether the VXID is still running, and return 
 * true or false. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN4290"></a><span class='Declare_Function'>VirtualXactLock</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN62"><span class='Ref_to_Typedef'>VirtualTransactionId</span></a> <span class='Declare_Parameter'>vxid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>wait</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4292"></a>    <a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a>     <span class='Declare_Local'>tag</span><span class='Delimiter'>; 
</span><a name="LN4293"></a>    <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>proc</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN71"><span class='Ref_to_Macro'>VirtualTransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>vxid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN233"><span class='Ref_to_Macro'>SET_LOCKTAG_VIRTUALTRANSACTION</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4292"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>vxid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a lock table entry must be made, this is the PGPROC on whose behalf 
     * it must be done.  Note that the transaction might end or the PGPROC 
     * might be reassigned to a new backend before we get around to examining 
     * it, but it doesn't matter.  If we find upon examination that the 
     * relevant lxid is no longer running here, that's enough to prove that 
     * it's no longer running anywhere. 
     */ 
</span>    <a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinvaladt.h.html#LN33"><span class='Ref_to_Proto'>BackendIdGetProc</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must acquire this lock before checking the backendId and lxid 
     * against the ones we're waiting for.  The target backend will only set 
     * or clear lxid while holding this lock. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the transaction has ended, our work here is done. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN111"><span class='Ref_to_Member'>backendId</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN64"><span class='Ref_to_Member'>backendId</span></a> 
        <span class='Operator'>|| </span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN180"><span class='Ref_to_Member'>fpLocalTransactionId</span></a> <span class='Operator'>!= </span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>vxid</span></a><span class='Operator'>.</span><a href="../../../include/storage/lock.h.html#LN65"><span class='Ref_to_Member'>localTransactionId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we aren't asked to wait, there's no need to set up a lock table 
     * entry.  The transaction is still in progress, so just return false. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN4290"><span class='Ref_to_Parameter'>wait</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK, we're going to need to sleep on the VXID.  But first, we must set 
     * up the primary lock table entry, if needed (ie, convert the proc's 
     * fast-path lock on its VXID to a regular lock). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN4343"></a>        <a href="../../../include/storage/lock.h.html#LN344"><span class='Ref_to_Struct'>PROCLOCK</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>proclock</span><span class='Delimiter'>; 
</span><a name="LN4344"></a>        <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN4345"></a>        <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN4344"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4292"><span class='Ref_To_Local'>tag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN4345"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4344"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4345"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN4343"><span class='Ref_To_Local'>proclock</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN343"><span class='Ref_to_Proto'>SetupLockInTable</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Delimiter'>[</span><a href="../../../include/storage/lock.h.html#LN128"><span class='Ref_to_Const'>DEFAULT_LOCKMETHOD</span></a><span class='Delimiter'>], </span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Delimiter'>, 
</span>                                    <span class='Operator'>&</span><a href="lock.c.html#LN4292"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="lock.c.html#LN4344"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="lock.c.html#LN4343"><span class='Ref_To_Local'>proclock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4345"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to increase max_locks_per_transaction."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/lock.h.html#LN548"><span class='Ref_to_Proto'>GrantLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4343"><span class='Ref_To_Local'>proclock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN347"><span class='Ref_to_Member'>tag</span></a><span class='Operator'>.</span>myLock<span class='Delimiter'>, </span><a href="lock.c.html#LN4343"><span class='Ref_To_Local'>proclock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN43"><span class='Ref_to_Const'>ExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4345"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN179"><span class='Ref_to_Member'>fpVXIDLock</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if proc-&GT;fpVXIDLock &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Done with proc-&GT;fpLockBits */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4293"><span class='Ref_To_Local'>proc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN174"><span class='Ref_to_Member'>backendLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Time to wait. */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/lock.h.html#LN523"><span class='Ref_to_Proto'>LockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4292"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lock.h.html#LN533"><span class='Ref_to_Proto'>LockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="lock.c.html#LN4292"><span class='Ref_To_Local'>tag</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN40"><span class='Ref_to_Const'>ShareLock</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end VirtualXactLock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * LockWaiterCount 
 * 
 * Find the number of lock requester on this locktag 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN4386"></a><span class='Declare_Function'>LockWaiterCount</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/lock.h.html#LN178"><span class='Ref_to_Struct'>LOCKTAG</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>locktag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN4388"></a>    <a href="../../../include/storage/lock.h.html#LN125"><span class='Ref_to_Typedef'>LOCKMETHODID</span></a> <span class='Declare_Local'>lockmethodid</span> <span class='Operator'>= </span><a href="lock.c.html#LN4386"><span class='Ref_to_Parameter'>locktag</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN185"><span class='Ref_to_Member'>locktag_lockmethodid</span></a><span class='Delimiter'>; 
</span><a name="LN4389"></a>    <a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>lock</span><span class='Delimiter'>; 
</span><a name="LN4390"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN4391"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hashcode</span><span class='Delimiter'>; 
</span><a name="LN4392"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>partitionLock</span><span class='Delimiter'>; 
</span><a name="LN4393"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>waiters</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4388"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="lock.c.html#LN4388"><span class='Ref_To_Local'>lockmethodid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN149"><span class='Ref_to_Global_Var'>LockMethods</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized lock method: %d"</span><span class='Delimiter'>, </span><a href="lock.c.html#LN4388"><span class='Ref_To_Local'>lockmethodid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN4391"><span class='Ref_To_Local'>hashcode</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN488"><span class='Ref_to_Func'>LockTagHashCode</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4386"><span class='Ref_to_Parameter'>locktag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="lock.c.html#LN4392"><span class='Ref_To_Local'>partitionLock</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lock.h.html#LN497"><span class='Ref_to_Macro'>LockHashPartitionLock</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4391"><span class='Ref_To_Local'>hashcode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4392"><span class='Ref_To_Local'>partitionLock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="lock.c.html#LN4389"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/lock.h.html#LN284"><span class='Ref_to_Struct'>LOCK</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN252"><span class='Ref_to_Global_Var'>LockMethodLockHash</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="lock.c.html#LN4386"><span class='Ref_to_Parameter'>locktag</span></a><span class='Delimiter'>, 
</span>                                                <a href="lock.c.html#LN4391"><span class='Ref_To_Local'>hashcode</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                <span class='Operator'>&</span><a href="lock.c.html#LN4390"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="lock.c.html#LN4390"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="lock.c.html#LN4389"><span class='Ref_To_Local'>lock</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="lock.c.html#LN4393"><span class='Ref_To_Local'>waiters</span></a> <span class='Operator'>= </span><a href="lock.c.html#LN4389"><span class='Ref_To_Local'>lock</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/lock.h.html#LN295"><span class='Ref_to_Member'>nRequested</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="lock.c.html#LN4392"><span class='Ref_To_Local'>partitionLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="lock.c.html#LN4393"><span class='Ref_To_Local'>waiters</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LockWaiterCount &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>