<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\page\bufpage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\page\bufpage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * bufpage.c 
 *    POSTGRES standard buffer page code. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/page/bufpage.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/itup.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/checksum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memdebug.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* GUC variable */ 
</span><a name="LN25"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>ignore_checksum_failure</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                      Page support functions 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageInit 
 *      Initializes the contents of a page. 
 *      Note that we don't calculate an initial checksum here; that's not done 
 *      until it's time to write. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN40"></a><span class='Declare_Function'>PageInit</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>pageSize</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>specialSize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN42"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>p</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>specialSize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>specialSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>specialSize</span></a> <span class='Operator'>+ </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure all fields of page are zero, as well as unused space */ 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN42"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN42"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN152"><span class='Ref_to_Member'>pd_flags</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN42"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN42"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>specialSize</span></a><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN42"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>specialSize</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/bufpage.h.html#LN281"><span class='Ref_to_Macro'>PageSetPageSizeAndVersion</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN40"><span class='Ref_to_Parameter'>pageSize</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN195"><span class='Ref_to_Const'>PG_PAGE_LAYOUT_VERSION</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* p-&GT;pd_prune_xid = InvalidTransactionId;      done by above MemSet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PageInit &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageIsVerified 
 *      Check that the page header and checksum (if any) appear valid. 
 * 
 * This is called when a page has just been read in from disk.  The idea is 
 * to cheaply detect trashed pages before we go nuts following bogus item 
 * pointers, testing invalid transaction identifiers, etc. 
 * 
 * It turns out to be necessary to allow zeroed pages here too.  Even though 
 * this routine is *not* called when deliberately adding a page to a relation, 
 * there are scenarios in which a zeroed page might be found in a table. 
 * (Example: a backend extends a relation, then crashes before it can write 
 * any WAL entry about the new page.  The kernel will already have the 
 * zeroed page in the file, and it will stay that way after restart.)  So we 
 * allow zeroed pages here, and are careful that the page access macros 
 * treat such a page as empty and without free space.  Eventually, VACUUM 
 * will clean up such a page and make it usable. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN80"></a><span class='Declare_Function'>PageIsVerified</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN82"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>p</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN80"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN83"></a>    size_t     <span class='Operator'>*</span><span class='Declare_Local'>pagebytes</span><span class='Delimiter'>; 
</span><a name="LN84"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN85"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>checksum_failure</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN86"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>header_sane</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN87"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>all_zeroes</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>checksum</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't verify page data unless the page passes basic non-zero test 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN80"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlog.h.html#LN259"><span class='Ref_to_Proto'>DataChecksumsEnabled</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <a href="bufpage.c.html#LN88"><span class='Ref_To_Local'>checksum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/checksum.h.html#LN21"><span class='Ref_to_Proto'>pg_checksum_page</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN80"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN80"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN88"><span class='Ref_To_Local'>checksum</span></a> <span class='Operator'>!= </span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN151"><span class='Ref_to_Member'>pd_checksum</span></a><span class='Parentheses'>) 
</span>                <a href="bufpage.c.html#LN85"><span class='Ref_To_Local'>checksum_failure</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The following checks don't prove the header is correct, only that 
         * it looks sane enough to allow into the buffer pool. Later usage of 
         * the block can still reveal problems, which is why we offer the 
         * checksum option. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN152"><span class='Ref_to_Member'>pd_flags</span></a> <span class='Operator'>& ~</span><a href="../../../include/storage/bufpage.h.html#LN181"><span class='Ref_to_Const'>PD_VALID_FLAG_BITS</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&& 
</span>            <a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&& 
</span>            <a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&LT;= </span>BLCKSZ <span class='Operator'>&& 
</span>            <a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>))</span> 
            <a href="bufpage.c.html#LN86"><span class='Ref_To_Local'>header_sane</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN86"><span class='Ref_To_Local'>header_sane</span></a> <span class='Operator'>&& !</span><a href="bufpage.c.html#LN85"><span class='Ref_To_Local'>checksum_failure</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !PageIsNew(page) &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check all-zeroes case. Luckily BLCKSZ is guaranteed to always be a 
     * multiple of size_t - and it's much faster to compare memory using the 
     * native word size. 
     */ 
</span>    <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>== </span><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>))</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <span class='String'>"BLCKSZ has to be a multiple of sizeof(size_t)"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN87"><span class='Ref_To_Local'>all_zeroes</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN83"><span class='Ref_To_Local'>pagebytes</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>size_t <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN80"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN84"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN84"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>/ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>))</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN84"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN83"><span class='Ref_To_Local'>pagebytes</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN84"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="bufpage.c.html#LN87"><span class='Ref_To_Local'>all_zeroes</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN87"><span class='Ref_To_Local'>all_zeroes</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Throw a WARNING if the checksum fails, but only after we've checked for 
     * the all-zeroes case. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN85"><span class='Ref_To_Local'>checksum_failure</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"page verification failed, calculated checksum %u but expected %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN88"><span class='Ref_To_Local'>checksum</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN82"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN151"><span class='Ref_to_Member'>pd_checksum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN86"><span class='Ref_To_Local'>header_sane</span></a> <span class='Operator'>&& </span><a href="bufpage.c.html#LN25"><span class='Ref_to_Global_Var'>ignore_checksum_failure</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageIsVerified &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  PageAddItemExtended 
 * 
 *  Add an item to a page.  Return value is the offset at which it was 
 *  inserted, or InvalidOffsetNumber if the item is not inserted for any 
 *  reason.  A WARNING is issued indicating the reason for the refusal. 
 * 
 *  offsetNumber must be either InvalidOffsetNumber to specify finding a 
 *  free item pointer, or a value between FirstOffsetNumber and one past 
 *  the last existing item, to specify using that particular item pointer. 
 * 
 *  If offsetNumber is valid and flag PAI_OVERWRITE is set, we just store 
 *  the item at the specified offsetNumber, which must be either a 
 *  currently-unused item pointer, or one past the last existing item. 
 * 
 *  If offsetNumber is valid and flag PAI_OVERWRITE is not set, insert 
 *  the item at the specified offsetNumber, moving existing items later 
 *  in the array to make room. 
 * 
 *  If offsetNumber is not valid, then assign a slot by finding the first 
 *  one that is both unused and deallocated. 
 * 
 *  If flag PAI_IS_HEAP is set, we enforce that there can't be more than 
 *  MaxHeapTuplesPerPage line pointers on the page. 
 * 
 *  !!! EREPORT(ERROR) IS DISALLOWED HERE !!! 
 */ 
</span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> 
<a name="LN189"></a><span class='Declare_Function'>PageAddItemExtended</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, 
</span><a name="LN190"></a>                    <a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a> <span class='Declare_Parameter'>item</span><span class='Delimiter'>, 
</span><a name="LN191"></a>                    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Delimiter'>, 
</span><a name="LN192"></a>                    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offsetNumber</span><span class='Delimiter'>, 
</span><a name="LN193"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN195"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN189"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN196"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>alignedSize</span><span class='Delimiter'>; 
</span><a name="LN197"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lower</span><span class='Delimiter'>; 
</span><a name="LN198"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>upper</span><span class='Delimiter'>; 
</span><a name="LN199"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>itemId</span><span class='Delimiter'>; 
</span><a name="LN200"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>limit</span><span class='Delimiter'>; 
</span><a name="LN201"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>needshuffle</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Be wary about corrupted page pointers 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ<span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select offsetNumber to place the new item at 
     */ 
</span>    <a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN189"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* was offsetNumber passed in? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/off.h.html#LN39"><span class='Ref_to_Macro'>OffsetNumberIsValid</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* yes, check it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="bufpage.c.html#LN193"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/storage/bufpage.h.html#LN409"><span class='Ref_to_Const'>PAI_OVERWRITE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"will not overwrite a used ItemId"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>) 
</span>                <a href="bufpage.c.html#LN201"><span class='Ref_To_Local'>needshuffle</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* need to move existing linp's */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if OffsetNumberIsValid(o... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* offsetNumber was not passed in, so find a free slot */ 
</span>        <span class='Comment_Multi_Line'>/* if no free slot, we'll put it at limit (1st open slot) */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN367"><span class='Ref_to_Macro'>PageHasFreeLinePointers</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Look for "recyclable" (unused) ItemId.  We check for no storage 
             * as well, just to be paranoid --- unused items should never have 
             * storage. 
             */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Parentheses'>))</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&GT;= </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* the hint is wrong, so reset it */ 
</span>                <a href="../../../include/storage/bufpage.h.html#LN371"><span class='Ref_to_Macro'>PageClearHasFreeLinePointers</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* don't bother searching if hint says there's no free slot */ 
</span>            <a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Reject placing items beyond the first unused line pointer */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"specified item offset is too large"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Reject placing items beyond heap boundary, if heap */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="bufpage.c.html#LN193"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/storage/bufpage.h.html#LN410"><span class='Ref_to_Const'>PAI_IS_HEAP</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>&GT; </span><a href="../../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"can't put more than MaxHeapTuplesPerPage items in a heap page"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute new lower and upper pointers for page, see if it'll fit. 
     * 
     * Note: do arithmetic as signed ints, to avoid mistakes if, say, 
     * alignedSize &GT; pd_upper. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a> <span class='Operator'>== </span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>|| </span><a href="bufpage.c.html#LN201"><span class='Ref_To_Local'>needshuffle</span></a><span class='Parentheses'>) 
</span>        <a href="bufpage.c.html#LN197"><span class='Ref_To_Local'>lower</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="bufpage.c.html#LN197"><span class='Ref_To_Local'>lower</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN196"><span class='Ref_To_Local'>alignedSize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN191"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN198"><span class='Ref_To_Local'>upper</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN196"><span class='Ref_To_Local'>alignedSize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN197"><span class='Ref_To_Local'>lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN198"><span class='Ref_To_Local'>upper</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/storage/off.h.html#LN25"><span class='Ref_to_Const'>InvalidOffsetNumber</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK to insert the item.  First, shuffle the existing pointers if needed. 
     */ 
</span>    <a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN201"><span class='Ref_To_Local'>needshuffle</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="bufpage.c.html#LN200"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set the item pointer */ 
</span>    <a href="../../../include/storage/itemid.h.html#LN138"><span class='Ref_to_Macro'>ItemIdSetNormal</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN199"><span class='Ref_To_Local'>itemId</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN198"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN191"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Items normally contain no uninitialized bytes.  Core bufpage consumers 
     * conform, but this is not a necessary coding rule; a new index AM could 
     * opt to depart from it.  However, data type input functions and other 
     * C-language functions that synthesize datums should initialize all 
     * bytes; datumIsEqual() relies on this.  Testing here, along with the 
     * similar check in printtup(), helps to catch such mistakes. 
     * 
     * Values of the "name" type retrieved via index-only scans may contain 
     * uninitialized bytes; see comment in btrescan().  Valgrind will report 
     * this as an error, but it is safe to ignore. 
     */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN22"><span class='Ref_to_Macro'>VALGRIND_CHECK_MEM_IS_DEFINED</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN190"><span class='Ref_to_Parameter'>item</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN191"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* copy the item's data onto the page */ 
</span>    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN189"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN198"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN190"><span class='Ref_to_Parameter'>item</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN191"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* adjust page header */ 
</span>    <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN82"><span class='Ref_to_Typedef'>LocationIndex</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN197"><span class='Ref_To_Local'>lower</span></a><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN195"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN82"><span class='Ref_to_Typedef'>LocationIndex</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN198"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="bufpage.c.html#LN192"><span class='Ref_to_Parameter'>offsetNumber</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageAddItemExtended &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageGetTempPage 
 *      Get a temporary page in local memory for special processing. 
 *      The returned page is not initialized at all; caller must do that. 
 */ 
</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> 
<a name="LN347"></a><span class='Declare_Function'>PageGetTempPage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN349"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span><span class='Delimiter'>; 
</span><a name="LN350"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>temp</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN349"><span class='Ref_To_Local'>pageSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN347"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN350"><span class='Ref_To_Local'>temp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN349"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="bufpage.c.html#LN350"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageGetTempPageCopy 
 *      Get a temporary page in local memory for special processing. 
 *      The page is initialized by copying the contents of the given page. 
 */ 
</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> 
<a name="LN364"></a><span class='Declare_Function'>PageGetTempPageCopy</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN366"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span><span class='Delimiter'>; 
</span><a name="LN367"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>temp</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN366"><span class='Ref_To_Local'>pageSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN364"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN367"><span class='Ref_To_Local'>temp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN366"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="bufpage.c.html#LN367"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN364"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN366"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="bufpage.c.html#LN367"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageGetTempPageCopySpecial 
 *      Get a temporary page in local memory for special processing. 
 *      The page is PageInit'd with the same special-space size as the 
 *      given page, and the special space is copied from the given page. 
 */ 
</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> 
<a name="LN384"></a><span class='Declare_Function'>PageGetTempPageCopySpecial</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN386"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span><span class='Delimiter'>; 
</span><a name="LN387"></a>    <a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a>        <span class='Declare_Local'>temp</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN386"><span class='Ref_To_Local'>pageSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN384"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN387"><span class='Ref_To_Local'>temp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN386"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN39"><span class='Ref_to_Func'>PageInit</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN387"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN386"><span class='Ref_To_Local'>pageSize</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN296"><span class='Ref_to_Macro'>PageGetSpecialSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN384"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN387"><span class='Ref_To_Local'>temp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../../include/storage/bufpage.h.html#LN322"><span class='Ref_to_Macro'>PageGetSpecialPointer</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN384"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../../../include/storage/bufpage.h.html#LN296"><span class='Ref_to_Macro'>PageGetSpecialSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN384"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="bufpage.c.html#LN387"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageRestoreTempPage 
 *      Copy temporary page back to permanent page after special processing 
 *      and release the temporary page. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN406"></a><span class='Declare_Function'>PageRestoreTempPage</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>tempPage</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>oldPage</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN408"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageSize</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN408"><span class='Ref_To_Local'>pageSize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN264"><span class='Ref_to_Macro'>PageGetPageSize</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN406"><span class='Ref_to_Parameter'>tempPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN406"><span class='Ref_to_Parameter'>oldPage</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN406"><span class='Ref_to_Parameter'>tempPage</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN408"><span class='Ref_To_Local'>pageSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN406"><span class='Ref_to_Parameter'>tempPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * sorting support for PageRepairFragmentation and PageIndexMultiDelete 
 */ 
</span><a name="LN419"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>itemIdSortData</span> 
<span class='Delimiter'>{ 
</span><a name="LN421"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>offsetindex</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* linp array index */ 
</span><a name="LN422"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>itemoff</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* page offset of item data */ 
</span><a name="LN423"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>alignedlen</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* MAXALIGN(item data len) */ 
</span><a name="LN424"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>itemIdSortData</span><span class='Delimiter'>; 
</span><a name="LN425"></a><span class='Control'>typedef</span> <a href="bufpage.c.html#LN419"><span class='Ref_to_Struct'>itemIdSortData</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>itemIdSort</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static int 
</span><a name="LN428"></a><span class='Declare_Function'>itemoffcompare</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>itemidp1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>itemidp2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Sort in decreasing itemoff order */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>((</span><a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN428"><span class='Ref_to_Parameter'>itemidp2</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>itemoff <span class='Operator'>- 
</span>        <span class='Parentheses'>((</span><a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN428"><span class='Ref_to_Parameter'>itemidp1</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>itemoff<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * After removing or marking some line pointers unused, move the tuples to 
 * remove the gaps caused by the removed items. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN440"></a><span class='Declare_Function'>compactify_tuples</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a> <span class='Declare_Parameter'>itemidbase</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, </span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN442"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN443"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>upper</span><span class='Delimiter'>; 
</span><a name="LN444"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sort itemIdSortData array into decreasing itemoff order */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>itemidbase</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN419"><span class='Ref_to_Struct'>itemIdSortData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="bufpage.c.html#LN427"><span class='Ref_to_Func'>itemoffcompare</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN443"><span class='Ref_To_Local'>upper</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN442"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN444"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN444"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN444"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN453"></a>        <a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a>  <span class='Declare_Local'>itemidptr</span> <span class='Operator'>= &</span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>itemidbase</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN444"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span><a name="LN454"></a>        <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span> 
        <a href="bufpage.c.html#LN454"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN453"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN421"><span class='Ref_to_Member'>offsetindex</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="bufpage.c.html#LN443"><span class='Ref_To_Local'>upper</span></a> <span class='Operator'>-= </span><a href="bufpage.c.html#LN453"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN443"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN440"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN453"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a><span class='Delimiter'>, 
</span>                <a href="bufpage.c.html#LN453"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="bufpage.c.html#LN454"><span class='Ref_To_Local'>lp</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/itemid.h.html#LN25"><span class='Ref_to_Member'>lp_off</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN443"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="bufpage.c.html#LN442"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN443"><span class='Ref_To_Local'>upper</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end compactify_tuples &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PageRepairFragmentation 
 * 
 * Frees fragmented space on a page. 
 * It doesn't remove unused line pointers! Please don't change this. 
 * 
 * This routine is usable for heap pages only, but see PageIndexMultiDelete. 
 * 
 * As a side effect, the page's PD_HAS_FREE_LINES hint bit is updated. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN478"></a><span class='Declare_Function'>PageRepairFragmentation</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN480"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_lower</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower<span class='Delimiter'>; 
</span><a name="LN481"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_upper</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper<span class='Delimiter'>; 
</span><a name="LN482"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_special</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_special<span class='Delimiter'>; 
</span><a name="LN483"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN484"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nline</span><span class='Delimiter'>, 
</span><a name="LN485"></a>                <span class='Declare_Local'>nstorage</span><span class='Delimiter'>, 
</span><a name="LN486"></a>                <span class='Declare_Local'>nunused</span><span class='Delimiter'>; 
</span><a name="LN487"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN488"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>totallen</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's worth the trouble to be more paranoid here than in most places, 
     * because we are about to reshuffle data in (what is usually) a shared 
     * disk buffer.  If we aren't careful then corrupted pointers, lengths, 
     * etc could cause us to clobber adjacent disk buffers, spreading the data 
     * loss further.  So, check everything. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN480"><span class='Ref_To_Local'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN480"><span class='Ref_To_Local'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN481"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN481"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN480"><span class='Ref_To_Local'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN481"><span class='Ref_To_Local'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN484"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN486"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN485"><span class='Ref_To_Local'>nstorage</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN484"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
                <a href="bufpage.c.html#LN485"><span class='Ref_To_Local'>nstorage</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Unused entries should have lp_len = 0, but make sure */ 
</span>            <a href="../../../include/storage/itemid.h.html#LN126"><span class='Ref_to_Macro'>ItemIdSetUnused</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN486"><span class='Ref_To_Local'>nunused</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN485"><span class='Ref_To_Local'>nstorage</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Page is completely empty, so just reset it quickly */ 
</span>        <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper <span class='Operator'>= </span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need to compact the page the hard way */ 
</span><a name="LN533"></a>        <a href="bufpage.c.html#LN419"><span class='Ref_to_Struct'>itemIdSortData</span></a> <span class='Declare_Local'>itemidbase</span><span class='Delimiter'>[</span><a href="../../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN534"></a>        <a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a>  <span class='Declare_Local'>itemidptr</span> <span class='Operator'>= </span><a href="bufpage.c.html#LN533"><span class='Ref_To_Local'>itemidbase</span></a><span class='Delimiter'>; 
</span> 
        <a href="bufpage.c.html#LN488"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN484"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN421"><span class='Ref_to_Member'>offsetindex</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN487"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>                <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN481"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>|| 
</span>                    <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a><span class='Parentheses'>)</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item pointer: %u"</span><span class='Delimiter'>, 
</span>                                    <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN483"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="bufpage.c.html#LN488"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a><span class='Delimiter'>; 
</span>                <a href="bufpage.c.html#LN534"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN488"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) (</span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN480"><span class='Ref_To_Local'>pd_lower</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item lengths: total %u, available space %u"</span><span class='Delimiter'>, 
</span>                      <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN488"><span class='Ref_To_Local'>totallen</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN482"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN480"><span class='Ref_To_Local'>pd_lower</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="bufpage.c.html#LN439"><span class='Ref_to_Func'>compactify_tuples</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN533"><span class='Ref_To_Local'>itemidbase</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN485"><span class='Ref_To_Local'>nstorage</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Set hint bit for PageAddItem */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN486"><span class='Ref_To_Local'>nunused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/bufpage.h.html#LN369"><span class='Ref_to_Macro'>PageSetHasFreeLinePointers</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/storage/bufpage.h.html#LN371"><span class='Ref_to_Macro'>PageClearHasFreeLinePointers</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN478"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageRepairFragmentation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PageGetFreeSpace 
 *      Returns the size of the free (allocatable) space on a page, 
 *      reduced by the space needed for a new line pointer. 
 * 
 * Note: this should usually only be used on index pages.  Use 
 * PageGetHeapFreeSpace on heap pages. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN581"></a><span class='Declare_Function'>PageGetFreeSpace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN583"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>space</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use signed arithmetic here so that we behave sensibly if pd_lower &GT; 
     * pd_upper. 
     */ 
</span>    <a href="bufpage.c.html#LN583"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN581"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper <span class='Operator'>- 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN581"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN583"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN583"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>-= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN583"><span class='Ref_To_Local'>space</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageGetFreeSpaceForMultipleTuples 
 *      Returns the size of the free (allocatable) space on a page, 
 *      reduced by the space needed for multiple new line pointers. 
 * 
 * Note: this should usually only be used on index pages.  Use 
 * PageGetHeapFreeSpace on heap pages. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN608"></a><span class='Declare_Function'>PageGetFreeSpaceForMultipleTuples</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntups</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN610"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>space</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use signed arithmetic here so that we behave sensibly if pd_lower &GT; 
     * pd_upper. 
     */ 
</span>    <a href="bufpage.c.html#LN610"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN608"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper <span class='Operator'>- 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN608"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN610"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN608"><span class='Ref_to_Parameter'>ntups</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)))</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN610"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>-= </span><a href="bufpage.c.html#LN608"><span class='Ref_to_Parameter'>ntups</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN610"><span class='Ref_To_Local'>space</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PageGetExactFreeSpace 
 *      Returns the size of the free (allocatable) space on a page, 
 *      without any consideration for adding/removing line pointers. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN632"></a><span class='Declare_Function'>PageGetExactFreeSpace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN634"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>space</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use signed arithmetic here so that we behave sensibly if pd_lower &GT; 
     * pd_upper. 
     */ 
</span>    <a href="bufpage.c.html#LN634"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN632"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_upper <span class='Operator'>- 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN632"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_lower<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN634"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN634"><span class='Ref_To_Local'>space</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * PageGetHeapFreeSpace 
 *      Returns the size of the free (allocatable) space on a page, 
 *      reduced by the space needed for a new line pointer. 
 * 
 * The difference between this and PageGetFreeSpace is that this will return 
 * zero if there are already MaxHeapTuplesPerPage line pointers in the page 
 * and none are free.  We use this to enforce that no more than 
 * MaxHeapTuplesPerPage line pointers are created on a heap page.  (Although 
 * no more tuples than that could fit anyway, in the presence of redirected 
 * or dead line pointers it'd be possible to have too many line pointers. 
 * To avoid breaking code that assumes MaxHeapTuplesPerPage is a hard limit 
 * on the number of line pointers, we make this extra check.) 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN665"></a><span class='Declare_Function'>PageGetHeapFreeSpace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN667"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>space</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN667"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN426"><span class='Ref_to_Proto'>PageGetFreeSpace</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN665"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN667"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN672"></a>        <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>, 
</span><a name="LN673"></a>                    <span class='Declare_Local'>nline</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Are there already MaxHeapTuplesPerPage line pointers in the page? 
         */ 
</span>        <a href="bufpage.c.html#LN673"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN665"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN673"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/htup_details.h.html#LN574"><span class='Ref_to_Const'>MaxHeapTuplesPerPage</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN367"><span class='Ref_to_Macro'>PageHasFreeLinePointers</span></a><span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN665"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Since this is just a hint, we must confirm that there is 
                 * indeed a free line pointer 
                 */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN673"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span><a name="LN689"></a>                    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN665"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/itemid.h.html#LN90"><span class='Ref_to_Macro'>ItemIdIsUsed</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN689"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span> 
                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN672"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN673"><span class='Ref_To_Local'>nline</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * The hint is wrong, but we can't clear it here since we 
                     * don't have the ability to mark the page dirty. 
                     */ 
</span>                    <a href="bufpage.c.html#LN667"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PageHasFreeLinePointe... &raquo; </span> 
            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Although the hint might be wrong, PageAddItem will believe 
                 * it anyway, so we must believe it too. 
                 */ 
</span>                <a href="bufpage.c.html#LN667"><span class='Ref_To_Local'>space</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nline&GT;=MaxHeapTuplesP... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if space&GT;0 &raquo; </span> 
    <span class='Control'>return</span> <a href="bufpage.c.html#LN667"><span class='Ref_To_Local'>space</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageGetHeapFreeSpace &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageIndexTupleDelete 
 * 
 * This routine does the work of removing a tuple from an index page. 
 * 
 * Unlike heap pages, we compact out the line pointer for the removed tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN726"></a><span class='Declare_Function'>PageIndexTupleDelete</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN728"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN729"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>addr</span><span class='Delimiter'>; 
</span><a name="LN730"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN731"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN732"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN733"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN734"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>offidx</span><span class='Delimiter'>; 
</span><a name="LN735"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nline</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As with PageRepairFragmentation, paranoia seems justified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN735"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN735"><span class='Ref_To_Local'>nline</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid index offnum: %u"</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* change offset number to offset index */ 
</span>    <a href="bufpage.c.html#LN734"><span class='Ref_To_Local'>offidx</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN730"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN730"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN730"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN730"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item pointer: offset = %u, size = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Amount of space to actually be deleted */ 
</span>    <a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, we want to get rid of the pd_linp entry for the index tuple. We 
     * copy all subsequent linp's back one slot in the array. We don't use 
     * PageGetItemId, because we are manipulating the _array_, not individual 
     * linp's. 
     */ 
</span>    <a href="bufpage.c.html#LN733"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>- 
</span>        <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN158"><span class='Ref_to_Member'>pd_linp</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN734"><span class='Ref_To_Local'>offidx</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN733"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN158"><span class='Ref_to_Member'>pd_linp</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN734"><span class='Ref_To_Local'>offidx</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN158"><span class='Ref_to_Member'>pd_linp</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN734"><span class='Ref_To_Local'>offidx</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="bufpage.c.html#LN733"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now move everything between the old upper bound (beginning of tuple 
     * space) and the beginning of the deleted tuple forward, so that space in 
     * the middle of the page is left free.  If we've just deleted the tuple 
     * at the beginning of tuple space, then there's no need to do the copy. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* beginning of tuple space */ 
</span>    <a href="bufpage.c.html#LN729"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN729"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN729"><span class='Ref_To_Local'>addr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* adjust free space boundary pointers */ 
</span>    <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>-= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Finally, we need to adjust the linp entries that remain. 
     * 
     * Anything that used to be before the deleted tuple's data was moved 
     * forward by the size of the deleted tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN726"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN811"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="bufpage.c.html#LN735"><span class='Ref_To_Local'>nline</span></a><span class='Operator'>--</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* there's one less than when we started */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN811"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN811"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN735"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN811"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN816"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>ii</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN728"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN811"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN816"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN816"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN732"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span> 
                <a href="bufpage.c.html#LN816"><span class='Ref_To_Local'>ii</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/itemid.h.html#LN25"><span class='Ref_to_Member'>lp_off</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN731"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PageIndexTupleDelete &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageIndexMultiDelete 
 * 
 * This routine handles the case of deleting multiple tuples from an 
 * index page at once.  It is considerably faster than a loop around 
 * PageIndexTupleDelete ... however, the caller *must* supply the array 
 * of item numbers to be deleted in item number order! 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN835"></a><span class='Declare_Function'>PageIndexMultiDelete</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>itemnos</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN837"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN838"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_lower</span> <span class='Operator'>= </span><a href="bufpage.c.html#LN837"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>; 
</span><a name="LN839"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_upper</span> <span class='Operator'>= </span><a href="bufpage.c.html#LN837"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>; 
</span><a name="LN840"></a>    <a href="../../../include/c.h.html#LN374"><span class='Ref_to_Typedef'>Offset</span></a>      <span class='Declare_Local'>pd_special</span> <span class='Operator'>= </span><a href="bufpage.c.html#LN837"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Delimiter'>; 
</span><a name="LN841"></a>    <a href="bufpage.c.html#LN419"><span class='Ref_to_Struct'>itemIdSortData</span></a> <span class='Declare_Local'>itemidbase</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN842"></a>    <a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a>  <span class='Declare_Local'>newitemids</span><span class='Delimiter'>[</span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Delimiter'>]; 
</span><a name="LN843"></a>    <a href="bufpage.c.html#LN425"><span class='Ref_to_Typedef'>itemIdSort</span></a>  <span class='Declare_Local'>itemidptr</span><span class='Delimiter'>; 
</span><a name="LN844"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>lp</span><span class='Delimiter'>; 
</span><a name="LN845"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nline</span><span class='Delimiter'>, 
</span><a name="LN846"></a>                <span class='Declare_Local'>nused</span><span class='Delimiter'>; 
</span><a name="LN847"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>totallen</span><span class='Delimiter'>; 
</span><a name="LN848"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN849"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN850"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nextitm</span><span class='Delimiter'>; 
</span><a name="LN851"></a>    <a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Local'>offnum</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/access/itup.h.html#LN136"><span class='Ref_to_Const'>MaxIndexTuplesPerPage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there aren't very many items to delete, then retail 
     * PageIndexTupleDelete is the best way.  Delete the items in reverse 
     * order so we don't have to think about adjusting item numbers for 
     * previous deletions. 
     * 
     * TODO: tune the magic number here 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&LT;= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/bufpage.h.html#LN430"><span class='Ref_to_Proto'>PageIndexTupleDelete</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As with PageRepairFragmentation, paranoia seems justified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN838"><span class='Ref_To_Local'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN838"><span class='Ref_To_Local'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN839"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN839"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN838"><span class='Ref_To_Local'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN839"><span class='Ref_To_Local'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the item pointer array and build a list of just the ones we are 
     * going to keep.  Notice we do not modify the page yet, since we are 
     * still validity-checking. 
     */ 
</span>    <a href="bufpage.c.html#LN845"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN841"><span class='Ref_To_Local'>itemidbase</span></a><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN847"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN850"><span class='Ref_To_Local'>nextitm</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN845"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN52"><span class='Ref_to_Macro'>OffsetNumberNext</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="bufpage.c.html#LN844"><span class='Ref_To_Local'>lp</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN844"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="bufpage.c.html#LN848"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN844"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN844"><span class='Ref_To_Local'>lp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN839"><span class='Ref_To_Local'>pd_upper</span></a> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN848"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>|| 
</span>            <a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item pointer: offset = %u, length = %u"</span><span class='Delimiter'>, 
</span>                          <a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN848"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN850"><span class='Ref_To_Local'>nextitm</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>&& </span><a href="bufpage.c.html#LN851"><span class='Ref_To_Local'>offnum</span></a> <span class='Operator'>== </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>itemnos</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN850"><span class='Ref_To_Local'>nextitm</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* skip item to be deleted */ 
</span>            <a href="bufpage.c.html#LN850"><span class='Ref_To_Local'>nextitm</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN421"><span class='Ref_to_Member'>offsetindex</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* where it will go */ 
</span>            <a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN422"><span class='Ref_to_Member'>itemoff</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN849"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN848"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN847"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>-&GT;</span><a href="bufpage.c.html#LN423"><span class='Ref_to_Member'>alignedlen</span></a><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN842"><span class='Ref_To_Local'>newitemids</span></a><span class='Delimiter'>[</span><a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="bufpage.c.html#LN844"><span class='Ref_To_Local'>lp</span></a><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN843"><span class='Ref_To_Local'>itemidptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for offnum=FirstOffsetNum... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* this will catch invalid or out-of-order itemnos[] */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN850"><span class='Ref_To_Local'>nextitm</span></a> <span class='Operator'>!= </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"incorrect index offsets supplied"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN847"><span class='Ref_To_Local'>totallen</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) (</span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN838"><span class='Ref_To_Local'>pd_lower</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item lengths: total %u, available space %u"</span><span class='Delimiter'>, 
</span>                      <span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN847"><span class='Ref_To_Local'>totallen</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN840"><span class='Ref_To_Local'>pd_special</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN838"><span class='Ref_To_Local'>pd_lower</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Looks good. Overwrite the line pointers with the copy, from which we've 
     * removed all the unused items. 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="bufpage.c.html#LN837"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN158"><span class='Ref_to_Member'>pd_linp</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN842"><span class='Ref_To_Local'>newitemids</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN837"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and compactify the tuple data */ 
</span>    <a href="bufpage.c.html#LN439"><span class='Ref_to_Func'>compactify_tuples</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN841"><span class='Ref_To_Local'>itemidbase</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN846"><span class='Ref_To_Local'>nused</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN835"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageIndexMultiDelete &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageIndexTupleDeleteNoCompact 
 * 
 * Remove the specified tuple from an index page, but set its line pointer 
 * to "unused" instead of compacting it out, except that it can be removed 
 * if it's the last line pointer on the page. 
 * 
 * This is used for index AMs that require that existing TIDs of live tuples 
 * remain unchanged, and are willing to allow unused line pointers instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN957"></a><span class='Declare_Function'>PageIndexTupleDeleteNoCompact</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN959"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN960"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>addr</span><span class='Delimiter'>; 
</span><a name="LN961"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN962"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN963"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN964"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nline</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As with PageRepairFragmentation, paranoia seems justified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN964"><span class='Ref_To_Local'>nline</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN964"><span class='Ref_To_Local'>nline</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid index offnum: %u"</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN961"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN961"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN961"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN961"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item pointer: offset = %u, size = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Amount of space to actually be deleted */ 
</span>    <a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Either set the item pointer to "unused", or zap it if it's the last 
     * one.  (Note: it's possible that the next-to-last one(s) are already 
     * unused, but we do not trouble to try to compact them out if so.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN964"><span class='Ref_To_Local'>nline</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/storage/itemid.h.html#LN126"><span class='Ref_to_Macro'>ItemIdSetUnused</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN961"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>-= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN23"><span class='Ref_to_Struct'>ItemIdData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="bufpage.c.html#LN964"><span class='Ref_To_Local'>nline</span></a><span class='Operator'>--</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* there's one less than when we started */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now move everything between the old upper bound (beginning of tuple 
     * space) and the beginning of the deleted tuple forward, so that space in 
     * the middle of the page is left free.  If we've just deleted the tuple 
     * at the beginning of tuple space, then there's no need to do the copy. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* beginning of tuple space */ 
</span>    <a href="bufpage.c.html#LN960"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN960"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN960"><span class='Ref_To_Local'>addr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* adjust free space boundary pointer */ 
</span>    <a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Finally, we need to adjust the linp entries that remain. 
     * 
     * Anything that used to be before the deleted tuple's data was moved 
     * forward by the size of the deleted tuple. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/bufpage.h.html#LN218"><span class='Ref_to_Macro'>PageIsEmpty</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN957"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1035"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1035"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="bufpage.c.html#LN1035"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN964"><span class='Ref_To_Local'>nline</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN1035"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1039"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>ii</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN959"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1035"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1039"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1039"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN963"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span> 
                <a href="bufpage.c.html#LN1039"><span class='Ref_To_Local'>ii</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/itemid.h.html#LN25"><span class='Ref_to_Member'>lp_off</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN962"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PageIndexTupleDeleteNoCompact &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * PageIndexTupleOverwrite 
 * 
 * Replace a specified tuple on an index page. 
 * 
 * The new tuple is placed exactly where the old one had been, shifting 
 * other tuples' data up or down as needed to keep the page compacted. 
 * This is better than deleting and reinserting the tuple, because it 
 * avoids any data shifting when the tuple size doesn't change; and 
 * even when it does, we avoid moving the item pointers around. 
 * Conceivably this could also be of use to an index AM that cares about 
 * the physical order of tuples as well as their ItemId order. 
 * 
 * If there's insufficient space for the new tuple, return false.  Other 
 * errors represent data-corruption problems, so we just elog. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1065"></a><span class='Declare_Function'>PageIndexTupleOverwrite</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/off.h.html#LN23"><span class='Ref_to_Typedef'>OffsetNumber</span></a> <span class='Declare_Parameter'>offnum</span><span class='Delimiter'>, 
</span><a name="LN1066"></a>                        <a href="../../../include/storage/item.h.html#LN16"><span class='Ref_to_Typedef'>Item</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>newsize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1068"></a>    <a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a>  <span class='Declare_Local'>phdr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span><a name="LN1069"></a>    <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>tupid</span><span class='Delimiter'>; 
</span><a name="LN1070"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>oldsize</span><span class='Delimiter'>; 
</span><a name="LN1071"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>alignednewsize</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size_diff</span><span class='Delimiter'>; 
</span><a name="LN1074"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>itemcount</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * As with PageRepairFragmentation, paranoia seems justified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/bufpage.h.html#LN212"><span class='Ref_to_Const'>SizeOfPageHeaderData</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>&GT; </span>BLCKSZ <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted page pointers: lower = %u, upper = %u, special = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN1074"><span class='Ref_To_Local'>itemcount</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN353"><span class='Ref_to_Macro'>PageGetMaxOffsetNumber</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>offnum</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN1074"><span class='Ref_To_Local'>itemcount</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid index offnum: %u"</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>offnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN57"><span class='Ref_to_Macro'>ItemIdGetLength</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&LT; </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN155"><span class='Ref_to_Member'>pd_special</span></a> <span class='Operator'>|| 
</span>        <a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"corrupted item pointer: offset = %u, size = %u"</span><span class='Delimiter'>, 
</span>                        <a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine actual change in space requirement, check for page overflow. 
     */ 
</span>    <a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="bufpage.c.html#LN1072"><span class='Ref_To_Local'>alignednewsize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1066"><span class='Ref_to_Parameter'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1072"><span class='Ref_To_Local'>alignednewsize</span></a> <span class='Operator'>&GT; </span><a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN153"><span class='Ref_to_Member'>pd_lower</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Relocate existing data and update line pointers, unless the new tuple 
     * is the same size as the old (after alignment), in which case there's 
     * nothing to do.  Notice that what we have to relocate is data before the 
     * target tuple, not data after, so it's convenient to express size_diff 
     * as the amount by which the tuple's size is decreasing, making it the 
     * delta to add to pd_upper and affected line pointers. 
     */ 
</span>    <a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a> <span class='Operator'>= </span><a href="bufpage.c.html#LN1070"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1072"><span class='Ref_To_Local'>alignednewsize</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1124"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>addr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>page</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Delimiter'>; 
</span><a name="LN1125"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* relocate all tuple data before the target tuple */ 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1124"><span class='Ref_To_Local'>addr</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1124"><span class='Ref_To_Local'>addr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>- </span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* adjust free space boundary pointer */ 
</span>        <a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/bufpage.h.html#LN154"><span class='Ref_to_Member'>pd_upper</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* adjust affected line pointers too */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1125"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="../../../include/storage/off.h.html#LN26"><span class='Ref_to_Const'>FirstOffsetNumber</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN1125"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN1074"><span class='Ref_To_Local'>itemcount</span></a><span class='Delimiter'>; </span><a href="bufpage.c.html#LN1125"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1136"></a>            <a href="../../../include/storage/itemid.h.html#LN30"><span class='Ref_to_Typedef'>ItemId</span></a>      <span class='Declare_Local'>ii</span> <span class='Operator'>= </span><a href="../../../include/storage/bufpage.h.html#LN231"><span class='Ref_to_Macro'>PageGetItemId</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1068"><span class='Ref_To_Local'>phdr</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1125"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Allow items without storage; currently only BRIN needs that */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/itemid.h.html#LN118"><span class='Ref_to_Macro'>ItemIdHasStorage</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1136"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><a href="../../../include/storage/itemid.h.html#LN63"><span class='Ref_to_Macro'>ItemIdGetOffset</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1136"><span class='Ref_To_Local'>ii</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>)</span> 
                <a href="bufpage.c.html#LN1136"><span class='Ref_To_Local'>ii</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/itemid.h.html#LN25"><span class='Ref_to_Member'>lp_off</span></a> <span class='Operator'>+= </span><a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if size_diff!=0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Update the item's tuple length (other fields shouldn't change) */ 
</span>    <a href="../../../include/storage/itemid.h.html#LN138"><span class='Ref_to_Macro'>ItemIdSetNormal</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1071"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>+ </span><a href="bufpage.c.html#LN1073"><span class='Ref_To_Local'>size_diff</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1066"><span class='Ref_to_Parameter'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy new tuple data onto page */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN336"><span class='Ref_to_Macro'>PageGetItem</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1065"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1069"><span class='Ref_To_Local'>tupid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1066"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1066"><span class='Ref_to_Parameter'>newsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageIndexTupleOverwrite &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Set checksum for a page in shared buffers. 
 * 
 * If checksums are disabled, or if the page is not initialized, just return 
 * the input.  Otherwise, we must make a copy of the page before calculating 
 * the checksum, to prevent concurrent modifications (e.g. setting hint bits) 
 * from making the final checksum invalid.  It doesn't matter if we include or 
 * exclude hints during the copy, as long as we write a valid page and 
 * associated checksum. 
 * 
 * Returns a pointer to the block-sized data that needs to be written. Uses 
 * statically-allocated memory, so the caller must immediately write the 
 * returned page and not refer to it again. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1169"></a><span class='Declare_Function'>PageSetChecksumCopy</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1171"></a>    <span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Local'>pageCopy</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we don't need a checksum, just return the passed-in data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1169"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span><a href="../../../include/access/xlog.h.html#LN259"><span class='Ref_to_Proto'>DataChecksumsEnabled</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1169"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We allocate the copy space once and use it over on each subsequent 
     * call.  The point of palloc'ing here, rather than having a static char 
     * array, is first to ensure adequate alignment for the checksumming code 
     * and second to avoid wasting space in processes that never call this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1169"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_checksum <span class='Operator'>= </span><a href="../../../include/storage/checksum.h.html#LN21"><span class='Ref_to_Proto'>pg_checksum_page</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1169"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="bufpage.c.html#LN1171"><span class='Ref_To_Local'>pageCopy</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PageSetChecksumCopy &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set checksum for a page in private memory. 
 * 
 * This must only be used when we know that no other process can be modifying 
 * the page buffer. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1198"></a><span class='Declare_Function'>PageSetChecksumInplace</span><span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN73"><span class='Ref_to_Typedef'>Page</span></a> <span class='Declare_Parameter'>page</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* If we don't need a checksum, just return */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/bufpage.h.html#LN225"><span class='Ref_to_Macro'>PageIsNew</span></a><span class='Parentheses'>(</span><a href="bufpage.c.html#LN1198"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>) </span><span class='Operator'>|| !</span><a href="../../../include/access/xlog.h.html#LN259"><span class='Ref_to_Proto'>DataChecksumsEnabled</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>((</span><a href="../../../include/storage/bufpage.h.html#LN161"><span class='Ref_to_Typedef'>PageHeader</span></a><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1198"><span class='Ref_to_Parameter'>page</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>pd_checksum <span class='Operator'>= </span><a href="../../../include/storage/checksum.h.html#LN21"><span class='Ref_to_Proto'>pg_checksum_page</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="bufpage.c.html#LN1198"><span class='Ref_to_Parameter'>page</span></a><span class='Delimiter'>, </span><a href="bufpage.c.html#LN1198"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>