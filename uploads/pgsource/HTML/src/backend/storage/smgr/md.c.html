<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\storage\smgr\md.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\storage\smgr\md.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:49 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * md.c 
 *    This code manages relations that reside on magnetic disk. 
 * 
 * Or at least, that was what the Berkeley folk had in mind when they named 
 * this file.  In reality, what this code provides is an interface from 
 * the smgr API to Unix-like filesystem APIs, so it will work with any type 
 * of device for which the operating system provides filesystem support. 
 * It doesn't matter whether the bits are on spinning rust or some other 
 * storage technology. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/storage/smgr/md.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/file.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"portability/instr_time.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/bgwriter.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/relfilenode.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pg_trace.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* intervals for calling AbsorbFsyncRequests in mdsync and mdpostckpt */ 
</span><a name="LN43"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FSYNCS_PER_ABSORB</span>       <span class='Number'>10</span> 
<a name="LN44"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>UNLINKS_PER_ABSORB</span>      <span class='Number'>10</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Special values for the segno arg to RememberFsyncRequest. 
 * 
 * Note that CompactCheckpointerRequestQueue assumes that it's OK to remove an 
 * fsync request from the queue if an identical, subsequent request is found. 
 * See comments there before making changes here. 
 */ 
</span><a name="LN53"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FORGET_RELATION_FSYNC</span>   <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span><a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FORGET_DATABASE_FSYNC</span>   <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>) 
</span><a name="LN55"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>UNLINK_RELATION_REQUEST</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Operator'>-</span><span class='Number'>2</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * On Windows, we have to interpret EACCES as possibly meaning the same as 
 * ENOENT, because if a file is unlinked-but-not-yet-gone on that platform, 
 * that's what you get.  Ugh.  This code is designed so that we don't 
 * actually believe these cases are okay without further evidence (namely, 
 * a pending fsync request getting canceled ... see mdsync). 
 */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN65"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FILE_POSSIBLY_DELETED</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>err</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><a href="md.c.html#LN65"><span class='Ref_to_Parameter'>err</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>ENOENT<span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
<a name="LN67"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FILE_POSSIBLY_DELETED</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>err</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><a href="md.c.html#LN67"><span class='Ref_to_Parameter'>err</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>ENOENT <span class='Operator'>|| </span><span class='Parentheses'>(</span><a href="md.c.html#LN67"><span class='Ref_to_Parameter'>err</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span>EACCES<span class='Parentheses'>)</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  The magnetic disk storage manager keeps track of open file 
 *  descriptors in its own descriptor pool.  This is done to make it 
 *  easier to support relations that are larger than the operating 
 *  system's file size limit (often 2GBytes).  In order to do that, 
 *  we break relations up into "segment" files that are each shorter than 
 *  the OS file size limit.  The segment size is set by the RELSEG_SIZE 
 *  configuration constant in pg_config.h. 
 * 
 *  On disk, a relation must consist of consecutively numbered segment 
 *  files in the pattern 
 *      -- Zero or more full segments of exactly RELSEG_SIZE blocks each 
 *      -- Exactly one partial segment of size 0 &LT;= size &LT; RELSEG_SIZE blocks 
 *      -- Optionally, any number of inactive segments of size 0 blocks. 
 *  The full and partial segments are collectively the "active" segments. 
 *  Inactive segments are those that once contained data but are currently 
 *  not needed because of an mdtruncate() operation.  The reason for leaving 
 *  them present at size zero, rather than unlinking them, is that other 
 *  backends and/or the checkpointer might be holding open file references to 
 *  such segments.  If the relation expands again after mdtruncate(), such 
 *  that a deactivated segment becomes active again, it is important that 
 *  such file references still be valid --- else data might get written 
 *  out to an unlinked old copy of a segment file that will eventually 
 *  disappear. 
 * 
 *  File descriptors are stored in the per-fork md_seg_fds arrays inside 
 *  SMgrRelation. The length of these arrays is stored in md_num_open_segs. 
 *  Note that a fork's md_num_open_segs having a specific value does not 
 *  necessarily mean the relation doesn't have additional segments; we may 
 *  just not have opened the next segment yet.  (We could not have "all 
 *  segments are in the array" as an invariant anyway, since another backend 
 *  could extend the relation while we aren't looking.)  We do not have 
 *  entries for inactive segments, however; as soon as we find a partial 
 *  segment, we assume that any subsequent segments are inactive. 
 * 
 *  The entire MdfdVec array is palloc'd in the MdCxt memory context. 
 */ 
</span> 
<a name="LN108"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>_MdfdVec</span> 
<span class='Delimiter'>{ 
</span><a name="LN110"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Member'>mdfd_vfd</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* fd number in fd.c's pool */ 
</span><a name="LN111"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Member'>mdfd_segno</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* segment number, from 0 */ 
</span><a name="LN112"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>MdfdVec</span><span class='Delimiter'>; 
</span> 
<a name="LN114"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>MdCxt</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* context for all MdfdVec objects */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * In some contexts (currently, standalone backends and the checkpointer) 
 * we keep track of pending fsync operations: we need to remember all relation 
 * segments that have been written since the last checkpoint, so that we can 
 * fsync them down to disk before completing the next checkpoint.  This hash 
 * table remembers the pending operations.  We use a hash table mostly as 
 * a convenient way of merging duplicate requests. 
 * 
 * We use a similar mechanism to remember no-longer-needed files that can 
 * be deleted after the next checkpoint, but we use a linked list instead of 
 * a hash table, because we don't expect there to be any duplicate requests. 
 * 
 * These mechanisms are only used for non-temp relations; we never fsync 
 * temp rels, nor do we need to postpone their deletion (see comments in 
 * mdunlink). 
 * 
 * (Regular backends do not track pending operations locally, but forward 
 * them to the checkpointer.) 
 */ 
</span><a name="LN136"></a><span class='Control'>typedef</span> <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Typedef'>CycleCtr</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* can be any convenient integer size */ 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN140"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Member'>rnode</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* hash table key (must be first!) */ 
</span><a name="LN141"></a>    <a href="md.c.html#LN136"><span class='Ref_to_Typedef'>CycleCtr</span></a>    <span class='Declare_Member'>cycle_ctr</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* mdsync_cycle_ctr of oldest request */ 
</span>    <span class='Comment_Multi_Line'>/* requests[f] has bit n set if we need to fsync segment n of fork f */ 
</span><a name="LN143"></a>    <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Member'>requests</span><span class='Delimiter'>[</span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* canceled[f] is true if we canceled fsyncs for fork "recently" */ 
</span><a name="LN145"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>canceled</span><span class='Delimiter'>[</span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span><a name="LN146"></a>} <span class='Declare_Typedef'>PendingOperationEntry</span><span class='Delimiter'>; 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN150"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Member'>rnode</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* the dead relation to delete */ 
</span><a name="LN151"></a>    <a href="md.c.html#LN136"><span class='Ref_to_Typedef'>CycleCtr</span></a>    <span class='Declare_Member'>cycle_ctr</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* mdckpt_cycle_ctr when request was made */ 
</span><a name="LN152"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>PendingUnlinkEntry</span><span class='Delimiter'>; 
</span> 
<a name="LN154"></a><span class='Keyword'>static </span><a href="../../utils/hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pendingOpsTable</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN155"></a><span class='Keyword'>static </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>pendingUnlinks</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span><a name="LN156"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>pendingOpsCxt</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* context for the above  */ 
</span> 
<a name="LN158"></a><span class='Keyword'>static </span><a href="md.c.html#LN136"><span class='Ref_to_Typedef'>CycleCtr</span></a> <span class='Declare_Var'>mdsync_cycle_ctr</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN159"></a><span class='Keyword'>static </span><a href="md.c.html#LN136"><span class='Ref_to_Typedef'>CycleCtr</span></a> <span class='Declare_Var'>mdckpt_cycle_ctr</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/*** behavior for mdopen & _mdfd_getseg ***/ 
/* ereport if segment not present */ 
</span><a name="LN164"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EXTENSION_FAIL</span>              <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* return NULL if segment not present */ 
</span><a name="LN166"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EXTENSION_RETURN_NULL</span>       <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* create new segments as needed */ 
</span><a name="LN168"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EXTENSION_CREATE</span>            <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>2</span><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* create new segments if needed during recovery */ 
</span><a name="LN170"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EXTENSION_CREATE_RECOVERY</span>   <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * Allow opening segments which are preceded by segments smaller than 
 * RELSEG_SIZE, e.g. inactive segments (see above). Note that this is breaks 
 * mdnblocks() and related functionality henceforth - which currently is ok, 
 * because this is only required in the checkpointer which never uses 
 * mdnblocks(). 
 */ 
</span><a name="LN178"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EXTENSION_DONT_CHECK_SIZE</span>   <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>4</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* local routines */ 
</span><a name="LN182"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>mdunlinkfork</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, 
</span><a name="LN183"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>isRedo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN184"></a><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>mdopen</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>behavior</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN185"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>register_dirty_segment</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN186"></a>                       <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN187"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>register_unlink</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN188"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>_fdvec_resize</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, 
</span><a name="LN189"></a>              <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN190"></a>              <span class='Keyword'>int </span><span class='Declare_Parameter'>nseg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN191"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>_mdfd_segpath</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN192"></a>              <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>segno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN193"></a><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>_mdfd_openseg</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkno</span><span class='Delimiter'>, 
</span><a name="LN194"></a>              <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>segno</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>oflags</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN195"></a><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>_mdfd_getseg</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkno</span><span class='Delimiter'>, 
</span><a name="LN196"></a>             <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>skipFsync</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>behavior</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN197"></a><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Prototype'>_mdnblocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN198"></a>           <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdinit() -- Initialize private state for magnetic disk storage manager. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN205"></a><span class='Declare_Function'>mdinit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="md.c.html#LN114"><span class='Ref_to_Global_Var'>MdCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../../utils/mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                  <span class='String'>"MdSmgr"</span><span class='Delimiter'>, 
</span>                                  <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create pending-operations hashtable if we need it.  Currently, we need 
     * it if we are standalone (not under a postmaster) or if we are a startup 
     * or checkpointer auxiliary process. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>|| </span><a href="../../../include/miscadmin.h.html#LN407"><span class='Ref_to_Macro'>AmStartupProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="../../../include/miscadmin.h.html#LN409"><span class='Ref_to_Macro'>AmCheckpointerProcess</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span><a name="LN218"></a>        <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>hash_ctl</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * XXX: The checkpointer needs to add entries to the pending ops table 
         * when absorbing fsync requests.  That is done within a critical 
         * section, which isn't usually allowed, but we make an exception. It 
         * means that there's a theoretical possibility that you run out of 
         * memory while absorbing fsync requests, which leads to a PANIC. 
         * Fortunately the hash table is small so that's unlikely to happen in 
         * practice. 
         */ 
</span>        <a href="md.c.html#LN156"><span class='Ref_to_Global_Var'>pendingOpsCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN114"><span class='Ref_to_Global_Var'>MdCxt</span></a><span class='Delimiter'>, 
</span>                                              <span class='String'>"Pending ops context"</span><span class='Delimiter'>, 
</span>                                              <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memutils.h.html#LN85"><span class='Ref_to_Proto'>MemoryContextAllowInCriticalSection</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN156"><span class='Ref_to_Global_Var'>pendingOpsCxt</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="md.c.html#LN156"><span class='Ref_to_Global_Var'>pendingOpsCxt</span></a><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Pending Ops Table"</span><span class='Delimiter'>, 
</span>                                      <span class='Number'>100L</span><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="md.c.html#LN218"><span class='Ref_To_Local'>hash_ctl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !IsUnderPostmaster||A... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdinit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * In archive recovery, we rely on checkpointer to do fsyncs, but we will have 
 * already created the pendingOpsTable during initialization of the startup 
 * process.  Calling this function drops the local pendingOpsTable so that 
 * subsequent requests will be forwarded to checkpointer. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN253"></a><span class='Declare_Function'>SetForwardFsyncRequests</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Perform any pending fsyncs we may have queued up, then drop table */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/smgr.h.html#LN137"><span class='Ref_to_Proto'>mdsync</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN123"><span class='Ref_to_Proto'>hash_destroy</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We should not have any pending unlink requests, since mdunlink doesn't 
     * queue unlink requests when isRedo. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  mdexists() -- Does the physical file exist? 
 * 
 * Note: this will return true for lingering files, with pending deletions 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN276"></a><span class='Declare_Function'>mdexists</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Close it first, to ensure that we notice if the fork has been unlinked 
     * since we opened it. 
     */ 
</span>    <a href="../../../include/storage/smgr.h.html#LN118"><span class='Ref_to_Proto'>mdclose</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN276"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN276"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="md.c.html#LN184"><span class='Ref_to_Proto'>mdopen</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN276"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN276"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 *  mdcreate() -- Create a new relation on magnetic disk. 
 * 
 * If isRedo is true, it's okay for the relation to exist already. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN293"></a><span class='Declare_Function'>mdcreate</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isRedo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN295"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>mdfd</span><span class='Delimiter'>; 
</span><a name="LN296"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span><a name="LN297"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>isRedo</span></a> <span class='Operator'>&& </span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* created and opened already... */ 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN296"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN297"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN296"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span>O_EXCL <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN297"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN310"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * During bootstrap, there are cases where a system relation will be 
         * accessed (by internal backend processes) before the bootstrap 
         * script nominally creates it.  Therefore, allow the file to exist 
         * already, even if isRedo is not set.  (See also mdopen) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>isRedo</span></a> <span class='Operator'>|| </span><a href="../../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
            <a href="md.c.html#LN297"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN296"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN297"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* be sure to report the error reported by create, not open */ 
</span>            errno <span class='Operator'>= </span><a href="md.c.html#LN310"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN296"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fd&LT;0 &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN296"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN188"><span class='Ref_to_Proto'>_fdvec_resize</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN295"><span class='Ref_To_Local'>mdfd</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN293"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>][</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="md.c.html#LN295"><span class='Ref_To_Local'>mdfd</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a> <span class='Operator'>= </span><a href="md.c.html#LN297"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN295"><span class='Ref_To_Local'>mdfd</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdcreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdunlink() -- Unlink a relation. 
 * 
 * Note that we're passed a RelFileNodeBackend --- by the time this is called, 
 * there won't be an SMgrRelation hashtable entry anymore. 
 * 
 * forkNum can be a fork number to delete a specific fork, or InvalidForkNumber 
 * to delete all forks. 
 * 
 * For regular relations, we don't unlink the first segment file of the rel, 
 * but just truncate it to zero length, and record a request to unlink it after 
 * the next checkpoint.  Additional segments can be unlinked immediately, 
 * however.  Leaving the empty file in place prevents that relfilenode 
 * number from being reused.  The scenario this protects us from is: 
 * 1. We delete a relation (and commit, and actually remove its file). 
 * 2. We create a new relation, which by chance gets the same relfilenode as 
 *    the just-deleted one (OIDs must've wrapped around for that to happen). 
 * 3. We crash before another checkpoint occurs. 
 * During replay, we would delete the file and then recreate it, which is fine 
 * if the contents of the file were repopulated by subsequent WAL entries. 
 * But if we didn't WAL-log insertions, but instead relied on fsyncing the 
 * file after populating it (as for instance CLUSTER and CREATE INDEX do), 
 * the contents of the file would be lost forever.  By leaving the empty file 
 * until after the next checkpoint, we prevent reassignment of the relfilenode 
 * number until it's safe, because relfilenode assignment skips over any 
 * existing file. 
 * 
 * We do not need to go through this dance for temp relations, though, because 
 * we never make WAL entries for temp rels, and so a temp rel poses no threat 
 * to the health of a regular rel that has taken over its relfilenode number. 
 * The fact that temp rels and regular rels have different file naming 
 * patterns provides additional safety. 
 * 
 * All the above applies only to the relation's main fork; other forks can 
 * just be removed immediately, since they are not needed to prevent the 
 * relfilenode number from being recycled.  Also, we do not carefully 
 * track whether other forks have been created or not, but just attempt to 
 * unlink them unconditionally; so we should never complain about ENOENT. 
 * 
 * If isRedo is true, it's unsurprising for the relation to be already gone. 
 * Also, we should remove the file immediately instead of queuing a request 
 * for later, since during redo there's no possibility of creating a 
 * conflicting relation. 
 * 
 * Note: any failure should be reported as WARNING not ERROR, because 
 * we are usually not in a transaction anymore when this is called. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN386"></a><span class='Declare_Function'>mdunlink</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isRedo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We have to clean out any pending fsync requests for the doomed 
     * relation, else the next mdsync() will fail.  There can't be any such 
     * requests for a temp relation, though.  We can send just one request 
     * even when deleting multiple forks, since the fsync queuing code accepts 
     * the "InvalidForkNumber = all forks" convention. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/relfilenode.h.html#LN77"><span class='Ref_to_Macro'>RelFileNodeBackendIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/smgr.h.html#LN143"><span class='Ref_to_Proto'>ForgetRelationFsyncRequests</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now do the per-fork work */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a> <span class='Operator'>== </span><a href="../../../include/common/relpath.h.html#LN25"><span class='Ref_to_EnumConst'>InvalidForkNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="md.c.html#LN182"><span class='Ref_to_Proto'>mdunlinkfork</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>isRedo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="md.c.html#LN182"><span class='Ref_to_Proto'>mdunlinkfork</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN386"><span class='Ref_to_Parameter'>isRedo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdunlink &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN409"></a><span class='Declare_Function'>mdunlinkfork</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forkNum</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isRedo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN411"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span><a name="LN412"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>forkNum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete or truncate the first segment. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>isRedo</span></a> <span class='Operator'>|| </span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>forkNum</span></a> <span class='Operator'>!= </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a> <span class='Operator'>|| </span><a href="../../../include/storage/relfilenode.h.html#LN77"><span class='Ref_to_Macro'>RelFileNodeBackendIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* truncate(2) would be easier here, but Windows hasn't got it */ 
</span><a name="LN430"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN430"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN96"><span class='Ref_to_Proto'>OpenTransientFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN430"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN435"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span><span class='Delimiter'>; 
</span> 
            <a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32.h.html#LN58"><span class='Ref_to_Macro'>ftruncate</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN430"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN435"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>            <a href="../../../include/storage/fd.h.html#LN97"><span class='Ref_to_Proto'>CloseTransientFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN430"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            errno <span class='Operator'>= </span><a href="md.c.html#LN435"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not truncate file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Register request to unlink first segment later */ 
</span>        <a href="md.c.html#LN187"><span class='Ref_to_Proto'>register_unlink</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN409"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Delete any additional segments. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN412"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN458"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>segpath</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>12</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN459"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note that because we loop until getting ENOENT, we will correctly 
         * remove all inactive segments as well as active ones. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN459"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;; </span><a href="md.c.html#LN459"><span class='Ref_To_Local'>segno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN458"><span class='Ref_To_Local'>segpath</span></a><span class='Delimiter'>, </span><span class='String'>"%s.%u"</span><span class='Delimiter'>, </span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN459"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN458"><span class='Ref_To_Local'>segpath</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* ENOENT is expected after the last segment... */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                       <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN458"><span class='Ref_To_Local'>segpath</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN458"><span class='Ref_To_Local'>segpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if ret&GT;=0 &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN411"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdunlinkfork &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdextend() -- Add a block to the specified relation. 
 * 
 *      The semantics are nearly the same as mdwrite(): write at the 
 *      specified position.  However, this is to be used for the case of 
 *      extending a relation (i.e., blocknum is at or beyond the current 
 *      EOF).  Note that we assume writing a block beyond current EOF 
 *      causes intervening file space to become filled with zeroes. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN494"></a><span class='Declare_Function'>mdextend</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, 
</span><a name="LN495"></a>         <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>skipFsync</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN497"></a>    off_t       <span class='Declare_Local'>seekpos</span><span class='Delimiter'>; 
</span><a name="LN498"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN499"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This assert is too expensive to have on normally ... */ 
</span><span class='Directive'>#ifdef</span> CHECK_WRITE_VS_EXTEND 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/storage/smgr.h.html#LN132"><span class='Ref_to_Proto'>mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If a relation manages to grow to 2^32-1 blocks, refuse to extend it any 
     * more --- we mustn't create a block whose number actually is 
     * InvalidBlockNumber. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>== </span><a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot extend file \"%s\" beyond %u blocks"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/block.h.html#LN32"><span class='Ref_to_Const'>InvalidBlockNumber</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN495"><span class='Ref_to_Parameter'>skipFsync</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN168"><span class='Ref_to_Const'>EXTENSION_CREATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN497"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN497"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>* </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: because caller usually obtained blocknum by calling mdnblocks, 
     * which did a seek(SEEK_END), this seek is often redundant and will be 
     * optimized away by fd.c.  It's not redundant, however, if there is a 
     * partial page at the end of the file. In that case we want to try to 
     * overwrite the partial page with a full page.  It's also not redundant 
     * if bufmgr.c had to dump another buffer of the same file to make room 
     * for the new page's buffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN74"><span class='Ref_to_Proto'>FileSeek</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN497"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="md.c.html#LN497"><span class='Ref_To_Local'>seekpos</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not seek to block %u in file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="md.c.html#LN498"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN72"><span class='Ref_to_Proto'>FileWrite</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN495"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN847"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_EXTEND</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN498"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not extend file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Check free disk space."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* short write: complain appropriately */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DISK_FULL<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not extend file \"%s\": wrote only %d of %d bytes at block %u"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN498"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Check free disk space."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN495"><span class='Ref_to_Parameter'>skipFsync</span></a> <span class='Operator'>&& !</span><a href="../../../include/storage/smgr.h.html#LN79"><span class='Ref_to_Macro'>SmgrIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span> 
        <a href="md.c.html#LN185"><span class='Ref_to_Proto'>register_dirty_segment</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN197"><span class='Ref_to_Proto'>_mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN494"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN499"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;= </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdextend &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdopen() -- Open the specified relation. 
 * 
 * Note we only open the first segment, when there are multiple segments. 
 * 
 * If first segment is not present, either ereport or return NULL according 
 * to "behavior".  We treat EXTENSION_CREATE the same as EXTENSION_FAIL; 
 * EXTENSION_CREATE means it's OK to extend an existing relation, not to 
 * invent one out of whole cloth. 
 */ 
</span><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>* 
</span><a name="LN573"></a><span class='Declare_Function'>mdopen</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>behavior</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN575"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>mdfd</span><span class='Delimiter'>; 
</span><a name="LN576"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span><a name="LN577"></a>    <a href="../../../include/storage/fd.h.html#LN50"><span class='Ref_to_Typedef'>File</span></a>        <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No work if already open */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>&</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
    <a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN577"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN577"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * During bootstrap, there are cases where a system relation will be 
         * accessed (by internal backend processes) before the bootstrap 
         * script nominally creates it.  Therefore, accept mdopen() as a 
         * substitute for mdcreate() in bootstrap mode only. (See mdcreate) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
            <a href="md.c.html#LN577"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span>O_EXCL <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN577"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <a href="md.c.html#LN65"><span class='Ref_to_Macro'>FILE_POSSIBLY_DELETED</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fd&LT;0 &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN576"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN188"><span class='Ref_to_Proto'>_fdvec_resize</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN575"><span class='Ref_To_Local'>mdfd</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="md.c.html#LN575"><span class='Ref_To_Local'>mdfd</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a> <span class='Operator'>= </span><a href="md.c.html#LN577"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN575"><span class='Ref_To_Local'>mdfd</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN197"><span class='Ref_to_Proto'>_mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN573"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN575"><span class='Ref_To_Local'>mdfd</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;= </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="md.c.html#LN575"><span class='Ref_To_Local'>mdfd</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdopen &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdclose() -- Close the specified relation, if it isn't closed already. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN627"></a><span class='Declare_Function'>mdclose</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN629"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nopensegs</span> <span class='Operator'>= </span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* No work if already closed */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN629"><span class='Ref_To_Local'>nopensegs</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* close segments starting from the end */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="md.c.html#LN629"><span class='Ref_To_Local'>nopensegs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN638"></a>        <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span> <span class='Operator'>= &</span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN629"><span class='Ref_To_Local'>nopensegs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* if not closed already */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN638"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/fd.h.html#LN69"><span class='Ref_to_Proto'>FileClose</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN638"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN638"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="md.c.html#LN629"><span class='Ref_To_Local'>nopensegs</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* resize just once, avoids pointless reallocations */ 
</span>    <a href="md.c.html#LN188"><span class='Ref_to_Proto'>_fdvec_resize</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN627"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdclose &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdprefetch() -- Initiate asynchronous read of the specified block of a relation 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN658"></a><span class='Declare_Function'>mdprefetch</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blocknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN145"><span class='Ref_to_Const'>USE_PREFETCH</span></a> 
<a name="LN661"></a>    off_t       <span class='Declare_Local'>seekpos</span><span class='Delimiter'>; 
</span><a name="LN662"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN662"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN658"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN658"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN658"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="md.c.html#LN164"><span class='Ref_to_Const'>EXTENSION_FAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN661"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="md.c.html#LN658"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN661"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>* </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/storage/fd.h.html#LN70"><span class='Ref_to_Proto'>FilePrefetch</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN662"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN661"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN850"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_PREFETCH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_PREFETCH */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * mdwriteback() -- Tell the kernel to write pages back to storage. 
 * 
 * This accepts a range of blocks because flushing several pages at once is 
 * considerably more efficient than doing so individually. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN681"></a><span class='Declare_Function'>mdwriteback</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN682"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Issue flush requests in as few requests as possible; have to split at 
     * segment boundaries though, since those are actually separate files. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN690"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nflush</span> <span class='Operator'>= </span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Delimiter'>; 
</span><a name="LN691"></a>        off_t       <span class='Declare_Local'>seekpos</span><span class='Delimiter'>; 
</span><a name="LN692"></a>        <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN693"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>segnum_start</span><span class='Delimiter'>, 
</span><a name="LN694"></a>                    <span class='Declare_Local'>segnum_end</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN692"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN681"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN681"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><span class='Boolean'>true </span><span class='Comment_Multi_Line'>/* not used */ </span><span class='Delimiter'>, 
</span>                         <a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We might be flushing buffers of already removed relations, that's 
         * ok, just ignore that case. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN692"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* compute offset inside the current segment */ 
</span>        <a href="md.c.html#LN693"><span class='Ref_To_Local'>segnum_start</span></a> <span class='Operator'>= </span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>/ </span>RELSEG_SIZE<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* compute number of desired writes within the current segment */ 
</span>        <a href="md.c.html#LN694"><span class='Ref_To_Local'>segnum_end</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>+ </span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span>RELSEG_SIZE<span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN693"><span class='Ref_To_Local'>segnum_start</span></a> <span class='Operator'>!= </span><a href="md.c.html#LN694"><span class='Ref_To_Local'>segnum_end</span></a><span class='Parentheses'>) 
</span>            <a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a> <span class='Operator'>= </span>RELSEG_SIZE <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a> <span class='Operator'>&LT;= </span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN691"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/fd.h.html#LN76"><span class='Ref_to_Proto'>FileWriteback</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN692"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN691"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>* </span><a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN848"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_FLUSH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN682"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>-= </span><a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN682"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>+= </span><a href="md.c.html#LN690"><span class='Ref_To_Local'>nflush</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while nblocks&GT;0 &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdwriteback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdread() -- Read the specified block from a relation. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN730"></a><span class='Declare_Function'>mdread</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, 
</span><a name="LN731"></a>       <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN733"></a>    off_t       <span class='Declare_Local'>seekpos</span><span class='Delimiter'>; 
</span><a name="LN734"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN735"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_SMGR_MD_READ_START<span class='Parentheses'>(</span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                     <a href="md.c.html#LN164"><span class='Ref_to_Const'>EXTENSION_FAIL</span></a> <span class='Operator'>| </span><a href="md.c.html#LN170"><span class='Ref_to_Const'>EXTENSION_CREATE_RECOVERY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN733"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN733"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>* </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN74"><span class='Ref_to_Proto'>FileSeek</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN733"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="md.c.html#LN733"><span class='Ref_To_Local'>seekpos</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not seek to block %u in file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN734"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN71"><span class='Ref_to_Proto'>FileRead</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN731"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN851"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_SMGR_MD_READ_DONE<span class='Parentheses'>(</span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN734"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, 
</span>                                       BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN734"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN734"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read block %u in file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Short read: we are at or past EOF, or we read a partial block at 
         * EOF.  Normally this is an error; upper levels should never try to 
         * read a nonexistent block.  However, if zero_damaged_pages is ON or 
         * we are InRecovery, we should instead return zeroes without 
         * complaining.  This allows, for example, the case of trying to 
         * update a block that was later truncated away. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../buffer/bufmgr.c.html#LN107"><span class='Ref_to_Global_Var'>zero_damaged_pages</span></a> <span class='Operator'>|| </span><a href="../../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN731"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATA_CORRUPTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read block %u in file \"%s\": read only %d of %d bytes"</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN730"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN735"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN734"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nbytes!=BLCKSZ &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdread &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdwrite() -- Write the supplied block at the appropriate location. 
 * 
 *      This is to be used only for updating already-existing blocks of a 
 *      relation (ie, those before the current EOF).  To extend a relation, 
 *      use mdextend(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN801"></a><span class='Declare_Function'>mdwrite</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, 
</span><a name="LN802"></a>        <span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>skipFsync</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN804"></a>    off_t       <span class='Declare_Local'>seekpos</span><span class='Delimiter'>; 
</span><a name="LN805"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span><a name="LN806"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This assert is too expensive to have on normally ... */ 
</span><span class='Directive'>#ifdef</span> CHECK_WRITE_VS_EXTEND 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>&LT; </span><a href="../../../include/storage/smgr.h.html#LN132"><span class='Ref_to_Proto'>mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    TRACE_POSTGRESQL_SMGR_MD_WRITE_START<span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, 
</span>                                         <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, 
</span>                                         <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, 
</span>                                         <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, 
</span>                                         <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN802"><span class='Ref_to_Parameter'>skipFsync</span></a><span class='Delimiter'>, 
</span>                     <a href="md.c.html#LN164"><span class='Ref_to_Const'>EXTENSION_FAIL</span></a> <span class='Operator'>| </span><a href="md.c.html#LN170"><span class='Ref_to_Const'>EXTENSION_CREATE_RECOVERY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN804"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>*</span><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>% </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN804"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span>BLCKSZ <span class='Operator'>* </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN74"><span class='Ref_to_Proto'>FileSeek</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN804"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="md.c.html#LN804"><span class='Ref_To_Local'>seekpos</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not seek to block %u in file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN805"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN72"><span class='Ref_to_Proto'>FileWrite</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN802"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN854"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    TRACE_POSTGRESQL_SMGR_MD_WRITE_DONE<span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN805"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, 
</span>                                        BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN805"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN805"><span class='Ref_To_Local'>nbytes</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write block %u in file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* short write: complain appropriately */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DISK_FULL<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write block %u in file \"%s\": wrote only %d of %d bytes"</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN801"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN805"><span class='Ref_To_Local'>nbytes</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Check free disk space."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN802"><span class='Ref_to_Parameter'>skipFsync</span></a> <span class='Operator'>&& !</span><a href="../../../include/storage/smgr.h.html#LN79"><span class='Ref_to_Macro'>SmgrIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span> 
        <a href="md.c.html#LN185"><span class='Ref_to_Proto'>register_dirty_segment</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN801"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN806"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdwrite &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdnblocks() -- Get the number of blocks stored in a relation. 
 * 
 *      Important side effect: all active segments of the relation are opened 
 *      and added to the mdfd_seg_fds array.  If this routine has not been 
 *      called, then only segments up to the last one actually touched 
 *      are present in the array. 
 */ 
</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN872"></a><span class='Declare_Function'>mdnblocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN874"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span> <span class='Operator'>= </span><a href="md.c.html#LN184"><span class='Ref_to_Proto'>mdopen</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN164"><span class='Ref_to_Const'>EXTENSION_FAIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN875"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblocks</span><span class='Delimiter'>; 
</span><a name="LN876"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>segno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* mdopen has opened the first segment */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start from the last open segments, to avoid redundant seeks.  We have 
     * previously verified that these segments are exactly RELSEG_SIZE long, 
     * and it's useless to recheck that each time. 
     * 
     * NOTE: this assumption could only be wrong if another backend has 
     * truncated the relation.  We rely on higher code levels to handle that 
     * scenario by closing and re-opening the md fd, which is handled via 
     * relcache flush.  (Since the checkpointer doesn't participate in 
     * relcache flush, it could have segment entries for inactive segments; 
     * that's OK because the checkpointer never needs to compute relation 
     * size.) 
     */ 
</span>    <a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>= </span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN874"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN875"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>= </span><a href="md.c.html#LN197"><span class='Ref_to_Proto'>_mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN874"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN875"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"segment too big"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN875"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>* </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="md.c.html#LN875"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If segment is exactly RELSEG_SIZE, advance to next one. 
         */ 
</span>        <a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We used to pass O_CREAT here, but that's has the disadvantage that 
         * it might create a segment which has vanished through some operating 
         * system misadventure.  In such a case, creating the segment here 
         * undermines _mdfd_getseg's attempts to notice and report an error 
         * upon access to a missing segment. 
         */ 
</span>        <a href="md.c.html#LN874"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN193"><span class='Ref_to_Proto'>_mdfd_openseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN872"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN874"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="md.c.html#LN876"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>* </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdnblocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdtruncate() -- Truncate relation to specified number of blocks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN927"></a><span class='Declare_Function'>mdtruncate</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nblocks</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN929"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>curnblk</span><span class='Delimiter'>; 
</span><a name="LN930"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>priorblocks</span><span class='Delimiter'>; 
</span><a name="LN931"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>curopensegs</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * NOTE: mdnblocks makes sure we have opened all active segments, so that 
     * truncation loop will get them all! 
     */ 
</span>    <a href="md.c.html#LN929"><span class='Ref_To_Local'>curnblk</span></a> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN132"><span class='Ref_to_Proto'>mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>&GT; </span><a href="md.c.html#LN929"><span class='Ref_To_Local'>curnblk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Bogus request ... but no complaint if InRecovery */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not truncate file \"%s\" to %u blocks: it's only %u blocks now"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN929"><span class='Ref_To_Local'>curnblk</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>== </span><a href="md.c.html#LN929"><span class='Ref_To_Local'>curnblk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* no work */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Truncate segments, starting at the last one. Starting at the end makes 
     * managing the memory for the fd array easier, should there be errors. 
     */ 
</span>    <a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a> <span class='Operator'>= </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN958"></a>        <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN930"><span class='Ref_To_Local'>priorblocks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span>RELSEG_SIZE<span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN930"><span class='Ref_To_Local'>priorblocks</span></a> <span class='Operator'>&GT; </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This segment is no longer active. We truncate the file, but do 
             * not delete it, for reasons explained in the header comments. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN75"><span class='Ref_to_Proto'>FileTruncate</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN853"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_TRUNCATE</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not truncate file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/smgr.h.html#LN79"><span class='Ref_to_Macro'>SmgrIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span> 
                <a href="md.c.html#LN185"><span class='Ref_to_Proto'>register_dirty_segment</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* we never drop the 1st segment */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>!= &</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/storage/fd.h.html#LN69"><span class='Ref_to_Proto'>FileClose</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN188"><span class='Ref_to_Proto'>_fdvec_resize</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if priorblocks&GT;nblocks &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN930"><span class='Ref_To_Local'>priorblocks</span></a> <span class='Operator'>+ </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>)</span> <span class='Operator'>&GT; </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * This is the last segment we want to keep. Truncate the file to 
             * the right length. NOTE: if nblocks is exactly a multiple K of 
             * RELSEG_SIZE, we will truncate the K+1st segment to 0 length but 
             * keep it. This adheres to the invariant given in the header 
             * comments. 
             */ 
</span><a name="LN994"></a>            <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>lastsegblocks</span> <span class='Operator'>= </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a> <span class='Operator'>- </span><a href="md.c.html#LN930"><span class='Ref_To_Local'>priorblocks</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN75"><span class='Ref_to_Proto'>FileTruncate</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><a href="md.c.html#LN994"><span class='Ref_To_Local'>lastsegblocks</span></a> <span class='Operator'>* </span>BLCKSZ<span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN853"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_TRUNCATE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                    <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not truncate file \"%s\" to %u blocks: %m"</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="md.c.html#LN927"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/smgr.h.html#LN79"><span class='Ref_to_Macro'>SmgrIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span> 
                <a href="md.c.html#LN185"><span class='Ref_to_Proto'>register_dirty_segment</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN927"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN958"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if priorblocks+((BlockNu... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We still need this segment, so nothing to do for this and any 
             * earlier segment. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="md.c.html#LN931"><span class='Ref_To_Local'>curopensegs</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while curopensegs&GT;0 &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdtruncate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdimmedsync() -- Immediately sync a relation to stable storage. 
 * 
 * Note that only writes already issued are synced; this routine knows 
 * nothing of dirty buffers that may exist inside the buffer manager. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1024"></a><span class='Declare_Function'>mdimmedsync</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1026"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * NOTE: mdnblocks makes sure we have opened all active segments, so that 
     * fsync loop will get them all! 
     */ 
</span>    <a href="../../../include/storage/smgr.h.html#LN132"><span class='Ref_to_Proto'>mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1026"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1026"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1038"></a>        <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span> <span class='Operator'>= &</span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1024"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN1026"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN73"><span class='Ref_to_Proto'>FileSync</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1038"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN849"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_IMMEDIATE_SYNC</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1038"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN1026"><span class='Ref_To_Local'>segno</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end mdimmedsync &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  mdsync() -- Sync previous writes to stable storage. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1053"></a><span class='Declare_Function'>mdsync</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1055"></a>    <span class='Keyword'>static bool </span><span class='Declare_Local'>mdsync_in_progress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN1057"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN1058"></a>    <a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1059"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>absorb_counter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Statistics on sync times */ 
</span><a name="LN1062"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>processed</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1063"></a>    <a href="../../../include/portability/instr_time.h.html#LN146"><span class='Ref_to_Typedef'>instr_time</span></a>  <span class='Declare_Local'>sync_start</span><span class='Delimiter'>, 
</span><a name="LN1064"></a>                <span class='Declare_Local'>sync_end</span><span class='Delimiter'>, 
</span><a name="LN1065"></a>                <span class='Declare_Local'>sync_diff</span><span class='Delimiter'>; 
</span><a name="LN1066"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>elapsed</span><span class='Delimiter'>; 
</span><a name="LN1067"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>longest</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1068"></a>    <a href="../../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a>      <span class='Declare_Local'>total_elapsed</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is only called during checkpoints, and checkpoints should only 
     * occur in processes that have created a pendingOpsTable. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot sync without a pendingOpsTable"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are in the checkpointer, the sync had better include all fsync 
     * requests that were queued by backends up to this point.  The tightest 
     * race condition that could occur is that a buffer that must be written 
     * and fsync'd for the checkpoint could have been dumped by a backend just 
     * before it was visited by BufferSync().  We know the backend will have 
     * queued an fsync request before clearing the buffer's dirtybit, so we 
     * are safe as long as we do an Absorb after completing BufferSync(). 
     */ 
</span>    <a href="../../../include/postmaster/bgwriter.h.html#LN35"><span class='Ref_to_Proto'>AbsorbFsyncRequests</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * To avoid excess fsync'ing (in the worst case, maybe a never-terminating 
     * checkpoint), we want to ignore fsync requests that are entered into the 
     * hashtable after this point --- they should be processed next time, 
     * instead.  We use mdsync_cycle_ctr to tell old entries apart from new 
     * ones: new ones will have cycle_ctr equal to the incremented value of 
     * mdsync_cycle_ctr. 
     * 
     * In normal circumstances, all entries present in the table at this point 
     * will have cycle_ctr exactly equal to the current (about to be old) 
     * value of mdsync_cycle_ctr.  However, if we fail partway through the 
     * fsync'ing loop, then older values of cycle_ctr might remain when we 
     * come back here to try again.  Repeated checkpoint failures would 
     * eventually wrap the counter around to the point where an old entry 
     * might appear new, causing us to skip it, possibly allowing a checkpoint 
     * to succeed that should not have.  To forestall wraparound, any time the 
     * previous mdsync() failed to complete, run through the table and 
     * forcibly set cycle_ctr = mdsync_cycle_ctr. 
     * 
     * Think not to merge this loop with the main loop, as the problem is 
     * exactly that that loop may fail before having visited all the entries. 
     * From a performance point of view it doesn't matter anyway, as this path 
     * will never be taken in a system that's functioning normally. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1055"><span class='Ref_To_Local'>mdsync_in_progress</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* prior try failed, so update any stale cycle_ctr values */ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1057"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1057"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN141"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>= </span><a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Advance counter so that new hashtable entries are distinguishable */ 
</span>    <a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set flag to detect failure if we don't reach the end of the loop */ 
</span>    <a href="md.c.html#LN1055"><span class='Ref_To_Local'>mdsync_in_progress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now scan the hashtable for fsync requests to process */ 
</span>    <a href="md.c.html#LN1059"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>= </span><a href="md.c.html#LN43"><span class='Ref_to_Const'>FSYNCS_PER_ABSORB</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1057"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1057"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1133"></a>        <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a>  <span class='Declare_Local'>forknum</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the entry is new then don't process it this time; it might 
         * contain multiple fsync-request bits, but they are all new.  Note 
         * "continue" bypasses the hash-remove call at the bottom of the loop. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN141"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>== </span><a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Else assert we haven't missed it */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="md.c.html#LN136"><span class='Ref_to_Typedef'>CycleCtr</span></a><span class='Parentheses'>) (</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN141"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Scan over the forks and segments represented by the entry. 
         * 
         * The bitmap manipulations are slightly tricky, because we can call 
         * AbsorbFsyncRequests() inside the loop and that could result in 
         * bms_add_member() modifying and even re-palloc'ing the bitmapsets. 
         * This is okay because we unlink each bitmapset from the hashtable 
         * entry before scanning it.  That means that any incoming fsync 
         * requests will be processed now if they reach the table before we 
         * begin to scan their fork. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1159"></a>            <a href="../../../include/nodes/bitmapset.h.html#LN36"><span class='Ref_to_Struct'>Bitmapset</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>requests</span> <span class='Operator'>= </span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>]; 
</span><a name="LN1160"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span> 
            <a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1160"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN97"><span class='Ref_to_Proto'>bms_first_member</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1159"><span class='Ref_To_Local'>requests</span></a><span class='Parentheses'>))</span> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1167"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>failures</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If fsync is off then we don't have to bother opening the 
                 * file at all.  (We delay checking until this point so that 
                 * changing fsync on the fly behaves sensibly.) 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../utils/init/globals.c.html#LN110"><span class='Ref_to_Global_Var'>enableFsync</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * If in checkpointer, we want to absorb pending requests 
                 * every so often to prevent overflow of the fsync request 
                 * queue.  It is unspecified whether newly-added entries will 
                 * be visited by hash_seq_search, but we don't care since we 
                 * don't need to process them anyway. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="md.c.html#LN1059"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/postmaster/bgwriter.h.html#LN35"><span class='Ref_to_Proto'>AbsorbFsyncRequests</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1059"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>= </span><a href="md.c.html#LN43"><span class='Ref_to_Const'>FSYNCS_PER_ABSORB</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * The fsync table could contain requests to fsync segments 
                 * that have been deleted (unlinked) by the time we get to 
                 * them. Rather than just hoping an ENOENT (or EACCES on 
                 * Windows) error can be ignored, what we do on error is 
                 * absorb pending requests and then retry.  Since mdunlink() 
                 * queues a "cancel" message before actually unlinking, the 
                 * fsync request is guaranteed to be marked canceled after the 
                 * absorb if it really was this case. DROP DATABASE likewise 
                 * has to tell us to forget fsync requests before it starts 
                 * deletions. 
                 */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1167"><span class='Ref_To_Local'>failures</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;; </span><a href="md.c.html#LN1167"><span class='Ref_To_Local'>failures</span></a><span class='Operator'>++</span><span class='Parentheses'>) </span><span class='Comment_Single_Line'>/* loop exits at "break" */ 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1204"></a>                    <a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Local'>reln</span><span class='Delimiter'>; 
</span><a name="LN1205"></a>                    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>seg</span><span class='Delimiter'>; 
</span><a name="LN1206"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span><a name="LN1207"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Find or create an smgr hash entry for this relation. 
                     * This may seem a bit unclean -- md calling smgr?  But 
                     * it's really the best solution.  It ensures that the 
                     * open file reference isn't permanently leaked if we get 
                     * an error here. (You may say "but an unreferenced 
                     * SMgrRelation is still a leak!" Not really, because the 
                     * only case in which a checkpoint is done by a process 
                     * that isn't about to shut down is in the checkpointer, 
                     * and it will periodically do smgrcloseall(). This fact 
                     * justifies our not closing the reln in the success path 
                     * either, which is a good thing since in non-checkpointer 
                     * cases we couldn't safely do that.) 
                     */ 
</span>                    <a href="md.c.html#LN1204"><span class='Ref_To_Local'>reln</span></a> <span class='Operator'>= </span><a href="../../../include/storage/smgr.h.html#LN83"><span class='Ref_to_Proto'>smgropen</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN140"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/backendid.h.html#LN22"><span class='Ref_to_Const'>InvalidBackendId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* Attempt to open and fsync the target segment */ 
</span>                    <a href="md.c.html#LN1205"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>= </span><a href="md.c.html#LN195"><span class='Ref_to_Proto'>_mdfd_getseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1204"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>, 
</span>                             <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="md.c.html#LN1160"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Delimiter'>, 
</span>                                       <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                                       <a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a> 
                                       <span class='Operator'>| </span><a href="md.c.html#LN178"><span class='Ref_to_Const'>EXTENSION_DONT_CHECK_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1063"><span class='Ref_To_Local'>sync_start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1205"><span class='Ref_To_Local'>seg</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                     <a href="../../../include/storage/fd.h.html#LN73"><span class='Ref_to_Proto'>FileSync</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1205"><span class='Ref_To_Local'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN852"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_SYNC</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* Success; update statistics about sync timing */ 
</span>                        <a href="../../../include/portability/instr_time.h.html#LN88"><span class='Ref_to_Macro'>INSTR_TIME_SET_CURRENT</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1064"><span class='Ref_To_Local'>sync_end</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="md.c.html#LN1065"><span class='Ref_To_Local'>sync_diff</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1064"><span class='Ref_To_Local'>sync_end</span></a><span class='Delimiter'>; 
</span>                        <a href="../../../include/portability/instr_time.h.html#LN102"><span class='Ref_to_Macro'>INSTR_TIME_SUBTRACT</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1065"><span class='Ref_To_Local'>sync_diff</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1063"><span class='Ref_To_Local'>sync_start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="md.c.html#LN1066"><span class='Ref_To_Local'>elapsed</span></a> <span class='Operator'>= </span><a href="../../../include/portability/instr_time.h.html#LN137"><span class='Ref_to_Macro'>INSTR_TIME_GET_MICROSEC</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1065"><span class='Ref_To_Local'>sync_diff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1066"><span class='Ref_To_Local'>elapsed</span></a> <span class='Operator'>&GT; </span><a href="md.c.html#LN1067"><span class='Ref_To_Local'>longest</span></a><span class='Parentheses'>) 
</span>                            <a href="md.c.html#LN1067"><span class='Ref_To_Local'>longest</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1066"><span class='Ref_To_Local'>elapsed</span></a><span class='Delimiter'>; 
</span>                        <a href="md.c.html#LN1068"><span class='Ref_To_Local'>total_elapsed</span></a> <span class='Operator'>+= </span><a href="md.c.html#LN1066"><span class='Ref_To_Local'>elapsed</span></a><span class='Delimiter'>; 
</span>                        <a href="md.c.html#LN1062"><span class='Ref_To_Local'>processed</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../access/transam/xlog.c.html#LN101"><span class='Ref_to_Global_Var'>log_checkpoints</span></a><span class='Parentheses'>) 
</span>                            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, </span><span class='String'>"checkpoint sync: number=%d file=%s time=%.3f msec"</span><span class='Delimiter'>, 
</span>                                 <a href="md.c.html#LN1062"><span class='Ref_To_Local'>processed</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1205"><span class='Ref_To_Local'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="md.c.html#LN1066"><span class='Ref_To_Local'>elapsed</span></a> <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>break</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* out of retry loop */ 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if seg!=NULL&&FileSync(s... &raquo; </span> 
 
                    <span class='Comment_Multi_Line'>/* Compute file name for use in message */ 
</span>                    <a href="md.c.html#LN1207"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1206"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="md.c.html#LN191"><span class='Ref_to_Proto'>_mdfd_segpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1204"><span class='Ref_To_Local'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="md.c.html#LN1160"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    errno <span class='Operator'>= </span><a href="md.c.html#LN1207"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * It is possible that the relation has been dropped or 
                     * truncated since the fsync request was entered. 
                     * Therefore, allow ENOENT, but only if we didn't fail 
                     * already on this file.  This applies both for 
                     * _mdfd_getseg() and for FileSync, since fd.c might have 
                     * closed the file behind our back. 
                     * 
                     * XXX is there any point in allowing more than one retry? 
                     * Don't see one at the moment, but easy to change the 
                     * test here if so. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN65"><span class='Ref_to_Macro'>FILE_POSSIBLY_DELETED</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                        <a href="md.c.html#LN1167"><span class='Ref_To_Local'>failures</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                        <a href="md.c.html#LN1206"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                        <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\" but retrying: %m"</span><span class='Delimiter'>, 
</span>                               <a href="md.c.html#LN1206"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1206"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Absorb incoming requests and check to see if a cancel 
                     * arrived for this relation fork. 
                     */ 
</span>                    <a href="../../../include/postmaster/bgwriter.h.html#LN35"><span class='Ref_to_Proto'>AbsorbFsyncRequests</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1059"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>= </span><a href="md.c.html#LN43"><span class='Ref_to_Const'>FSYNCS_PER_ABSORB</span></a><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* might as well... */ 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for failures=0;;failures+... &raquo; </span>               <span class='Comment_Single_Line'>/* end retry loop */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (segno=bms_first_memb... &raquo; </span> 
            <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1159"><span class='Ref_To_Local'>requests</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for forknum=0;forknum&LT;=MA... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * We've finished everything that was requested before we started to 
         * scan the entry.  If no new requests have been inserted meanwhile, 
         * remove the entry.  Otherwise, update its cycle counter, as all the 
         * requests now in it must have arrived during this cycle. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1133"><span class='Ref_To_Local'>forknum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Parentheses'>) 
</span>            <a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN141"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>= </span><a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Okay to remove it */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="md.c.html#LN1058"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN140"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"pendingOpsTable corrupted"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (entry=(PendingOperat... &raquo; </span>                           <span class='Comment_Single_Line'>/* end loop over hashtable entries */ 
</span> 
    <span class='Comment_Multi_Line'>/* Return sync performance metrics for report at checkpoint end */ 
</span>    <a href="../../access/transam/xlog.c.html#LN172"><span class='Ref_to_Global_Var'>CheckpointStats</span></a><span class='Operator'>.</span><a href="../../../include/access/xlog.h.html#LN210"><span class='Ref_to_Member'>ckpt_sync_rels</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1062"><span class='Ref_To_Local'>processed</span></a><span class='Delimiter'>; 
</span>    <a href="../../access/transam/xlog.c.html#LN172"><span class='Ref_to_Global_Var'>CheckpointStats</span></a><span class='Operator'>.</span><a href="../../../include/access/xlog.h.html#LN211"><span class='Ref_to_Member'>ckpt_longest_sync</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1067"><span class='Ref_To_Local'>longest</span></a><span class='Delimiter'>; 
</span>    <a href="../../access/transam/xlog.c.html#LN172"><span class='Ref_to_Global_Var'>CheckpointStats</span></a><span class='Operator'>.</span><a href="../../../include/access/xlog.h.html#LN212"><span class='Ref_to_Member'>ckpt_agg_sync_time</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1068"><span class='Ref_To_Local'>total_elapsed</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Flag successful completion of mdsync */ 
</span>    <a href="md.c.html#LN1055"><span class='Ref_To_Local'>mdsync_in_progress</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mdsync &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * mdpreckpt() -- Do pre-checkpoint work 
 * 
 * To distinguish unlink requests that arrived before this checkpoint 
 * started from those that arrived during the checkpoint, we use a cycle 
 * counter similar to the one we use for fsync requests. That cycle 
 * counter is incremented here. 
 * 
 * This must be called *before* the checkpoint REDO point is determined. 
 * That ensures that we won't delete files too soon. 
 * 
 * Note that we can't do anything here that depends on the assumption 
 * that the checkpoint will be completed. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1345"></a><span class='Declare_Function'>mdpreckpt</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Any unlink requests arriving after this point will be assigned the next 
     * cycle counter, and won't be unlinked until next checkpoint. 
     */ 
</span>    <a href="md.c.html#LN159"><span class='Ref_to_Global_Var'>mdckpt_cycle_ctr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * mdpostckpt() -- Do post-checkpoint work 
 * 
 * Remove any lingering files that can now be safely removed. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1360"></a><span class='Declare_Function'>mdpostckpt</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1362"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>absorb_counter</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1362"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>= </span><a href="md.c.html#LN44"><span class='Ref_to_Const'>UNLINKS_PER_ABSORB</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1367"></a>        <a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1368"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * New entries are appended to the end, so if the entry is new we've 
         * reached the end of old entries. 
         * 
         * Note: if just the right number of consecutive checkpoints fail, we 
         * could be fooled here by cycle_ctr wraparound.  However, the only 
         * consequence is that we'd delay unlinking for one more checkpoint, 
         * which is perfectly tolerable. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1367"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN151"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>== </span><a href="md.c.html#LN159"><span class='Ref_to_Global_Var'>mdckpt_cycle_ctr</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Unlink the file */ 
</span>        <a href="md.c.html#LN1368"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN66"><span class='Ref_to_Macro'>relpathperm</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1367"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN150"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1368"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * There's a race condition, when the database is dropped at the 
             * same time that we process the pending unlink requests. If the 
             * DROP DATABASE deletes the file before we do, we will get ENOENT 
             * here. rmtree() also has to ignore ENOENT errors, to deal with 
             * the possibility that we delete the file first. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ENOENT<span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="md.c.html#LN1368"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1368"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* And remove the list entry */ 
</span>        <a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN237"><span class='Ref_to_Proto'>list_delete_first</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1367"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * As in mdsync, we don't want to stop absorbing fsync requests for a 
         * long time when there are many deletions to be done.  We can safely 
         * call AbsorbFsyncRequests() at this point in the loop (note it might 
         * try to delete list entries). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="md.c.html#LN1362"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/postmaster/bgwriter.h.html#LN35"><span class='Ref_to_Proto'>AbsorbFsyncRequests</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN1362"><span class='Ref_To_Local'>absorb_counter</span></a> <span class='Operator'>= </span><a href="md.c.html#LN44"><span class='Ref_to_Const'>UNLINKS_PER_ABSORB</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while pendingUnlinks!=NIL &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end mdpostckpt &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * register_dirty_segment() -- Mark a relation segment as needing fsync 
 * 
 * If there is a local pending-ops table, just make an entry in it for 
 * mdsync to process later.  Otherwise, try to pass off the fsync request 
 * to the checkpointer process.  If that fails, just do the fsync 
 * locally before returning (we hope this will not happen often enough 
 * to be a performance problem). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1428"></a><span class='Declare_Function'>register_dirty_segment</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Temp relations should never be fsync'd */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/smgr.h.html#LN79"><span class='Ref_to_Macro'>SmgrIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>reln</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* push it into local pending-ops table */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN141"><span class='Ref_to_Proto'>RememberFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postmaster/bgwriter.h.html#LN33"><span class='Ref_to_Proto'>ForwardFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* passed it off successfully */ 
</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not forward fsync request because request queue is full"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN73"><span class='Ref_to_Proto'>FileSync</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><a href="../../../include/pgstat.h.html#LN852"><span class='Ref_to_EnumConst'>WAIT_EVENT_DATA_FILE_SYNC</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not fsync file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1428"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end register_dirty_segment &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * register_unlink() -- Schedule a file to be deleted after next checkpoint 
 * 
 * We don't bother passing in the fork number, because this is only used 
 * with main forks. 
 * 
 * As with register_dirty_segment, this could involve either a local or 
 * a remote pending-ops table. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1464"></a><span class='Declare_Function'>register_unlink</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Should never be used with temp relations */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/relfilenode.h.html#LN77"><span class='Ref_to_Macro'>RelFileNodeBackendIsTemp</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1464"><span class='Ref_to_Parameter'>rnode</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* push it into local pending-ops table */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN141"><span class='Ref_to_Proto'>RememberFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1464"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, 
</span>                             <a href="md.c.html#LN55"><span class='Ref_to_Const'>UNLINK_RELATION_REQUEST</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Notify the checkpointer about it.  If we fail to queue the request 
         * message, we have to sleep and try again, because we can't simply 
         * delete the file now.  Ugly, but hopefully won't happen often. 
         * 
         * XXX should we just leave the file orphaned instead? 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postmaster/bgwriter.h.html#LN33"><span class='Ref_to_Proto'>ForwardFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1464"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Delimiter'>, 
</span>                                    <a href="md.c.html#LN55"><span class='Ref_to_Const'>UNLINK_RELATION_REQUEST</span></a><span class='Parentheses'>))</span> 
            <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>10000L</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* 10 msec seems a good number */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end register_unlink &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RememberFsyncRequest() -- callback from checkpointer side of fsync request 
 * 
 * We stuff fsync requests into the local hash table for execution 
 * during the checkpointer's next checkpoint.  UNLINK requests go into a 
 * separate linked list, however, because they get processed separately. 
 * 
 * The range of possible segment numbers is way less than the range of 
 * BlockNumber, so we can reserve high values of segno for special purposes. 
 * We define three: 
 * - FORGET_RELATION_FSYNC means to cancel pending fsyncs for a relation, 
 *   either for one fork, or all forks if forknum is InvalidForkNumber 
 * - FORGET_DATABASE_FSYNC means to cancel pending fsyncs for a whole database 
 * - UNLINK_RELATION_REQUEST is a request to delete the file after the next 
 *   checkpoint. 
 * Note also that we're assuming real segment numbers don't exceed INT_MAX. 
 * 
 * (Handling FORGET_DATABASE_FSYNC requests is a tad slow because the hash 
 * table has to be searched linearly, but dropping a database is a pretty 
 * heavyweight operation anyhow, so we'll live with it.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1513"></a><span class='Declare_Function'>RememberFsyncRequest</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>segno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>== </span><a href="md.c.html#LN53"><span class='Ref_to_Const'>FORGET_RELATION_FSYNC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Remove any pending requests for the relation (one or all forks) */ 
</span><a name="LN1520"></a>        <a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Delimiter'>, 
</span>                                                      <span class='Operator'>&</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, 
</span>                                                      <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, 
</span>                                                      <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We can't just delete the entry since mdsync could have an 
             * active hashtable scan.  Instead we delete the bitmapsets; this 
             * is safe because of the way mdsync is coded.  We also set the 
             * "canceled" flags so that mdsync can tell that a cancel arrived 
             * for the fork(s). 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>== </span><a href="../../../include/common/relpath.h.html#LN25"><span class='Ref_to_EnumConst'>InvalidForkNumber</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* remove requests for all forks */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* remove requests for single fork */ 
</span>                <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="md.c.html#LN1520"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if entry &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if segno==FORGET_RELATIO... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>== </span><a href="md.c.html#LN54"><span class='Ref_to_Const'>FORGET_DATABASE_FSYNC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Remove any pending requests for the entire database */ 
</span><a name="LN1557"></a>        <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hstat</span><span class='Delimiter'>; 
</span><a name="LN1558"></a>        <a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1559"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>, 
</span><a name="LN1560"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>, 
</span><a name="LN1561"></a>                   <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remove fsync requests */ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1557"><span class='Ref_To_Local'>hstat</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1558"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="md.c.html#LN1557"><span class='Ref_To_Local'>hstat</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1558"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN140"><span class='Ref_to_Member'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a> <span class='Operator'>== </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* remove requests for all forks */ 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/common/relpath.h.html#LN38"><span class='Ref_to_Const'>MAX_FORKNUM</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/nodes/bitmapset.h.html#LN68"><span class='Ref_to_Proto'>bms_free</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1558"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1558"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                    <a href="md.c.html#LN1558"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Remove unlink requests */ 
</span>        <a href="md.c.html#LN1560"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN75"><span class='Ref_to_Func'>list_head</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1561"><span class='Ref_To_Local'>next</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1583"></a>            <a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="md.c.html#LN1561"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN104"><span class='Ref_to_Macro'>lnext</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1583"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN150"><span class='Ref_to_Member'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a> <span class='Operator'>== </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN238"><span class='Ref_to_Proto'>list_delete_cell</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1560"><span class='Ref_To_Local'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1583"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="md.c.html#LN1560"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1559"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if segno==FORGET_DATABAS... &raquo; </span> 
    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>== </span><a href="md.c.html#LN55"><span class='Ref_to_Const'>UNLINK_RELATION_REQUEST</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Unlink request: put it in the linked list */ 
</span><a name="LN1598"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN156"><span class='Ref_to_Global_Var'>pendingOpsCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1599"></a>        <a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* PendingUnlinkEntry doesn't store forknum, since it's always MAIN */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a> <span class='Operator'>== </span><a href="../../../include/common/relpath.h.html#LN26"><span class='Ref_to_EnumConst'>MAIN_FORKNUM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN1599"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN148"><span class='Ref_to_Typedef'>PendingUnlinkEntry</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN1599"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN150"><span class='Ref_to_Member'>rnode</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>; 
</span>        <a href="md.c.html#LN1599"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN151"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>= </span><a href="md.c.html#LN159"><span class='Ref_to_Global_Var'>mdckpt_cycle_ctr</span></a><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN155"><span class='Ref_to_Global_Var'>pendingUnlinks</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1599"><span class='Ref_To_Local'>entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1598"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Normal case: enter a request to fsync this segment */ 
</span><a name="LN1615"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN156"><span class='Ref_to_Global_Var'>pendingOpsCxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1616"></a>        <a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN1617"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
        <a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="md.c.html#LN138"><span class='Ref_to_Typedef'>PendingOperationEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Delimiter'>, 
</span>                                                      <span class='Operator'>&</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, 
</span>                                                      <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                                      <span class='Operator'>&</span><a href="md.c.html#LN1617"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* if new entry, initialize it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN1617"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN141"><span class='Ref_to_Member'>cycle_ctr</span></a> <span class='Operator'>= </span><a href="md.c.html#LN158"><span class='Ref_to_Global_Var'>mdsync_cycle_ctr</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN145"><span class='Ref_to_Member'>canceled</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * NB: it's intentional that we don't change cycle_ctr if the entry 
         * already exists.  The cycle_ctr must represent the oldest fsync 
         * request that could be in the entry. 
         */ 
</span> 
        <a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1616"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN143"><span class='Ref_to_Member'>requests</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>], 
</span>                                                  <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="md.c.html#LN1513"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1615"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end RememberFsyncRequest &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ForgetRelationFsyncRequests -- forget any fsyncs for a relation fork 
 * 
 * forknum == InvalidForkNumber means all forks, although this code doesn't 
 * actually know that, since it's just forwarding the request elsewhere. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1651"></a><span class='Declare_Function'>ForgetRelationFsyncRequests</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Parameter'>rnode</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* standalone backend or startup process: fsync state is local */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN141"><span class='Ref_to_Proto'>RememberFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1651"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1651"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN53"><span class='Ref_to_Const'>FORGET_RELATION_FSYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Notify the checkpointer about it.  If we fail to queue the cancel 
         * message, we have to sleep and try again ... ugly, but hopefully 
         * won't happen often. 
         * 
         * XXX should we CHECK_FOR_INTERRUPTS in this loop?  Escaping with an 
         * error would leave the no-longer-used file still present on disk, 
         * which would be bad, so I'm inclined to assume that the checkpointer 
         * will always empty the queue soon. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postmaster/bgwriter.h.html#LN33"><span class='Ref_to_Proto'>ForwardFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1651"><span class='Ref_to_Parameter'>rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1651"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN53"><span class='Ref_to_Const'>FORGET_RELATION_FSYNC</span></a><span class='Parentheses'>))</span> 
            <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>10000L</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* 10 msec seems a good number */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Note we don't wait for the checkpointer to actually absorb the 
         * cancel message; see mdsync() for the implications. 
         */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsUnderPostmaster &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ForgetRelationFsyncRequests &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ForgetDatabaseFsyncRequests -- forget any fsyncs and unlinks for a DB 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1684"></a><span class='Declare_Function'>ForgetDatabaseFsyncRequests</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1686"></a>    <a href="../../../include/storage/relfilenode.h.html#LN56"><span class='Ref_to_Struct'>RelFileNode</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1686"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN59"><span class='Ref_to_Member'>dbNode</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1684"><span class='Ref_to_Parameter'>dbid</span></a><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN1686"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN58"><span class='Ref_to_Member'>spcNode</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN1686"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN60"><span class='Ref_to_Member'>relNode</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN154"><span class='Ref_to_Global_Var'>pendingOpsTable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* standalone backend or startup process: fsync state is local */ 
</span>        <a href="../../../include/storage/smgr.h.html#LN141"><span class='Ref_to_Proto'>RememberFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1686"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN25"><span class='Ref_to_EnumConst'>InvalidForkNumber</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN54"><span class='Ref_to_Const'>FORGET_DATABASE_FSYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../utils/init/globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* see notes in ForgetRelationFsyncRequests */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/postmaster/bgwriter.h.html#LN33"><span class='Ref_to_Proto'>ForwardFsyncRequest</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1686"><span class='Ref_To_Local'>rnode</span></a><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN25"><span class='Ref_to_EnumConst'>InvalidForkNumber</span></a><span class='Delimiter'>, 
</span>                                    <a href="md.c.html#LN54"><span class='Ref_to_Const'>FORGET_DATABASE_FSYNC</span></a><span class='Parentheses'>))</span> 
            <a href="../../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><span class='Number'>10000L</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* 10 msec seems a good number */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ForgetDatabaseFsyncRequests &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 *  _fdvec_resize() -- Resize the fork's open segments array 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1711"></a><span class='Declare_Function'>_fdvec_resize</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, 
</span><a name="LN1712"></a>              <a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, 
</span><a name="LN1713"></a>              <span class='Keyword'>int </span><span class='Declare_Parameter'>nseg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1713"><span class='Ref_to_Parameter'>nseg</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN114"><span class='Ref_to_Global_Var'>MdCxt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="md.c.html#LN1713"><span class='Ref_to_Parameter'>nseg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * It doesn't seem worthwhile complicating the code by having a more 
         * aggressive growth strategy here; the number of segments doesn't 
         * grow that fast, and the memory context internally will sometimes 
         * avoid doing an actual reallocation. 
         */ 
</span>        <a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>], 
</span>                     <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="md.c.html#LN1713"><span class='Ref_to_Parameter'>nseg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="md.c.html#LN1711"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1712"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="md.c.html#LN1713"><span class='Ref_to_Parameter'>nseg</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _fdvec_resize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the filename for the specified segment of the relation. The 
 * returned string is palloc'd. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1749"></a><span class='Declare_Function'>_mdfd_segpath</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>segno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1751"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span><span class='Delimiter'>, 
</span><a name="LN1752"></a>               <span class='Operator'>*</span><span class='Declare_Local'>fullpath</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1751"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN70"><span class='Ref_to_Macro'>relpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1749"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN42"><span class='Ref_to_Member'>smgr_rnode</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1749"><span class='Ref_to_Parameter'>forknum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1749"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN1752"><span class='Ref_To_Local'>fullpath</span></a> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s.%u"</span><span class='Delimiter'>, </span><a href="md.c.html#LN1751"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1749"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1751"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="md.c.html#LN1752"><span class='Ref_To_Local'>fullpath</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1751"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="md.c.html#LN1752"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Open the specified segment of the relation, 
 * and make a MdfdVec object for it.  Returns NULL on failure. 
 */ 
</span><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>* 
</span><a name="LN1772"></a><span class='Declare_Function'>_mdfd_openseg</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>segno</span><span class='Delimiter'>, 
</span><a name="LN1773"></a>              <span class='Keyword'>int </span><span class='Declare_Parameter'>oflags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1775"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1776"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1777"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fullpath</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1777"><span class='Ref_To_Local'>fullpath</span></a> <span class='Operator'>= </span><a href="md.c.html#LN191"><span class='Ref_to_Proto'>_mdfd_segpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* open the file */ 
</span>    <a href="md.c.html#LN1776"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN67"><span class='Ref_to_Proto'>PathNameOpenFile</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1777"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a> <span class='Operator'>| </span><a href="md.c.html#LN1773"><span class='Ref_to_Parameter'>oflags</span></a><span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1777"><span class='Ref_To_Local'>fullpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1776"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>&LT;= </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <a href="md.c.html#LN188"><span class='Ref_to_Proto'>_fdvec_resize</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>segno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* fill the entry */ 
</span>    <a href="md.c.html#LN1775"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>segno</span></a><span class='Delimiter'>]; 
</span>    <a href="md.c.html#LN1775"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1776"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>; 
</span>    <a href="md.c.html#LN1775"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>segno</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN197"><span class='Ref_to_Proto'>_mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1772"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1775"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;= </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* all done */ 
</span>    <span class='Control'>return</span> <a href="md.c.html#LN1775"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _mdfd_openseg &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *  _mdfd_getseg() -- Find the segment of the relation holding the 
 *      specified block. 
 * 
 * If the segment doesn't exist, we ereport, return NULL, or create the 
 * segment, according to "behavior".  Note: skipFsync is only used in the 
 * EXTENSION_CREATE case. 
 */ 
</span><span class='Keyword'>static </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>* 
</span><a name="LN1812"></a><span class='Declare_Function'>_mdfd_getseg</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>blkno</span><span class='Delimiter'>, 
</span><a name="LN1813"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>skipFsync</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>behavior</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1815"></a>    <a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1816"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>targetseg</span><span class='Delimiter'>; 
</span><a name="LN1817"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nextsegno</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* some way to handle non-existent segments needs to be specified */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& 
</span>           <span class='Parentheses'>(</span><a href="md.c.html#LN164"><span class='Ref_to_Const'>EXTENSION_FAIL</span></a> <span class='Operator'>| </span><a href="md.c.html#LN168"><span class='Ref_to_Const'>EXTENSION_CREATE</span></a> <span class='Operator'>| </span><a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1816"><span class='Ref_To_Local'>targetseg</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>blkno</span></a> <span class='Operator'>/ </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* if an existing and opened segment, we're done */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1816"><span class='Ref_To_Local'>targetseg</span></a> <span class='Operator'>&LT; </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN1816"><span class='Ref_To_Local'>targetseg</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>return</span> <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The target segment is not yet open. Iterate over all the segments 
     * between the last opened and the target segment. This way missing 
     * segments either raise an error, or get created (according to 
     * 'behavior'). Start with either the last opened, or the first segment if 
     * none was opened before. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= &</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN71"><span class='Ref_to_Member'>md_seg_fds</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>][</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN184"><span class='Ref_to_Proto'>mdopen</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* if behavior & EXTENSION_RETURN_NULL */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a> <span class='Operator'>= </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/smgr.h.html#LN70"><span class='Ref_to_Member'>md_num_open_segs</span></a><span class='Delimiter'>[</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>]; 
</span>         <a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a> <span class='Operator'>&LT;= </span><a href="md.c.html#LN1816"><span class='Ref_To_Local'>targetseg</span></a><span class='Delimiter'>; </span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1851"></a>        <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>nblocks</span> <span class='Operator'>= </span><a href="md.c.html#LN197"><span class='Ref_to_Proto'>_mdnblocks</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1852"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>flags</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a> <span class='Operator'>== </span><a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN111"><span class='Ref_to_Member'>mdfd_segno</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1851"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"segment too big"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN168"><span class='Ref_to_Const'>EXTENSION_CREATE</span></a><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="../../access/transam/xlog.c.html#LN191"><span class='Ref_to_Global_Var'>InRecovery</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN170"><span class='Ref_to_Const'>EXTENSION_CREATE_RECOVERY</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Normally we will create new segments only if authorized by the 
             * caller (i.e., we are doing mdextend()).  But when doing WAL 
             * recovery, create segments anyway; this allows cases such as 
             * replaying WAL data that has a write into a high-numbered 
             * segment of a relation that was later deleted. We want to go 
             * ahead and create the segments so we can finish out the replay. 
             * However if the caller has specified 
             * EXTENSION_REALLY_RETURN_NULL, then extension is not desired 
             * even in recovery; we won't reach this point in that case. 
             * 
             * We have to maintain the invariant that segments before the last 
             * active segment are of size RELSEG_SIZE; therefore, if 
             * extending, pad them out with zeroes if needed.  (This only 
             * matters if in recovery, or if the caller is extending the 
             * relation discontiguously, but that can happen in hash indexes.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1851"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1881"></a>                <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>zerobuf</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/smgr.h.html#LN122"><span class='Ref_to_Proto'>mdextend</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, 
</span>                         <a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a> <span class='Operator'>* </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                         <a href="md.c.html#LN1881"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>skipFsync</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1881"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="md.c.html#LN1852"><span class='Ref_To_Local'>flags</span></a> <span class='Operator'>= </span>O_CREAT<span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (behavior&EXTENSION_C... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN178"><span class='Ref_to_Const'>EXTENSION_DONT_CHECK_SIZE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>                 <a href="md.c.html#LN1851"><span class='Ref_To_Local'>nblocks</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span>RELSEG_SIZE<span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * When not extending (or explicitly including truncated 
             * segments), only open the next segment if the current one is 
             * exactly RELSEG_SIZE.  If not (this branch), either return NULL 
             * or fail. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Some callers discern between reasons for _mdfd_getseg() 
                 * returning NULL based on errno. As there's no failing 
                 * syscall involved in this case, explicitly set errno to 
                 * ENOENT, as that seems the closest interpretation. 
                 */ 
</span>                errno <span class='Operator'>= </span>ENOENT<span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\" (target block %u): previous segment is only %u blocks"</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN191"><span class='Ref_to_Proto'>_mdfd_segpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>blkno</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1851"><span class='Ref_To_Local'>nblocks</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !(behavior&EXTENSION_... &raquo; </span> 
 
        <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>= </span><a href="md.c.html#LN193"><span class='Ref_to_Proto'>_mdfd_openseg</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1852"><span class='Ref_To_Local'>flags</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="md.c.html#LN1813"><span class='Ref_to_Parameter'>behavior</span></a> <span class='Operator'>& </span><a href="md.c.html#LN166"><span class='Ref_to_Const'>EXTENSION_RETURN_NULL</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>                <a href="md.c.html#LN65"><span class='Ref_to_Macro'>FILE_POSSIBLY_DELETED</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                   <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\" (target block %u): %m"</span><span class='Delimiter'>, 
</span>                          <a href="md.c.html#LN191"><span class='Ref_to_Proto'>_mdfd_segpath</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>reln</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>forknum</span></a><span class='Delimiter'>, </span><a href="md.c.html#LN1817"><span class='Ref_To_Local'>nextsegno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <a href="md.c.html#LN1812"><span class='Ref_to_Parameter'>blkno</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for nextsegno=reln-&GT;md_nu... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="md.c.html#LN1815"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end _mdfd_getseg &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get number of blocks present in a single disk file 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN1940"></a><span class='Declare_Function'>_mdnblocks</span><span class='Parentheses'>(</span><a href="../../../include/storage/smgr.h.html#LN77"><span class='Ref_to_Typedef'>SMgrRelation</span></a> <span class='Declare_Parameter'>reln</span><span class='Delimiter'>, </span><a href="../../../include/common/relpath.h.html#LN23"><span class='Ref_to_Enum'>ForkNumber</span></a> <span class='Declare_Parameter'>forknum</span><span class='Delimiter'>, </span><a href="md.c.html#LN108"><span class='Ref_to_Typedef'>MdfdVec</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>seg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1942"></a>    off_t       <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
    <a href="md.c.html#LN1942"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN74"><span class='Ref_to_Proto'>FileSeek</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1940"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Delimiter'>, </span><span class='Number'>0L</span><span class='Delimiter'>, </span>SEEK_END<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="md.c.html#LN1942"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../../utils/error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not seek to end of file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/fd.h.html#LN77"><span class='Ref_to_Proto'>FilePathName</span></a><span class='Parentheses'>(</span><a href="md.c.html#LN1940"><span class='Ref_to_Parameter'>seg</span></a><span class='Operator'>-&GT;</span><a href="md.c.html#LN110"><span class='Ref_to_Member'>mdfd_vfd</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* note that this calculation will ignore any partial block at EOF */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) (</span><a href="md.c.html#LN1942"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>/ </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>