<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\adt\array_selfuncs.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\adt\array_selfuncs.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:50 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * array_selfuncs.c 
 *    Functions for selectivity estimation of array operators 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/adt/array_selfuncs.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_operator.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_statistic.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/clauses.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/array.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/selfuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Default selectivity constant for "@&GT;" and "&LT;@" operators */ 
</span><a name="LN31"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEFAULT_CONTAIN_SEL</span> <span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>005</span> 
 
<span class='Comment_Multi_Line'>/* Default selectivity constant for "&&" operator */ 
</span><a name="LN34"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEFAULT_OVERLAP_SEL</span> <span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>01</span> 
 
<span class='Comment_Multi_Line'>/* Default selectivity for given operator */ 
</span><a name="LN37"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DEFAULT_SEL</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>operator</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><span class='Keyword'>operator</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1565"><span class='Ref_to_Const'>OID_ARRAY_OVERLAP_OP</span></a> <span class='Operator'>? \ 
</span>        <a href="network_selfuncs.c.html#LN32"><span class='Ref_to_Const'>DEFAULT_OVERLAP_SEL</span></a> <span class='Operator'>: </span><a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Parentheses'>)</span> 
 
<a name="LN41"></a><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Prototype'>calc_arraycontsel</span><span class='Parentheses'>(</span><a href="../../../include/utils/selfuncs.h.html#LN66"><span class='Ref_to_Struct'>VariableStatData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vardata</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>constval</span><span class='Delimiter'>, 
</span><a name="LN42"></a>                  <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>elemtype</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN43"></a><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Prototype'>mcelem_array_selec</span><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array</span><span class='Delimiter'>, 
</span><a name="LN44"></a>                   <a href="../../../include/utils/typcache.h.html#LN28"><span class='Ref_to_Struct'>TypeCacheEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typentry</span><span class='Delimiter'>, 
</span><a name="LN45"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN46"></a>                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN47"></a>                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, 
</span><a name="LN48"></a>                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Prototype'>mcelem_array_contain_overlap_selec</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN50"></a>                                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN51"></a>                                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array_data</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN52"></a>                                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN53"></a><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Prototype'>mcelem_array_contained_selec</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN54"></a>                             <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN55"></a>                             <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array_data</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN56"></a>                             <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, 
</span><a name="LN57"></a>                             <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN58"></a><span class='Keyword'>static float </span><span class='Operator'>*</span><span class='Declare_Prototype'>calc_hist</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN59"></a><span class='Keyword'>static float </span><span class='Operator'>*</span><span class='Declare_Prototype'>calc_distr</span><span class='Parentheses'>(</span><span class='Keyword'>const float </span><span class='Operator'>*</span><span class='Declare_Parameter'>p</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>m</span><span class='Delimiter'>, </span><span class='Keyword'>float </span><span class='Declare_Parameter'>rest</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN60"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>floor_log2</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN61"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>find_next_mcelem</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, 
</span><a name="LN62"></a>                 <span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>element_compare</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key2</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>float_compare_desc</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * scalararraysel_containment 
 *      Estimate selectivity of ScalarArrayOpExpr via array containment. 
 * 
 * If we have const =/&LT;&GT; ANY/ALL (array_var) then we can estimate the 
 * selectivity as though this were an array containment operator, 
 * array_var op ARRAY[const]. 
 * 
 * scalararraysel() has already verified that the ScalarArrayOpExpr's operator 
 * is the array element type's default equality or inequality operator, and 
 * has aggressively simplified both inputs to constants. 
 * 
 * Returns selectivity (0..1), or -1 if we fail to estimate selectivity. 
 */ 
</span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> 
<a name="LN82"></a><span class='Declare_Function'>scalararraysel_containment</span><span class='Parentheses'>(</span><a href="../../../include/nodes/relation.h.html#LN150"><span class='Ref_to_Struct'>PlannerInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>root</span><span class='Delimiter'>, 
</span><a name="LN83"></a>                           <a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>leftop</span><span class='Delimiter'>, </span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>rightop</span><span class='Delimiter'>, 
</span><a name="LN84"></a>                           <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>elemtype</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isEquality</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>useOr</span><span class='Delimiter'>, 
</span><a name="LN85"></a>                           <span class='Keyword'>int </span><span class='Declare_Parameter'>varRelid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Local'>selec</span><span class='Delimiter'>; 
</span><a name="LN88"></a>    <a href="../../../include/utils/selfuncs.h.html#LN66"><span class='Ref_to_Struct'>VariableStatData</span></a> <span class='Declare_Local'>vardata</span><span class='Delimiter'>; 
</span><a name="LN89"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>constval</span><span class='Delimiter'>; 
</span><a name="LN90"></a>    <a href="../../../include/utils/typcache.h.html#LN28"><span class='Ref_to_Struct'>TypeCacheEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>typentry</span><span class='Delimiter'>; 
</span><a name="LN91"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cmpfunc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * rightop must be a variable, else punt. 
     */ 
</span>    <a href="../../../include/utils/selfuncs.h.html#LN154"><span class='Ref_to_Proto'>examine_variable</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN82"><span class='Ref_to_Parameter'>root</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN83"><span class='Ref_to_Parameter'>rightop</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN85"><span class='Ref_to_Parameter'>varRelid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN69"><span class='Ref_to_Member'>rel</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * leftop must be a constant, else punt. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN83"><span class='Ref_to_Parameter'>leftop</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN83"><span class='Ref_to_Parameter'>leftop</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>constisnull<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* qual can't succeed if null on left */ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN83"><span class='Ref_to_Parameter'>leftop</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>constvalue<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get element type's default comparison function */ 
</span>    <a href="array_selfuncs.c.html#LN90"><span class='Ref_To_Local'>typentry</span></a> <span class='Operator'>= </span><a href="../../../include/utils/typcache.h.html#LN142"><span class='Ref_to_Proto'>lookup_type_cache</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>elemtype</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/typcache.h.html#LN115"><span class='Ref_to_Const'>TYPECACHE_CMP_PROC_FINFO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN90"><span class='Ref_To_Local'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN67"><span class='Ref_to_Member'>cmp_proc_finfo</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a> <span class='Operator'>= &</span><a href="array_selfuncs.c.html#LN90"><span class='Ref_To_Local'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN67"><span class='Ref_to_Member'>cmp_proc_finfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the operator is &LT;&GT;, swap ANY/ALL, then invert the result later. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>isEquality</span></a><span class='Parentheses'>) 
</span>        <a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a> <span class='Operator'>= !</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get array element stats for var, if available */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN156"><span class='Ref_to_Proto'>statistic_proc_security_check</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN138"></a>        <a href="../../../include/catalog/pg_statistic.h.html#LN128"><span class='Ref_to_Typedef'>Form_pg_statistic</span></a> <span class='Declare_Local'>stats</span><span class='Delimiter'>; 
</span><a name="LN139"></a>        <a href="../../../include/utils/lsyscache.h.html#LN42"><span class='Ref_to_Struct'>AttStatsSlot</span></a> <span class='Declare_Local'>sslot</span><span class='Delimiter'>; 
</span><a name="LN140"></a>        <a href="../../../include/utils/lsyscache.h.html#LN42"><span class='Ref_to_Struct'>AttStatsSlot</span></a> <span class='Declare_Local'>hslot</span><span class='Delimiter'>; 
</span> 
        <a href="array_selfuncs.c.html#LN138"><span class='Ref_To_Local'>stats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_statistic.h.html#LN128"><span class='Ref_to_Typedef'>Form_pg_statistic</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* MCELEM will be an array of same type as element */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN172"><span class='Ref_to_Proto'>get_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_statistic.h.html#LN256"><span class='Ref_to_Const'>STATISTIC_KIND_MCELEM</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/lsyscache.h.html#LN38"><span class='Ref_to_Const'>ATTSTATSSLOT_VALUES</span></a> <span class='Operator'>| </span><a href="../../../include/utils/lsyscache.h.html#LN39"><span class='Ref_to_Const'>ATTSTATSSLOT_NUMBERS</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* For ALL case, also get histogram of distinct-element counts */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/utils/lsyscache.h.html#LN172"><span class='Ref_to_Proto'>get_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/catalog/pg_statistic.h.html#LN269"><span class='Ref_to_Const'>STATISTIC_KIND_DECHIST</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/utils/lsyscache.h.html#LN39"><span class='Ref_to_Const'>ATTSTATSSLOT_NUMBERS</span></a><span class='Parentheses'>))</span> 
                memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * For = ANY, estimate as var @&GT; ARRAY[const]. 
             * 
             * For = ALL, estimate as var &LT;@ ARRAY[const]. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN49"><span class='Ref_to_Proto'>mcelem_array_contain_overlap_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN48"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, 
</span>                                                           <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN49"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>, 
</span>                                                           <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>, 
</span>                                                           <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN52"><span class='Ref_to_Member'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                                           <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                       <a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Delimiter'>, 
</span>                                                           <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN53"><span class='Ref_to_Proto'>mcelem_array_contained_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN48"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN49"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN52"><span class='Ref_to_Member'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN52"><span class='Ref_to_Member'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                                     <a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN140"><span class='Ref_To_Local'>hslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN139"><span class='Ref_To_Local'>sslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if get_attstatsslot(&ssl... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* No most-common-elements info, so do without */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN49"><span class='Ref_to_Proto'>mcelem_array_contain_overlap_selec</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                           <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                       <a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Delimiter'>, 
</span>                                                           <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN53"><span class='Ref_to_Proto'>mcelem_array_contained_selec</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                     <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                     <a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Delimiter'>, 
</span>                                                     <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * MCE stats count only non-null rows, so adjust for null rows. 
         */ 
</span>        <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN138"><span class='Ref_To_Local'>stats</span></a><span class='Operator'>-&GT;</span>stanullfrac<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HeapTupleIsValid(vard... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No stats at all, so do without */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>useOr</span></a><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN49"><span class='Ref_to_Proto'>mcelem_array_contain_overlap_selec</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                       <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                       <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                       <a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Delimiter'>, 
</span>                                                       <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN53"><span class='Ref_to_Proto'>mcelem_array_contained_selec</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN89"><span class='Ref_To_Local'>constval</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                                 <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Delimiter'>, 
</span>                                                 <a href="array_selfuncs.c.html#LN91"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* we assume no nulls here, so no stanullfrac correction */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN88"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the operator is &LT;&GT;, invert the results. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="array_selfuncs.c.html#LN84"><span class='Ref_to_Parameter'>isEquality</span></a><span class='Parentheses'>) 
</span>        <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/selfuncs.h.html#LN56"><span class='Ref_to_Macro'>CLAMP_PROBABILITY</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN87"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end scalararraysel_containment &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * arraycontsel -- restriction selectivity for array @&GT;, &&, &LT;@ operators 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN242"></a><span class='Declare_Function'>arraycontsel</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN244"></a>    <a href="../../../include/nodes/relation.h.html#LN150"><span class='Ref_to_Struct'>PlannerInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/relation.h.html#LN150"><span class='Ref_to_Struct'>PlannerInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN245"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Keyword'>operator </span><span class='Operator'>= </span><span class='Declare_Local'>PG_GETARG_OID</span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN246"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>args</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN247"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>varRelid</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN233"><span class='Ref_to_Macro'>PG_GETARG_INT32</span></a><span class='Parentheses'>(</span><span class='Number'>3</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN248"></a>    <a href="../../../include/utils/selfuncs.h.html#LN66"><span class='Ref_to_Struct'>VariableStatData</span></a> <span class='Declare_Local'>vardata</span><span class='Delimiter'>; 
</span><a name="LN249"></a>    <a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>other</span><span class='Delimiter'>; 
</span><a name="LN250"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>varonleft</span><span class='Delimiter'>; 
</span><a name="LN251"></a>    <a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Local'>selec</span><span class='Delimiter'>; 
</span><a name="LN252"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>element_typeid</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If expression is not (variable op something) or (something op 
     * variable), then punt and return a default estimate. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/selfuncs.h.html#LN157"><span class='Ref_to_Proto'>get_restriction_variable</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN244"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN246"><span class='Ref_To_Local'>args</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN247"><span class='Ref_To_Local'>varRelid</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN249"><span class='Ref_To_Local'>other</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN250"><span class='Ref_To_Local'>varonleft</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN37"><span class='Ref_to_Macro'>DEFAULT_SEL</span></a><span class='Parentheses'>(</span><span class='Keyword'>operator</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Can't do anything useful if the something is not a constant, either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN249"><span class='Ref_To_Local'>other</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN37"><span class='Ref_to_Macro'>DEFAULT_SEL</span></a><span class='Parentheses'>(</span><span class='Keyword'>operator</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The "&&", "@&GT;" and "&LT;@" operators are strict, so we can cope with a 
     * NULL constant right away. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN249"><span class='Ref_To_Local'>other</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>constisnull<span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If var is on the right, commute the operator, so that we can assume the 
     * var is on the left in what follows. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="array_selfuncs.c.html#LN250"><span class='Ref_To_Local'>varonleft</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Parentheses'>) 
</span>            <span class='Keyword'>operator </span><span class='Operator'>= </span><a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Parentheses'>) 
</span>            <span class='Keyword'>operator </span><span class='Operator'>= </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK, there's a Var and a Const we're dealing with here.  We need the 
     * Const to be an array with same element type as column, else we can't do 
     * anything useful.  (Such cases will likely fail at runtime, but here 
     * we'd rather just return a default estimate.) 
     */ 
</span>    <a href="array_selfuncs.c.html#LN252"><span class='Ref_To_Local'>element_typeid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/lsyscache.h.html#LN160"><span class='Ref_to_Proto'>get_base_element_type</span></a><span class='Parentheses'>(((</span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN249"><span class='Ref_To_Local'>other</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>consttype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN252"><span class='Ref_To_Local'>element_typeid</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>&& 
</span>        <a href="array_selfuncs.c.html#LN252"><span class='Ref_To_Local'>element_typeid</span></a> <span class='Operator'>== </span><a href="../../../include/utils/lsyscache.h.html#LN160"><span class='Ref_to_Proto'>get_base_element_type</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Operator'>.</span><a href="../../../include/utils/selfuncs.h.html#LN73"><span class='Ref_to_Member'>vartype</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN251"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN41"><span class='Ref_to_Proto'>calc_arraycontsel</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Delimiter'>, </span><span class='Parentheses'>((</span><a href="../../../include/nodes/primnodes.h.html#LN188"><span class='Ref_to_Struct'>Const</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN249"><span class='Ref_To_Local'>other</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>constvalue<span class='Delimiter'>, 
</span>                                  <a href="array_selfuncs.c.html#LN252"><span class='Ref_To_Local'>element_typeid</span></a><span class='Delimiter'>, </span><span class='Keyword'>operator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN251"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN37"><span class='Ref_to_Macro'>DEFAULT_SEL</span></a><span class='Parentheses'>(</span><span class='Keyword'>operator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/selfuncs.h.html#LN80"><span class='Ref_to_Macro'>ReleaseVariableStats</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN248"><span class='Ref_To_Local'>vardata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/selfuncs.h.html#LN56"><span class='Ref_to_Macro'>CLAMP_PROBABILITY</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN251"><span class='Ref_To_Local'>selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN380"><span class='Ref_to_Typedef'>float8</span></a><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN251"><span class='Ref_To_Local'>selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end arraycontsel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * arraycontjoinsel -- join selectivity for array @&GT;, &&, &LT;@ operators 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN322"></a><span class='Declare_Function'>arraycontjoinsel</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* For the moment this is just a stub */ 
</span><a name="LN325"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Keyword'>operator </span><span class='Operator'>= </span><span class='Declare_Local'>PG_GETARG_OID</span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN37"><span class='Ref_to_Macro'>DEFAULT_SEL</span></a><span class='Parentheses'>(</span><span class='Keyword'>operator</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Calculate selectivity for "arraycolumn @&GT; const", "arraycolumn && const" 
 * or "arraycolumn &LT;@ const" based on the statistics 
 * 
 * This function is mainly responsible for extracting the pg_statistic data 
 * to be used; we then pass the problem on to mcelem_array_selec(). 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> 
<a name="LN338"></a><span class='Declare_Function'>calc_arraycontsel</span><span class='Parentheses'>(</span><a href="../../../include/utils/selfuncs.h.html#LN66"><span class='Ref_to_Struct'>VariableStatData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vardata</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>constval</span><span class='Delimiter'>, 
</span><a name="LN339"></a>                  <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>elemtype</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN341"></a>    <a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Local'>selec</span><span class='Delimiter'>; 
</span><a name="LN342"></a>    <a href="../../../include/utils/typcache.h.html#LN28"><span class='Ref_to_Struct'>TypeCacheEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>typentry</span><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cmpfunc</span><span class='Delimiter'>; 
</span><a name="LN344"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>array</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get element type's default comparison function */ 
</span>    <a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a> <span class='Operator'>= </span><a href="../../../include/utils/typcache.h.html#LN142"><span class='Ref_to_Proto'>lookup_type_cache</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN339"><span class='Ref_to_Parameter'>elemtype</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/typcache.h.html#LN115"><span class='Ref_to_Const'>TYPECACHE_CMP_PROC_FINFO</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN67"><span class='Ref_to_Member'>cmp_proc_finfo</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN37"><span class='Ref_to_Macro'>DEFAULT_SEL</span></a><span class='Parentheses'>(</span><span class='Keyword'>operator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="array_selfuncs.c.html#LN343"><span class='Ref_To_Local'>cmpfunc</span></a> <span class='Operator'>= &</span><a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN67"><span class='Ref_to_Member'>cmp_proc_finfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The caller made sure the const is an array with same element type, so 
     * get it now 
     */ 
</span>    <a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>constval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>vardata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN156"><span class='Ref_to_Proto'>statistic_proc_security_check</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>vardata</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN343"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN361"></a>        <a href="../../../include/catalog/pg_statistic.h.html#LN128"><span class='Ref_to_Typedef'>Form_pg_statistic</span></a> <span class='Declare_Local'>stats</span><span class='Delimiter'>; 
</span><a name="LN362"></a>        <a href="../../../include/utils/lsyscache.h.html#LN42"><span class='Ref_to_Struct'>AttStatsSlot</span></a> <span class='Declare_Local'>sslot</span><span class='Delimiter'>; 
</span><a name="LN363"></a>        <a href="../../../include/utils/lsyscache.h.html#LN42"><span class='Ref_to_Struct'>AttStatsSlot</span></a> <span class='Declare_Local'>hslot</span><span class='Delimiter'>; 
</span> 
        <a href="array_selfuncs.c.html#LN361"><span class='Ref_To_Local'>stats</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_statistic.h.html#LN128"><span class='Ref_to_Typedef'>Form_pg_statistic</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>vardata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* MCELEM will be an array of same type as column */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN172"><span class='Ref_to_Proto'>get_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>vardata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_statistic.h.html#LN256"><span class='Ref_to_Const'>STATISTIC_KIND_MCELEM</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/lsyscache.h.html#LN38"><span class='Ref_to_Const'>ATTSTATSSLOT_VALUES</span></a> <span class='Operator'>| </span><a href="../../../include/utils/lsyscache.h.html#LN39"><span class='Ref_to_Const'>ATTSTATSSLOT_NUMBERS</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * For "array &LT;@ const" case we also need histogram of distinct 
             * element counts. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>!= </span><a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a> <span class='Operator'>|| 
</span>                <span class='Operator'>!</span><a href="../../../include/utils/lsyscache.h.html#LN172"><span class='Ref_to_Proto'>get_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>vardata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/selfuncs.h.html#LN70"><span class='Ref_to_Member'>statsTuple</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/catalog/pg_statistic.h.html#LN269"><span class='Ref_to_Const'>STATISTIC_KIND_DECHIST</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/utils/lsyscache.h.html#LN39"><span class='Ref_to_Const'>ATTSTATSSLOT_NUMBERS</span></a><span class='Parentheses'>))</span> 
                memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Use the most-common-elements slot for the array Var. */ 
</span>            <a href="array_selfuncs.c.html#LN341"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN43"><span class='Ref_to_Proto'>mcelem_array_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a><span class='Delimiter'>, 
</span>                                       <a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN48"><span class='Ref_to_Member'>values</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN49"><span class='Ref_to_Member'>nvalues</span></a><span class='Delimiter'>, 
</span>                                       <a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN52"><span class='Ref_to_Member'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                       <a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN51"><span class='Ref_to_Member'>numbers</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Operator'>.</span><a href="../../../include/utils/lsyscache.h.html#LN52"><span class='Ref_to_Member'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                       <span class='Keyword'>operator</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN343"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN363"><span class='Ref_To_Local'>hslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/lsyscache.h.html#LN174"><span class='Ref_to_Proto'>free_attstatsslot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN362"><span class='Ref_To_Local'>sslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if get_attstatsslot(&ssl... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* No most-common-elements info, so do without */ 
</span>            <a href="array_selfuncs.c.html#LN341"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN43"><span class='Ref_to_Proto'>mcelem_array_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a><span class='Delimiter'>, 
</span>                                       <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                       <span class='Keyword'>operator</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN343"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * MCE stats count only non-null rows, so adjust for null rows. 
         */ 
</span>        <a href="array_selfuncs.c.html#LN341"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN361"><span class='Ref_To_Local'>stats</span></a><span class='Operator'>-&GT;</span>stanullfrac<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if HeapTupleIsValid(vard... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* No stats at all, so do without */ 
</span>        <a href="array_selfuncs.c.html#LN341"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN43"><span class='Ref_to_Proto'>mcelem_array_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN342"><span class='Ref_To_Local'>typentry</span></a><span class='Delimiter'>, 
</span>                                   <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>operator</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN343"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* we assume no nulls here, so no stanullfrac correction */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* If constant was toasted, release the copy we made */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="array_selfuncs.c.html#LN338"><span class='Ref_to_Parameter'>constval</span></a><span class='Parentheses'>)</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN344"><span class='Ref_To_Local'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN341"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end calc_arraycontsel &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Array selectivity estimation based on most common elements statistics 
 * 
 * This function just deconstructs and sorts the array constant's contents, 
 * and then passes the problem on to mcelem_array_contain_overlap_selec or 
 * mcelem_array_contained_selec depending on the operator. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> 
<a name="LN429"></a><span class='Declare_Function'>mcelem_array_selec</span><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array</span><span class='Delimiter'>, </span><a href="../../../include/utils/typcache.h.html#LN28"><span class='Ref_to_Struct'>TypeCacheEntry</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>typentry</span><span class='Delimiter'>, 
</span><a name="LN430"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN431"></a>                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN432"></a>                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, 
</span><a name="LN433"></a>                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN435"></a>    <a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Local'>selec</span><span class='Delimiter'>; 
</span><a name="LN436"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_elems</span><span class='Delimiter'>; 
</span><a name="LN437"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>elem_values</span><span class='Delimiter'>; 
</span><a name="LN438"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>elem_nulls</span><span class='Delimiter'>; 
</span><a name="LN439"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>null_present</span><span class='Delimiter'>; 
</span><a name="LN440"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nonnull_nitems</span><span class='Delimiter'>; 
</span><a name="LN441"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prepare constant array data for sorting.  Sorting lets us find unique 
     * elements and efficiently merge with the MCELEM array. 
     */ 
</span>    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN429"><span class='Ref_to_Parameter'>array</span></a><span class='Delimiter'>, 
</span>                      <a href="array_selfuncs.c.html#LN429"><span class='Ref_to_Parameter'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN31"><span class='Ref_to_Member'>type_id</span></a><span class='Delimiter'>, 
</span>                      <a href="array_selfuncs.c.html#LN429"><span class='Ref_to_Parameter'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN34"><span class='Ref_to_Member'>typlen</span></a><span class='Delimiter'>, 
</span>                      <a href="array_selfuncs.c.html#LN429"><span class='Ref_to_Parameter'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN35"><span class='Ref_to_Member'>typbyval</span></a><span class='Delimiter'>, 
</span>                      <a href="array_selfuncs.c.html#LN429"><span class='Ref_to_Parameter'>typentry</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/typcache.h.html#LN36"><span class='Ref_to_Member'>typalign</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN438"><span class='Ref_To_Local'>elem_nulls</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN436"><span class='Ref_To_Local'>num_elems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Collapse out any null elements */ 
</span>    <a href="array_selfuncs.c.html#LN440"><span class='Ref_To_Local'>nonnull_nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="array_selfuncs.c.html#LN439"><span class='Ref_To_Local'>null_present</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN441"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN441"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN436"><span class='Ref_To_Local'>num_elems</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN441"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN438"><span class='Ref_To_Local'>elem_nulls</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN441"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN439"><span class='Ref_To_Local'>null_present</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN440"><span class='Ref_To_Local'>nonnull_nitems</span></a><span class='Operator'>++</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN441"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Query "column @&GT; '{anything, null}'" matches nothing.  For the other 
     * two operators, presence of a null in the constant can be ignored. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN439"><span class='Ref_To_Local'>null_present</span></a> <span class='Operator'>&& </span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN438"><span class='Ref_To_Local'>elem_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Sort extracted elements using their default comparison function. */ 
</span>    <a href="../../../port/qsort_arg.c.html#LN111"><span class='Ref_to_Func'>qsort_arg</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN440"><span class='Ref_To_Local'>nonnull_nitems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN433"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Separate cases according to operator */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a> <span class='Operator'>|| </span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1565"><span class='Ref_to_Const'>OID_ARRAY_OVERLAP_OP</span></a><span class='Parentheses'>) 
</span>        <a href="array_selfuncs.c.html#LN435"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN49"><span class='Ref_to_Proto'>mcelem_array_contain_overlap_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN430"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN430"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>, 
</span>                                                   <a href="array_selfuncs.c.html#LN431"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN431"><span class='Ref_to_Parameter'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                                 <a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN440"><span class='Ref_To_Local'>nonnull_nitems</span></a><span class='Delimiter'>, 
</span>                                                   <span class='Keyword'>operator</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN433"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1571"><span class='Ref_to_Const'>OID_ARRAY_CONTAINED_OP</span></a><span class='Parentheses'>) 
</span>        <a href="array_selfuncs.c.html#LN435"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN53"><span class='Ref_to_Proto'>mcelem_array_contained_selec</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN430"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN430"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>, 
</span>                                             <a href="array_selfuncs.c.html#LN431"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN431"><span class='Ref_to_Parameter'>nnumbers</span></a><span class='Delimiter'>, 
</span>                                             <a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN440"><span class='Ref_To_Local'>nonnull_nitems</span></a><span class='Delimiter'>, 
</span>                                             <a href="array_selfuncs.c.html#LN432"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN432"><span class='Ref_to_Parameter'>nhist</span></a><span class='Delimiter'>, 
</span>                                             <span class='Keyword'>operator</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN433"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"arraycontsel called for unrecognized operator %u"</span><span class='Delimiter'>, 
</span>             <span class='Keyword'>operator</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN435"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN437"><span class='Ref_To_Local'>elem_values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN438"><span class='Ref_To_Local'>elem_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN435"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mcelem_array_selec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate selectivity of "column @&GT; const" and "column && const" based on 
 * most common element statistics.  This estimation assumes element 
 * occurrences are independent. 
 * 
 * mcelem (of length nmcelem) and numbers (of length nnumbers) are from 
 * the array column's MCELEM statistics slot, or are NULL/0 if stats are 
 * not available.  array_data (of length nitems) is the constant's elements. 
 * 
 * Both the mcelem and array_data arrays are assumed presorted according 
 * to the element type's cmpfunc.  Null elements are not present. 
 * 
 * TODO: this estimate probably could be improved by using the distinct 
 * elements count histogram.  For example, excepting the special case of 
 * "column @&GT; '{}'", we can multiply the calculated selectivity by the 
 * fraction of nonempty arrays in the column. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> 
<a name="LN522"></a><span class='Declare_Function'>mcelem_array_contain_overlap_selec</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN523"></a>                                   <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN524"></a>                                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array_data</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN525"></a>                                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN527"></a>    <a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> <span class='Declare_Local'>selec</span><span class='Delimiter'>, 
</span><a name="LN528"></a>                <span class='Declare_Local'>elem_selec</span><span class='Delimiter'>; 
</span><a name="LN529"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mcelem_index</span><span class='Delimiter'>, 
</span><a name="LN530"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN531"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>use_bsearch</span><span class='Delimiter'>; 
</span><a name="LN532"></a>    <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a>      <span class='Declare_Local'>minfreq</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be three more Numbers than Values, because the last three 
     * cells should hold minimal and maximal frequency among the non-null 
     * elements, and then the frequency of null elements.  Ignore the Numbers 
     * if not right. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>nnumbers</span></a> <span class='Operator'>!= </span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>numbers</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>nnumbers</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>numbers</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Grab the lowest observed frequency */ 
</span>        <a href="array_selfuncs.c.html#LN532"><span class='Ref_To_Local'>minfreq</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Without statistics make some default assumptions */ 
</span>        <a href="array_selfuncs.c.html#LN532"><span class='Ref_To_Local'>minfreq</span></a> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Decide whether it is faster to use binary search or not. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>nitems</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN60"><span class='Ref_to_Proto'>floor_log2</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span> 
        <a href="array_selfuncs.c.html#LN531"><span class='Ref_To_Local'>use_bsearch</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="array_selfuncs.c.html#LN531"><span class='Ref_To_Local'>use_bsearch</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Initial selectivity for "column @&GT; const" query is 1.0, and it will 
         * be decreased with each element of constant array. 
         */ 
</span>        <a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Initial selectivity for "column && const" query is 0.0, and it will 
         * be increased with each element of constant array. 
         */ 
</span>        <a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Scan mcelem and array in parallel. */ 
</span>    <a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN584"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>match</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore any duplicates in the array data. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="array_selfuncs.c.html#LN525"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find the smallest MCELEM &GT;= this array item. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN531"><span class='Ref_To_Local'>use_bsearch</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="array_selfuncs.c.html#LN584"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN61"><span class='Ref_to_Proto'>find_next_mcelem</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                     <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN525"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN601"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>cmp</span> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN522"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>], 
</span>                                                  <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN524"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN530"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                                  <a href="array_selfuncs.c.html#LN525"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN601"><span class='Ref_To_Local'>cmp</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN601"><span class='Ref_To_Local'>cmp</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="array_selfuncs.c.html#LN584"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* mcelem is found */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN584"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>&& </span><a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>numbers</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* MCELEM matches the array item; use its frequency. */ 
</span>            <a href="array_selfuncs.c.html#LN528"><span class='Ref_To_Local'>elem_selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN523"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]; 
</span>            <a href="array_selfuncs.c.html#LN529"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The element is not in MCELEM.  Punt, but assume that the 
             * selectivity cannot be more than minfreq / 2. 
             */ 
</span>            <a href="array_selfuncs.c.html#LN528"><span class='Ref_To_Local'>elem_selec</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN532"><span class='Ref_To_Local'>minfreq</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Update overall selectivity using the current element's selectivity 
         * and an assumption of element occurrence independence. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>operator </span><span class='Operator'>== </span><a href="../../../include/catalog/pg_operator.h.html#LN1568"><span class='Ref_to_Const'>OID_ARRAY_CONTAINS_OP</span></a><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>*= </span><a href="array_selfuncs.c.html#LN528"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN528"><span class='Ref_To_Local'>elem_selec</span></a> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN528"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Clamp intermediate results to stay sane despite roundoff error */ 
</span>        <a href="../../../include/utils/selfuncs.h.html#LN56"><span class='Ref_to_Macro'>CLAMP_PROBABILITY</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nitems;i++ &raquo; </span> 
 
    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN527"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mcelem_array_contain_overlap_selec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate selectivity of "column &LT;@ const" based on most common element 
 * statistics. 
 * 
 * mcelem (of length nmcelem) and numbers (of length nnumbers) are from 
 * the array column's MCELEM statistics slot, or are NULL/0 if stats are 
 * not available.  array_data (of length nitems) is the constant's elements. 
 * hist (of length nhist) is from the array column's DECHIST statistics slot, 
 * or is NULL/0 if those stats are not available. 
 * 
 * Both the mcelem and array_data arrays are assumed presorted according 
 * to the element type's cmpfunc.  Null elements are not present. 
 * 
 * Independent element occurrence would imply a particular distribution of 
 * distinct element counts among matching rows.  Real data usually falsifies 
 * that assumption.  For example, in a set of 11-element integer arrays having 
 * elements in the range [0..10], element occurrences are typically not 
 * independent.  If they were, a sufficiently-large set would include all 
 * distinct element counts 0 through 11.  We correct for this using the 
 * histogram of distinct element counts. 
 * 
 * In the "column @&GT; const" and "column && const" cases, we usually have a 
 * "const" with low number of elements (otherwise we have selectivity close 
 * to 0 or 1 respectively).  That's why the effect of dependence related 
 * to distinct element count distribution is negligible there.  In the 
 * "column &LT;@ const" case, number of elements is usually high (otherwise we 
 * have selectivity close to 0).  That's why we should do a correction with 
 * the array distinct element count distribution here. 
 * 
 * Using the histogram of distinct element counts produces a different 
 * distribution law than independent occurrences of elements.  This 
 * distribution law can be described as follows: 
 * 
 * P(o1, o2, ..., on) = f1^o1 * (1 - f1)^(1 - o1) * f2^o2 * 
 *    (1 - f2)^(1 - o2) * ... * fn^on * (1 - fn)^(1 - on) * hist[m] / ind[m] 
 * 
 * where: 
 * o1, o2, ..., on - occurrences of elements 1, 2, ..., n 
 *      (1 - occurrence, 0 - no occurrence) in row 
 * f1, f2, ..., fn - frequencies of elements 1, 2, ..., n 
 *      (scalar values in [0..1]) according to collected statistics 
 * m = o1 + o2 + ... + on = total number of distinct elements in row 
 * hist[m] - histogram data for occurrence of m elements. 
 * ind[m] - probability of m occurrences from n events assuming their 
 *    probabilities to be equal to frequencies of array elements. 
 * 
 * ind[m] = sum(f1^o1 * (1 - f1)^(1 - o1) * f2^o2 * (1 - f2)^(1 - o2) * 
 * ... * fn^on * (1 - fn)^(1 - on), o1, o2, ..., on) | o1 + o2 + .. on = m 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/nodes.h.html#LN637"><span class='Ref_to_Typedef'>Selectivity</span></a> 
<a name="LN697"></a><span class='Declare_Function'>mcelem_array_contained_selec</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, 
</span><a name="LN698"></a>                             <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>numbers</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nnumbers</span><span class='Delimiter'>, 
</span><a name="LN699"></a>                             <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>array_data</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nitems</span><span class='Delimiter'>, 
</span><a name="LN700"></a>                             <a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, 
</span><a name="LN701"></a>                             <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>operator</span><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN703"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>mcelem_index</span><span class='Delimiter'>, 
</span><a name="LN704"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN705"></a>                <span class='Declare_Local'>unique_nitems</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN706"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>selec</span><span class='Delimiter'>, 
</span><a name="LN707"></a>                <span class='Declare_Local'>minfreq</span><span class='Delimiter'>, 
</span><a name="LN708"></a>                <span class='Declare_Local'>nullelem_freq</span><span class='Delimiter'>; 
</span><a name="LN709"></a>    <span class='Keyword'>float</span>      <span class='Operator'>*</span><span class='Declare_Local'>dist</span><span class='Delimiter'>, 
</span><a name="LN710"></a>               <span class='Operator'>*</span><span class='Declare_Local'>mcelem_dist</span><span class='Delimiter'>, 
</span><a name="LN711"></a>               <span class='Operator'>*</span><span class='Declare_Local'>hist_part</span><span class='Delimiter'>; 
</span><a name="LN712"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>avg_count</span><span class='Delimiter'>, 
</span><a name="LN713"></a>                <span class='Declare_Local'>mult</span><span class='Delimiter'>, 
</span><a name="LN714"></a>                <span class='Declare_Local'>rest</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <span class='Keyword'>float</span>      <span class='Operator'>*</span><span class='Declare_Local'>elem_selec</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * There should be three more Numbers than Values in the MCELEM slot, 
     * because the last three cells should hold minimal and maximal frequency 
     * among the non-null elements, and then the frequency of null elements. 
     * Punt if not right, because we can't do much without the element freqs. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>nnumbers</span></a> <span class='Operator'>!= </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can't do much without a count histogram, either */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>hist</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>nhist</span></a> <span class='Operator'>&LT; </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Grab some of the summary statistics that compute_array_stats() stores: 
     * lowest frequency, frequency of null elements, and average distinct 
     * element count. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN707"><span class='Ref_To_Local'>minfreq</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>]; 
</span>    <a href="array_selfuncs.c.html#LN708"><span class='Ref_To_Local'>nullelem_freq</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span>    <a href="array_selfuncs.c.html#LN712"><span class='Ref_To_Local'>avg_count</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>nhist</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * "rest" will be the sum of the frequencies of all elements not 
     * represented in MCELEM.  The average distinct element count is the sum 
     * of the frequencies of *all* elements.  Begin with that; we will proceed 
     * to subtract the MCELEM frequencies. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN712"><span class='Ref_To_Local'>avg_count</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * mult is a multiplier representing estimate of probability that each 
     * mcelem that is not present in constant doesn't occur. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN713"><span class='Ref_To_Local'>mult</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * elem_selec is array of estimated frequencies for elements in the 
     * constant. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="array_selfuncs.c.html#LN699"><span class='Ref_to_Parameter'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan mcelem and array in parallel. */ 
</span>    <a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN699"><span class='Ref_to_Parameter'>nitems</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN763"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>match</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Ignore any duplicates in the array data. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN699"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN699"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="array_selfuncs.c.html#LN701"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Iterate over MCELEM until we find an entry greater than or equal to 
         * this element of the constant.  Update "rest" and "mult" for mcelem 
         * entries skipped over. 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN777"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>cmp</span> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>], 
</span>                                              <span class='Operator'>&</span><a href="array_selfuncs.c.html#LN699"><span class='Ref_to_Parameter'>array_data</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                              <a href="array_selfuncs.c.html#LN701"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN777"><span class='Ref_To_Local'>cmp</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="array_selfuncs.c.html#LN713"><span class='Ref_To_Local'>mult</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a> <span class='Operator'>-= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]; 
</span>                <a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN777"><span class='Ref_To_Local'>cmp</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <a href="array_selfuncs.c.html#LN763"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* mcelem is found */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN763"><span class='Ref_To_Local'>match</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* MCELEM matches the array item. */ 
</span>            <a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]; 
</span>            <span class='Comment_Multi_Line'>/* "rest" is decremented for all mcelems, matched or not */ 
</span>            <a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a> <span class='Operator'>-= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]; 
</span>            <a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The element is not in MCELEM.  Punt, but assume that the 
             * selectivity cannot be more than minfreq / 2. 
             */ 
</span>            <a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Delimiter'>, 
</span>                                            <a href="array_selfuncs.c.html#LN707"><span class='Ref_To_Local'>minfreq</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nitems;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If we handled all constant elements without exhausting the MCELEM 
     * array, finish walking it to complete calculation of "rest" and "mult". 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN713"><span class='Ref_To_Local'>mult</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a> <span class='Operator'>-= </span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Delimiter'>]; 
</span>        <a href="array_selfuncs.c.html#LN703"><span class='Ref_To_Local'>mcelem_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The presence of many distinct rare elements materially decreases 
     * selectivity.  Use the Poisson distribution to estimate the probability 
     * of a column value having zero occurrences of such elements.  See above 
     * for the definition of "rest". 
     */ 
</span>    <a href="array_selfuncs.c.html#LN713"><span class='Ref_To_Local'>mult</span></a> <span class='Operator'>*= </span>exp<span class='Parentheses'>(</span><span class='Operator'>-</span><a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * Using the distinct element count histogram requires 
     *      O(unique_nitems * (nmcelem + unique_nitems)) 
     * operations.  Beyond a certain computational cost threshold, it's 
     * reasonable to sacrifice accuracy for decreased planning time.  We limit 
     * the number of operations to EFFORT * nmcelem; since nmcelem is limited 
     * by the column's statistics target, the work done is user-controllable. 
     * 
     * If the number of operations would be too large, we can reduce it 
     * without losing all accuracy by reducing unique_nitems and considering 
     * only the most-common elements of the constant array.  To make the 
     * results exactly match what we would have gotten with only those 
     * elements to start with, we'd have to remove any discarded elements' 
     * frequencies from "mult", but since this is only an approximation 
     * anyway, we don't bother with that.  Therefore it's sufficient to qsort 
     * elem_selec[] and take the largest elements.  (They will no longer match 
     * up with the elements of array_data[], but we don't care.) 
     *---------- 
     */ 
</span><a name="LN854"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>EFFORT</span> <span class='Number'>100</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a> <span class='Operator'>&GT; </span><a href="array_selfuncs.c.html#LN854"><span class='Ref_to_Const'>EFFORT</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Use the quadratic formula to solve for largest allowable N.  We 
         * have A = 1, B = nmcelem, C = - EFFORT * nmcelem. 
         */ 
</span><a name="LN863"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>b</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>; 
</span><a name="LN864"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>n</span><span class='Delimiter'>; 
</span> 
        <a href="array_selfuncs.c.html#LN864"><span class='Ref_To_Local'>n</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span>sqrt<span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN863"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN863"><span class='Ref_To_Local'>b</span></a> <span class='Operator'>+ </span><span class='Number'>4</span> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN854"><span class='Ref_to_Const'>EFFORT</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN863"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="array_selfuncs.c.html#LN863"><span class='Ref_To_Local'>b</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Sort, then take just the first n elements */ 
</span>        <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="array_selfuncs.c.html#LN64"><span class='Ref_to_Proto'>float_compare_desc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN864"><span class='Ref_To_Local'>n</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Calculate probabilities of each distinct element count for both mcelems 
     * and constant elements.  At this point, assume independent element 
     * occurrence. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN709"><span class='Ref_To_Local'>dist</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN59"><span class='Ref_to_Proto'>calc_distr</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="array_selfuncs.c.html#LN710"><span class='Ref_To_Local'>mcelem_dist</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN59"><span class='Ref_to_Proto'>calc_distr</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN698"><span class='Ref_to_Parameter'>numbers</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN697"><span class='Ref_to_Parameter'>nmcelem</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN714"><span class='Ref_To_Local'>rest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* ignore hist[nhist-1], which is the average not a histogram member */ 
</span>    <a href="array_selfuncs.c.html#LN711"><span class='Ref_To_Local'>hist_part</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN58"><span class='Ref_to_Proto'>calc_hist</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN700"><span class='Ref_to_Parameter'>nhist</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="array_selfuncs.c.html#LN706"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN705"><span class='Ref_To_Local'>unique_nitems</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * mult * dist[i] / mcelem_dist[i] gives us probability of qual 
         * matching from assumption of independent element occurrence with the 
         * condition that distinct element count = i. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN710"><span class='Ref_To_Local'>mcelem_dist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN706"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>+= </span><a href="array_selfuncs.c.html#LN711"><span class='Ref_To_Local'>hist_part</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>* </span><a href="array_selfuncs.c.html#LN713"><span class='Ref_To_Local'>mult</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN709"><span class='Ref_To_Local'>dist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>/ </span><a href="array_selfuncs.c.html#LN710"><span class='Ref_To_Local'>mcelem_dist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN704"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN709"><span class='Ref_To_Local'>dist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN710"><span class='Ref_To_Local'>mcelem_dist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN711"><span class='Ref_To_Local'>hist_part</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN715"><span class='Ref_To_Local'>elem_selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Take into account occurrence of NULL element. */ 
</span>    <a href="array_selfuncs.c.html#LN706"><span class='Ref_To_Local'>selec</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN708"><span class='Ref_To_Local'>nullelem_freq</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/selfuncs.h.html#LN56"><span class='Ref_to_Macro'>CLAMP_PROBABILITY</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN706"><span class='Ref_To_Local'>selec</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN706"><span class='Ref_To_Local'>selec</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mcelem_array_contained_selec &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Calculate the first n distinct element count probabilities from a 
 * histogram of distinct element counts. 
 * 
 * Returns a palloc'd array of n+1 entries, with array[k] being the 
 * probability of element count k, k in [0..n]. 
 * 
 * We assume that a histogram box with bounds a and b gives 1 / ((b - a + 1) * 
 * (nhist - 1)) probability to each value in (a,b) and an additional half of 
 * that to a and b themselves. 
 */ 
</span><span class='Keyword'>static float </span><span class='Operator'>* 
</span><a name="LN922"></a><span class='Declare_Function'>calc_hist</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/c.h.html#LN379"><span class='Ref_to_Typedef'>float4</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nhist</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN924"></a>    <span class='Keyword'>float</span>      <span class='Operator'>*</span><span class='Declare_Local'>hist_part</span><span class='Delimiter'>; 
</span><a name="LN925"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>k</span><span class='Delimiter'>, 
</span><a name="LN926"></a>                <span class='Declare_Local'>i</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN927"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>prev_interval</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, 
</span><a name="LN928"></a>                <span class='Declare_Local'>next_interval</span><span class='Delimiter'>; 
</span><a name="LN929"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>frac</span><span class='Delimiter'>; 
</span> 
    <a href="array_selfuncs.c.html#LN924"><span class='Ref_To_Local'>hist_part</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * frac is a probability contribution for each interval between histogram 
     * values.  We have nhist - 1 intervals, so contribution of each one will 
     * be 1 / (nhist - 1). 
     */ 
</span>    <a href="array_selfuncs.c.html#LN929"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span> <span class='Operator'>/ </span><span class='Parentheses'>((</span><span class='Keyword'>float</span><span class='Parentheses'>) (</span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>nhist</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN942"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Count the histogram boundaries equal to k.  (Although the histogram 
         * should theoretically contain only exact integers, entries are 
         * floats so there could be roundoff error in large values.  Treat any 
         * fractional value as equal to the next larger k.) 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>nhist</span></a> <span class='Operator'>&& </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="array_selfuncs.c.html#LN942"><span class='Ref_To_Local'>count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN942"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* k is an exact bound for at least one histogram box. */ 
</span><a name="LN959"></a>            <span class='Keyword'>float</span>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Find length between current histogram value and the next one */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>nhist</span></a><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN928"><span class='Ref_To_Local'>next_interval</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><a href="array_selfuncs.c.html#LN922"><span class='Ref_to_Parameter'>hist</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN926"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>            <span class='Control'>else</span> 
                <a href="array_selfuncs.c.html#LN928"><span class='Ref_To_Local'>next_interval</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * count - 1 histogram boxes contain k exclusively.  They 
             * contribute a total of (count - 1) * frac probability.  Also 
             * factor in the partial histogram boxes on either side. 
             */ 
</span>            <a href="array_selfuncs.c.html#LN959"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>) (</span><a href="array_selfuncs.c.html#LN942"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN928"><span class='Ref_To_Local'>next_interval</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN959"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>+= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>5f</span> <span class='Operator'>/ </span><a href="array_selfuncs.c.html#LN928"><span class='Ref_To_Local'>next_interval</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN927"><span class='Ref_To_Local'>prev_interval</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN959"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>+= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>5f</span> <span class='Operator'>/ </span><a href="array_selfuncs.c.html#LN927"><span class='Ref_To_Local'>prev_interval</span></a><span class='Delimiter'>; 
</span>            <a href="array_selfuncs.c.html#LN924"><span class='Ref_To_Local'>hist_part</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="array_selfuncs.c.html#LN929"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>* </span><a href="array_selfuncs.c.html#LN959"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span> 
            <a href="array_selfuncs.c.html#LN927"><span class='Ref_To_Local'>prev_interval</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN928"><span class='Ref_To_Local'>next_interval</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if count&GT;0 &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* k does not appear as an exact histogram bound. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN927"><span class='Ref_To_Local'>prev_interval</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN924"><span class='Ref_To_Local'>hist_part</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="array_selfuncs.c.html#LN929"><span class='Ref_To_Local'>frac</span></a> <span class='Operator'>/ </span><a href="array_selfuncs.c.html#LN927"><span class='Ref_To_Local'>prev_interval</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="array_selfuncs.c.html#LN924"><span class='Ref_To_Local'>hist_part</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN925"><span class='Ref_To_Local'>k</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for k=0;k&LT;=n;k++ &raquo; </span> 
 
    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN924"><span class='Ref_To_Local'>hist_part</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end calc_hist &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Consider n independent events with probabilities p[].  This function 
 * calculates probabilities of exact k of events occurrence for k in [0..m]. 
 * Returns a palloc'd array of size m+1. 
 * 
 * "rest" is the sum of the probabilities of all low-probability events not 
 * included in p. 
 * 
 * Imagine matrix M of size (n + 1) x (m + 1).  Element M[i,j] denotes the 
 * probability that exactly j of first i events occur.  Obviously M[0,0] = 1. 
 * For any constant j, each increment of i increases the probability iff the 
 * event occurs.  So, by the law of total probability: 
 *  M[i,j] = M[i - 1, j] * (1 - p[i]) + M[i - 1, j - 1] * p[i] 
 *      for i &GT; 0, j &GT; 0. 
 *  M[i,0] = M[i - 1, 0] * (1 - p[i]) for i &GT; 0. 
 */ 
</span><span class='Keyword'>static float </span><span class='Operator'>* 
</span><a name="LN1011"></a><span class='Declare_Function'>calc_distr</span><span class='Parentheses'>(</span><span class='Keyword'>const float </span><span class='Operator'>*</span><span class='Declare_Parameter'>p</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>m</span><span class='Delimiter'>, </span><span class='Keyword'>float </span><span class='Declare_Parameter'>rest</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1013"></a>    <span class='Keyword'>float</span>      <span class='Operator'>*</span><span class='Declare_Local'>row</span><span class='Delimiter'>, 
</span><a name="LN1014"></a>               <span class='Operator'>*</span><span class='Declare_Local'>prev_row</span><span class='Delimiter'>, 
</span><a name="LN1015"></a>               <span class='Operator'>*</span><span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span><a name="LN1016"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1017"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Since we return only the last row of the matrix and need only the 
     * current and previous row for calculations, allocate two rows. 
     */ 
</span>    <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>((</span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* M[0,0] = 1 */ 
</span>    <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1030"></a>        <span class='Keyword'>float</span>       <span class='Declare_Local'>t</span> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>p</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Swap rows */ 
</span>        <a href="array_selfuncs.c.html#LN1015"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1015"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Calculate next row */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&& </span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1040"></a>            <span class='Keyword'>float</span>       <span class='Declare_Local'>val</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN1040"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>+= </span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>* </span><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0f</span> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN1030"><span class='Ref_To_Local'>t</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN1040"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>+= </span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>* </span><a href="array_selfuncs.c.html#LN1030"><span class='Ref_To_Local'>t</span></a><span class='Delimiter'>; 
</span>            <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1040"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=1;i&LT;=n;i++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The presence of many distinct rare (not in "p") elements materially 
     * decreases selectivity.  Model their collective occurrence with the 
     * Poisson distribution. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>rest</span></a> <span class='Operator'>&GT; </span><a href="array_selfuncs.c.html#LN31"><span class='Ref_to_Const'>DEFAULT_CONTAIN_SEL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1057"></a>        <span class='Keyword'>float</span>       <span class='Declare_Local'>t</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Swap rows */ 
</span>        <a href="array_selfuncs.c.html#LN1015"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1015"><span class='Ref_To_Local'>tmp</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0f</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Value of Poisson distribution for 0 occurrences */ 
</span>        <a href="array_selfuncs.c.html#LN1057"><span class='Ref_To_Local'>t</span></a> <span class='Operator'>= </span>exp<span class='Parentheses'>(</span><span class='Operator'>-</span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>rest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Calculate convolution of previously computed distribution and the 
         * Poisson distribution. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>m</span></a> <span class='Operator'>- </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; </span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>+= </span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1017"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>* </span><a href="array_selfuncs.c.html#LN1057"><span class='Ref_To_Local'>t</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Get Poisson distribution value for (i + 1) occurrences */ 
</span>            <a href="array_selfuncs.c.html#LN1057"><span class='Ref_To_Local'>t</span></a> <span class='Operator'>*= </span><a href="array_selfuncs.c.html#LN1011"><span class='Ref_to_Parameter'>rest</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>float</span><span class='Parentheses'>) (</span><a href="array_selfuncs.c.html#LN1016"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if rest&GT;DEFAULT_CONTAIN_... &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1014"><span class='Ref_To_Local'>prev_row</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN1013"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end calc_distr &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Fast function for floor value of 2 based logarithm calculation. */ 
</span><span class='Keyword'>static int 
</span><a name="LN1090"></a><span class='Declare_Function'>floor_log2</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1092"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>logval</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>16</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>16</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a> <span class='Operator'>+= </span><span class='Number'>16</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>8</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a> <span class='Operator'>+= </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>4</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a> <span class='Operator'>+= </span><span class='Number'>4</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>2</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a> <span class='Operator'>+= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1090"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="array_selfuncs.c.html#LN1092"><span class='Ref_To_Local'>logval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end floor_log2 &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * find_next_mcelem binary-searches a most common elements array, starting 
 * from *index, for the first member &GT;= value.  It saves the position of the 
 * match into *index and returns true if it's an exact match.  (Note: we 
 * assume the mcelem elements are distinct so there can't be more than one 
 * exact match.) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1131"></a><span class='Declare_Function'>find_next_mcelem</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>mcelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nmcelem</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>value</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN1132"></a>                 <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cmpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1134"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>l</span> <span class='Operator'>= *</span><a href="array_selfuncs.c.html#LN1131"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>, 
</span><a name="LN1135"></a>                <span class='Declare_Local'>r</span> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1131"><span class='Ref_to_Parameter'>nmcelem</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span><a name="LN1136"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1137"></a>                <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1134"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>&LT;= </span><a href="array_selfuncs.c.html#LN1135"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="array_selfuncs.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1134"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>+ </span><a href="array_selfuncs.c.html#LN1135"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="array_selfuncs.c.html#LN1137"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN63"><span class='Ref_to_Proto'>element_compare</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="array_selfuncs.c.html#LN1131"><span class='Ref_to_Parameter'>mcelem</span></a><span class='Delimiter'>[</span><a href="array_selfuncs.c.html#LN1136"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><span class='Keyword'>value</span><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN1132"><span class='Ref_to_Parameter'>cmpfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1137"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="array_selfuncs.c.html#LN1131"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1136"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1137"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="array_selfuncs.c.html#LN1134"><span class='Ref_To_Local'>l</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="array_selfuncs.c.html#LN1135"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1136"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="array_selfuncs.c.html#LN1131"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>= </span><a href="array_selfuncs.c.html#LN1134"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_next_mcelem &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Comparison function for elements. 
 * 
 * We use the element type's default btree opclass, and the default collation 
 * if the type is collation-sensitive. 
 * 
 * XXX consider using SortSupport infrastructure 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1166"></a><span class='Declare_Function'>element_compare</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key2</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1168"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>d1</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN1166"><span class='Ref_to_Parameter'>key1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1169"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>d2</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN1166"><span class='Ref_to_Parameter'>key2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1170"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>cmpfunc</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN1166"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span><a name="LN1171"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span> 
    <a href="array_selfuncs.c.html#LN1171"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN512"><span class='Ref_to_Proto'>FunctionCall2Coll</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1170"><span class='Ref_To_Local'>cmpfunc</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN1168"><span class='Ref_To_Local'>d1</span></a><span class='Delimiter'>, </span><a href="array_selfuncs.c.html#LN1169"><span class='Ref_To_Local'>d2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1171"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Comparison function for sorting floats into descending order. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1181"></a><span class='Declare_Function'>float_compare_desc</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key1</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>key2</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1183"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>d1</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN1181"><span class='Ref_to_Parameter'>key1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1184"></a>    <span class='Keyword'>float</span>       <span class='Declare_Local'>d2</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const float </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="array_selfuncs.c.html#LN1181"><span class='Ref_to_Parameter'>key2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1183"><span class='Ref_To_Local'>d1</span></a> <span class='Operator'>&GT; </span><a href="array_selfuncs.c.html#LN1184"><span class='Ref_To_Local'>d2</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="array_selfuncs.c.html#LN1183"><span class='Ref_To_Local'>d1</span></a> <span class='Operator'>&LT; </span><a href="array_selfuncs.c.html#LN1184"><span class='Ref_To_Local'>d2</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>