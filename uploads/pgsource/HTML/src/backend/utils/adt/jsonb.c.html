<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\adt\jsonb.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\adt\jsonb.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:51 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * jsonb.c 
 *      I/O routines for jsonb type 
 * 
 * Copyright (c) 2014-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/adt/jsonb.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/pqformat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_coerce.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/date.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/datetime.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/json.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/jsonapi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/jsonb.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/typcache.h"</span> 
 
<a name="LN30"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>JsonbInState</span> 
<span class='Delimiter'>{ 
</span><a name="LN32"></a>    <a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>parseState</span><span class='Delimiter'>; 
</span><a name="LN33"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a> <span class='Operator'>*</span><span class='Declare_Member'>res</span><span class='Delimiter'>; 
</span><a name="LN34"></a>} <span class='Declare_Typedef'>JsonbInState</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* unlike with json categories, we need to treat json and jsonb differently */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span>                    <span class='Comment_Single_Line'>/* type categories for datum_to_jsonb */ 
</span><span class='Delimiter'>{ 
</span><a name="LN39"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_NULL</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* null, so we didn't bother to identify */ 
</span><a name="LN40"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_BOOL</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* boolean (built-in types only) */ 
</span><a name="LN41"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_NUMERIC</span><span class='Delimiter'>,</span>          <span class='Comment_Single_Line'>/* numeric (ditto) */ 
</span><a name="LN42"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_DATE</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* we use special formatting for datetimes */ 
</span><a name="LN43"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_TIMESTAMP</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* we use special formatting for timestamp */ 
</span><a name="LN44"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_TIMESTAMPTZ</span><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* ... and timestamptz */ 
</span><a name="LN45"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_JSON</span><span class='Delimiter'>,</span>             <span class='Comment_Single_Line'>/* JSON */ 
</span><a name="LN46"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_JSONB</span><span class='Delimiter'>,</span>            <span class='Comment_Single_Line'>/* JSONB */ 
</span><a name="LN47"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_ARRAY</span><span class='Delimiter'>,</span>            <span class='Comment_Single_Line'>/* array */ 
</span><a name="LN48"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_COMPOSITE</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* composite */ 
</span><a name="LN49"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_JSONCAST</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* something with an explicit cast to JSON */ 
</span><a name="LN50"></a>    <span class='Declare_Enum_Const'>JSONBTYPE_OTHER</span>             <span class='Comment_Single_Line'>/* all else */ 
</span><a name="LN51"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>JsonbTypeCategory</span><span class='Delimiter'>; 
</span> 
<a name="LN53"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>JsonbAggState</span> 
<span class='Delimiter'>{ 
</span><a name="LN55"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>res</span><span class='Delimiter'>; 
</span><a name="LN56"></a>    <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Member'>key_category</span><span class='Delimiter'>; 
</span><a name="LN57"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>key_output_func</span><span class='Delimiter'>; 
</span><a name="LN58"></a>    <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Member'>val_category</span><span class='Delimiter'>; 
</span><a name="LN59"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>val_output_func</span><span class='Delimiter'>; 
</span><a name="LN60"></a>} <span class='Declare_Typedef'>JsonbAggState</span><span class='Delimiter'>; 
</span> 
<a name="LN62"></a><span class='Keyword'>static inline </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>jsonb_from_cstring</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>json</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN63"></a><span class='Keyword'>static </span>size_t <span class='Declare_Prototype'>checkStringLen</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN64"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_object_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN65"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_object_end</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN66"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_array_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN67"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_array_end</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_object_field_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_put_escaped_value</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>scalarVal</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_in_scalar</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>token</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonapi.h.html#LN19"><span class='Ref_to_Typedef'>JsonTokenType</span></a> <span class='Declare_Parameter'>tokentype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_categorize_type</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typoid</span><span class='Delimiter'>, 
</span><a name="LN72"></a>                      <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, 
</span><a name="LN73"></a>                      <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>outfuncoid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN74"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>composite_to_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>composite</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN75"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>array_dim_to_jsonb</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>dim</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ndims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>dims</span><span class='Delimiter'>, 
</span><a name="LN76"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vals</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>nulls</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>valcount</span><span class='Delimiter'>, 
</span><a name="LN77"></a>                   <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>outfuncoid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN78"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>array_to_jsonb_internal</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>array</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>jsonb_categorize_type</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typoid</span><span class='Delimiter'>, 
</span><a name="LN80"></a>                      <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, 
</span><a name="LN81"></a>                      <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>outfuncoid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>datum_to_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>val</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_null</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, 
</span><a name="LN83"></a>               <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>outfuncoid</span><span class='Delimiter'>, 
</span><a name="LN84"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>key_scalar</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN85"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>add_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>val</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_null</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, 
</span><a name="LN86"></a>          <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>val_type</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>key_scalar</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static </span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>clone_parse_state</span><span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>JsonbToCStringWorker</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN192"><span class='Ref_to_Struct'>JsonbContainer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>estimated_len</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>indent</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>add_indent</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>indent</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * jsonb type input function 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN95"></a><span class='Declare_Function'>jsonb_in</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN97"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>json</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN241"><span class='Ref_to_Macro'>PG_GETARG_CSTRING</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="jsonb.c.html#LN62"><span class='Ref_to_Proto'>jsonb_from_cstring</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN97"><span class='Ref_To_Local'>json</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN97"><span class='Ref_To_Local'>json</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * jsonb type recv function 
 * 
 * The type is sent as text in binary mode, so this is almost the same 
 * as the input function, but it's prefixed with a version number so we 
 * can change the binary format sent in future if necessary. For now, 
 * only version 1 is supported. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN111"></a><span class='Declare_Function'>jsonb_recv</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN113"></a>    <a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>buf</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN114"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>version</span> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN38"><span class='Ref_to_Proto'>pq_getmsgint</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN113"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN115"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span><span class='Delimiter'>; 
</span><a name="LN116"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbytes</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN114"><span class='Ref_To_Local'>version</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="jsonb.c.html#LN115"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/libpq/pqformat.h.html#LN44"><span class='Ref_to_Proto'>pq_getmsgtext</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN113"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN113"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>- </span><a href="jsonb.c.html#LN113"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN39"><span class='Ref_to_Member'>cursor</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN116"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unsupported jsonb version number %d"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN114"><span class='Ref_To_Local'>version</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="jsonb.c.html#LN62"><span class='Ref_to_Proto'>jsonb_from_cstring</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN115"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN116"><span class='Ref_To_Local'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * jsonb type output function 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN130"></a><span class='Declare_Function'>jsonb_out</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN132"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>jb</span> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN69"><span class='Ref_to_Macro'>PG_GETARG_JSONB</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>out</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN133"><span class='Ref_To_Local'>out</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN374"><span class='Ref_to_Proto'>JsonbToCString</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN132"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN132"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN321"><span class='Ref_to_Macro'>PG_RETURN_CSTRING</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN133"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * jsonb type send function 
 * 
 * Just send jsonb as a version number, then a string of text 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN146"></a><span class='Declare_Function'>jsonb_send</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN148"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>jb</span> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN69"><span class='Ref_to_Macro'>PG_GETARG_JSONB</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN149"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN150"></a>    <a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a>  <span class='Declare_Local'>jtext</span> <span class='Operator'>= </span><a href="../../lib/stringinfo.c.html#LN26"><span class='Ref_to_Func'>makeStringInfo</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN151"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>version</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN374"><span class='Ref_to_Proto'>JsonbToCString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN150"><span class='Ref_To_Local'>jtext</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN148"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN303"><span class='Ref_to_Macro'>VARSIZE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN148"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/libpq/pqformat.h.html#LN31"><span class='Ref_to_Proto'>pq_begintypsend</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN149"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN25"><span class='Ref_to_Proto'>pq_sendint</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN151"><span class='Ref_To_Local'>version</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/libpq/pqformat.h.html#LN22"><span class='Ref_to_Proto'>pq_sendtext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN149"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN150"><span class='Ref_To_Local'>jtext</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN150"><span class='Ref_To_Local'>jtext</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN150"><span class='Ref_To_Local'>jtext</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN150"><span class='Ref_To_Local'>jtext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN328"><span class='Ref_to_Macro'>PG_RETURN_BYTEA_P</span></a><span class='Parentheses'>(</span><a href="../../../include/libpq/pqformat.h.html#LN32"><span class='Ref_to_Proto'>pq_endtypsend</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN149"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SQL function jsonb_typeof(jsonb) -&GT; text 
 * 
 * This function is here because the analog json function is in json.c, since 
 * it uses the json parser internals not exposed elsewhere. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN171"></a><span class='Declare_Function'>jsonb_typeof</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN173"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>in</span> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN69"><span class='Ref_to_Macro'>PG_GETARG_JSONB</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN174"></a>    <a href="../../../include/utils/jsonb.h.html#LN323"><span class='Ref_to_Struct'>JsonbIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN175"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN176"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN223"><span class='Ref_to_Macro'>JB_ROOT_IS_OBJECT</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN173"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>))</span> 
        <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"object"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN224"><span class='Ref_to_Macro'>JB_ROOT_IS_ARRAY</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN173"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="../../../include/utils/jsonb.h.html#LN222"><span class='Ref_to_Macro'>JB_ROOT_IS_SCALAR</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN173"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>))</span> 
        <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"array"</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN222"><span class='Ref_to_Macro'>JB_ROOT_IS_SCALAR</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN173"><span class='Ref_To_Local'>in</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN174"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN173"><span class='Ref_To_Local'>in</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * A root scalar is stored as an array of one element, so we get the 
         * array and then its first (and only) member. 
         */ 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN174"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN175"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN175"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN174"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN175"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN175"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"null"</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"string"</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"number"</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN233"><span class='Ref_to_EnumConst'>jbvBool</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='String'>"boolean"</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown jsonb scalar type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="../../../include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN176"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_typeof &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * jsonb_from_cstring 
 * 
 * Turns json string into a jsonb Datum. 
 * 
 * Uses the json parser (with hooks) to construct a jsonb. 
 */ 
</span><span class='Keyword'>static inline </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN225"></a><span class='Declare_Function'>jsonb_from_cstring</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>json</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN227"></a>    <a href="../../../include/utils/jsonapi.h.html#LN50"><span class='Ref_to_Struct'>JsonLexContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lex</span><span class='Delimiter'>; 
</span><a name="LN228"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN229"></a>    <a href="../../../include/utils/jsonapi.h.html#LN81"><span class='Ref_to_Struct'>JsonSemAction</span></a> <span class='Declare_Local'>sem</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN228"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN228"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN227"><span class='Ref_To_Local'>lex</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonapi.h.html#LN123"><span class='Ref_to_Proto'>makeJsonLexContextCstringLen</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN225"><span class='Ref_to_Parameter'>json</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN225"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN83"><span class='Ref_to_Member'>semstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="jsonb.c.html#LN228"><span class='Ref_To_Local'>state</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN84"><span class='Ref_to_Member'>object_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN64"><span class='Ref_to_Proto'>jsonb_in_object_start</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN86"><span class='Ref_to_Member'>array_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN66"><span class='Ref_to_Proto'>jsonb_in_array_start</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN85"><span class='Ref_to_Member'>object_end</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN65"><span class='Ref_to_Proto'>jsonb_in_object_end</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN87"><span class='Ref_to_Member'>array_end</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN67"><span class='Ref_to_Proto'>jsonb_in_array_end</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN92"><span class='Ref_to_Member'>scalar</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN70"><span class='Ref_to_Proto'>jsonb_in_scalar</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN88"><span class='Ref_to_Member'>object_field_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN68"><span class='Ref_to_Proto'>jsonb_in_object_field_start</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/jsonapi.h.html#LN104"><span class='Ref_to_Proto'>pg_parse_json</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN227"><span class='Ref_To_Local'>lex</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN229"><span class='Ref_To_Local'>sem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* after parsing, the item member has the composed jsonb structure */ 
</span>    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN228"><span class='Ref_To_Local'>state</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_from_cstring &raquo; </span> 
 
<span class='Keyword'>static </span>size_t 
<a name="LN251"></a><span class='Declare_Function'>checkStringLen</span><span class='Parentheses'>(</span>size_t <span class='Declare_Parameter'>len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN251"><span class='Ref_to_Parameter'>len</span></a> <span class='Operator'>&GT; </span><a href="../../../include/utils/jsonb.h.html#LN140"><span class='Ref_to_Const'>JENTRY_OFFLENMASK</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_PROGRAM_LIMIT_EXCEEDED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"string too long to represent as jsonb string"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Due to an implementation restriction, jsonb strings cannot exceed %d bytes."</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/jsonb.h.html#LN140"><span class='Ref_to_Const'>JENTRY_OFFLENMASK</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="jsonb.c.html#LN251"><span class='Ref_to_Parameter'>len</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN264"></a><span class='Declare_Function'>jsonb_in_object_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN266"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN264"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN266"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN266"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN272"></a><span class='Declare_Function'>jsonb_in_object_end</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN274"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN272"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN274"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN274"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN280"></a><span class='Declare_Function'>jsonb_in_array_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN282"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN280"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN282"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN282"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN288"></a><span class='Declare_Function'>jsonb_in_array_end</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN290"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN288"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN290"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN290"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN296"></a><span class='Declare_Function'>jsonb_in_object_field_start</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>fname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isnull</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN298"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN296"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span><a name="LN299"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN296"><span class='Ref_to_Parameter'>fname</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN299"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN299"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN63"><span class='Ref_to_Proto'>checkStringLen</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN296"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN299"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN296"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN298"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN298"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN299"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN310"></a><span class='Declare_Function'>jsonb_put_escaped_value</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>scalarVal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>scalarVal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Operator'>: 
</span>            <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>"null"</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/json.h.html#LN19"><span class='Ref_to_Proto'>escape_json</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/palloc.h.html#LN127"><span class='Ref_to_Proto'>pnstrdup</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>scalarVal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val<span class='Delimiter'>, </span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>scalarVal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Operator'>: 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/postgres.h.html#LN571"><span class='Ref_to_Macro'>DatumGetCString</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="numeric.c.html#LN639"><span class='Ref_to_Func'>numeric_out</span></a><span class='Delimiter'>, 
</span>                                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>scalarVal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN233"><span class='Ref_to_EnumConst'>jbvBool</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>scalarVal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>boolean<span class='Parentheses'>) 
</span>                <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>"true"</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN310"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>"false"</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown jsonb scalar type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch scalarVal-&GT;type &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end jsonb_put_escaped_value &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * For jsonb we always want the de-escaped value - that's what's in token 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN340"></a><span class='Declare_Function'>jsonb_in_scalar</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pstate</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>token</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonapi.h.html#LN19"><span class='Ref_to_Typedef'>JsonTokenType</span></a> <span class='Declare_Parameter'>tokentype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN342"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>_state</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>pstate</span></a><span class='Delimiter'>; 
</span><a name="LN343"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>tokentype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/jsonapi.h.html#LN22"><span class='Ref_to_EnumConst'>JSON_TOKEN_STRING</span></a><span class='Operator'>: 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>token</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN63"><span class='Ref_to_Proto'>checkStringLen</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>token</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>token</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonapi.h.html#LN23"><span class='Ref_to_EnumConst'>JSON_TOKEN_NUMBER</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to check size of numeric values, because maximum 
             * numeric size is well below the JsonbValue restriction 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>token</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric <span class='Operator'>= </span><a href="../../../include/utils/numeric.h.html#LN48"><span class='Ref_to_Macro'>DatumGetNumeric</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN587"><span class='Ref_to_Macro'>DirectFunctionCall3</span></a><span class='Parentheses'>(</span><a href="numeric.c.html#LN557"><span class='Ref_to_Func'>numeric_in</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN340"><span class='Ref_to_Parameter'>token</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonapi.h.html#LN30"><span class='Ref_to_EnumConst'>JSON_TOKEN_TRUE</span></a><span class='Operator'>: 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN233"><span class='Ref_to_EnumConst'>jbvBool</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>boolean <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonapi.h.html#LN31"><span class='Ref_to_EnumConst'>JSON_TOKEN_FALSE</span></a><span class='Operator'>: 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN233"><span class='Ref_to_EnumConst'>jbvBool</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>boolean <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/jsonapi.h.html#LN32"><span class='Ref_to_EnumConst'>JSON_TOKEN_NULL</span></a><span class='Operator'>: 
</span>            <a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* should not be possible */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid json token type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch tokentype &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* single scalar */ 
</span><a name="LN387"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>va</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN387"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN387"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN387"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>nElems <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN387"><span class='Ref_To_Local'>va</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN399"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a> <span class='Operator'>*</span><span class='Declare_Local'>o</span> <span class='Operator'>= &</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN305"><span class='Ref_to_Member'>contVal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN399"><span class='Ref_To_Local'>o</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN236"><span class='Ref_to_EnumConst'>jbvObject</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN342"><span class='Ref_To_Local'>_state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN343"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected parent of nested structure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_in_scalar &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * JsonbToCString 
 *     Converts jsonb value to a C-string. 
 * 
 * If 'out' argument is non-null, the resulting C-string is stored inside the 
 * StringBuffer.  The resulting string is always returned. 
 * 
 * A typical case for passing the StringInfo in rather than NULL is where the 
 * caller wants access to the len attribute without having to call strlen, e.g. 
 * if they are converting it to a text* object. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN427"></a><span class='Declare_Function'>JsonbToCString</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN192"><span class='Ref_to_Struct'>JsonbContainer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>estimated_len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="jsonb.c.html#LN88"><span class='Ref_to_Proto'>JsonbToCStringWorker</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN427"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN427"><span class='Ref_to_Parameter'>in</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN427"><span class='Ref_to_Parameter'>estimated_len</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * same thing but with indentation turned on 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN436"></a><span class='Declare_Function'>JsonbToCStringIndent</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN192"><span class='Ref_to_Struct'>JsonbContainer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>estimated_len</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="jsonb.c.html#LN88"><span class='Ref_to_Proto'>JsonbToCStringWorker</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN436"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN436"><span class='Ref_to_Parameter'>in</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN436"><span class='Ref_to_Parameter'>estimated_len</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * common worker for above two functions 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN445"></a><span class='Declare_Function'>JsonbToCStringWorker</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN192"><span class='Ref_to_Struct'>JsonbContainer</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>in</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>estimated_len</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>indent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN447"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>first</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN448"></a>    <a href="../../../include/utils/jsonb.h.html#LN323"><span class='Ref_to_Struct'>JsonbIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN449"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN450"></a>    <a href="../../../include/utils/jsonb.h.html#LN19"><span class='Ref_to_Typedef'>JsonbIteratorToken</span></a> <span class='Declare_Local'>type</span> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Delimiter'>; 
</span><a name="LN451"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>level</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN452"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>redo_switch</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we are indenting, don't add a space after a comma */ 
</span><a name="LN455"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ispaces</span> <span class='Operator'>= </span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>indent</span></a> <span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't indent the very first item. This gets set to the indent flag at 
     * the bottom of the loop. 
     */ 
</span><a name="LN461"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>use_indent</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN462"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>raw_scalar</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN463"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>last_was_key</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a> <span class='Operator'>= </span><a href="../../lib/stringinfo.c.html#LN26"><span class='Ref_to_Func'>makeStringInfo</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/lib/stringinfo.h.html#LN149"><span class='Ref_to_Proto'>enlargeStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>estimated_len</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>estimated_len</span></a> <span class='Operator'>: </span><span class='Number'>64</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN448"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>in</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN452"><span class='Ref_To_Local'>redo_switch</span></a> <span class='Operator'>|| 
</span>           <span class='Parentheses'>((</span><a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN448"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN452"><span class='Ref_To_Local'>redo_switch</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN455"><span class='Ref_To_Local'>ispaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar<span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a> <span class='Operator'>&& !</span><a href="jsonb.c.html#LN463"><span class='Ref_To_Local'>last_was_key</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN126"><span class='Ref_to_Macro'>appendStringInfoCharMacro</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>'['</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                    <a href="jsonb.c.html#LN462"><span class='Ref_To_Local'>raw_scalar</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN455"><span class='Ref_To_Local'>ispaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a> <span class='Operator'>&& !</span><a href="jsonb.c.html#LN463"><span class='Ref_To_Local'>last_was_key</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/lib/stringinfo.h.html#LN126"><span class='Ref_to_Macro'>appendStringInfoCharMacro</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>'{'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN455"><span class='Ref_To_Local'>ispaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
                <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* json rules guarantee this is a string */ 
</span>                <a href="jsonb.c.html#LN69"><span class='Ref_to_Proto'>jsonb_put_escaped_value</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>": "</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN448"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN69"><span class='Ref_to_Proto'>jsonb_put_escaped_value</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN450"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * We need to rerun the current switch() since we need to 
                     * output the object which we just got from the iterator 
                     * before calling the iterator again. 
                     */ 
</span>                    <a href="jsonb.c.html#LN452"><span class='Ref_To_Local'>redo_switch</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN455"><span class='Ref_To_Local'>ispaces</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN462"><span class='Ref_To_Local'>raw_scalar</span></a><span class='Parentheses'>) 
</span>                    <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN69"><span class='Ref_to_Proto'>jsonb_put_escaped_value</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN449"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN462"><span class='Ref_To_Local'>raw_scalar</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/lib/stringinfo.h.html#LN126"><span class='Ref_to_Macro'>appendStringInfoCharMacro</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>']'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN89"><span class='Ref_to_Proto'>add_indent</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/lib/stringinfo.h.html#LN126"><span class='Ref_to_Macro'>appendStringInfoCharMacro</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>'}'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN447"><span class='Ref_To_Local'>first</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown jsonb iterator token type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
        <a href="jsonb.c.html#LN461"><span class='Ref_To_Local'>use_indent</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>indent</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN463"><span class='Ref_To_Local'>last_was_key</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN452"><span class='Ref_To_Local'>redo_switch</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while redo_switch||((type=J... &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN451"><span class='Ref_To_Local'>level</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="jsonb.c.html#LN445"><span class='Ref_to_Parameter'>out</span></a><span class='Operator'>-&GT;</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end JsonbToCStringWorker &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN569"></a><span class='Declare_Function'>add_indent</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>out</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>indent</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN569"><span class='Ref_to_Parameter'>indent</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN573"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/lib/stringinfo.h.html#LN126"><span class='Ref_to_Macro'>appendStringInfoCharMacro</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN569"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN573"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN573"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN569"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; </span><a href="jsonb.c.html#LN573"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/lib/stringinfo.h.html#LN142"><span class='Ref_to_Proto'>appendBinaryStringInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN569"><span class='Ref_to_Parameter'>out</span></a><span class='Delimiter'>, </span><span class='String'>"    "</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine how we want to render values of a given type in datum_to_jsonb. 
 * 
 * Given the datatype OID, return its JsonbTypeCategory, as well as the type's 
 * output function OID.  If the returned category is JSONBTYPE_JSONCAST, 
 * we return the OID of the relevant cast function instead. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN590"></a><span class='Declare_Function'>jsonb_categorize_type</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typoid</span><span class='Delimiter'>, 
</span><a name="LN591"></a>                      <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, 
</span><a name="LN592"></a>                      <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>outfuncoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN594"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typisvarlena</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look through any domain */ 
</span>    <a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/lsyscache.h.html#LN168"><span class='Ref_to_Proto'>getBaseType</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="jsonb.c.html#LN592"><span class='Ref_to_Parameter'>outfuncoid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to get the output function for everything except date and 
     * timestamp types, booleans, array and composite types, json and jsonb, 
     * and non-builtin types where there's a cast to json. In this last case 
     * we return the oid of the cast function instead. 
     */ 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN40"><span class='Ref_to_EnumConst'>JSONBTYPE_BOOL</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN22"><span class='Ref_to_Const'>INT2OID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN21"><span class='Ref_to_Const'>INT8OID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN38"><span class='Ref_to_Const'>FLOAT4OID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN39"><span class='Ref_to_Const'>FLOAT8OID</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN58"><span class='Ref_to_Const'>NUMERICOID</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN592"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN594"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN41"><span class='Ref_to_EnumConst'>JSONBTYPE_NUMERIC</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN50"><span class='Ref_to_Const'>DATEOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN42"><span class='Ref_to_EnumConst'>JSONBTYPE_DATE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN52"><span class='Ref_to_Const'>TIMESTAMPOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN43"><span class='Ref_to_EnumConst'>JSONBTYPE_TIMESTAMP</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN53"><span class='Ref_to_Const'>TIMESTAMPTZOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN44"><span class='Ref_to_EnumConst'>JSONBTYPE_TIMESTAMPTZ</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN75"><span class='Ref_to_Const'>JSONBOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN46"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONB</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/catalog/pg_type.h.html#LN355"><span class='Ref_to_Const'>JSONOID</span></a><span class='Operator'>: 
</span>            <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN45"><span class='Ref_to_EnumConst'>JSONBTYPE_JSON</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Check for arrays and composites */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN157"><span class='Ref_to_Proto'>get_element_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| </span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_type.h.html#LN687"><span class='Ref_to_Const'>ANYARRAYOID</span></a> 
                <span class='Operator'>|| </span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_type.h.html#LN681"><span class='Ref_to_Const'>RECORDARRAYOID</span></a><span class='Parentheses'>)</span> 
                <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN47"><span class='Ref_to_EnumConst'>JSONBTYPE_ARRAY</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN150"><span class='Ref_to_Proto'>type_is_rowtype</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Parentheses'>))</span>   <span class='Comment_Single_Line'>/* includes RECORDOID */ 
</span>                <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN48"><span class='Ref_to_EnumConst'>JSONBTYPE_COMPOSITE</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* It's probably the general case ... */ 
</span>                <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN50"><span class='Ref_to_EnumConst'>JSONBTYPE_OTHER</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * but first let's look for a cast to json (note: not to 
                 * jsonb) if it's not built-in. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/access/transam.h.html#LN93"><span class='Ref_to_Const'>FirstNormalObjectId</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN662"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>castfunc</span><span class='Delimiter'>; 
</span><a name="LN663"></a>                    <a href="../../../include/parser/parse_coerce.h.html#LN23"><span class='Ref_to_Enum'>CoercionPathType</span></a> <span class='Declare_Local'>ctype</span><span class='Delimiter'>; 
</span> 
                    <a href="jsonb.c.html#LN663"><span class='Ref_To_Local'>ctype</span></a> <span class='Operator'>= </span><a href="../../../include/parser/parse_coerce.h.html#LN86"><span class='Ref_to_Proto'>find_coercion_pathway</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_type.h.html#LN355"><span class='Ref_to_Const'>JSONOID</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../../include/nodes/primnodes.h.html#LN422"><span class='Ref_to_EnumConst'>COERCION_EXPLICIT</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN662"><span class='Ref_To_Local'>castfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN663"><span class='Ref_To_Local'>ctype</span></a> <span class='Operator'>== </span><a href="../../../include/parser/parse_coerce.h.html#LN26"><span class='Ref_to_EnumConst'>COERCION_PATH_FUNC</span></a> <span class='Operator'>&& </span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN662"><span class='Ref_To_Local'>castfunc</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Operator'>*</span><a href="jsonb.c.html#LN591"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN49"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONCAST</span></a><span class='Delimiter'>; 
</span>                        <span class='Operator'>*</span><a href="jsonb.c.html#LN592"><span class='Ref_to_Parameter'>outfuncoid</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN662"><span class='Ref_To_Local'>castfunc</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* not a cast type, so just get the usual output func */ 
</span>                        <a href="../../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN592"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN594"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* any other builtin type */ 
</span>                    <a href="../../../include/utils/lsyscache.h.html#LN162"><span class='Ref_to_Proto'>getTypeOutputInfo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN590"><span class='Ref_to_Parameter'>typoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN592"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN594"><span class='Ref_To_Local'>typisvarlena</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch typoid &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end jsonb_categorize_type &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Turn a Datum into jsonb, adding it to the result JsonbInState. 
 * 
 * tcategory and outfuncoid are from a previous call to json_categorize_type, 
 * except that if is_null is true then they can be invalid. 
 * 
 * If key_scalar is true, the value is stored as a key, so insist 
 * it's of an acceptable type, and force it to be a jbvString. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN698"></a><span class='Declare_Function'>datum_to_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>val</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_null</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, 
</span><a name="LN699"></a>               <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>outfuncoid</span><span class='Delimiter'>, 
</span><a name="LN700"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>key_scalar</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN702"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>outputstr</span><span class='Delimiter'>; 
</span><a name="LN703"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>numeric_error</span><span class='Delimiter'>; 
</span><a name="LN704"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>jb</span><span class='Delimiter'>; 
</span><a name="LN705"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>scalar_jsonb</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert val to a JsonbValue in jb (in most cases) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>is_null</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN700"><span class='Ref_to_Parameter'>key_scalar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN700"><span class='Ref_to_Parameter'>key_scalar</span></a> <span class='Operator'>&& 
</span>             <span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN47"><span class='Ref_to_EnumConst'>JSONBTYPE_ARRAY</span></a> <span class='Operator'>|| 
</span>              <a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN48"><span class='Ref_to_EnumConst'>JSONBTYPE_COMPOSITE</span></a> <span class='Operator'>|| 
</span>              <a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN45"><span class='Ref_to_EnumConst'>JSONBTYPE_JSON</span></a> <span class='Operator'>|| 
</span>              <a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN46"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONB</span></a> <span class='Operator'>|| 
</span>              <a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN49"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONCAST</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"key value must be scalar, not array, composite, or json"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>== </span><a href="jsonb.c.html#LN49"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONCAST</span></a><span class='Parentheses'>) 
</span>            <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN621"><span class='Ref_to_Macro'>OidFunctionCall1</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN47"><span class='Ref_to_EnumConst'>JSONBTYPE_ARRAY</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN78"><span class='Ref_to_Proto'>array_to_jsonb_internal</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN48"><span class='Ref_to_EnumConst'>JSONBTYPE_COMPOSITE</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN74"><span class='Ref_to_Proto'>composite_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN40"><span class='Ref_to_EnumConst'>JSONBTYPE_BOOL</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN700"><span class='Ref_to_Parameter'>key_scalar</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN233"><span class='Ref_to_EnumConst'>jbvBool</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>boolean <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN41"><span class='Ref_to_EnumConst'>JSONBTYPE_NUMERIC</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN700"><span class='Ref_to_Parameter'>key_scalar</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* always quote keys */ 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Make it numeric if it's a valid JSON number, otherwise 
                     * a string. Invalid numeric output will always have an 
                     * 'N' or 'n' in it (I think). 
                     */ 
</span>                    <a href="jsonb.c.html#LN703"><span class='Ref_To_Local'>numeric_error</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>strchr<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>, </span><span class='String'>'N'</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>                                     strchr<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>, </span><span class='String'>'n'</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN703"><span class='Ref_To_Local'>numeric_error</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Delimiter'>; 
</span>                        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric <span class='Operator'>= </span><a href="../../../include/utils/numeric.h.html#LN48"><span class='Ref_to_Macro'>DatumGetNumeric</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN587"><span class='Ref_to_Macro'>DirectFunctionCall3</span></a><span class='Parentheses'>(</span><a href="numeric.c.html#LN557"><span class='Ref_to_Func'>numeric_in</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN583"><span class='Ref_to_Macro'>CStringGetDatum</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN42"><span class='Ref_to_EnumConst'>JSONBTYPE_DATE</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN788"></a>                    <a href="../../../include/utils/date.h.html#LN21"><span class='Ref_to_Typedef'>DateADT</span></a>     <span class='Declare_Local'>date</span><span class='Delimiter'>; 
</span><a name="LN789"></a>                    <span class='Control'>struct</span> <a href="../../../include/pgtime.h.html#LN24"><span class='Ref_to_Struct'>pg_tm</span></a> <span class='Declare_Local'>tm</span><span class='Delimiter'>; 
</span><a name="LN790"></a>                    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN195"><span class='Ref_to_Const'>MAXDATELEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
                    <a href="jsonb.c.html#LN788"><span class='Ref_To_Local'>date</span></a> <span class='Operator'>= </span><a href="../../../include/utils/date.h.html#LN51"><span class='Ref_to_Macro'>DatumGetDateADT</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Same as date_out(), but forcing DateStyle */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/date.h.html#LN41"><span class='Ref_to_Macro'>DATE_NOT_FINITE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN788"><span class='Ref_To_Local'>date</span></a><span class='Parentheses'>))</span> 
                        <a href="../../../include/utils/date.h.html#LN71"><span class='Ref_to_Proto'>EncodeSpecialDate</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN788"><span class='Ref_To_Local'>date</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN790"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../include/utils/datetime.h.html#LN290"><span class='Ref_to_Proto'>j2date</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN788"><span class='Ref_To_Local'>date</span></a> <span class='Operator'>+ </span><a href="../../../include/datatype/timestamp.h.html#LN162"><span class='Ref_to_Const'>POSTGRES_EPOCH_JDATE</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN789"><span class='Ref_To_Local'>tm</span></a><span class='Operator'>.</span><a href="../../../include/pgtime.h.html#LN31"><span class='Ref_to_Member'>tm_year</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN789"><span class='Ref_To_Local'>tm</span></a><span class='Operator'>.</span><a href="../../../include/pgtime.h.html#LN30"><span class='Ref_to_Member'>tm_mon</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN789"><span class='Ref_To_Local'>tm</span></a><span class='Operator'>.</span><a href="../../../include/pgtime.h.html#LN29"><span class='Ref_to_Member'>tm_mday</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <a href="../../../include/utils/datetime.h.html#LN316"><span class='Ref_to_Proto'>EncodeDateOnly</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN789"><span class='Ref_To_Local'>tm</span></a><span class='Delimiter'>, </span><a href="../../../include/miscadmin.h.html#LN215"><span class='Ref_to_Const'>USE_XSD_DATES</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN790"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN790"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN790"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN43"><span class='Ref_to_EnumConst'>JSONBTYPE_TIMESTAMP</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN809"></a>                    <a href="../../../include/datatype/timestamp.h.html#LN37"><span class='Ref_to_Typedef'>Timestamp</span></a>   <span class='Declare_Local'>timestamp</span><span class='Delimiter'>; 
</span><a name="LN810"></a>                    <span class='Control'>struct</span> <a href="../../../include/pgtime.h.html#LN24"><span class='Ref_to_Struct'>pg_tm</span></a> <span class='Declare_Local'>tm</span><span class='Delimiter'>; 
</span><a name="LN811"></a>                    <a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN9"><span class='Ref_to_Typedef'>fsec_t</span></a>      <span class='Declare_Local'>fsec</span><span class='Delimiter'>; 
</span><a name="LN812"></a>                    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN195"><span class='Ref_to_Const'>MAXDATELEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
                    <a href="jsonb.c.html#LN809"><span class='Ref_To_Local'>timestamp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN26"><span class='Ref_to_Macro'>DatumGetTimestamp</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Same as timestamp_out(), but forcing DateStyle */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/datatype/timestamp.h.html#LN121"><span class='Ref_to_Macro'>TIMESTAMP_NOT_FINITE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN809"><span class='Ref_To_Local'>timestamp</span></a><span class='Parentheses'>))</span> 
                        <a href="../../../interfaces/ecpg/pgtypeslib/timestamp.c.html#LN194"><span class='Ref_to_Func'>EncodeSpecialTimestamp</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN809"><span class='Ref_To_Local'>timestamp</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN812"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/timestamp.h.html#LN84"><span class='Ref_to_Proto'>timestamp2tm</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN809"><span class='Ref_To_Local'>timestamp</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN810"><span class='Ref_To_Local'>tm</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN811"><span class='Ref_To_Local'>fsec</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                        <a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN315"><span class='Ref_to_Proto'>EncodeDateTime</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN810"><span class='Ref_To_Local'>tm</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN811"><span class='Ref_To_Local'>fsec</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/miscadmin.h.html#LN215"><span class='Ref_to_Const'>USE_XSD_DATES</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN812"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATETIME_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"timestamp out of range"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN812"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN812"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN44"><span class='Ref_to_EnumConst'>JSONBTYPE_TIMESTAMPTZ</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN831"></a>                    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>timestamp</span><span class='Delimiter'>; 
</span><a name="LN832"></a>                    <span class='Control'>struct</span> <a href="../../../include/pgtime.h.html#LN24"><span class='Ref_to_Struct'>pg_tm</span></a> <span class='Declare_Local'>tm</span><span class='Delimiter'>; 
</span><a name="LN833"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>tz</span><span class='Delimiter'>; 
</span><a name="LN834"></a>                    <a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN9"><span class='Ref_to_Typedef'>fsec_t</span></a>      <span class='Declare_Local'>fsec</span><span class='Delimiter'>; 
</span><a name="LN835"></a>                    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>tzn</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN836"></a>                    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN195"><span class='Ref_to_Const'>MAXDATELEN</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
                    <a href="jsonb.c.html#LN831"><span class='Ref_To_Local'>timestamp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN27"><span class='Ref_to_Macro'>DatumGetTimestampTz</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Comment_Multi_Line'>/* Same as timestamptz_out(), but forcing DateStyle */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/datatype/timestamp.h.html#LN121"><span class='Ref_to_Macro'>TIMESTAMP_NOT_FINITE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN831"><span class='Ref_To_Local'>timestamp</span></a><span class='Parentheses'>))</span> 
                        <a href="../../../interfaces/ecpg/pgtypeslib/timestamp.c.html#LN194"><span class='Ref_to_Func'>EncodeSpecialTimestamp</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN831"><span class='Ref_To_Local'>timestamp</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN836"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/timestamp.h.html#LN84"><span class='Ref_to_Proto'>timestamp2tm</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN831"><span class='Ref_To_Local'>timestamp</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN833"><span class='Ref_To_Local'>tz</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN832"><span class='Ref_To_Local'>tm</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN834"><span class='Ref_To_Local'>fsec</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN835"><span class='Ref_To_Local'>tzn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                        <a href="../../../interfaces/ecpg/pgtypeslib/dt.h.html#LN315"><span class='Ref_to_Proto'>EncodeDateTime</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN832"><span class='Ref_To_Local'>tm</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN834"><span class='Ref_To_Local'>fsec</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN833"><span class='Ref_To_Local'>tz</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN835"><span class='Ref_To_Local'>tzn</span></a><span class='Delimiter'>, </span><a href="../../../include/miscadmin.h.html#LN215"><span class='Ref_to_Const'>USE_XSD_DATES</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN836"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DATETIME_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"timestamp out of range"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN836"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN836"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN49"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONCAST</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN45"><span class='Ref_to_EnumConst'>JSONBTYPE_JSON</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* parse the json right into the existing result object */ 
</span><a name="LN857"></a>                    <a href="../../../include/utils/jsonapi.h.html#LN50"><span class='Ref_to_Struct'>JsonLexContext</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lex</span><span class='Delimiter'>; 
</span><a name="LN858"></a>                    <a href="../../../include/utils/jsonapi.h.html#LN81"><span class='Ref_to_Struct'>JsonSemAction</span></a> <span class='Declare_Local'>sem</span><span class='Delimiter'>; 
</span><a name="LN859"></a>                    <a href="../../../../contrib/seg/segparse.y.html#LN46"><span class='Ref_to_Global_Var'>text</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>json</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN255"><span class='Ref_to_Macro'>DatumGetTextPP</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="jsonb.c.html#LN857"><span class='Ref_To_Local'>lex</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonapi.h.html#LN122"><span class='Ref_to_Proto'>makeJsonLexContext</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN859"><span class='Ref_To_Local'>json</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN83"><span class='Ref_to_Member'>semstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>; 
</span> 
                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN84"><span class='Ref_to_Member'>object_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN64"><span class='Ref_to_Proto'>jsonb_in_object_start</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN86"><span class='Ref_to_Member'>array_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN66"><span class='Ref_to_Proto'>jsonb_in_array_start</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN85"><span class='Ref_to_Member'>object_end</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN65"><span class='Ref_to_Proto'>jsonb_in_object_end</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN87"><span class='Ref_to_Member'>array_end</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN67"><span class='Ref_to_Proto'>jsonb_in_array_end</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN92"><span class='Ref_to_Member'>scalar</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN70"><span class='Ref_to_Proto'>jsonb_in_scalar</span></a><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonapi.h.html#LN88"><span class='Ref_to_Member'>object_field_start</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN68"><span class='Ref_to_Proto'>jsonb_in_object_field_start</span></a><span class='Delimiter'>; 
</span> 
                    <a href="../../../include/utils/jsonapi.h.html#LN104"><span class='Ref_to_Proto'>pg_parse_json</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN857"><span class='Ref_To_Local'>lex</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN858"><span class='Ref_To_Local'>sem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="jsonb.c.html#LN46"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONB</span></a><span class='Operator'>: 
</span>                <span class='Delimiter'>{ 
</span><a name="LN880"></a>                    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>jsonb</span> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN67"><span class='Ref_to_Macro'>DatumGetJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN881"></a>                    <a href="../../../include/utils/jsonb.h.html#LN323"><span class='Ref_to_Struct'>JsonbIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span> 
                    <a href="jsonb.c.html#LN881"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN880"><span class='Ref_To_Local'>jsonb</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN222"><span class='Ref_to_Macro'>JB_ROOT_IS_SCALAR</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN880"><span class='Ref_To_Local'>jsonb</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN881"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN881"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="jsonb.c.html#LN705"><span class='Ref_To_Local'>scalar_jsonb</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN894"></a>                        <a href="../../../include/utils/jsonb.h.html#LN19"><span class='Ref_to_Typedef'>JsonbIteratorToken</span></a> <span class='Declare_Local'>type</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN881"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                               <span class='Operator'>!= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Parentheses'>)</span> 
                        <span class='Delimiter'>{ 
</span>                            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a> <span class='Operator'>|| 
</span>                                <a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Parentheses'>) 
</span>                                <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                             <a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                            <span class='Control'>else</span> 
                                <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                             <a href="jsonb.c.html#LN894"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN647"><span class='Ref_to_Proto'>OidOutputFunctionCall</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN63"><span class='Ref_to_Proto'>checkStringLen</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN702"><span class='Ref_To_Local'>outputstr</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch tcategory &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Now insert jb into result, unless we did it recursively */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>is_null</span></a> <span class='Operator'>&& !</span><a href="jsonb.c.html#LN705"><span class='Ref_To_Local'>scalar_jsonb</span></a> <span class='Operator'>&& 
</span>        <a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>&GT;= </span><a href="jsonb.c.html#LN45"><span class='Ref_to_EnumConst'>JSONBTYPE_JSON</span></a> <span class='Operator'>&& </span><a href="jsonb.c.html#LN699"><span class='Ref_to_Parameter'>tcategory</span></a> <span class='Operator'>&LT;= </span><a href="jsonb.c.html#LN49"><span class='Ref_to_EnumConst'>JSONBTYPE_JSONCAST</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* work has been done recursively */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* single root scalar */ 
</span><a name="LN929"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>va</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN929"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN929"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN929"><span class='Ref_To_Local'>va</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>nElems <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN929"><span class='Ref_To_Local'>va</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN941"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a> <span class='Operator'>*</span><span class='Declare_Local'>o</span> <span class='Operator'>= &</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN305"><span class='Ref_to_Member'>contVal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN941"><span class='Ref_To_Local'>o</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN235"><span class='Ref_to_EnumConst'>jbvArray</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN236"><span class='Ref_to_EnumConst'>jbvObject</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN698"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="jsonb.c.html#LN700"><span class='Ref_to_Parameter'>key_scalar</span></a> <span class='Operator'>? </span><a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a> <span class='Operator'>: </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Delimiter'>, 
</span>                                             <span class='Operator'>&</span><a href="jsonb.c.html#LN704"><span class='Ref_To_Local'>jb</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected parent of nested structure"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end datum_to_jsonb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Process a single dimension of an array. 
 * If it's the innermost dimension, output the values, otherwise call 
 * ourselves recursively to process the next dimension. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN965"></a><span class='Declare_Function'>array_dim_to_jsonb</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>dim</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>ndims</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>dims</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vals</span><span class='Delimiter'>, 
</span><a name="LN966"></a>                   <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>nulls</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>valcount</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Parameter'>tcategory</span><span class='Delimiter'>, 
</span><a name="LN967"></a>                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>outfuncoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN969"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dim</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>ndims</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN969"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN969"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dims</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dim</span></a><span class='Delimiter'>]; </span><a href="jsonb.c.html#LN969"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dim</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>== </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>ndims</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>vals</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>valcount</span></a><span class='Delimiter'>], </span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>nulls</span></a><span class='Delimiter'>[</span><span class='Operator'>*</span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>valcount</span></a><span class='Delimiter'>], </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>tcategory</span></a><span class='Delimiter'>, 
</span>                           <a href="jsonb.c.html#LN967"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>valcount</span></a><span class='Parentheses'>)</span><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN75"><span class='Ref_to_Proto'>array_dim_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dim</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>ndims</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>dims</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>vals</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>nulls</span></a><span class='Delimiter'>, 
</span>                               <a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>valcount</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN966"><span class='Ref_to_Parameter'>tcategory</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN967"><span class='Ref_to_Parameter'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN965"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end array_dim_to_jsonb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Turn an array into JSON. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN997"></a><span class='Declare_Function'>array_to_jsonb_internal</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>array</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN999"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>v</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1000"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>element_type</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN999"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1001"></a>    <span class='Keyword'>int</span>        <span class='Operator'>*</span><span class='Declare_Local'>dim</span><span class='Delimiter'>; 
</span><a name="LN1002"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndim</span><span class='Delimiter'>; 
</span><a name="LN1003"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nitems</span><span class='Delimiter'>; 
</span><a name="LN1004"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1005"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>elements</span><span class='Delimiter'>; 
</span><a name="LN1006"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>nulls</span><span class='Delimiter'>; 
</span><a name="LN1007"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Local'>typlen</span><span class='Delimiter'>; 
</span><a name="LN1008"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>typbyval</span><span class='Delimiter'>; 
</span><a name="LN1009"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>typalign</span><span class='Delimiter'>; 
</span><a name="LN1010"></a>    <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Local'>tcategory</span><span class='Delimiter'>; 
</span><a name="LN1011"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>outfuncoid</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1002"><span class='Ref_To_Local'>ndim</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN999"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1001"><span class='Ref_To_Local'>dim</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN999"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1003"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>= </span><a href="arrayutils.c.html#LN73"><span class='Ref_to_Func'>ArrayGetNItems</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1002"><span class='Ref_To_Local'>ndim</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1001"><span class='Ref_To_Local'>dim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1003"><span class='Ref_To_Local'>nitems</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/utils/lsyscache.h.html#LN136"><span class='Ref_to_Proto'>get_typlenbyvalalign</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1000"><span class='Ref_To_Local'>element_type</span></a><span class='Delimiter'>, 
</span>                         <span class='Operator'>&</span><a href="jsonb.c.html#LN1007"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1008"><span class='Ref_To_Local'>typbyval</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1009"><span class='Ref_To_Local'>typalign</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1000"><span class='Ref_To_Local'>element_type</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="jsonb.c.html#LN1010"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1011"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN999"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1000"><span class='Ref_To_Local'>element_type</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1007"><span class='Ref_To_Local'>typlen</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1008"><span class='Ref_To_Local'>typbyval</span></a><span class='Delimiter'>, 
</span>                      <a href="jsonb.c.html#LN1009"><span class='Ref_To_Local'>typalign</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1005"><span class='Ref_To_Local'>elements</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1006"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="jsonb.c.html#LN1003"><span class='Ref_To_Local'>nitems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN75"><span class='Ref_to_Proto'>array_dim_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN997"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1002"><span class='Ref_To_Local'>ndim</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1001"><span class='Ref_To_Local'>dim</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1005"><span class='Ref_To_Local'>elements</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1006"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1004"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1010"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, 
</span>                       <a href="jsonb.c.html#LN1011"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1005"><span class='Ref_To_Local'>elements</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1006"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end array_to_jsonb_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Turn a composite / record into JSON. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1045"></a><span class='Declare_Function'>composite_to_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>composite</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1047"></a>    <a href="../../../include/access/htup.h.html#LN22"><span class='Ref_to_Typedef'>HeapTupleHeader</span></a> <span class='Declare_Local'>td</span><span class='Delimiter'>; 
</span><a name="LN1048"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tupType</span><span class='Delimiter'>; 
</span><a name="LN1049"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Local'>tupTypmod</span><span class='Delimiter'>; 
</span><a name="LN1050"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1051"></a>    <a href="../../../include/access/htup.h.html#LN61"><span class='Ref_to_Struct'>HeapTupleData</span></a> <span class='Declare_Local'>tmptup</span><span class='Delimiter'>, 
</span><a name="LN1052"></a>               <span class='Operator'>*</span><span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN1053"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1047"><span class='Ref_To_Local'>td</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN258"><span class='Ref_to_Macro'>DatumGetHeapTupleHeader</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>composite</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Extract rowtype info and find a tupdesc */ 
</span>    <a href="jsonb.c.html#LN1048"><span class='Ref_To_Local'>tupType</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN444"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypeId</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1047"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1049"><span class='Ref_To_Local'>tupTypmod</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN454"><span class='Ref_to_Macro'>HeapTupleHeaderGetTypMod</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1047"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/typcache.h.html#LN151"><span class='Ref_to_Proto'>lookup_rowtype_tupdesc</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1048"><span class='Ref_To_Local'>tupType</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1049"><span class='Ref_To_Local'>tupTypmod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build a temporary HeapTuple control structure */ 
</span>    <a href="jsonb.c.html#LN1051"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN63"><span class='Ref_to_Member'>t_len</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN438"><span class='Ref_to_Macro'>HeapTupleHeaderGetDatumLength</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1047"><span class='Ref_To_Local'>td</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1051"><span class='Ref_To_Local'>tmptup</span></a><span class='Operator'>.</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1047"><span class='Ref_To_Local'>td</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1052"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= &</span><a href="jsonb.c.html#LN1051"><span class='Ref_To_Local'>tmptup</span></a><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1071"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1073"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>attname</span><span class='Delimiter'>; 
</span><a name="LN1074"></a>        <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Local'>tcategory</span><span class='Delimiter'>; 
</span><a name="LN1075"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>outfuncoid</span><span class='Delimiter'>; 
</span><a name="LN1076"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attisdropped<span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1073"><span class='Ref_To_Local'>attname</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>attname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1076"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* don't need checkStringLen here - can't exceed maximum name length */ 
</span>        <a href="jsonb.c.html#LN1076"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN1073"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1076"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1073"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1076"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1071"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1052"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1072"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1072"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1074"><span class='Ref_To_Local'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN39"><span class='Ref_to_EnumConst'>JSONBTYPE_NULL</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1075"><span class='Ref_To_Local'>outfuncoid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1053"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="jsonb.c.html#LN1074"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1075"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1071"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1072"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1074"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1075"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;tupdesc-&GT;natts;... &raquo; </span> 
 
    <a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1045"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN106"><span class='Ref_to_Macro'>ReleaseTupleDesc</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1050"><span class='Ref_To_Local'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end composite_to_jsonb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Append JSON text for "val" to "result". 
 * 
 * This is just a thin wrapper around datum_to_jsonb.  If the same type will be 
 * printed many times, avoid using this; better to do the jsonb_categorize_type 
 * lookups only once. 
 */ 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1117"></a><span class='Declare_Function'>add_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>val</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_null</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, 
</span><a name="LN1118"></a>          <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>val_type</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>key_scalar</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1120"></a>    <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Local'>tcategory</span><span class='Delimiter'>; 
</span><a name="LN1121"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>outfuncoid</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1118"><span class='Ref_to_Parameter'>val_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine input data type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1117"><span class='Ref_to_Parameter'>is_null</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN1120"><span class='Ref_To_Local'>tcategory</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN39"><span class='Ref_to_EnumConst'>JSONBTYPE_NULL</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1121"><span class='Ref_To_Local'>outfuncoid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1118"><span class='Ref_to_Parameter'>val_type</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="jsonb.c.html#LN1120"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1121"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1117"><span class='Ref_to_Parameter'>val</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1117"><span class='Ref_to_Parameter'>is_null</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1117"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1120"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1121"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1118"><span class='Ref_to_Parameter'>key_scalar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end add_jsonb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL function to_jsonb(anyvalue) 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1144"></a><span class='Declare_Function'>to_jsonb</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1146"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1147"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>val_type</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1148"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1149"></a>    <a href="jsonb.c.html#LN37"><span class='Ref_to_Typedef'>JsonbTypeCategory</span></a> <span class='Declare_Local'>tcategory</span><span class='Delimiter'>; 
</span><a name="LN1150"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>outfuncoid</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1147"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine input data type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1147"><span class='Ref_To_Local'>val_type</span></a><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="jsonb.c.html#LN1149"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1150"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1148"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1146"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1148"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1149"><span class='Ref_To_Local'>tcategory</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1150"><span class='Ref_To_Local'>outfuncoid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1148"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end to_jsonb &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL function jsonb_build_object(variadic "any") 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1171"></a><span class='Declare_Function'>jsonb_build_object</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1173"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1174"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1175"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>arg</span><span class='Delimiter'>; 
</span><a name="LN1176"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>val_type</span><span class='Delimiter'>; 
</span><a name="LN1177"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1173"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>% </span><span class='Number'>2</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid number of arguments: object must be matched key value pairs"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN1173"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+= </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* process key */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"argument %d: key must not be null"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * turn a constant (more or less literal) value that's of unknown type 
         * into text. Unknowns come in as a cstring pointer. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a> <span class='Operator'>&& </span><a href="../../../include/fmgr.h.html#LN665"><span class='Ref_to_Proto'>get_fn_expr_arg_stable</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine data type for argument %d"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN85"><span class='Ref_to_Proto'>add_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* process value */ 
</span> 
        <a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* see comments above */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a> <span class='Operator'>&& </span><a href="../../../include/fmgr.h.html#LN665"><span class='Ref_to_Proto'>get_fn_expr_arg_stable</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
                <a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine data type for argument %d"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>2</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN85"><span class='Ref_to_Proto'>add_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1175"><span class='Ref_To_Local'>arg</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1174"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1176"><span class='Ref_To_Local'>val_type</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nargs;i+=2 &raquo; </span> 
 
    <a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1177"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_build_object &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * degenerate case of jsonb_build_object where it gets 0 arguments. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1250"></a><span class='Declare_Function'>jsonb_build_object_noargs</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1252"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1252"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1252"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1252"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1252"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1252"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SQL function jsonb_build_array(variadic "any") 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1266"></a><span class='Declare_Function'>jsonb_build_array</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1268"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1269"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1270"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>arg</span><span class='Delimiter'>; 
</span><a name="LN1271"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>val_type</span><span class='Delimiter'>; 
</span><a name="LN1272"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN1268"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* see comments in jsonb_build_object above */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a> <span class='Operator'>&& </span><a href="../../../include/fmgr.h.html#LN665"><span class='Ref_to_Proto'>get_fn_expr_arg_stable</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                <a href="jsonb.c.html#LN1270"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="jsonb.c.html#LN1270"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1270"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>|| </span><a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a> <span class='Operator'>== </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN43"><span class='Ref_to_Const'>UNKNOWNOID</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine data type for argument %d"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN85"><span class='Ref_to_Proto'>add_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1270"><span class='Ref_To_Local'>arg</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1269"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1271"><span class='Ref_To_Local'>val_type</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;nargs;i++ &raquo; </span> 
 
    <a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1272"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_build_array &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * degenerate case of jsonb_build_array where it gets 0 arguments. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1310"></a><span class='Declare_Function'>jsonb_build_array_noargs</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1312"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1312"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1312"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1312"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1312"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1312"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL function jsonb_object(text[]) 
 * 
 * take a one or two dimensional array of text as name value pairs 
 * for a jsonb object. 
 * 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1331"></a><span class='Declare_Function'>jsonb_object</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1333"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>in_array</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1334"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndims</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1333"><span class='Ref_To_Local'>in_array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1335"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>in_datums</span><span class='Delimiter'>; 
</span><a name="LN1336"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>in_nulls</span><span class='Delimiter'>; 
</span><a name="LN1337"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>in_count</span><span class='Delimiter'>, 
</span><a name="LN1338"></a>                <span class='Declare_Local'>count</span><span class='Delimiter'>, 
</span><a name="LN1339"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1340"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1334"><span class='Ref_To_Local'>ndims</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span>            <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="jsonb.c.html#LN1420"><span class='Ref_to_Label'>close_object</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <span class='Number'>1</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1333"><span class='Ref_To_Local'>in_array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span> <span class='Operator'>% </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"array must have even number of elements"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <span class='Number'>2</span><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1333"><span class='Ref_To_Local'>in_array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"array must have two columns"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"wrong number of array subscripts"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch ndims &raquo; </span> 
 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1333"><span class='Ref_To_Local'>in_array</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="jsonb.c.html#LN1335"><span class='Ref_To_Local'>in_datums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1336"><span class='Ref_To_Local'>in_nulls</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1337"><span class='Ref_To_Local'>in_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1338"><span class='Ref_To_Local'>count</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1337"><span class='Ref_To_Local'>in_count</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN1338"><span class='Ref_To_Local'>count</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1380"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1381"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span><span class='Delimiter'>; 
</span><a name="LN1382"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1336"><span class='Ref_To_Local'>in_nulls</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NULL_VALUE_NOT_ALLOWED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"null value not allowed for object key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1335"><span class='Ref_To_Local'>in_datums</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1382"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN1382"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1336"><span class='Ref_To_Local'>in_nulls</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1335"><span class='Ref_To_Local'>in_datums</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1339"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1382"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span> 
            <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN1382"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1381"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1380"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;count;++i &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1335"><span class='Ref_To_Local'>in_datums</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1336"><span class='Ref_To_Local'>in_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN1420"></a><span class='Label'>close_object</span><span class='Operator'>: 
</span>    <a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1340"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_object &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SQL function jsonb_object(text[], text[]) 
 * 
 * take separate name and value arrays of text to construct a jsonb object 
 * pairwise. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1433"></a><span class='Declare_Function'>jsonb_object_two_arg</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1435"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>key_array</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>val_array</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1437"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nkdims</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1435"><span class='Ref_To_Local'>key_array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1438"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nvdims</span> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1436"><span class='Ref_To_Local'>val_array</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1439"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>key_datums</span><span class='Delimiter'>, 
</span><a name="LN1440"></a>               <span class='Operator'>*</span><span class='Declare_Local'>val_datums</span><span class='Delimiter'>; 
</span><a name="LN1441"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>key_nulls</span><span class='Delimiter'>, 
</span><a name="LN1442"></a>               <span class='Operator'>*</span><span class='Declare_Local'>val_nulls</span><span class='Delimiter'>; 
</span><a name="LN1443"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>key_count</span><span class='Delimiter'>, 
</span><a name="LN1444"></a>                <span class='Declare_Local'>val_count</span><span class='Delimiter'>, 
</span><a name="LN1445"></a>                <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1446"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1437"><span class='Ref_To_Local'>nkdims</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="jsonb.c.html#LN1437"><span class='Ref_To_Local'>nkdims</span></a> <span class='Operator'>!= </span><a href="jsonb.c.html#LN1438"><span class='Ref_To_Local'>nvdims</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"wrong number of array subscripts"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1437"><span class='Ref_To_Local'>nkdims</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>goto</span> <span class='Symbol_Characters'>&darr;</span><a href="jsonb.c.html#LN1517"><span class='Ref_to_Label'>close_object</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1435"><span class='Ref_To_Local'>key_array</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="jsonb.c.html#LN1439"><span class='Ref_To_Local'>key_datums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1441"><span class='Ref_To_Local'>key_nulls</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1443"><span class='Ref_To_Local'>key_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1436"><span class='Ref_To_Local'>val_array</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'i'</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="jsonb.c.html#LN1440"><span class='Ref_To_Local'>val_datums</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1442"><span class='Ref_To_Local'>val_nulls</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1444"><span class='Ref_To_Local'>val_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1443"><span class='Ref_To_Local'>key_count</span></a> <span class='Operator'>!= </span><a href="jsonb.c.html#LN1444"><span class='Ref_To_Local'>val_count</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ARRAY_SUBSCRIPT_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"mismatched array dimensions"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="jsonb.c.html#LN1443"><span class='Ref_To_Local'>key_count</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1475"></a>        <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1476"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span><span class='Delimiter'>; 
</span><a name="LN1477"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1441"><span class='Ref_To_Local'>key_nulls</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NULL_VALUE_NOT_ALLOWED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"null value not allowed for object key"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1439"><span class='Ref_To_Local'>key_datums</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1477"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN1477"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1442"><span class='Ref_To_Local'>val_nulls</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN230"><span class='Ref_to_EnumConst'>jbvNull</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1440"><span class='Ref_To_Local'>val_datums</span></a><span class='Delimiter'>[</span><a href="jsonb.c.html#LN1445"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1477"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Delimiter'>; 
</span> 
            <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>= </span><a href="jsonb.c.html#LN1477"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>            <a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1476"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1475"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;key_count;++i &raquo; </span> 
 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1439"><span class='Ref_To_Local'>key_datums</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1441"><span class='Ref_To_Local'>key_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1440"><span class='Ref_To_Local'>val_datums</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1442"><span class='Ref_To_Local'>val_nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN1517"></a><span class='Label'>close_object</span><span class='Operator'>: 
</span>    <a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1446"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_object_two_arg &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * shallow clone of a parse state, suitable for use in aggregate 
 * final functions that will only append to the values rather than 
 * change them. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>* 
</span><a name="LN1530"></a><span class='Declare_Function'>clone_parse_state</span><span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>state</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1532"></a>    <a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>, 
</span><a name="LN1533"></a>               <span class='Operator'>*</span><span class='Declare_Local'>icursor</span><span class='Delimiter'>, 
</span><a name="LN1534"></a>               <span class='Operator'>*</span><span class='Declare_Local'>ocursor</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1530"><span class='Ref_to_Parameter'>state</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1532"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1530"><span class='Ref_to_Parameter'>state</span></a><span class='Delimiter'>; 
</span>    <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1532"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN305"><span class='Ref_to_Member'>contVal</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN305"><span class='Ref_to_Member'>contVal</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN306"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN306"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN307"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1533"><span class='Ref_To_Local'>icursor</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN307"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/jsonb.h.html#LN303"><span class='Ref_to_Struct'>JsonbParseState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN307"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="jsonb.c.html#LN1534"><span class='Ref_To_Local'>ocursor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN307"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="jsonb.c.html#LN1532"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end clone_parse_state &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * jsonb_agg aggregate function 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1562"></a><span class='Declare_Function'>jsonb_agg_transfn</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1564"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>, 
</span><a name="LN1565"></a>                <span class='Declare_Local'>aggcontext</span><span class='Delimiter'>; 
</span><a name="LN1566"></a>    <a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1567"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>elem</span><span class='Delimiter'>; 
</span><a name="LN1568"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN1569"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1570"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>single_scalar</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1571"></a>    <a href="../../../include/utils/jsonb.h.html#LN323"><span class='Ref_to_Struct'>JsonbIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN1572"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>jbelem</span><span class='Delimiter'>; 
</span><a name="LN1573"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1574"></a>    <a href="../../../include/utils/jsonb.h.html#LN19"><span class='Ref_to_Typedef'>JsonbIteratorToken</span></a> <span class='Declare_Local'>type</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1565"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* cannot be called directly because of internal-type argument */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"jsonb_agg_transfn called in non-aggregate context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* set up the accumulator on the first go round */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1586"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>arg_type</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1586"><span class='Ref_To_Local'>arg_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine input data type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1564"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1565"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1564"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1586"><span class='Ref_To_Local'>arg_type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN58"><span class='Ref_to_Member'>val_category</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN59"><span class='Ref_to_Member'>val_output_func</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PG_ARGISNULL(0) &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* turn the argument into jsonb in the normal function context */ 
</span> 
    <a href="jsonb.c.html#LN1568"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1567"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1568"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1567"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN58"><span class='Ref_to_Member'>val_category</span></a><span class='Delimiter'>, 
</span>                   <a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN59"><span class='Ref_to_Member'>val_output_func</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1572"><span class='Ref_To_Local'>jbelem</span></a> <span class='Operator'>= </span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1567"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* switch to the aggregate context for accumulation operations */ 
</span> 
    <a href="jsonb.c.html#LN1564"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1565"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1571"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1572"><span class='Ref_To_Local'>jbelem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1571"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar<span class='Parentheses'>) 
</span>                    <a href="jsonb.c.html#LN1570"><span class='Ref_To_Local'>single_scalar</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                 <a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN1570"><span class='Ref_To_Local'>single_scalar</span></a><span class='Parentheses'>) 
</span>                    <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                 <a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* copy string values in the aggregate context */ 
</span><a name="LN1654"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1654"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1654"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* same for numeric */ 
</span>                    <a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric <span class='Operator'>= 
</span>                    <a href="../../../include/utils/numeric.h.html#LN48"><span class='Ref_to_Macro'>DatumGetNumeric</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="numeric.c.html#LN1146"><span class='Ref_to_Func'>numeric_uplus</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/utils/numeric.h.html#LN50"><span class='Ref_to_Macro'>NumericGetDatum</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1569"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="jsonb.c.html#LN1574"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1573"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown jsonb iterator token type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (type=JsonbIteratorNe... &raquo; </span> 
 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1564"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1566"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_agg_transfn &raquo; </span> 
 
<a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1680"></a><span class='Declare_Function'>jsonb_agg_finalfn</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1682"></a>    <a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arg</span><span class='Delimiter'>; 
</span><a name="LN1683"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1684"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>out</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cannot be called directly because of internal-type argument */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* returns null iff no input values */ 
</span> 
    <a href="jsonb.c.html#LN1682"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to do a shallow clone of the argument in case the final 
     * function is called more than once, so we avoid changing the argument. A 
     * shallow clone is sufficient as we aren't going to change any of the 
     * values, just add the final array end marker. 
     */ 
</span> 
    <a href="jsonb.c.html#LN1683"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN87"><span class='Ref_to_Proto'>clone_parse_state</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1682"><span class='Ref_To_Local'>arg</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1683"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1683"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1684"><span class='Ref_To_Local'>out</span></a> <span class='Operator'>= </span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1683"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1684"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_agg_finalfn &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * jsonb_object_agg aggregate function 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1715"></a><span class='Declare_Function'>jsonb_object_agg_transfn</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1717"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>, 
</span><a name="LN1718"></a>                <span class='Declare_Local'>aggcontext</span><span class='Delimiter'>; 
</span><a name="LN1719"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>elem</span><span class='Delimiter'>; 
</span><a name="LN1720"></a>    <a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>state</span><span class='Delimiter'>; 
</span><a name="LN1721"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN1722"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1723"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>single_scalar</span><span class='Delimiter'>; 
</span><a name="LN1724"></a>    <a href="../../../include/utils/jsonb.h.html#LN323"><span class='Ref_to_Struct'>JsonbIterator</span></a> <span class='Operator'>*</span><span class='Declare_Local'>it</span><span class='Delimiter'>; 
</span><a name="LN1725"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>jbkey</span><span class='Delimiter'>, 
</span><a name="LN1726"></a>               <span class='Operator'>*</span><span class='Declare_Local'>jbval</span><span class='Delimiter'>; 
</span><a name="LN1727"></a>    <a href="../../../include/utils/jsonb.h.html#LN247"><span class='Ref_to_Struct'>JsonbValue</span></a>  <span class='Declare_Local'>v</span><span class='Delimiter'>; 
</span><a name="LN1728"></a>    <a href="../../../include/utils/jsonb.h.html#LN19"><span class='Ref_to_Typedef'>JsonbIteratorToken</span></a> <span class='Declare_Local'>type</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1718"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* cannot be called directly because of internal-type argument */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"jsonb_object_agg_transfn called in non-aggregate context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* set up the accumulator on the first go round */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1740"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>arg_type</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1717"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1718"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1717"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine input data type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN56"><span class='Ref_to_Member'>key_category</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN57"><span class='Ref_to_Member'>key_output_func</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span>fcinfo<span class='Operator'>-&GT;</span>flinfo<span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not determine input data type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="jsonb.c.html#LN71"><span class='Ref_to_Proto'>jsonb_categorize_type</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1740"><span class='Ref_To_Local'>arg_type</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN58"><span class='Ref_to_Member'>val_category</span></a><span class='Delimiter'>, 
</span>                              <span class='Operator'>&</span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN59"><span class='Ref_to_Member'>val_output_func</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if PG_ARGISNULL(0) &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* turn the argument into jsonb in the normal function context */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"field name must not be null"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1721"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1721"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN56"><span class='Ref_to_Member'>key_category</span></a><span class='Delimiter'>, 
</span>                   <a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN57"><span class='Ref_to_Member'>key_output_func</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1725"><span class='Ref_To_Local'>jbkey</span></a> <span class='Operator'>= </span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1721"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span> <span class='Operator'>: </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN82"><span class='Ref_to_Proto'>datum_to_jsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1721"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN58"><span class='Ref_to_Member'>val_category</span></a><span class='Delimiter'>, 
</span>                   <a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN59"><span class='Ref_to_Member'>val_output_func</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1726"><span class='Ref_To_Local'>jbval</span></a> <span class='Operator'>= </span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1719"><span class='Ref_To_Local'>elem</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1724"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1725"><span class='Ref_To_Local'>jbkey</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* switch to the aggregate context for accumulation operations */ 
</span> 
    <a href="jsonb.c.html#LN1717"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1718"><span class='Ref_To_Local'>aggcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * keys should be scalar, and we should have already checked for that 
     * above when calling datum_to_jsonb, so we only need to look for these 
     * things. 
     */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1724"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar<span class='Parentheses'>) 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected structure for key"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* copy string values in the aggregate context */ 
</span><a name="LN1825"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1825"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1825"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"object keys must be strings"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected structure for key"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (type=JsonbIteratorNe... &raquo; </span> 
 
    <a href="jsonb.c.html#LN1724"><span class='Ref_To_Local'>it</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN365"><span class='Ref_to_Proto'>JsonbIteratorInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1726"><span class='Ref_To_Local'>jbval</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/jsonb.h.html#LN217"><span class='Ref_to_Member'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1723"><span class='Ref_To_Local'>single_scalar</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * values can be anything, including structured and null, so we treat them 
     * as in json_agg_transfn, except that single scalars are always pushed as 
     * WJB_VALUE items. 
     */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN366"><span class='Ref_to_Proto'>JsonbIteratorNext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1724"><span class='Ref_To_Local'>it</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="../../../include/utils/jsonb.h.html#LN21"><span class='Ref_to_EnumConst'>WJB_DONE</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN25"><span class='Ref_to_EnumConst'>WJB_BEGIN_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>array<span class='Operator'>.</span>rawScalar<span class='Parentheses'>) 
</span>                    <a href="jsonb.c.html#LN1723"><span class='Ref_To_Local'>single_scalar</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                 <a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN26"><span class='Ref_to_EnumConst'>WJB_END_ARRAY</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="jsonb.c.html#LN1723"><span class='Ref_To_Local'>single_scalar</span></a><span class='Parentheses'>) 
</span>                    <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                                 <a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN27"><span class='Ref_to_EnumConst'>WJB_BEGIN_OBJECT</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Operator'>: 
</span>                <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN24"><span class='Ref_to_EnumConst'>WJB_ELEM</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN22"><span class='Ref_to_EnumConst'>WJB_KEY</span></a><span class='Operator'>: 
</span>            <span class='Control'>case</span> <a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN231"><span class='Ref_to_EnumConst'>jbvString</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* copy string values in the aggregate context */ 
</span><a name="LN1884"></a>                    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>buf</span> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1884"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>len <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>string<span class='Operator'>.</span>val <span class='Operator'>= </span><a href="jsonb.c.html#LN1884"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN249"><span class='Ref_to_Member'>type</span></a> <span class='Operator'>== </span><a href="../../../include/utils/jsonb.h.html#LN232"><span class='Ref_to_EnumConst'>jbvNumeric</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* same for numeric */ 
</span>                    <a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric <span class='Operator'>= 
</span>                    <a href="../../../include/utils/numeric.h.html#LN48"><span class='Ref_to_Macro'>DatumGetNumeric</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN583"><span class='Ref_to_Macro'>DirectFunctionCall1</span></a><span class='Parentheses'>(</span><a href="numeric.c.html#LN1146"><span class='Ref_to_Func'>numeric_uplus</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/utils/numeric.h.html#LN50"><span class='Ref_to_Macro'>NumericGetDatum</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Operator'>.</span><a href="../../../include/utils/jsonb.h.html#LN279"><span class='Ref_to_Member'>val</span></a><span class='Operator'>.</span>numeric<span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1722"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                             <a href="jsonb.c.html#LN1723"><span class='Ref_To_Local'>single_scalar</span></a> <span class='Operator'>? </span><a href="../../../include/utils/jsonb.h.html#LN23"><span class='Ref_to_EnumConst'>WJB_VALUE</span></a> <span class='Operator'>: </span><a href="jsonb.c.html#LN1728"><span class='Ref_To_Local'>type</span></a><span class='Delimiter'>, 
</span>                                             <span class='Operator'>&</span><a href="jsonb.c.html#LN1727"><span class='Ref_To_Local'>v</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unknown jsonb iterator token type"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch type &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (type=JsonbIteratorNe... &raquo; </span> 
 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1717"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1720"><span class='Ref_To_Local'>state</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_object_agg_transfn &raquo; </span> 
 
<a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1911"></a><span class='Declare_Function'>jsonb_object_agg_finalfn</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1913"></a>    <a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>arg</span><span class='Delimiter'>; 
</span><a name="LN1914"></a>    <a href="jsonb.c.html#LN30"><span class='Ref_to_Struct'>JsonbInState</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1915"></a>    <a href="../../../include/utils/jsonb.h.html#LN214"><span class='Ref_to_Typedef'>Jsonb</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>out</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* cannot be called directly because of internal-type argument */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* returns null iff no input values */ 
</span> 
    <a href="jsonb.c.html#LN1913"><span class='Ref_To_Local'>arg</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="jsonb.c.html#LN53"><span class='Ref_to_Struct'>JsonbAggState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to do a shallow clone of the argument's res field in case the 
     * final function is called more than once, so we avoid changing the 
     * aggregate state value.  A shallow clone is sufficient as we aren't 
     * going to change any of the values, just add the final object end 
     * marker. 
     */ 
</span> 
    <a href="jsonb.c.html#LN1914"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a> <span class='Operator'>= </span><a href="jsonb.c.html#LN87"><span class='Ref_to_Proto'>clone_parse_state</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1913"><span class='Ref_To_Local'>arg</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN55"><span class='Ref_to_Member'>res</span></a><span class='Operator'>-&GT;</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1914"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a> <span class='Operator'>= </span><a href="../../../include/utils/jsonb.h.html#LN363"><span class='Ref_to_Proto'>pushJsonbValue</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="jsonb.c.html#LN1914"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN32"><span class='Ref_to_Member'>parseState</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/jsonb.h.html#LN28"><span class='Ref_to_EnumConst'>WJB_END_OBJECT</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="jsonb.c.html#LN1915"><span class='Ref_To_Local'>out</span></a> <span class='Operator'>= </span><a href="jsonb_util.c.html#LN77"><span class='Ref_to_Func'>JsonbValueToJsonb</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1914"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="jsonb.c.html#LN33"><span class='Ref_to_Member'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="jsonb.c.html#LN1915"><span class='Ref_To_Local'>out</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end jsonb_object_agg_finalfn &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>