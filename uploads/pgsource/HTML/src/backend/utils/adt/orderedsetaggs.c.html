<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\adt\orderedsetaggs.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\adt\orderedsetaggs.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:52 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * orderedsetaggs.c 
 *      Ordered-set aggregate functions. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/adt/orderedsetaggs.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;float.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_aggregate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_operator.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/executor.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/tlist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/array.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tuplesort.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Generic support for ordered-set aggregates 
 * 
 * The state for an ordered-set aggregate is divided into a per-group struct 
 * (which is the internal-type transition state datum returned to nodeAgg.c) 
 * and a per-query struct, which contains data and sub-objects that we can 
 * create just once per query because they will not change across groups. 
 * The per-query struct and subsidiary data live in the executor's per-query 
 * memory context, and go away implicitly at ExecutorEnd(). 
 */ 
</span> 
<a name="LN44"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>OSAPerQueryState</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Aggref for this aggregate: */ 
</span><a name="LN47"></a>    <a href="../../../include/nodes/primnodes.h.html#LN290"><span class='Ref_to_Struct'>Aggref</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>aggref</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Memory context containing this struct and other per-query data: */ 
</span><a name="LN49"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>qcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These fields are used only when accumulating tuples: */ 
</span> 
    <span class='Comment_Multi_Line'>/* Tuple descriptor for tuples inserted into sortstate: */ 
</span><a name="LN54"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Member'>tupdesc</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Tuple slot we can use for inserting/extracting tuples: */ 
</span><a name="LN56"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tupslot</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Per-sort-column sorting information */ 
</span><a name="LN58"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>numSortCols</span><span class='Delimiter'>; 
</span><a name="LN59"></a>    <a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Operator'>*</span><span class='Declare_Member'>sortColIdx</span><span class='Delimiter'>; 
</span><a name="LN60"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>sortOperators</span><span class='Delimiter'>; 
</span><a name="LN61"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>eqOperators</span><span class='Delimiter'>; 
</span><a name="LN62"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>        <span class='Operator'>*</span><span class='Declare_Member'>sortCollations</span><span class='Delimiter'>; 
</span><a name="LN63"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Member'>sortNullsFirsts</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Equality operator call info, created only if needed: */ 
</span><a name="LN65"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Member'>equalfns</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These fields are used only when accumulating datums: */ 
</span> 
    <span class='Comment_Multi_Line'>/* Info about datatype of datums being sorted: */ 
</span><a name="LN70"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>sortColType</span><span class='Delimiter'>; 
</span><a name="LN71"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>typLen</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>typByVal</span><span class='Delimiter'>; 
</span><a name="LN73"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>typAlign</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Info about sort ordering: */ 
</span><a name="LN75"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>sortOperator</span><span class='Delimiter'>; 
</span><a name="LN76"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>eqOperator</span><span class='Delimiter'>; 
</span><a name="LN77"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>sortCollation</span><span class='Delimiter'>; 
</span><a name="LN78"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>sortNullsFirst</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Equality operator call info, created only if needed: */ 
</span><a name="LN80"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>equalfn</span><span class='Delimiter'>; 
</span><a name="LN81"></a>}<span class='Auto_Annotations'> &laquo; end OSAPerQueryState &raquo; </span> <span class='Declare_Typedef'>OSAPerQueryState</span><span class='Delimiter'>; 
</span> 
<a name="LN83"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>OSAPerGroupState</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Link to the per-query state for this aggregate: */ 
</span><a name="LN86"></a>    <a href="orderedsetaggs.c.html#LN44"><span class='Ref_to_Struct'>OSAPerQueryState</span></a> <span class='Operator'>*</span><span class='Declare_Member'>qstate</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Memory context containing per-group data: */ 
</span><a name="LN88"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>gcontext</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Sort object we're accumulating data in: */ 
</span><a name="LN90"></a>    <a href="../sort/tuplesort.c.html#LN270"><span class='Ref_to_Struct'>Tuplesortstate</span></a> <span class='Operator'>*</span><span class='Declare_Member'>sortstate</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Number of normal rows inserted into sortstate: */ 
</span><a name="LN92"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Member'>number_of_rows</span><span class='Delimiter'>; 
</span><a name="LN93"></a>} <span class='Declare_Typedef'>OSAPerGroupState</span><span class='Delimiter'>; 
</span> 
<a name="LN95"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ordered_set_shutdown</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set up working state for an ordered-set aggregate 
 */ 
</span><span class='Keyword'>static </span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>* 
</span><a name="LN102"></a><span class='Declare_Function'>ordered_set_startup</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>use_tuples</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN104"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN105"></a>    <a href="orderedsetaggs.c.html#LN44"><span class='Ref_to_Struct'>OSAPerQueryState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>qstate</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>gcontext</span><span class='Delimiter'>; 
</span><a name="LN107"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check we're called as aggregate (and not a window function), and get 
     * the Agg node's group-lifespan context (which might change from group to 
     * group, so we shouldn't cache it in the per-query state). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN106"><span class='Ref_To_Local'>gcontext</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ordered-set aggregate called in non-aggregate context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We keep a link to the per-query state in fn_extra; if it's not there, 
     * create it, and do the per-query setup we need. 
     */ 
</span>    <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN44"><span class='Ref_to_Struct'>OSAPerQueryState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN63"><span class='Ref_to_Member'>fn_extra</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN124"></a>        <a href="../../../include/nodes/primnodes.h.html#LN290"><span class='Ref_to_Struct'>Aggref</span></a>     <span class='Operator'>*</span><span class='Declare_Local'>aggref</span><span class='Delimiter'>; 
</span><a name="LN125"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>qcontext</span><span class='Delimiter'>; 
</span><a name="LN126"></a>        <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>sortlist</span><span class='Delimiter'>; 
</span><a name="LN127"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>numSortCols</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Get the Aggref so we can examine aggregate's arguments */ 
</span>        <a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN697"><span class='Ref_to_Proto'>AggGetAggref</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ordered-set aggregate called in non-aggregate context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/catalog/pg_aggregate.h.html#LN128"><span class='Ref_to_Macro'>AGGKIND_IS_ORDERED_SET</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN307"><span class='Ref_to_Member'>aggkind</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ordered-set aggregate support function called for non-ordered-set aggregate"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Prepare per-query structures in the fn_mcxt, which we assume is the 
         * executor's per-query context; in any case it's the right place to 
         * keep anything found via fn_extra. 
         */ 
</span>        <a href="orderedsetaggs.c.html#LN125"><span class='Ref_To_Local'>qcontext</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN64"><span class='Ref_to_Member'>fn_mcxt</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN107"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN125"><span class='Ref_To_Local'>qcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN44"><span class='Ref_to_Struct'>OSAPerQueryState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN44"><span class='Ref_to_Struct'>OSAPerQueryState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN47"><span class='Ref_to_Member'>aggref</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN49"><span class='Ref_to_Member'>qcontext</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN125"><span class='Ref_To_Local'>qcontext</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Extract the sort information */ 
</span>        <a href="orderedsetaggs.c.html#LN126"><span class='Ref_To_Local'>sortlist</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN301"><span class='Ref_to_Member'>aggorder</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN126"><span class='Ref_To_Local'>sortlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>use_tuples</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN154"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>ishypothetical</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN307"><span class='Ref_to_Member'>aggkind</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_aggregate.h.html#LN125"><span class='Ref_to_Const'>AGGKIND_HYPOTHETICAL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN155"></a>            <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN156"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN154"><span class='Ref_To_Local'>ishypothetical</span></a><span class='Parentheses'>) 
</span>                <a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* make space for flag column */ 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN58"><span class='Ref_to_Member'>numSortCols</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN59"><span class='Ref_to_Member'>sortColIdx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN60"><span class='Ref_to_Member'>sortOperators</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN61"><span class='Ref_to_Member'>eqOperators</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN62"><span class='Ref_to_Member'>sortCollations</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN63"><span class='Ref_to_Member'>sortNullsFirsts</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN155"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN126"><span class='Ref_To_Local'>sortlist</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN170"></a>                <a href="../../../include/nodes/parsenodes.h.html#LN1161"><span class='Ref_to_Struct'>SortGroupClause</span></a> <span class='Operator'>*</span><span class='Declare_Local'>sortcl</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN1161"><span class='Ref_to_Struct'>SortGroupClause</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN155"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN171"></a>                <a href="../../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span> <span class='Operator'>= </span><a href="../../../include/optimizer/tlist.h.html#LN37"><span class='Ref_to_Proto'>get_sortgroupclause_tle</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN170"><span class='Ref_To_Local'>sortcl</span></a><span class='Delimiter'>, 
</span>                                                           <a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN300"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* the parser should have made sure of this */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN170"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1166"><span class='Ref_to_Member'>sortop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN59"><span class='Ref_to_Member'>sortColIdx</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN171"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN1367"><span class='Ref_to_Member'>resno</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN60"><span class='Ref_to_Member'>sortOperators</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN170"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1166"><span class='Ref_to_Member'>sortop</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN61"><span class='Ref_to_Member'>eqOperators</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN170"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1165"><span class='Ref_to_Member'>eqop</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN62"><span class='Ref_to_Member'>sortCollations</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/nodeFuncs.h.html#LN38"><span class='Ref_to_Proto'>exprCollation</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN171"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN63"><span class='Ref_to_Member'>sortNullsFirsts</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN170"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1167"><span class='Ref_to_Member'>nulls_first</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN154"><span class='Ref_To_Local'>ishypothetical</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Add an integer flag column as the last sort column */ 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN59"><span class='Ref_to_Member'>sortColIdx</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN300"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN60"><span class='Ref_to_Member'>sortOperators</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/catalog/pg_operator.h.html#LN132"><span class='Ref_to_Const'>Int4LessOperator</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN61"><span class='Ref_to_Member'>eqOperators</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/catalog/pg_operator.h.html#LN129"><span class='Ref_to_Const'>Int4EqualOperator</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN62"><span class='Ref_to_Member'>sortCollations</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN63"><span class='Ref_to_Member'>sortNullsFirsts</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Get a tupledesc corresponding to the aggregated inputs 
             * (including sort expressions) of the agg. 
             */ 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../../include/executor/executor.h.html#LN405"><span class='Ref_to_Proto'>ExecTypeFromTL</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN300"><span class='Ref_to_Member'>args</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If we need a flag column, hack the tupledesc to include that */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN154"><span class='Ref_To_Local'>ishypothetical</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN207"></a>                <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>newdesc</span><span class='Delimiter'>; 
</span><a name="LN208"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>natts</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Delimiter'>; 
</span> 
                <a href="orderedsetaggs.c.html#LN207"><span class='Ref_To_Local'>newdesc</span></a> <span class='Operator'>= </span><a href="../../access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN208"><span class='Ref_To_Local'>natts</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="orderedsetaggs.c.html#LN208"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/access/tupdesc.h.html#LN92"><span class='Ref_to_Proto'>TupleDescCopyEntry</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN207"><span class='Ref_To_Local'>newdesc</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN156"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN207"><span class='Ref_To_Local'>newdesc</span></a><span class='Delimiter'>, 
</span>                                   <span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Operator'>++</span><a href="orderedsetaggs.c.html#LN208"><span class='Ref_To_Local'>natts</span></a><span class='Delimiter'>, 
</span>                                   <span class='String'>"flag"</span><span class='Delimiter'>, 
</span>                                   <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                                   <span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/access/tupdesc.h.html#LN95"><span class='Ref_to_Proto'>FreeTupleDesc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN207"><span class='Ref_To_Local'>newdesc</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Create slot we'll use to store/retrieve rows */ 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/tuptable.h.html#LN144"><span class='Ref_to_Proto'>MakeSingleTupleTableSlot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if use_tuples &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Sort single datums */ 
</span><a name="LN231"></a>            <a href="../../../include/nodes/parsenodes.h.html#LN1161"><span class='Ref_to_Struct'>SortGroupClause</span></a> <span class='Operator'>*</span><span class='Declare_Local'>sortcl</span><span class='Delimiter'>; 
</span><a name="LN232"></a>            <a href="../../../include/nodes/primnodes.h.html#LN1363"><span class='Ref_to_Struct'>TargetEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tle</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN127"><span class='Ref_To_Local'>numSortCols</span></a> <span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN307"><span class='Ref_to_Member'>aggkind</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_aggregate.h.html#LN125"><span class='Ref_to_Const'>AGGKIND_HYPOTHETICAL</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"ordered-set aggregate support function does not support multiple aggregated columns"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN1161"><span class='Ref_to_Struct'>SortGroupClause</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN110"><span class='Ref_to_Macro'>linitial</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN126"><span class='Ref_To_Local'>sortlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN232"><span class='Ref_To_Local'>tle</span></a> <span class='Operator'>= </span><a href="../../../include/optimizer/tlist.h.html#LN37"><span class='Ref_to_Proto'>get_sortgroupclause_tle</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN124"><span class='Ref_To_Local'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN300"><span class='Ref_to_Member'>args</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* the parser should have made sure of this */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1166"><span class='Ref_to_Member'>sortop</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Save sort ordering info */ 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodeFuncs.h.html#LN31"><span class='Ref_to_Proto'>exprType</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN232"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN75"><span class='Ref_to_Member'>sortOperator</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1166"><span class='Ref_to_Member'>sortop</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN76"><span class='Ref_to_Member'>eqOperator</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1165"><span class='Ref_to_Member'>eqop</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN77"><span class='Ref_to_Member'>sortCollation</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodeFuncs.h.html#LN38"><span class='Ref_to_Proto'>exprCollation</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN232"><span class='Ref_To_Local'>tle</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN1366"><span class='Ref_to_Member'>expr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN78"><span class='Ref_to_Member'>sortNullsFirst</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN231"><span class='Ref_To_Local'>sortcl</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1167"><span class='Ref_to_Member'>nulls_first</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Save datatype info */ 
</span>            <a href="../../../include/utils/lsyscache.h.html#LN136"><span class='Ref_to_Proto'>get_typlenbyvalalign</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN71"><span class='Ref_to_Member'>typLen</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN72"><span class='Ref_to_Member'>typByVal</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN73"><span class='Ref_to_Member'>typAlign</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN63"><span class='Ref_to_Member'>fn_extra</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN107"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if qstate==NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Now build the stuff we need in group-lifespan context */ 
</span>    <a href="orderedsetaggs.c.html#LN107"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN106"><span class='Ref_To_Local'>gcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN88"><span class='Ref_to_Member'>gcontext</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN106"><span class='Ref_To_Local'>gcontext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize tuplesort object. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>use_tuples</span></a><span class='Parentheses'>) 
</span>        <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN60"><span class='Ref_to_Proto'>tuplesort_begin_heap</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>, 
</span>                                                   <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN58"><span class='Ref_to_Member'>numSortCols</span></a><span class='Delimiter'>, 
</span>                                                   <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN59"><span class='Ref_to_Member'>sortColIdx</span></a><span class='Delimiter'>, 
</span>                                                   <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN60"><span class='Ref_to_Member'>sortOperators</span></a><span class='Delimiter'>, 
</span>                                                   <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN62"><span class='Ref_to_Member'>sortCollations</span></a><span class='Delimiter'>, 
</span>                                                   <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN63"><span class='Ref_to_Member'>sortNullsFirsts</span></a><span class='Delimiter'>, 
</span>                                                   <a href="../init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tuplesort.h.html#LN78"><span class='Ref_to_Proto'>tuplesort_begin_datum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Delimiter'>, 
</span>                                                    <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN75"><span class='Ref_to_Member'>sortOperator</span></a><span class='Delimiter'>, 
</span>                                                    <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN77"><span class='Ref_to_Member'>sortCollation</span></a><span class='Delimiter'>, 
</span>                                                    <a href="orderedsetaggs.c.html#LN105"><span class='Ref_To_Local'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN78"><span class='Ref_to_Member'>sortNullsFirst</span></a><span class='Delimiter'>, 
</span>                                                    <a href="../init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now register a shutdown callback to clean things up at end of group */ 
</span>    <a href="../../../include/fmgr.h.html#LN699"><span class='Ref_to_Proto'>AggRegisterCallback</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN102"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, 
</span>                        <a href="orderedsetaggs.c.html#LN95"><span class='Ref_to_Proto'>ordered_set_shutdown</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN107"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN104"><span class='Ref_To_Local'>osastate</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ordered_set_startup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Clean up when evaluation of an ordered-set aggregate is complete. 
 * 
 * We don't need to bother freeing objects in the per-group memory context, 
 * since that will get reset anyway by nodeAgg.c; nor should we free anything 
 * in the per-query context, which will get cleared (if this was the last 
 * group) by ExecutorEnd.  But we must take care to release any potential 
 * non-memory resources. 
 * 
 * This callback is arguably unnecessary, since we don't support use of 
 * ordered-set aggs in AGG_HASHED mode and there is currently no non-error 
 * code path in non-hashed modes wherein nodeAgg.c won't call the finalfn 
 * after calling the transfn one or more times.  So in principle we could rely 
 * on the finalfn to delete the tuplestore etc.  However, it's possible that 
 * such a code path might exist in future, and in any case it'd be 
 * notationally tedious and sometimes require extra data copying to ensure 
 * we always delete the tuplestore in the finalfn. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN318"></a><span class='Declare_Function'>ordered_set_shutdown</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN320"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN318"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Tuplesort object might have temp files. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN320"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/tuplesort.h.html#LN106"><span class='Ref_to_Proto'>tuplesort_end</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN320"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN320"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The tupleslot probably can't be holding a pin, but let's be safe. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN320"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN320"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Generic transition function for ordered-set aggregates 
 * with a single input column in which we want to suppress nulls 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN337"></a><span class='Declare_Function'>ordered_set_transition</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN339"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If first call, create the transition state workspace */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="orderedsetaggs.c.html#LN339"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN101"><span class='Ref_to_Func'>ordered_set_startup</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="orderedsetaggs.c.html#LN339"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the datum into the tuplesort object, but only if it's not null */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/tuplesort.h.html#LN91"><span class='Ref_to_Proto'>tuplesort_putdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN339"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN339"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN339"><span class='Ref_To_Local'>osastate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ordered_set_transition &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Generic transition function for ordered-set aggregates 
 * with (potentially) multiple aggregated input columns 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN362"></a><span class='Declare_Function'>ordered_set_transition_multi</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN364"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN365"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span><a name="LN366"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span><span class='Delimiter'>; 
</span><a name="LN367"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If first call, create the transition state workspace */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN101"><span class='Ref_to_Func'>ordered_set_startup</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Form a tuple from all the other inputs besides the transition value */ 
</span>    <a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN366"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN366"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN47"><span class='Ref_to_Member'>aggref</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN307"><span class='Ref_to_Member'>aggkind</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_aggregate.h.html#LN125"><span class='Ref_to_Const'>AGGKIND_HYPOTHETICAL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Add a zero flag value to mark this row as a normal input row */ 
</span>        <a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN367"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN120"><span class='Ref_to_Member'>tts_tupleDescriptor</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN155"><span class='Ref_to_Proto'>ExecStoreVirtualTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the row into the tuplesort object */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN85"><span class='Ref_to_Proto'>tuplesort_puttupleslot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN365"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN364"><span class='Ref_To_Local'>osastate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ordered_set_transition_multi &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * percentile_disc(float8) within group(anyelement) - discrete percentile 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN406"></a><span class='Declare_Function'>percentile_disc_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN408"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN409"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>percentile</span><span class='Delimiter'>; 
</span><a name="LN410"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN411"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN412"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rownum</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get and check the percentile argument */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN245"><span class='Ref_to_Macro'>PG_GETARG_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="../../../interfaces/ecpg/test/expected/pgtypeslib-nan_test.c.html#LN30"><span class='Ref_to_Macro'>isnan</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"percentile value %g is not between 0 and 1"</span><span class='Delimiter'>, 
</span>                        <a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the result is NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number_of_rows could be zero if we only saw NULL input values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Finish the sort */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * We need the smallest K such that (K/N) &GT;= percentile. 
     * N&GT;0, therefore K &GT;= N*percentile, therefore K = ceil(N*percentile). 
     * So we skip K-1 rows (if K&GT;0) and return the next row fetched. 
     *---------- 
     */ 
</span>    <a href="orderedsetaggs.c.html#LN412"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span>ceil<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN409"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>* </span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN412"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>&LT;= </span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN412"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN103"><span class='Ref_to_Proto'>tuplesort_skiptuples</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN412"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_disc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN408"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN410"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN411"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_disc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we *cannot* clean up the tuplesort object here, because the value 
     * to be returned is allocated inside its sortcontext.  We could use 
     * datumCopy to copy it out of there, but it doesn't seem worth the 
     * trouble, since the cleanup callback will clear the tuplesort later. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* We shouldn't have stored any nulls, but do the right thing anyway */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN411"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/fmgr.h.html#LN312"><span class='Ref_to_Macro'>PG_RETURN_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN410"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end percentile_disc_final &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * For percentile_cont, we need a way to interpolate between consecutive 
 * values. Use a helper function for that, so that we can share the rest 
 * of the code between types. 
 */ 
</span><a name="LN479"></a><span class='Control'>typedef</span> <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Typedef'>LerpFunc</span><span class='Parentheses'>) (</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <a href="../../replication/repl_scanner.l.html#LN122"><span class='Ref_to_Global_Var'>lo</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <a href="../../replication/repl_scanner.l.html#LN121"><span class='Ref_to_Global_Var'>hi</span></a><span class='Delimiter'>, </span><span class='Keyword'>double </span>pct<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN482"></a><span class='Declare_Function'>float8_lerp</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>lo</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>hi</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Declare_Parameter'>pct</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN484"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>loval</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN720"><span class='Ref_to_Func'>DatumGetFloat8</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN482"><span class='Ref_to_Parameter'>lo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN485"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>hival</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN720"><span class='Ref_to_Func'>DatumGetFloat8</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN482"><span class='Ref_to_Parameter'>hi</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN745"><span class='Ref_to_Func'>Float8GetDatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN484"><span class='Ref_To_Local'>loval</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN482"><span class='Ref_to_Parameter'>pct</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN485"><span class='Ref_To_Local'>hival</span></a> <span class='Operator'>- </span><a href="orderedsetaggs.c.html#LN484"><span class='Ref_To_Local'>loval</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN491"></a><span class='Declare_Function'>interval_lerp</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>lo</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>hi</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Declare_Parameter'>pct</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN493"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>diff_result</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN585"><span class='Ref_to_Macro'>DirectFunctionCall2</span></a><span class='Parentheses'>(</span><a href="timestamp.c.html#LN3072"><span class='Ref_to_Func'>interval_mi</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN491"><span class='Ref_to_Parameter'>hi</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN491"><span class='Ref_to_Parameter'>lo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN494"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>mul_result</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN585"><span class='Ref_to_Macro'>DirectFunctionCall2</span></a><span class='Parentheses'>(</span><a href="timestamp.c.html#LN3112"><span class='Ref_to_Func'>interval_mul</span></a><span class='Delimiter'>, 
</span>                                                 <a href="orderedsetaggs.c.html#LN493"><span class='Ref_To_Local'>diff_result</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/postgres.h.html#LN778"><span class='Ref_to_Macro'>Float8GetDatumFast</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN491"><span class='Ref_to_Parameter'>pct</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/fmgr.h.html#LN585"><span class='Ref_to_Macro'>DirectFunctionCall2</span></a><span class='Parentheses'>(</span><a href="timestamp.c.html#LN3038"><span class='Ref_to_Func'>interval_pl</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN494"><span class='Ref_To_Local'>mul_result</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN491"><span class='Ref_to_Parameter'>lo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Continuous percentile 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN505"></a><span class='Declare_Function'>percentile_cont_final_common</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN506"></a>                             <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>expect_type</span><span class='Delimiter'>, 
</span><a name="LN507"></a>                             <a href="orderedsetaggs.c.html#LN479"><span class='Ref_to_Typedef'>LerpFunc</span></a> <span class='Declare_Parameter'>lerpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN509"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN510"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>percentile</span><span class='Delimiter'>; 
</span><a name="LN511"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>first_row</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN512"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>second_row</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN513"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN514"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>first_val</span><span class='Delimiter'>; 
</span><a name="LN515"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>second_val</span><span class='Delimiter'>; 
</span><a name="LN516"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>proportion</span><span class='Delimiter'>; 
</span><a name="LN517"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN505"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get and check the percentile argument */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN245"><span class='Ref_to_Macro'>PG_GETARG_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="../../../interfaces/ecpg/test/expected/pgtypeslib-nan_test.c.html#LN30"><span class='Ref_to_Macro'>isnan</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"percentile value %g is not between 0 and 1"</span><span class='Delimiter'>, 
</span>                        <a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the result is NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number_of_rows could be zero if we only saw NULL input values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN506"><span class='Ref_to_Parameter'>expect_type</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Finish the sort */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN511"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>= </span>floor<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN512"><span class='Ref_To_Local'>second_row</span></a> <span class='Operator'>= </span>ceil<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN511"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN103"><span class='Ref_to_Proto'>tuplesort_skiptuples</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN511"><span class='Ref_To_Local'>first_row</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN514"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN517"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN517"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN511"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN512"><span class='Ref_To_Local'>second_row</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="orderedsetaggs.c.html#LN513"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN514"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN515"><span class='Ref_To_Local'>second_val</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN517"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN517"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN516"><span class='Ref_To_Local'>proportion</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN510"><span class='Ref_To_Local'>percentile</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN509"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>- </span><a href="orderedsetaggs.c.html#LN511"><span class='Ref_To_Local'>first_row</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN513"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN507"><span class='Ref_to_Parameter'>lerpfunc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN514"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN515"><span class='Ref_To_Local'>second_val</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN516"><span class='Ref_To_Local'>proportion</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we *cannot* clean up the tuplesort object here, because the value 
     * to be returned may be allocated inside its sortcontext.  We could use 
     * datumCopy to copy it out of there, but it doesn't seem worth the 
     * trouble, since the cleanup callback will clear the tuplesort later. 
     */ 
</span> 
    <a href="../../../include/fmgr.h.html#LN312"><span class='Ref_to_Macro'>PG_RETURN_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN513"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end percentile_cont_final_common &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * percentile_cont(float8) within group (float8)    - continuous percentile 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN591"></a><span class='Declare_Function'>percentile_cont_float8_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN504"><span class='Ref_to_Func'>percentile_cont_final_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN39"><span class='Ref_to_Const'>FLOAT8OID</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN481"><span class='Ref_to_Func'>float8_lerp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * percentile_cont(float8) within group (interval)  - continuous percentile 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN600"></a><span class='Declare_Function'>percentile_cont_interval_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN504"><span class='Ref_to_Func'>percentile_cont_final_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN54"><span class='Ref_to_Const'>INTERVALOID</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN490"><span class='Ref_to_Func'>interval_lerp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Support code for handling arrays of percentiles 
 * 
 * Note: in each pct_info entry, second_row should be equal to or 
 * exactly one more than first_row. 
 */ 
</span><a name="LN612"></a><span class='Control'>struct</span> <span class='Declare_Struct'>pct_info</span> 
<span class='Delimiter'>{ 
</span><a name="LN614"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Member'>first_row</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* first row to sample */ 
</span><a name="LN615"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Member'>second_row</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* possible second row to sample */ 
</span><a name="LN616"></a>    <span class='Keyword'>double</span>      <span class='Declare_Member'>proportion</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* interpolation fraction */ 
</span><a name="LN617"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>idx</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* index of this item in original array */ 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Sort comparator to sort pct_infos by first_row then second_row 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN624"></a><span class='Declare_Function'>pct_info_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pa</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pb</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN626"></a>    <span class='Keyword'>const </span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN612"><span class='Ref_to_Struct'>pct_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>a</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN612"><span class='Ref_to_Struct'>pct_info</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN624"><span class='Ref_to_Parameter'>pa</span></a><span class='Delimiter'>; 
</span><a name="LN627"></a>    <span class='Keyword'>const </span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN612"><span class='Ref_to_Struct'>pct_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>b</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>const </span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN612"><span class='Ref_to_Struct'>pct_info</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="orderedsetaggs.c.html#LN624"><span class='Ref_to_Parameter'>pb</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN626"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>!= </span><a href="orderedsetaggs.c.html#LN627"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN626"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN627"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a><span class='Parentheses'>) </span><span class='Operator'>? -</span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN626"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a> <span class='Operator'>!= </span><a href="orderedsetaggs.c.html#LN627"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN626"><span class='Ref_To_Local'>a</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN627"><span class='Ref_To_Local'>b</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a><span class='Parentheses'>) </span><span class='Operator'>? -</span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Construct array showing which rows to sample for percentiles. 
 */ 
</span><span class='Keyword'>static </span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN612"><span class='Ref_to_Struct'>pct_info</span></a> <span class='Operator'>* 
</span><a name="LN640"></a><span class='Declare_Function'>setup_pct_info</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>num_percentiles</span><span class='Delimiter'>, 
</span><a name="LN641"></a>               <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>percentiles_datum</span><span class='Delimiter'>, 
</span><a name="LN642"></a>               <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>percentiles_null</span><span class='Delimiter'>, 
</span><a name="LN643"></a>               <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Declare_Parameter'>rowcount</span><span class='Delimiter'>, 
</span><a name="LN644"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>continuous</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN646"></a>    <span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pct_info</span><span class='Delimiter'>; 
</span><a name="LN647"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN640"><span class='Ref_to_Parameter'>num_percentiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN640"><span class='Ref_to_Parameter'>num_percentiles</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN617"><span class='Ref_to_Member'>idx</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN642"><span class='Ref_to_Parameter'>percentiles_null</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* dummy entry for any NULL in array */ 
</span>            <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN616"><span class='Ref_to_Member'>proportion</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN664"></a>            <span class='Keyword'>double</span>      <span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN720"><span class='Ref_to_Func'>DatumGetFloat8</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN641"><span class='Ref_to_Parameter'>percentiles_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="../../../interfaces/ecpg/test/expected/pgtypeslib-nan_test.c.html#LN30"><span class='Ref_to_Macro'>isnan</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_NUMERIC_VALUE_OUT_OF_RANGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"percentile value %g is not between 0 and 1"</span><span class='Delimiter'>, 
</span>                                <a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN644"><span class='Ref_to_Parameter'>continuous</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>+ </span>floor<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN643"><span class='Ref_to_Parameter'>rowcount</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a> <span class='Operator'>= </span><span class='Number'>1</span> <span class='Operator'>+ </span>ceil<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN643"><span class='Ref_to_Parameter'>rowcount</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN616"><span class='Ref_to_Member'>proportion</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN643"><span class='Ref_to_Parameter'>rowcount</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>- </span>floor<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN643"><span class='Ref_to_Parameter'>rowcount</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/*---------- 
                 * We need the smallest K such that (K/N) &GT;= percentile. 
                 * N&GT;0, therefore K &GT;= N*percentile, therefore 
                 * K = ceil(N*percentile); but not less than 1. 
                 *---------- 
                 */ 
</span><a name="LN686"></a>                <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>row</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a><span class='Parentheses'>) </span>ceil<span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN664"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>* </span><a href="orderedsetaggs.c.html#LN643"><span class='Ref_to_Parameter'>rowcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="orderedsetaggs.c.html#LN686"><span class='Ref_To_Local'>row</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN10"><span class='Ref_to_Macro'>Max</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN686"><span class='Ref_To_Local'>row</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN686"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN686"><span class='Ref_To_Local'>row</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN647"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN616"><span class='Ref_to_Member'>proportion</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;num_percentiles... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * The parameter array wasn't necessarily in sorted order, but we need to 
     * visit the rows in order, so sort by first_row/second_row. 
     */ 
</span>    <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN640"><span class='Ref_to_Parameter'>num_percentiles</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN623"><span class='Ref_to_Func'>pct_info_cmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN646"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end setup_pct_info &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * percentile_disc(float8[]) within group (anyelement)  - discrete percentiles 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN709"></a><span class='Declare_Function'>percentile_disc_multi_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN711"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN712"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span><a name="LN713"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>percentiles_datum</span><span class='Delimiter'>; 
</span><a name="LN714"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>percentiles_null</span><span class='Delimiter'>; 
</span><a name="LN715"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_percentiles</span><span class='Delimiter'>; 
</span><a name="LN716"></a>    <span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pct_info</span><span class='Delimiter'>; 
</span><a name="LN717"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>result_datum</span><span class='Delimiter'>; 
</span><a name="LN718"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>result_isnull</span><span class='Delimiter'>; 
</span><a name="LN719"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rownum</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN720"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN721"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN722"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the result is NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number_of_rows could be zero if we only saw NULL input values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Deconstruct the percentile-array input */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN712"><span class='Ref_To_Local'>param</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN712"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN39"><span class='Ref_to_Const'>FLOAT8OID</span></a><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* hard-wired info on type float8 */ 
</span>                      <span class='Number'>8</span><span class='Delimiter'>, </span>FLOAT8PASSBYVAL<span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN713"><span class='Ref_To_Local'>percentiles_datum</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN714"><span class='Ref_To_Local'>percentiles_null</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN378"><span class='Ref_to_Proto'>construct_empty_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN639"><span class='Ref_to_Func'>setup_pct_info</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN713"><span class='Ref_To_Local'>percentiles_datum</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN714"><span class='Ref_To_Local'>percentiles_null</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN717"><span class='Ref_To_Local'>result_datum</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN718"><span class='Ref_To_Local'>result_isnull</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start by dealing with any nulls in the param array - those are sorted 
     * to the front on row=0, so set the corresponding result indexes to null 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN766"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN617"><span class='Ref_to_Member'>idx</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN717"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN766"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN718"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN766"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's anything left after doing the nulls, then grind the input 
     * and extract the needed values 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Finish the sort */ 
</span>        <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN715"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN786"></a>            <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>target_row</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a><span class='Delimiter'>; 
</span><a name="LN787"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN716"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN722"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN617"><span class='Ref_to_Member'>idx</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Advance to target row, if not already there */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN786"><span class='Ref_To_Local'>target_row</span></a> <span class='Operator'>&GT; </span><a href="orderedsetaggs.c.html#LN719"><span class='Ref_To_Local'>rownum</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN103"><span class='Ref_to_Proto'>tuplesort_skiptuples</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN786"><span class='Ref_To_Local'>target_row</span></a> <span class='Operator'>- </span><a href="orderedsetaggs.c.html#LN719"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_disc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN720"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN721"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_disc"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="orderedsetaggs.c.html#LN719"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN786"><span class='Ref_To_Local'>target_row</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="orderedsetaggs.c.html#LN717"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN787"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN720"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN718"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN787"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN721"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;i&LT;num_percentiles;i+... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if i&LT;num_percentiles &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We could clean up the tuplesort object after forming the array, but 
     * probably not worth the trouble. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* We make the output array the same shape as the input */ 
</span>    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN372"><span class='Ref_to_Proto'>construct_md_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN717"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN718"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN712"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN712"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/array.h.html#LN276"><span class='Ref_to_Macro'>ARR_LBOUND</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN712"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN71"><span class='Ref_to_Member'>typLen</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN72"><span class='Ref_to_Member'>typByVal</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN711"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN73"><span class='Ref_to_Member'>typAlign</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end percentile_disc_multi_final &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * percentile_cont(float8[]) within group ()    - continuous percentiles 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN826"></a><span class='Declare_Function'>percentile_cont_multi_final_common</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, 
</span><a name="LN827"></a>                                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>expect_type</span><span class='Delimiter'>, 
</span><a name="LN828"></a>                                   <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Declare_Parameter'>typLen</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>typByVal</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Declare_Parameter'>typAlign</span><span class='Delimiter'>, 
</span><a name="LN829"></a>                                   <a href="orderedsetaggs.c.html#LN479"><span class='Ref_to_Typedef'>LerpFunc</span></a> <span class='Declare_Parameter'>lerpfunc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN831"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN832"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span><a name="LN833"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>percentiles_datum</span><span class='Delimiter'>; 
</span><a name="LN834"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>percentiles_null</span><span class='Delimiter'>; 
</span><a name="LN835"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>num_percentiles</span><span class='Delimiter'>; 
</span><a name="LN836"></a>    <span class='Control'>struct</span> <a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pct_info</span><span class='Delimiter'>; 
</span><a name="LN837"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>result_datum</span><span class='Delimiter'>; 
</span><a name="LN838"></a>    <span class='Keyword'>bool</span>       <span class='Operator'>*</span><span class='Declare_Local'>result_isnull</span><span class='Delimiter'>; 
</span><a name="LN839"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rownum</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN840"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>first_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN841"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>second_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN842"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN843"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN826"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the result is NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number_of_rows could be zero if we only saw NULL input values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN827"><span class='Ref_to_Parameter'>expect_type</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Deconstruct the percentile-array input */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN832"><span class='Ref_To_Local'>param</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN243"><span class='Ref_to_Macro'>PG_GETARG_ARRAYTYPE_P</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/array.h.html#LN382"><span class='Ref_to_Proto'>deconstruct_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN832"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN39"><span class='Ref_to_Const'>FLOAT8OID</span></a><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* hard-wired info on type float8 */ 
</span>                      <span class='Number'>8</span><span class='Delimiter'>, </span>FLOAT8PASSBYVAL<span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN833"><span class='Ref_To_Local'>percentiles_datum</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN834"><span class='Ref_To_Local'>percentiles_null</span></a><span class='Delimiter'>, 
</span>                      <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN378"><span class='Ref_to_Proto'>construct_empty_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN70"><span class='Ref_to_Member'>sortColType</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN639"><span class='Ref_to_Func'>setup_pct_info</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN833"><span class='Ref_To_Local'>percentiles_datum</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN834"><span class='Ref_To_Local'>percentiles_null</span></a><span class='Delimiter'>, 
</span>                              <a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN837"><span class='Ref_To_Local'>result_datum</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN838"><span class='Ref_To_Local'>result_isnull</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start by dealing with any nulls in the param array - those are sorted 
     * to the front on row=0, so set the corresponding result indexes to null 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN889"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN617"><span class='Ref_to_Member'>idx</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN837"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN889"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN838"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN889"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's anything left after doing the nulls, then grind the input 
     * and extract the needed values 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Finish the sort */ 
</span>        <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN835"><span class='Ref_To_Local'>num_percentiles</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN909"></a>            <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>first_row</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN614"><span class='Ref_to_Member'>first_row</span></a><span class='Delimiter'>; 
</span><a name="LN910"></a>            <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>second_row</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN615"><span class='Ref_to_Member'>second_row</span></a><span class='Delimiter'>; 
</span><a name="LN911"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN617"><span class='Ref_to_Member'>idx</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Advance to first_row, if not already there.  Note that we might 
             * already have rownum beyond first_row, in which case first_val 
             * is already correct.  (This occurs when interpolating between 
             * the same two input rows as for the previous percentile.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN909"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>&GT; </span><a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN103"><span class='Ref_to_Proto'>tuplesort_skiptuples</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN909"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>- </span><a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN840"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN842"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN842"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN909"><span class='Ref_To_Local'>first_row</span></a><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* Always advance second_val to be latest input value */ 
</span>                <a href="orderedsetaggs.c.html#LN841"><span class='Ref_To_Local'>second_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN840"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN909"><span class='Ref_To_Local'>first_row</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * We are already at the desired row, so we must previously 
                 * have read its value into second_val (and perhaps first_val 
                 * as well, but this assignment is harmless in that case). 
                 */ 
</span>                <a href="orderedsetaggs.c.html#LN840"><span class='Ref_To_Local'>first_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN841"><span class='Ref_To_Local'>second_val</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Fetch second_row if needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN910"><span class='Ref_To_Local'>second_row</span></a> <span class='Operator'>&GT; </span><a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN831"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN841"><span class='Ref_To_Local'>second_val</span></a><span class='Delimiter'>, 
</span>                                        <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN842"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="orderedsetaggs.c.html#LN842"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"missing row in percentile_cont"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* We should now certainly be on second_row exactly */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN910"><span class='Ref_To_Local'>second_row</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN839"><span class='Ref_To_Local'>rownum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Compute appropriate result */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN910"><span class='Ref_To_Local'>second_row</span></a> <span class='Operator'>&GT; </span><a href="orderedsetaggs.c.html#LN909"><span class='Ref_To_Local'>first_row</span></a><span class='Parentheses'>) 
</span>                <a href="orderedsetaggs.c.html#LN837"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN911"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN829"><span class='Ref_to_Parameter'>lerpfunc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN840"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN841"><span class='Ref_To_Local'>second_val</span></a><span class='Delimiter'>, 
</span>                                             <a href="orderedsetaggs.c.html#LN836"><span class='Ref_To_Local'>pct_info</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN843"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="orderedsetaggs.c.html#LN616"><span class='Ref_to_Member'>proportion</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="orderedsetaggs.c.html#LN837"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN911"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN840"><span class='Ref_To_Local'>first_val</span></a><span class='Delimiter'>; 
</span> 
            <a href="orderedsetaggs.c.html#LN838"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN911"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;i&LT;num_percentiles;i+... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if i&LT;num_percentiles &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We could clean up the tuplesort object after forming the array, but 
     * probably not worth the trouble. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* We make the output array the same shape as the input */ 
</span>    <a href="../../../include/fmgr.h.html#LN320"><span class='Ref_to_Macro'>PG_RETURN_POINTER</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN372"><span class='Ref_to_Proto'>construct_md_array</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN837"><span class='Ref_To_Local'>result_datum</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN838"><span class='Ref_To_Local'>result_isnull</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN832"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN832"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN276"><span class='Ref_to_Macro'>ARR_LBOUND</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN832"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN827"><span class='Ref_to_Parameter'>expect_type</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN828"><span class='Ref_to_Parameter'>typLen</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN828"><span class='Ref_to_Parameter'>typByVal</span></a><span class='Delimiter'>, 
</span>                                         <a href="orderedsetaggs.c.html#LN828"><span class='Ref_to_Parameter'>typAlign</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end percentile_cont_multi_final_common &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * percentile_cont(float8[]) within group (float8)  - continuous percentiles 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN983"></a><span class='Declare_Function'>percentile_cont_float8_multi_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN825"><span class='Ref_to_Func'>percentile_cont_multi_final_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, 
</span>                                              <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN39"><span class='Ref_to_Const'>FLOAT8OID</span></a><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* hard-wired info on type float8 */ 
</span>                                              <span class='Number'>8</span><span class='Delimiter'>, </span>FLOAT8PASSBYVAL<span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>, 
</span>                                              <a href="orderedsetaggs.c.html#LN481"><span class='Ref_to_Func'>float8_lerp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * percentile_cont(float8[]) within group (interval)  - continuous percentiles 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN996"></a><span class='Declare_Function'>percentile_cont_interval_multi_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN825"><span class='Ref_to_Func'>percentile_cont_multi_final_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, 
</span>                                              <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN54"><span class='Ref_to_Const'>INTERVALOID</span></a><span class='Delimiter'>, 
</span>    <span class='Comment_Multi_Line'>/* hard-wired info on type interval */ 
</span>                                              <span class='Number'>16</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>, 
</span>                                              <a href="orderedsetaggs.c.html#LN490"><span class='Ref_to_Func'>interval_lerp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * mode() within group (anyelement) - most common value 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1010"></a><span class='Declare_Function'>mode_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1012"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN1013"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span><a name="LN1014"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1015"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>mode_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1016"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>mode_freq</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1017"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>last_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1018"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>last_val_freq</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1019"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>last_val_is_mode</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1020"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>equalfn</span><span class='Delimiter'>; 
</span><a name="LN1021"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>abbrev_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1022"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>last_abbrev_val</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1023"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>shouldfree</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the result is NULL */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* number_of_rows could be zero if we only saw NULL input values */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up the equality function for the datatype, if we didn't already */ 
</span>    <a href="orderedsetaggs.c.html#LN1020"><span class='Ref_To_Local'>equalfn</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN80"><span class='Ref_to_Member'>equalfn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1020"><span class='Ref_To_Local'>equalfn</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN98"><span class='Ref_to_Proto'>get_opcode</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN76"><span class='Ref_to_Member'>eqOperator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1020"><span class='Ref_To_Local'>equalfn</span></a><span class='Delimiter'>, 
</span>                      <a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN49"><span class='Ref_to_Member'>qcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1023"><span class='Ref_To_Local'>shouldfree</span></a> <span class='Operator'>= !</span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN72"><span class='Ref_to_Member'>typByVal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Finish the sort */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Scan tuples and count frequencies */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/tuplesort.h.html#LN100"><span class='Ref_to_Proto'>tuplesort_getdatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1012"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1013"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1014"><span class='Ref_To_Local'>isnull</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1021"><span class='Ref_To_Local'>abbrev_val</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* we don't expect any nulls, but ignore them if found */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1014"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1018"><span class='Ref_To_Local'>last_val_freq</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* first nonnull value - it's the mode for now */ 
</span>            <a href="orderedsetaggs.c.html#LN1015"><span class='Ref_To_Local'>mode_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1013"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1016"><span class='Ref_To_Local'>mode_freq</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1018"><span class='Ref_To_Local'>last_val_freq</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1022"><span class='Ref_To_Local'>last_abbrev_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1021"><span class='Ref_To_Local'>abbrev_val</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1021"><span class='Ref_To_Local'>abbrev_val</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN1022"><span class='Ref_To_Local'>last_abbrev_val</span></a> <span class='Operator'>&& 
</span>                 <a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN603"><span class='Ref_to_Macro'>FunctionCall2</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1020"><span class='Ref_To_Local'>equalfn</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1013"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a><span class='Parentheses'>)))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* value equal to previous value, count it */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a><span class='Parentheses'>) 
</span>                <a href="orderedsetaggs.c.html#LN1016"><span class='Ref_To_Local'>mode_freq</span></a><span class='Operator'>++</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* needn't maintain last_val_freq */ 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="orderedsetaggs.c.html#LN1018"><span class='Ref_To_Local'>last_val_freq</span></a> <span class='Operator'>&GT; </span><a href="orderedsetaggs.c.html#LN1016"><span class='Ref_To_Local'>mode_freq</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* last_val becomes new mode */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1023"><span class='Ref_To_Local'>shouldfree</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1015"><span class='Ref_To_Local'>mode_val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN1015"><span class='Ref_To_Local'>mode_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN1016"><span class='Ref_To_Local'>mode_freq</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1018"><span class='Ref_To_Local'>last_val_freq</span></a><span class='Delimiter'>; 
</span>                <a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1023"><span class='Ref_To_Local'>shouldfree</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1013"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* val should replace last_val */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1023"><span class='Ref_To_Local'>shouldfree</span></a> <span class='Operator'>&& !</span><a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1013"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* avoid equality function calls by reusing abbreviated keys */ 
</span>            <a href="orderedsetaggs.c.html#LN1022"><span class='Ref_To_Local'>last_abbrev_val</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1021"><span class='Ref_To_Local'>abbrev_val</span></a><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1018"><span class='Ref_To_Local'>last_val_freq</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while tuplesort_getdatum(os... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1023"><span class='Ref_To_Local'>shouldfree</span></a> <span class='Operator'>&& !</span><a href="orderedsetaggs.c.html#LN1019"><span class='Ref_To_Local'>last_val_is_mode</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1017"><span class='Ref_To_Local'>last_val</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we *cannot* clean up the tuplesort object here, because the value 
     * to be returned is allocated inside its sortcontext.  We could use 
     * datumCopy to copy it out of there, but it doesn't seem worth the 
     * trouble, since the cleanup callback will clear the tuplesort later. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1016"><span class='Ref_To_Local'>mode_freq</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN312"><span class='Ref_to_Macro'>PG_RETURN_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1015"><span class='Ref_To_Local'>mode_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/fmgr.h.html#LN304"><span class='Ref_to_Macro'>PG_RETURN_NULL</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end mode_final &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Common code to sanity-check args for hypothetical-set functions. No need 
 * for friendly errors, these can only happen if someone's messing up the 
 * aggregate definitions. The checks are needed for security, however. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1119"></a><span class='Declare_Function'>hypothetical_check_argtypes</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nargs</span><span class='Delimiter'>, 
</span><a name="LN1120"></a>                            <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1122"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that we have an int4 flag column */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="orderedsetaggs.c.html#LN1120"><span class='Ref_to_Parameter'>tupdesc</span></a> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1119"><span class='Ref_to_Parameter'>nargs</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="orderedsetaggs.c.html#LN1120"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN72"><span class='Ref_to_Member'>natts</span></a> <span class='Operator'>|| 
</span>        <a href="orderedsetaggs.c.html#LN1120"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1119"><span class='Ref_to_Parameter'>nargs</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid <span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN24"><span class='Ref_to_Const'>INT4OID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"type mismatch in hypothetical-set function"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check that direct args match in type with aggregated args */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1122"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1122"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN1119"><span class='Ref_to_Parameter'>nargs</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1122"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN663"><span class='Ref_to_Proto'>get_fn_expr_argtype</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1119"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN78"><span class='Ref_to_Member'>flinfo</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1122"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="orderedsetaggs.c.html#LN1120"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/tupdesc.h.html#LN73"><span class='Ref_to_Member'>attrs</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1122"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>-&GT;</span>atttypid<span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"type mismatch in hypothetical-set function"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * compute rank of hypothetical row 
 * 
 * flag should be -1 to sort hypothetical row ahead of its peers, or +1 
 * to sort behind. 
 * total number of regular rows is returned into *number_of_rows. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> 
<a name="LN1146"></a><span class='Declare_Function'>hypothetical_rank_common</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flag</span><span class='Delimiter'>, 
</span><a name="LN1147"></a>                         <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>number_of_rows</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1149"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1150"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rank</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1151"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN1152"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span><a name="LN1153"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1146"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the rank is always 1 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="orderedsetaggs.c.html#LN1147"><span class='Ref_to_Parameter'>number_of_rows</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="orderedsetaggs.c.html#LN1147"><span class='Ref_to_Parameter'>number_of_rows</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN92"><span class='Ref_to_Member'>number_of_rows</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Adjust nargs to be the number of direct (or aggregated) args */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1149"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>% </span><span class='Number'>2</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments in hypothetical-set function"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1149"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>/= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1118"><span class='Ref_to_Func'>hypothetical_check_argtypes</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1146"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1149"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* insert the hypothetical row into the sort */ 
</span>    <a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN1149"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1146"><span class='Ref_to_Parameter'>flag</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1153"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN155"><span class='Ref_to_Proto'>ExecStoreVirtualTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/tuplesort.h.html#LN85"><span class='Ref_to_Proto'>tuplesort_puttupleslot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* finish the sort */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* iterate till we find the hypothetical row */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/tuplesort.h.html#LN96"><span class='Ref_to_Proto'>tuplesort_gettupleslot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1194"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1195"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>d</span> <span class='Operator'>= </span><a href="../../../include/executor/tuptable.h.html#LN167"><span class='Ref_to_Proto'>slot_getattr</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1149"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1194"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="orderedsetaggs.c.html#LN1194"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>&& </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1195"><span class='Ref_To_Local'>d</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN1150"><span class='Ref_To_Local'>rank</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1152"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Might as well clean up the tuplesort object immediately */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN106"><span class='Ref_to_Proto'>tuplesort_end</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1151"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="orderedsetaggs.c.html#LN1150"><span class='Ref_To_Local'>rank</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hypothetical_rank_common &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * rank()  - rank of hypothetical row 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1219"></a><span class='Declare_Function'>hypothetical_rank_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1221"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rank</span><span class='Delimiter'>; 
</span><a name="LN1222"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rowcount</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1221"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1145"><span class='Ref_to_Func'>hypothetical_rank_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1222"><span class='Ref_To_Local'>rowcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN326"><span class='Ref_to_Macro'>PG_RETURN_INT64</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1221"><span class='Ref_To_Local'>rank</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * percent_rank()   - percentile rank of hypothetical row 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1233"></a><span class='Declare_Function'>hypothetical_percent_rank_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1235"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rank</span><span class='Delimiter'>; 
</span><a name="LN1236"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rowcount</span><span class='Delimiter'>; 
</span><a name="LN1237"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>result_val</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1235"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1145"><span class='Ref_to_Func'>hypothetical_rank_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1236"><span class='Ref_To_Local'>rowcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1236"><span class='Ref_To_Local'>rowcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1237"><span class='Ref_To_Local'>result_val</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="orderedsetaggs.c.html#LN1235"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="orderedsetaggs.c.html#LN1236"><span class='Ref_To_Local'>rowcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1237"><span class='Ref_To_Local'>result_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * cume_dist()  - cumulative distribution of hypothetical row 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1253"></a><span class='Declare_Function'>hypothetical_cume_dist_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1255"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rank</span><span class='Delimiter'>; 
</span><a name="LN1256"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rowcount</span><span class='Delimiter'>; 
</span><a name="LN1257"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>result_val</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1255"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1145"><span class='Ref_to_Func'>hypothetical_rank_common</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1256"><span class='Ref_To_Local'>rowcount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1257"><span class='Ref_To_Local'>result_val</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="orderedsetaggs.c.html#LN1255"><span class='Ref_To_Local'>rank</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) (</span><a href="orderedsetaggs.c.html#LN1256"><span class='Ref_To_Local'>rowcount</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN325"><span class='Ref_to_Macro'>PG_RETURN_FLOAT8</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1257"><span class='Ref_To_Local'>result_val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * dense_rank() - rank of hypothetical row without gaps in ranking 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1270"></a><span class='Declare_Function'>hypothetical_dense_rank_final</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1272"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nargs</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN167"><span class='Ref_to_Macro'>PG_NARGS</span></a><span class='Parentheses'>() </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1273"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>rank</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1274"></a>    <a href="../../../include/c.h.html#LN294"><span class='Ref_to_Typedef'>int64</span></a>       <span class='Declare_Local'>duplicate_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1275"></a>    <a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Declare_Local'>osastate</span><span class='Delimiter'>; 
</span><a name="LN1276"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numDistinctCols</span><span class='Delimiter'>; 
</span><a name="LN1277"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>abbrevVal</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1278"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>abbrevOld</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1279"></a>    <a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a> <span class='Operator'>*</span><span class='Declare_Local'>sortColIdx</span><span class='Delimiter'>; 
</span><a name="LN1280"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>equalfns</span><span class='Delimiter'>; 
</span><a name="LN1281"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot</span><span class='Delimiter'>; 
</span><a name="LN1282"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>extraslot</span><span class='Delimiter'>; 
</span><a name="LN1283"></a>    <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>slot2</span><span class='Delimiter'>; 
</span><a name="LN1284"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>tmpcontext</span><span class='Delimiter'>; 
</span><a name="LN1285"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN695"><span class='Ref_to_Proto'>AggCheckCallContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="../../../include/fmgr.h.html#LN692"><span class='Ref_to_Const'>AGG_CONTEXT_AGGREGATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there were no regular rows, the rank is always 1 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>))</span> 
        <a href="../../../include/fmgr.h.html#LN326"><span class='Ref_to_Macro'>PG_RETURN_INT64</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1273"><span class='Ref_To_Local'>rank</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN83"><span class='Ref_to_Struct'>OSAPerGroupState</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/fmgr.h.html#LN240"><span class='Ref_to_Macro'>PG_GETARG_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Adjust nargs to be the number of direct (or aggregated) args */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1272"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>% </span><span class='Number'>2</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong number of arguments in hypothetical-set function"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1272"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>/= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1118"><span class='Ref_to_Func'>hypothetical_check_argtypes</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1272"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When comparing tuples, we can omit the flag column since we will only 
     * compare rows with flag == 0. 
     */ 
</span>    <a href="orderedsetaggs.c.html#LN1276"><span class='Ref_To_Local'>numDistinctCols</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN58"><span class='Ref_to_Member'>numSortCols</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Look up the equality function(s), if we didn't already */ 
</span>    <a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN65"><span class='Ref_to_Member'>equalfns</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1312"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>qcontext</span> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN49"><span class='Ref_to_Member'>qcontext</span></a><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1312"><span class='Ref_To_Local'>qcontext</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1276"><span class='Ref_To_Local'>numDistinctCols</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN1276"><span class='Ref_To_Local'>numDistinctCols</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN98"><span class='Ref_to_Proto'>get_opcode</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN61"><span class='Ref_to_Member'>eqOperators</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                          <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                          <a href="orderedsetaggs.c.html#LN1312"><span class='Ref_To_Local'>qcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN65"><span class='Ref_to_Member'>equalfns</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="orderedsetaggs.c.html#LN1279"><span class='Ref_To_Local'>sortColIdx</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN59"><span class='Ref_to_Member'>sortColIdx</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get short-term context we can use for execTuplesMatch */ 
</span>    <a href="orderedsetaggs.c.html#LN1284"><span class='Ref_To_Local'>tmpcontext</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN698"><span class='Ref_to_Proto'>AggGetTempMemoryContext</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* insert the hypothetical row into the sort */ 
</span>    <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN56"><span class='Ref_to_Member'>tupslot</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="orderedsetaggs.c.html#LN1272"><span class='Ref_To_Local'>nargs</span></a><span class='Delimiter'>; </span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN232"><span class='Ref_to_Macro'>PG_GETARG_DATUM</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN173"><span class='Ref_to_Macro'>PG_ARGISNULL</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN124"><span class='Ref_to_Member'>tts_values</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/tuptable.h.html#LN125"><span class='Ref_to_Member'>tts_isnull</span></a><span class='Delimiter'>[</span><a href="orderedsetaggs.c.html#LN1285"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN155"><span class='Ref_to_Proto'>ExecStoreVirtualTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/tuplesort.h.html#LN85"><span class='Ref_to_Proto'>tuplesort_puttupleslot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* finish the sort */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN94"><span class='Ref_to_Proto'>tuplesort_performsort</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We alternate fetching into tupslot and extraslot so that we have the 
     * previous row available for comparisons.  This is accomplished by 
     * swapping the slot pointer variables after each row. 
     */ 
</span>    <a href="orderedsetaggs.c.html#LN1282"><span class='Ref_To_Local'>extraslot</span></a> <span class='Operator'>= </span><a href="../../../include/executor/tuptable.h.html#LN144"><span class='Ref_to_Proto'>MakeSingleTupleTableSlot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN86"><span class='Ref_to_Member'>qstate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN54"><span class='Ref_to_Member'>tupdesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1282"><span class='Ref_To_Local'>extraslot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* iterate till we find the hypothetical row */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/tuplesort.h.html#LN96"><span class='Ref_to_Proto'>tuplesort_gettupleslot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1277"><span class='Ref_To_Local'>abbrevVal</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1358"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span><a name="LN1359"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>d</span> <span class='Operator'>= </span><a href="../../../include/executor/tuptable.h.html#LN167"><span class='Ref_to_Proto'>slot_getattr</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1272"><span class='Ref_To_Local'>nargs</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="orderedsetaggs.c.html#LN1358"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1360"></a>        <a href="../../../include/executor/tuptable.h.html#LN112"><span class='Ref_to_Struct'>TupleTableSlot</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmpslot</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="orderedsetaggs.c.html#LN1358"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>&& </span><a href="../../../include/postgres.h.html#LN477"><span class='Ref_to_Macro'>DatumGetInt32</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1359"><span class='Ref_To_Local'>d</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* count non-distinct tuples */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/executor/tuptable.h.html#LN137"><span class='Ref_to_Macro'>TupIsNull</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="orderedsetaggs.c.html#LN1277"><span class='Ref_To_Local'>abbrevVal</span></a> <span class='Operator'>== </span><a href="orderedsetaggs.c.html#LN1278"><span class='Ref_To_Local'>abbrevOld</span></a> <span class='Operator'>&& 
</span>            <a href="../../executor/execGrouping.c.html#LN67"><span class='Ref_to_Func'>execTuplesMatch</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>, </span><a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a><span class='Delimiter'>, 
</span>                            <a href="orderedsetaggs.c.html#LN1276"><span class='Ref_To_Local'>numDistinctCols</span></a><span class='Delimiter'>, 
</span>                            <a href="orderedsetaggs.c.html#LN1279"><span class='Ref_To_Local'>sortColIdx</span></a><span class='Delimiter'>, 
</span>                            <a href="orderedsetaggs.c.html#LN1280"><span class='Ref_To_Local'>equalfns</span></a><span class='Delimiter'>, 
</span>                            <a href="orderedsetaggs.c.html#LN1284"><span class='Ref_To_Local'>tmpcontext</span></a><span class='Parentheses'>))</span> 
            <a href="orderedsetaggs.c.html#LN1274"><span class='Ref_To_Local'>duplicate_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN1360"><span class='Ref_To_Local'>tmpslot</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Delimiter'>; 
</span>        <a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1360"><span class='Ref_To_Local'>tmpslot</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* avoid execTuplesMatch() calls by reusing abbreviated keys */ 
</span>        <a href="orderedsetaggs.c.html#LN1278"><span class='Ref_To_Local'>abbrevOld</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1277"><span class='Ref_To_Local'>abbrevVal</span></a><span class='Delimiter'>; 
</span> 
        <a href="orderedsetaggs.c.html#LN1273"><span class='Ref_To_Local'>rank</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/miscadmin.h.html#LN99"><span class='Ref_to_Macro'>CHECK_FOR_INTERRUPTS</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while tuplesort_gettupleslo... &raquo; </span> 
 
    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1281"><span class='Ref_To_Local'>slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/executor/tuptable.h.html#LN154"><span class='Ref_to_Proto'>ExecClearTuple</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1283"><span class='Ref_To_Local'>slot2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/executor/tuptable.h.html#LN145"><span class='Ref_to_Proto'>ExecDropSingleTupleTableSlot</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1282"><span class='Ref_To_Local'>extraslot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Might as well clean up the tuplesort object immediately */ 
</span>    <a href="../../../include/utils/tuplesort.h.html#LN106"><span class='Ref_to_Proto'>tuplesort_end</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="orderedsetaggs.c.html#LN1275"><span class='Ref_To_Local'>osastate</span></a><span class='Operator'>-&GT;</span><a href="orderedsetaggs.c.html#LN90"><span class='Ref_to_Member'>sortstate</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="orderedsetaggs.c.html#LN1273"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>= </span><a href="orderedsetaggs.c.html#LN1273"><span class='Ref_To_Local'>rank</span></a> <span class='Operator'>- </span><a href="orderedsetaggs.c.html#LN1274"><span class='Ref_To_Local'>duplicate_count</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/fmgr.h.html#LN326"><span class='Ref_to_Macro'>PG_RETURN_INT64</span></a><span class='Parentheses'>(</span><a href="orderedsetaggs.c.html#LN1273"><span class='Ref_To_Local'>rank</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hypothetical_dense_rank_final &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>