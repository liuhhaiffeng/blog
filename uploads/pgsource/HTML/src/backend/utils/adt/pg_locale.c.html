<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\adt\pg_locale.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\adt\pg_locale.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:52 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*----------------------------------------------------------------------- 
 * 
 * PostgreSQL locale utilities 
 * 
 * Portions Copyright (c) 2002-2017, PostgreSQL Global Development Group 
 * 
 * src/backend/utils/adt/pg_locale.c 
 * 
 *----------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/*---------- 
 * Here is how the locale stuff is handled: LC_COLLATE and LC_CTYPE 
 * are fixed at CREATE DATABASE time, stored in pg_database, and cannot 
 * be changed. Thus, the effects of strcoll(), strxfrm(), isupper(), 
 * toupper(), etc. are always in the same fixed locale. 
 * 
 * LC_MESSAGES is settable at run time and will take effect 
 * immediately. 
 * 
 * The other categories, LC_MONETARY, LC_NUMERIC, and LC_TIME are also 
 * settable at run-time.  However, we don't actually set those locale 
 * categories permanently.  This would have bizarre effects like no 
 * longer accepting standard floating-point literals in some locales. 
 * Instead, we only set the locales briefly when needed, cache the 
 * required information obtained from localeconv(), and set them back. 
 * The cached information is only used by the formatting functions 
 * (to_char, etc.) and the money type.  For the user, this should all be 
 * transparent. 
 * 
 * !!! NOW HEAR THIS !!! 
 * 
 * We've been bitten repeatedly by this bug, so let's try to keep it in 
 * mind in future: on some platforms, the locale functions return pointers 
 * to static data that will be overwritten by any later locale function. 
 * Thus, for example, the obvious-looking sequence 
 *          save = setlocale(category, NULL); 
 *          if (!setlocale(category, value)) 
 *              fail = true; 
 *          setlocale(category, save); 
 * DOES NOT WORK RELIABLY: on some platforms the second setlocale() call 
 * will change the memory save is pointing at.  To do this sort of thing 
 * safely, you *must* pstrdup what setlocale returns the first time. 
 * 
 * FYI, The Open Group locale standard is defined here: 
 * 
 *  http://www.opengroup.org/onlinepubs/009695399/basedefs/xbd_chap07.html 
 *---------- 
 */ 
</span> 
 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_control.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/pg_locale.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
<span class='Directive'>#ifdef</span> USE_ICU 
<span class='Keyword'>#include </span><span class='String'>&LT;unicode/ucnv.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* 
 * This Windows file defines StrNCpy. We don't need it here, so we undefine 
 * it to keep the compiler quiet, and undefine it again after the file is 
 * included, so we don't accidentally use theirs. 
 */ 
</span><span class='Keyword'>#undef </span><a href="../../../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a> 
<span class='Keyword'>#include </span><span class='String'>&LT;shlwapi.h&GT;</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN829"><span class='Ref_to_Macro'>StrNCpy</span></a> 
<span class='Keyword'>#undef </span>STrNCpy 
<span class='Directive'>#endif</span> 
<span class='Directive'>#endif</span> 
 
<a name="LN83"></a><span class='Keyword'>#define</span>     <span class='Declare_Constant'>MAX_L10N_DATA</span>       <span class='Number'>80</span> 
 
 
<span class='Comment_Multi_Line'>/* GUC settings */ 
</span><a name="LN87"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>locale_messages</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>locale_monetary</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>locale_numeric</span><span class='Delimiter'>; 
</span><a name="LN90"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>locale_time</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* lc_time localization cache */ 
</span><a name="LN93"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>localized_abbrev_days</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span><a name="LN94"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>localized_full_days</span><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>]; 
</span><a name="LN95"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>localized_abbrev_months</span><span class='Delimiter'>[</span><span class='Number'>12</span><span class='Delimiter'>]; 
</span><a name="LN96"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>localized_full_months</span><span class='Delimiter'>[</span><span class='Number'>12</span><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* indicates whether locale information cache is valid */ 
</span><a name="LN99"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>CurrentLocaleConvValid</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN100"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>CurrentLCTimeValid</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Environment variable storage area */ 
</span> 
<a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>LC_ENV_BUFSIZE</span> <span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> <span class='Operator'>+ </span><span class='Number'>20</span><span class='Parentheses'>) 
</span> 
<a name="LN106"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_collate_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN107"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_ctype_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span> 
<span class='Directive'>#ifdef</span> LC_MESSAGES 
<a name="LN110"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_messages_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span><span class='Directive'>#endif</span> 
<a name="LN112"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_monetary_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN113"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_numeric_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span><a name="LN114"></a><span class='Keyword'>static char </span><span class='Declare_Var'>lc_time_envbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span> 
<span class='Comment_Multi_Line'>/* Cache for collation-related knowledge */ 
</span> 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN120"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>collid</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* hash key: pg_collation OID */ 
</span><a name="LN121"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>collate_is_c</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* is collation's LC_COLLATE C? */ 
</span><a name="LN122"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>ctype_is_c</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* is collation's LC_CTYPE C? */ 
</span><a name="LN123"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>flags_valid</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* true if above flags are valid */ 
</span><a name="LN124"></a>    <a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a> <span class='Declare_Member'>locale</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* locale_t struct, or 0 if not valid */ 
</span><a name="LN125"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>collation_cache_entry</span><span class='Delimiter'>; 
</span> 
<a name="LN127"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>collation_cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>LC_MESSAGES<span class='Parentheses'>) 
</span><a name="LN131"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>IsoLocaleName</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><span class='Declare_Parameter'>char</span> <span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* MSVC specific */ 
</span><span class='Directive'>#endif</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * pg_perm_setlocale 
 * 
 * This wraps the libc function setlocale(), with two additions.  First, when 
 * changing LC_CTYPE, update gettext's encoding for the current message 
 * domain.  GNU gettext automatically tracks LC_CTYPE on most platforms, but 
 * not on Windows.  Second, if the operation is successful, the corresponding 
 * LC_XXX environment variable is set to match.  By setting the environment 
 * variable, we ensure that any subsequent use of setlocale(..., "") will 
 * preserve the settings made through this routine.  Of course, LC_ALL must 
 * also be unset to fully ensure that, but that has to be done elsewhere after 
 * all the individual LC_XXX variables have been set correctly.  (Thank you 
 * Perl for making this kluge necessary.) 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN150"></a><span class='Declare_Function'>pg_perm_setlocale</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>category</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>locale</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN152"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN153"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>envvar</span><span class='Delimiter'>; 
</span><a name="LN154"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>envbuf</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * On Windows, setlocale(LC_MESSAGES) does not work, so just assume that 
     * the given value is good and set it in the environment variables. We 
     * must ignore attempts to set to "", which means "keep using the old 
     * environment value". 
     */ 
</span><span class='Directive'>#ifdef</span> LC_MESSAGES 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_MESSAGES<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* fall out immediately on failure */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use the right encoding in translated messages.  Under ENABLE_NLS, let 
     * pg_bind_textdomain_codeset() figure it out.  Under !ENABLE_NLS, message 
     * format strings are ASCII, but database-encoding strings may enter the 
     * message via %s.  This makes the overall message encoding equal to the 
     * database encoding. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a> <span class='Operator'>== </span>LC_CTYPE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN190"></a>        <span class='Keyword'>static char </span><span class='Declare_Local'>save_lc_ctype</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* copy setlocale() return value before callee invokes it again */ 
</span>        <a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN190"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN190"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN190"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> ENABLE_NLS 
        <a href="../../../include/mb/pg_wchar.h.html#LN547"><span class='Ref_to_Proto'>SetMessageEncoding</span></a><span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN551"><span class='Ref_to_Proto'>pg_bind_textdomain_codeset</span></a><span class='Parentheses'>(</span>textdomain<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../../include/mb/pg_wchar.h.html#LN547"><span class='Ref_to_Proto'>SetMessageEncoding</span></a><span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> LC_COLLATE<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_COLLATE"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN106"><span class='Ref_to_Global_Var'>lc_collate_envbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> LC_CTYPE<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_CTYPE"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN107"><span class='Ref_to_Global_Var'>lc_ctype_envbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> LC_MESSAGES 
        <span class='Control'>case</span> LC_MESSAGES<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_MESSAGES"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN110"><span class='Ref_to_Global_Var'>lc_messages_envbuf</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN131"><span class='Ref_to_Proto'>IsoLocaleName</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>locale</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* LC_MESSAGES */ 
</span>        <span class='Control'>case</span> LC_MONETARY<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_MONETARY"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN112"><span class='Ref_to_Global_Var'>lc_monetary_envbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> LC_NUMERIC<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_NUMERIC"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN113"><span class='Ref_to_Global_Var'>lc_numeric_envbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> LC_TIME<span class='Operator'>: 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='String'>"LC_TIME"</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN114"><span class='Ref_to_Global_Var'>lc_time_envbuf</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized LC category: %d"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN150"><span class='Ref_to_Parameter'>category</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span>            <a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch category &raquo; </span> 
 
    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN104"><span class='Ref_to_Const'>LC_ENV_BUFSIZE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s=%s"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN153"><span class='Ref_To_Local'>envvar</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN410"><span class='Ref_to_Macro'>putenv</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN154"><span class='Ref_To_Local'>envbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN152"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_perm_setlocale &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Is the locale name valid for the locale category? 
 * 
 * If successful, and canonname isn't NULL, a palloc'd copy of the locale's 
 * canonical name is stored there.  This is especially useful for figuring out 
 * what locale name "" means (ie, the server environment value).  (Actually, 
 * it seems that on most implementations that's the only thing it's good for; 
 * we could wish that setlocale gave back a canonically spelled version of 
 * the locale name, but typically it doesn't.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN263"></a><span class='Declare_Function'>check_locale</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>category</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>locale</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>canonname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN265"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save</span><span class='Delimiter'>; 
</span><a name="LN266"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>canonname</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>canonname</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* in case of failure */ 
</span> 
    <a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* won't happen, we hope */ 
</span> 
    <span class='Comment_Multi_Line'>/* save may be pointing at a modifiable scratch variable, see above. */ 
</span>    <a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* set the locale with setlocale, to see if it accepts it. */ 
</span>    <a href="pg_locale.c.html#LN266"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* save canonical name if requested. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN266"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>&& </span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>canonname</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>canonname</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN266"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* restore old value. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN263"><span class='Ref_to_Parameter'>category</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"failed to restore old locale \"%s\""</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN265"><span class='Ref_To_Local'>save</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN266"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_locale &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * GUC check/assign hooks 
 * 
 * For most locale categories, the assign hook doesn't actually set the locale 
 * permanently, just reset flags so that the next use will cache the 
 * appropriate values.  (See explanation at the top of this file.) 
 * 
 * Note: we accept value = "" as selecting the postmaster's environment 
 * value, whatever it was (so long as the environment setting is legal). 
 * This will have been locked down by an earlier call to pg_perm_setlocale. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN306"></a><span class='Declare_Function'>check_locale_monetary</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN306"><span class='Ref_to_Parameter'>newval</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN312"></a><span class='Declare_Function'>assign_locale_monetary</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>extra</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_locale.c.html#LN99"><span class='Ref_to_Global_Var'>CurrentLocaleConvValid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN318"></a><span class='Declare_Function'>check_locale_numeric</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN318"><span class='Ref_to_Parameter'>newval</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN324"></a><span class='Declare_Function'>assign_locale_numeric</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>extra</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_locale.c.html#LN99"><span class='Ref_to_Global_Var'>CurrentLocaleConvValid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN330"></a><span class='Declare_Function'>check_locale_time</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN330"><span class='Ref_to_Parameter'>newval</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN336"></a><span class='Declare_Function'>assign_locale_time</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>extra</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_locale.c.html#LN100"><span class='Ref_to_Global_Var'>CurrentLCTimeValid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We allow LC_MESSAGES to actually be set globally. 
 * 
 * Note: we normally disallow value = "" because it wouldn't have consistent 
 * semantics (it'd effectively just use the previous value).  However, this 
 * is the value passed for PGC_S_DEFAULT, so don't complain in that case, 
 * not even if the attempted setting fails due to invalid environment value. 
 * The idea there is just to accept the environment setting *if possible* 
 * during startup, until we can read the proper value from postgresql.conf. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN352"></a><span class='Declare_Function'>check_locale_messages</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>extra</span><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN104"><span class='Ref_to_Typedef'>GucSource</span></a> <span class='Declare_Parameter'>source</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>**</span><a href="pg_locale.c.html#LN352"><span class='Ref_to_Parameter'>newval</span></a> <span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN352"><span class='Ref_to_Parameter'>source</span></a> <span class='Operator'>== </span><a href="../../../include/utils/guc.h.html#LN106"><span class='Ref_to_EnumConst'>PGC_S_DEFAULT</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * LC_MESSAGES category does not exist everywhere, but accept it anyway 
     * 
     * On Windows, we can't even check the value, so accept blindly 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>LC_MESSAGES<span class='Parentheses'>) </span><span class='Operator'>&& !</span>defined<span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/pg_locale.h.html#LN46"><span class='Ref_to_Proto'>check_locale</span></a><span class='Parentheses'>(</span>LC_MESSAGES<span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN352"><span class='Ref_to_Parameter'>newval</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end check_locale_messages &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN375"></a><span class='Declare_Function'>assign_locale_messages</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>newval</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>extra</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * LC_MESSAGES category does not exist everywhere, but accept it anyway. 
     * We ignore failure, as per comment above. 
     */ 
</span><span class='Directive'>#ifdef</span> LC_MESSAGES 
    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/pg_locale.h.html#LN47"><span class='Ref_to_Proto'>pg_perm_setlocale</span></a><span class='Parentheses'>(</span>LC_MESSAGES<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN375"><span class='Ref_to_Parameter'>newval</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Frees the malloced content of a struct lconv.  (But not the struct 
 * itself.)  It's important that this not throw elog(ERROR). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN392"></a><span class='Declare_Function'>free_struct_lconv</span><span class='Parentheses'>(</span><span class='Control'>struct</span> lconv <span class='Operator'>* </span><span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>decimal_point<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>thousands_sep<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>grouping<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>grouping<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>int_curr_symbol<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>int_curr_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>currency_symbol<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>currency_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_decimal_point<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_thousands_sep<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_grouping<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_grouping<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>positive_sign<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>positive_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>negative_sign<span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN392"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>negative_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end free_struct_lconv &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check that all fields of a struct lconv (or at least, the ones we care 
 * about) are non-NULL.  The field list must match free_struct_lconv(). 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN421"></a><span class='Declare_Function'>struct_lconv_is_valid</span><span class='Parentheses'>(</span><span class='Control'>struct</span> lconv <span class='Operator'>* </span><span class='Declare_Parameter'>s</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>decimal_point <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>thousands_sep <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>grouping <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>int_curr_symbol <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>currency_symbol <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_decimal_point <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_thousands_sep <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>mon_grouping <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>positive_sign <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN421"><span class='Ref_to_Parameter'>s</span></a><span class='Operator'>-&GT;</span>negative_sign <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end struct_lconv_is_valid &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Convert the strdup'd string at *str from the specified encoding to the 
 * database encoding. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN452"></a><span class='Declare_Function'>db_encoding_convert</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>encoding</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN454"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>pstr</span><span class='Delimiter'>; 
</span><a name="LN455"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>mstr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* convert the string to the database encoding */ 
</span>    <a href="pg_locale.c.html#LN454"><span class='Ref_To_Local'>pstr</span></a> <span class='Operator'>= </span><a href="../../../include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>str</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>encoding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN454"><span class='Ref_To_Local'>pstr</span></a> <span class='Operator'>== *</span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* no conversion happened */ 
</span> 
    <span class='Comment_Multi_Line'>/* need it malloc'd not palloc'd */ 
</span>    <a href="pg_locale.c.html#LN455"><span class='Ref_To_Local'>mstr</span></a> <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN454"><span class='Ref_To_Local'>pstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN455"><span class='Ref_To_Local'>mstr</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* replace old string */ 
</span>    <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pg_locale.c.html#LN452"><span class='Ref_to_Parameter'>str</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN455"><span class='Ref_To_Local'>mstr</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN454"><span class='Ref_To_Local'>pstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end db_encoding_convert &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Return the POSIX lconv struct (contains number/money formatting 
 * information) with locale information for all categories. 
 */ 
</span><span class='Control'>struct</span> lconv <span class='Operator'>* 
</span><a name="LN482"></a><span class='Declare_Function'>PGLC_localeconv</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN484"></a>    <span class='Keyword'>static </span><span class='Control'>struct</span> lconv <span class='Declare_Local'>CurrentLocaleConv</span><span class='Delimiter'>; 
</span><a name="LN485"></a>    <span class='Keyword'>static bool </span><span class='Declare_Local'>CurrentLocaleConvAllocated</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN486"></a>    <span class='Control'>struct</span> lconv <span class='Operator'>*</span><span class='Declare_Local'>extlconv</span><span class='Delimiter'>; 
</span><a name="LN487"></a>    <span class='Control'>struct</span> lconv <span class='Declare_Local'>worklconv</span><span class='Delimiter'>; 
</span><a name="LN488"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>trouble</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN489"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_lc_monetary</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_lc_numeric</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN492"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_lc_ctype</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Did we do it already? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN99"><span class='Ref_to_Global_Var'>CurrentLocaleConvValid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>&</span><a href="pg_locale.c.html#LN484"><span class='Ref_To_Local'>CurrentLocaleConv</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Free any already-allocated storage */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN485"><span class='Ref_To_Local'>CurrentLocaleConvAllocated</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN391"><span class='Ref_to_Func'>free_struct_lconv</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN484"><span class='Ref_To_Local'>CurrentLocaleConv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN485"><span class='Ref_To_Local'>CurrentLocaleConvAllocated</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This is tricky because we really don't want to risk throwing error 
     * while the locale is set to other than our usual settings.  Therefore, 
     * the process is: collect the usual settings, set locale to special 
     * setting, copy relevant data into worklconv using strdup(), restore 
     * normal settings, convert data to desired encoding, and finally stash 
     * the collected data in CurrentLocaleConv.  This makes it safe if we 
     * throw an error during encoding conversion or run out of memory anywhere 
     * in the process.  All data pointed to by struct lconv members is 
     * allocated with strdup, to avoid premature elog(ERROR) and to allow 
     * using a single cleanup routine. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Save user's values of monetary and numeric locales */ 
</span>    <a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * Ideally, monetary and numeric local symbols could be returned in any 
     * server encoding.  Unfortunately, the WIN32 API does not allow 
     * setlocale() to return values in a codepage/CTYPE that uses more than 
     * two bytes per character, such as UTF-8: 
     * 
     * http://msdn.microsoft.com/en-us/library/x99tb11d.aspx 
     * 
     * Evidently, LC_CTYPE allows us to control the encoding used for strings 
     * returned by localeconv().  The Open Group standard, mentioned at the 
     * top of this C file, doesn't explicitly state this. 
     * 
     * Therefore, we set LC_CTYPE to match LC_NUMERIC or LC_MONETARY (which 
     * cannot be UTF8), call localeconv(), and then convert from the 
     * numeric/monetary LC_CTYPE to the server encoding.  One example use of 
     * this is for the Euro symbol. 
     * 
     * Perhaps someday we will use GetLocaleInfoW() which returns values in 
     * UTF16 and convert from that. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* save user's value of ctype locale */ 
</span>    <a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Here begins the critical section where we must not throw error */ 
</span> 
    <span class='Comment_Multi_Line'>/* use numeric to set the ctype */ 
</span>    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN89"><span class='Ref_to_Global_Var'>locale_numeric</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Get formatting information for numeric */ 
</span>    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN89"><span class='Ref_to_Global_Var'>locale_numeric</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a> <span class='Operator'>= </span>localeconv<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must copy data now in case setlocale() overwrites it */ 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>decimal_point <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>thousands_sep <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>grouping <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>grouping<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* use monetary to set the ctype */ 
</span>    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN88"><span class='Ref_to_Global_Var'>locale_monetary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Get formatting information for monetary */ 
</span>    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN88"><span class='Ref_to_Global_Var'>locale_monetary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a> <span class='Operator'>= </span>localeconv<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must copy data now in case setlocale() overwrites it */ 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>int_curr_symbol <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>int_curr_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>currency_symbol <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>currency_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>mon_decimal_point <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>mon_decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>mon_thousands_sep <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>mon_thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>mon_grouping <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>mon_grouping<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>positive_sign <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>positive_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>negative_sign <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>negative_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Copy scalar fields as well */ 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>int_frac_digits <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>int_frac_digits<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>frac_digits <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>frac_digits<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>p_cs_precedes <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>p_cs_precedes<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>p_sep_by_space <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>p_sep_by_space<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>n_cs_precedes <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>n_cs_precedes<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>n_sep_by_space <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>n_sep_by_space<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>p_sign_posn <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>p_sign_posn<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>n_sign_posn <span class='Operator'>= </span><a href="pg_locale.c.html#LN486"><span class='Ref_To_Local'>extlconv</span></a><span class='Operator'>-&GT;</span>n_sign_posn<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Try to restore internal settings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_MONETARY<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>))</span> 
            <a href="pg_locale.c.html#LN488"><span class='Ref_To_Local'>trouble</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_NUMERIC<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>))</span> 
            <a href="pg_locale.c.html#LN488"><span class='Ref_To_Local'>trouble</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Try to restore internal ctype settings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>))</span> 
            <a href="pg_locale.c.html#LN488"><span class='Ref_To_Local'>trouble</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * At this point we've done our best to clean up, and can call functions 
     * that might possibly throw errors with a clean conscience.  But let's 
     * make sure we don't leak any already-strdup'd fields in worklconv. 
     */ 
</span>    <a href="../../../include/utils/elog.h.html#LN283"><span class='Ref_to_Macro'>PG_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span><a name="LN628"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>encoding</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Report it if we failed to restore anything.  Perhaps this should be 
         * FATAL, rather than continuing with bad locale settings? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN488"><span class='Ref_To_Local'>trouble</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"failed to restore old locale"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Release the pstrdup'd locale names */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN489"><span class='Ref_To_Local'>save_lc_monetary</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN490"><span class='Ref_To_Local'>save_lc_numeric</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN492"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* If any of the preceding strdup calls failed, complain now. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN420"><span class='Ref_to_Func'>struct_lconv_is_valid</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Now we must perform encoding conversion from whatever's associated 
         * with the locale into the database encoding. 
         */ 
</span>        <a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>= </span><a href="../../../port/chklocale.c.html#LN309"><span class='Ref_to_Func'>pg_get_encoding_from_locale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN89"><span class='Ref_to_Global_Var'>locale_numeric</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* grouping is not text and does not require conversion */ 
</span> 
        <a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a> <span class='Operator'>= </span><a href="../../../port/chklocale.c.html#LN309"><span class='Ref_to_Func'>pg_get_encoding_from_locale</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN88"><span class='Ref_to_Global_Var'>locale_monetary</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>int_curr_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>currency_symbol<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>mon_decimal_point<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>mon_thousands_sep<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* mon_grouping is not text and does not require conversion */ 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>positive_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN451"><span class='Ref_to_Func'>db_encoding_convert</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN628"><span class='Ref_To_Local'>encoding</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Operator'>.</span>negative_sign<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN292"><span class='Ref_to_Macro'>PG_CATCH</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN391"><span class='Ref_to_Func'>free_struct_lconv</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN310"><span class='Ref_to_Macro'>PG_RE_THROW</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/utils/elog.h.html#LN299"><span class='Ref_to_Macro'>PG_END_TRY</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Everything is good, so save the results. 
     */ 
</span>    <a href="pg_locale.c.html#LN484"><span class='Ref_To_Local'>CurrentLocaleConv</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN487"><span class='Ref_To_Local'>worklconv</span></a><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN485"><span class='Ref_To_Local'>CurrentLocaleConvAllocated</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN99"><span class='Ref_to_Global_Var'>CurrentLocaleConvValid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Operator'>&</span><a href="pg_locale.c.html#LN484"><span class='Ref_To_Local'>CurrentLocaleConv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PGLC_localeconv &raquo; </span> 
 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<span class='Comment_Multi_Line'>/* 
 * On WIN32, strftime() returns the encoding in CP_ACP (the default 
 * operating system codpage for that computer), which is likely different 
 * from SERVER_ENCODING.  This is especially important in Japanese versions 
 * of Windows which will use SJIS encoding, which we don't support as a 
 * server encoding. 
 * 
 * So, instead of using strftime(), use wcsftime() to return the value in 
 * wide characters (internally UTF16) and then convert it to the appropriate 
 * database encoding. 
 * 
 * Note that this only affects the calls to strftime() in this file, which are 
 * used to get the locale-aware strings. Other parts of the backend use 
 * pg_strftime(), which isn't locale-aware and does not need to be replaced. 
 */ 
</span><span class='Keyword'>static </span>size_t 
<a name="LN706"></a><span class='Declare_Function'>strftime_win32</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dst</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>dstlen</span><span class='Delimiter'>, 
</span><a name="LN707"></a>               <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>format</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><span class='Control'>struct</span> <a href="pg_locale.c.html#LN707"><span class='Ref_to_Parameter'>tm</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>tm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN709"></a>    size_t      <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN710"></a>    <span class='Keyword'>wchar_t</span>     <span class='Declare_Local'>wformat</span><span class='Delimiter'>[</span><span class='Number'>8</span><span class='Delimiter'>];</span>     <span class='Comment_Single_Line'>/* formats used below need 3 bytes */ 
</span><a name="LN711"></a>    <span class='Keyword'>wchar_t</span>     <span class='Declare_Local'>wbuf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN83"><span class='Ref_to_Const'>MAX_L10N_DATA</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* get a wchar_t version of the format string */ 
</span>    <a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>MultiByteToWideChar<span class='Parentheses'>(</span>CP_UTF8<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN707"><span class='Ref_to_Parameter'>format</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                              <a href="pg_locale.c.html#LN710"><span class='Ref_To_Local'>wformat</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN710"><span class='Ref_To_Local'>wformat</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not convert format string from UTF-8: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>wcsftime<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN711"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN83"><span class='Ref_to_Const'>MAX_L10N_DATA</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN710"><span class='Ref_To_Local'>wformat</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN707"><span class='Ref_to_Parameter'>tm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * strftime failed, possibly because the result would not fit in 
         * MAX_L10N_DATA.  Return 0 with the contents of dst unspecified. 
         */ 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>WideCharToMultiByte<span class='Parentheses'>(</span>CP_UTF8<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN711"><span class='Ref_To_Local'>wbuf</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dstlen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, 
</span>                              <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not convert string to UTF-8: error code %lu"</span><span class='Delimiter'>, 
</span>             GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN739"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>convstr</span> <span class='Operator'>= </span><a href="../../../include/mb/pg_wchar.h.html#LN566"><span class='Ref_to_Proto'>pg_any_to_server</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>, </span><a href="../../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN739"><span class='Ref_To_Local'>convstr</span></a> <span class='Operator'>!= </span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN739"><span class='Ref_To_Local'>convstr</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dstlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN706"><span class='Ref_to_Parameter'>dst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN739"><span class='Ref_To_Local'>convstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN709"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end strftime_win32 &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* redefine strftime() */ 
</span><a name="LN753"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>strftime</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>c</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>d</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN705"><span class='Ref_to_Func'>strftime_win32</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN753"><span class='Ref_to_Parameter'>a</span></a><span class='Delimiter'>,</span><a href="pg_locale.c.html#LN753"><span class='Ref_to_Parameter'>b</span></a><span class='Delimiter'>,</span><a href="pg_locale.c.html#LN753"><span class='Ref_to_Parameter'>c</span></a><span class='Delimiter'>,</span><a href="pg_locale.c.html#LN753"><span class='Ref_to_Parameter'>d</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
<span class='Comment_Multi_Line'>/* Subroutine for cache_locale_time(). */ 
</span><span class='Keyword'>static void 
</span><a name="LN758"></a><span class='Declare_Function'>cache_single_time</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>dst</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>format</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><span class='Control'>struct</span> <a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>tm</span></a> <span class='Operator'>* </span><span class='Declare_Parameter'>tm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN760"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN83"><span class='Ref_to_Const'>MAX_L10N_DATA</span></a><span class='Delimiter'>]; 
</span><a name="LN761"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * MAX_L10N_DATA is sufficient buffer space for every known locale, and 
     * POSIX defines no strftime() errors.  (Buffer space exhaustion is not an 
     * error.)  An implementation might report errors (e.g. ENOMEM) by 
     * returning 0 (or, less plausibly, a negative value) and setting errno. 
     * Report errno just in case the implementation did that, but clear it in 
     * advance of the call so we don't emit a stale, unrelated errno. 
     */ 
</span>    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN753"><span class='Ref_to_Macro'>strftime</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN760"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN83"><span class='Ref_to_Const'>MAX_L10N_DATA</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>format</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>tm</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"strftime(%s) failed: %m"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>format</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN761"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN760"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>dst</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>dst</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pg_locale.c.html#LN758"><span class='Ref_to_Parameter'>dst</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN761"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cache_single_time &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Update the lc_time localization cache variables if needed. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN785"></a><span class='Declare_Function'>cache_locale_time</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN787"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_lc_time</span><span class='Delimiter'>; 
</span><a name="LN788"></a>    time_t      <span class='Declare_Local'>timenow</span><span class='Delimiter'>; 
</span><a name="LN789"></a>    <span class='Control'>struct</span> <a href="../../../timezone/localtime.c.html#LN110"><span class='Ref_to_Global_Var'>tm</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>timeinfo</span><span class='Delimiter'>; 
</span><a name="LN790"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN793"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>save_lc_ctype</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* did we do this already? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN100"><span class='Ref_to_Global_Var'>CurrentLCTimeValid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"cache_locale_time() executed; locale: \"%s\""</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN90"><span class='Ref_to_Global_Var'>locale_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* save user's value of time locale */ 
</span>    <a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * On WIN32, there is no way to get locale-specific time values in a 
     * specified locale, like we do for monetary/numeric.  We can only get 
     * CP_ACP (see strftime_win32) or UTF16.  Therefore, we get UTF16 and 
     * convert it to the database locale.  However, wcsftime() internally uses 
     * LC_CTYPE, so we set it here.  See the WIN32 comment near the top of 
     * PGLC_localeconv(). 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* save user's value of ctype locale */ 
</span>    <a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* use lc_time to set the ctype */ 
</span>    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN90"><span class='Ref_to_Global_Var'>locale_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN90"><span class='Ref_to_Global_Var'>locale_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN788"><span class='Ref_To_Local'>timenow</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a> <span class='Operator'>= </span>localtime<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN788"><span class='Ref_To_Local'>timenow</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* localized days */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>7</span><span class='Delimiter'>; </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Operator'>-&GT;</span>tm_wday <span class='Operator'>= </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN757"><span class='Ref_to_Func'>cache_single_time</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN93"><span class='Ref_to_Global_Var'>localized_abbrev_days</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"%a"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN757"><span class='Ref_to_Func'>cache_single_time</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN94"><span class='Ref_to_Global_Var'>localized_full_days</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"%A"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* localized months */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><span class='Number'>12</span><span class='Delimiter'>; </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Operator'>-&GT;</span>tm_mon <span class='Operator'>= </span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Operator'>-&GT;</span>tm_mday <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* make sure we don't have invalid date */ 
</span>        <a href="pg_locale.c.html#LN757"><span class='Ref_to_Func'>cache_single_time</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN95"><span class='Ref_to_Global_Var'>localized_abbrev_months</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"%b"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN757"><span class='Ref_to_Func'>cache_single_time</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN96"><span class='Ref_to_Global_Var'>localized_full_months</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN790"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><span class='String'>"%B"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN789"><span class='Ref_To_Local'>timeinfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* try to restore internal settings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_TIME<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"failed to restore old locale"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN787"><span class='Ref_To_Local'>save_lc_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* try to restore internal ctype settings */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"failed to restore old locale"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN793"><span class='Ref_To_Local'>save_lc_ctype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <a href="pg_locale.c.html#LN100"><span class='Ref_to_Global_Var'>CurrentLCTimeValid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cache_locale_time &raquo; </span> 
 
 
<span class='Directive'>#if</span> defined<span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span>defined<span class='Parentheses'>(</span>LC_MESSAGES<span class='Parentheses'>) 
</span><span class='Comment_Multi_Line'>/* 
 * Convert a Windows setlocale() argument to a Unix-style one. 
 * 
 * Regardless of platform, we install message catalogs under a Unix-style 
 * LL[_CC][.ENCODING][@VARIANT] naming convention.  Only LC_MESSAGES settings 
 * following that style will elicit localized interface strings. 
 * 
 * Before Visual Studio 2012 (msvcr110.dll), Windows setlocale() accepted "C" 
 * (but not "c") and strings of the form &LT;Language&GT;[_&LT;Country&GT;][.&LT;CodePage&GT;], 
 * case-insensitive.  setlocale() returns the fully-qualified form; for 
 * example, setlocale("thaI") returns "Thai_Thailand.874".  Internally, 
 * setlocale() and _create_locale() select a "locale identifier"[1] and store 
 * it in an undocumented _locale_t field.  From that LCID, we can retrieve the 
 * ISO 639 language and the ISO 3166 country.  Character encoding does not 
 * matter, because the server and client encodings govern that. 
 * 
 * Windows Vista introduced the "locale name" concept[2], closely following 
 * RFC 4646.  Locale identifiers are now deprecated.  Starting with Visual 
 * Studio 2012, setlocale() accepts locale names in addition to the strings it 
 * accepted historically.  It does not standardize them; setlocale("Th-tH") 
 * returns "Th-tH".  setlocale(category, "") still returns a traditional 
 * string.  Furthermore, msvcr110.dll changed the undocumented _locale_t 
 * content to carry locale names instead of locale identifiers. 
 * 
 * MinGW headers declare _create_locale(), but msvcrt.dll lacks that symbol. 
 * IsoLocaleName() always fails in a MinGW-built postgres.exe, so only 
 * Unix-style values of the lc_messages GUC can elicit localized messages.  In 
 * particular, every lc_messages setting that initdb can select automatically 
 * will yield only C-locale messages.  XXX This could be fixed by running the 
 * fully-qualified locale name through a lookup table. 
 * 
 * This function returns a pointer to a static buffer bearing the converted 
 * name or NULL if conversion fails. 
 * 
 * [1] http://msdn.microsoft.com/en-us/library/windows/desktop/dd373763.aspx 
 * [2] http://msdn.microsoft.com/en-us/library/windows/desktop/dd373814.aspx 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN910"></a><span class='Declare_Function'>IsoLocaleName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>winlocname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> <span class='Parentheses'>(</span>_MSC_VER <span class='Operator'>&GT;= </span><span class='Number'>1400</span><span class='Parentheses'>)</span>          <span class='Comment_Single_Line'>/* VC8.0 or later */ 
</span><a name="LN913"></a>    <span class='Keyword'>static char </span><span class='Declare_Local'>iso_lc_messages</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN914"></a>    _locale_t   <span class='Declare_Local'>loct</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><span class='String'>"c"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN910"><span class='Ref_to_Parameter'>winlocname</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><span class='String'>"posix"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN910"><span class='Ref_to_Parameter'>winlocname</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>, </span><span class='String'>"C"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a> <span class='Operator'>= </span>_create_locale<span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN910"><span class='Ref_to_Parameter'>winlocname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> <span class='Parentheses'>(</span>_MSC_VER <span class='Operator'>&GT;= </span><span class='Number'>1700</span><span class='Parentheses'>)</span>          <span class='Comment_Single_Line'>/* Visual Studio 2012 or later */ 
</span><a name="LN927"></a>        size_t      <span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span><a name="LN928"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>hyphen</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Locale names use only ASCII, any conversion locale suffices. */ 
</span>        <a href="pg_locale.c.html#LN927"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/utils/pg_locale.h.html#LN100"><span class='Ref_to_Proto'>wchar2char</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a><span class='Operator'>-&GT;</span>locinfo<span class='Operator'>-&GT;</span>locale_name<span class='Delimiter'>[</span>LC_CTYPE<span class='Delimiter'>], 
</span>                        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        _free_locale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN927"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== -</span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="pg_locale.c.html#LN927"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Since the message catalogs sit on a case-insensitive filesystem, we 
         * need not standardize letter case here.  So long as we do not ship 
         * message catalogs for which it would matter, we also need not 
         * translate the script/variant portion, e.g. uz-Cyrl-UZ to 
         * uz_UZ@cyrillic.  Simply replace the hyphen with an underscore. 
         * 
         * Note that the locale name can be less-specific than the value we 
         * would derive under earlier Visual Studio releases.  For example, 
         * French_France.1252 yields just "fr".  This does not affect any of 
         * the country-specific message catalogs available as of this writing 
         * (pt_BR, zh_CN, zh_TW). 
         */ 
</span>        <a href="pg_locale.c.html#LN928"><span class='Ref_To_Local'>hyphen</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>, </span><span class='String'>'-'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN928"><span class='Ref_To_Local'>hyphen</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="pg_locale.c.html#LN928"><span class='Ref_To_Local'>hyphen</span></a> <span class='Operator'>= </span><span class='String'>'_'</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN954"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>isolang</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>], 
</span><a name="LN955"></a>                    <span class='Declare_Local'>isocrty</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN956"></a>        LCID        <span class='Declare_Local'>lcid</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN956"><span class='Ref_To_Local'>lcid</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a><span class='Operator'>-&GT;</span>locinfo<span class='Operator'>-&GT;</span>lc_handle<span class='Delimiter'>[</span>LC_CTYPE<span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN956"><span class='Ref_To_Local'>lcid</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="pg_locale.c.html#LN956"><span class='Ref_To_Local'>lcid</span></a> <span class='Operator'>= </span>MAKELCID<span class='Parentheses'>(</span>MAKELANGID<span class='Parentheses'>(</span>LANG_ENGLISH<span class='Delimiter'>, </span>SUBLANG_ENGLISH_US<span class='Parentheses'>)</span><span class='Delimiter'>, </span>SORT_DEFAULT<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        _free_locale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN914"><span class='Ref_To_Local'>loct</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetLocaleInfoA<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN956"><span class='Ref_To_Local'>lcid</span></a><span class='Delimiter'>, </span>LOCALE_SISO639LANGNAME<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN954"><span class='Ref_To_Local'>isolang</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN954"><span class='Ref_To_Local'>isolang</span></a><span class='Parentheses'>)))</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>GetLocaleInfoA<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN956"><span class='Ref_To_Local'>lcid</span></a><span class='Delimiter'>, </span>LOCALE_SISO3166CTRYNAME<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN955"><span class='Ref_To_Local'>isocrty</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN955"><span class='Ref_To_Local'>isocrty</span></a><span class='Parentheses'>)))</span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"%s_%s"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN954"><span class='Ref_To_Local'>isolang</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN955"><span class='Ref_To_Local'>isocrty</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <span class='Control'>return</span> <a href="pg_locale.c.html#LN913"><span class='Ref_To_Local'>iso_lc_messages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if loct!=NULL &raquo; </span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* Not supported on this version of msvc/mingw */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* _MSC_VER &GT;= 1400 */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end IsoLocaleName &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 && LC_MESSAGES */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Detect aging strxfrm() implementations that, in a subset of locales, write 
 * past the specified buffer length.  Affected users must update OS packages 
 * before using PostgreSQL 9.5 or later. 
 * 
 * Assume that the bug can come and go from one postmaster startup to another 
 * due to physical replication among diverse machines.  Assume that the bug's 
 * presence will not change during the life of a particular postmaster.  Given 
 * those assumptions, call this no less than once per postmaster startup per 
 * LC_COLLATE setting used.  No known-affected system offers strxfrm_l(), so 
 * there is no need to consider pg_collation locales. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN992"></a><span class='Declare_Function'>check_strxfrm_bug</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN994"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN995"></a>    <span class='Keyword'>const int</span>   <span class='Declare_Local'>canary</span> <span class='Operator'>= </span><span class='Number'>0x7F</span><span class='Delimiter'>; 
</span><a name="LN996"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>ok</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Given a two-byte ASCII string and length limit 7, 8 or 9, Solaris 10 
     * 05/08 returns 18 and modifies 10 bytes.  It respects limits above or 
     * below that range. 
     * 
     * The bug is present in Solaris 8 as well; it is absent in Solaris 10 
     * 01/13 and Solaris 11.2.  Affected locales include is_IS.ISO8859-1, 
     * en_US.UTF-8, en_US.ISO8859-1, and ru_RU.KOI8-R.  Unaffected locales 
     * include de_DE.UTF-8, de_DE.ISO8859-1, zh_TW.UTF-8, and C. 
     */ 
</span>    <a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_locale.c.html#LN995"><span class='Ref_To_Local'>canary</span></a><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>strxfrm<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"ab"</span><span class='Delimiter'>, </span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>7</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="pg_locale.c.html#LN995"><span class='Ref_To_Local'>canary</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN996"><span class='Ref_To_Local'>ok</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * illumos bug #1594 was present in the source tree from 2010-10-11 to 
     * 2012-02-01.  Given an ASCII string of any length and length limit 1, 
     * affected systems ignore the length limit and modify a number of bytes 
     * one less than the return value.  The problem inputs for this bug do not 
     * overlap those for the Solaris bug, hence a distinct test. 
     * 
     * Affected systems include smartos-20110926T021612Z.  Affected locales 
     * include en_US.ISO8859-1 and en_US.UTF-8.  Unaffected locales include C. 
     */ 
</span>    <a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="pg_locale.c.html#LN995"><span class='Ref_To_Local'>canary</span></a><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span>strxfrm<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"a"</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN994"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="pg_locale.c.html#LN995"><span class='Ref_To_Local'>canary</span></a><span class='Parentheses'>) 
</span>        <a href="pg_locale.c.html#LN996"><span class='Ref_To_Local'>ok</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN996"><span class='Ref_To_Local'>ok</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYSTEM_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN825"><span class='Ref_to_Func'>errmsg_internal</span></a><span class='Parentheses'>(</span><span class='String'>"strxfrm(), in locale \"%s\", writes past the specified array length"</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Apply system library package updates."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end check_strxfrm_bug &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Cache mechanism for collation information. 
 * 
 * We cache two flags: whether the collation's LC_COLLATE or LC_CTYPE is C 
 * (or POSIX), so we can optimize a few code paths in various places. 
 * For the built-in C and POSIX collations, we can know that without even 
 * doing a cache lookup, but we want to support aliases for C/POSIX too. 
 * For the "default" collation, there are separate static cache variables, 
 * since consulting the pg_collation catalog doesn't tell us what we need. 
 * 
 * Also, if a pg_locale_t has been requested for a collation, we cache that 
 * for the life of a backend. 
 * 
 * Note that some code relies on the flags not reporting false negatives 
 * (that is, saying it's not C when it is).  For example, char2wchar() 
 * could fail if the locale is C, so str_tolower() shouldn't call it 
 * in that case. 
 * 
 * Note that we currently lack any way to flush the cache.  Since we don't 
 * support ALTER COLLATION, this is OK.  The worst case is that someone 
 * drops a collation, and a useless cache entry hangs around in existing 
 * backends. 
 */ 
</span> 
<span class='Keyword'>static </span><a href="pg_locale.c.html#LN118"><span class='Ref_to_Typedef'>collation_cache_entry</span></a> <span class='Operator'>* 
</span><a name="LN1062"></a><span class='Declare_Function'>lookup_collation_cache</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>set_flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1064"></a>    <a href="pg_locale.c.html#LN118"><span class='Ref_to_Typedef'>collation_cache_entry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache_entry</span><span class='Delimiter'>; 
</span><a name="LN1065"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>!= </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN127"><span class='Ref_to_Global_Var'>collation_cache</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* First time through, initialize the hash table */ 
</span><a name="LN1073"></a>        <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
        memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1073"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1073"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1073"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1073"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN118"><span class='Ref_to_Typedef'>collation_cache_entry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN127"><span class='Ref_to_Global_Var'>collation_cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Collation cache"</span><span class='Delimiter'>, </span><span class='Number'>100</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1073"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN127"><span class='Ref_to_Global_Var'>collation_cache</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>collation</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1065"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1065"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Make sure cache entry is marked invalid, in case we fail before 
         * setting things. 
         */ 
</span>        <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN123"><span class='Ref_to_Member'>flags_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN124"><span class='Ref_to_Member'>locale</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>set_flags</span></a> <span class='Operator'>&& !</span><a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN123"><span class='Ref_to_Member'>flags_valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Attempt to set the flags */ 
</span><a name="LN1096"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN1097"></a>        <a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a> <span class='Declare_Local'>collform</span><span class='Delimiter'>; 
</span><a name="LN1098"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>collcollate</span><span class='Delimiter'>; 
</span><a name="LN1099"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>collctype</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1096"><span class='Ref_To_Local'>tp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN49"><span class='Ref_to_EnumConst'>COLLOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1096"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for collation %u"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1062"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1097"><span class='Ref_To_Local'>collform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1096"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1098"><span class='Ref_To_Local'>collcollate</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1097"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collcollate<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1099"><span class='Ref_To_Local'>collctype</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1097"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collctype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN121"><span class='Ref_to_Member'>collate_is_c</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1098"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span><span class='String'>"C"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                                     <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1098"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span><span class='String'>"POSIX"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN122"><span class='Ref_to_Member'>ctype_is_c</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1099"><span class='Ref_To_Local'>collctype</span></a><span class='Delimiter'>, </span><span class='String'>"C"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> <span class='Operator'>|| 
</span>                                   <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1099"><span class='Ref_To_Local'>collctype</span></a><span class='Delimiter'>, </span><span class='String'>"POSIX"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN123"><span class='Ref_to_Member'>flags_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1096"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if set_flags&&!cache_ent... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1064"><span class='Ref_To_Local'>cache_entry</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lookup_collation_cache &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Detect whether collation's LC_COLLATE property is C 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1127"></a><span class='Declare_Function'>lc_collate_is_c</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If we're asked about "collation 0", return false, so that the code will 
     * go into the non-C path and report that the collation is bogus. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1127"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're asked about the default collation, we have to inquire of the C 
     * library.  Cache the result so we only have to compute it once. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1127"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1142"></a>        <span class='Keyword'>static int</span>  <span class='Declare_Local'>result</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1143"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>localeptr</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1143"><span class='Ref_To_Local'>localeptr</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_COLLATE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1143"><span class='Ref_To_Local'>localeptr</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid LC_COLLATE setting"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1143"><span class='Ref_To_Local'>localeptr</span></a><span class='Delimiter'>, </span><span class='String'>"C"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1143"><span class='Ref_To_Local'>localeptr</span></a><span class='Delimiter'>, </span><span class='String'>"POSIX"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN1142"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're asked about the built-in C/POSIX collations, we know that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1127"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN77"><span class='Ref_to_Const'>C_COLLATION_OID</span></a> <span class='Operator'>|| 
</span>        <a href="pg_locale.c.html#LN1127"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN80"><span class='Ref_to_Const'>POSIX_COLLATION_OID</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, we have to consult pg_collation, but we cache that. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1061"><span class='Ref_to_Func'>lookup_collation_cache</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1127"><span class='Ref_to_Parameter'>collation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>collate_is_c<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lc_collate_is_c &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Detect whether collation's LC_CTYPE property is C 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1177"></a><span class='Declare_Function'>lc_ctype_is_c</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If we're asked about "collation 0", return false, so that the code will 
     * go into the non-C path and report that the collation is bogus. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1177"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're asked about the default collation, we have to inquire of the C 
     * library.  Cache the result so we only have to compute it once. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1177"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1192"></a>        <span class='Keyword'>static int</span>  <span class='Declare_Local'>result</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1193"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>localeptr</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1193"><span class='Ref_To_Local'>localeptr</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN201"><span class='Ref_to_Macro'>setlocale</span></a><span class='Parentheses'>(</span>LC_CTYPE<span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1193"><span class='Ref_To_Local'>localeptr</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid LC_CTYPE setting"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1193"><span class='Ref_To_Local'>localeptr</span></a><span class='Delimiter'>, </span><span class='String'>"C"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1193"><span class='Ref_To_Local'>localeptr</span></a><span class='Delimiter'>, </span><span class='String'>"POSIX"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) </span><a href="pg_locale.c.html#LN1192"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're asked about the built-in C/POSIX collations, we know that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1177"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN77"><span class='Ref_to_Const'>C_COLLATION_OID</span></a> <span class='Operator'>|| 
</span>        <a href="pg_locale.c.html#LN1177"><span class='Ref_to_Parameter'>collation</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN80"><span class='Ref_to_Const'>POSIX_COLLATION_OID</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, we have to consult pg_collation, but we cache that. 
     */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1061"><span class='Ref_to_Func'>lookup_collation_cache</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1177"><span class='Ref_to_Parameter'>collation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>ctype_is_c<span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end lc_ctype_is_c &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* simple subroutine for reporting errors from newlocale() */ 
</span><span class='Directive'>#ifdef</span> HAVE_LOCALE_T 
<span class='Keyword'>static void 
</span><a name="LN1227"></a><span class='Declare_Function'>report_newlocale_failure</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>localename</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* copy errno in case one of the ereport auxiliary functions changes it */ 
</span><a name="LN1230"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * ENOENT means "no such locale", not "no such file", so clarify that 
     * errno with an errdetail message. 
     */ 
</span>    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create locale \"%s\": %m"</span><span class='Delimiter'>, 
</span>                    <a href="pg_locale.c.html#LN1227"><span class='Ref_to_Parameter'>localename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1230"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>== </span>ENOENT <span class='Operator'>? 
</span>              <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The operating system could not find any locale data for the locale name \"%s\"."</span><span class='Delimiter'>, 
</span>                        <a href="pg_locale.c.html#LN1227"><span class='Ref_to_Parameter'>localename</span></a><span class='Parentheses'>) </span><span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_LOCALE_T */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a locale_t from a collation OID.  Results are cached for the 
 * lifetime of the backend.  Thus, do not free the result with freelocale(). 
 * 
 * As a special optimization, the default/database collation returns 0. 
 * Callers should then revert to the non-locale_t-enabled code path. 
 * In fact, they shouldn't call this function at all when they are dealing 
 * with the default locale.  That can save quite a bit in hotspots. 
 * Also, callers should avoid calling this before going down a C/POSIX 
 * fastpath, because such a fastpath should work even on platforms without 
 * locale_t support in the C library. 
 * 
 * For simplicity, we always generate COLLATE + CTYPE even though we 
 * might only need one of them.  Since this is called only once per session, 
 * it shouldn't cost much. 
 */ 
</span><a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a> 
<a name="LN1264"></a><span class='Declare_Function'>pg_newlocale_from_collation</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1266"></a>    <a href="pg_locale.c.html#LN118"><span class='Ref_to_Typedef'>collation_cache_entry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cache_entry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Callers must pass a valid OID */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1264"><span class='Ref_to_Parameter'>collid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return 0 for "default" collation, just in case caller forgets */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1264"><span class='Ref_to_Parameter'>collid</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN74"><span class='Ref_to_Const'>DEFAULT_COLLATION_OID</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1266"><span class='Ref_To_Local'>cache_entry</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN1061"><span class='Ref_to_Func'>lookup_collation_cache</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1264"><span class='Ref_to_Parameter'>collid</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1266"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN124"><span class='Ref_to_Member'>locale</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We haven't computed this yet in this session, so do it */ 
</span><a name="LN1280"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN1281"></a>        <a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a> <span class='Declare_Local'>collform</span><span class='Delimiter'>; 
</span><a name="LN1282"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>collcollate</span><span class='Delimiter'>; 
</span><a name="LN1283"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span>collctype <span class='Declare_Local'>pg_attribute_unused</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1284"></a>        <a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1285"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>collversion</span><span class='Delimiter'>; 
</span><a name="LN1286"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1280"><span class='Ref_To_Local'>tp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN49"><span class='Ref_to_EnumConst'>COLLOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1264"><span class='Ref_to_Parameter'>collid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1280"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for collation %u"</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1264"><span class='Ref_to_Parameter'>collid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1280"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collcollate<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        collctype <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collctype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memset<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN70"><span class='Ref_to_Member'>provider</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collprovider<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collprovider <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN85"><span class='Ref_to_Const'>COLLPROVIDER_LIBC</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LOCALE_T 
<a name="LN1303"></a>            <a href="../../../include/port/win32.h.html#LN322"><span class='Ref_to_Const'>locale_t</span></a>    <span class='Declare_Local'>loc</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span>collctype<span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Normal case where they're the same */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
                <a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span>newlocale<span class='Parentheses'>(</span>LC_COLLATE_MASK <span class='Operator'>| </span>LC_CTYPE_MASK<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, 
</span>                                <span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                <a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span>_create_locale<span class='Parentheses'>(</span>LC_ALL<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_locale.c.html#LN1226"><span class='Ref_to_Func'>report_newlocale_failure</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
                <span class='Comment_Multi_Line'>/* We need two newlocale() steps */ 
</span><a name="LN1321"></a>                <a href="../../../include/port/win32.h.html#LN322"><span class='Ref_to_Const'>locale_t</span></a>    <span class='Declare_Local'>loc1</span><span class='Delimiter'>; 
</span> 
                <a href="pg_locale.c.html#LN1321"><span class='Ref_To_Local'>loc1</span></a> <span class='Operator'>= </span>newlocale<span class='Parentheses'>(</span>LC_COLLATE_MASK<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1321"><span class='Ref_To_Local'>loc1</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_locale.c.html#LN1226"><span class='Ref_to_Func'>report_newlocale_failure</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a> <span class='Operator'>= </span>newlocale<span class='Parentheses'>(</span>LC_CTYPE_MASK<span class='Delimiter'>, </span>collctype<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1321"><span class='Ref_To_Local'>loc1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_locale.c.html#LN1226"><span class='Ref_to_Func'>report_newlocale_failure</span></a><span class='Parentheses'>(</span>collctype<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
                <span class='Comment_Multi_Line'>/* 
                 * XXX The _create_locale() API doesn't appear to support 
                 * this. Could perhaps be worked around by changing 
                 * pg_locale_t to contain two separate fields. 
                 */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"collations with different collate and ctype values are not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
            <a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>lt <span class='Operator'>= </span><a href="pg_locale.c.html#LN1303"><span class='Ref_To_Local'>loc</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* not HAVE_LOCALE_T */ 
</span>            <span class='Comment_Multi_Line'>/* platform that doesn't support locale_t */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"collation provider LIBC is not supported on this platform"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* not HAVE_LOCALE_T */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if collform-&GT;collprovide... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collprovider <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN84"><span class='Ref_to_Const'>COLLPROVIDER_ICU</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> USE_ICU 
<a name="LN1353"></a>            UCollator  <span class='Operator'>*</span><span class='Declare_Local'>collator</span><span class='Delimiter'>; 
</span><a name="LN1354"></a>            UErrorCode  <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
            <a href="pg_locale.c.html#LN1354"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span>U_ZERO_ERROR<span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN1353"><span class='Ref_To_Local'>collator</span></a> <span class='Operator'>= </span>ucol_open<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1354"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>U_FAILURE<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1354"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                     <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open collator for locale \"%s\": %s"</span><span class='Delimiter'>, 
</span>                             <a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Delimiter'>, </span>u_errorName<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1354"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
            <a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>icu<span class='Operator'>.</span>locale <span class='Operator'>= </span>strdup<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>icu<span class='Operator'>.</span>ucol <span class='Operator'>= </span><a href="pg_locale.c.html#LN1353"><span class='Ref_To_Local'>collator</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* not USE_ICU */ 
</span>            <span class='Comment_Multi_Line'>/* could get here if a collation was created by a build with ICU */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ICU is not supported in this build"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>               <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You need to rebuild PostgreSQL using --with-icu."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* not USE_ICU */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if collform-&GT;collprovide... &raquo; </span> 
 
        <a href="pg_locale.c.html#LN1285"><span class='Ref_To_Local'>collversion</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN49"><span class='Ref_to_EnumConst'>COLLOID</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1280"><span class='Ref_To_Local'>tp</span></a><span class='Delimiter'>, </span><a href="../../../include/catalog/pg_collation.h.html#LN65"><span class='Ref_to_Const'>Anum_pg_collation_collversion</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="pg_locale.c.html#LN1286"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1286"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1378"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>actual_versionstr</span><span class='Delimiter'>; 
</span><a name="LN1379"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>collversionstr</span><span class='Delimiter'>; 
</span> 
            <a href="pg_locale.c.html#LN1378"><span class='Ref_To_Local'>actual_versionstr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/pg_locale.h.html#LN91"><span class='Ref_to_Proto'>get_collation_actual_version</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collprovider<span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1282"><span class='Ref_To_Local'>collcollate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1378"><span class='Ref_To_Local'>actual_versionstr</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * This could happen when specifying a version in CREATE 
                 * COLLATION for a libc locale, or manually creating a mess in 
                 * the catalogs. 
                 */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"collation \"%s\" has no actual version, but a version was specified"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collname<span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pg_locale.c.html#LN1379"><span class='Ref_To_Local'>collversionstr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN91"><span class='Ref_to_Macro'>TextDatumGetCString</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1285"><span class='Ref_To_Local'>collversion</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1378"><span class='Ref_To_Local'>actual_versionstr</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1379"><span class='Ref_To_Local'>collversionstr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"collation \"%s\" has version mismatch"</span><span class='Delimiter'>, 
</span>                                <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collname<span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The collation in the database was created using version %s, "</span> 
                             <span class='String'>"but the operating system provides version %s."</span><span class='Delimiter'>, 
</span>                                   <a href="pg_locale.c.html#LN1379"><span class='Ref_To_Local'>collversionstr</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1378"><span class='Ref_To_Local'>actual_versionstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Rebuild all objects affected by this collation and run "</span> 
                                 <span class='String'>"ALTER COLLATION %s REFRESH VERSION, "</span> 
                       <span class='String'>"or build PostgreSQL with the right library version."</span><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/builtins.h.html#LN78"><span class='Ref_to_Proto'>quote_qualified_identifier</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collnamespace<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                             <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1281"><span class='Ref_To_Local'>collform</span></a><span class='Operator'>-&GT;</span>collname<span class='Parentheses'>)))))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !isnull &raquo; </span> 
 
        <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1280"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1266"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN124"><span class='Ref_to_Member'>locale</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN1284"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if cache_entry-&GT;locale==... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1266"><span class='Ref_To_Local'>cache_entry</span></a><span class='Operator'>-&GT;</span><a href="pg_locale.c.html#LN124"><span class='Ref_to_Member'>locale</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_newlocale_from_collation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get provider-specific collation version string for the given collation from 
 * the operating system/library. 
 * 
 * A particular provider must always either return a non-NULL string or return 
 * NULL (if it doesn't support versions).  It must not return NULL for some 
 * collcollate and not NULL for others. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1426"></a><span class='Declare_Function'>get_collation_actual_version</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Declare_Parameter'>collprovider</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>collcollate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1428"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>collversion</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> USE_ICU 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1426"><span class='Ref_to_Parameter'>collprovider</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN84"><span class='Ref_to_Const'>COLLPROVIDER_ICU</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1433"></a>        UCollator  <span class='Operator'>*</span><span class='Declare_Local'>collator</span><span class='Delimiter'>; 
</span><a name="LN1434"></a>        UErrorCode  <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1435"></a>        UVersionInfo <span class='Declare_Local'>versioninfo</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span>U_MAX_VERSION_STRING_LENGTH<span class='Delimiter'>]; 
</span> 
        <a href="pg_locale.c.html#LN1434"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span>U_ZERO_ERROR<span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1433"><span class='Ref_To_Local'>collator</span></a> <span class='Operator'>= </span>ucol_open<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1426"><span class='Ref_to_Parameter'>collcollate</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1434"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>U_FAILURE<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1434"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open collator for locale \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="pg_locale.c.html#LN1426"><span class='Ref_to_Parameter'>collcollate</span></a><span class='Delimiter'>, </span>u_errorName<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1434"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>        ucol_getVersion<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1433"><span class='Ref_To_Local'>collator</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1435"><span class='Ref_To_Local'>versioninfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        ucol_close<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1433"><span class='Ref_To_Local'>collator</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        u_versionToString<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1435"><span class='Ref_To_Local'>versioninfo</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1436"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1428"><span class='Ref_To_Local'>collversion</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1436"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <a href="pg_locale.c.html#LN1428"><span class='Ref_To_Local'>collversion</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1428"><span class='Ref_To_Local'>collversion</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_collation_actual_version &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> USE_ICU 
<span class='Comment_Multi_Line'>/* 
 * Converter object for converting between ICU's UChar strings and C strings 
 * in database encoding.  Since the database encoding doesn't change, we only 
 * need one of these per session. 
 */ 
</span><a name="LN1464"></a><span class='Keyword'>static </span>UConverter <span class='Operator'>*</span><span class='Declare_Var'>icu_converter</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1467"></a><span class='Declare_Function'>init_icu_converter</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1469"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>icu_encoding_name</span><span class='Delimiter'>; 
</span><a name="LN1470"></a>    UErrorCode  <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1471"></a>    UConverter <span class='Operator'>*</span><span class='Declare_Local'>conv</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1464"><span class='Ref_to_Global_Var'>icu_converter</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1469"><span class='Ref_To_Local'>icu_encoding_name</span></a> <span class='Operator'>= </span><a href="../../../include/mb/pg_wchar.h.html#LN338"><span class='Ref_to_Proto'>get_encoding_name_for_icu</span></a><span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1470"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span>U_ZERO_ERROR<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN1471"><span class='Ref_To_Local'>conv</span></a> <span class='Operator'>= </span>ucnv_open<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1469"><span class='Ref_To_Local'>icu_encoding_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1470"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>U_FAILURE<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1470"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>              <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open ICU converter for encoding \"%s\": %s"</span><span class='Delimiter'>, 
</span>                      <a href="pg_locale.c.html#LN1469"><span class='Ref_To_Local'>icu_encoding_name</span></a><span class='Delimiter'>, </span>u_errorName<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1470"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1464"><span class='Ref_to_Global_Var'>icu_converter</span></a> <span class='Operator'>= </span><a href="pg_locale.c.html#LN1471"><span class='Ref_To_Local'>conv</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end init_icu_converter &raquo; </span> 
 
<a href="../../../port/crypt.c.html#LN107"><span class='Ref_to_Typedef'>int32_t</span></a> 
<a name="LN1489"></a><span class='Declare_Function'>icu_to_uchar</span><span class='Parentheses'>(</span>UChar <span class='Operator'>**</span><span class='Declare_Parameter'>buff_uchar</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buff</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1491"></a>    UErrorCode  <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1492"></a>    <a href="../../../port/crypt.c.html#LN107"><span class='Ref_to_Typedef'>int32_t</span></a>     <span class='Declare_Local'>len_uchar</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1466"><span class='Ref_to_Func'>init_icu_converter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1492"><span class='Ref_To_Local'>len_uchar</span></a> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* max length per docs */ 
</span>    <span class='Operator'>*</span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>buff_uchar</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1492"><span class='Ref_To_Local'>len_uchar</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Operator'>**</span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>buff_uchar</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN1491"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span>U_ZERO_ERROR<span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN1492"><span class='Ref_To_Local'>len_uchar</span></a> <span class='Operator'>= </span>ucnv_toUChars<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1464"><span class='Ref_to_Global_Var'>icu_converter</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>buff_uchar</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1492"><span class='Ref_To_Local'>len_uchar</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>buff</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1489"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1491"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>U_FAILURE<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1491"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ucnv_toUChars failed: %s"</span><span class='Delimiter'>, </span>u_errorName<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1491"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1492"><span class='Ref_To_Local'>len_uchar</span></a><span class='Delimiter'>; 
} 
</span> 
<a href="../../../port/crypt.c.html#LN107"><span class='Ref_to_Typedef'>int32_t</span></a> 
<a name="LN1507"></a><span class='Declare_Function'>icu_from_uchar</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>result</span><span class='Delimiter'>, </span>UChar <span class='Operator'>*</span><span class='Declare_Parameter'>buff_uchar</span><span class='Delimiter'>, </span><a href="../../../port/crypt.c.html#LN107"><span class='Ref_to_Typedef'>int32_t</span></a> <span class='Declare_Parameter'>len_uchar</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1509"></a>    UErrorCode  <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1510"></a>    <a href="../../../port/crypt.c.html#LN107"><span class='Ref_to_Typedef'>int32_t</span></a>     <span class='Declare_Local'>len_result</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1466"><span class='Ref_to_Func'>init_icu_converter</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_locale.c.html#LN1510"><span class='Ref_To_Local'>len_result</span></a> <span class='Operator'>= </span>UCNV_GET_MAX_BYTES_FOR_STRING<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1507"><span class='Ref_to_Parameter'>len_uchar</span></a><span class='Delimiter'>, </span>ucnv_getMaxCharSize<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1464"><span class='Ref_to_Global_Var'>icu_converter</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="pg_locale.c.html#LN1507"><span class='Ref_to_Parameter'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1510"><span class='Ref_To_Local'>len_result</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_locale.c.html#LN1509"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>= </span>U_ZERO_ERROR<span class='Delimiter'>; 
</span>    ucnv_fromUChars<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1464"><span class='Ref_to_Global_Var'>icu_converter</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="pg_locale.c.html#LN1507"><span class='Ref_to_Parameter'>result</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1510"><span class='Ref_To_Local'>len_result</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1507"><span class='Ref_to_Parameter'>buff_uchar</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1507"><span class='Ref_to_Parameter'>len_uchar</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_locale.c.html#LN1509"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>U_FAILURE<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1509"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"ucnv_fromUChars failed: %s"</span><span class='Delimiter'>, </span>u_errorName<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1509"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1510"><span class='Ref_To_Local'>len_result</span></a><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * These functions convert from/to libc's wchar_t, *not* pg_wchar_t. 
 * Therefore we keep them here rather than with the mbutils code. 
 */ 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN1113"><span class='Ref_to_Const'>USE_WIDE_UPPER_LOWER</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * wchar2char --- convert wide characters to multibyte format 
 * 
 * This has the same API as the standard wcstombs_l() function; in particular, 
 * tolen is the maximum number of bytes to store at *to, and *from must be 
 * zero-terminated.  The output will be zero-terminated iff there is room. 
 */ 
</span>size_t 
<a name="LN1540"></a><span class='Declare_Function'>wchar2char</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>to</span><span class='Delimiter'>, </span><span class='Keyword'>const wchar_t </span><span class='Operator'>*</span><span class='Declare_Parameter'>from</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>tolen</span><span class='Delimiter'>, </span><a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a> <span class='Declare_Parameter'>locale</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1542"></a>    size_t      <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>locale</span></a> <span class='Operator'>|| </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN70"><span class='Ref_to_Member'>provider</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN85"><span class='Ref_to_Const'>COLLPROVIDER_LIBC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * On Windows, the "Unicode" locales assume UTF16 not UTF8 encoding, and 
     * for some reason mbstowcs and wcstombs won't do this for us, so we use 
     * MultiByteToWideChar(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><a href="../../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>WideCharToMultiByte<span class='Parentheses'>(</span>CP_UTF8<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a><span class='Delimiter'>, 
</span>                                     <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* A zero return is failure */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT;= </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Microsoft counts the zero terminator in the result */ 
</span>            <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>locale</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Use wcstombs directly for the default locale */ 
</span>        <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>wcstombs<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LOCALE_T 
<span class='Directive'>#ifdef</span> HAVE_WCSTOMBS_L 
        <span class='Comment_Multi_Line'>/* Use wcstombs_l for nondefault locales */ 
</span>        <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32.h.html#LN348"><span class='Ref_to_Const'>wcstombs_l</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>lt<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_WCSTOMBS_L */ 
</span>        <span class='Comment_Multi_Line'>/* We have to temporarily set the locale as current ... ugh */ 
</span><a name="LN1585"></a>        <a href="../../../include/port/win32.h.html#LN322"><span class='Ref_to_Const'>locale_t</span></a>    <span class='Declare_Local'>save_locale</span> <span class='Operator'>= </span>uselocale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>lt<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>wcstombs<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1540"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        uselocale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1585"><span class='Ref_To_Local'>save_locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_WCSTOMBS_L */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_LOCALE_T */ 
</span>        <span class='Comment_Multi_Line'>/* Can't have locale != 0 without HAVE_LOCALE_T */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wcstombs_l is not available"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_LOCALE_T */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1542"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end wchar2char &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * char2wchar --- convert multibyte characters to wide characters 
 * 
 * This has almost the API of mbstowcs_l(), except that *from need not be 
 * null-terminated; instead, the number of input bytes is specified as 
 * fromlen.  Also, we ereport() rather than returning -1 for invalid 
 * input encoding.  tolen is the maximum number of wchar_t's to store at *to. 
 * The output will be zero-terminated iff there is room. 
 */ 
</span>size_t 
<a name="LN1611"></a><span class='Declare_Function'>char2wchar</span><span class='Parentheses'>(</span><span class='Keyword'>wchar_t </span><span class='Operator'>*</span><span class='Declare_Parameter'>to</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>tolen</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>from</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>fromlen</span><span class='Delimiter'>, 
</span><a name="LN1612"></a>           <a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a> <span class='Declare_Parameter'>locale</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1614"></a>    size_t      <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_locale.c.html#LN1612"><span class='Ref_to_Parameter'>locale</span></a> <span class='Operator'>|| </span><a href="pg_locale.c.html#LN1612"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN70"><span class='Ref_to_Member'>provider</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_collation.h.html#LN85"><span class='Ref_to_Const'>COLLPROVIDER_LIBC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* See WIN32 "Unicode" comment above */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/mb/pg_wchar.h.html#LN545"><span class='Ref_to_Proto'>GetDatabaseEncoding</span></a><span class='Parentheses'>() </span><span class='Operator'>== </span><a href="../../../fe_utils/mbprint.c.html#LN42"><span class='Ref_to_Const'>PG_UTF8</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Win32 API does not work for zero-length input */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>fromlen</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>MultiByteToWideChar<span class='Parentheses'>(</span>CP_UTF8<span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>fromlen</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* A zero return is failure */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT; </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Append trailing null wchar (MultiByteToWideChar() does not) */ 
</span>            <a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>[</span><a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if GetDatabaseEncoding()... &raquo; </span> 
    <span class='Control'>else</span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* mbstowcs requires ending '\0' */ 
</span><a name="LN1647"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>str</span> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN127"><span class='Ref_to_Proto'>pnstrdup</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>fromlen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1612"><span class='Ref_to_Parameter'>locale</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../../include/utils/pg_locale.h.html#LN87"><span class='Ref_to_Typedef'>pg_locale_t</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Use mbstowcs directly for the default locale */ 
</span>            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>mbstowcs<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1647"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LOCALE_T 
<span class='Directive'>#ifdef</span> HAVE_MBSTOWCS_L 
            <span class='Comment_Multi_Line'>/* Use mbstowcs_l for nondefault locales */ 
</span>            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/port/win32.h.html#LN349"><span class='Ref_to_Const'>mbstowcs_l</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1647"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1612"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>lt<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_MBSTOWCS_L */ 
</span>            <span class='Comment_Multi_Line'>/* We have to temporarily set the locale as current ... ugh */ 
</span><a name="LN1662"></a>            <a href="../../../include/port/win32.h.html#LN322"><span class='Ref_to_Const'>locale_t</span></a>    <span class='Declare_Local'>save_locale</span> <span class='Operator'>= </span>uselocale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1612"><span class='Ref_to_Parameter'>locale</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/pg_locale.h.html#LN84"><span class='Ref_to_Member'>info</span></a><span class='Operator'>.</span>lt<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>mbstowcs<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>to</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1647"><span class='Ref_To_Local'>str</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>tolen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            uselocale<span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1662"><span class='Ref_To_Local'>save_locale</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_MBSTOWCS_L */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_LOCALE_T */ 
</span>            <span class='Comment_Multi_Line'>/* Can't have locale != 0 without HAVE_LOCALE_T */ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"mbstowcs_l is not available"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_LOCALE_T */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1647"><span class='Ref_To_Local'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Invalid multibyte character encountered.  We try to give a useful 
         * error message by letting pg_verifymbstr check the string.  But it's 
         * possible that the string is OK to us, and not OK to mbstowcs --- 
         * this suggests that the LC_CTYPE locale is different from the 
         * database encoding.  Give a generic error message if verifymbstr 
         * can't find anything wrong. 
         */ 
</span>        <a href="../../parser/scan.l.html#LN546"><span class='Ref_to_Proto'>pg_verifymbstr</span></a><span class='Parentheses'>(</span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>from</span></a><span class='Delimiter'>, </span><a href="pg_locale.c.html#LN1611"><span class='Ref_to_Parameter'>fromlen</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* might not return */ 
</span>        <span class='Comment_Multi_Line'>/* but if it does ... */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_CHARACTER_NOT_IN_REPERTOIRE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid multibyte character for locale"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"The server's LC_CTYPE locale is probably incompatible with the database encoding."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pg_locale.c.html#LN1614"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end char2wchar &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* USE_WIDE_UPPER_LOWER */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>