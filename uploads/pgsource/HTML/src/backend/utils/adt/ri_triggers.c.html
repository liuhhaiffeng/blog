<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\adt\ri_triggers.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\adt\ri_triggers.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:53 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_triggers.c 
 * 
 *  Generic trigger procedures for referential integrity constraint 
 *  checks. 
 * 
 *  Note about memory management: the private hashtables kept here live 
 *  across query and transaction boundaries, in fact they live as long as 
 *  the backend does.  This works because the hashtable structures 
 *  themselves are allocated by dynahash.c in its permanent DynaHashCxt, 
 *  and the SPI plans they point to are saved using SPI_keepplan(). 
 *  There is not currently any provision for throwing away a no-longer-needed 
 *  plan --- consider improving this someday. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * src/backend/utils/adt/ri_triggers.c 
 * 
 * ---------- 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Internal TODO: 
 * 
 *      Add MATCH PARTIAL logic. 
 * ---------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/sysattr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_collation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_constraint.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_operator.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/trigger.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/executor.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/spi.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/ilist.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_coerce.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parse_relation.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/bufmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/acl.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/fmgroids.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/lsyscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rls.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local definitions 
 * ---------- 
 */ 
</span> 
<a name="LN66"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_MAX_NUMKEYS</span>                  <a href="../../../include/pg_config_manual.h.html#LN45"><span class='Ref_to_Const'>INDEX_MAX_KEYS</span></a> 
 
<a name="LN68"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_INIT_CONSTRAINTHASHSIZE</span>      <span class='Number'>64</span> 
<a name="LN69"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_INIT_QUERYHASHSIZE</span>           <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN68"><span class='Ref_to_Const'>RI_INIT_CONSTRAINTHASHSIZE</span></a> <span class='Operator'>* </span><span class='Number'>4</span><span class='Parentheses'>) 
</span> 
<a name="LN71"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_KEYS_ALL_NULL</span>                <span class='Number'>0</span> 
<a name="LN72"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_KEYS_SOME_NULL</span>               <span class='Number'>1</span> 
<a name="LN73"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_KEYS_NONE_NULL</span>               <span class='Number'>2</span> 
 
<span class='Comment_Multi_Line'>/* RI query type codes */ 
/* these queries are executed against the PK (referenced) table: */ 
</span><a name="LN77"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_CHECK_LOOKUPPK</span>          <span class='Number'>1</span> 
<a name="LN78"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_CHECK_LOOKUPPK_FROM_PK</span>  <span class='Number'>2</span> 
<a name="LN79"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_LAST_ON_PK</span>              <a href="ri_triggers.c.html#LN78"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK_FROM_PK</span></a> 
<span class='Comment_Multi_Line'>/* these queries are executed against the FK (referencing) table: */ 
</span><a name="LN81"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_CASCADE_DEL_DODELETE</span>    <span class='Number'>3</span> 
<a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_CASCADE_UPD_DOUPDATE</span>    <span class='Number'>4</span> 
<a name="LN83"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_RESTRICT_DEL_CHECKREF</span>   <span class='Number'>5</span> 
<a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_RESTRICT_UPD_CHECKREF</span>   <span class='Number'>6</span> 
<a name="LN85"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_SETNULL_DEL_DOUPDATE</span>    <span class='Number'>7</span> 
<a name="LN86"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_SETNULL_UPD_DOUPDATE</span>    <span class='Number'>8</span> 
<a name="LN87"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_SETDEFAULT_DEL_DOUPDATE</span> <span class='Number'>9</span> 
<a name="LN88"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_PLAN_SETDEFAULT_UPD_DOUPDATE</span> <span class='Number'>10</span> 
 
<a name="LN90"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_QUOTED_NAME_LEN</span>  <span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Operator'>*</span><span class='Number'>2</span><span class='Operator'>+</span><span class='Number'>3</span><span class='Parentheses'>) 
</span><a name="LN91"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_QUOTED_REL_NAME_LEN</span>  <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Operator'>*</span><span class='Number'>2</span><span class='Parentheses'>) 
</span> 
<a name="LN93"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RIAttName</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>attnum</span><span class='Parentheses'>)</span>  <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="../../../include/parser/parse_relation.h.html#LN126"><span class='Ref_to_Proto'>attnumAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN93"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN93"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>))</span> 
<a name="LN94"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RIAttType</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>attnum</span><span class='Parentheses'>)</span>  <a href="../../../include/parser/parse_relation.h.html#LN127"><span class='Ref_to_Proto'>attnumTypeId</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>) 
</span><a name="LN95"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>RIAttCollation</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>attnum</span><span class='Parentheses'>) </span><a href="../../../include/parser/parse_relation.h.html#LN128"><span class='Ref_to_Proto'>attnumCollationId</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN95"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN95"><span class='Ref_to_Parameter'>attnum</span></a><span class='Parentheses'>) 
</span> 
<a name="LN97"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_TRIGTYPE_INSERT</span> <span class='Number'>1</span> 
<a name="LN98"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_TRIGTYPE_UPDATE</span> <span class='Number'>2</span> 
<a name="LN99"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RI_TRIGTYPE_DELETE</span> <span class='Number'>3</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_ConstraintInfo 
 * 
 *  Information extracted from an FK pg_constraint entry.  This is cached in 
 *  ri_constraint_cache. 
 * ---------- 
 */ 
</span><a name="LN109"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RI_ConstraintInfo</span> 
<span class='Delimiter'>{ 
</span><a name="LN111"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>constraint_id</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* OID of pg_constraint entry (hash key) */ 
</span><a name="LN112"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>valid</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* successfully initialized? */ 
</span><a name="LN113"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>oidHashValue</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* hash value of pg_constraint OID */ 
</span><a name="LN114"></a>    <a href="../../../include/c.h.html#LN492"><span class='Ref_to_Typedef'>NameData</span></a>    <span class='Declare_Member'>conname</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* name of the FK constraint */ 
</span><a name="LN115"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>pk_relid</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* referenced relation */ 
</span><a name="LN116"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>fk_relid</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* referencing relation */ 
</span><a name="LN117"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>confupdtype</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* foreign key's ON UPDATE action */ 
</span><a name="LN118"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>confdeltype</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* foreign key's ON DELETE action */ 
</span><a name="LN119"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>confmatchtype</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* foreign key's match type */ 
</span><a name="LN120"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nkeys</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* number of key columns */ 
</span><a name="LN121"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>pk_attnums</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>];</span>     <span class='Comment_Single_Line'>/* attnums of referenced cols */ 
</span><a name="LN122"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>fk_attnums</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>];</span>     <span class='Comment_Single_Line'>/* attnums of referencing cols */ 
</span><a name="LN123"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>pf_eq_oprs</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>];</span>     <span class='Comment_Multi_Line'>/* equality operators (PK = 
                                                 * FK) */ 
</span><a name="LN125"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>pp_eq_oprs</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>];</span>     <span class='Comment_Multi_Line'>/* equality operators (PK = 
                                                 * PK) */ 
</span><a name="LN127"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>ff_eq_oprs</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>];</span>     <span class='Comment_Multi_Line'>/* equality operators (FK = 
                                                 * FK) */ 
</span><a name="LN129"></a>    <a href="../../../include/lib/ilist.h.html#LN120"><span class='Ref_to_Struct'>dlist_node</span></a>  <span class='Declare_Member'>valid_link</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Link in list of valid entries */ 
</span><a name="LN130"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end RI_ConstraintInfo &raquo; </span> <span class='Declare_Typedef'>RI_ConstraintInfo</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_QueryKey 
 * 
 *  The key identifying a prepared SPI plan in our query hashtable 
 * ---------- 
 */ 
</span><a name="LN139"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RI_QueryKey</span> 
<span class='Delimiter'>{ 
</span><a name="LN141"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>constr_id</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* OID of pg_constraint entry */ 
</span><a name="LN142"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>constr_queryno</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* query type ID, see RI_PLAN_XXX above */ 
</span><a name="LN143"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>RI_QueryKey</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_QueryHashEntry 
 * ---------- 
 */ 
</span><a name="LN150"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RI_QueryHashEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN152"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Member'>key</span><span class='Delimiter'>; 
</span><a name="LN153"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Member'>plan</span><span class='Delimiter'>; 
</span><a name="LN154"></a>} <span class='Declare_Typedef'>RI_QueryHashEntry</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_CompareKey 
 * 
 *  The key identifying an entry showing how to compare two values 
 * ---------- 
 */ 
</span><a name="LN163"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RI_CompareKey</span> 
<span class='Delimiter'>{ 
</span><a name="LN165"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>eq_opr</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* the equality operator to apply */ 
</span><a name="LN166"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Member'>typeid</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* the data type to apply it to */ 
</span><a name="LN167"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>RI_CompareKey</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_CompareHashEntry 
 * ---------- 
 */ 
</span><a name="LN174"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>RI_CompareHashEntry</span> 
<span class='Delimiter'>{ 
</span><a name="LN176"></a>    <a href="ri_triggers.c.html#LN163"><span class='Ref_to_Struct'>RI_CompareKey</span></a> <span class='Declare_Member'>key</span><span class='Delimiter'>; 
</span><a name="LN177"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>valid</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* successfully initialized? */ 
</span><a name="LN178"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>eq_opr_finfo</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* call info for equality fn */ 
</span><a name="LN179"></a>    <a href="../../../include/fmgr.h.html#LN55"><span class='Ref_to_Struct'>FmgrInfo</span></a>    <span class='Declare_Member'>cast_func_finfo</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* in case we must coerce input */ 
</span><a name="LN180"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>RI_CompareHashEntry</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local data 
 * ---------- 
 */ 
</span><a name="LN187"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ri_constraint_cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN188"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ri_query_cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN189"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ri_compare_cache</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN190"></a><span class='Keyword'>static </span><a href="../../../include/lib/ilist.h.html#LN134"><span class='Ref_to_Struct'>dlist_head</span></a> <span class='Declare_Var'>ri_constraint_cache_valid_list</span><span class='Delimiter'>; 
</span><a name="LN191"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>ri_constraint_cache_valid_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local function prototypes 
 * ---------- 
 */ 
</span><a name="LN198"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ri_Check_Pk_Match</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, 
</span><a name="LN199"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_row</span><span class='Delimiter'>, 
</span><a name="LN200"></a>                  <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN201"></a><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>ri_restrict_del</span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigdata</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_action</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN202"></a><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Prototype'>ri_restrict_upd</span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigdata</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_action</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN203"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>quoteOneName</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN204"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>quoteRelationName</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN205"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_GenerateQual</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN206"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sep</span><span class='Delimiter'>, 
</span><a name="LN207"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>leftop</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>leftoptype</span><span class='Delimiter'>, 
</span><a name="LN208"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>opoid</span><span class='Delimiter'>, 
</span><a name="LN209"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rightop</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>rightoptype</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN210"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_add_cast_to</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN211"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_GenerateQualCollation</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN212"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>ri_NullCheck</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN213"></a>             <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN214"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_BuildQueryKey</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, 
</span><a name="LN215"></a>                 <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN216"></a>                 <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>constr_queryno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN217"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ri_KeysEqual</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN218"></a>             <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN219"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ri_AttributesEqual</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>eq_opr</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeid</span><span class='Delimiter'>, 
</span><a name="LN220"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>oldvalue</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>newvalue</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN222"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_InitHashTables</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN223"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>InvalidateConstraintCacheCallBack</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN224"></a><span class='Keyword'>static </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Prototype'>ri_FetchPreparedPlan</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN225"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_HashPreparedPlan</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Parameter'>plan</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN226"></a><span class='Keyword'>static </span><a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ri_HashCompareOp</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>eq_opr</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN228"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_CheckTrigger</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Delimiter'>, 
</span><a name="LN229"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>tgkind</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN230"></a><span class='Keyword'>static const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ri_FetchConstraintInfo</span><span class='Parentheses'>(</span><a href="../../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigger</span><span class='Delimiter'>, 
</span><a name="LN231"></a>                       <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>trig_rel</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN232"></a><span class='Keyword'>static const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>ri_LoadConstraintInfo</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>constraintOid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN233"></a><span class='Keyword'>static </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Prototype'>ri_PlanCheck</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>querystr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nargs</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>argtypes</span><span class='Delimiter'>, 
</span><a name="LN234"></a>             <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qkey</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, 
</span><a name="LN235"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>cache_plan</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN236"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ri_PerformCheck</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN237"></a>                <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qkey</span><span class='Delimiter'>, </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Parameter'>qplan</span><span class='Delimiter'>, 
</span><a name="LN238"></a>                <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, 
</span><a name="LN239"></a>                <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_tuple</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>new_tuple</span><span class='Delimiter'>, 
</span><a name="LN240"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>detectNewRows</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>expect_OK</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN241"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_ExtractValues</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN242"></a>                 <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Delimiter'>, 
</span><a name="LN243"></a>                 <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>nulls</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN244"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ri_ReportViolation</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN245"></a>                   <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, 
</span><a name="LN246"></a>                   <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>violator</span><span class='Delimiter'>, </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN247"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>queryno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>spi_err</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_check - 
 * 
 *  Check foreign key existence (combined for INSERT and UPDATE). 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN257"></a><span class='Declare_Function'>RI_FKey_check</span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigdata</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN259"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN260"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN261"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN262"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_row</span><span class='Delimiter'>; 
</span><a name="LN263"></a>    <a href="../../../include/storage/buf.h.html#LN22"><span class='Ref_to_Typedef'>Buffer</span></a>      <span class='Declare_Local'>new_row_buf</span><span class='Delimiter'>; 
</span><a name="LN264"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN265"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN266"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN262"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN38"><span class='Ref_to_Member'>tg_newtuplebuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN262"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN37"><span class='Ref_to_Member'>tg_trigtuplebuf</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We should not even consider checking the row if it is no longer valid, 
     * since it was either deleted (so the deferred check should be skipped) 
     * or updated (in which case only the latest version of the row should be 
     * checked).  Test its liveness according to SnapshotSelf.  We need pin 
     * and lock on the buffer to call HeapTupleSatisfiesVisibility.  Caller 
     * should be holding pin, but not lock. 
     */ 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN87"><span class='Ref_to_Const'>BUFFER_LOCK_SHARE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/tqual.h.html#LN44"><span class='Ref_to_Macro'>HeapTupleSatisfiesVisibility</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN262"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/tqual.h.html#LN26"><span class='Ref_to_Const'>SnapshotSelf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/bufmgr.h.html#LN214"><span class='Ref_to_Proto'>LockBuffer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN263"><span class='Ref_To_Local'>new_row_buf</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/bufmgr.h.html#LN86"><span class='Ref_to_Const'>BUFFER_LOCK_UNLOCK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables. 
     * 
     * pk_rel is opened in RowShareLock mode since that's what our eventual 
     * SELECT FOR KEY SHARE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN257"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN115"><span class='Ref_to_Member'>pk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN262"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No further check needed - an all-NULL key passes every type of 
             * foreign key constraint. 
             */ 
</span>            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * This is the only case that differs between the three kinds of 
             * MATCH. 
             */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Not allowed - MATCH FULL says either all or none of the 
                     * attributes can be NULLs 
                     */ 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FOREIGN_KEY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"insert or update on table \"%s\" violates foreign key constraint \"%s\""</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH FULL does not allow mixing of null and nonnull key values."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * MATCH SIMPLE - if ANY column is null, the key passes 
                     * the constraint. 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * MATCH PARTIAL - all non-null columns must match. (not 
                     * implemented, can be done by modifying the query below 
                     * to only include non-null columns, or by writing a 
                     * special version here) 
                     */ 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>default</span><span class='Operator'>: 
</span>                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Have a full qualified key - continue below for all three kinds 
             * of MATCH. 
             */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch ri_NullCheck(new_row,... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch or prepare a saved plan for the real check 
     */ 
</span>    <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN264"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN77"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN265"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN264"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN399"></a>        <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN400"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>pkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN401"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN402"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN403"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN404"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* ---------- 
         * The query string built is 
         *  SELECT 1 FROM ONLY &LT;pktable&GT; x WHERE pkatt1 = $1 [AND ...] 
         *         FOR KEY SHARE OF x 
         * The type id's for the $ parameters are those of the 
         * corresponding FK attributes. 
         * ---------- 
         */ 
</span>        <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN399"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN400"><span class='Ref_To_Local'>pkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN399"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT 1 FROM ONLY %s x"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN400"><span class='Ref_To_Local'>pkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN403"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN420"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN421"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN401"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN402"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN399"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN403"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN401"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN420"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                            <a href="ri_triggers.c.html#LN402"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN421"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN403"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN404"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN266"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN421"><span class='Ref_To_Local'>fk_type</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN399"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" FOR KEY SHARE OF x"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>        <a href="ri_triggers.c.html#LN265"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN399"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN404"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="ri_triggers.c.html#LN264"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Now check that foreign key exists in PK table 
     */ 
</span>    <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN259"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN264"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN265"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                    <a href="ri_triggers.c.html#LN260"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                    <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN262"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, 
</span>                    <span class='Boolean'>false</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN261"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_check &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_check_ins - 
 * 
 *  Check foreign key existence at insert event on FK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN465"></a><span class='Declare_Function'>RI_FKey_check_ins</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_check_ins"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN97"><span class='Ref_to_Const'>RI_TRIGTYPE_INSERT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with UPDATE case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN256"><span class='Ref_to_Func'>RI_FKey_check</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_check_upd - 
 * 
 *  Check foreign key existence at update event on FK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN486"></a><span class='Declare_Function'>RI_FKey_check_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_check_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with INSERT case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN256"><span class='Ref_to_Func'>RI_FKey_check</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_Check_Pk_Match 
 * 
 * Check to see if another PK row has been created that provides the same 
 * key values as the "old_row" that's been modified or deleted in our trigger 
 * event.  Returns true if a match is found in the PK table. 
 * 
 * We assume the caller checked that the old_row contains no NULL key values, 
 * since otherwise a match is impossible. 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN512"></a><span class='Declare_Function'>ri_Check_Pk_Match</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, 
</span><a name="LN513"></a>                  <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_row</span><span class='Delimiter'>, 
</span><a name="LN514"></a>                  <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN516"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN517"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN518"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN519"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Only called for non-null rows */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN513"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch or prepare a saved plan for checking PK table with values coming 
     * from a PK row 
     */ 
</span>    <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN517"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN78"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK_FROM_PK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN516"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN517"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN535"></a>        <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN536"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>pkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN537"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN538"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN539"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN540"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* ---------- 
         * The query string built is 
         *  SELECT 1 FROM ONLY &LT;pktable&GT; x WHERE pkatt1 = $1 [AND ...] 
         *         FOR KEY SHARE OF x 
         * The type id's for the $ parameters are those of the 
         * PK attributes themselves. 
         * ---------- 
         */ 
</span>        <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN535"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN536"><span class='Ref_To_Local'>pkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN535"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT 1 FROM ONLY %s x"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN536"><span class='Ref_To_Local'>pkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN539"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN556"></a>            <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN537"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN538"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN535"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN539"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN537"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN556"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN125"><span class='Ref_to_Member'>pp_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                            <a href="ri_triggers.c.html#LN538"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN556"><span class='Ref_To_Local'>pk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN539"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN540"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN518"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN556"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN535"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" FOR KEY SHARE OF x"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>        <a href="ri_triggers.c.html#LN516"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN535"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN540"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                             <span class='Operator'>&</span><a href="ri_triggers.c.html#LN517"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * We have a plan now. Run it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN519"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN514"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN517"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN516"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                             <a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN512"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, 
</span>                             <a href="ri_triggers.c.html#LN513"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                             <span class='Boolean'>true</span><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* treat like update */ 
</span>                             <a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN519"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_Check_Pk_Match &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_noaction_del - 
 * 
 *  Give an error and roll back the current transaction if the 
 *  delete has resulted in a violation of the given referential 
 *  integrity constraint. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN600"></a><span class='Declare_Function'>RI_FKey_noaction_del</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_noaction_del"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with RESTRICT case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN201"><span class='Ref_to_Proto'>ri_restrict_del</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_restrict_del - 
 * 
 *  Restrict delete from PK table to rows unreferenced by foreign key. 
 * 
 *  The SQL standard intends that this referential action occur exactly when 
 *  the delete is performed, rather than after.  This appears to be 
 *  the only difference between "NO ACTION" and "RESTRICT".  In Postgres 
 *  we still implement this as an AFTER trigger, but it's non-deferrable. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN625"></a><span class='Declare_Function'>RI_FKey_restrict_del</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_restrict_del"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with NO ACTION case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN201"><span class='Ref_to_Proto'>ri_restrict_del</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_restrict_del - 
 * 
 *  Common code for ON DELETE RESTRICT and ON DELETE NO ACTION. 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN645"></a><span class='Declare_Function'>ri_restrict_del</span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigdata</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_action</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN647"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN648"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN649"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN650"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN651"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN652"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN653"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN645"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN645"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowShareLock mode since that's what our eventual 
     * SELECT FOR KEY SHARE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN649"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN645"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN650"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN645"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 9) a) iv): 
             *      MATCH SIMPLE/FULL 
             *          ... ON DELETE RESTRICT 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN650"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If another PK row now exists providing the old key values, we 
             * should not do anything.  However, this check should only be 
             * made in the NO ACTION case; in RESTRICT cases we don't wish to 
             * allow another row to be substituted. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN645"><span class='Ref_to_Parameter'>is_no_action</span></a> <span class='Operator'>&& 
</span>                <a href="ri_triggers.c.html#LN198"><span class='Ref_to_Proto'>ri_Check_Pk_Match</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN649"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN650"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the restrict delete lookup 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN651"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN83"><span class='Ref_to_Const'>RI_PLAN_RESTRICT_DEL_CHECKREF</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN652"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN651"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN725"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN726"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN727"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN728"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN729"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN730"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  SELECT 1 FROM ONLY &LT;fktable&GT; x WHERE $1 = fkatt1 [AND ...] 
                 *         FOR KEY SHARE OF x 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN725"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN726"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN725"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT 1 FROM ONLY %s x"</span><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN726"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN729"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN747"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN649"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN748"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN727"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN728"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN725"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN729"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN728"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN747"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN727"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN748"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN729"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN730"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN653"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN747"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN725"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" FOR KEY SHARE OF x"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN652"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN725"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN730"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN651"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN649"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to check for existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN651"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN652"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN649"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN650"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN648"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL restrict delete. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN647"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_restrict_del &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_noaction_upd - 
 * 
 *  Give an error and roll back the current transaction if the 
 *  update has resulted in a violation of the given referential 
 *  integrity constraint. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN812"></a><span class='Declare_Function'>RI_FKey_noaction_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_noaction_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with RESTRICT case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN202"><span class='Ref_to_Proto'>ri_restrict_upd</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_restrict_upd - 
 * 
 *  Restrict update of PK to rows unreferenced by foreign key. 
 * 
 *  The SQL standard intends that this referential action occur exactly when 
 *  the update is performed, rather than after.  This appears to be 
 *  the only difference between "NO ACTION" and "RESTRICT".  In Postgres 
 *  we still implement this as an AFTER trigger, but it's non-deferrable. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN837"></a><span class='Declare_Function'>RI_FKey_restrict_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_restrict_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Share code with NO ACTION case. 
     */ 
</span>    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN202"><span class='Ref_to_Proto'>ri_restrict_upd</span></a><span class='Parentheses'>((</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_restrict_upd - 
 * 
 *  Common code for ON UPDATE RESTRICT and ON UPDATE NO ACTION. 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN857"></a><span class='Declare_Function'>ri_restrict_upd</span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigdata</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_no_action</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN859"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN860"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN861"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN862"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_row</span><span class='Delimiter'>; 
</span><a name="LN863"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN864"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN865"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN866"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the new and 
     * old tuple. 
     * 
     * fk_rel is opened in RowShareLock mode since that's what our eventual 
     * SELECT FOR KEY SHARE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN862"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN863"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 10) a) iv): 
             *      MATCH SIMPLE/FULL 
             *          ... ON UPDATE RESTRICT 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN863"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to check anything if old and new keys are equal 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN863"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN862"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If another PK row now exists providing the old key values, we 
             * should not do anything.  However, this check should only be 
             * made in the NO ACTION case; in RESTRICT cases we don't wish to 
             * allow another row to be substituted. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN857"><span class='Ref_to_Parameter'>is_no_action</span></a> <span class='Operator'>&& 
</span>                <a href="ri_triggers.c.html#LN198"><span class='Ref_to_Proto'>ri_Check_Pk_Match</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN863"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the restrict update lookup 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN864"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN84"><span class='Ref_to_Const'>RI_PLAN_RESTRICT_UPD_CHECKREF</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN865"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN864"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN949"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN950"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN951"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN952"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN953"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN954"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  SELECT 1 FROM ONLY &LT;fktable&GT; WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN949"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN950"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN949"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT 1 FROM ONLY %s x"</span><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN950"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN953"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN970"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN971"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN951"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN952"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN949"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN953"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN952"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN970"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN951"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN971"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN953"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN954"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN866"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN970"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN949"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>" FOR KEY SHARE OF x"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN865"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN949"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN954"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN864"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to check for existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN864"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN865"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN861"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN863"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN860"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL restrict update. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN859"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_restrict_upd &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_cascade_del - 
 * 
 *  Cascaded delete foreign key references at delete event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1033"></a><span class='Declare_Function'>RI_FKey_cascade_del</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1035"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1036"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1037"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1038"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1039"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1040"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1041"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN1042"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_cascade_del"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1035"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1035"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual DELETE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1038"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1035"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1039"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1035"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 9) a) i): 
             *      MATCH SIMPLE/FULL 
             *          ... ON DELETE CASCADE 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1039"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the cascaded delete 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1040"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN81"><span class='Ref_to_Const'>RI_PLAN_CASCADE_DEL_DODELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1041"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1040"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1106"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1107"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1108"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1109"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1110"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1111"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  DELETE FROM ONLY &LT;fktable&GT; WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1106"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1107"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1106"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"DELETE FROM ONLY %s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1107"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1110"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1126"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1038"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1127"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1108"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1109"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1106"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1110"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1109"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1126"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1108"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1127"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1110"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1111"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1042"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1126"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1041"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1106"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1111"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1040"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1038"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Build up the arguments from the key values 
             * in the deleted PK tuple and delete the referencing rows 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1040"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1041"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1038"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1039"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN56"><span class='Ref_to_Const'>SPI_OK_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1037"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL cascaded delete. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1036"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_cascade_del &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_cascade_upd - 
 * 
 *  Cascaded update foreign key references at update event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1189"></a><span class='Declare_Function'>RI_FKey_cascade_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1191"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1192"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1193"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1194"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1195"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_row</span><span class='Delimiter'>; 
</span><a name="LN1196"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1197"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1198"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN1199"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1200"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_cascade_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1191"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1191"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the new and 
     * old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual UPDATE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1194"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1191"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1195"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1191"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1196"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1191"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 10) a) i): 
             *      MATCH SIMPLE/FULL 
             *          ... ON UPDATE CASCADE 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1196"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to do anything if old and new keys are equal 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1194"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1196"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1195"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the cascaded update 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1197"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN82"><span class='Ref_to_Const'>RI_PLAN_CASCADE_UPD_DOUPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1198"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1197"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1275"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1276"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>qualbuf</span><span class='Delimiter'>; 
</span><a name="LN1277"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1278"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1279"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1280"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1281"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualsep</span><span class='Delimiter'>; 
</span><a name="LN1282"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  UPDATE ONLY &LT;fktable&GT; SET fkatt1 = $1 [, ...] 
                 *          WHERE $n = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes.  Note that we are assuming 
                 * there is an assignment cast from the PK to the FK type; 
                 * else the parser will fail. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1275"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1276"><span class='Ref_To_Local'>qualbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1277"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1275"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE ONLY %s SET"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1277"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1280"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1281"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1200"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1200"><span class='Ref_To_Local'>j</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1302"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1194"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1303"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1278"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1275"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"%s %s = $%d"</span><span class='Delimiter'>, 
</span>                                     <a href="ri_triggers.c.html#LN1280"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1278"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1279"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1200"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1276"><span class='Ref_To_Local'>qualbuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1281"><span class='Ref_To_Local'>qualsep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1279"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1302"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1278"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1303"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1280"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>","</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1281"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1282"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1199"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1302"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1282"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1200"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1302"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0,j=riinfo-&GT;nkeys;i... &raquo; </span> 
                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1275"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1276"><span class='Ref_To_Local'>qualbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1198"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1275"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1282"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1197"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1194"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to update the existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1197"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1198"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1194"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1196"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1195"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1193"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL cascade update. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1192"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_cascade_upd &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_setnull_del - 
 * 
 *  Set foreign key references to NULL values at delete event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1370"></a><span class='Declare_Function'>RI_FKey_setnull_del</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1372"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1373"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1374"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1375"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1376"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1377"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1378"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN1379"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_setnull_del"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1372"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1372"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual UPDATE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1375"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1372"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1376"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1372"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 9) a) ii): 
             *      MATCH SIMPLE/FULL 
             *          ... ON DELETE SET NULL 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1376"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the set null delete operation 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1377"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN85"><span class='Ref_to_Const'>RI_PLAN_SETNULL_DEL_DOUPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1378"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1377"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1443"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1444"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>qualbuf</span><span class='Delimiter'>; 
</span><a name="LN1445"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1446"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1447"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1448"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1449"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualsep</span><span class='Delimiter'>; 
</span><a name="LN1450"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  UPDATE ONLY &LT;fktable&GT; SET fkatt1 = NULL [, ...] 
                 *          WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1443"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1444"><span class='Ref_To_Local'>qualbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1445"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1443"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE ONLY %s SET"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1445"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1448"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1449"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1468"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1375"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1469"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1446"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1443"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"%s %s = NULL"</span><span class='Delimiter'>, 
</span>                                     <a href="ri_triggers.c.html#LN1448"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1446"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1447"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1444"><span class='Ref_To_Local'>qualbuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1449"><span class='Ref_To_Local'>qualsep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1447"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1468"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1446"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1469"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1448"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>","</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1449"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1450"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1379"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1468"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1443"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1444"><span class='Ref_To_Local'>qualbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1378"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1443"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1450"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1377"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1375"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to check for existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1377"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1378"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1375"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1376"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1374"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL set null delete. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1373"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_setnull_del &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_setnull_upd - 
 * 
 *  Set foreign key references to NULL at update event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1535"></a><span class='Declare_Function'>RI_FKey_setnull_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1537"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1538"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1539"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1540"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1541"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_row</span><span class='Delimiter'>; 
</span><a name="LN1542"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1543"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1544"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN1545"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_setnull_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1537"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1537"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual UPDATE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1540"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1537"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1541"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1537"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1542"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1537"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 10) a) ii): 
             *      MATCH SIMPLE/FULL 
             *          ... ON UPDATE SET NULL 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1542"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to do anything if old and new keys are equal 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1540"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1542"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1541"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the set null update operation 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1543"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN86"><span class='Ref_to_Const'>RI_PLAN_SETNULL_UPD_DOUPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1544"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1543"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1619"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1620"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>qualbuf</span><span class='Delimiter'>; 
</span><a name="LN1621"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1622"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1623"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1624"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1625"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualsep</span><span class='Delimiter'>; 
</span><a name="LN1626"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  UPDATE ONLY &LT;fktable&GT; SET fkatt1 = NULL [, ...] 
                 *          WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1619"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1620"><span class='Ref_To_Local'>qualbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1621"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1619"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE ONLY %s SET"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1621"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1624"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1625"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1644"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1540"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1645"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1622"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1619"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"%s %s = NULL"</span><span class='Delimiter'>, 
</span>                                     <a href="ri_triggers.c.html#LN1624"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1622"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1623"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1620"><span class='Ref_To_Local'>qualbuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1625"><span class='Ref_To_Local'>qualsep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1623"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1644"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1622"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1645"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1624"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>","</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1625"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1626"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1545"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1644"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1619"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1620"><span class='Ref_To_Local'>qualbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1544"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1619"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1626"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1543"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1540"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to update the existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1543"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1544"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1540"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1542"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1539"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL set null update. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1538"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_setnull_upd &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_setdefault_del - 
 * 
 *  Set foreign key references to defaults at delete event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1711"></a><span class='Declare_Function'>RI_FKey_setdefault_del</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1713"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1714"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1715"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1716"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1718"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1719"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_setdefault_del"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1713"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1713"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual UPDATE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1716"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1713"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1717"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1713"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 9) a) iii): 
             *      MATCH SIMPLE/FULL 
             *          ... ON DELETE SET DEFAULT 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1717"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the set default delete 
             * operation 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1718"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN87"><span class='Ref_to_Const'>RI_PLAN_SETDEFAULT_DEL_DOUPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1719"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1718"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1784"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1785"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>qualbuf</span><span class='Delimiter'>; 
</span><a name="LN1786"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1787"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1788"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1789"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1790"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualsep</span><span class='Delimiter'>; 
</span><a name="LN1791"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN1792"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  UPDATE ONLY &LT;fktable&GT; SET fkatt1 = DEFAULT [, ...] 
                 *          WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1784"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1785"><span class='Ref_To_Local'>qualbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1786"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1784"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE ONLY %s SET"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1786"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1789"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1790"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1810"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1716"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1811"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1787"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1784"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"%s %s = DEFAULT"</span><span class='Delimiter'>, 
</span>                                     <a href="ri_triggers.c.html#LN1789"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1787"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1788"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1785"><span class='Ref_To_Local'>qualbuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1790"><span class='Ref_To_Local'>qualsep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1788"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1810"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1787"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1811"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1789"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>","</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1790"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1791"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1792"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN1810"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1784"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1785"><span class='Ref_To_Local'>qualbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1719"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1784"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1791"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1718"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1716"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to update the existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1718"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1719"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1716"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1717"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1715"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we just deleted the PK row whose key was equal to the FK 
             * columns' default values, and a referencing row exists in the FK 
             * table, we would have updated that row to the same values it 
             * already had --- and RI_FKey_fk_upd_check_required would hence 
             * believe no check is necessary.  So we need to do another lookup 
             * now and in case a reference still exists, abort the operation. 
             * That is already implemented in the NO ACTION trigger, so just 
             * run it.  (This recheck is only needed in the SET DEFAULT case, 
             * since CASCADE would remove such rows, while SET NULL is certain 
             * to result in rows that satisfy the FK constraint.) 
             */ 
</span>            <a href="ri_triggers.c.html#LN599"><span class='Ref_to_Func'>RI_FKey_noaction_del</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL set default delete. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1714"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_setdefault_del &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_setdefault_upd - 
 * 
 *  Set foreign key references to defaults at update event on PK table. 
 * ---------- 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1891"></a><span class='Declare_Function'>RI_FKey_setdefault_upd</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1893"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>context<span class='Delimiter'>; 
</span><a name="LN1894"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN1895"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>fk_rel</span><span class='Delimiter'>; 
</span><a name="LN1896"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>pk_rel</span><span class='Delimiter'>; 
</span><a name="LN1897"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>new_row</span><span class='Delimiter'>; 
</span><a name="LN1898"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>old_row</span><span class='Delimiter'>; 
</span><a name="LN1899"></a>    <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Declare_Local'>qkey</span><span class='Delimiter'>; 
</span><a name="LN1900"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that this is a valid trigger call on the right time and event. 
     */ 
</span>    <a href="ri_triggers.c.html#LN228"><span class='Ref_to_Proto'>ri_CheckTrigger</span></a><span class='Parentheses'>(</span>fcinfo<span class='Delimiter'>, </span><span class='String'>"RI_FKey_setdefault_upd"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1893"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN36"><span class='Ref_to_Member'>tg_trigger</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1893"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the relation descriptors of the FK and PK tables and the old tuple. 
     * 
     * fk_rel is opened in RowExclusiveLock mode since that's what our 
     * eventual UPDATE will get on it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a> <span class='Operator'>= </span><a href="../../../include/access/heapam.h.html#LN91"><span class='Ref_to_Proto'>heap_open</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1896"><span class='Ref_To_Local'>pk_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1893"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN33"><span class='Ref_to_Member'>tg_relation</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1897"><span class='Ref_To_Local'>new_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1893"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN35"><span class='Ref_to_Member'>tg_newtuple</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN1898"><span class='Ref_To_Local'>old_row</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN1893"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN34"><span class='Ref_to_Member'>tg_trigtuple</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* ---------- 
             * SQL:2008 15.17 &LT;Execution of referential actions&GT; 
             *  General rules 10) a) iii): 
             *      MATCH SIMPLE/FULL 
             *          ... ON UPDATE SET DEFAULT 
             * ---------- 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1898"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * No check needed - there cannot be any reference to old 
                     * key if it contains a NULL 
                     */ 
</span>                    <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span> 
                    <span class='Comment_Multi_Line'>/* 
                     * Have a full qualified key - continue below 
                     */ 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No need to do anything if old and new keys are equal 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1896"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1898"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1897"><span class='Ref_To_Local'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fetch or prepare a saved plan for the set default update 
             * operation 
             */ 
</span>            <a href="ri_triggers.c.html#LN214"><span class='Ref_to_Proto'>ri_BuildQueryKey</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1899"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN88"><span class='Ref_to_Const'>RI_PLAN_SETDEFAULT_UPD_DOUPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN1900"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN224"><span class='Ref_to_Proto'>ri_FetchPreparedPlan</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1899"><span class='Ref_To_Local'>qkey</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span><a name="LN1975"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN1976"></a>                <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>qualbuf</span><span class='Delimiter'>; 
</span><a name="LN1977"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1978"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>attname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN1979"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>paramname</span><span class='Delimiter'>[</span><span class='Number'>16</span><span class='Delimiter'>]; 
</span><a name="LN1980"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>querysep</span><span class='Delimiter'>; 
</span><a name="LN1981"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>qualsep</span><span class='Delimiter'>; 
</span><a name="LN1982"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>queryoids</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Delimiter'>]; 
</span><a name="LN1983"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* ---------- 
                 * The query string built is 
                 *  UPDATE ONLY &LT;fktable&GT; SET fkatt1 = DEFAULT [, ...] 
                 *          WHERE $1 = fkatt1 [AND ...] 
                 * The type id's for the $ parameters are those of the 
                 * corresponding PK attributes. 
                 * ---------- 
                 */ 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1975"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1976"><span class='Ref_To_Local'>qualbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1977"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1975"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"UPDATE ONLY %s SET"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1977"><span class='Ref_To_Local'>fkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1980"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>                <a href="ri_triggers.c.html#LN1981"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"WHERE"</span><span class='Delimiter'>; 
</span>                <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN2001"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1896"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2002"></a>                    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1978"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1975"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                                     <span class='String'>"%s %s = DEFAULT"</span><span class='Delimiter'>, 
</span>                                     <a href="ri_triggers.c.html#LN1980"><span class='Ref_To_Local'>querysep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1978"><span class='Ref_To_Local'>attname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1979"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><span class='String'>"$%d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1976"><span class='Ref_To_Local'>qualbuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1981"><span class='Ref_To_Local'>qualsep</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1979"><span class='Ref_To_Local'>paramname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2001"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                                    <a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                                    <a href="ri_triggers.c.html#LN1978"><span class='Ref_To_Local'>attname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2002"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1980"><span class='Ref_To_Local'>querysep</span></a> <span class='Operator'>= </span><span class='String'>","</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1981"><span class='Ref_To_Local'>qualsep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>                    <a href="ri_triggers.c.html#LN1982"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN1983"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN2001"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1975"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1976"><span class='Ref_To_Local'>qualbuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare and save the plan */ 
</span>                <a href="ri_triggers.c.html#LN1900"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN233"><span class='Ref_to_Proto'>ri_PlanCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1975"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1982"><span class='Ref_To_Local'>queryoids</span></a><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="ri_triggers.c.html#LN1899"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1896"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (qplan=ri_FetchPrepar... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * We have a plan now. Run it to update the existing references. 
             */ 
</span>            <a href="ri_triggers.c.html#LN236"><span class='Ref_to_Proto'>ri_PerformCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN1899"><span class='Ref_To_Local'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1900"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN1896"><span class='Ref_To_Local'>pk_rel</span></a><span class='Delimiter'>, 
</span>                            <a href="ri_triggers.c.html#LN1898"><span class='Ref_To_Local'>old_row</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                            <span class='Boolean'>true</span><span class='Delimiter'>,</span>       <span class='Comment_Single_Line'>/* must detect new rows */ 
</span>                            <a href="../../../include/executor/spi.h.html#LN57"><span class='Ref_to_Const'>SPI_OK_UPDATE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/access/heapam.h.html#LN96"><span class='Ref_to_Macro'>heap_close</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN1895"><span class='Ref_To_Local'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we just updated the PK row whose key was equal to the FK 
             * columns' default values, and a referencing row exists in the FK 
             * table, we would have updated that row to the same values it 
             * already had --- and RI_FKey_fk_upd_check_required would hence 
             * believe no check is necessary.  So we need to do another lookup 
             * now and in case a reference still exists, abort the operation. 
             * That is already implemented in the NO ACTION trigger, so just 
             * run it.  (This recheck is only needed in the SET DEFAULT case, 
             * since CASCADE must change the FK key values, while SET NULL is 
             * certain to result in rows that satisfy the FK constraint.) 
             */ 
</span>            <a href="ri_triggers.c.html#LN811"><span class='Ref_to_Func'>RI_FKey_noaction_upd</span></a><span class='Parentheses'>(</span>fcinfo<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Handle MATCH PARTIAL set default update. 
             */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN1894"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_setdefault_upd &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_pk_upd_check_required - 
 * 
 *  Check if we really need to fire the RI trigger for an update to a PK 
 *  relation.  This is called by the AFTER trigger queue manager to see if 
 *  it can skip queuing an instance of an RI trigger.  Returns TRUE if the 
 *  trigger must be fired, FALSE if we can prove the constraint will still 
 *  be satisfied. 
 * ---------- 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN2086"></a><span class='Declare_Function'>RI_FKey_pk_upd_check_required</span><span class='Parentheses'>(</span><a href="../../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigger</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, 
</span><a name="LN2087"></a>                              <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_row</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>new_row</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2089"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2089"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2086"><span class='Ref_to_Parameter'>trigger</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2086"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2089"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If any old key value is NULL, the row could not have been 
             * referenced by an FK row, so no check is needed. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2087"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2089"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If all old and new key values are equal, no check is needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2086"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2087"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2087"><span class='Ref_to_Parameter'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2089"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Else we need to fire the trigger. */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Handle MATCH PARTIAL check. */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN2089"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_pk_upd_check_required &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_FKey_fk_upd_check_required - 
 * 
 *  Check if we really need to fire the RI trigger for an update to an FK 
 *  relation.  This is called by the AFTER trigger queue manager to see if 
 *  it can skip queuing an instance of an RI trigger.  Returns TRUE if the 
 *  trigger must be fired, FALSE if we can prove the constraint will still 
 *  be satisfied. 
 * ---------- 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN2143"></a><span class='Declare_Function'>RI_FKey_fk_upd_check_required</span><span class='Parentheses'>(</span><a href="../../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigger</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, 
</span><a name="LN2144"></a>                              <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_row</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>new_row</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2146"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get arguments. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2143"><span class='Ref_to_Parameter'>trigger</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2143"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If any new key value is NULL, the row must satisfy the 
             * constraint, so no check is needed. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the original row was inserted by our own transaction, we 
             * must fire the trigger whether or not the keys are equal.  This 
             * is because our UPDATE will invalidate the INSERT so that the 
             * INSERT RI trigger will not do anything; so we had better do the 
             * UPDATE check.  (We could skip this if we knew the INSERT 
             * trigger already fired, but there is no easy way to know that.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>old_row</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If all old and new key values are equal, no check is needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2143"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Else we need to fire the trigger. */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If all new key values are NULL, the row must satisfy the 
             * constraint, so no check is needed.  On the other hand, if only 
             * some of them are NULL, the row must fail the constraint.  We 
             * must not throw error here, because the row might get 
             * invalidated before the constraint is to be checked, but we 
             * should queue the event to apply the check later. 
             */ 
</span>            <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Operator'>: 
</span>                    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Operator'>: 
</span>                    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>case</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Operator'>: 
</span>                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* continue with the check */ 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the original row was inserted by our own transaction, we 
             * must fire the trigger whether or not the keys are equal.  This 
             * is because our UPDATE will invalidate the INSERT so that the 
             * INSERT RI trigger will not do anything; so we had better do the 
             * UPDATE check.  (We could skip this if we knew the INSERT 
             * trigger already fired, but there is no easy way to know that.) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN345"><span class='Ref_to_Proto'>TransactionIdIsCurrentTransactionId</span></a><span class='Parentheses'>(</span><a href="../../../include/access/htup_details.h.html#LN306"><span class='Ref_to_Macro'>HeapTupleHeaderGetXmin</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>old_row</span></a><span class='Operator'>-&GT;</span><a href="../../../include/access/htup.h.html#LN66"><span class='Ref_to_Member'>t_data</span></a><span class='Parentheses'>)))</span> 
                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* If all old and new key values are equal, no check is needed */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN217"><span class='Ref_to_Proto'>ri_KeysEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2143"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>old_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2144"><span class='Ref_to_Parameter'>new_row</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Else we need to fire the trigger. */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Handle MATCH PARTIAL check. */ 
</span>        <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>default</span><span class='Operator'>: 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN2146"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch riinfo-&GT;confmatchtype &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Never reached */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_fk_upd_check_required &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * RI_Initial_Check - 
 * 
 *  Check an entire table for non-matching values using a single query. 
 *  This is not a trigger procedure, but is called during ALTER TABLE 
 *  ADD FOREIGN KEY to validate the initial table contents. 
 * 
 *  We expect that the caller has made provision to prevent any problems 
 *  caused by concurrent actions. This could be either by locking rel and 
 *  pkrel at ShareRowExclusiveLock or higher, or by otherwise ensuring 
 *  that triggers implementing the checks are already active. 
 *  Hence, we do not need to lock individual rows for the check. 
 * 
 *  If the check fails because the current user doesn't have permissions 
 *  to read both tables, return false to let our caller know that they will 
 *  need to do something else to check the constraint. 
 * ---------- 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN2256"></a><span class='Declare_Function'>RI_Initial_Check</span><span class='Parentheses'>(</span><a href="../../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigger</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2258"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN2259"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>querybuf</span><span class='Delimiter'>; 
</span><a name="LN2260"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN2261"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fkrelname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN91"><span class='Ref_to_Const'>MAX_QUOTED_REL_NAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN2262"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pkattname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN2263"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>fkattname</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Delimiter'>]; 
</span><a name="LN2264"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pkrte</span><span class='Delimiter'>; 
</span><a name="LN2265"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>fkrte</span><span class='Delimiter'>; 
</span><a name="LN2266"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>sep</span><span class='Delimiter'>; 
</span><a name="LN2267"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN2268"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_nestlevel</span><span class='Delimiter'>; 
</span><a name="LN2269"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>workmembuf</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN2270"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>spi_result</span><span class='Delimiter'>; 
</span><a name="LN2271"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Fetch constraint info. */ 
</span>    <a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN230"><span class='Ref_to_Proto'>ri_FetchConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>trigger</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check to make sure current user has enough permissions to do the test 
     * query.  (If not, caller can fall back to the trigger method, which 
     * works because it changes user IDs on the fly.) 
     * 
     * XXX are there any other show-stopper conditions to check? 
     */ 
</span>    <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN556"><span class='Ref_to_Macro'>makeNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN948"><span class='Ref_to_Member'>relkind</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relkind<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1027"><span class='Ref_to_Member'>requiredPerms</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2297"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>attno</span><span class='Delimiter'>; 
</span> 
        <a href="ri_triggers.c.html#LN2297"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><a href="../../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2297"><span class='Ref_To_Local'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ri_triggers.c.html#LN2297"><span class='Ref_To_Local'>attno</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><a href="../../../include/access/sysattr.h.html#LN27"><span class='Ref_to_Const'>FirstLowInvalidHeapAttributeNumber</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/bitmapset.h.html#LN89"><span class='Ref_to_Proto'>bms_add_member</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1029"><span class='Ref_to_Member'>selectedCols</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2297"><span class='Ref_To_Local'>attno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/executor/executor.h.html#LN178"><span class='Ref_to_Proto'>ExecCheckRTPerms</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN139"><span class='Ref_to_Macro'>list_make2</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also punt if RLS is enabled on either table unless this role has the 
     * bypassrls right or is the table owner of the table(s) involved which 
     * have RLS enabled. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN331"><span class='Ref_to_Proto'>has_bypassrls_privilege</span></a><span class='Parentheses'>(</span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>())</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>((</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relrowsecurity <span class='Operator'>&& 
</span>          <span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2264"><span class='Ref_To_Local'>pkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))</span> <span class='Operator'>|| 
</span>         <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relrowsecurity <span class='Operator'>&& 
</span>          <span class='Operator'>!</span><a href="../../../include/utils/acl.h.html#LN308"><span class='Ref_to_Proto'>pg_class_ownercheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2265"><span class='Ref_To_Local'>fkrte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()))))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * The query string built is: 
     *  SELECT fk.keycols FROM ONLY relname fk 
     *   LEFT OUTER JOIN ONLY pkrelname pk 
     *   ON (pk.pkkeycol1=fk.keycol1 [AND ...]) 
     *   WHERE pk.pkkeycol1 IS NULL AND 
     * For MATCH SIMPLE: 
     *   (fk.keycol1 IS NOT NULL [AND ...]) 
     * For MATCH FULL: 
     *   (fk.keycol1 IS NOT NULL [OR ...]) 
     * 
     * We attach COLLATE clauses to the operators when comparing columns 
     * that have different collations. 
     *---------- 
     */ 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"SELECT "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Delimiter'>, 
</span>                     <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>"%sfk.%s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>", "</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2260"><span class='Ref_To_Local'>pkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN204"><span class='Ref_to_Proto'>quoteRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2261"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>" FROM ONLY %s fk LEFT OUTER JOIN ONLY %s pk ON"</span><span class='Delimiter'>, 
</span>                     <a href="ri_triggers.c.html#LN2261"><span class='Ref_To_Local'>fkrelname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2260"><span class='Ref_To_Local'>pkrelname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2262"><span class='Ref_To_Local'>pkattname</span></a><span class='Delimiter'>, </span><span class='String'>"pk."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Delimiter'>, </span><span class='String'>"fk."</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>"("</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2358"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2359"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_type</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2360"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>pk_coll</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN95"><span class='Ref_to_Macro'>RIAttCollation</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN2361"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>fk_coll</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN95"><span class='Ref_to_Macro'>RIAttCollation</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2262"><span class='Ref_To_Local'>pkattname</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>                     <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a> <span class='Operator'>+ </span><span class='Number'>3</span><span class='Delimiter'>, 
</span>                     <a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN205"><span class='Ref_to_Proto'>ri_GenerateQual</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a><span class='Delimiter'>, 
</span>                        <a href="ri_triggers.c.html#LN2262"><span class='Ref_To_Local'>pkattname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2358"><span class='Ref_To_Local'>pk_type</span></a><span class='Delimiter'>, 
</span>                        <a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], 
</span>                        <a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2359"><span class='Ref_To_Local'>fk_type</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2360"><span class='Ref_To_Local'>pk_coll</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2361"><span class='Ref_To_Local'>fk_coll</span></a><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN211"><span class='Ref_to_Proto'>ri_GenerateQualCollation</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2360"><span class='Ref_To_Local'>pk_coll</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>"AND"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's sufficient to test any one pk attribute for null to detect a join 
     * failure. 
     */ 
</span>    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2262"><span class='Ref_To_Local'>pkattname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>") WHERE pk.%s IS NULL AND ("</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2262"><span class='Ref_To_Local'>pkattname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN93"><span class='Ref_to_Macro'>RIAttName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, 
</span>                         <span class='String'>"%sfk.%s IS NOT NULL"</span><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2263"><span class='Ref_To_Local'>fkattname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2048"><span class='Ref_to_Const'>FKCONSTR_MATCH_SIMPLE</span></a><span class='Operator'>: 
</span>                <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>" AND "</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a><span class='Operator'>: 
</span>                <a href="ri_triggers.c.html#LN2266"><span class='Ref_To_Local'>sep</span></a> <span class='Operator'>= </span><span class='String'>" OR "</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN2047"><span class='Ref_to_Const'>FKCONSTR_MATCH_PARTIAL</span></a><span class='Operator'>: 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH PARTIAL not yet implemented"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized confmatchtype: %d"</span><span class='Delimiter'>, 
</span>                     <a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;riinfo-&GT;nkeys;i... &raquo; </span> 
    <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Delimiter'>, </span><span class='String'>')'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Temporarily increase work_mem so that the check query can be executed 
     * more efficiently.  It seems okay to do this because the query is simple 
     * enough to not use a multiple of work_mem, and one typically would not 
     * have many large foreign-key validations happening concurrently.  So 
     * this seems to meet the criteria for being considered a "maintenance" 
     * operation, and accordingly we use maintenance_work_mem. 
     * 
     * We use the equivalent of a function SET option to allow the setting to 
     * persist for exactly the duration of the check query.  guc.c also takes 
     * care of undoing the setting on error. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2268"><span class='Ref_To_Local'>save_nestlevel</span></a> <span class='Operator'>= </span><a href="../../../include/utils/guc.h.html#LN354"><span class='Ref_to_Proto'>NewGUCNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2269"><span class='Ref_To_Local'>workmembuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2269"><span class='Ref_To_Local'>workmembuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><a href="../init/globals.c.html#LN113"><span class='Ref_to_Global_Var'>maintenance_work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/utils/guc.h.html#LN361"><span class='Ref_to_Proto'>set_config_option</span></a><span class='Parentheses'>(</span><span class='String'>"work_mem"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2269"><span class='Ref_To_Local'>workmembuf</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/guc.h.html#LN75"><span class='Ref_to_EnumConst'>PGC_USERSET</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN119"><span class='Ref_to_EnumConst'>PGC_S_SESSION</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/guc.h.html#LN195"><span class='Ref_to_EnumConst'>GUC_ACTION_SAVE</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN79"><span class='Ref_to_Proto'>SPI_connect</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN49"><span class='Ref_to_Const'>SPI_OK_CONNECT</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_connect failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate the plan.  We don't need to cache it, and there are no 
     * arguments to the plan. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2271"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN99"><span class='Ref_to_Proto'>SPI_prepare</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2271"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_prepare returned %d for %s"</span><span class='Delimiter'>, 
</span>             <a href="../../executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2259"><span class='Ref_To_Local'>querybuf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Run the plan.  For safety we force a current snapshot to be used. (In 
     * transaction-snapshot mode, this arguably violates transaction isolation 
     * rules, but we really haven't got much choice.) We don't need to 
     * register the snapshot, because SPI_execute_snapshot will see to it. We 
     * need at most one tuple returned, so pass limit = 1. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2270"><span class='Ref_To_Local'>spi_result</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN90"><span class='Ref_to_Proto'>SPI_execute_snapshot</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2271"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>, 
</span>                                      <span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/snapmgr.h.html#LN64"><span class='Ref_to_Proto'>GetLatestSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                      <a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>, 
</span>                                      <span class='Boolean'>true</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check result */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2270"><span class='Ref_To_Local'>spi_result</span></a> <span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_execute_snapshot returned %d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2270"><span class='Ref_To_Local'>spi_result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Did we find a tuple violating the constraint? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2463"></a>        <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span> <span class='Operator'>= </span><a href="../../executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/spi.h.html#LN27"><span class='Ref_to_Member'>vals</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span><a name="LN2464"></a>        <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span> <span class='Operator'>= </span><a href="../../executor/spi.c.html#LN40"><span class='Ref_to_Global_Var'>SPI_tuptable</span></a><span class='Operator'>-&GT;</span><a href="../../../include/executor/spi.h.html#LN26"><span class='Ref_to_Member'>tupdesc</span></a><span class='Delimiter'>; 
</span><a name="LN2465"></a>        <a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Declare_Local'>fake_riinfo</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The columns to look at in the result tuple are 1..N, not whatever 
         * they are in the fk_rel.  Hack up riinfo so that the subroutines 
         * called here will behave properly. 
         * 
         * In addition to this, we have to pass the correct tupdesc to 
         * ri_ReportViolation, overriding its normal habit of using the pk_rel 
         * or fk_rel's tupdesc. 
         */ 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2258"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN2267"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If it's MATCH FULL, and there are any nulls in the FK keys, 
         * complain about that rather than the lack of a match.  MATCH FULL 
         * disallows partially-null FK rows. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/parsenodes.h.html#LN2046"><span class='Ref_to_Const'>FKCONSTR_MATCH_FULL</span></a> <span class='Operator'>&& 
</span>            <a href="ri_triggers.c.html#LN212"><span class='Ref_to_Proto'>ri_NullCheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2463"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FOREIGN_KEY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"insert or update on table \"%s\" violates foreign key constraint \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"MATCH FULL does not allow mixing of null and nonnull key values."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, 
</span>                                        <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We tell ri_ReportViolation we were doing the RI_PLAN_CHECK_LOOKUPPK 
         * query, which isn't true, but will cause it to use 
         * fake_riinfo.fk_attnums as we need. 
         */ 
</span>        <a href="ri_triggers.c.html#LN244"><span class='Ref_to_Proto'>ri_ReportViolation</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2465"><span class='Ref_To_Local'>fake_riinfo</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2256"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN2463"><span class='Ref_To_Local'>tuple</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2464"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN77"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if SPI_processed&GT;0 &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/executor/spi.h.html#LN80"><span class='Ref_to_Proto'>SPI_finish</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/executor/spi.h.html#LN50"><span class='Ref_to_Const'>SPI_OK_FINISH</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_finish failed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Restore work_mem. 
     */ 
</span>    <a href="../../../include/utils/guc.h.html#LN355"><span class='Ref_to_Proto'>AtEOXact_GUC</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2268"><span class='Ref_To_Local'>save_nestlevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_Initial_Check &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * Local functions below 
 * ---------- 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * quoteOneName --- safely quote a single SQL name 
 * 
 * buffer must be MAX_QUOTED_NAME_LEN long (includes room for \0) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2531"></a><span class='Declare_Function'>quoteOneName</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Rather than trying to be smart, just always quote it. */ 
</span>    <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>buffer</span></a><span class='Operator'>++ = </span><span class='String'>'"'</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>== </span><span class='String'>'"'</span><span class='Parentheses'>) 
</span>            <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>buffer</span></a><span class='Operator'>++ = </span><span class='String'>'"'</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>buffer</span></a><span class='Operator'>++ = *</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>name</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>buffer</span></a><span class='Operator'>++ = </span><span class='String'>'"'</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2531"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * quoteRelationName --- safely quote a fully qualified relation name 
 * 
 * buffer must be MAX_QUOTED_REL_NAME_LEN long (includes room for \0) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2551"></a><span class='Declare_Function'>quoteRelationName</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN443"><span class='Ref_to_Macro'>RelationGetNamespace</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>buffer</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>buffer</span></a><span class='Operator'>++ = </span><span class='String'>'.'</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2551"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ri_GenerateQual --- generate a WHERE clause equating two variables 
 * 
 * The idea is to append " sep leftop op rightop" to buf.  The complexity 
 * comes from needing to be sure that the parser will select the desired 
 * operator.  We always name the operator using OPERATOR(schema.op) syntax 
 * (readability isn't a big priority here), so as to avoid search-path 
 * uncertainties.  We have to emit casts too, if either input isn't already 
 * the input type of the operator; else we are at the mercy of the parser's 
 * heuristics for ambiguous-operator resolution. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2571"></a><span class='Declare_Function'>ri_GenerateQual</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, 
</span><a name="LN2572"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sep</span><span class='Delimiter'>, 
</span><a name="LN2573"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>leftop</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>leftoptype</span><span class='Delimiter'>, 
</span><a name="LN2574"></a>                <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>opoid</span><span class='Delimiter'>, 
</span><a name="LN2575"></a>                <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rightop</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>rightoptype</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2577"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>opertup</span><span class='Delimiter'>; 
</span><a name="LN2578"></a>    <a href="../../../include/catalog/pg_operator.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_operator</span></a> <span class='Declare_Local'>operform</span><span class='Delimiter'>; 
</span><a name="LN2579"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>oprname</span><span class='Delimiter'>; 
</span><a name="LN2580"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nspname</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2577"><span class='Ref_To_Local'>opertup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN71"><span class='Ref_to_EnumConst'>OPEROID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2574"><span class='Ref_to_Parameter'>opoid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2577"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for operator %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2574"><span class='Ref_to_Parameter'>opoid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_operator.h.html#LN56"><span class='Ref_to_Typedef'>Form_pg_operator</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2577"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprkind <span class='Operator'>== </span><span class='String'>'b'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2579"><span class='Ref_To_Local'>oprname</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2580"><span class='Ref_To_Local'>nspname</span></a> <span class='Operator'>= </span><a href="../../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %s %s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2572"><span class='Ref_to_Parameter'>sep</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2573"><span class='Ref_to_Parameter'>leftop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2573"><span class='Ref_to_Parameter'>leftoptype</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprleft<span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN210"><span class='Ref_to_Proto'>ri_add_cast_to</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprleft<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" OPERATOR(%s."</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN77"><span class='Ref_to_Proto'>quote_identifier</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2580"><span class='Ref_To_Local'>nspname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2579"><span class='Ref_To_Local'>oprname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>") %s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2575"><span class='Ref_to_Parameter'>rightop</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2575"><span class='Ref_to_Parameter'>rightoptype</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprright<span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN210"><span class='Ref_to_Proto'>ri_add_cast_to</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2571"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2578"><span class='Ref_To_Local'>operform</span></a><span class='Operator'>-&GT;</span>oprright<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2577"><span class='Ref_To_Local'>opertup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_GenerateQual &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a cast specification to buf.  We spell out the type name the hard way, 
 * intentionally not using format_type_be().  This is to avoid corner cases 
 * for CHARACTER, BIT, and perhaps other types, where specifying the type 
 * using SQL-standard syntax results in undesirable data truncation.  By 
 * doing it this way we can be certain that the cast will have default (-1) 
 * target typmod. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2612"></a><span class='Declare_Function'>ri_add_cast_to</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2614"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>typetup</span><span class='Delimiter'>; 
</span><a name="LN2615"></a>    <a href="../../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a> <span class='Declare_Local'>typform</span><span class='Delimiter'>; 
</span><a name="LN2616"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>typname</span><span class='Delimiter'>; 
</span><a name="LN2617"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>nspname</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2614"><span class='Ref_To_Local'>typetup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN107"><span class='Ref_to_EnumConst'>TYPEOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2612"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2614"><span class='Ref_To_Local'>typetup</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for type %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2612"><span class='Ref_to_Parameter'>typid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2615"><span class='Ref_To_Local'>typform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_type.h.html#LN232"><span class='Ref_to_Typedef'>Form_pg_type</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2614"><span class='Ref_To_Local'>typetup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2616"><span class='Ref_To_Local'>typname</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2615"><span class='Ref_To_Local'>typform</span></a><span class='Operator'>-&GT;</span>typname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2617"><span class='Ref_To_Local'>nspname</span></a> <span class='Operator'>= </span><a href="../../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2615"><span class='Ref_To_Local'>typform</span></a><span class='Operator'>-&GT;</span>typnamespace<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2612"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"::%s.%s"</span><span class='Delimiter'>, 
</span>                     <a href="../../../include/utils/builtins.h.html#LN77"><span class='Ref_to_Proto'>quote_identifier</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2617"><span class='Ref_To_Local'>nspname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/builtins.h.html#LN77"><span class='Ref_to_Proto'>quote_identifier</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2616"><span class='Ref_To_Local'>typname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2614"><span class='Ref_To_Local'>typetup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_add_cast_to &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ri_GenerateQualCollation --- add a COLLATE spec to a WHERE clause 
 * 
 * At present, we intentionally do not use this function for RI queries that 
 * compare a variable to a $n parameter.  Since parameter symbols always have 
 * default collation, the effect will be to use the variable's collation. 
 * Now that is only strictly correct when testing the referenced column, since 
 * the SQL standard specifies that RI comparisons should use the referenced 
 * column's collation.  However, so long as all collations have the same 
 * notion of equality (which they do, because texteq reduces to bitwise 
 * equality), there's no visible semantic impact from using the referencing 
 * column's collation when testing it, and this is a good thing to do because 
 * it lets us use a normal index on the referencing column.  However, we do 
 * have to use this function when directly comparing the referencing and 
 * referenced columns, if they are of different collations; else the parser 
 * will fail to resolve the collation to use. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2651"></a><span class='Declare_Function'>ri_GenerateQualCollation</span><span class='Parentheses'>(</span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>collation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2653"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tp</span><span class='Delimiter'>; 
</span><a name="LN2654"></a>    <a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a> <span class='Declare_Local'>colltup</span><span class='Delimiter'>; 
</span><a name="LN2655"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>collname</span><span class='Delimiter'>; 
</span><a name="LN2656"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>onename</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN90"><span class='Ref_to_Const'>MAX_QUOTED_NAME_LEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Nothing to do if it's a noncollatable data type */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2651"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2653"><span class='Ref_To_Local'>tp</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN49"><span class='Ref_to_EnumConst'>COLLOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2651"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2653"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for collation %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2651"><span class='Ref_to_Parameter'>collation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2654"><span class='Ref_To_Local'>colltup</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_collation.h.html#LN51"><span class='Ref_to_Typedef'>Form_pg_collation</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2653"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2655"><span class='Ref_To_Local'>collname</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2654"><span class='Ref_To_Local'>colltup</span></a><span class='Operator'>-&GT;</span>collname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We qualify the name always, for simplicity and to ensure the query is 
     * not search-path-dependent. 
     */ 
</span>    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2656"><span class='Ref_To_Local'>onename</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/lsyscache.h.html#LN175"><span class='Ref_to_Proto'>get_namespace_name</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2654"><span class='Ref_To_Local'>colltup</span></a><span class='Operator'>-&GT;</span>collnamespace<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2651"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" COLLATE %s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2656"><span class='Ref_To_Local'>onename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN203"><span class='Ref_to_Proto'>quoteOneName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2656"><span class='Ref_To_Local'>onename</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2655"><span class='Ref_To_Local'>collname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2651"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>".%s"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2656"><span class='Ref_To_Local'>onename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2653"><span class='Ref_To_Local'>tp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_GenerateQualCollation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_BuildQueryKey - 
 * 
 *  Construct a hashtable key for a prepared SPI plan of an FK constraint. 
 * 
 *      key: output argument, *key is filled in based on the other arguments 
 *      riinfo: info from pg_constraint entry 
 *      constr_queryno: an internal number identifying the query type 
 *          (see RI_PLAN_XXX constants at head of file) 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2692"></a><span class='Declare_Function'>ri_BuildQueryKey</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN2693"></a>                 <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Parameter'>constr_queryno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We assume struct RI_QueryKey contains no padding bytes, else we'd need 
     * to use memset to clear them. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2692"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN141"><span class='Ref_to_Member'>constr_id</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2692"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN111"><span class='Ref_to_Member'>constraint_id</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2692"><span class='Ref_to_Parameter'>key</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2693"><span class='Ref_to_Parameter'>constr_queryno</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Check that RI trigger function was called in expected context 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2707"></a><span class='Declare_Function'>ri_CheckTrigger</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN37"><span class='Ref_to_Typedef'>FunctionCallInfo</span></a> <span class='Declare_Parameter'>fcinfo</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tgkind</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2709"></a>    <a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>trigdata</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/commands/trigger.h.html#LN29"><span class='Ref_to_Struct'>TriggerData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN79"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN24"><span class='Ref_to_Macro'>CALLED_AS_TRIGGER</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>fcinfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" was not called by trigger manager"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check proper event 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN90"><span class='Ref_to_Macro'>TRIGGER_FIRED_AFTER</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2709"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN81"><span class='Ref_to_Macro'>TRIGGER_FIRED_FOR_ROW</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2709"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" must be fired AFTER ROW"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>tgkind</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN97"><span class='Ref_to_Const'>RI_TRIGTYPE_INSERT</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN69"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_INSERT</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2709"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" must be fired for INSERT"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN98"><span class='Ref_to_Const'>RI_TRIGTYPE_UPDATE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN75"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_UPDATE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2709"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" must be fired for UPDATE"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <a href="ri_triggers.c.html#LN99"><span class='Ref_to_Const'>RI_TRIGTYPE_DELETE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/commands/trigger.h.html#LN72"><span class='Ref_to_Macro'>TRIGGER_FIRED_BY_DELETE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2709"><span class='Ref_To_Local'>trigdata</span></a><span class='Operator'>-&GT;</span><a href="../../../include/commands/trigger.h.html#LN32"><span class='Ref_to_Member'>tg_event</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_E_R_I_E_TRIGGER_PROTOCOL_VIOLATED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"function \"%s\" must be fired for DELETE"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2707"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch tgkind &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ri_CheckTrigger &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch the RI_ConstraintInfo struct for the trigger's FK constraint. 
 */ 
</span><span class='Keyword'>static const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>* 
</span><a name="LN2753"></a><span class='Declare_Function'>ri_FetchConstraintInfo</span><span class='Parentheses'>(</span><a href="../../../include/utils/reltrigger.h.html#LN22"><span class='Ref_to_Struct'>Trigger</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>trigger</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>trig_rel</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2755"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>constraintOid</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN33"><span class='Ref_to_Member'>tgconstraint</span></a><span class='Delimiter'>; 
</span><a name="LN2756"></a>    <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that the FK constraint's OID is available; it might not be if 
     * we've been invoked via an ordinary trigger or an old-style "constraint 
     * trigger". 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2755"><span class='Ref_To_Local'>constraintOid</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_OBJECT_DEFINITION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>          <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"no pg_constraint entry for trigger \"%s\" on table \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trig_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Remove this referential integrity trigger and its mates, then do ALTER TABLE ADD CONSTRAINT."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create a hashtable entry for the constraint */ 
</span>    <a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN232"><span class='Ref_to_Proto'>ri_LoadConstraintInfo</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2755"><span class='Ref_To_Local'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do some easy cross-checks against the trigger call data */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>rel_is_pk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN31"><span class='Ref_to_Member'>tgconstrrelid</span></a> <span class='Operator'>|| 
</span>            <a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN115"><span class='Ref_to_Member'>pk_relid</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trig_rel</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong pg_constraint entry for trigger \"%s\" on table \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trig_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trig_rel</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN115"><span class='Ref_to_Member'>pk_relid</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN31"><span class='Ref_to_Member'>tgconstrrelid</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"wrong pg_constraint entry for trigger \"%s\" on table \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trigger</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/reltrigger.h.html#LN26"><span class='Ref_to_Member'>tgname</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2753"><span class='Ref_to_Parameter'>trig_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN2756"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_FetchConstraintInfo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fetch or create the RI_ConstraintInfo struct for an FK constraint. 
 */ 
</span><span class='Keyword'>static const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>* 
</span><a name="LN2796"></a><span class='Declare_Function'>ri_LoadConstraintInfo</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>constraintOid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2798"></a>    <a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span><span class='Delimiter'>; 
</span><a name="LN2799"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span><a name="LN2800"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span><a name="LN2801"></a>    <a href="../../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a> <span class='Declare_Local'>conForm</span><span class='Delimiter'>; 
</span><a name="LN2802"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>adatum</span><span class='Delimiter'>; 
</span><a name="LN2803"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isNull</span><span class='Delimiter'>; 
</span><a name="LN2804"></a>    <a href="../../../include/utils/array.h.html#LN75"><span class='Ref_to_Typedef'>ArrayType</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>arr</span><span class='Delimiter'>; 
</span><a name="LN2805"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>numkeys</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On the first call initialize the hashtable 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN187"><span class='Ref_to_Global_Var'>ri_constraint_cache</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN222"><span class='Ref_to_Proto'>ri_InitHashTables</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a hash entry.  If we find a valid one, just return it. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN187"><span class='Ref_to_Global_Var'>ri_constraint_cache</span></a><span class='Delimiter'>, 
</span>                                               <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Delimiter'>, 
</span>                                               <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2799"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN2799"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN112"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN112"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fetch the pg_constraint row so we can fill in the entry. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> <span class='Comment_Single_Line'>/* should not happen */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_constraint.h.html#LN146"><span class='Ref_to_Typedef'>Form_pg_constraint</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>contype <span class='Operator'>!= </span><a href="../../../include/catalog/pg_constraint.h.html#LN188"><span class='Ref_to_Const'>CONSTRAINT_FOREIGN</span></a><span class='Parentheses'>) </span><span class='Comment_Single_Line'>/* should not happen */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"constraint %u is not a foreign key constraint"</span><span class='Delimiter'>, 
</span>             <a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And extract data */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN111"><span class='Ref_to_Member'>constraint_id</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN113"><span class='Ref_to_Member'>oidHashValue</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN191"><span class='Ref_to_Macro'>GetSysCacheHashValue1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, 
</span>                                            <a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>conname<span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN492"><span class='Ref_to_Typedef'>NameData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN115"><span class='Ref_to_Member'>pk_relid</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>confrelid<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN116"><span class='Ref_to_Member'>fk_relid</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>conrelid<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN117"><span class='Ref_to_Member'>confupdtype</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>confupdtype<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN118"><span class='Ref_to_Member'>confdeltype</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>confdeltype<span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN119"><span class='Ref_to_Member'>confmatchtype</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2801"><span class='Ref_To_Local'>conForm</span></a><span class='Operator'>-&GT;</span>confmatchtype<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We expect the arrays to be 1-D arrays of the right types; verify that. 
     * We don't need to use deconstruct_array() since the array data is just 
     * going to look like a C array of values. 
     */ 
</span>    <a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_constraint.h.html#LN169"><span class='Ref_to_Const'>Anum_pg_constraint_conkey</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null conkey for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ensure not toasted */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN271"><span class='Ref_to_Macro'>ARR_HASNULL</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN22"><span class='Ref_to_Const'>INT2OID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"conkey is not a 1-D smallint array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>&GT; </span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"foreign key constraint cannot have %d columns"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* free de-toasted copy, if any */ 
</span> 
    <a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_constraint.h.html#LN170"><span class='Ref_to_Const'>Anum_pg_constraint_confkey</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null confkey for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ensure not toasted */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN271"><span class='Ref_to_Macro'>ARR_HASNULL</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN22"><span class='Ref_to_Const'>INT2OID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"confkey is not a 1-D smallint array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* free de-toasted copy, if any */ 
</span> 
    <a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_constraint.h.html#LN171"><span class='Ref_to_Const'>Anum_pg_constraint_conpfeqop</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null conpfeqop for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ensure not toasted */ 
</span>    <span class='Comment_Multi_Line'>/* see TryReuseForeignKey if you change the test below */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN271"><span class='Ref_to_Macro'>ARR_HASNULL</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"conpfeqop is not a 1-D Oid array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN123"><span class='Ref_to_Member'>pf_eq_oprs</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* free de-toasted copy, if any */ 
</span> 
    <a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_constraint.h.html#LN172"><span class='Ref_to_Const'>Anum_pg_constraint_conppeqop</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null conppeqop for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ensure not toasted */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN271"><span class='Ref_to_Macro'>ARR_HASNULL</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"conppeqop is not a 1-D Oid array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN125"><span class='Ref_to_Member'>pp_eq_oprs</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* free de-toasted copy, if any */ 
</span> 
    <a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN133"><span class='Ref_to_Proto'>SysCacheGetAttr</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/catalog/pg_constraint.h.html#LN173"><span class='Ref_to_Const'>Anum_pg_constraint_conffeqop</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2803"><span class='Ref_To_Local'>isNull</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"null conffeqop for constraint %u"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2796"><span class='Ref_to_Parameter'>constraintOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>= </span><a href="../../../include/utils/array.h.html#LN241"><span class='Ref_to_Macro'>DatumGetArrayTypeP</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ensure not toasted */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/array.h.html#LN270"><span class='Ref_to_Macro'>ARR_NDIM</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN274"><span class='Ref_to_Macro'>ARR_DIMS</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN271"><span class='Ref_to_Macro'>ARR_HASNULL</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/utils/array.h.html#LN272"><span class='Ref_to_Macro'>ARR_ELEMTYPE</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN27"><span class='Ref_to_Const'>OIDOID</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"conffeqop is not a 1-D Oid array"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN127"><span class='Ref_to_Member'>ff_eq_oprs</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/array.h.html#LN302"><span class='Ref_to_Macro'>ARR_DATA_PTR</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2805"><span class='Ref_To_Local'>numkeys</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN244"><span class='Ref_to_Typedef'>Pointer</span></a><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a> <span class='Operator'>!= </span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2802"><span class='Ref_To_Local'>adatum</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2804"><span class='Ref_To_Local'>arr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* free de-toasted copy, if any */ 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2800"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For efficient processing of invalidation messages below, we keep a 
     * doubly-linked list, and a count, of all currently valid entries. 
     */ 
</span>    <a href="../../../include/lib/ilist.h.html#LN315"><span class='Ref_to_Func'>dlist_push_tail</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN190"><span class='Ref_to_Global_Var'>ri_constraint_cache_valid_list</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN129"><span class='Ref_to_Member'>valid_link</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN191"><span class='Ref_to_Global_Var'>ri_constraint_cache_valid_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN112"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN2798"><span class='Ref_To_Local'>riinfo</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_LoadConstraintInfo &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Callback for pg_constraint inval events 
 * 
 * While most syscache callbacks just flush all their entries, pg_constraint 
 * gets enough update traffic that it's probably worth being smarter. 
 * Invalidate any ri_constraint_cache entry associated with the syscache 
 * entry with the specified hash value, or all entries if hashvalue == 0. 
 * 
 * Note: at the time a cache invalidation message is processed there may be 
 * active references to the cache.  Because of this we never remove entries 
 * from the cache, but only mark them invalid, which is harmless to active 
 * uses.  (Any query using an entry should hold a lock sufficient to keep that 
 * data from changing under it --- but we may get cache flushes anyway.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2955"></a><span class='Declare_Function'>InvalidateConstraintCacheCallBack</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2957"></a>    <a href="../../../include/lib/ilist.h.html#LN177"><span class='Ref_to_Struct'>dlist_mutable_iter</span></a> <span class='Declare_Local'>iter</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN187"><span class='Ref_to_Global_Var'>ri_constraint_cache</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the list of currently valid entries gets excessively large, we mark 
     * them all invalid so we can empty the list.  This arrangement avoids 
     * O(N^2) behavior in situations where a session touches many foreign keys 
     * and also does many ALTER TABLEs, such as a restore from pg_dump. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN191"><span class='Ref_to_Global_Var'>ri_constraint_cache_valid_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>1000</span><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN2955"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* pretend it's a cache reset */ 
</span> 
    <a href="../../../include/lib/ilist.h.html#LN523"><span class='Ref_to_Macro'>dlist_foreach_modify</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2957"><span class='Ref_To_Local'>iter</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN190"><span class='Ref_to_Global_Var'>ri_constraint_cache_valid_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2972"></a>        <a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>riinfo</span> <span class='Operator'>= </span><a href="../../../include/lib/ilist.h.html#LN476"><span class='Ref_to_Macro'>dlist_container</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a><span class='Delimiter'>, 
</span>                                                    valid_link<span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2957"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2955"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="ri_triggers.c.html#LN2972"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN113"><span class='Ref_to_Member'>oidHashValue</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN2955"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="ri_triggers.c.html#LN2972"><span class='Ref_To_Local'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN112"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Remove invalidated entries from the list, too */ 
</span>            <a href="../../../include/lib/ilist.h.html#LN356"><span class='Ref_to_Func'>dlist_delete</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2957"><span class='Ref_To_Local'>iter</span></a><span class='Operator'>.</span><a href="../../../include/lib/ilist.h.html#LN179"><span class='Ref_to_Member'>cur</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN191"><span class='Ref_to_Global_Var'>ri_constraint_cache_valid_count</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end InvalidateConstraintCacheCallBack &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Prepare execution plan for a query to enforce an RI restriction 
 * 
 * If cache_plan is true, the plan is saved into our plan hashtable 
 * so that we don't need to plan it again. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> 
<a name="LN2993"></a><span class='Declare_Function'>ri_PlanCheck</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>querystr</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nargs</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>argtypes</span><span class='Delimiter'>, 
</span><a name="LN2994"></a>             <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qkey</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, 
</span><a name="LN2995"></a>             <span class='Keyword'>bool </span><span class='Declare_Parameter'>cache_plan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2997"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>qplan</span><span class='Delimiter'>; 
</span><a name="LN2998"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>query_rel</span><span class='Delimiter'>; 
</span><a name="LN2999"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>save_userid</span><span class='Delimiter'>; 
</span><a name="LN3000"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_sec_context</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use the query type code to determine whether the query is run against 
     * the PK or FK table; we'll do the check as that table's owner 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2994"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>&LT;= </span><a href="ri_triggers.c.html#LN79"><span class='Ref_to_Const'>RI_PLAN_LAST_ON_PK</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN2998"><span class='Ref_To_Local'>query_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2994"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="ri_triggers.c.html#LN2998"><span class='Ref_To_Local'>query_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN2994"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Switch to proper UID to perform check as */ 
</span>    <a href="../../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN2999"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3000"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN410"><span class='Ref_to_Macro'>RelationGetForm</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2998"><span class='Ref_To_Local'>query_rel</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>relowner<span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3000"><span class='Ref_To_Local'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a> <span class='Operator'>| 
</span>                           <a href="../../../include/miscadmin.h.html#LN297"><span class='Ref_to_Const'>SECURITY_NOFORCE_RLS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create the plan */ 
</span>    <a href="ri_triggers.c.html#LN2997"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN99"><span class='Ref_to_Proto'>SPI_prepare</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2993"><span class='Ref_to_Parameter'>querystr</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2993"><span class='Ref_to_Parameter'>nargs</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2993"><span class='Ref_to_Parameter'>argtypes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2997"><span class='Ref_To_Local'>qplan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_prepare returned %d for %s"</span><span class='Delimiter'>, </span><a href="../../executor/spi.c.html#LN41"><span class='Ref_to_Global_Var'>SPI_result</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2993"><span class='Ref_to_Parameter'>querystr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore UID and security context */ 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2999"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3000"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Save the plan if requested */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2995"><span class='Ref_to_Parameter'>cache_plan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/executor/spi.h.html#LN106"><span class='Ref_to_Proto'>SPI_keepplan</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2997"><span class='Ref_To_Local'>qplan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN225"><span class='Ref_to_Proto'>ri_HashPreparedPlan</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN2994"><span class='Ref_to_Parameter'>qkey</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN2997"><span class='Ref_To_Local'>qplan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN2997"><span class='Ref_To_Local'>qplan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_PlanCheck &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Perform a query to enforce an RI restriction 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3040"></a><span class='Declare_Function'>ri_PerformCheck</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN3041"></a>                <a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qkey</span><span class='Delimiter'>, </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Parameter'>qplan</span><span class='Delimiter'>, 
</span><a name="LN3042"></a>                <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, 
</span><a name="LN3043"></a>                <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>old_tuple</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>new_tuple</span><span class='Delimiter'>, 
</span><a name="LN3044"></a>                <span class='Keyword'>bool </span><span class='Declare_Parameter'>detectNewRows</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>expect_OK</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3046"></a>    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a>    <span class='Declare_Local'>query_rel</span><span class='Delimiter'>, 
</span><a name="LN3047"></a>                <span class='Declare_Local'>source_rel</span><span class='Delimiter'>; 
</span><a name="LN3048"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>source_is_pk</span><span class='Delimiter'>; 
</span><a name="LN3049"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>test_snapshot</span><span class='Delimiter'>; 
</span><a name="LN3050"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>crosscheck_snapshot</span><span class='Delimiter'>; 
</span><a name="LN3051"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>limit</span><span class='Delimiter'>; 
</span><a name="LN3052"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>spi_result</span><span class='Delimiter'>; 
</span><a name="LN3053"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>save_userid</span><span class='Delimiter'>; 
</span><a name="LN3054"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>save_sec_context</span><span class='Delimiter'>; 
</span><a name="LN3055"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>vals</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span><a name="LN3056"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN66"><span class='Ref_to_Const'>RI_MAX_NUMKEYS</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use the query type code to determine whether the query is run against 
     * the PK or FK table; we'll do the check as that table's owner 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>&LT;= </span><a href="ri_triggers.c.html#LN79"><span class='Ref_to_Const'>RI_PLAN_LAST_ON_PK</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN3046"><span class='Ref_To_Local'>query_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="ri_triggers.c.html#LN3046"><span class='Ref_To_Local'>query_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The values for the query are taken from the table on which the trigger 
     * is called - it is normally the other one with respect to query_rel. An 
     * exception is ri_Check_Pk_Match(), which uses the PK table for both (and 
     * sets queryno to RI_PLAN_CHECK_LOOKUPPK_FROM_PK).  We might eventually 
     * need some less klugy way to determine this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN77"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3047"><span class='Ref_To_Local'>source_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3048"><span class='Ref_To_Local'>source_is_pk</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3047"><span class='Ref_To_Local'>source_rel</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3048"><span class='Ref_To_Local'>source_is_pk</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Extract the parameters to be passed into the query */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN241"><span class='Ref_to_Proto'>ri_ExtractValues</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3047"><span class='Ref_To_Local'>source_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3048"><span class='Ref_To_Local'>source_is_pk</span></a><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN3055"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3056"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>old_tuple</span></a><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN241"><span class='Ref_to_Proto'>ri_ExtractValues</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3047"><span class='Ref_To_Local'>source_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>old_tuple</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3048"><span class='Ref_To_Local'>source_is_pk</span></a><span class='Delimiter'>, 
</span>                             <a href="ri_triggers.c.html#LN3055"><span class='Ref_To_Local'>vals</span></a> <span class='Operator'>+ </span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3056"><span class='Ref_To_Local'>nulls</span></a> <span class='Operator'>+ </span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN241"><span class='Ref_to_Proto'>ri_ExtractValues</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3047"><span class='Ref_To_Local'>source_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>old_tuple</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3048"><span class='Ref_To_Local'>source_is_pk</span></a><span class='Delimiter'>, 
</span>                         <a href="ri_triggers.c.html#LN3055"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3056"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In READ COMMITTED mode, we just need to use an up-to-date regular 
     * snapshot, and we will see all rows that could be interesting. But in 
     * transaction-snapshot mode, we can't change the transaction snapshot. If 
     * the caller passes detectNewRows == false then it's okay to do the query 
     * with the transaction snapshot; otherwise we use a current snapshot, and 
     * tell the executor to error out if it finds any rows under the current 
     * snapshot that wouldn't be visible per the transaction snapshot.  Note 
     * that SPI_execute_snapshot will register the snapshots, so we don't need 
     * to bother here. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN42"><span class='Ref_to_Macro'>IsolationUsesXactSnapshot</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="ri_triggers.c.html#LN3044"><span class='Ref_to_Parameter'>detectNewRows</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/access/xact.h.html#LN346"><span class='Ref_to_Proto'>CommandCounterIncrement</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* be sure all my own work is visible */ 
</span>        <a href="ri_triggers.c.html#LN3049"><span class='Ref_To_Local'>test_snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN64"><span class='Ref_to_Proto'>GetLatestSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3050"><span class='Ref_To_Local'>crosscheck_snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* the default SPI behavior is okay */ 
</span>        <a href="ri_triggers.c.html#LN3049"><span class='Ref_To_Local'>test_snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3050"><span class='Ref_To_Local'>crosscheck_snapshot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is a select query (e.g., for a 'no action' or 'restrict' 
     * trigger), we only need to see if there is a single row in the table, 
     * matching the key.  Otherwise, limit = 0 - because we want the query to 
     * affect ALL the matching rows. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3051"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3044"><span class='Ref_to_Parameter'>expect_OK</span></a> <span class='Operator'>== </span><a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Switch to proper UID to perform check as */ 
</span>    <a href="../../../include/miscadmin.h.html#LN312"><span class='Ref_to_Proto'>GetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3053"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3054"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/rel.h.html#LN410"><span class='Ref_to_Macro'>RelationGetForm</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3046"><span class='Ref_To_Local'>query_rel</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>relowner<span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3054"><span class='Ref_To_Local'>save_sec_context</span></a> <span class='Operator'>| </span><a href="../../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a> <span class='Operator'>| 
</span>                           <a href="../../../include/miscadmin.h.html#LN297"><span class='Ref_to_Const'>SECURITY_NOFORCE_RLS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Finally we can run the query. */ 
</span>    <a href="ri_triggers.c.html#LN3052"><span class='Ref_To_Local'>spi_result</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN90"><span class='Ref_to_Proto'>SPI_execute_snapshot</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qplan</span></a><span class='Delimiter'>, 
</span>                                      <a href="ri_triggers.c.html#LN3055"><span class='Ref_To_Local'>vals</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3056"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, 
</span>                                      <a href="ri_triggers.c.html#LN3049"><span class='Ref_To_Local'>test_snapshot</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3050"><span class='Ref_To_Local'>crosscheck_snapshot</span></a><span class='Delimiter'>, 
</span>                                      <span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3051"><span class='Ref_To_Local'>limit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Restore UID and security context */ 
</span>    <a href="../../../include/miscadmin.h.html#LN313"><span class='Ref_to_Proto'>SetUserIdAndSecContext</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3053"><span class='Ref_To_Local'>save_userid</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3054"><span class='Ref_To_Local'>save_sec_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check result */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3052"><span class='Ref_To_Local'>spi_result</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"SPI_execute_snapshot returned %d"</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3052"><span class='Ref_To_Local'>spi_result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3044"><span class='Ref_to_Parameter'>expect_OK</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="ri_triggers.c.html#LN3052"><span class='Ref_To_Local'>spi_result</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN3044"><span class='Ref_to_Parameter'>expect_OK</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN244"><span class='Ref_to_Proto'>ri_ReportViolation</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a> <span class='Operator'>? </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a> <span class='Operator'>: </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>old_tuple</span></a><span class='Delimiter'>, 
</span>                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* XXX wouldn't it be clearer to do this part at the caller? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>!= </span><a href="ri_triggers.c.html#LN78"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK_FROM_PK</span></a> <span class='Operator'>&& 
</span>        <a href="ri_triggers.c.html#LN3044"><span class='Ref_to_Parameter'>expect_OK</span></a> <span class='Operator'>== </span><a href="../../../include/executor/spi.h.html#LN53"><span class='Ref_to_Const'>SPI_OK_SELECT</span></a> <span class='Operator'>&& 
</span>    <span class='Parentheses'>(</span><a href="../../executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN77"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK</span></a><span class='Parentheses'>))</span> 
        <a href="ri_triggers.c.html#LN244"><span class='Ref_to_Proto'>ri_ReportViolation</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3040"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3042"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a> <span class='Operator'>? </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>new_tuple</span></a> <span class='Operator'>: </span><a href="ri_triggers.c.html#LN3043"><span class='Ref_to_Parameter'>old_tuple</span></a><span class='Delimiter'>, 
</span>                           <span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3041"><span class='Ref_to_Parameter'>qkey</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN142"><span class='Ref_to_Member'>constr_queryno</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../executor/spi.c.html#LN38"><span class='Ref_to_Global_Var'>SPI_processed</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_PerformCheck &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Extract fields from a tuple into Datum/nulls arrays 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3175"></a><span class='Declare_Function'>ri_ExtractValues</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN3176"></a>                 <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Delimiter'>, 
</span><a name="LN3177"></a>                 <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>vals</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>nulls</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3179"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3175"><span class='Ref_to_Parameter'>rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span><a name="LN3180"></a>    <span class='Keyword'>const </span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attnums</span><span class='Delimiter'>; 
</span><a name="LN3181"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3182"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3176"><span class='Ref_to_Parameter'>rel_is_pk</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN3180"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3176"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="ri_triggers.c.html#LN3180"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3176"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN3176"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3177"><span class='Ref_to_Parameter'>vals</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3175"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3180"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ri_triggers.c.html#LN3179"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="ri_triggers.c.html#LN3182"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3177"><span class='Ref_to_Parameter'>nulls</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3181"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="ri_triggers.c.html#LN3182"><span class='Ref_To_Local'>isnull</span></a> <span class='Operator'>? </span><span class='String'>'n'</span> <span class='Operator'>: </span><span class='String'>' '</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ri_ExtractValues &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Produce an error report 
 * 
 * If the failed constraint was on insert/update to the FK table, 
 * we want the key names and values extracted from there, and the error 
 * message to look like 'key blah is not present in PK'. 
 * Otherwise, the attr names and values come from the PK table and the 
 * message looks like 'key blah is still referenced from FK'. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3207"></a><span class='Declare_Function'>ri_ReportViolation</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, 
</span><a name="LN3208"></a>                   <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>pk_rel</span><span class='Delimiter'>, </span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>fk_rel</span><span class='Delimiter'>, 
</span><a name="LN3209"></a>                   <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>violator</span><span class='Delimiter'>, </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Parameter'>tupdesc</span><span class='Delimiter'>, 
</span><a name="LN3210"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>queryno</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>spi_err</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3212"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>key_names</span><span class='Delimiter'>; 
</span><a name="LN3213"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>key_values</span><span class='Delimiter'>; 
</span><a name="LN3214"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>onfk</span><span class='Delimiter'>; 
</span><a name="LN3215"></a>    <span class='Keyword'>const </span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attnums</span><span class='Delimiter'>; 
</span><a name="LN3216"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span><span class='Delimiter'>; 
</span><a name="LN3217"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>rel_oid</span><span class='Delimiter'>; 
</span><a name="LN3218"></a>    <a href="../../../include/utils/acl.h.html#LN169"><span class='Ref_to_Typedef'>AclResult</span></a>   <span class='Declare_Local'>aclresult</span><span class='Delimiter'>; 
</span><a name="LN3219"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>has_perm</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3210"><span class='Ref_to_Parameter'>spi_err</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INTERNAL_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"referential integrity query on \"%s\" from constraint \"%s\" on \"%s\" gave unexpected result"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"This is most likely due to a rule having rewritten the query."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Determine which relation to complain about.  If tupdesc wasn't passed 
     * by caller, assume the violator tuple came from there. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3214"><span class='Ref_To_Local'>onfk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3210"><span class='Ref_to_Parameter'>queryno</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN77"><span class='Ref_to_Const'>RI_PLAN_CHECK_LOOKUPPK</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3214"><span class='Ref_To_Local'>onfk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3215"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3217"><span class='Ref_To_Local'>rel_oid</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3215"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3217"><span class='Ref_To_Local'>rel_oid</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN115"><span class='Ref_to_Member'>rd_id</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN114"><span class='Ref_to_Member'>rd_att</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check permissions- if the user does not have access to view the data in 
     * any of the key columns then we don't include the errdetail() below. 
     * 
     * Check if RLS is enabled on the relation first.  If so, we don't return 
     * any specifics to avoid leaking data. 
     * 
     * Check table-level permissions next and, failing that, column-level 
     * privileges. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/rls.h.html#LN47"><span class='Ref_to_Proto'>check_enable_rls</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3217"><span class='Ref_To_Local'>rel_oid</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../../include/utils/rls.h.html#LN44"><span class='Ref_to_EnumConst'>RLS_ENABLED</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3218"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../../include/utils/acl.h.html#LN283"><span class='Ref_to_Proto'>pg_class_aclcheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3217"><span class='Ref_To_Local'>rel_oid</span></a><span class='Delimiter'>, </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="../../../include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3218"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Try for column-level permissions */ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="ri_triggers.c.html#LN3218"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>= </span><a href="../../../include/utils/acl.h.html#LN279"><span class='Ref_to_Proto'>pg_attribute_aclcheck</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3217"><span class='Ref_To_Local'>rel_oid</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3215"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>], 
</span>                                                  <a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                                                  <a href="../../../include/nodes/parsenodes.h.html#LN72"><span class='Ref_to_Const'>ACL_SELECT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* No access to the key */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3218"><span class='Ref_To_Local'>aclresult</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/acl.h.html#LN171"><span class='Ref_to_EnumConst'>ACLCHECK_OK</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="ri_triggers.c.html#LN3219"><span class='Ref_To_Local'>has_perm</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if check_enable_rls(rel_... &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="ri_triggers.c.html#LN3219"><span class='Ref_To_Local'>has_perm</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3219"><span class='Ref_To_Local'>has_perm</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Get printable versions of the keys involved */ 
</span>        <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3212"><span class='Ref_To_Local'>key_names</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3213"><span class='Ref_To_Local'>key_values</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN3292"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>fnum</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3215"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>]; 
</span><a name="LN3293"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span><span class='Delimiter'>, 
</span><a name="LN3294"></a>                       <span class='Operator'>*</span><span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span> 
            <a href="ri_triggers.c.html#LN3293"><span class='Ref_To_Local'>name</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN124"><span class='Ref_to_Proto'>SPI_fname</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3292"><span class='Ref_To_Local'>fnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="ri_triggers.c.html#LN3294"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><a href="../../../include/executor/spi.h.html#LN125"><span class='Ref_to_Proto'>SPI_getvalue</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>violator</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3209"><span class='Ref_to_Parameter'>tupdesc</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3292"><span class='Ref_To_Local'>fnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN3294"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) 
</span>                <a href="ri_triggers.c.html#LN3294"><span class='Ref_To_Local'>val</span></a> <span class='Operator'>= </span><span class='String'>"null"</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3216"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3212"><span class='Ref_To_Local'>key_names</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3213"><span class='Ref_To_Local'>key_values</span></a><span class='Delimiter'>, </span><span class='String'>", "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3212"><span class='Ref_To_Local'>key_names</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3293"><span class='Ref_To_Local'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3213"><span class='Ref_To_Local'>key_values</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3294"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if has_perm &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3214"><span class='Ref_To_Local'>onfk</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FOREIGN_KEY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"insert or update on table \"%s\" violates foreign key constraint \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN3219"><span class='Ref_To_Local'>has_perm</span></a> <span class='Operator'>? 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Key (%s)=(%s) is not present in table \"%s\"."</span><span class='Delimiter'>, 
</span>                           <a href="ri_triggers.c.html#LN3212"><span class='Ref_To_Local'>key_names</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3213"><span class='Ref_To_Local'>key_values</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>))</span> <span class='Operator'>: 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Key is not present in table \"%s\"."</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FOREIGN_KEY_VIOLATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"update or delete on table \"%s\" violates foreign key constraint \"%s\" on table \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>pk_rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="ri_triggers.c.html#LN3219"><span class='Ref_To_Local'>has_perm</span></a> <span class='Operator'>? 
</span>            <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Key (%s)=(%s) is still referenced from table \"%s\"."</span><span class='Delimiter'>, 
</span>                      <a href="ri_triggers.c.html#LN3212"><span class='Ref_To_Local'>key_names</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3213"><span class='Ref_To_Local'>key_values</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>))</span> <span class='Operator'>: 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Key is still referenced from table \"%s\"."</span><span class='Delimiter'>, 
</span>                           <a href="../../../include/utils/rel.h.html#LN436"><span class='Ref_to_Macro'>RelationGetRelationName</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                 <a href="../../../include/utils/relcache.h.html#LN79"><span class='Ref_to_Proto'>errtableconstraint</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3208"><span class='Ref_to_Parameter'>fk_rel</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3207"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN114"><span class='Ref_to_Member'>conname</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_ReportViolation &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_NullCheck - 
 * 
 *  Determine the NULL state of all key values in a tuple 
 * 
 *  Returns one of RI_KEYS_ALL_NULL, RI_KEYS_NONE_NULL or RI_KEYS_SOME_NULL. 
 * ---------- 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN3350"></a><span class='Declare_Function'>ri_NullCheck</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tup</span><span class='Delimiter'>, 
</span><a name="LN3351"></a>             <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3353"></a>    <span class='Keyword'>const </span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attnums</span><span class='Delimiter'>; 
</span><a name="LN3354"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN3355"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>allnull</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN3356"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>nonenull</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3351"><span class='Ref_to_Parameter'>rel_is_pk</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN3353"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3351"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="ri_triggers.c.html#LN3353"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3351"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3354"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3354"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN3351"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3354"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../access/common/heaptuple.c.html#LN295"><span class='Ref_to_Func'>heap_attisnull</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3350"><span class='Ref_to_Parameter'>tup</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3353"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3354"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <a href="ri_triggers.c.html#LN3356"><span class='Ref_To_Local'>nonenull</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="ri_triggers.c.html#LN3355"><span class='Ref_To_Local'>allnull</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3355"><span class='Ref_To_Local'>allnull</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="ri_triggers.c.html#LN71"><span class='Ref_to_Const'>RI_KEYS_ALL_NULL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3356"><span class='Ref_To_Local'>nonenull</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="ri_triggers.c.html#LN73"><span class='Ref_to_Const'>RI_KEYS_NONE_NULL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN72"><span class='Ref_to_Const'>RI_KEYS_SOME_NULL</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_NullCheck &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_InitHashTables - 
 * 
 *  Initialize our internal hash tables. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3388"></a><span class='Declare_Function'>ri_InitHashTables</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3390"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN187"><span class='Ref_to_Global_Var'>ri_constraint_cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"RI constraint cache"</span><span class='Delimiter'>, 
</span>                                      <a href="ri_triggers.c.html#LN68"><span class='Ref_to_Const'>RI_INIT_CONSTRAINTHASHSIZE</span></a><span class='Delimiter'>, 
</span>                                      <span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Arrange to flush cache on pg_constraint changes */ 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN52"><span class='Ref_to_EnumConst'>CONSTROID</span></a><span class='Delimiter'>, 
</span>                                  <a href="ri_triggers.c.html#LN223"><span class='Ref_to_Proto'>InvalidateConstraintCacheCallBack</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN150"><span class='Ref_to_Struct'>RI_QueryHashEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN188"><span class='Ref_to_Global_Var'>ri_query_cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"RI query cache"</span><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN69"><span class='Ref_to_Const'>RI_INIT_QUERYHASHSIZE</span></a><span class='Delimiter'>, 
</span>                                 <span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN163"><span class='Ref_to_Struct'>RI_CompareKey</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN189"><span class='Ref_to_Global_Var'>ri_compare_cache</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"RI compare cache"</span><span class='Delimiter'>, 
</span>                                   <a href="ri_triggers.c.html#LN69"><span class='Ref_to_Const'>RI_INIT_QUERYHASHSIZE</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="ri_triggers.c.html#LN3390"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a> <span class='Operator'>| </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_InitHashTables &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_FetchPreparedPlan - 
 * 
 *  Lookup for a query key in our private hash table of prepared 
 *  and saved SPI execution plans. Return the plan if found or NULL. 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> 
<a name="LN3428"></a><span class='Declare_Function'>ri_FetchPreparedPlan</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3430"></a>    <a href="ri_triggers.c.html#LN150"><span class='Ref_to_Struct'>RI_QueryHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN3431"></a>    <a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a>  <span class='Declare_Local'>plan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On the first call initialize the hashtable 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN188"><span class='Ref_to_Global_Var'>ri_query_cache</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN222"><span class='Ref_to_Proto'>ri_InitHashTables</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup for the key 
     */ 
</span>    <a href="ri_triggers.c.html#LN3430"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN150"><span class='Ref_to_Struct'>RI_QueryHashEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN188"><span class='Ref_to_Global_Var'>ri_query_cache</span></a><span class='Delimiter'>, 
</span>                                              <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN3428"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3430"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check whether the plan is still valid.  If it isn't, we don't want to 
     * simply rely on plancache.c to regenerate it; rather we should start 
     * from scratch and rebuild the query text too.  This is to cover cases 
     * such as table/column renames.  We depend on the plancache machinery to 
     * detect possible invalidations, though. 
     * 
     * CAUTION: this check is only trustworthy if the caller has already 
     * locked both FK and PK rels. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3430"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN153"><span class='Ref_to_Member'>plan</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>&& </span><a href="../../../include/executor/spi.h.html#LN113"><span class='Ref_to_Proto'>SPI_plan_is_valid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise we might as well flush the cached plan now, to free a little 
     * memory space before we make a new one. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3430"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN153"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/executor/spi.h.html#LN108"><span class='Ref_to_Proto'>SPI_freeplan</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3431"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_FetchPreparedPlan &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_HashPreparedPlan - 
 * 
 *  Add another plan to our private SPI query plan hashtable. 
 * ---------- 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN3481"></a><span class='Declare_Function'>ri_HashPreparedPlan</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN139"><span class='Ref_to_Struct'>RI_QueryKey</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>key</span><span class='Delimiter'>, </span><a href="../../../include/executor/spi.h.html#LN33"><span class='Ref_to_Typedef'>SPIPlanPtr</span></a> <span class='Declare_Parameter'>plan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3483"></a>    <a href="ri_triggers.c.html#LN150"><span class='Ref_to_Struct'>RI_QueryHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN3484"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On the first call initialize the hashtable 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN188"><span class='Ref_to_Global_Var'>ri_query_cache</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN222"><span class='Ref_to_Proto'>ri_InitHashTables</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add the new plan.  We might be overwriting an entry previously found 
     * invalid by ri_FetchPreparedPlan. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3483"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN150"><span class='Ref_to_Struct'>RI_QueryHashEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN188"><span class='Ref_to_Global_Var'>ri_query_cache</span></a><span class='Delimiter'>, 
</span>                                              <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="ri_triggers.c.html#LN3481"><span class='Ref_to_Parameter'>key</span></a><span class='Delimiter'>, 
</span>                                              <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3484"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN3484"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>|| </span><a href="ri_triggers.c.html#LN3483"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN153"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3483"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN153"><span class='Ref_to_Member'>plan</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3481"><span class='Ref_to_Parameter'>plan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_HashPreparedPlan &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_KeysEqual - 
 * 
 *  Check if all key values in OLD and NEW are equal. 
 * 
 *  Note: at some point we might wish to redefine this as checking for 
 *  "IS NOT DISTINCT" rather than "=", that is, allow two nulls to be 
 *  considered equal.  Currently there is no need since all callers have 
 *  previously found at least one of the rows to contain no nulls. 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3516"></a><span class='Declare_Function'>ri_KeysEqual</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>rel</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>oldtup</span><span class='Delimiter'>, </span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtup</span><span class='Delimiter'>, 
</span><a name="LN3517"></a>             <span class='Keyword'>const </span><a href="ri_triggers.c.html#LN109"><span class='Ref_to_Struct'>RI_ConstraintInfo</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>riinfo</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>rel_is_pk</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3519"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN428"><span class='Ref_to_Macro'>RelationGetDescr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3516"><span class='Ref_to_Parameter'>rel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN3520"></a>    <span class='Keyword'>const </span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Operator'>*</span><span class='Declare_Local'>attnums</span><span class='Delimiter'>; 
</span><a name="LN3521"></a>    <span class='Keyword'>const </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Operator'>*</span><span class='Declare_Local'>eq_oprs</span><span class='Delimiter'>; 
</span><a name="LN3522"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>rel_is_pk</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3520"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN121"><span class='Ref_to_Member'>pk_attnums</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3521"><span class='Ref_To_Local'>eq_oprs</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN125"><span class='Ref_to_Member'>pp_eq_oprs</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3520"><span class='Ref_To_Local'>attnums</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN122"><span class='Ref_to_Member'>fk_attnums</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3521"><span class='Ref_To_Local'>eq_oprs</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN127"><span class='Ref_to_Member'>ff_eq_oprs</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="ri_triggers.c.html#LN3517"><span class='Ref_to_Parameter'>riinfo</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN120"><span class='Ref_to_Member'>nkeys</span></a><span class='Delimiter'>; </span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3537"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>oldvalue</span><span class='Delimiter'>; 
</span><a name="LN3538"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>newvalue</span><span class='Delimiter'>; 
</span><a name="LN3539"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isnull</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get one attribute's oldvalue. If it is NULL - they're not equal. 
         */ 
</span>        <a href="ri_triggers.c.html#LN3537"><span class='Ref_To_Local'>oldvalue</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3516"><span class='Ref_to_Parameter'>oldtup</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3520"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ri_triggers.c.html#LN3519"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3539"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3539"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get one attribute's newvalue. If it is NULL - they're not equal. 
         */ 
</span>        <a href="ri_triggers.c.html#LN3538"><span class='Ref_To_Local'>newvalue</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN768"><span class='Ref_to_Macro'>heap_getattr</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3516"><span class='Ref_to_Parameter'>newtup</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3520"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ri_triggers.c.html#LN3519"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3539"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3539"><span class='Ref_To_Local'>isnull</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Compare them with the appropriate equality operator. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN219"><span class='Ref_to_Proto'>ri_AttributesEqual</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3521"><span class='Ref_To_Local'>eq_oprs</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>], </span><a href="ri_triggers.c.html#LN94"><span class='Ref_to_Macro'>RIAttType</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3516"><span class='Ref_to_Parameter'>rel</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3520"><span class='Ref_To_Local'>attnums</span></a><span class='Delimiter'>[</span><a href="ri_triggers.c.html#LN3522"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="ri_triggers.c.html#LN3537"><span class='Ref_To_Local'>oldvalue</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3538"><span class='Ref_To_Local'>newvalue</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;riinfo-&GT;nkeys;i... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_KeysEqual &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_AttributesEqual - 
 * 
 *  Call the appropriate equality comparison operator for two values. 
 * 
 *  NB: we have already checked that neither value is null. 
 * ---------- 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN3576"></a><span class='Declare_Function'>ri_AttributesEqual</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>eq_opr</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeid</span><span class='Delimiter'>, 
</span><a name="LN3577"></a>                   <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>oldvalue</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>newvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3579"></a>    <a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN226"><span class='Ref_to_Proto'>ri_HashCompareOp</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3576"><span class='Ref_to_Parameter'>eq_opr</span></a><span class='Delimiter'>, </span><span class='Keyword'>typeid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do we need to cast the values? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3579"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN179"><span class='Ref_to_Member'>cast_func_finfo</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>oldvalue</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN605"><span class='Ref_to_Macro'>FunctionCall3</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3579"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN179"><span class='Ref_to_Member'>cast_func_finfo</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>oldvalue</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* typmod */ 
</span>                                 <a href="../../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>))</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* implicit coercion */ 
</span>        <a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>newvalue</span></a> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN605"><span class='Ref_to_Macro'>FunctionCall3</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3579"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN179"><span class='Ref_to_Member'>cast_func_finfo</span></a><span class='Delimiter'>, 
</span>                                 <a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>newvalue</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/postgres.h.html#LN484"><span class='Ref_to_Macro'>Int32GetDatum</span></a><span class='Parentheses'>(</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* typmod */ 
</span>                                 <a href="../../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>))</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* implicit coercion */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Apply the comparison operator.  We assume it doesn't care about 
     * collations. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../../include/postgres.h.html#LN398"><span class='Ref_to_Macro'>DatumGetBool</span></a><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN603"><span class='Ref_to_Macro'>FunctionCall2</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3579"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN178"><span class='Ref_to_Member'>eq_opr_finfo</span></a><span class='Delimiter'>, 
</span>                                      <a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>oldvalue</span></a><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3577"><span class='Ref_to_Parameter'>newvalue</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_AttributesEqual &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * ri_HashCompareOp - 
 * 
 *  See if we know how to compare two values, and create a new hash entry 
 *  if not. 
 * ---------- 
 */ 
</span><span class='Keyword'>static </span><a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a> <span class='Operator'>* 
</span><a name="LN3610"></a><span class='Declare_Function'>ri_HashCompareOp</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>eq_opr</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>typeid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN3612"></a>    <a href="ri_triggers.c.html#LN163"><span class='Ref_to_Struct'>RI_CompareKey</span></a> <span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span><a name="LN3613"></a>    <a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>entry</span><span class='Delimiter'>; 
</span><a name="LN3614"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * On the first call initialize the hashtable 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN189"><span class='Ref_to_Global_Var'>ri_compare_cache</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN222"><span class='Ref_to_Proto'>ri_InitHashTables</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Find or create a hash entry.  Note we're assuming RI_CompareKey 
     * contains no struct padding. 
     */ 
</span>    <a href="ri_triggers.c.html#LN3612"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><a href="ri_triggers.c.html#LN165"><span class='Ref_to_Member'>eq_opr</span></a> <span class='Operator'>= </span><a href="ri_triggers.c.html#LN3610"><span class='Ref_to_Parameter'>eq_opr</span></a><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3612"><span class='Ref_To_Local'>key</span></a><span class='Operator'>.</span><span class='Keyword'>typeid </span><span class='Operator'>= </span><span class='Keyword'>typeid</span><span class='Delimiter'>; 
</span>    <a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN174"><span class='Ref_to_Struct'>RI_CompareHashEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN189"><span class='Ref_to_Global_Var'>ri_compare_cache</span></a><span class='Delimiter'>, 
</span>                                                <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3612"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, 
</span>                                                <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3614"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN3614"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN177"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If not already initialized, do so.  Since we'll keep this hash entry 
     * for the life of the backend, put any subsidiary info for the function 
     * cache structs into TopMemoryContext. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN177"><span class='Ref_to_Member'>valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN3641"></a>        <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>lefttype</span><span class='Delimiter'>, 
</span><a name="LN3642"></a>                    <span class='Declare_Local'>righttype</span><span class='Delimiter'>, 
</span><a name="LN3643"></a>                    <span class='Declare_Local'>castfunc</span><span class='Delimiter'>; 
</span><a name="LN3644"></a>        <a href="../../../include/parser/parse_coerce.h.html#LN23"><span class='Ref_to_Enum'>CoercionPathType</span></a> <span class='Declare_Local'>pathtype</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We always need to know how to call the equality operator */ 
</span>        <a href="../../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/lsyscache.h.html#LN98"><span class='Ref_to_Proto'>get_opcode</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3610"><span class='Ref_to_Parameter'>eq_opr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN178"><span class='Ref_to_Member'>eq_opr_finfo</span></a><span class='Delimiter'>, 
</span>                      <a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we chose to use a cast from FK to PK type, we may have to apply 
         * the cast function to get to the operator's input type. 
         * 
         * XXX eventually it would be good to support array-coercion cases 
         * here and in ri_AttributesEqual().  At the moment there is no point 
         * because cases involving nonidentical array types will be rejected 
         * at constraint creation time. 
         * 
         * XXX perhaps also consider supporting CoerceViaIO?  No need at the 
         * moment since that will never be generated for implicit coercions. 
         */ 
</span>        <a href="../../../include/utils/lsyscache.h.html#LN101"><span class='Ref_to_Proto'>op_input_types</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3610"><span class='Ref_to_Parameter'>eq_opr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3642"><span class='Ref_To_Local'>righttype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a> <span class='Operator'>== </span><a href="ri_triggers.c.html#LN3642"><span class='Ref_To_Local'>righttype</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>typeid </span><span class='Operator'>== </span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a><span class='Parentheses'>) 
</span>            <a href="ri_triggers.c.html#LN3643"><span class='Ref_To_Local'>castfunc</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* simplest case */ 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="ri_triggers.c.html#LN3644"><span class='Ref_To_Local'>pathtype</span></a> <span class='Operator'>= </span><a href="../../../include/parser/parse_coerce.h.html#LN86"><span class='Ref_to_Proto'>find_coercion_pathway</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a><span class='Delimiter'>, </span><span class='Keyword'>typeid</span><span class='Delimiter'>, 
</span>                                             <a href="../../../include/nodes/primnodes.h.html#LN420"><span class='Ref_to_EnumConst'>COERCION_IMPLICIT</span></a><span class='Delimiter'>, 
</span>                                             <span class='Operator'>&</span><a href="ri_triggers.c.html#LN3643"><span class='Ref_To_Local'>castfunc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3644"><span class='Ref_To_Local'>pathtype</span></a> <span class='Operator'>!= </span><a href="../../../include/parser/parse_coerce.h.html#LN26"><span class='Ref_to_EnumConst'>COERCION_PATH_FUNC</span></a> <span class='Operator'>&& 
</span>                <a href="ri_triggers.c.html#LN3644"><span class='Ref_To_Local'>pathtype</span></a> <span class='Operator'>!= </span><a href="../../../include/parser/parse_coerce.h.html#LN27"><span class='Ref_to_EnumConst'>COERCION_PATH_RELABELTYPE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * The declared input type of the eq_opr might be a 
                 * polymorphic type such as ANYARRAY or ANYENUM, or other 
                 * special cases such as RECORD; find_coercion_pathway 
                 * currently doesn't subsume these special cases. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/parser/parse_coerce.h.html#LN33"><span class='Ref_to_Proto'>IsBinaryCoercible</span></a><span class='Parentheses'>(</span><span class='Keyword'>typeid</span><span class='Delimiter'>, </span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no conversion function from %s to %s"</span><span class='Delimiter'>, 
</span>                         <a href="format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><span class='Keyword'>typeid</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="format_type.c.html#LN92"><span class='Ref_to_Func'>format_type_be</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3641"><span class='Ref_To_Local'>lefttype</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3643"><span class='Ref_To_Local'>castfunc</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/fmgr.h.html#LN99"><span class='Ref_to_Proto'>fmgr_info_cxt</span></a><span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3643"><span class='Ref_To_Local'>castfunc</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN179"><span class='Ref_to_Member'>cast_func_finfo</span></a><span class='Delimiter'>, 
</span>                          <a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN179"><span class='Ref_to_Member'>cast_func_finfo</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN58"><span class='Ref_to_Member'>fn_oid</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Operator'>-&GT;</span><a href="ri_triggers.c.html#LN177"><span class='Ref_to_Member'>valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !entry-&GT;valid &raquo; </span> 
 
    <span class='Control'>return</span> <a href="ri_triggers.c.html#LN3613"><span class='Ref_To_Local'>entry</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ri_HashCompareOp &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Given a trigger function OID, determine whether it is an RI trigger, 
 * and if so whether it is attached to PK or FK relation. 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN3703"></a><span class='Declare_Function'>RI_FKey_trigger_type</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tgfoid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="ri_triggers.c.html#LN3703"><span class='Ref_to_Parameter'>tgfoid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> F_RI_FKEY_CASCADE_DEL<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_CASCADE_UPD<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_RESTRICT_DEL<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_RESTRICT_UPD<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_SETNULL_DEL<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_SETNULL_UPD<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_SETDEFAULT_DEL<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_SETDEFAULT_UPD<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_NOACTION_DEL<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_NOACTION_UPD<span class='Operator'>: 
</span>            <span class='Control'>return</span> <a href="../../../include/commands/trigger.h.html#LN208"><span class='Ref_to_Const'>RI_TRIGGER_PK</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> F_RI_FKEY_CHECK_INS<span class='Operator'>: 
</span>        <span class='Control'>case</span> F_RI_FKEY_CHECK_UPD<span class='Operator'>: 
</span>            <span class='Control'>return</span> <a href="../../../include/commands/trigger.h.html#LN209"><span class='Ref_to_Const'>RI_TRIGGER_FK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="../../../include/commands/trigger.h.html#LN210"><span class='Ref_to_Const'>RI_TRIGGER_NONE</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RI_FKey_trigger_type &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>