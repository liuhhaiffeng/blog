<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\cache\inval.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\cache\inval.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:55 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * inval.c 
 *    POSTGRES cache invalidation dispatcher code. 
 * 
 *  This is subtle stuff, so pay attention: 
 * 
 *  When a tuple is updated or deleted, our standard time qualification rules 
 *  consider that it is *still valid* so long as we are in the same command, 
 *  ie, until the next CommandCounterIncrement() or transaction commit. 
 *  (See utils/time/tqual.c, and note that system catalogs are generally 
 *  scanned under the most current snapshot available, rather than the 
 *  transaction snapshot.)  At the command boundary, the old tuple stops 
 *  being valid and the new version, if any, becomes valid.  Therefore, 
 *  we cannot simply flush a tuple from the system caches during heap_update() 
 *  or heap_delete().  The tuple is still good at that point; what's more, 
 *  even if we did flush it, it might be reloaded into the caches by a later 
 *  request in the same command.  So the correct behavior is to keep a list 
 *  of outdated (updated/deleted) tuples and then do the required cache 
 *  flushes at the next command boundary.  We must also keep track of 
 *  inserted tuples so that we can flush "negative" cache entries that match 
 *  the new tuples; again, that mustn't happen until end of command. 
 * 
 *  Once we have finished the command, we still need to remember inserted 
 *  tuples (including new versions of updated tuples), so that we can flush 
 *  them from the caches if we abort the transaction.  Similarly, we'd better 
 *  be able to flush "negative" cache entries that may have been loaded in 
 *  place of deleted tuples, so we still need the deleted ones too. 
 * 
 *  If we successfully complete the transaction, we have to broadcast all 
 *  these invalidation events to other backends (via the SI message queue) 
 *  so that they can flush obsolete entries from their caches.  Note we have 
 *  to record the transaction commit before sending SI messages, otherwise 
 *  the other backends won't see our updated tuples as good. 
 * 
 *  When a subtransaction aborts, we can process and discard any events 
 *  it has queued.  When a subtransaction commits, we just add its events 
 *  to the pending lists of the parent transaction. 
 * 
 *  In short, we need to remember until xact end every insert or delete 
 *  of a tuple that might be in the system caches.  Updates are treated as 
 *  two events, delete + insert, for simplicity.  (If the update doesn't 
 *  change the tuple hash value, catcache.c optimizes this into one event.) 
 * 
 *  We do not need to register EVERY tuple operation in this way, just those 
 *  on tuples in relations that have associated catcaches.  We do, however, 
 *  have to register every operation on every tuple that *could* be in a 
 *  catcache, whether or not it currently is in our cache.  Also, if the 
 *  tuple is in a relation that has multiple catcaches, we need to register 
 *  an invalidation message for each such catcache.  catcache.c's 
 *  PrepareToInvalidateCacheTuple() routine provides the knowledge of which 
 *  catcaches may need invalidation for a given tuple. 
 * 
 *  Also, whenever we see an operation on a pg_class, pg_attribute, or 
 *  pg_index tuple, we register a relcache flush operation for the relation 
 *  described by that tuple (as specified in CacheInvalidateHeapTuple()). 
 * 
 *  We keep the relcache flush requests in lists separate from the catcache 
 *  tuple flush requests.  This allows us to issue all the pending catcache 
 *  flushes before we issue relcache flushes, which saves us from loading 
 *  a catcache tuple during relcache load only to flush it again right away. 
 *  Also, we avoid queuing multiple relcache flush requests for the same 
 *  relation, since a relcache flush is relatively expensive to do. 
 *  (XXX is it worth testing likewise for duplicate catcache flush entries? 
 *  Probably not.) 
 * 
 *  If a relcache flush is issued for a system relation that we preload 
 *  from the relcache init file, we must also delete the init file so that 
 *  it will be rebuilt during the next backend restart.  The actual work of 
 *  manipulating the init file is in relcache.c, but we keep track of the 
 *  need for it here. 
 * 
 *  The request lists proper are kept in CurTransactionContext of their 
 *  creating (sub)transaction, since they can be forgotten on abort of that 
 *  transaction but must be kept till top-level commit otherwise.  For 
 *  simplicity we keep the controlling list-of-lists in TopTransactionContext. 
 * 
 *  Currently, inval messages are sent without regard for the possibility 
 *  that the object described by the catalog tuple might be a session-local 
 *  object such as a temporary table.  This is because (1) this code has 
 *  no practical way to tell the difference, and (2) it is not certain that 
 *  other backends don't have catalog cache or even relcache entries for 
 *  such tables, anyway; there is nothing that prevents that.  It might be 
 *  worth trying to avoid sending such inval traffic in the future, if those 
 *  problems can be overcome cheaply. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/cache/inval.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/smgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/catcache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memdebug.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/relmapper.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * To minimize palloc traffic, we keep pending requests in successively- 
 * larger chunks (a slightly more sophisticated version of an expansible 
 * array).  All request types can be stored as SharedInvalidationMessage 
 * records.  The ordering of requests within a list is never significant. 
 */ 
</span><a name="LN121"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>InvalidationChunk</span> 
<span class='Delimiter'>{ 
</span><a name="LN123"></a>    <span class='Control'>struct</span> <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* list link */ 
</span><a name="LN124"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nitems</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* # items currently stored in chunk */ 
</span><a name="LN125"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>maxitems</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* size of allocated array in this chunk */ 
</span><a name="LN126"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Member'>msgs</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN127"></a>} <span class='Declare_Typedef'>InvalidationChunk</span><span class='Delimiter'>; 
</span> 
<a name="LN129"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>InvalidationListHeader</span> 
<span class='Delimiter'>{ 
</span><a name="LN131"></a>    <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>cclist</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* list of chunks holding catcache msgs */ 
</span><a name="LN132"></a>    <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Declare_Member'>rclist</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* list of chunks holding relcache msgs */ 
</span><a name="LN133"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>InvalidationListHeader</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/*---------------- 
 * Invalidation info is divided into two lists: 
 *  1) events so far in current command, not yet reflected to caches. 
 *  2) events in previous commands of current transaction; these have 
 *     been reflected to local caches, and must be either broadcast to 
 *     other backends or rolled back from local cache when we commit 
 *     or abort the transaction. 
 * Actually, we need two such lists for each level of nested transaction, 
 * so that we can discard events from an aborted subtransaction.  When 
 * a subtransaction commits, we append its lists to the parent's lists. 
 * 
 * The relcache-file-invalidated flag can just be a simple boolean, 
 * since we only act on it at transaction commit; we don't care which 
 * command of the transaction set it. 
 *---------------- 
 */ 
</span> 
<a name="LN152"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TransInvalidationInfo</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Back link to parent transaction's info */ 
</span><a name="LN155"></a>    <span class='Control'>struct</span> <a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a> <span class='Operator'>*</span><span class='Declare_Member'>parent</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Subtransaction nesting depth */ 
</span><a name="LN158"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>my_level</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* head of current-command event list */ 
</span><a name="LN161"></a>    <a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Declare_Member'>CurrentCmdInvalidMsgs</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* head of previous-commands event list */ 
</span><a name="LN164"></a>    <a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Declare_Member'>PriorCmdInvalidMsgs</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* init file must be invalidated? */ 
</span><a name="LN167"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>RelcacheInitFileInval</span><span class='Delimiter'>; 
</span><a name="LN168"></a>} <span class='Declare_Typedef'>TransInvalidationInfo</span><span class='Delimiter'>; 
</span> 
<a name="LN170"></a><span class='Keyword'>static </span><a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a> <span class='Operator'>*</span><span class='Declare_Var'>transInvalInfo</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN172"></a><span class='Keyword'>static </span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Var'>SharedInvalidMessagesArray</span><span class='Delimiter'>; 
</span><a name="LN173"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>numSharedInvalidMessagesArray</span><span class='Delimiter'>; 
</span><a name="LN174"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>maxSharedInvalidMessagesArray</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Dynamically-registered callback functions.  Current implementation 
 * assumes there won't be enough of these to justify a dynamically resizable 
 * array; it'd be easy to improve that if needed. 
 * 
 * To avoid searching in CallSyscacheCallbacks, all callbacks for a given 
 * syscache are linked into a list pointed to by syscache_callback_links[id]. 
 * The link values are syscache_callback_list[] index plus 1, or 0 for none. 
 */ 
</span> 
<a name="LN187"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_SYSCACHE_CALLBACKS</span> <span class='Number'>64</span> 
<a name="LN188"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_RELCACHE_CALLBACKS</span> <span class='Number'>10</span> 
 
<a name="LN190"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <span class='Declare_Struct'>SYSCACHECALLBACK</span> 
<span class='Delimiter'>{ 
</span><a name="LN192"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>id</span><span class='Delimiter'>;</span>             <span class='Comment_Single_Line'>/* cache number */ 
</span><a name="LN193"></a>    <a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a>       <span class='Declare_Member'>link</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* next callback index+1 for same cache */ 
</span><a name="LN194"></a>    <a href="../../../include/utils/inval.h.html#LN21"><span class='Ref_to_Typedef'>SyscacheCallbackFunction</span></a> <span class='Declare_Member'>function</span><span class='Delimiter'>; 
</span><a name="LN195"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Member'>arg</span><span class='Delimiter'>; 
</span><a name="LN196"></a>}   <span class='Declare_Var'>syscache_callback_list</span><span class='Delimiter'>[</span><a href="inval.c.html#LN187"><span class='Ref_to_Const'>MAX_SYSCACHE_CALLBACKS</span></a><span class='Delimiter'>]; 
</span> 
<a name="LN198"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN254"><span class='Ref_to_Typedef'>int16</span></a> <span class='Declare_Var'>syscache_callback_links</span><span class='Delimiter'>[</span>SysCacheSize<span class='Delimiter'>]; 
</span> 
<a name="LN200"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>syscache_callback_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN202"></a><span class='Keyword'>static </span><span class='Control'>struct</span> <span class='Declare_Struct'>RELCACHECALLBACK</span> 
<span class='Delimiter'>{ 
</span><a name="LN204"></a>    <a href="../../../include/utils/inval.h.html#LN22"><span class='Ref_to_Typedef'>RelcacheCallbackFunction</span></a> <span class='Declare_Member'>function</span><span class='Delimiter'>; 
</span><a name="LN205"></a>    <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Member'>arg</span><span class='Delimiter'>; 
</span><a name="LN206"></a>}   <span class='Declare_Var'>relcache_callback_list</span><span class='Delimiter'>[</span><a href="inval.c.html#LN188"><span class='Ref_to_Const'>MAX_RELCACHE_CALLBACKS</span></a><span class='Delimiter'>]; 
</span> 
<a name="LN208"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>relcache_callback_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *              Invalidation list support functions 
 * 
 * These three routines encapsulate processing of the "chunked" 
 * representation of what is logically just a list of messages. 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AddInvalidationMessage 
 *      Add an invalidation message to a list (of chunks). 
 * 
 * Note that we do not pay any great attention to maintaining the original 
 * ordering of the messages. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN226"></a><span class='Declare_Function'>AddInvalidationMessage</span><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>listHdr</span><span class='Delimiter'>, 
</span><a name="LN227"></a>                       <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN229"></a>    <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= *</span><a href="inval.c.html#LN226"><span class='Ref_to_Parameter'>listHdr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* First time through; create initial chunk */ 
</span><a name="LN234"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FIRSTCHUNKSIZE</span> <span class='Number'>32</span> 
        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a><span class='Delimiter'>, </span>msgs<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                         <a href="inval.c.html#LN234"><span class='Ref_to_Const'>FIRSTCHUNKSIZE</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN124"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN125"><span class='Ref_to_Member'>maxitems</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN234"><span class='Ref_to_Const'>FIRSTCHUNKSIZE</span></a><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN123"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= *</span><a href="inval.c.html#LN226"><span class='Ref_to_Parameter'>listHdr</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="inval.c.html#LN226"><span class='Ref_to_Parameter'>listHdr</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN124"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>&GT;= </span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN125"><span class='Ref_to_Member'>maxitems</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Need another chunk; double size of last chunk */ 
</span><a name="LN247"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>chunksize</span> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN125"><span class='Ref_to_Member'>maxitems</span></a><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a><span class='Delimiter'>, </span>msgs<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                               <a href="inval.c.html#LN247"><span class='Ref_To_Local'>chunksize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN124"><span class='Ref_to_Member'>nitems</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN125"><span class='Ref_to_Member'>maxitems</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN247"><span class='Ref_To_Local'>chunksize</span></a><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN123"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= *</span><a href="inval.c.html#LN226"><span class='Ref_to_Parameter'>listHdr</span></a><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="inval.c.html#LN226"><span class='Ref_to_Parameter'>listHdr</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Okay, add message to current chunk */ 
</span>    <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN126"><span class='Ref_to_Member'>msgs</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN124"><span class='Ref_to_Member'>nitems</span></a><span class='Delimiter'>] </span><span class='Operator'>= *</span><a href="inval.c.html#LN227"><span class='Ref_to_Parameter'>msg</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN229"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN124"><span class='Ref_to_Member'>nitems</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddInvalidationMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Append one list of invalidation message chunks to another, resetting 
 * the source chunk-list pointer to NULL. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN268"></a><span class='Declare_Function'>AppendInvalidationMessageList</span><span class='Parentheses'>(</span><a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>destHdr</span><span class='Delimiter'>, 
</span><a name="LN269"></a>                              <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>srcHdr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN271"></a>    <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span><span class='Declare_Local'>chunk</span> <span class='Operator'>= *</span><a href="inval.c.html#LN269"><span class='Ref_to_Parameter'>srcHdr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN271"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN271"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN123"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="inval.c.html#LN271"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN271"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN123"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN271"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN123"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= *</span><a href="inval.c.html#LN268"><span class='Ref_to_Parameter'>destHdr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="inval.c.html#LN268"><span class='Ref_to_Parameter'>destHdr</span></a> <span class='Operator'>= *</span><a href="inval.c.html#LN269"><span class='Ref_to_Parameter'>srcHdr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="inval.c.html#LN269"><span class='Ref_to_Parameter'>srcHdr</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Process a list of invalidation messages. 
 * 
 * This is a macro that executes the given code fragment for each message in 
 * a message chunk list.  The fragment should refer to the message as *msg. 
 */ 
</span><a name="LN292"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ProcessMessageList</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>listHdr</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>codeFragment</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span>_chunk<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span>_chunk <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN292"><span class='Ref_to_Parameter'>listHdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span>_chunk <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span>_chunk <span class='Operator'>= </span>_chunk<span class='Operator'>-&GT;</span>next<span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>        <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>            <span class='Keyword'>int</span>     _cindex<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span>_cindex <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span>_cindex <span class='Operator'>&LT; </span>_chunk<span class='Operator'>-&GT;</span>nitems<span class='Delimiter'>; </span>_cindex<span class='Operator'>++</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>                <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span>msg <span class='Operator'>= &</span>_chunk<span class='Operator'>-&GT;</span>msgs<span class='Delimiter'>[</span>_cindex<span class='Delimiter'>]; </span><span class='Operator'>\ 
</span>                <a href="inval.c.html#LN292"><span class='Ref_to_Parameter'>codeFragment</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>            <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>        <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Process a list of invalidation messages group-wise. 
 * 
 * As above, but the code fragment can handle an array of messages. 
 * The fragment should refer to the messages as msgs[], with n entries. 
 */ 
</span><a name="LN312"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ProcessMessageListMulti</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>listHdr</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>codeFragment</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>        <a href="inval.c.html#LN121"><span class='Ref_to_Struct'>InvalidationChunk</span></a> <span class='Operator'>*</span>_chunk<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span>_chunk <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN312"><span class='Ref_to_Parameter'>listHdr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span>_chunk <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span>_chunk <span class='Operator'>= </span>_chunk<span class='Operator'>-&GT;</span>next<span class='Parentheses'>)</span> <span class='Operator'>\ 
</span>        <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>            <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span>msgs <span class='Operator'>= </span>_chunk<span class='Operator'>-&GT;</span>msgs<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>            <span class='Keyword'>int</span>     n <span class='Operator'>= </span>_chunk<span class='Operator'>-&GT;</span>nitems<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>            <a href="inval.c.html#LN312"><span class='Ref_to_Parameter'>codeFragment</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>        <span class='Delimiter'>} </span><span class='Operator'>\ 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *              Invalidation set support functions 
 * 
 * These routines understand about the division of a logical invalidation 
 * list into separate physical lists for catcache and relcache entries. 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add a catcache inval entry 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN336"></a><span class='Declare_Function'>AddCatcacheInvalidationMessage</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN337"></a>                               <span class='Keyword'>int </span><span class='Declare_Parameter'>id</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashValue</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN339"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN337"><span class='Ref_to_Parameter'>id</span></a> <span class='Operator'>&LT; </span>CHAR_MAX<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN61"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN253"><span class='Ref_to_Typedef'>int8</span></a><span class='Parentheses'>) </span><a href="inval.c.html#LN337"><span class='Ref_to_Parameter'>id</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN62"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN337"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN63"><span class='Ref_to_Member'>hashValue</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN337"><span class='Ref_to_Parameter'>hashValue</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Define padding bytes in SharedInvalidationMessage structs to be 
     * defined. Otherwise the sinvaladt.c ringbuffer, which is accessed by 
     * multiple processes, will cause spurious valgrind warnings about 
     * undefined memory being used. That's because valgrind remembers the 
     * undefined bytes from the last local process's store, not realizing that 
     * another process has written since, filling the previously uninitialized 
     * bytes 
     */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN225"><span class='Ref_to_Func'>AddInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN336"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN339"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddCatcacheInvalidationMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a whole-catalog inval entry 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN364"></a><span class='Declare_Function'>AddCatalogInvalidationMessage</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN365"></a>                              <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>catId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN367"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN70"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN66"><span class='Ref_to_Const'>SHAREDINVALCATALOG_ID</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN71"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN365"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN72"><span class='Ref_to_Member'>catId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN365"><span class='Ref_to_Parameter'>catId</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check AddCatcacheInvalidationMessage() for an explanation */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN225"><span class='Ref_to_Func'>AddInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN364"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN367"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Add a relcache inval entry 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN382"></a><span class='Declare_Function'>AddRelcacheInvalidationMessage</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN383"></a>                               <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN385"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't add a duplicate item. We assume dbId need not be checked because 
     * it will never change. InvalidOid for relId means all relations so we 
     * don't need to add individual ones when it is present. 
     */ 
</span>    <a href="inval.c.html#LN292"><span class='Ref_to_Macro'>ProcessMessageList</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN382"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, 
</span>                       <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN79"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN75"><span class='Ref_to_Const'>SHAREDINVALRELCACHE_ID</span></a> <span class='Operator'>&& 
</span>                           <span class='Parentheses'>(</span><a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>== </span><a href="inval.c.html#LN383"><span class='Ref_to_Parameter'>relId</span></a> <span class='Operator'>|| 
</span>                            <a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>))</span> 
                       <span class='Control'>return</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, add the item */ 
</span>    <a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN79"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN75"><span class='Ref_to_Const'>SHAREDINVALRELCACHE_ID</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN80"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN383"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN383"><span class='Ref_to_Parameter'>relId</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check AddCatcacheInvalidationMessage() for an explanation */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN225"><span class='Ref_to_Func'>AddInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN382"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN385"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddRelcacheInvalidationMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a snapshot inval entry 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN412"></a><span class='Declare_Function'>AddSnapshotInvalidationMessage</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN413"></a>                               <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN415"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't add a duplicate item */ 
</span>    <span class='Comment_Multi_Line'>/* We assume dbId need not be checked because it will never change */ 
</span>    <a href="inval.c.html#LN292"><span class='Ref_to_Macro'>ProcessMessageList</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN412"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, 
</span>                       <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN120"><span class='Ref_to_Member'>sn</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN107"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN103"><span class='Ref_to_Const'>SHAREDINVALSNAPSHOT_ID</span></a> <span class='Operator'>&& 
</span>                           <a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN120"><span class='Ref_to_Member'>sn</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN109"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>== </span><a href="inval.c.html#LN413"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>) 
</span>                       <span class='Control'>return</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, add the item */ 
</span>    <a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN120"><span class='Ref_to_Member'>sn</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN107"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN103"><span class='Ref_to_Const'>SHAREDINVALSNAPSHOT_ID</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN120"><span class='Ref_to_Member'>sn</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN108"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN413"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN120"><span class='Ref_to_Member'>sn</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN109"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN413"><span class='Ref_to_Parameter'>relId</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check AddCatcacheInvalidationMessage() for an explanation */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN225"><span class='Ref_to_Func'>AddInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN412"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN415"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AddSnapshotInvalidationMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Append one list of invalidation messages to another, resetting 
 * the source list to empty. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN439"></a><span class='Declare_Function'>AppendInvalidationMessages</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest</span><span class='Delimiter'>, 
</span><a name="LN440"></a>                           <a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN267"><span class='Ref_to_Func'>AppendInvalidationMessageList</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN439"><span class='Ref_to_Parameter'>dest</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN440"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN267"><span class='Ref_to_Func'>AppendInvalidationMessageList</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN439"><span class='Ref_to_Parameter'>dest</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="inval.c.html#LN440"><span class='Ref_to_Parameter'>src</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Execute the given function for all the messages in an invalidation list. 
 * The list is not altered. 
 * 
 * catcache entries are processed first, for reasons mentioned above. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN453"></a><span class='Declare_Function'>ProcessInvalidationMessages</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN454"></a>                            <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>func</span><span class='Parentheses'>) (</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span>msg<span class='Parentheses'>))</span> 
<span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN292"><span class='Ref_to_Macro'>ProcessMessageList</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN453"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN454"><span class='Ref_to_Parameter'>func</span></a><span class='Parentheses'>(</span>msg<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN292"><span class='Ref_to_Macro'>ProcessMessageList</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN453"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN454"><span class='Ref_to_Parameter'>func</span></a><span class='Parentheses'>(</span>msg<span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * As above, but the function is able to process an array of messages 
 * rather than just one at a time. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN465"></a><span class='Declare_Function'>ProcessInvalidationMessagesMulti</span><span class='Parentheses'>(</span><a href="inval.c.html#LN129"><span class='Ref_to_Struct'>InvalidationListHeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hdr</span><span class='Delimiter'>, 
</span><a name="LN466"></a>                 <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Parameter'>func</span><span class='Parentheses'>) (</span><span class='Keyword'>const </span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span>msgs<span class='Delimiter'>, </span><span class='Keyword'>int </span>n<span class='Parentheses'>))</span> 
<span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN312"><span class='Ref_to_Macro'>ProcessMessageListMulti</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN465"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN131"><span class='Ref_to_Member'>cclist</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN466"><span class='Ref_to_Parameter'>func</span></a><span class='Parentheses'>(</span>msgs<span class='Delimiter'>, </span>n<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN312"><span class='Ref_to_Macro'>ProcessMessageListMulti</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN465"><span class='Ref_to_Parameter'>hdr</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN132"><span class='Ref_to_Member'>rclist</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN466"><span class='Ref_to_Parameter'>func</span></a><span class='Parentheses'>(</span>msgs<span class='Delimiter'>, </span>n<span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                    private support functions 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RegisterCatcacheInvalidation 
 * 
 * Register an invalidation event for a catcache tuple entry. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN483"></a><span class='Declare_Function'>RegisterCatcacheInvalidation</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheId</span><span class='Delimiter'>, 
</span><a name="LN484"></a>                             <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashValue</span><span class='Delimiter'>, 
</span><a name="LN485"></a>                             <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN335"><span class='Ref_to_Func'>AddCatcacheInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                   <a href="inval.c.html#LN483"><span class='Ref_to_Parameter'>cacheId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN484"><span class='Ref_to_Parameter'>hashValue</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN485"><span class='Ref_to_Parameter'>dbId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RegisterCatalogInvalidation 
 * 
 * Register an invalidation event for all catcache entries from a catalog. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN497"></a><span class='Declare_Function'>RegisterCatalogInvalidation</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>catId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN363"><span class='Ref_to_Func'>AddCatalogInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                  <a href="inval.c.html#LN497"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN497"><span class='Ref_to_Parameter'>catId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RegisterRelcacheInvalidation 
 * 
 * As above, but register a relcache invalidation event. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN509"></a><span class='Declare_Function'>RegisterRelcacheInvalidation</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN381"><span class='Ref_to_Func'>AddRelcacheInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                   <a href="inval.c.html#LN509"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN509"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Most of the time, relcache invalidation is associated with system 
     * catalog updates, but there are a few cases where it isn't.  Quick hack 
     * to ensure that the next CommandCounterIncrement() will think that we 
     * need to do CommandEndInvalidationMessages(). 
     */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the relation being invalidated is one of those cached in the local 
     * relcache init file, mark that we need to zap that file at commit. Same 
     * is true when we are invalidating whole relcache. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN509"><span class='Ref_to_Parameter'>dbId</span></a><span class='Parentheses'>)</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN126"><span class='Ref_to_Proto'>RelationIdIsInInitFile</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN509"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="inval.c.html#LN509"><span class='Ref_to_Parameter'>relId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>))</span> 
        <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RegisterRelcacheInvalidation &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RegisterSnapshotInvalidation 
 * 
 * Register an invalidation event for MVCC scans against a given catalog. 
 * Only needed for catalogs that don't have catcaches. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN539"></a><span class='Declare_Function'>RegisterSnapshotInvalidation</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbId</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN411"><span class='Ref_to_Func'>AddSnapshotInvalidationMessage</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                   <a href="inval.c.html#LN539"><span class='Ref_to_Parameter'>dbId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN539"><span class='Ref_to_Parameter'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * LocalExecuteInvalidationMessage 
 * 
 * Process a single invalidation message (which could be of any type). 
 * Only the local caches are flushed; this does not transmit the message 
 * to other backends. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN553"></a><span class='Declare_Function'>LocalExecuteInvalidationMessage</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN62"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>|| </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN62"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/syscache.h.html#LN144"><span class='Ref_to_Proto'>SysCacheInvalidate</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN61"><span class='Ref_to_Member'>id</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN63"><span class='Ref_to_Member'>hashValue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/inval.h.html#LN62"><span class='Ref_to_Proto'>CallSyscacheCallbacks</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN61"><span class='Ref_to_Member'>id</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN115"><span class='Ref_to_Member'>cc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN63"><span class='Ref_to_Member'>hashValue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN66"><span class='Ref_to_Const'>SHAREDINVALCATALOG_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN71"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>|| </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN71"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/utils/catcache.h.html#LN191"><span class='Ref_to_Proto'>CatalogCacheFlushCatalog</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN116"><span class='Ref_to_Member'>cat</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN72"><span class='Ref_to_Member'>catId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* CatalogCacheFlushCatalog calls CallSyscacheCallbacks as needed */ 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN75"><span class='Ref_to_Const'>SHAREDINVALRELCACHE_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN80"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a> <span class='Operator'>|| </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN80"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN581"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/relcache.h.html#LN115"><span class='Ref_to_Proto'>RelationCacheInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/utils/relcache.h.html#LN113"><span class='Ref_to_Proto'>RelationCacheInvalidateEntry</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN581"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="inval.c.html#LN581"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a><span class='Delimiter'>; </span><a href="inval.c.html#LN581"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN590"></a>                <span class='Control'>struct</span> <a href="inval.c.html#LN202"><span class='Ref_to_Struct'>RELCACHECALLBACK</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ccitem</span> <span class='Operator'>= </span><a href="inval.c.html#LN206"><span class='Ref_to_Global_Var'>relcache_callback_list</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN581"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
                <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="inval.c.html#LN590"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN204"><span class='Ref_to_Member'>function</span></a><span class='Parentheses'>) (</span><a href="inval.c.html#LN590"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN205"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN117"><span class='Ref_to_Member'>rc</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN81"><span class='Ref_to_Member'>relId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN84"><span class='Ref_to_Const'>SHAREDINVALSMGR_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We could have smgr entries for relations of other databases, so no 
         * short-circuit test is possible here. 
         */ 
</span><a name="LN602"></a>        <a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Local'>rnode</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN602"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN602"><span class='Ref_To_Local'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN90"><span class='Ref_to_Member'>backend_hi</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>16</span><span class='Parentheses'>) </span><span class='Operator'>| </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN91"><span class='Ref_to_Member'>backend_lo</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/smgr.h.html#LN89"><span class='Ref_to_Proto'>smgrclosenode</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN602"><span class='Ref_To_Local'>rnode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN95"><span class='Ref_to_Const'>SHAREDINVALRELMAP_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We only care about our own database and shared catalogs */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN100"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/relmapper.h.html#LN46"><span class='Ref_to_Proto'>RelationMapInvalidate</span></a><span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN100"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/relmapper.h.html#LN46"><span class='Ref_to_Proto'>RelationMapInvalidate</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="../../../include/storage/sinval.h.html#LN103"><span class='Ref_to_Const'>SHAREDINVALSNAPSHOT_ID</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We only care about our own database and shared catalogs */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN100"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN100"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>== </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized SI message ID: %d"</span><span class='Delimiter'>, </span><a href="inval.c.html#LN553"><span class='Ref_to_Parameter'>msg</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/sinval.h.html#LN114"><span class='Ref_to_Member'>id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LocalExecuteInvalidationMessage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 *      InvalidateSystemCaches 
 * 
 *      This blows away all tuples in the system catalog caches and 
 *      all the cached relation descriptors and smgr cache entries. 
 *      Relation descriptors that have positive refcounts are then rebuilt. 
 * 
 *      We call this when we see a shared-inval-queue overflow signal, 
 *      since that tells us we've lost some shared-inval messages and hence 
 *      don't know what needs to be invalidated. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN640"></a><span class='Declare_Function'>InvalidateSystemCaches</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN642"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/catcache.h.html#LN190"><span class='Ref_to_Proto'>ResetCatalogCaches</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relcache.h.html#LN115"><span class='Ref_to_Proto'>RelationCacheInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* gets smgr and relmap too */ 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>; </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN650"></a>        <span class='Control'>struct</span> <a href="inval.c.html#LN190"><span class='Ref_to_Struct'>SYSCACHECALLBACK</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ccitem</span> <span class='Operator'>= </span><a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="inval.c.html#LN650"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN194"><span class='Ref_to_Member'>function</span></a><span class='Parentheses'>) (</span><a href="inval.c.html#LN650"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN195"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN650"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN192"><span class='Ref_to_Member'>id</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a><span class='Delimiter'>; </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN657"></a>        <span class='Control'>struct</span> <a href="inval.c.html#LN202"><span class='Ref_to_Struct'>RELCACHECALLBACK</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ccitem</span> <span class='Operator'>= </span><a href="inval.c.html#LN206"><span class='Ref_to_Global_Var'>relcache_callback_list</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN642"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="inval.c.html#LN657"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN204"><span class='Ref_to_Member'>function</span></a><span class='Parentheses'>) (</span><a href="inval.c.html#LN657"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN205"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end InvalidateSystemCaches &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                    public functions 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AcceptInvalidationMessages 
 *      Read and process invalidation messages from the shared invalidation 
 *      message queue. 
 * 
 * Note: 
 *      This should be called as the first step in processing a transaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN678"></a><span class='Declare_Function'>AcceptInvalidationMessages</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../storage/ipc/sinval.c.html#LN69"><span class='Ref_to_Func'>ReceiveSharedInvalidMessages</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Delimiter'>, 
</span>                                 <a href="../../../include/utils/inval.h.html#LN64"><span class='Ref_to_Proto'>InvalidateSystemCaches</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Test code to force cache flushes anytime a flush could happen. 
     * 
     * If used with CLOBBER_FREED_MEMORY, CLOBBER_CACHE_ALWAYS provides a 
     * fairly thorough test that the system contains no cache-flush hazards. 
     * However, it also makes the system unbelievably slow --- the regression 
     * tests take about 100 times longer than normal. 
     * 
     * If you're a glutton for punishment, try CLOBBER_CACHE_RECURSIVELY. This 
     * slows things by at least a factor of 10000, so I wouldn't suggest 
     * trying to run the entire regression tests that way.  It's useful to try 
     * a few simple tests, to make sure that cache reload isn't subject to 
     * internal cache-flush hazards, but after you've done a few thousand 
     * recursive reloads it's unlikely you'll learn more. 
     */ 
</span><span class='Directive'>#if</span> defined<span class='Parentheses'>(</span>CLOBBER_CACHE_ALWAYS<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN700"></a>        <span class='Keyword'>static bool </span><span class='Declare_Local'>in_recursion</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="inval.c.html#LN700"><span class='Ref_To_Local'>in_recursion</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="inval.c.html#LN700"><span class='Ref_To_Local'>in_recursion</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/inval.h.html#LN64"><span class='Ref_to_Proto'>InvalidateSystemCaches</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="inval.c.html#LN700"><span class='Ref_To_Local'>in_recursion</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#elif</span> defined<span class='Parentheses'>(</span>CLOBBER_CACHE_RECURSIVELY<span class='Parentheses'>) 
</span>    <a href="../../../include/utils/inval.h.html#LN64"><span class='Ref_to_Proto'>InvalidateSystemCaches</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AcceptInvalidationMessages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PrepareInvalidationState 
 *      Initialize inval lists for the current (sub)transaction. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN719"></a><span class='Declare_Function'>PrepareInvalidationState</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN721"></a>    <a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myInfo</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>== </span><a href="../../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN721"><span class='Ref_To_Local'>myInfo</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN721"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN721"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's any previous entry, this one should be for a deeper nesting 
     * level. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>           <a href="inval.c.html#LN721"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>&GT; </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN721"><span class='Ref_To_Local'>myInfo</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PrepareInvalidationState &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PostPrepare_Inval 
 *      Clean up after successful PREPARE. 
 * 
 * Here, we want to act as though the transaction aborted, so that we will 
 * undo any syscache changes it made, thereby bringing us into sync with the 
 * outside world, which doesn't believe the transaction committed yet. 
 * 
 * If the prepared transaction is later aborted, there is nothing more to 
 * do; if it commits, we will receive the consequent inval messages just 
 * like everyone else. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN756"></a><span class='Declare_Function'>PostPrepare_Inval</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/inval.h.html#LN27"><span class='Ref_to_Proto'>AtEOXact_Inval</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Collect invalidation messages into SharedInvalidMessagesArray array. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN765"></a><span class='Declare_Function'>MakeSharedInvalidMessagesArray</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msgs</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Initialise array first time through in each commit 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN234"><span class='Ref_to_Const'>FIRSTCHUNKSIZE</span></a><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Although this is being palloc'd we don't actually free it directly. 
         * We're so close to EOXact that we now we're going to lose it anyhow. 
         */ 
</span>        <a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a> 
                                        <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN765"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN765"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a><span class='Parentheses'>)</span> 
            <a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a><span class='Delimiter'>, 
</span>                                              <a href="inval.c.html#LN174"><span class='Ref_to_Global_Var'>maxSharedInvalidMessagesArray</span></a> 
                                        <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Append the next chunk onto the array 
     */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a><span class='Delimiter'>, 
</span>           <a href="inval.c.html#LN765"><span class='Ref_to_Parameter'>msgs</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN765"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>+= </span><a href="inval.c.html#LN765"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MakeSharedInvalidMessagesArray &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * xactGetCommittedInvalidationMessages() is executed by 
 * RecordTransactionCommit() to add invalidation messages onto the 
 * commit record. This applies only to commit message types, never to 
 * abort records. Must always run before AtEOXact_Inval(), since that 
 * removes the data we need to see. 
 * 
 * Remember that this runs before we have officially committed, so we 
 * must not do anything here to change what might occur *if* we should 
 * fail between here and the actual commit. 
 * 
 * see also xact_redo_commit() and xact_desc_commit() 
 */ 
</span><span class='Keyword'>int 
</span><a name="LN815"></a><span class='Declare_Function'>xactGetCommittedInvalidationMessages</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>**</span><span class='Declare_Parameter'>msgs</span><span class='Delimiter'>, 
</span><a name="LN816"></a>                                     <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>RelcacheInitFileInval</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN818"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick exit if we haven't done anything with invalidation messages. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="inval.c.html#LN816"><span class='Ref_to_Parameter'>RelcacheInitFileInval</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Operator'>*</span><a href="inval.c.html#LN815"><span class='Ref_to_Parameter'>msgs</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Must be at top of stack */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Relcache init file invalidation requires processing both before and 
     * after we send the SI messages.  However, we need not do anything unless 
     * we committed. 
     */ 
</span>    <span class='Operator'>*</span><a href="inval.c.html#LN816"><span class='Ref_to_Parameter'>RelcacheInitFileInval</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Walk through TransInvalidationInfo to collect all the messages into a 
     * single contiguous array of invalidation messages. It must be contiguous 
     * so we can copy directly into WAL message. Maintain the order that they 
     * would be processed in by AtEOXact_Inval(), to ensure emulated behaviour 
     * in redo is as similar as possible to original. We want the same bugs, 
     * if any, not new ones. 
     */ 
</span>    <a href="inval.c.html#LN818"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN48"><span class='Ref_to_Global_Var'>CurTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN464"><span class='Ref_to_Func'>ProcessInvalidationMessagesMulti</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                     <a href="inval.c.html#LN764"><span class='Ref_to_Func'>MakeSharedInvalidMessagesArray</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN464"><span class='Ref_to_Func'>ProcessInvalidationMessagesMulti</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                     <a href="inval.c.html#LN764"><span class='Ref_to_Func'>MakeSharedInvalidMessagesArray</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN818"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>             <a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="inval.c.html#LN815"><span class='Ref_to_Parameter'>msgs</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end xactGetCommittedInvalidationMessages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ProcessCommittedInvalidationMessages is executed by xact_redo_commit() or 
 * standby_redo() to process invalidation messages. Currently that happens 
 * only at end-of-xact. 
 * 
 * Relcache init file invalidation requires processing both 
 * before and after we send the SI messages. See AtEOXact_Inval() 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN871"></a><span class='Declare_Function'>ProcessCommittedInvalidationMessages</span><span class='Parentheses'>(</span><a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>msgs</span><span class='Delimiter'>, 
</span><a name="LN872"></a>                                     <span class='Keyword'>int </span><span class='Declare_Parameter'>nmsgs</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>RelcacheInitFileInval</span><span class='Delimiter'>, 
</span><a name="LN873"></a>                                     <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>dbid</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>tsid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>nmsgs</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/miscadmin.h.html#LN287"><span class='Ref_to_Proto'>trace_recovery</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"replaying commit with %d messages%s"</span><span class='Delimiter'>, </span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Delimiter'>, 
</span>         <span class='Parentheses'>(</span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>RelcacheInitFileInval</span></a> <span class='Operator'>? </span><span class='String'>" and relcache file invalidation"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>RelcacheInitFileInval</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * RelationCacheInitFilePreInvalidate requires DatabasePath to be set, 
         * but we should not use SetDatabasePath during recovery, since it is 
         * intended to be used only once by normal backends.  Hence, a quick 
         * hack: set DatabasePath directly then unset after use. 
         */ 
</span>        <a href="../init/globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a> <span class='Operator'>= </span><a href="../../../include/common/relpath.h.html#LN50"><span class='Ref_to_Proto'>GetDatabasePath</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN873"><span class='Ref_to_Parameter'>dbid</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN873"><span class='Ref_to_Parameter'>tsid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/miscadmin.h.html#LN287"><span class='Ref_to_Proto'>trace_recovery</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN21"><span class='Ref_to_Const'>DEBUG4</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"removing relcache init file in \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="../init/globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/relcache.h.html#LN127"><span class='Ref_to_Proto'>RelationCacheInitFilePreInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="../init/globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../init/globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../storage/ipc/sinval.c.html#LN47"><span class='Ref_to_Func'>SendSharedInvalidMessages</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN871"><span class='Ref_to_Parameter'>msgs</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>nmsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN872"><span class='Ref_to_Parameter'>RelcacheInitFileInval</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relcache.h.html#LN128"><span class='Ref_to_Proto'>RelationCacheInitFilePostInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ProcessCommittedInvalidationMessages &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOXact_Inval 
 *      Process queued-up invalidation messages at end of main transaction. 
 * 
 * If isCommit, we must send out the messages in our PriorCmdInvalidMsgs list 
 * to the shared invalidation message queue.  Note that these will be read 
 * not only by other backends, but also by our own backend at the next 
 * transaction start (via AcceptInvalidationMessages).  This means that 
 * we can skip immediate local processing of anything that's still in 
 * CurrentCmdInvalidMsgs, and just send that list out too. 
 * 
 * If not isCommit, we are aborting, and must locally process the messages 
 * in PriorCmdInvalidMsgs.  No messages need be sent to other backends, 
 * since they'll not have seen our changed tuples anyway.  We can forget 
 * about CurrentCmdInvalidMsgs too, since those changes haven't touched 
 * the caches yet. 
 * 
 * In any case, reset the various lists to empty.  We need not physically 
 * free memory here, since TopTransactionContext is about to be emptied 
 * anyway. 
 * 
 * Note: 
 *      This should be called as the last step in processing a transaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN928"></a><span class='Declare_Function'>AtEOXact_Inval</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Quick exit if no messages */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Must be at top of stack */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN928"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Relcache init file invalidation requires processing both before and 
         * after we send the SI messages.  However, we need not do anything 
         * unless we committed. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/relcache.h.html#LN127"><span class='Ref_to_Proto'>RelationCacheInitFilePreInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN438"><span class='Ref_to_Func'>AppendInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN464"><span class='Ref_to_Func'>ProcessInvalidationMessagesMulti</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                         <a href="../../storage/ipc/sinval.c.html#LN47"><span class='Ref_to_Func'>SendSharedInvalidMessages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/relcache.h.html#LN128"><span class='Ref_to_Proto'>RelationCacheInitFilePostInvalidate</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="inval.c.html#LN452"><span class='Ref_to_Func'>ProcessInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Need not free anything explicitly */ 
</span>    <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN172"><span class='Ref_to_Global_Var'>SharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN173"><span class='Ref_to_Global_Var'>numSharedInvalidMessagesArray</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtEOXact_Inval &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOSubXact_Inval 
 *      Process queued-up invalidation messages at end of subtransaction. 
 * 
 * If isCommit, process CurrentCmdInvalidMsgs if any (there probably aren't), 
 * and then attach both CurrentCmdInvalidMsgs and PriorCmdInvalidMsgs to the 
 * parent's PriorCmdInvalidMsgs list. 
 * 
 * If not isCommit, we are aborting, and must locally process the messages 
 * in PriorCmdInvalidMsgs.  No messages need be sent to other backends. 
 * We can forget about CurrentCmdInvalidMsgs too, since those changes haven't 
 * touched the caches yet. 
 * 
 * In any case, pop the transaction stack.  We need not physically free memory 
 * here, since CurTransactionContext is about to be emptied anyway 
 * (if aborting).  Beware of the possibility of aborting the same nesting 
 * level twice, though. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN987"></a><span class='Declare_Function'>AtEOSubXact_Inval</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN989"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>my_level</span><span class='Delimiter'>; 
</span><a name="LN990"></a>    <a href="inval.c.html#LN152"><span class='Ref_to_Struct'>TransInvalidationInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>myInfo</span> <span class='Operator'>= </span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Quick exit if no messages. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Also bail out quickly if messages are not for this level. */ 
</span>    <a href="inval.c.html#LN989"><span class='Ref_To_Local'>my_level</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>!= </span><a href="inval.c.html#LN989"><span class='Ref_To_Local'>my_level</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>&LT; </span><a href="inval.c.html#LN989"><span class='Ref_To_Local'>my_level</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN987"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* If CurrentCmdInvalidMsgs still has anything, fix it */ 
</span>        <a href="../../../include/utils/inval.h.html#LN35"><span class='Ref_to_Proto'>CommandEndInvalidationMessages</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We create invalidation stack entries lazily, so the parent might 
         * not have one.  Instead of creating one, moving all the data over, 
         * and then freeing our own, we can just adjust the level of our own 
         * entry. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a> <span class='Operator'>&LT; </span><a href="inval.c.html#LN989"><span class='Ref_To_Local'>my_level</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN158"><span class='Ref_to_Member'>my_level</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Pass up my inval messages to parent */ 
</span>        <a href="inval.c.html#LN438"><span class='Ref_to_Func'>AppendInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Pending relcache inval becomes parent's problem too */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a><span class='Parentheses'>) 
</span>            <a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN167"><span class='Ref_to_Member'>RelcacheInitFileInval</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Pop the transaction state stack */ 
</span>        <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need not free anything else explicitly */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isCommit &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="inval.c.html#LN452"><span class='Ref_to_Func'>ProcessInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                    <a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Pop the transaction state stack */ 
</span>        <a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN155"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Need not free anything else explicitly */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN990"><span class='Ref_To_Local'>myInfo</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AtEOSubXact_Inval &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CommandEndInvalidationMessages 
 *      Process queued-up invalidation messages at end of one command 
 *      in a transaction. 
 * 
 * Here, we send no messages to the shared queue, since we don't know yet if 
 * we will commit.  We do need to locally process the CurrentCmdInvalidMsgs 
 * list, so as to flush our caches of any entries we have outdated in the 
 * current command.  We then move the current-cmd list over to become part 
 * of the prior-cmds list. 
 * 
 * Note: 
 *      This should be called during CommandCounterIncrement(), 
 *      after we have advanced the command ID. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1064"></a><span class='Declare_Function'>CommandEndInvalidationMessages</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * You might think this shouldn't be called outside any transaction, but 
     * bootstrap does it, and also ABORT issued when not in a transaction. So 
     * just quietly return if no state to work on. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN452"><span class='Ref_to_Func'>ProcessInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/storage/sinval.h.html#LN151"><span class='Ref_to_Proto'>LocalExecuteInvalidationMessage</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN438"><span class='Ref_to_Func'>AppendInvalidationMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN164"><span class='Ref_to_Member'>PriorCmdInvalidMsgs</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="inval.c.html#LN170"><span class='Ref_to_Global_Var'>transInvalInfo</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN161"><span class='Ref_to_Member'>CurrentCmdInvalidMsgs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateHeapTuple 
 *      Register the given tuple for invalidation at end of command 
 *      (ie, current command is creating or outdating this tuple). 
 *      Also, detect whether a relcache invalidation is implied. 
 * 
 * For an insert or delete, tuple is the target tuple and newtuple is NULL. 
 * For an update, we are called just once, with tuple being the old tuple 
 * version and newtuple the new version.  This allows avoidance of duplicate 
 * effort during an update. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1093"></a><span class='Declare_Function'>CacheInvalidateHeapTuple</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Delimiter'>, 
</span><a name="LN1094"></a>                         <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>tuple</span><span class='Delimiter'>, 
</span><a name="LN1095"></a>                         <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>newtuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1097"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>tupleRelId</span><span class='Delimiter'>; 
</span><a name="LN1098"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>databaseId</span><span class='Delimiter'>; 
</span><a name="LN1099"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relationId</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do nothing during bootstrap */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We only need to worry about invalidation for tuples that are in system 
     * catalogs; user-relation tuples are never in catcaches and can't affect 
     * the relcache either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/catalog/catalog.h.html#LN31"><span class='Ref_to_Proto'>IsCatalogRelation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1093"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * IsCatalogRelation() will return true for TOAST tables of system 
     * catalogs, but we don't care about those, either. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN30"><span class='Ref_to_Proto'>IsToastRelation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1093"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're not prepared to queue invalidation messages for this 
     * subtransaction level, get ready now. 
     */ 
</span>    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First let the catcache do its thing 
     */ 
</span>    <a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1093"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN146"><span class='Ref_to_Proto'>RelationInvalidatesSnapshotsOnly</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/catalog.h.html#LN42"><span class='Ref_to_Proto'>IsSharedRelation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a> <span class='Operator'>: </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN538"><span class='Ref_to_Func'>RegisterSnapshotInvalidation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/catcache.h.html#LN193"><span class='Ref_to_Proto'>PrepareToInvalidateCacheTuple</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1093"><span class='Ref_to_Parameter'>relation</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1094"><span class='Ref_to_Parameter'>tuple</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1095"><span class='Ref_to_Parameter'>newtuple</span></a><span class='Delimiter'>, 
</span>                                      <a href="inval.c.html#LN482"><span class='Ref_to_Func'>RegisterCatcacheInvalidation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now, is this tuple one of the primary definers of a relcache entry? See 
     * comments in file header for deeper explanation. 
     * 
     * Note we ignore newtuple here; we assume an update cannot move a tuple 
     * from being part of one relcache entry to being part of another. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_class.h.html#LN28"><span class='Ref_to_Const'>RelationRelationId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1148"></a>        <a href="../../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classtup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1094"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN1099"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1094"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1148"><span class='Ref_To_Local'>classtup</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>) 
</span>            <a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_attribute.h.html#LN32"><span class='Ref_to_Const'>AttributeRelationId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1158"></a>        <a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a> <span class='Declare_Local'>atttup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_attribute.h.html#LN186"><span class='Ref_to_Typedef'>Form_pg_attribute</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1094"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="inval.c.html#LN1099"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1158"><span class='Ref_To_Local'>atttup</span></a><span class='Operator'>-&GT;</span>attrelid<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * KLUGE ALERT: we always send the relcache event with MyDatabaseId, 
         * even if the rel in question is shared (which we can't easily tell). 
         * This essentially means that only backends in this same database 
         * will react to the relcache flush request.  This is in fact 
         * appropriate, since only those backends could see our pg_attribute 
         * change anyway.  It looks a bit ugly though.  (In practice, shared 
         * relations can't have schema changes after bootstrap, so we should 
         * never come here for a shared rel anyway.) 
         */ 
</span>        <a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1097"><span class='Ref_To_Local'>tupleRelId</span></a> <span class='Operator'>== </span><a href="../../../include/catalog/pg_index.h.html#LN28"><span class='Ref_to_Const'>IndexRelationId</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1176"></a>        <a href="../../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a> <span class='Declare_Local'>indextup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_index.h.html#LN66"><span class='Ref_to_Typedef'>Form_pg_index</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1094"><span class='Ref_to_Parameter'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * When a pg_index row is updated, we should send out a relcache inval 
         * for the index relation.  As above, we don't know the shared status 
         * of the index, but in practice it doesn't matter since indexes of 
         * shared catalogs can't have such updates. 
         */ 
</span>        <a href="inval.c.html#LN1099"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1176"><span class='Ref_To_Local'>indextup</span></a><span class='Operator'>-&GT;</span>indexrelid<span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Yes.  We need to register a relcache invalidation event. 
     */ 
</span>    <a href="inval.c.html#LN508"><span class='Ref_to_Func'>RegisterRelcacheInvalidation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1098"><span class='Ref_To_Local'>databaseId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1099"><span class='Ref_To_Local'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CacheInvalidateHeapTuple &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateCatalog 
 *      Register invalidation of the whole content of a system catalog. 
 * 
 * This is normally used in VACUUM FULL/CLUSTER, where we haven't so much 
 * changed any tuples as moved them around.  Some uses of catcache entries 
 * expect their TIDs to be correct, so we have to blow away the entries. 
 * 
 * Note: we expect caller to verify that the rel actually is a system 
 * catalog.  If it isn't, no great harm is done, just a wasted sinval message. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1208"></a><span class='Declare_Function'>CacheInvalidateCatalog</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>catalogId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1210"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>databaseId</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/catalog/catalog.h.html#LN42"><span class='Ref_to_Proto'>IsSharedRelation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1208"><span class='Ref_to_Parameter'>catalogId</span></a><span class='Parentheses'>))</span> 
        <a href="inval.c.html#LN1210"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="inval.c.html#LN1210"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN496"><span class='Ref_to_Func'>RegisterCatalogInvalidation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1210"><span class='Ref_To_Local'>databaseId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1208"><span class='Ref_to_Parameter'>catalogId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateRelcache 
 *      Register invalidation of the specified relation's relcache entry 
 *      at end of command. 
 * 
 * This is used in places that need to force relcache rebuild but aren't 
 * changing any of the tuples recognized as contributors to the relcache 
 * entry by CacheInvalidateHeapTuple.  (An example is dropping an index.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1232"></a><span class='Declare_Function'>CacheInvalidateRelcache</span><span class='Parentheses'>(</span><a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1234"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>databaseId</span><span class='Delimiter'>; 
</span><a name="LN1235"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relationId</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1235"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="../../../include/utils/rel.h.html#LN416"><span class='Ref_to_Macro'>RelationGetRelid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1232"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1232"><span class='Ref_to_Parameter'>relation</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/rel.h.html#LN113"><span class='Ref_to_Member'>rd_rel</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>) 
</span>        <a href="inval.c.html#LN1234"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="inval.c.html#LN1234"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN508"><span class='Ref_to_Func'>RegisterRelcacheInvalidation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1234"><span class='Ref_To_Local'>databaseId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1235"><span class='Ref_To_Local'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateRelcacheAll 
 *      Register invalidation of the whole relcache at the end of command. 
 * 
 * This is used by alter publication as changes in publications may affect 
 * large number of tables. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1256"></a><span class='Declare_Function'>CacheInvalidateRelcacheAll</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN508"><span class='Ref_to_Func'>RegisterRelcacheInvalidation</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateRelcacheByTuple 
 *      As above, but relation is identified by passing its pg_class tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1268"></a><span class='Declare_Function'>CacheInvalidateRelcacheByTuple</span><span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a> <span class='Declare_Parameter'>classTuple</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1270"></a>    <a href="../../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a> <span class='Declare_Local'>classtup</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_class.h.html#LN94"><span class='Ref_to_Typedef'>Form_pg_class</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1268"><span class='Ref_to_Parameter'>classTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1271"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>databaseId</span><span class='Delimiter'>; 
</span><a name="LN1272"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>relationId</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1272"><span class='Ref_To_Local'>relationId</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1268"><span class='Ref_to_Parameter'>classTuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1270"><span class='Ref_To_Local'>classtup</span></a><span class='Operator'>-&GT;</span>relisshared<span class='Parentheses'>) 
</span>        <a href="inval.c.html#LN1271"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="inval.c.html#LN1271"><span class='Ref_To_Local'>databaseId</span></a> <span class='Operator'>= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN508"><span class='Ref_to_Func'>RegisterRelcacheInvalidation</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1271"><span class='Ref_To_Local'>databaseId</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1272"><span class='Ref_To_Local'>relationId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateRelcacheByRelid 
 *      As above, but relation is identified by passing its OID. 
 *      This is the least efficient of the three options; use one of 
 *      the above routines if you have a Relation or pg_class tuple. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1291"></a><span class='Declare_Function'>CacheInvalidateRelcacheByRelid</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1293"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tup</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN718"><span class='Ref_to_Func'>PrepareInvalidationState</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1293"><span class='Ref_To_Local'>tup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN83"><span class='Ref_to_EnumConst'>RELOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1291"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1293"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cache lookup failed for relation %u"</span><span class='Delimiter'>, </span><a href="inval.c.html#LN1291"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN47"><span class='Ref_to_Proto'>CacheInvalidateRelcacheByTuple</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1293"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="inval.c.html#LN1293"><span class='Ref_To_Local'>tup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateSmgr 
 *      Register invalidation of smgr references to a physical relation. 
 * 
 * Sending this type of invalidation msg forces other backends to close open 
 * smgr entries for the rel.  This should be done to flush dangling open-file 
 * references when the physical rel is being dropped or truncated.  Because 
 * these are nontransactional (i.e., not-rollback-able) operations, we just 
 * send the inval message immediately without any queuing. 
 * 
 * Note: in most cases there will have been a relcache flush issued against 
 * the rel at the logical level.  We need a separate smgr-level flush because 
 * it is possible for backends to have open smgr entries for rels they don't 
 * have a relcache entry for, e.g. because the only thing they ever did with 
 * the rel is write out dirty shared buffers. 
 * 
 * Note: because these messages are nontransactional, they won't be captured 
 * in commit/abort WAL entries.  Instead, calls to CacheInvalidateSmgr() 
 * should happen in low-level smgr.c routines, which are executed while 
 * replaying WAL as well as when creating it. 
 * 
 * Note: In order to avoid bloating SharedInvalidationMessage, we store only 
 * three bytes of the backend ID using what would otherwise be padding space. 
 * Thus, the maximum possible backend ID is 2^23-1. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1331"></a><span class='Declare_Function'>CacheInvalidateSmgr</span><span class='Parentheses'>(</span><a href="../../../include/storage/relfilenode.h.html#LN71"><span class='Ref_to_Struct'>RelFileNodeBackend</span></a> <span class='Declare_Parameter'>rnode</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1333"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN89"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN84"><span class='Ref_to_Const'>SHAREDINVALSMGR_ID</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN90"><span class='Ref_to_Member'>backend_hi</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1331"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN91"><span class='Ref_to_Member'>backend_lo</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1331"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN74"><span class='Ref_to_Member'>backend</span></a> <span class='Operator'>& </span><span class='Number'>0xffff</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN118"><span class='Ref_to_Member'>sm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN92"><span class='Ref_to_Member'>rnode</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1331"><span class='Ref_to_Parameter'>rnode</span></a><span class='Operator'>.</span><a href="../../../include/storage/relfilenode.h.html#LN73"><span class='Ref_to_Member'>node</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check AddCatcacheInvalidationMessage() for an explanation */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/ipc/sinval.c.html#LN47"><span class='Ref_to_Func'>SendSharedInvalidMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN1333"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CacheInvalidateRelmap 
 *      Register invalidation of the relation mapping for a database, 
 *      or for the shared catalogs if databaseId is zero. 
 * 
 * Sending this type of invalidation msg forces other backends to re-read 
 * the indicated relation mapping file.  It is also necessary to send a 
 * relcache inval for the specific relations whose mapping has been altered, 
 * else the relcache won't get updated with the new filenode data. 
 * 
 * Note: because these messages are nontransactional, they won't be captured 
 * in commit/abort WAL entries.  Instead, calls to CacheInvalidateRelmap() 
 * should happen in low-level relmapper.c routines, which are executed while 
 * replaying WAL as well as when creating it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1361"></a><span class='Declare_Function'>CacheInvalidateRelmap</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>databaseId</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1363"></a>    <a href="../../../include/storage/sinval.h.html#LN112"><span class='Ref_to_Typedef'>SharedInvalidationMessage</span></a> <span class='Declare_Local'>msg</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1363"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN99"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="../../../include/storage/sinval.h.html#LN95"><span class='Ref_to_Const'>SHAREDINVALRELMAP_ID</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN1363"><span class='Ref_To_Local'>msg</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN119"><span class='Ref_to_Member'>rm</span></a><span class='Operator'>.</span><a href="../../../include/storage/sinval.h.html#LN100"><span class='Ref_to_Member'>dbId</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1361"><span class='Ref_to_Parameter'>databaseId</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* check AddCatcacheInvalidationMessage() for an explanation */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN1363"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="inval.c.html#LN1363"><span class='Ref_To_Local'>msg</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../storage/ipc/sinval.c.html#LN47"><span class='Ref_to_Func'>SendSharedInvalidMessages</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="inval.c.html#LN1363"><span class='Ref_To_Local'>msg</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CacheRegisterSyscacheCallback 
 *      Register the specified function to be called for all future 
 *      invalidation events in the specified cache.  The cache ID and the 
 *      hash value of the tuple being invalidated will be passed to the 
 *      function. 
 * 
 * NOTE: Hash value zero will be passed if a cache reset request is received. 
 * In this case the called routines should flush all cached state. 
 * Yes, there's a possibility of a false match to zero, but it doesn't seem 
 * worth troubling over, especially since most of the current callees just 
 * flush all cached state anyway. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1388"></a><span class='Declare_Function'>CacheRegisterSyscacheCallback</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, 
</span><a name="LN1389"></a>                              <a href="../../../include/utils/inval.h.html#LN21"><span class='Ref_to_Typedef'>SyscacheCallbackFunction</span></a> <span class='Declare_Parameter'>func</span><span class='Delimiter'>, 
</span><a name="LN1390"></a>                              <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a> <span class='Operator'>&GT;= </span>SysCacheSize<span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"invalid cache ID: %d"</span><span class='Delimiter'>, </span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a> <span class='Operator'>&GT;= </span><a href="inval.c.html#LN187"><span class='Ref_to_Const'>MAX_SYSCACHE_CALLBACKS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"out of syscache_callback_list slots"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN198"><span class='Ref_to_Global_Var'>syscache_callback_links</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* first callback for this cache */ 
</span>        <a href="inval.c.html#LN198"><span class='Ref_to_Global_Var'>syscache_callback_links</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* add to end of chain, so that older callbacks are called first */ 
</span><a name="LN1405"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span> <span class='Operator'>= </span><a href="inval.c.html#LN198"><span class='Ref_to_Global_Var'>syscache_callback_links</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1405"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN193"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="inval.c.html#LN1405"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1405"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN193"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1405"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN193"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN192"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1388"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN193"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN194"><span class='Ref_to_Member'>function</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1389"><span class='Ref_to_Parameter'>func</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN195"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1390"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>++</span><a href="inval.c.html#LN200"><span class='Ref_to_Global_Var'>syscache_callback_count</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CacheRegisterSyscacheCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CacheRegisterRelcacheCallback 
 *      Register the specified function to be called for all future 
 *      relcache invalidation events.  The OID of the relation being 
 *      invalidated will be passed to the function. 
 * 
 * NOTE: InvalidOid will be passed if a cache reset request is received. 
 * In this case the called routines should flush all cached state. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1430"></a><span class='Declare_Function'>CacheRegisterRelcacheCallback</span><span class='Parentheses'>(</span><a href="../../../include/utils/inval.h.html#LN22"><span class='Ref_to_Typedef'>RelcacheCallbackFunction</span></a> <span class='Declare_Parameter'>func</span><span class='Delimiter'>, 
</span><a name="LN1431"></a>                              <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a> <span class='Operator'>&GT;= </span><a href="inval.c.html#LN188"><span class='Ref_to_Const'>MAX_RELCACHE_CALLBACKS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"out of relcache_callback_list slots"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN206"><span class='Ref_to_Global_Var'>relcache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN204"><span class='Ref_to_Member'>function</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1430"><span class='Ref_to_Parameter'>func</span></a><span class='Delimiter'>; 
</span>    <a href="inval.c.html#LN206"><span class='Ref_to_Global_Var'>relcache_callback_list</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="inval.c.html#LN205"><span class='Ref_to_Member'>arg</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1431"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; 
</span> 
    <span class='Operator'>++</span><a href="inval.c.html#LN208"><span class='Ref_to_Global_Var'>relcache_callback_count</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CallSyscacheCallbacks 
 * 
 * This is exported so that CatalogCacheFlushCatalog can call it, saving 
 * this module from knowing which catcache IDs correspond to which catalogs. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1449"></a><span class='Declare_Function'>CallSyscacheCallbacks</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1451"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a> <span class='Operator'>&GT;= </span>SysCacheSize<span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid cache ID: %d"</span><span class='Delimiter'>, </span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="inval.c.html#LN1451"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN198"><span class='Ref_to_Global_Var'>syscache_callback_links</span></a><span class='Delimiter'>[</span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>] </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="inval.c.html#LN1451"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1459"></a>        <span class='Control'>struct</span> <a href="inval.c.html#LN190"><span class='Ref_to_Struct'>SYSCACHECALLBACK</span></a> <span class='Operator'>*</span><span class='Declare_Local'>ccitem</span> <span class='Operator'>= </span><a href="inval.c.html#LN196"><span class='Ref_to_Global_Var'>syscache_callback_list</span></a> <span class='Operator'>+ </span><a href="inval.c.html#LN1451"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="inval.c.html#LN1459"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN192"><span class='Ref_to_Member'>id</span></a> <span class='Operator'>== </span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="inval.c.html#LN1459"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN194"><span class='Ref_to_Member'>function</span></a><span class='Parentheses'>) (</span><a href="inval.c.html#LN1459"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN195"><span class='Ref_to_Member'>arg</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Delimiter'>, </span><a href="inval.c.html#LN1449"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="inval.c.html#LN1451"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="inval.c.html#LN1459"><span class='Ref_To_Local'>ccitem</span></a><span class='Operator'>-&GT;</span><a href="inval.c.html#LN193"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>