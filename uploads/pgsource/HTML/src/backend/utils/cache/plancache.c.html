<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\cache\plancache.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\cache\plancache.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:55 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * plancache.c 
 *    Plan cache management. 
 * 
 * The plan cache manager has two principal responsibilities: deciding when 
 * to use a generic plan versus a custom (parameter-value-specific) plan, 
 * and tracking whether cached plans need to be invalidated because of schema 
 * changes in the objects they depend on. 
 * 
 * The logic for choosing generic or custom plans is in choose_custom_plan, 
 * which see for comments. 
 * 
 * Cache invalidation is driven off sinval events.  Any CachedPlanSource 
 * that matches the event is marked invalid, as is its generic CachedPlan 
 * if it has one.  When (and if) the next demand for a cached plan occurs, 
 * parse analysis and rewrite is repeated to build a new valid query tree, 
 * and then planning is performed as normal.  We also force re-analysis and 
 * re-planning if the active search_path is different from the previous time 
 * or, if RLS is involved, if the user changes or the RLS environment changes. 
 * 
 * Note that if the sinval was a result of user DDL actions, parse analysis 
 * could throw an error, for example if a column referenced by the query is 
 * no longer present.  Another possibility is for the query's output tupdesc 
 * to change (for instance "SELECT *" might expand differently than before). 
 * The creator of a cached plan can specify whether it is allowable for the 
 * query to change output tupdesc on replan --- if so, it's up to the 
 * caller to notice changes and cope with them. 
 * 
 * Currently, we track exactly the dependencies of plans on relations and 
 * user-defined functions.  On relcache invalidation events or pg_proc 
 * syscache invalidation events, we invalidate just those plans that depend 
 * on the particular object being modified.  (Note: this scheme assumes 
 * that any table modification that requires replanning will generate a 
 * relcache inval event.)  We also watch for inval events on certain other 
 * system catalogs, such as pg_namespace; but for them, our response is 
 * just to invalidate all plans.  We expect updates on those catalogs to 
 * be infrequent enough that more-detailed tracking is not worth the effort. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/cache/plancache.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/namespace.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"executor/executor.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"nodes/nodeFuncs.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/cost.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/planmain.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"optimizer/prep.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/analyze.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"parser/parsetree.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/pquery.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"tcop/utility.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/inval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rls.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * We must skip "overhead" operations that involve database access when the 
 * cached plan's subject statement is a transaction control command. 
 */ 
</span><a name="LN77"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>IsTransactionStmtPlan</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>)</span>  <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="plancache.c.html#LN77"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>raw_parse_tree <span class='Operator'>&& \ 
</span>     <a href="../../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>((</span><a href="plancache.c.html#LN77"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>raw_parse_tree<span class='Operator'>-&GT;</span>stmt<span class='Delimiter'>, </span><a href="../../../include/nodes/parsenodes.h.html#LN2902"><span class='Ref_to_Struct'>TransactionStmt</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This is the head of the backend's list of "saved" CachedPlanSources (i.e., 
 * those that are in long-lived storage and are examined for sinval events). 
 * We thread the structs manually instead of using List cells so that we can 
 * guarantee to save a CachedPlanSource without error. 
 */ 
</span><a name="LN87"></a><span class='Keyword'>static </span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Var'>first_saved_plan</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN89"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReleaseGenericPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN90"></a><span class='Keyword'>static </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>RevalidateCachedQuery</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN91"></a>                      <a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN92"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>CheckCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN93"></a><span class='Keyword'>static </span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>BuildCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qlist</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                <a href="../../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>boundParams</span><span class='Delimiter'>, </span><a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN95"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>choose_custom_plan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN96"></a>                   <a href="../../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>boundParams</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static double </span><span class='Declare_Prototype'>cached_plan_cost</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plan</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>include_planner</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN98"></a><span class='Keyword'>static </span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>QueryListGetPrimaryStmt</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN99"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AcquireExecutorLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN100"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AcquirePlannerLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN101"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ScanQueryForLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN102"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ScanQueryWalker</span><span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN103"></a><span class='Keyword'>static </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> <span class='Declare_Prototype'>PlanCacheComputeResultDesc</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN104"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PlanCacheRelCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN105"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PlanCacheFuncCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN106"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>PlanCacheSysCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * InitPlanCache: initialize module during InitPostgres. 
 * 
 * All we need to do is hook into inval.c's callback lists. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN115"></a><span class='Declare_Function'>InitPlanCache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/inval.h.html#LN59"><span class='Ref_to_Proto'>CacheRegisterRelcacheCallback</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN104"><span class='Ref_to_Proto'>PlanCacheRelCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN76"><span class='Ref_to_EnumConst'>PROCOID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN105"><span class='Ref_to_Proto'>PlanCacheFuncCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN69"><span class='Ref_to_EnumConst'>NAMESPACEOID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN106"><span class='Ref_to_Proto'>PlanCacheSysCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN71"><span class='Ref_to_EnumConst'>OPEROID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN106"><span class='Ref_to_Proto'>PlanCacheSysCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN36"><span class='Ref_to_EnumConst'>AMOPOPID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN106"><span class='Ref_to_Proto'>PlanCacheSysCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN63"><span class='Ref_to_EnumConst'>FOREIGNSERVEROID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN106"><span class='Ref_to_Proto'>PlanCacheSysCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/inval.h.html#LN55"><span class='Ref_to_Proto'>CacheRegisterSyscacheCallback</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN61"><span class='Ref_to_EnumConst'>FOREIGNDATAWRAPPEROID</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN106"><span class='Ref_to_Proto'>PlanCacheSysCallback</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CreateCachedPlan: initially create a plan cache entry. 
 * 
 * Creation of a cached plan is divided into two steps, CreateCachedPlan and 
 * CompleteCachedPlan.  CreateCachedPlan should be called after running the 
 * query through raw_parser, but before doing parse analysis and rewrite; 
 * CompleteCachedPlan is called after that.  The reason for this arrangement 
 * is that it can save one round of copying of the raw parse tree, since 
 * the parser will normally scribble on the raw parse tree.  Callers would 
 * otherwise need to make an extra copy of the parse tree to ensure they 
 * still had a clean copy to present at plan cache creation time. 
 * 
 * All arguments presented to CreateCachedPlan are copied into a memory 
 * context created as a child of the call-time CurrentMemoryContext, which 
 * should be a reasonably short-lived working context that will go away in 
 * event of an error.  This ensures that the cached plan data structure will 
 * likewise disappear if an error occurs before we have fully constructed it. 
 * Once constructed, the cached plan can be made longer-lived, if needed, 
 * by calling SaveCachedPlan. 
 * 
 * raw_parse_tree: output of raw_parser(), or NULL if empty query 
 * query_string: original query text 
 * commandTag: compile-time-constant tag for query, or NULL if empty query 
 */ 
</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>* 
</span><a name="LN151"></a><span class='Declare_Function'>CreateCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN1396"><span class='Ref_to_Struct'>RawStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>raw_parse_tree</span><span class='Delimiter'>, 
</span><a name="LN152"></a>                 <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query_string</span><span class='Delimiter'>, 
</span><a name="LN153"></a>                 <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>commandTag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN155"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plansource</span><span class='Delimiter'>; 
</span><a name="LN156"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>source_context</span><span class='Delimiter'>; 
</span><a name="LN157"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN152"><span class='Ref_to_Parameter'>query_string</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* required as of 8.4 */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make a dedicated memory context for the CachedPlanSource and its 
     * permanent subsidiary data.  It's probably not going to be large, but 
     * just in case, allow it to grow large.  Initially it's a child of the 
     * caller's context (which we assume to be transient), so that it will be 
     * cleaned up on error. 
     */ 
</span>    <a href="plancache.c.html#LN156"><span class='Ref_To_Local'>source_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                           <span class='String'>"CachedPlanSource"</span><span class='Delimiter'>, 
</span>                                           <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create and fill the CachedPlanSource struct within the new context. 
     * Most fields are just left empty for the moment. 
     */ 
</span>    <a href="plancache.c.html#LN157"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN156"><span class='Ref_To_Local'>source_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN151"><span class='Ref_to_Parameter'>raw_parse_tree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN152"><span class='Ref_to_Parameter'>query_string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN84"><span class='Ref_to_Member'>commandTag</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN153"><span class='Ref_to_Parameter'>commandTag</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN156"><span class='Ref_To_Local'>source_context</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN110"><span class='Ref_to_Member'>generation</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN157"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN155"><span class='Ref_To_Local'>plansource</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CreateOneShotCachedPlan: initially create a one-shot plan cache entry. 
 * 
 * This variant of CreateCachedPlan creates a plan cache entry that is meant 
 * to be used only once.  No data copying occurs: all data structures remain 
 * in the caller's memory context (which typically should get cleared after 
 * completing execution).  The CachedPlanSource struct itself is also created 
 * in that context. 
 * 
 * A one-shot plan cannot be saved or copied, since we make no effort to 
 * preserve the raw parse tree unmodified.  There is also no support for 
 * invalidation, so plan use must be completed in the current transaction, 
 * and DDL that might invalidate the querytree_list must be avoided as well. 
 * 
 * raw_parse_tree: output of raw_parser(), or NULL if empty query 
 * query_string: original query text 
 * commandTag: compile-time-constant tag for query, or NULL if empty query 
 */ 
</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>* 
</span><a name="LN234"></a><span class='Declare_Function'>CreateOneShotCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN1396"><span class='Ref_to_Struct'>RawStmt</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>raw_parse_tree</span><span class='Delimiter'>, 
</span><a name="LN235"></a>                        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>query_string</span><span class='Delimiter'>, 
</span><a name="LN236"></a>                        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>commandTag</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN238"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plansource</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN235"><span class='Ref_to_Parameter'>query_string</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* required as of 8.4 */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create and fill the CachedPlanSource struct within the caller's memory 
     * context.  Most fields are just left empty for the moment. 
     */ 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN234"><span class='Ref_to_Parameter'>raw_parse_tree</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN235"><span class='Ref_to_Parameter'>query_string</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN84"><span class='Ref_to_Member'>commandTag</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN236"><span class='Ref_to_Parameter'>commandTag</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN110"><span class='Ref_to_Member'>generation</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN238"><span class='Ref_To_Local'>plansource</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateOneShotCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CompleteCachedPlan: second step of creating a plan cache entry. 
 * 
 * Pass in the analyzed-and-rewritten form of the query, as well as the 
 * required subsidiary data about parameters and such.  All passed values will 
 * be copied into the CachedPlanSource's memory, except as specified below. 
 * After this is called, GetCachedPlan can be called to obtain a plan, and 
 * optionally the CachedPlanSource can be saved using SaveCachedPlan. 
 * 
 * If querytree_context is not NULL, the querytree_list must be stored in that 
 * context (but the other parameters need not be).  The querytree_list is not 
 * copied, rather the given context is kept as the initial query_context of 
 * the CachedPlanSource.  (It should have been created as a child of the 
 * caller's working memory context, but it will now be reparented to belong 
 * to the CachedPlanSource.)  The querytree_context is normally the context in 
 * which the caller did raw parsing and parse analysis.  This approach saves 
 * one tree copying step compared to passing NULL, but leaves lots of extra 
 * cruft in the query_context, namely whatever extraneous stuff parse analysis 
 * created, as well as whatever went unused from the raw parse tree.  Using 
 * this option is a space-for-time tradeoff that is appropriate if the 
 * CachedPlanSource is not expected to survive long. 
 * 
 * plancache.c cannot know how to copy the data referenced by parserSetupArg, 
 * and it would often be inappropriate to do so anyway.  When using that 
 * option, it is caller's responsibility that the referenced data remains 
 * valid for as long as the CachedPlanSource exists. 
 * 
 * If the CachedPlanSource is a "oneshot" plan, then no querytree copying 
 * occurs at all, and querytree_context is ignored; it is caller's 
 * responsibility that the passed querytree_list is sufficiently long-lived. 
 * 
 * plansource: structure returned by CreateCachedPlan 
 * querytree_list: analyzed-and-rewritten form of query (list of Query nodes) 
 * querytree_context: memory context containing querytree_list, 
 *                    or NULL to copy querytree_list into a fresh context 
 * param_types: array of fixed parameter type OIDs, or NULL if none 
 * num_params: number of fixed parameters 
 * parserSetup: alternate method for handling query parameters 
 * parserSetupArg: data to pass to parserSetup 
 * cursor_options: options bitmask to pass to planner 
 * fixed_result: TRUE to disallow future changes in query's result tupdesc 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN324"></a><span class='Declare_Function'>CompleteCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN325"></a>                   <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>querytree_list</span><span class='Delimiter'>, 
</span><a name="LN326"></a>                   <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>querytree_context</span><span class='Delimiter'>, 
</span><a name="LN327"></a>                   <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param_types</span><span class='Delimiter'>, 
</span><a name="LN328"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>num_params</span><span class='Delimiter'>, 
</span><a name="LN329"></a>                   <a href="../../../include/nodes/params.h.html#LN65"><span class='Ref_to_Typedef'>ParserSetupHook</span></a> <span class='Declare_Parameter'>parserSetup</span><span class='Delimiter'>, 
</span><a name="LN330"></a>                   <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>parserSetupArg</span><span class='Delimiter'>, 
</span><a name="LN331"></a>                   <span class='Keyword'>int </span><span class='Declare_Parameter'>cursor_options</span><span class='Delimiter'>, 
</span><a name="LN332"></a>                   <span class='Keyword'>bool </span><span class='Declare_Parameter'>fixed_result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN334"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>source_context</span> <span class='Operator'>= </span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>; 
</span><a name="LN335"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert caller is doing things in a sane order */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If caller supplied a querytree_context, reparent it underneath the 
     * CachedPlanSource's context; otherwise, create a suitable context and 
     * copy the querytree_list into it.  But no data copying should be done 
     * for one-shot plans; for those, assume the passed querytree_list is 
     * sufficiently long-lived. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN334"><span class='Ref_To_Local'>source_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Again, it's a good bet the querytree_context can be small */ 
</span>        <a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN334"><span class='Ref_To_Local'>source_context</span></a><span class='Delimiter'>, 
</span>                                                  <span class='String'>"CachedPlanQuery"</span><span class='Delimiter'>, 
</span>                                                  <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN325"><span class='Ref_to_Parameter'>querytree_list</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN325"><span class='Ref_to_Parameter'>querytree_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN325"><span class='Ref_to_Parameter'>querytree_list</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>&& !</span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Use the planner machinery to extract dependencies.  Data is saved 
         * in query_context.  (We assume that not a lot of extra cruft is 
         * created by this call.)  We can skip this for one-shot plans, and 
         * transaction control commands have no such dependencies anyway. 
         */ 
</span>        <a href="../../../include/optimizer/planmain.h.html#LN117"><span class='Ref_to_Proto'>extract_query_dependencies</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plancache.c.html#LN325"><span class='Ref_to_Parameter'>querytree_list</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a><span class='Delimiter'>, 
</span>                                   <span class='Operator'>&</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update RLS info as well. */ 
</span>        <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>= </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>= </span><a href="../misc/guc.c.html#LN445"><span class='Ref_to_Global_Var'>row_security</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Also save the current search_path in the query_context.  (This 
         * should not generate much extra cruft either, since almost certainly 
         * the path is already valid.)  Again, we don't really need this for 
         * one-shot plans; and we *must* skip this for transaction control 
         * commands, because this could result in catalog accesses. 
         */ 
</span>        <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/namespace.h.html#LN136"><span class='Ref_to_Proto'>GetOverrideSearchPath</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN326"><span class='Ref_to_Parameter'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !plansource-&GT;is_onesh... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Save the final parameter types (or other parameter specification data) 
     * into the source_context, as well as our other parameters.  Also save 
     * the result tuple descriptor. 
     */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN334"><span class='Ref_To_Local'>source_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN328"><span class='Ref_to_Parameter'>num_params</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN328"><span class='Ref_to_Parameter'>num_params</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN327"><span class='Ref_to_Parameter'>param_types</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN328"><span class='Ref_to_Parameter'>num_params</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN328"><span class='Ref_to_Parameter'>num_params</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN329"><span class='Ref_to_Parameter'>parserSetup</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN330"><span class='Ref_to_Parameter'>parserSetupArg</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN331"><span class='Ref_to_Parameter'>cursor_options</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN332"><span class='Ref_to_Parameter'>fixed_result</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN103"><span class='Ref_to_Proto'>PlanCacheComputeResultDesc</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN325"><span class='Ref_to_Parameter'>querytree_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN335"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN324"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CompleteCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * SaveCachedPlan: save a cached plan permanently 
 * 
 * This function moves the cached plan underneath CacheMemoryContext (making 
 * it live for the life of the backend, unless explicitly dropped), and adds 
 * it to the list of cached plans that are checked for invalidation when an 
 * sinval event occurs. 
 * 
 * This is guaranteed not to throw error, except for the caller-error case 
 * of trying to save a one-shot plan.  Callers typically depend on that 
 * since this is called just before or just after adding a pointer to the 
 * CachedPlanSource to some permanent data structure of their own.  Up until 
 * this is done, a CachedPlanSource is just transient data that will go away 
 * automatically on transaction abort. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN440"></a><span class='Declare_Function'>SaveCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Assert caller is doing things in a sane order */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This seems worth a real test, though */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot save one-shot cached plan"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In typical use, this function would be called before generating any 
     * plans from the CachedPlanSource.  If there is a generic plan, moving it 
     * into CacheMemoryContext would be pretty risky since it's unclear 
     * whether the caller has taken suitable care with making references 
     * long-lived.  Best thing to do seems to be to discard the plan. 
     */ 
</span>    <a href="plancache.c.html#LN89"><span class='Ref_to_Proto'>ReleaseGenericPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Reparent the source memory context under CacheMemoryContext so that it 
     * will live indefinitely.  The query_context follows along since it's 
     * already a child of the other one. 
     */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="../mmgr/mcxt.c.html#LN45"><span class='Ref_to_Global_Var'>CacheMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add the entry to the global list of cached plans. 
     */ 
</span>    <a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN440"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SaveCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * DropCachedPlan: destroy a cached plan. 
 * 
 * Actually this only destroys the CachedPlanSource: any referenced CachedPlan 
 * is released, but not destroyed until its refcount goes to zero.  That 
 * handles the situation where DropCachedPlan is called while the plan is 
 * still in use. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN485"></a><span class='Declare_Function'>DropCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If it's been saved, remove it from the list */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a> <span class='Operator'>== </span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>) 
</span>            <a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN496"></a>            <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>psrc</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>== </span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="plancache.c.html#LN496"><span class='Ref_To_Local'>psrc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Decrement generic CachePlan's refcount and drop if no longer needed */ 
</span>    <a href="plancache.c.html#LN89"><span class='Ref_to_Proto'>ReleaseGenericPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Mark it no longer valid */ 
</span>    <a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove the CachedPlanSource and all subsidiary data (including the 
     * query_context if any).  But if it's a one-shot we can't free anything. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN485"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DropCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReleaseGenericPlan: release a CachedPlanSource's generic plan, if any. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN528"></a><span class='Declare_Function'>ReleaseGenericPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Be paranoid about the possibility that ReleaseCachedPlan fails */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN528"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN533"></a>        <a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plan</span> <span class='Operator'>= </span><a href="plancache.c.html#LN528"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN533"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN528"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/plancache.h.html#LN182"><span class='Ref_to_Proto'>ReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN533"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RevalidateCachedQuery: ensure validity of analyzed-and-rewritten query tree. 
 * 
 * What we do here is re-acquire locks and redo parse analysis if necessary. 
 * On return, the query_list is valid and we have sufficient locks to begin 
 * planning. 
 * 
 * If any parse analysis activity is required, the caller's memory context is 
 * used for that work. 
 * 
 * The result value is the transient analyzed-and-rewritten query tree if we 
 * had to do re-analysis, and NIL otherwise.  (This is returned just to save 
 * a tree copying step in a subsequent BuildCachedPlan call.) 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN556"></a><span class='Declare_Function'>RevalidateCachedQuery</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN557"></a>                      <a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN559"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>snapshot_set</span><span class='Delimiter'>; 
</span><a name="LN560"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN1396"><span class='Ref_to_Struct'>RawStmt</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>rawtree</span><span class='Delimiter'>; 
</span><a name="LN561"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>tlist</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* transient query-tree list */ 
</span><a name="LN562"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qlist</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* permanent query-tree list */ 
</span><a name="LN563"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>resultDesc</span><span class='Delimiter'>; 
</span><a name="LN564"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>querytree_context</span><span class='Delimiter'>; 
</span><a name="LN565"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For one-shot plans, we do not support revalidation checking; it's 
     * assumed the query is parsed, planned, and executed in one transaction, 
     * so that no lock re-acquisition is necessary.  Also, there is never any 
     * need to revalidate plans for transaction control commands (and we 
     * mustn't risk any catalog accesses when handling those). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>|| </span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the query is currently valid, we should have a saved search_path --- 
     * check to see if that matches the current environment.  If not, we want 
     * to force replan. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/catalog/namespace.h.html#LN138"><span class='Ref_to_Proto'>OverrideSearchPathMatchesCurrent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Invalidate the querytree and generic plan */ 
</span>            <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>                <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the query rewrite phase had a possible RLS dependency, we must redo 
     * it if either the role or the row_security setting has changed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>&& </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>!= </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>() </span><span class='Operator'>|| 
</span>         <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>!= </span><a href="../misc/guc.c.html#LN445"><span class='Ref_to_Global_Var'>row_security</span></a><span class='Parentheses'>))</span> 
        <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the query is currently valid, acquire locks on the referenced 
     * objects; then check again.  We need to do it this way to cover the race 
     * condition that an invalidation message arrives before we get the locks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plancache.c.html#LN100"><span class='Ref_to_Proto'>AcquirePlannerLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * By now, if any invalidation has happened, the inval callback 
         * functions will have marked the query invalid. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Successfully revalidated and locked the query. */ 
</span>            <span class='Control'>return</span> <a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Oops, the race case happened.  Release useless locks. */ 
</span>        <a href="plancache.c.html#LN100"><span class='Ref_to_Proto'>AcquirePlannerLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Discard the no-longer-useful query tree.  (Note: we don't want to do 
     * this any earlier, else we'd not have been able to release locks 
     * correctly in the race condition case.) 
     */ 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Free the query_context.  We don't really expect MemoryContextDelete to 
     * fail, but just in case, make sure the CachedPlanSource is left in a 
     * reasonably sane state.  (The generic plan won't get unlinked yet, but 
     * that's acceptable.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN648"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>qcxt</span> <span class='Operator'>= </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a><span class='Delimiter'>; 
</span> 
        <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN648"><span class='Ref_To_Local'>qcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Drop the generic plan reference if any */ 
</span>    <a href="plancache.c.html#LN89"><span class='Ref_to_Proto'>ReleaseGenericPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now re-do parse analysis and rewrite.  This not incidentally acquires 
     * the locks we need to do planning safely. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a snapshot is already set (the normal case), we can just use that 
     * for parsing/planning.  But if it isn't, install one.  Note: no point in 
     * checking whether parse analysis requires a snapshot; utility commands 
     * don't have invalidatable plans, so we'd not get here for such a 
     * command. 
     */ 
</span>    <a href="plancache.c.html#LN559"><span class='Ref_To_Local'>snapshot_set</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/snapmgr.h.html#LN78"><span class='Ref_to_Proto'>ActiveSnapshotSet</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN559"><span class='Ref_To_Local'>snapshot_set</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Run parse analysis and rule rewriting.  The parser tends to scribble on 
     * its input, so we must copy the raw parse tree to prevent corruption of 
     * the cache. 
     */ 
</span>    <a href="plancache.c.html#LN560"><span class='Ref_To_Local'>rawtree</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN560"><span class='Ref_To_Local'>rawtree</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a> <span class='Operator'>= </span><a href="../../../include/tcop/tcopprot.h.html#LN54"><span class='Ref_to_Proto'>pg_analyze_and_rewrite_params</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN560"><span class='Ref_To_Local'>rawtree</span></a><span class='Delimiter'>, 
</span>                                              <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a><span class='Delimiter'>, 
</span>                                              <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a><span class='Delimiter'>, 
</span>                                              <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a><span class='Delimiter'>, 
</span>                                              <a href="plancache.c.html#LN557"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a> <span class='Operator'>= </span><a href="../../../include/tcop/tcopprot.h.html#LN50"><span class='Ref_to_Proto'>pg_analyze_and_rewrite</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN560"><span class='Ref_To_Local'>rawtree</span></a><span class='Delimiter'>, 
</span>                                       <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a><span class='Delimiter'>, 
</span>                                       <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a><span class='Delimiter'>, 
</span>                                       <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a><span class='Delimiter'>, 
</span>                                       <a href="plancache.c.html#LN557"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release snapshot if we got one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN559"><span class='Ref_To_Local'>snapshot_set</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check or update the result tupdesc.  XXX should we use a weaker 
     * condition than equalTupleDescs() here? 
     * 
     * We assume the parameter types didn't change from the first time, so no 
     * need to update that. 
     */ 
</span>    <a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN103"><span class='Ref_to_Proto'>PlanCacheComputeResultDesc</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* OK, doesn't return tuples */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>             <span class='Operator'>!</span><a href="../../../include/access/tupdesc.h.html#LN112"><span class='Ref_to_Proto'>equalTupleDescs</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* can we give a better error message? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cached plan must not change result type"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN565"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a><span class='Parentheses'>) 
</span>            <a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a> <span class='Operator'>= </span><a href="../../../include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/access/tupdesc.h.html#LN95"><span class='Ref_to_Proto'>FreeTupleDesc</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN563"><span class='Ref_To_Local'>resultDesc</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN565"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allocate new query_context and copy the completed querytree into it. 
     * It's transient until we complete the copying and dependency extraction. 
     */ 
</span>    <a href="plancache.c.html#LN564"><span class='Ref_To_Local'>querytree_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                              <span class='String'>"CachedPlanQuery"</span><span class='Delimiter'>, 
</span>                                              <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN565"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN564"><span class='Ref_To_Local'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN562"><span class='Ref_To_Local'>qlist</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use the planner machinery to extract dependencies.  Data is saved in 
     * query_context.  (We assume that not a lot of extra cruft is created by 
     * this call.) 
     */ 
</span>    <a href="../../../include/optimizer/planmain.h.html#LN117"><span class='Ref_to_Proto'>extract_query_dependencies</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plancache.c.html#LN562"><span class='Ref_To_Local'>qlist</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a><span class='Delimiter'>, 
</span>                               <span class='Operator'>&</span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update RLS info as well. */ 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>= </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>= </span><a href="../misc/guc.c.html#LN445"><span class='Ref_to_Global_Var'>row_security</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Also save the current search_path in the query_context.  (This should 
     * not generate much extra cruft either, since almost certainly the path 
     * is already valid.) 
     */ 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/namespace.h.html#LN136"><span class='Ref_to_Proto'>GetOverrideSearchPath</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN564"><span class='Ref_To_Local'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN565"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now reparent the finished query_context and save the links */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN564"><span class='Ref_To_Local'>querytree_context</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN564"><span class='Ref_To_Local'>querytree_context</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN562"><span class='Ref_To_Local'>qlist</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: we do not reset generic_cost or total_custom_cost, although we 
     * could choose to do so.  If the DDL or statistics change that prompted 
     * the invalidation meant a significant change in the cost estimates, it 
     * would be better to reset those variables and start fresh; but often it 
     * doesn't, and we're better retaining our hard-won knowledge about the 
     * relative costs. 
     */ 
</span> 
    <a href="plancache.c.html#LN556"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return transient copy of querytrees for possible use in planning */ 
</span>    <span class='Control'>return</span> <a href="plancache.c.html#LN561"><span class='Ref_To_Local'>tlist</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RevalidateCachedQuery &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CheckCachedPlan: see if the CachedPlanSource's generic plan is valid. 
 * 
 * Caller must have already called RevalidateCachedQuery to verify that the 
 * querytree is up to date. 
 * 
 * On a "true" return, we have acquired the locks needed to run the plan. 
 * (We must do this for the "true" result to be race-condition-free.) 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN796"></a><span class='Declare_Function'>CheckCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN798"></a>    <a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plan</span> <span class='Operator'>= </span><a href="plancache.c.html#LN796"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert that caller checked the querytree */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN796"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If there's no generic plan, just say "false" */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Generic plans are never one-shot */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN133"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If plan isn't valid for current role, we can't use it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>&& </span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN137"><span class='Ref_to_Member'>dependsOnRole</span></a> <span class='Operator'>&& 
</span>        <a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN136"><span class='Ref_to_Member'>planRoleId</span></a> <span class='Operator'>!= </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>())</span> 
        <a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If it appears valid, acquire locks and recheck; this is much the same 
     * logic as in RevalidateCachedQuery, but for a plan. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Plan must have positive refcount because it is referenced by 
         * plansource; so no need to fear it disappears under us here. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plancache.c.html#LN99"><span class='Ref_to_Proto'>AcquireExecutorLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If plan was transient, check to see if TransactionXmin has 
         * advanced, and if so invalidate it. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/access/transam.h.html#LN40"><span class='Ref_to_Macro'>TransactionIdIsValid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN138"><span class='Ref_to_Member'>saved_xmin</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN42"><span class='Ref_to_Macro'>TransactionIdEquals</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN138"><span class='Ref_to_Member'>saved_xmin</span></a><span class='Delimiter'>, </span><a href="../time/snapmgr.c.html#LN163"><span class='Ref_to_Global_Var'>TransactionXmin</span></a><span class='Parentheses'>))</span> 
            <a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * By now, if any invalidation has happened, the inval callback 
         * functions will have marked the plan invalid. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Successfully revalidated and locked the query. */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Oops, the race case happened.  Release useless locks. */ 
</span>        <a href="plancache.c.html#LN99"><span class='Ref_to_Proto'>AcquireExecutorLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN798"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if plan-&GT;is_valid &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Plan has been invalidated, so unlink it from the parent and release it. 
     */ 
</span>    <a href="plancache.c.html#LN89"><span class='Ref_to_Proto'>ReleaseGenericPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN796"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CheckCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * BuildCachedPlan: construct a new CachedPlan from a CachedPlanSource. 
 * 
 * qlist should be the result value from a previous RevalidateCachedQuery, 
 * or it can be set to NIL if we need to re-copy the plansource's query_list. 
 * 
 * To build a generic, parameter-value-independent plan, pass NULL for 
 * boundParams.  To build a custom plan, pass the actual parameter values via 
 * boundParams.  For best effect, the PARAM_FLAG_CONST flag should be set on 
 * each parameter value; otherwise the planner will treat the value as a 
 * hint rather than a hard constant. 
 * 
 * Planning work is done in the caller's memory context.  The finished plan 
 * is in a child memory context, which typically should get reparented 
 * (unless this is a one-shot plan, in which case we don't copy the plan). 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>* 
</span><a name="LN880"></a><span class='Declare_Function'>BuildCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>qlist</span><span class='Delimiter'>, 
</span><a name="LN881"></a>                <a href="../../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>boundParams</span><span class='Delimiter'>, </span><a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN883"></a>    <a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plan</span><span class='Delimiter'>; 
</span><a name="LN884"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>plist</span><span class='Delimiter'>; 
</span><a name="LN885"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>snapshot_set</span><span class='Delimiter'>; 
</span><a name="LN886"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>is_transient</span><span class='Delimiter'>; 
</span><a name="LN887"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>plan_context</span><span class='Delimiter'>; 
</span><a name="LN888"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span><a name="LN889"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normally the querytree should be valid already, but if it's not, 
     * rebuild it. 
     * 
     * NOTE: GetCachedPlan should have called RevalidateCachedQuery first, so 
     * we ought to be holding sufficient locks to prevent any invalidation. 
     * However, if we're building a custom plan after having built and 
     * rejected a generic plan, it's possible to reach here with is_valid 
     * false due to an invalidation while making the generic plan.  In theory 
     * the invalidation must be a false positive, perhaps a consequence of an 
     * sinval reset event or the CLOBBER_CACHE_ALWAYS debug code.  But for 
     * safety, let's treat it as real and redo the RevalidateCachedQuery call. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>        <a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>qlist</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN90"><span class='Ref_to_Proto'>RevalidateCachedQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN881"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we don't already have a copy of the querytree list that can be 
     * scribbled on by the planner, make one.  For a one-shot plan, we assume 
     * it's okay to scribble on the original query_list. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>qlist</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>            <a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>qlist</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>qlist</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If a snapshot is already set (the normal case), we can just use that 
     * for planning.  But if it isn't, and we need one, install one. 
     */ 
</span>    <a href="plancache.c.html#LN885"><span class='Ref_To_Local'>snapshot_set</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/snapmgr.h.html#LN78"><span class='Ref_to_Proto'>ActiveSnapshotSet</span></a><span class='Parentheses'>() </span><span class='Operator'>&& 
</span>        <a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a> <span class='Operator'>&& 
</span>        <a href="../../../include/parser/analyze.h.html#LN37"><span class='Ref_to_Proto'>analyze_requires_snapshot</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN885"><span class='Ref_To_Local'>snapshot_set</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Generate the plan. 
     */ 
</span>    <a href="plancache.c.html#LN884"><span class='Ref_To_Local'>plist</span></a> <span class='Operator'>= </span><a href="../../../include/tcop/tcopprot.h.html#LN61"><span class='Ref_to_Proto'>pg_plan_queries</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>qlist</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN881"><span class='Ref_to_Parameter'>boundParams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Release snapshot if we got one */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN885"><span class='Ref_To_Local'>snapshot_set</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN76"><span class='Ref_to_Proto'>PopActiveSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Normally we make a dedicated memory context for the CachedPlan and its 
     * subsidiary data.  (It's probably not going to be large, but just in 
     * case, allow it to grow large.  It's transient for the moment.)  But for 
     * a one-shot plan, we just leave it in the caller's memory context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plancache.c.html#LN887"><span class='Ref_To_Local'>plan_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                             <span class='String'>"CachedPlan"</span><span class='Delimiter'>, 
</span>                                             <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Copy plan into the new context. 
         */ 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN887"><span class='Ref_To_Local'>plan_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plancache.c.html#LN884"><span class='Ref_To_Local'>plist</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN884"><span class='Ref_To_Local'>plist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN887"><span class='Ref_To_Local'>plan_context</span></a> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create and fill the CachedPlan struct within the new context. 
     */ 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN884"><span class='Ref_To_Local'>plist</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * CachedPlan is dependent on role either if RLS affected the rewrite 
     * phase or if a role dependency was injected during planning.  And it's 
     * transient if any plan is marked so. 
     */ 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN136"><span class='Ref_to_Member'>planRoleId</span></a> <span class='Operator'>= </span><a href="../init/miscinit.c.html#LN281"><span class='Ref_to_Func'>GetUserId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN137"><span class='Ref_to_Member'>dependsOnRole</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN886"><span class='Ref_To_Local'>is_transient</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN889"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN884"><span class='Ref_To_Local'>plist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN981"></a>        <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plannedstmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN889"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN981"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN44"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Ignore utility statements */ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN981"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN54"><span class='Ref_to_Member'>transientPlan</span></a><span class='Parentheses'>) 
</span>            <a href="plancache.c.html#LN886"><span class='Ref_To_Local'>is_transient</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN981"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN56"><span class='Ref_to_Member'>dependsOnRole</span></a><span class='Parentheses'>) 
</span>            <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN137"><span class='Ref_to_Member'>dependsOnRole</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN886"><span class='Ref_To_Local'>is_transient</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="../time/snapmgr.c.html#LN163"><span class='Ref_to_Global_Var'>TransactionXmin</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN138"><span class='Ref_to_Member'>saved_xmin</span></a> <span class='Operator'>= </span><a href="../time/snapmgr.c.html#LN163"><span class='Ref_to_Global_Var'>TransactionXmin</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN138"><span class='Ref_to_Member'>saved_xmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN887"><span class='Ref_To_Local'>plan_context</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN133"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN134"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* assign generation number to new plan */ 
</span>    <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN140"><span class='Ref_to_Member'>generation</span></a> <span class='Operator'>= ++</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN880"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN110"><span class='Ref_to_Member'>generation</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN888"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN883"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BuildCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * choose_custom_plan: choose whether to use custom or generic plan 
 * 
 * This defines the policy followed by GetCachedPlan. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1018"></a><span class='Declare_Function'>choose_custom_plan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, </span><a href="../../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>boundParams</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1020"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>avg_custom_cost</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* One-shot plans will always be considered custom */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Otherwise, never any point in a custom plan if there's no parameters */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>boundParams</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* ... nor for transaction control statements */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See if caller wants to force the decision */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2608"><span class='Ref_to_Const'>CURSOR_OPT_GENERIC_PLAN</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2609"><span class='Ref_to_Const'>CURSOR_OPT_CUSTOM_PLAN</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Generate custom plans until we have done at least 5 (arbitrary) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a> <span class='Operator'>&LT; </span><span class='Number'>5</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1020"><span class='Ref_To_Local'>avg_custom_cost</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a> <span class='Operator'>/ </span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Prefer generic plan if it's less expensive than the average custom 
     * plan.  (Because we include a charge for cost of planning in the 
     * custom-plan costs, this means the generic plan only has to be less 
     * expensive than the execution cost plus replan cost of the custom 
     * plans.) 
     * 
     * Note that if generic_cost is -1 (indicating we've not yet determined 
     * the generic plan cost), we'll always prefer generic at this point. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1018"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a> <span class='Operator'>&LT; </span><a href="plancache.c.html#LN1020"><span class='Ref_To_Local'>avg_custom_cost</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end choose_custom_plan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * cached_plan_cost: calculate estimated cost of a plan 
 * 
 * If include_planner is true, also include the estimated cost of constructing 
 * the plan.  (We must factor that into the cost of using a custom plan, but 
 * we don't count it for a generic plan.) 
 */ 
</span><span class='Keyword'>static double 
</span><a name="LN1069"></a><span class='Declare_Function'>cached_plan_cost</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plan</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>include_planner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1071"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1072"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1072"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1069"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1076"></a>        <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plannedstmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1072"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1076"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN44"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Ignore utility statements */ 
</span> 
        <a href="plancache.c.html#LN1071"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>+= </span><a href="plancache.c.html#LN1076"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN60"><span class='Ref_to_Member'>planTree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN125"><span class='Ref_to_Member'>total_cost</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1069"><span class='Ref_to_Parameter'>include_planner</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Currently we use a very crude estimate of planning effort based 
             * on the number of relations in the finished plan's rangetable. 
             * Join planning effort actually scales much worse than linearly 
             * in the number of relations --- but only until the join collapse 
             * limits kick in.  Also, while inheritance child relations surely 
             * add to planning effort, they don't make the join situation 
             * worse.  So the actual shape of the planning cost curve versus 
             * number of relations isn't all that obvious.  It will take 
             * considerable work to arrive at a less crude estimate, and for 
             * now it's not clear that's worth doing. 
             * 
             * The other big difficulty here is that we don't have any very 
             * good model of how planning cost compares to execution costs. 
             * The current multiplier of 1000 * cpu_operator_cost is probably 
             * on the low side, but we'll try this for awhile before making a 
             * more aggressive correction. 
             * 
             * If we ever do write a more complicated estimator, it should 
             * probably live in src/backend/optimizer/ not here. 
             */ 
</span><a name="LN1106"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>nrelations</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1076"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN62"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="plancache.c.html#LN1071"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>+= </span><span class='Number'>1000</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span><a href="../../optimizer/path/costsize.c.html#LN107"><span class='Ref_to_Global_Var'>cpu_operator_cost</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1106"><span class='Ref_To_Local'>nrelations</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if include_planner &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN1071"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cached_plan_cost &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetCachedPlan: get a cached plan from a CachedPlanSource. 
 * 
 * This function hides the logic that decides whether to use a generic 
 * plan or a custom plan for the given parameters: the caller does not know 
 * which it will get. 
 * 
 * On return, the plan is valid and we have sufficient locks to begin 
 * execution. 
 * 
 * On return, the refcount of the plan has been incremented; a later 
 * ReleaseCachedPlan() call is expected.  The refcount has been reported 
 * to the CurrentResourceOwner if useResOwner is true (note that that must 
 * only be true if it's a "saved" CachedPlanSource). 
 * 
 * Note: if any replanning activity is required, the caller's memory context 
 * is used for that work. 
 */ 
</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>* 
</span><a name="LN1134"></a><span class='Declare_Function'>GetCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, </span><a href="../../../include/nodes/params.h.html#LN61"><span class='Ref_to_Typedef'>ParamListInfo</span></a> <span class='Declare_Parameter'>boundParams</span><span class='Delimiter'>, 
</span><a name="LN1135"></a>              <span class='Keyword'>bool </span><span class='Declare_Parameter'>useResOwner</span><span class='Delimiter'>, </span><a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1137"></a>    <a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plan</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1138"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>qlist</span><span class='Delimiter'>; 
</span><a name="LN1139"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>customplan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert caller is doing things in a sane order */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* This seems worth a real test, though */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>useResOwner</span></a> <span class='Operator'>&& !</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot apply ResourceOwner to non-saved cached plan"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure the querytree list is valid and we have parse-time locks */ 
</span>    <a href="plancache.c.html#LN1138"><span class='Ref_To_Local'>qlist</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN90"><span class='Ref_to_Proto'>RevalidateCachedQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Decide whether to use a custom plan */ 
</span>    <a href="plancache.c.html#LN1139"><span class='Ref_To_Local'>customplan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN95"><span class='Ref_to_Proto'>choose_custom_plan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>boundParams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1139"><span class='Ref_To_Local'>customplan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN92"><span class='Ref_to_Proto'>CheckCachedPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We want a generic plan, and we already have a valid one */ 
</span>            <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Build a new generic plan */ 
</span>            <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN93"><span class='Ref_to_Proto'>BuildCachedPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1138"><span class='Ref_To_Local'>qlist</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Just make real sure plansource-&GT;gplan is clear */ 
</span>            <a href="plancache.c.html#LN89"><span class='Ref_to_Proto'>ReleaseGenericPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Link the new generic plan into the plansource */ 
</span>            <a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>; 
</span>            <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Immediately reparent into appropriate context */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* saved plans all live under CacheMemoryContext */ 
</span>                <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="../mmgr/mcxt.c.html#LN45"><span class='Ref_to_Global_Var'>CacheMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN134"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* otherwise, it should be a sibling of the plansource */ 
</span>                <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/utils/memutils.h.html#LN81"><span class='Ref_to_Proto'>MemoryContextGetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* Update generic_cost whenever we make a new generic plan */ 
</span>            <a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN97"><span class='Ref_to_Proto'>cached_plan_cost</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If, based on the now-known value of generic_cost, we'd not have 
             * chosen to use a generic plan, then forget it and make a custom 
             * plan.  This is a bit of a wart but is necessary to avoid a 
             * glitch in behavior when the custom plans are consistently big 
             * winners; at some point we'll experiment with a generic plan and 
             * find it's a loser, but we don't want to actually execute that 
             * plan. 
             */ 
</span>            <a href="plancache.c.html#LN1139"><span class='Ref_To_Local'>customplan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN95"><span class='Ref_to_Proto'>choose_custom_plan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>boundParams</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If we choose to plan again, we need to re-copy the query_list, 
             * since the planner probably scribbled on it.  We can force 
             * BuildCachedPlan to do that by passing NIL. 
             */ 
</span>            <a href="plancache.c.html#LN1138"><span class='Ref_To_Local'>qlist</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !customplan &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1139"><span class='Ref_To_Local'>customplan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Build a custom plan */ 
</span>        <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN93"><span class='Ref_to_Proto'>BuildCachedPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1138"><span class='Ref_To_Local'>qlist</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>boundParams</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Accumulate total costs of custom plans, but 'ware overflow */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a> <span class='Operator'>&LT; </span>INT_MAX<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a> <span class='Operator'>+= </span><a href="plancache.c.html#LN97"><span class='Ref_to_Proto'>cached_plan_cost</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Flag the plan as in use by caller */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>useResOwner</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN56"><span class='Ref_to_Proto'>ResourceOwnerEnlargePlanCacheRefs</span></a><span class='Parentheses'>(</span><a href="../resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1135"><span class='Ref_to_Parameter'>useResOwner</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN57"><span class='Ref_to_Proto'>ResourceOwnerRememberPlanCacheRef</span></a><span class='Parentheses'>(</span><a href="../resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Saved plans should be under CacheMemoryContext so they will not go away 
     * until their reference count goes to zero.  In the generic-plan cases we 
     * already took care of that, but for a custom plan, do it as soon as we 
     * have created a reference-counted link. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1139"><span class='Ref_To_Local'>customplan</span></a> <span class='Operator'>&& </span><a href="plancache.c.html#LN1134"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="../mmgr/mcxt.c.html#LN45"><span class='Ref_to_Global_Var'>CacheMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN134"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN1137"><span class='Ref_To_Local'>plan</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ReleaseCachedPlan: release active use of a cached plan. 
 * 
 * This decrements the reference count, and frees the plan if the count 
 * has thereby gone to zero.  If useResOwner is true, it is assumed that 
 * the reference count is managed by the CurrentResourceOwner. 
 * 
 * Note: useResOwner = false is used for releasing references that are in 
 * persistent data structures, such as the parent CachedPlanSource or a 
 * Portal.  Transient references should be protected by a resource owner. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1255"></a><span class='Declare_Function'>ReleaseCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plan</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>useResOwner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>useResOwner</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN134"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner_private.h.html#LN59"><span class='Ref_to_Proto'>ResourceOwnerForgetPlanCacheRef</span></a><span class='Parentheses'>(</span><a href="../resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN141"><span class='Ref_to_Member'>refcount</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Mark it no longer valid */ 
</span>        <a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* One-shot plans do not own their context, so we can't free them */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN133"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1255"><span class='Ref_to_Parameter'>plan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ReleaseCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CachedPlanSetParentContext: move a CachedPlanSource to a new memory context 
 * 
 * This can only be applied to unsaved plans; once saved, a plan always 
 * lives underneath CacheMemoryContext. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1283"></a><span class='Declare_Function'>CachedPlanSetParentContext</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN1284"></a>                           <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>newcontext</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Assert caller is doing things in a sane order */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* These seem worth real tests, though */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot move a saved cached plan to another context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot move a one-shot cached plan to another context"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, let the caller keep the plan where he wishes */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1284"><span class='Ref_to_Parameter'>newcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The query_context needs no special handling, since it's a child of 
     * plansource-&GT;context.  But if there's a generic plan, it should be 
     * maintained as a sibling of plansource-&GT;context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN131"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN25"><span class='Ref_to_Const'>CACHEDPLAN_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memutils.h.html#LN78"><span class='Ref_to_Proto'>MemoryContextSetParent</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1283"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN142"><span class='Ref_to_Member'>context</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1284"><span class='Ref_to_Parameter'>newcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end CachedPlanSetParentContext &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CopyCachedPlan: make a copy of a CachedPlanSource 
 * 
 * This is a convenience routine that does the equivalent of 
 * CreateCachedPlan + CompleteCachedPlan, using the data stored in the 
 * input CachedPlanSource.  The result is therefore "unsaved" (regardless 
 * of the state of the source), and we don't copy any generic plan either. 
 * The result will be currently valid, or not, the same as the source. 
 */ 
</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>* 
</span><a name="LN1321"></a><span class='Declare_Function'>CopyCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1323"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newsource</span><span class='Delimiter'>; 
</span><a name="LN1324"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>source_context</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>querytree_context</span><span class='Delimiter'>; 
</span><a name="LN1326"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * One-shot plans can't be copied, because we haven't taken care that 
     * parsing/planning didn't scribble on the raw parse tree or querytrees. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot copy a one-shot cached plan"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1324"><span class='Ref_To_Local'>source_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN36"><span class='Ref_to_Global_Var'>CurrentMemoryContext</span></a><span class='Delimiter'>, 
</span>                                           <span class='String'>"CachedPlanSource"</span><span class='Delimiter'>, 
</span>                                           <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1326"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1324"><span class='Ref_To_Local'>source_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN34"><span class='Ref_to_Proto'>palloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN82"><span class='Ref_to_Member'>raw_parse_tree</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN83"><span class='Ref_to_Member'>query_string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN84"><span class='Ref_to_Member'>commandTag</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN84"><span class='Ref_to_Member'>commandTag</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a><span class='Delimiter'>, 
</span>               <a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN85"><span class='Ref_to_Member'>param_types</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN86"><span class='Ref_to_Member'>num_params</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN87"><span class='Ref_to_Member'>parserSetup</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN88"><span class='Ref_to_Member'>parserSetupArg</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN89"><span class='Ref_to_Member'>cursor_options</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN90"><span class='Ref_to_Member'>fixed_result</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a><span class='Parentheses'>) 
</span>        <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><a href="../../../include/access/tupdesc.h.html#LN88"><span class='Ref_to_Proto'>CreateTupleDescCopy</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN92"><span class='Ref_to_Member'>context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1324"><span class='Ref_To_Local'>source_context</span></a><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1325"><span class='Ref_To_Local'>querytree_context</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1324"><span class='Ref_To_Local'>source_context</span></a><span class='Delimiter'>, 
</span>                                              <span class='String'>"CachedPlanQuery"</span><span class='Delimiter'>, 
</span>                                              <a href="../../../include/utils/memutils.h.html#LN181"><span class='Ref_to_Const'>ALLOCSET_START_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1325"><span class='Ref_To_Local'>querytree_context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/nodes.h.html#LN618"><span class='Ref_to_Macro'>copyObject</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a><span class='Parentheses'>) 
</span>        <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/namespace.h.html#LN137"><span class='Ref_to_Proto'>CopyOverrideSearchPath</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN97"><span class='Ref_to_Member'>search_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN99"><span class='Ref_to_Member'>query_context</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1325"><span class='Ref_To_Local'>querytree_context</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN100"><span class='Ref_to_Member'>rewriteRoleId</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN101"><span class='Ref_to_Member'>rewriteRowSecurity</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN102"><span class='Ref_to_Member'>dependsOnRLS</span></a><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN106"><span class='Ref_to_Member'>is_oneshot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN108"><span class='Ref_to_Member'>is_saved</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN110"><span class='Ref_to_Member'>generation</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN110"><span class='Ref_to_Member'>generation</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We may as well copy any acquired cost knowledge */ 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN114"><span class='Ref_to_Member'>generic_cost</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN115"><span class='Ref_to_Member'>total_custom_cost</span></a><span class='Delimiter'>; 
</span>    <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1321"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN116"><span class='Ref_to_Member'>num_custom_plans</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1326"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="plancache.c.html#LN1323"><span class='Ref_To_Local'>newsource</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CopyCachedPlan &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CachedPlanIsValid: test whether the rewritten querytree within a 
 * CachedPlanSource is currently valid (that is, not marked as being in need 
 * of revalidation). 
 * 
 * This result is only trustworthy (ie, free from race conditions) if 
 * the caller has acquired locks on all the relations used in the plan. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1411"></a><span class='Declare_Function'>CachedPlanIsValid</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1411"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="plancache.c.html#LN1411"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CachedPlanGetTargetList: return tlist, if any, describing plan's output 
 * 
 * The result is guaranteed up-to-date.  However, it is local storage 
 * within the cached plan, and may disappear next time the plan is updated. 
 */ 
</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>* 
</span><a name="LN1424"></a><span class='Declare_Function'>CachedPlanGetTargetList</span><span class='Parentheses'>(</span><a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>plansource</span><span class='Delimiter'>, 
</span><a name="LN1425"></a>                        <a href="../misc/queryenvironment.c.html#LN31"><span class='Ref_to_Struct'>QueryEnvironment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>queryEnv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1427"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>pstmt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assert caller is doing things in a sane order */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1424"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1424"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN107"><span class='Ref_to_Member'>is_complete</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No work needed if statement doesn't return tuples (we assume this 
     * feature cannot be changed by an invalidation) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1424"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN91"><span class='Ref_to_Member'>resultDesc</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure the querytree list is valid and we have parse-time locks */ 
</span>    <a href="plancache.c.html#LN90"><span class='Ref_to_Proto'>RevalidateCachedQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1424"><span class='Ref_to_Parameter'>plansource</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1425"><span class='Ref_to_Parameter'>queryEnv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Get the primary statement and find out what it returns */ 
</span>    <a href="plancache.c.html#LN1427"><span class='Ref_To_Local'>pstmt</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN98"><span class='Ref_to_Proto'>QueryListGetPrimaryStmt</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1424"><span class='Ref_to_Parameter'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/tcop/pquery.h.html#LN27"><span class='Ref_to_Proto'>FetchStatementTargetList</span></a><span class='Parentheses'>((</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plancache.c.html#LN1427"><span class='Ref_To_Local'>pstmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CachedPlanGetTargetList &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * QueryListGetPrimaryStmt 
 *      Get the "primary" stmt within a list, ie, the one marked canSetTag. 
 * 
 * Returns NULL if no such stmt.  If multiple queries within the list are 
 * marked canSetTag, returns the first one.  Neither of these cases should 
 * occur in present usages of this function. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>* 
</span><a name="LN1458"></a><span class='Declare_Function'>QueryListGetPrimaryStmt</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1460"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1460"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1458"><span class='Ref_to_Parameter'>stmts</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1464"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>stmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1460"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1464"><span class='Ref_To_Local'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN115"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="plancache.c.html#LN1464"><span class='Ref_To_Local'>stmt</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AcquireExecutorLocks: acquire locks needed for execution of a cached plan; 
 * or release them if acquire is false. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1477"></a><span class='Declare_Function'>AcquireExecutorLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1479"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc1</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1479"><span class='Ref_To_Local'>lc1</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1477"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1483"></a>        <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plannedstmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1479"><span class='Ref_To_Local'>lc1</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1484"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>rt_index</span><span class='Delimiter'>; 
</span><a name="LN1485"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc2</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN44"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Ignore utility statements, except those (such as EXPLAIN) that 
             * contain a parsed-but-not-planned query.  Note: it's okay to use 
             * ScanQueryForLocks, even though the query hasn't been through 
             * rule rewriting, because rewriting doesn't change the query 
             * representation. 
             */ 
</span><a name="LN1496"></a>            <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span> <span class='Operator'>= </span><a href="../../../include/tcop/utility.h.html#LN46"><span class='Ref_to_Proto'>UtilityContainsQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN93"><span class='Ref_to_Member'>utilityStmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1496"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>) 
</span>                <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1496"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1477"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="plancache.c.html#LN1484"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1485"><span class='Ref_To_Local'>lc2</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN62"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1506"></a>            <a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1485"><span class='Ref_To_Local'>lc2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1507"></a>            <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span><a name="LN1508"></a>            <a href="../../../include/nodes/plannodes.h.html#LN1002"><span class='Ref_to_Struct'>PlanRowMark</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rc</span><span class='Delimiter'>; 
</span> 
            <a href="plancache.c.html#LN1484"><span class='Ref_To_Local'>rt_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1506"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Acquire the appropriate type of lock on each relation OID. Note 
             * that we don't actually try to open the rel, and hence will not 
             * fail if it's been dropped entirely --- we'll just transiently 
             * acquire a non-conflicting lock. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN230"><span class='Ref_to_Proto'>list_member_int</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN65"><span class='Ref_to_Member'>resultRelations</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1484"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>              <a href="../../../include/nodes/pg_list.h.html#LN230"><span class='Ref_to_Proto'>list_member_int</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN71"><span class='Ref_to_Member'>nonleafResultRelations</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1484"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>))</span> 
                <a href="plancache.c.html#LN1507"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plancache.c.html#LN1508"><span class='Ref_To_Local'>rc</span></a> <span class='Operator'>= </span><a href="../../../include/optimizer/prep.h.html#LN45"><span class='Ref_to_Proto'>get_plan_rowmark</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1483"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN85"><span class='Ref_to_Member'>rowMarks</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1484"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                     <a href="../../../include/nodes/plannodes.h.html#LN961"><span class='Ref_to_Macro'>RowMarkRequiresRowShareLock</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1508"><span class='Ref_To_Local'>rc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN1008"><span class='Ref_to_Member'>markType</span></a><span class='Parentheses'>))</span> 
                <a href="plancache.c.html#LN1507"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="plancache.c.html#LN1507"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1477"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1506"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1507"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1506"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1507"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AcquireExecutorLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AcquirePlannerLocks: acquire locks needed for planning of a querytree list; 
 * or release them if acquire is false. 
 * 
 * Note that we don't actually try to open the relations, and hence will not 
 * fail if one has been dropped entirely --- we'll just transiently acquire 
 * a non-conflicting lock. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1547"></a><span class='Declare_Function'>AcquirePlannerLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1549"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1549"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1547"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1553"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1549"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Ignore utility statements, unless they contain a Query */ 
</span>            <a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../../include/tcop/utility.h.html#LN46"><span class='Ref_to_Proto'>UtilityContainsQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN117"><span class='Ref_to_Member'>utilityStmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a><span class='Parentheses'>) 
</span>                <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1547"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1553"><span class='Ref_To_Local'>query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1547"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AcquirePlannerLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ScanQueryForLocks: recursively scan one Query for AcquirePlannerLocks. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1572"></a><span class='Declare_Function'>ScanQueryForLocks</span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parsetree</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1574"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span><a name="LN1575"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>rt_index</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Shouldn't get called on utility commands */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, process RTEs of the current query level. 
     */ 
</span>    <a href="plancache.c.html#LN1575"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1574"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN134"><span class='Ref_to_Member'>rtable</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1586"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rte</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN932"><span class='Ref_to_Struct'>RangeTblEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1574"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1587"></a>        <a href="../../../include/storage/lockdefs.h.html#LN25"><span class='Ref_to_Typedef'>LOCKMODE</span></a>    <span class='Declare_Local'>lockmode</span><span class='Delimiter'>; 
</span> 
        <a href="plancache.c.html#LN1575"><span class='Ref_To_Local'>rt_index</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1586"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN936"><span class='Ref_to_Member'>rtekind</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN922"><span class='Ref_to_EnumConst'>RTE_RELATION</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Acquire or release the appropriate type of lock */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1575"><span class='Ref_To_Local'>rt_index</span></a> <span class='Operator'>== </span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN119"><span class='Ref_to_Member'>resultRelation</span></a><span class='Parentheses'>) 
</span>                    <a href="plancache.c.html#LN1587"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN37"><span class='Ref_to_Const'>RowExclusiveLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/parser/parsetree.h.html#LN76"><span class='Ref_to_Proto'>get_parse_rowmark</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1575"><span class='Ref_To_Local'>rt_index</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <a href="plancache.c.html#LN1587"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN36"><span class='Ref_to_Const'>RowShareLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="plancache.c.html#LN1587"><span class='Ref_To_Local'>lockmode</span></a> <span class='Operator'>= </span><a href="../../../include/storage/lockdefs.h.html#LN35"><span class='Ref_to_Const'>AccessShareLock</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/storage/lmgr.h.html#LN39"><span class='Ref_to_Proto'>LockRelationOid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1586"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1587"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../../include/storage/lmgr.h.html#LN42"><span class='Ref_to_Proto'>UnlockRelationOid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1586"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN947"><span class='Ref_to_Member'>relid</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1587"><span class='Ref_To_Local'>lockmode</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>case</span> <a href="../../../include/nodes/parsenodes.h.html#LN923"><span class='Ref_to_EnumConst'>RTE_SUBQUERY</span></a><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* Recurse into subquery-in-FROM */ 
</span>                <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1586"><span class='Ref_To_Local'>rte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN954"><span class='Ref_to_Member'>subquery</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* ignore other types of RTEs */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch rte-&GT;rtekind &raquo; </span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Recurse into subquery-in-WITH */ 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1574"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN132"><span class='Ref_to_Member'>cteList</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1620"></a>        <a href="../../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cte</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN1339"><span class='Ref_to_Struct'>CommonTableExpr</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1574"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN575"><span class='Ref_to_Macro'>castNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1620"><span class='Ref_To_Local'>cte</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN1345"><span class='Ref_to_Member'>ctequery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Recurse into sublink subqueries, too.  But we already did the ones in 
     * the rtable and cteList. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN125"><span class='Ref_to_Member'>hasSubLinks</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/nodes/nodeFuncs.h.html#LN57"><span class='Ref_to_Proto'>query_tree_walker</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>parsetree</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN102"><span class='Ref_to_Proto'>ScanQueryWalker</span></a><span class='Delimiter'>, 
</span>                          <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Operator'>&</span><a href="plancache.c.html#LN1572"><span class='Ref_to_Parameter'>acquire</span></a><span class='Delimiter'>, 
</span>                          <a href="../../../include/nodes/nodeFuncs.h.html#LN21"><span class='Ref_to_Const'>QTW_IGNORE_RC_SUBQUERIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end ScanQueryForLocks &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Walker to find sublink subqueries for ScanQueryForLocks 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1641"></a><span class='Declare_Function'>ScanQueryWalker</span><span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN508"><span class='Ref_to_Struct'>Node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>node</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>acquire</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>node</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1647"></a>        <a href="../../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>sub</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/primnodes.h.html#LN629"><span class='Ref_to_Struct'>SubLink</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do what we came for */ 
</span>        <a href="plancache.c.html#LN101"><span class='Ref_to_Proto'>ScanQueryForLocks</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN575"><span class='Ref_to_Macro'>castNode</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1647"><span class='Ref_To_Local'>sub</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/primnodes.h.html#LN636"><span class='Ref_to_Member'>subselect</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Fall through to process lefthand args of SubLink */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do NOT recurse into Query nodes, because ScanQueryForLocks already 
     * processed subselects of subselects for us. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../../include/nodes/nodeFuncs.h.html#LN52"><span class='Ref_to_Proto'>expression_tree_walker</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>node</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN102"><span class='Ref_to_Proto'>ScanQueryWalker</span></a><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="plancache.c.html#LN1641"><span class='Ref_to_Parameter'>acquire</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ScanQueryWalker &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PlanCacheComputeResultDesc: given a list of analyzed-and-rewritten Queries, 
 * determine the result tupledesc it will produce.  Returns NULL if the 
 * execution will not return tuples. 
 * 
 * Note: the result is created or copied into current memory context. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a> 
<a name="LN1670"></a><span class='Declare_Function'>PlanCacheComputeResultDesc</span><span class='Parentheses'>(</span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmt_list</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1672"></a>    <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../../include/tcop/pquery.h.html#LN23"><span class='Ref_to_Proto'>ChoosePortalStrategy</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1670"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/portal.h.html#LN89"><span class='Ref_to_EnumConst'>PORTAL_ONE_SELECT</span></a><span class='Operator'>: 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/portal.h.html#LN91"><span class='Ref_to_EnumConst'>PORTAL_ONE_MOD_WITH</span></a><span class='Operator'>: 
</span>            <a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1670"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/executor/executor.h.html#LN406"><span class='Ref_to_Proto'>ExecCleanTypeFromTL</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN137"><span class='Ref_to_Member'>targetList</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/portal.h.html#LN90"><span class='Ref_to_EnumConst'>PORTAL_ONE_RETURNING</span></a><span class='Operator'>: 
</span>            <a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN98"><span class='Ref_to_Proto'>QueryListGetPrimaryStmt</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1670"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/executor/executor.h.html#LN406"><span class='Ref_to_Proto'>ExecCleanTypeFromTL</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN143"><span class='Ref_to_Member'>returningList</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/portal.h.html#LN92"><span class='Ref_to_EnumConst'>PORTAL_UTIL_SELECT</span></a><span class='Operator'>: 
</span>            <a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN113"><span class='Ref_to_Macro'>linitial_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1670"><span class='Ref_to_Parameter'>stmt_list</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN117"><span class='Ref_to_Member'>utilityStmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/tcop/utility.h.html#LN44"><span class='Ref_to_Proto'>UtilityTupleDescriptor</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1672"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN117"><span class='Ref_to_Member'>utilityStmt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/portal.h.html#LN93"><span class='Ref_to_EnumConst'>PORTAL_MULTI_QUERY</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* will not return tuples */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch ChoosePortalStrategy(... &raquo; </span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PlanCacheComputeResultDesc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PlanCacheRelCallback 
 *      Relcache inval callback function 
 * 
 * Invalidate all plans mentioning the given rel, or all plans mentioning 
 * any rel at all if relid == InvalidOid. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1706"></a><span class='Declare_Function'>PlanCacheRelCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1708"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plansource</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No work if it's already invalidated */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Never invalidate transaction control commands */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check the dependency list for the rewritten querytree. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plancache.c.html#LN1706"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>: 
</span>            <a href="../../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN95"><span class='Ref_to_Member'>relationOids</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1706"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Invalidate the querytree and generic plan */ 
</span>            <a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>                <a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The generic plan, if any, could have more dependencies than the 
         * querytree does, so we have to check it too. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>&& </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1740"></a>            <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1740"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1744"></a>                <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plannedstmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1740"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1744"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN44"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Ignore utility statements */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="plancache.c.html#LN1706"><span class='Ref_to_Parameter'>relid</span></a> <span class='Operator'>== </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="plancache.c.html#LN1744"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN87"><span class='Ref_to_Member'>relationOids</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a> <span class='Operator'>: 
</span>                    <a href="../../../include/nodes/pg_list.h.html#LN231"><span class='Ref_to_Proto'>list_member_oid</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1744"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN87"><span class='Ref_to_Member'>relationOids</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1706"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Invalidate the generic plan only */ 
</span>                    <a href="plancache.c.html#LN1708"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* out of stmt_list scan */ 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for plansource=first_save... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PlanCacheRelCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PlanCacheFuncCallback 
 *      Syscache inval callback function for PROCOID cache 
 * 
 * Invalidate all plans mentioning the object with the specified hash value, 
 * or all plans mentioning any member of this cache if hashvalue == 0. 
 * 
 * Note that the coding would support use for multiple caches, but right 
 * now only user-defined functions are tracked this way. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1771"></a><span class='Declare_Function'>PlanCacheFuncCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1773"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plansource</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1777"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No work if it's already invalidated */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Never invalidate transaction control commands */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check the dependency list for the rewritten querytree. 
         */ 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1777"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN96"><span class='Ref_to_Member'>invalItems</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1794"></a>            <a href="../../../include/nodes/plannodes.h.html#LN1025"><span class='Ref_to_Struct'>PlanInvalItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN1025"><span class='Ref_to_Struct'>PlanInvalItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1777"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1794"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN1028"><span class='Ref_to_Member'>cacheId</span></a> <span class='Operator'>!= </span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                <a href="plancache.c.html#LN1794"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN1029"><span class='Ref_to_Member'>hashValue</span></a> <span class='Operator'>== </span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Invalidate the querytree and generic plan */ 
</span>                <a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>                    <a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The generic plan, if any, could have more dependencies than the 
         * querytree does, so we have to check it too. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a> <span class='Operator'>&& </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1777"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN132"><span class='Ref_to_Member'>stmt_list</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1817"></a>                <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plannedstmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1777"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1818"></a>                <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc3</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1817"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN44"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>continue</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Ignore utility statements */ 
</span>                <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1818"><span class='Ref_To_Local'>lc3</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1817"><span class='Ref_To_Local'>plannedstmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN89"><span class='Ref_to_Member'>invalItems</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1824"></a>                    <a href="../../../include/nodes/plannodes.h.html#LN1025"><span class='Ref_to_Struct'>PlanInvalItem</span></a> <span class='Operator'>*</span><span class='Declare_Local'>item</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN1025"><span class='Ref_to_Struct'>PlanInvalItem</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1818"><span class='Ref_To_Local'>lc3</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1824"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN1028"><span class='Ref_to_Member'>cacheId</span></a> <span class='Operator'>!= </span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>cacheid</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>continue</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                        <a href="plancache.c.html#LN1824"><span class='Ref_To_Local'>item</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN1029"><span class='Ref_to_Member'>hashValue</span></a> <span class='Operator'>== </span><a href="plancache.c.html#LN1771"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* Invalidate the generic plan only */ 
</span>                        <a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <span class='Control'>break</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* out of invalItems scan */ 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1773"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* out of stmt_list scan */ 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if plansource-&GT;gplan&&pl... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for plansource=first_save... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end PlanCacheFuncCallback &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PlanCacheSysCallback 
 *      Syscache inval callback function for other caches 
 * 
 * Just invalidate everything... 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1850"></a><span class='Declare_Function'>PlanCacheSysCallback</span><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>cacheid</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/plancache.h.html#LN147"><span class='Ref_to_Proto'>ResetPlanCache</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ResetPlanCache: invalidate all cached plans. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1859"></a><span class='Declare_Function'>ResetPlanCache</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1861"></a>    <a href="../../../include/utils/plancache.h.html#LN79"><span class='Ref_to_Struct'>CachedPlanSource</span></a> <span class='Operator'>*</span><span class='Declare_Local'>plansource</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN87"><span class='Ref_to_Global_Var'>first_saved_plan</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Delimiter'>; </span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a> <span class='Operator'>= </span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN112"><span class='Ref_to_Member'>next_saved</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1865"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN81"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="../../../include/utils/plancache.h.html#LN24"><span class='Ref_to_Const'>CACHEDPLANSOURCE_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No work if it's already invalidated */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We *must not* mark transaction control statements as invalid, 
         * particularly not ROLLBACK, because they may need to be executed in 
         * aborted transactions when we can't revalidate them (cf bug #5269). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN77"><span class='Ref_to_Macro'>IsTransactionStmtPlan</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * In general there is no point in invalidating utility statements 
         * since they have no plans anyway.  So invalidate it only if it 
         * contains at least one non-utility statement, or contains a utility 
         * statement that contains a pre-analyzed query (which could have 
         * dependencies.) 
         */ 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1865"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN94"><span class='Ref_to_Member'>query_list</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1890"></a>            <a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a>      <span class='Operator'>*</span><span class='Declare_Local'>query</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/parsenodes.h.html#LN105"><span class='Ref_to_Struct'>Query</span></a><span class='Delimiter'>, </span><a href="plancache.c.html#LN1865"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1890"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN109"><span class='Ref_to_Member'>commandType</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/nodes.h.html#LN654"><span class='Ref_to_EnumConst'>CMD_UTILITY</span></a> <span class='Operator'>|| 
</span>                <a href="../../../include/tcop/utility.h.html#LN46"><span class='Ref_to_Proto'>UtilityContainsQuery</span></a><span class='Parentheses'>(</span><a href="plancache.c.html#LN1890"><span class='Ref_To_Local'>query</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/parsenodes.h.html#LN117"><span class='Ref_to_Member'>utilityStmt</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* non-utility statement, so invalidate */ 
</span>                <a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN109"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Parentheses'>) 
</span>                    <a href="plancache.c.html#LN1861"><span class='Ref_To_Local'>plansource</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN104"><span class='Ref_to_Member'>gplan</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/plancache.h.html#LN135"><span class='Ref_to_Member'>is_valid</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* no need to look further */ 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for plansource=first_save... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ResetPlanCache &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>