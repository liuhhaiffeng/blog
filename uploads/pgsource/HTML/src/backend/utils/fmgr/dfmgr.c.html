<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\fmgr\dfmgr.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\fmgr\dfmgr.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:56 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * dfmgr.c 
 *    Dynamic function manager code. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/fmgr/dfmgr.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"dynloader.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dynamic_loader.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/hsearch.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* signatures for PostgreSQL-specific library init/fini functions */ 
</span><a name="LN27"></a><span class='Control'>typedef</span> <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Typedef'>PG_init_t</span><span class='Parentheses'>) (</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN28"></a><span class='Control'>typedef</span> <span class='Keyword'>void </span><span class='Parentheses'>(</span><span class='Operator'>*</span><span class='Declare_Typedef'>PG_fini_t</span><span class='Parentheses'>) (</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* hashtable entry for rendezvous variables */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN33"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>varName</span><span class='Delimiter'>[</span><a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>];</span>   <span class='Comment_Single_Line'>/* hash key (must be first) */ 
</span><a name="LN34"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>varValue</span><span class='Delimiter'>; 
</span><a name="LN35"></a>} <span class='Declare_Typedef'>rendezvousHashEntry</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * List of dynamically loaded files (kept in malloc'd memory). 
 */ 
</span> 
<a name="LN41"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>df_files</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <span class='Control'>struct</span> <a href="dfmgr.c.html#LN41"><span class='Ref_to_Struct'>df_files</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* List link */ 
</span><a name="LN44"></a>    dev_t       <span class='Declare_Member'>device</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Device file is on */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a>                   <span class='Comment_Multi_Line'>/* ensures we never again depend on this under 
                                 * win32 */ 
</span>    ino_t       inode<span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Inode number of file */ 
</span><span class='Directive'>#endif</span> 
<a name="LN49"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>handle</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* a handle for pg_dl* functions */ 
</span><a name="LN50"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>filename</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>];</span>        <span class='Comment_Single_Line'>/* Full pathname of file */ 
</span><a name="LN51"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>DynamicFileList</span><span class='Delimiter'>; 
</span> 
<a name="LN53"></a><span class='Keyword'>static </span><a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Var'>file_list</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN54"></a><span class='Keyword'>static </span><a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Var'>file_tail</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* stat() call under Win32 returns an st_ino field, but it has no meaning */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN58"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SAME_INODE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>A</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>B</span><span class='Parentheses'>) ((</span><a href="dfmgr.c.html#LN58"><span class='Ref_to_Parameter'>A</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>st_ino <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN58"><span class='Ref_to_Parameter'>B</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>inode <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN58"><span class='Ref_to_Parameter'>A</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>st_dev <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN58"><span class='Ref_to_Parameter'>B</span></a><span class='Parentheses'>)</span><span class='Operator'>.</span>device<span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
<a name="LN60"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>SAME_INODE</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>A</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>B</span><span class='Parentheses'>) </span><span class='Boolean'>false 
</span><span class='Directive'>#endif</span> 
 
<a name="LN63"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>Dynamic_library_path</span><span class='Delimiter'>; 
</span> 
<a name="LN65"></a><span class='Keyword'>static void </span><span class='Operator'>*</span><span class='Declare_Prototype'>internal_load_library</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Keyword'>static void </span><a href="dfmgr.c.html#LN296"><span class='Ref_to_Func'>incompatible_module_error</span></a><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span>libname<span class='Delimiter'>, 
</span><a name="LN67"></a>           <span class='Keyword'>const </span><a href="../../../include/fmgr.h.html#LN410"><span class='Ref_to_Typedef'>Pg_magic_struct</span></a> <span class='Operator'>*</span>module_magic_data<span class='Parentheses'>) </span><span class='Declare_Var'>pg_attribute_noreturn</span><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN68"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>internal_unload_library</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libname</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN69"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>file_exists</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN70"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>expand_dynamic_library_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN71"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>check_restricted_library_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN72"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>substitute_libpath_macro</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN73"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Prototype'>find_in_dynamic_libpath</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>basename</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Magic structure that module needs to match to be accepted */ 
</span><a name="LN76"></a><span class='Keyword'>static const </span><a href="../../../include/fmgr.h.html#LN410"><span class='Ref_to_Typedef'>Pg_magic_struct</span></a> <span class='Declare_Var'>magic_data</span> <span class='Operator'>= </span><a href="../../../include/fmgr.h.html#LN422"><span class='Ref_to_Const'>PG_MODULE_MAGIC_DATA</span></a><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load the specified dynamic-link library file, and look for a function 
 * named funcname in it. 
 * 
 * If the function is not found, we raise an error if signalNotFound is true, 
 * else return (PGFunction) NULL.  Note that errors in loading the library 
 * will provoke ereport() regardless of signalNotFound. 
 * 
 * If filehandle is not NULL, then *filehandle will be set to a handle 
 * identifying the library file.  The filehandle can be used with 
 * lookup_external_function to lookup additional functions in the same file 
 * at less cost than repeating load_external_function. 
 */ 
</span><a href="../../../include/fmgr.h.html#LN39"><span class='Ref_to_Typedef'>PGFunction</span></a> 
<a name="LN93"></a><span class='Declare_Function'>load_external_function</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Delimiter'>, 
</span><a name="LN94"></a>                       <span class='Keyword'>bool </span><span class='Declare_Parameter'>signalNotFound</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>**</span><span class='Declare_Parameter'>filehandle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN96"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fullname</span><span class='Delimiter'>; 
</span><a name="LN97"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Local'>lib_handle</span><span class='Delimiter'>; 
</span><a name="LN98"></a>    <a href="../../../include/fmgr.h.html#LN39"><span class='Ref_to_Typedef'>PGFunction</span></a>  <span class='Declare_Local'>retval</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Expand the possibly-abbreviated filename to an exact path name */ 
</span>    <a href="dfmgr.c.html#LN96"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN70"><span class='Ref_to_Proto'>expand_dynamic_library_name</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN93"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the shared library, unless we already did */ 
</span>    <a href="dfmgr.c.html#LN97"><span class='Ref_To_Local'>lib_handle</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN65"><span class='Ref_to_Proto'>internal_load_library</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN96"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Return handle if caller wants it */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN94"><span class='Ref_to_Parameter'>filehandle</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="dfmgr.c.html#LN94"><span class='Ref_to_Parameter'>filehandle</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN97"><span class='Ref_To_Local'>lib_handle</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Look up the function within the library.  According to POSIX dlsym() 
     * should declare its second argument as "const char *", but older 
     * platforms might not, so for the time being we just cast away const. 
     */ 
</span>    <a href="dfmgr.c.html#LN98"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN39"><span class='Ref_to_Typedef'>PGFunction</span></a><span class='Parentheses'>) </span><a href="../../port/dynloader/darwin.h.html#LN5"><span class='Ref_to_Proto'>pg_dlsym</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN97"><span class='Ref_To_Local'>lib_handle</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN93"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN98"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="dfmgr.c.html#LN94"><span class='Ref_to_Parameter'>signalNotFound</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_FUNCTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not find function \"%s\" in file \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="dfmgr.c.html#LN93"><span class='Ref_to_Parameter'>funcname</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN96"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN96"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="dfmgr.c.html#LN98"><span class='Ref_To_Local'>retval</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end load_external_function &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * This function loads a shlib file without looking up any particular 
 * function in it.  If the same shlib has previously been loaded, 
 * unload and reload it. 
 * 
 * When 'restricted' is true, only libraries in the presumed-secure 
 * directory $libdir/plugins may be referenced. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN136"></a><span class='Declare_Function'>load_file</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>restricted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN138"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>fullname</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Apply security restriction if requested */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN136"><span class='Ref_to_Parameter'>restricted</span></a><span class='Parentheses'>) 
</span>        <a href="dfmgr.c.html#LN71"><span class='Ref_to_Proto'>check_restricted_library_name</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN136"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Expand the possibly-abbreviated filename to an exact path name */ 
</span>    <a href="dfmgr.c.html#LN138"><span class='Ref_To_Local'>fullname</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN70"><span class='Ref_to_Proto'>expand_dynamic_library_name</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN136"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Unload the library if currently loaded */ 
</span>    <a href="dfmgr.c.html#LN68"><span class='Ref_to_Proto'>internal_unload_library</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN138"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Load the shared library */ 
</span>    <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN65"><span class='Ref_to_Proto'>internal_load_library</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN138"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN138"><span class='Ref_To_Local'>fullname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end load_file &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Lookup a function whose library file is already loaded. 
 * Return (PGFunction) NULL if not found. 
 */ 
</span><a href="../../../include/fmgr.h.html#LN39"><span class='Ref_to_Typedef'>PGFunction</span></a> 
<a name="LN161"></a><span class='Declare_Function'>lookup_external_function</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>filehandle</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>funcname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* as above, cast away const for the time being */ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN39"><span class='Ref_to_Typedef'>PGFunction</span></a><span class='Parentheses'>) </span><a href="../../port/dynloader/darwin.h.html#LN5"><span class='Ref_to_Proto'>pg_dlsym</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN161"><span class='Ref_to_Parameter'>filehandle</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN161"><span class='Ref_to_Parameter'>funcname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Load the specified dynamic-link library file, unless it already is 
 * loaded.  Return the pg_dl* handle for the file. 
 * 
 * Note: libname is expected to be an exact name for the library file. 
 */ 
</span><span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN175"></a><span class='Declare_Function'>internal_load_library</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN177"></a>    <a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>file_scanner</span><span class='Delimiter'>; 
</span><a name="LN178"></a>    <a href="../../../include/fmgr.h.html#LN437"><span class='Ref_to_Typedef'>PGModuleMagicFunction</span></a> <span class='Declare_Local'>magic_func</span><span class='Delimiter'>; 
</span><a name="LN179"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>load_error</span><span class='Delimiter'>; 
</span><a name="LN180"></a>    <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>stat_buf</span><span class='Delimiter'>; 
</span><a name="LN181"></a>    <a href="dfmgr.c.html#LN27"><span class='Ref_to_Typedef'>PG_init_t</span></a>   <span class='Declare_Local'>PG_init</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Scan the list of loaded FILES to see if the file has been loaded. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>         strcmp<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Check for same files - different paths (ie, symlink or link) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dfmgr.c.html#LN180"><span class='Ref_To_Local'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not access file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a><span class='Delimiter'>; 
</span>             <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>             <span class='Operator'>!</span><a href="dfmgr.c.html#LN58"><span class='Ref_to_Macro'>SAME_INODE</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN180"><span class='Ref_To_Local'>stat_buf</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>             <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * File not loaded yet. 
         */ 
</span>        <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a><span class='Delimiter'>, </span><a href="../../../bin/pg_test_fsync/pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>+</span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a><span class='Delimiter'>, </span><a href="../../../bin/pg_test_fsync/pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN44"><span class='Ref_to_Member'>device</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN180"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_dev<span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span>inode <span class='Operator'>= </span><a href="dfmgr.c.html#LN180"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_ino<span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>= </span><a href="../../port/dynloader/darwin.h.html#LN4"><span class='Ref_to_Proto'>pg_dlopen</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dfmgr.c.html#LN179"><span class='Ref_To_Local'>load_error</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../port/dynloader/darwin.h.html#LN7"><span class='Ref_to_Proto'>pg_dlerror</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* errcode_for_file_access might not be appropriate here? */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not load library \"%s\": %s"</span><span class='Delimiter'>, 
</span>                            <a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN179"><span class='Ref_To_Local'>load_error</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Check the magic function to determine compatibility */ 
</span>        <a href="dfmgr.c.html#LN178"><span class='Ref_To_Local'>magic_func</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN437"><span class='Ref_to_Typedef'>PGModuleMagicFunction</span></a><span class='Parentheses'>) 
</span>            <a href="../../port/dynloader/darwin.h.html#LN5"><span class='Ref_to_Proto'>pg_dlsym</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Delimiter'>, </span><a href="../../../include/fmgr.h.html#LN440"><span class='Ref_to_Const'>PG_MAGIC_FUNCTION_NAME_STRING</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN178"><span class='Ref_To_Local'>magic_func</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN247"></a>            <span class='Keyword'>const </span><a href="../../../include/fmgr.h.html#LN410"><span class='Ref_to_Typedef'>Pg_magic_struct</span></a> <span class='Operator'>*</span><span class='Declare_Local'>magic_data_ptr</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dfmgr.c.html#LN178"><span class='Ref_To_Local'>magic_func</span></a><span class='Parentheses'>) ()</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN247"><span class='Ref_To_Local'>magic_data_ptr</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN412"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN412"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>|| 
</span>                memcmp<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN247"><span class='Ref_To_Local'>magic_data_ptr</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN412"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* copy data block before unlinking library */ 
</span><a name="LN253"></a>                <a href="../../../include/fmgr.h.html#LN410"><span class='Ref_to_Typedef'>Pg_magic_struct</span></a> <span class='Declare_Local'>module_magic_data</span> <span class='Operator'>= *</span><a href="dfmgr.c.html#LN247"><span class='Ref_To_Local'>magic_data_ptr</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* try to unlink library */ 
</span>                <a href="../../port/dynloader/darwin.h.html#LN6"><span class='Ref_to_Proto'>pg_dlclose</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* issue suitable complaint */ 
</span>                <a href="dfmgr.c.html#LN296"><span class='Ref_to_Func'>incompatible_module_error</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dfmgr.c.html#LN253"><span class='Ref_To_Local'>module_magic_data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* try to unlink library */ 
</span>            <a href="../../port/dynloader/darwin.h.html#LN6"><span class='Ref_to_Proto'>pg_dlclose</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* complain */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                  <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incompatible library \"%s\": missing magic block"</span><span class='Delimiter'>, 
</span>                          <a href="dfmgr.c.html#LN175"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                   <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Extension libraries are required to use the PG_MODULE_MAGIC macro."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the library has a _PG_init() function, call it. 
         */ 
</span>        <a href="dfmgr.c.html#LN181"><span class='Ref_To_Local'>PG_init</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN27"><span class='Ref_to_Typedef'>PG_init_t</span></a><span class='Parentheses'>) </span><a href="../../port/dynloader/darwin.h.html#LN5"><span class='Ref_to_Proto'>pg_dlsym</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Delimiter'>, </span><span class='String'>"_PG_init"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN181"><span class='Ref_To_Local'>PG_init</span></a><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dfmgr.c.html#LN181"><span class='Ref_To_Local'>PG_init</span></a><span class='Parentheses'>) ()</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* OK to link it into list */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dfmgr.c.html#LN54"><span class='Ref_to_Global_Var'>file_tail</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN54"><span class='Ref_to_Global_Var'>file_tail</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if file_scanner==NULL &raquo; </span> 
 
    <span class='Control'>return</span> <a href="dfmgr.c.html#LN177"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end internal_load_library &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Report a suitable error for an incompatible magic block. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN297"></a><span class='Declare_Function'>incompatible_module_error</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libname</span><span class='Delimiter'>, 
</span><a name="LN298"></a>                          <span class='Keyword'>const </span><a href="../../../include/fmgr.h.html#LN410"><span class='Ref_to_Typedef'>Pg_magic_struct</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>module_magic_data</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN300"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>details</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the version doesn't match, just report that, because the rest of the 
     * block might not even have the fields we expect. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN308"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>library_version</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1000</span><span class='Parentheses'>) 
</span>            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN308"><span class='Ref_To_Local'>library_version</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN308"><span class='Ref_To_Local'>library_version</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, 
</span>                     <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN308"><span class='Ref_To_Local'>library_version</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN308"><span class='Ref_To_Local'>library_version</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d.%d"</span><span class='Delimiter'>, 
</span>                     <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>, 
</span>                     <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>% </span><span class='Number'>100</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incompatible library \"%s\": version mismatch"</span><span class='Delimiter'>, 
</span>                        <a href="dfmgr.c.html#LN297"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Server is version %d, library is version %s."</span><span class='Delimiter'>, 
</span>                           <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN413"><span class='Ref_to_Member'>version</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN308"><span class='Ref_To_Local'>library_version</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Otherwise, spell out which fields don't agree. 
     * 
     * XXX this code has to be adjusted any time the set of fields in a magic 
     * block change! 
     */ 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN414"><span class='Ref_to_Member'>funcmaxargs</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN414"><span class='Ref_to_Member'>funcmaxargs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"Server has FUNC_MAX_ARGS = %d, library has %d."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN414"><span class='Ref_to_Member'>funcmaxargs</span></a><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN414"><span class='Ref_to_Member'>funcmaxargs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN415"><span class='Ref_to_Member'>indexmaxkeys</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN415"><span class='Ref_to_Member'>indexmaxkeys</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"Server has INDEX_MAX_KEYS = %d, library has %d."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN415"><span class='Ref_to_Member'>indexmaxkeys</span></a><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN415"><span class='Ref_to_Member'>indexmaxkeys</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN416"><span class='Ref_to_Member'>namedatalen</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN416"><span class='Ref_to_Member'>namedatalen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>                         _<span class='Parentheses'>(</span><span class='String'>"Server has NAMEDATALEN = %d, library has %d."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN416"><span class='Ref_to_Member'>namedatalen</span></a><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN416"><span class='Ref_to_Member'>namedatalen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN417"><span class='Ref_to_Member'>float4byval</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN417"><span class='Ref_to_Member'>float4byval</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>                       _<span class='Parentheses'>(</span><span class='String'>"Server has FLOAT4PASSBYVAL = %s, library has %s."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN417"><span class='Ref_to_Member'>float4byval</span></a> <span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN417"><span class='Ref_to_Member'>float4byval</span></a> <span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN418"><span class='Ref_to_Member'>float8byval</span></a> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN418"><span class='Ref_to_Member'>float8byval</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>) 
</span>            <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>                       _<span class='Parentheses'>(</span><span class='String'>"Server has FLOAT8PASSBYVAL = %s, library has %s."</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN76"><span class='Ref_to_Global_Var'>magic_data</span></a><span class='Operator'>.</span><a href="../../../include/fmgr.h.html#LN418"><span class='Ref_to_Member'>float8byval</span></a> <span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Delimiter'>, 
</span>                         <a href="dfmgr.c.html#LN298"><span class='Ref_to_Parameter'>module_magic_data</span></a><span class='Operator'>-&GT;</span><a href="../../../include/fmgr.h.html#LN418"><span class='Ref_to_Member'>float8byval</span></a> <span class='Operator'>? </span><span class='String'>"true"</span> <span class='Operator'>: </span><span class='String'>"false"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Delimiter'>, 
</span>              _<span class='Parentheses'>(</span><span class='String'>"Magic block has unexpected length or padding difference."</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"incompatible library \"%s\": magic block mismatch"</span><span class='Delimiter'>, 
</span>                    <a href="dfmgr.c.html#LN297"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="../error/elog.c.html#LN898"><span class='Ref_to_Func'>errdetail_internal</span></a><span class='Parentheses'>(</span><span class='String'>"%s"</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN300"><span class='Ref_To_Local'>details</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end incompatible_module_error &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Unload the specified dynamic-link library file, if it is loaded. 
 * 
 * Note: libname is expected to be an exact name for the library file. 
 * 
 * XXX for the moment, this is disabled, resulting in LOAD of an already-loaded 
 * library always being a no-op.  We might re-enable it someday if we can 
 * convince ourselves we have safe protocols for un-hooking from hook function 
 * pointers, releasing custom GUC variables, and perhaps other things that 
 * are definitely unsafe currently. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN400"></a><span class='Declare_Function'>internal_unload_library</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libname</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> NOT_USED 
<a name="LN403"></a>    <a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>file_scanner</span><span class='Delimiter'>, 
</span><a name="LN404"></a>               <span class='Operator'>*</span><span class='Declare_Local'>prv</span><span class='Delimiter'>, 
</span><a name="LN405"></a>               <span class='Operator'>*</span><span class='Declare_Local'>nxt</span><span class='Delimiter'>; 
</span><a name="LN406"></a>    <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>stat_buf</span><span class='Delimiter'>; 
</span><a name="LN407"></a>    <a href="dfmgr.c.html#LN28"><span class='Ref_to_Typedef'>PG_fini_t</span></a>   <span class='Declare_Local'>PG_fini</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need to do stat() in order to determine whether this is the same 
     * file as a previously loaded file; it's also handy so as to give a good 
     * error message if bogus file name given. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN400"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dfmgr.c.html#LN406"><span class='Ref_To_Local'>stat_buf</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not access file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN400"><span class='Ref_to_Parameter'>libname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We have to zap all entries in the list that match on either filename or 
     * inode, else internal_load_library() will still think it's present. 
     */ 
</span>    <a href="dfmgr.c.html#LN404"><span class='Ref_To_Local'>prv</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a><span class='Delimiter'>; </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN405"><span class='Ref_To_Local'>nxt</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN405"><span class='Ref_To_Local'>nxt</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN400"><span class='Ref_to_Parameter'>libname</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <a href="dfmgr.c.html#LN58"><span class='Ref_to_Macro'>SAME_INODE</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN406"><span class='Ref_To_Local'>stat_buf</span></a><span class='Delimiter'>, </span><span class='Operator'>*</span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN404"><span class='Ref_To_Local'>prv</span></a><span class='Parentheses'>) 
</span>                <a href="dfmgr.c.html#LN404"><span class='Ref_To_Local'>prv</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN405"><span class='Ref_To_Local'>nxt</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN405"><span class='Ref_To_Local'>nxt</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If the library has a _PG_fini() function, call it. 
             */ 
</span>            <a href="dfmgr.c.html#LN407"><span class='Ref_To_Local'>PG_fini</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN28"><span class='Ref_to_Typedef'>PG_fini_t</span></a><span class='Parentheses'>) </span><a href="../../port/dynloader/darwin.h.html#LN5"><span class='Ref_to_Proto'>pg_dlsym</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Delimiter'>, </span><span class='String'>"_PG_fini"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN407"><span class='Ref_To_Local'>PG_fini</span></a><span class='Parentheses'>) 
</span>                <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dfmgr.c.html#LN407"><span class='Ref_To_Local'>PG_fini</span></a><span class='Parentheses'>) ()</span><span class='Delimiter'>; 
</span> 
            <a href="fmgr.c.html#LN506"><span class='Ref_to_Func'>clear_external_function_hash</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../port/dynloader/darwin.h.html#LN6"><span class='Ref_to_Proto'>pg_dlclose</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN49"><span class='Ref_to_Member'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* prv does not change */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(libname,file_s... &raquo; </span> 
        <span class='Control'>else</span> 
            <a href="dfmgr.c.html#LN404"><span class='Ref_To_Local'>prv</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN403"><span class='Ref_To_Local'>file_scanner</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for file_scanner=file_lis... &raquo; </span> 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* NOT_USED */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end internal_unload_library &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN454"></a><span class='Declare_Function'>file_exists</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN456"></a>    <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>st</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN454"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN454"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dfmgr.c.html#LN456"><span class='Ref_To_Local'>st</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <a href="../../../include/port/win32.h.html#LN429"><span class='Ref_to_Macro'>S_ISDIR</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN456"><span class='Ref_To_Local'>st</span></a><span class='Operator'>.</span>st_mode<span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Boolean'>false </span><span class='Operator'>: </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT <span class='Operator'>|| </span>errno <span class='Operator'>== </span>ENOTDIR <span class='Operator'>|| </span>errno <span class='Operator'>== </span>EACCES<span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not access file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN454"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* Example format: ".so" */ 
</span><span class='Directive'>#ifndef</span> <a href="../../../include/port/win32.h.html#LN442"><span class='Ref_to_Const'>DLSUFFIX</span></a> 
#error <span class='String'>"DLSUFFIX must be defined to compile this file."</span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * If name contains a slash, check if the file exists, if so return 
 * the name.  Else (no slash) try to expand using search path (see 
 * find_in_dynamic_libpath below); if that works, return the fully 
 * expanded file name.  If the previous failed, append DLSUFFIX and 
 * try again.  If all fails, just return the original name. 
 * 
 * The result will always be freshly palloc'd. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN486"></a><span class='Declare_Function'>expand_dynamic_library_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN488"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>have_slash</span><span class='Delimiter'>; 
</span><a name="LN489"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>new</span><span class='Delimiter'>; 
</span><a name="LN490"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>full</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dfmgr.c.html#LN488"><span class='Ref_To_Local'>have_slash</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dfmgr.c.html#LN488"><span class='Ref_To_Local'>have_slash</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN73"><span class='Ref_to_Proto'>find_in_dynamic_libpath</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN72"><span class='Ref_to_Proto'>substitute_libpath_macro</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../test/regress/pg_regress.h.html#LN52"><span class='Ref_to_Proto'>file_exists</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>new</span> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s%s"</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="../../../include/port/win32.h.html#LN442"><span class='Ref_to_Const'>DLSUFFIX</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dfmgr.c.html#LN488"><span class='Ref_To_Local'>have_slash</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN73"><span class='Ref_to_Proto'>find_in_dynamic_libpath</span></a><span class='Parentheses'>(</span><span class='Control'>new</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><span class='Control'>new</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN72"><span class='Ref_to_Proto'>substitute_libpath_macro</span></a><span class='Parentheses'>(</span><span class='Control'>new</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><span class='Control'>new</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../test/regress/pg_regress.h.html#LN52"><span class='Ref_to_Proto'>file_exists</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN490"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we can't find the file, just return the string as-is. The ensuing 
     * load attempt will fail and report a suitable message. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN486"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end expand_dynamic_library_name &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check a restricted library name.  It must begin with "$libdir/plugins/" 
 * and there must not be any directory separators after that (this is 
 * sufficient to prevent ".." style attacks). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN541"></a><span class='Declare_Function'>check_restricted_library_name</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN541"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><span class='String'>"$libdir/plugins/"</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN541"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>+ </span><span class='Number'>16</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"access to library \"%s\" is not allowed"</span><span class='Delimiter'>, 
</span>                        <a href="dfmgr.c.html#LN541"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Substitute for any macros appearing in the given string. 
 * Result is always freshly palloc'd. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN556"></a><span class='Declare_Function'>substitute_libpath_macro</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN558"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>sep_ptr</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Currently, we only recognize $libdir at the start of the string */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'$'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dfmgr.c.html#LN558"><span class='Ref_To_Local'>sep_ptr</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <a href="dfmgr.c.html#LN558"><span class='Ref_To_Local'>sep_ptr</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><span class='String'>"$libdir"</span><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="dfmgr.c.html#LN558"><span class='Ref_To_Local'>sep_ptr</span></a> <span class='Operator'>- </span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a> <span class='Operator'>|| 
</span>        strncmp<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><span class='String'>"$libdir"</span><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><span class='String'>"$libdir"</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid macro name in dynamic library path: %s"</span><span class='Delimiter'>, 
</span>                        <a href="dfmgr.c.html#LN556"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s%s"</span><span class='Delimiter'>, </span><a href="../init/globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN558"><span class='Ref_To_Local'>sep_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end substitute_libpath_macro &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Search for a file called 'basename' in the colon-separated search 
 * path Dynamic_library_path.  If the file is found, the full file name 
 * is returned in freshly palloc'd memory.  If the file is not found, 
 * return NULL. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN587"></a><span class='Declare_Function'>find_in_dynamic_libpath</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>basename</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN589"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN590"></a>    size_t      <span class='Declare_Local'>baselen</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN587"><span class='Ref_to_Parameter'>basename</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN587"><span class='Ref_to_Parameter'>basename</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN63"><span class='Ref_to_Global_Var'>Dynamic_library_path</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN63"><span class='Ref_to_Global_Var'>Dynamic_library_path</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="dfmgr.c.html#LN590"><span class='Ref_To_Local'>baselen</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN587"><span class='Ref_to_Parameter'>basename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN604"></a>        size_t      <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN605"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>piece</span><span class='Delimiter'>; 
</span><a name="LN606"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>mangled</span><span class='Delimiter'>; 
</span><a name="LN607"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>full</span><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN39"><span class='Ref_to_Proto'>first_path_var_separator</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a> <span class='Operator'>== </span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"zero-length component in parameter \"dynamic_library_path\""</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a> <span class='Operator'>- </span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN72"><span class='Ref_to_Proto'>substitute_libpath_macro</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN605"><span class='Ref_To_Local'>piece</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* only absolute paths */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_NAME<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"component in parameter \"dynamic_library_path\" is not an absolute path"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>+ </span><a href="dfmgr.c.html#LN590"><span class='Ref_To_Local'>baselen</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN587"><span class='Ref_to_Parameter'>basename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN606"><span class='Ref_To_Local'>mangled</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN22"><span class='Ref_to_Const'>DEBUG3</span></a><span class='Delimiter'>, </span><span class='String'>"find_in_dynamic_libpath: trying \"%s\""</span><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../test/regress/pg_regress.h.html#LN52"><span class='Ref_to_Proto'>file_exists</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN607"><span class='Ref_To_Local'>full</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>[</span><a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dfmgr.c.html#LN589"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>+= </span><a href="dfmgr.c.html#LN604"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_in_dynamic_libpath &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Find (or create) a rendezvous variable that one dynamically 
 * loaded library can use to meet up with another. 
 * 
 * On the first call of this function for a particular varName, 
 * a "rendezvous variable" is created with the given name. 
 * The value of the variable is a void pointer (initially set to NULL). 
 * Subsequent calls with the same varName just return the address of 
 * the existing variable.  Once created, a rendezvous variable lasts 
 * for the life of the process. 
 * 
 * Dynamically loaded libraries can use rendezvous variables 
 * to find each other and share information: they just need to agree 
 * on the variable name and the data it will point to. 
 */ 
</span><span class='Keyword'>void</span>      <span class='Operator'>** 
</span><a name="LN671"></a><span class='Declare_Function'>find_rendezvous_variable</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>varName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN673"></a>    <span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rendezvousHash</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN675"></a>    <a href="dfmgr.c.html#LN31"><span class='Ref_to_Typedef'>rendezvousHashEntry</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span><a name="LN676"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create a hashtable if we haven't already done so in this process */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN673"><span class='Ref_To_Local'>rendezvousHash</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN681"></a>        <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dfmgr.c.html#LN681"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN681"><span class='Ref_To_Local'>ctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN681"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN681"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN31"><span class='Ref_to_Typedef'>rendezvousHashEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN673"><span class='Ref_To_Local'>rendezvousHash</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Rendezvous variable hash"</span><span class='Delimiter'>, 
</span>                                     <span class='Number'>16</span><span class='Delimiter'>, 
</span>                                     <span class='Operator'>&</span><a href="dfmgr.c.html#LN681"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, 
</span>                                     <a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create the hashtable entry for this varName */ 
</span>    <a href="dfmgr.c.html#LN675"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN31"><span class='Ref_to_Typedef'>rendezvousHashEntry</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN673"><span class='Ref_To_Local'>rendezvousHash</span></a><span class='Delimiter'>, 
</span>                                                 <a href="dfmgr.c.html#LN671"><span class='Ref_to_Parameter'>varName</span></a><span class='Delimiter'>, 
</span>                                                 <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, 
</span>                                                 <span class='Operator'>&</span><a href="dfmgr.c.html#LN676"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize to NULL if first time */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dfmgr.c.html#LN676"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <a href="dfmgr.c.html#LN675"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN34"><span class='Ref_to_Member'>varValue</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="dfmgr.c.html#LN675"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN34"><span class='Ref_to_Member'>varValue</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end find_rendezvous_variable &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate the amount of space needed to serialize the list of libraries 
 * we have loaded. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN710"></a><span class='Declare_Function'>EstimateLibraryStateSpace</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN712"></a>    <a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>file_scanner</span><span class='Delimiter'>; 
</span><a name="LN713"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN712"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN712"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN712"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN712"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <a href="dfmgr.c.html#LN713"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN713"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN712"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dfmgr.c.html#LN713"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Serialize the list of libraries we have loaded to a chunk of memory. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN727"></a><span class='Declare_Function'>SerializeLibraryState</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>maxsize</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_address</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN729"></a>    <a href="dfmgr.c.html#LN41"><span class='Ref_to_Typedef'>DynamicFileList</span></a> <span class='Operator'>*</span><span class='Declare_Local'>file_scanner</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dfmgr.c.html#LN729"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN53"><span class='Ref_to_Global_Var'>file_list</span></a><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN729"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="dfmgr.c.html#LN729"><span class='Ref_To_Local'>file_scanner</span></a> <span class='Operator'>= </span><a href="dfmgr.c.html#LN729"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN735"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span> 
        <a href="dfmgr.c.html#LN735"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>start_address</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN729"><span class='Ref_To_Local'>file_scanner</span></a><span class='Operator'>-&GT;</span><a href="dfmgr.c.html#LN50"><span class='Ref_to_Member'>filename</span></a><span class='Delimiter'>, </span><a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>maxsize</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN735"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>maxsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>maxsize</span></a> <span class='Operator'>-= </span><a href="dfmgr.c.html#LN735"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>+= </span><a href="dfmgr.c.html#LN735"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dfmgr.c.html#LN727"><span class='Ref_to_Parameter'>start_address</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Load every library the serializing backend had loaded. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN749"></a><span class='Declare_Function'>RestoreLibraryState</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_address</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dfmgr.c.html#LN749"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dfmgr.c.html#LN65"><span class='Ref_to_Proto'>internal_load_library</span></a><span class='Parentheses'>(</span><a href="dfmgr.c.html#LN749"><span class='Ref_to_Parameter'>start_address</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dfmgr.c.html#LN749"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="dfmgr.c.html#LN749"><span class='Ref_to_Parameter'>start_address</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>