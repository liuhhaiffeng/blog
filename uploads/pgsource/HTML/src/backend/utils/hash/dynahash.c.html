<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\hash\dynahash.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\hash\dynahash.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:57 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * dynahash.c 
 *    dynamic hash tables 
 * 
 * dynahash.c supports both local-to-a-backend hash tables and hash tables in 
 * shared memory.  For shared hash tables, it is the caller's responsibility 
 * to provide appropriate access interlocking.  The simplest convention is 
 * that a single LWLock protects the whole hash table.  Searches (HASH_FIND or 
 * hash_seq_search) need only shared lock, but any update requires exclusive 
 * lock.  For heavily-used shared tables, the single-lock approach creates a 
 * concurrency bottleneck, so we also support "partitioned" locking wherein 
 * there are multiple LWLocks guarding distinct subsets of the table.  To use 
 * a hash table in partitioned mode, the HASH_PARTITION flag must be given 
 * to hash_create.  This prevents any attempt to split buckets on-the-fly. 
 * Therefore, each hash bucket chain operates independently, and no fields 
 * of the hash header change after init except nentries and freeList. 
 * A partitioned table uses spinlocks to guard changes of those fields. 
 * This lets any subset of the hash buckets be treated as a separately 
 * lockable partition.  We expect callers to use the low-order bits of a 
 * lookup key's hash value as a partition number --- this will work because 
 * of the way calc_bucket() maps hash values to bucket numbers. 
 * 
 * For hash tables in shared memory, the memory allocator function should 
 * match malloc's semantics of returning NULL on failure.  For hash tables 
 * in local memory, we typically use palloc() which will throw error on 
 * failure.  The code in this file has to cope with both cases. 
 * 
 * dynahash.c provides support for these types of lookup keys: 
 * 
 * 1. Null-terminated C strings (truncated if necessary to fit in keysize), 
 * compared as though by strcmp().  This is the default behavior. 
 * 
 * 2. Arbitrary binary data of size keysize, compared as though by memcmp(). 
 * (Caller must ensure there are no undefined padding bits in the keys!) 
 * This is selected by specifying HASH_BLOBS flag to hash_create. 
 * 
 * 3. More complex key behavior can be selected by specifying user-supplied 
 * hashing, comparison, and/or key-copying functions.  At least a hashing 
 * function must be supplied; comparison defaults to memcmp() and key copying 
 * to memcpy() when a user-defined hashing function is selected. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/hash/dynahash.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Original comments: 
 * 
 * Dynamic hashing, after CACM April 1988 pp 446-457, by Per-Ake Larson. 
 * Coded into C, with minor code improvements, and with hsearch(3) interface, 
 * by ejp@ausmelb.oz, Jul 26, 1988: 13:16; 
 * also, hcreate/hdestroy routines added to simulate hsearch(3). 
 * 
 * These routines simulate hsearch(3) and family, with the important 
 * difference that the hash table is dynamic - can grow indefinitely 
 * beyond its original size (as supplied to hcreate()). 
 * 
 * Performance appears to be comparable to that of hsearch(3). 
 * The 'source-code' options referred to in hsearch(3)'s 'man' page 
 * are not implemented; otherwise functionality is identical. 
 * 
 * Compilation controls: 
 * HASH_DEBUG controls some informative traces, mainly for debugging. 
 * HASH_STATISTICS causes HashAccesses and HashCollisions to be maintained; 
 * when combined with HASH_DEBUG, these are displayed by hdestroy(). 
 * 
 * Problems & fixes to ejp@ausmelb.oz. WARNING: relies on pre-processor 
 * concatenation property, in probably unnecessary code 'optimization'. 
 * 
 * Modified margo@postgres.berkeley.edu February 1990 
 *      added multiple table interface 
 * Modified by sullivan@postgres.berkeley.edu April 1990 
 *      changed ctl structure for shared memory 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;limits.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dynahash.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Constants 
 * 
 * A hash table has a top-level "directory", each of whose entries points 
 * to a "segment" of ssize bucket headers.  The maximum number of hash 
 * buckets is thus dsize * ssize (but dsize may be expansible).  Of course, 
 * the number of records in the table can be larger, but we don't want a 
 * whole lot of records per bucket or performance goes down. 
 * 
 * In a hash table allocated in shared memory, the directory cannot be 
 * expanded because it must stay at a fixed address.  The directory size 
 * should be selected using hash_select_dirsize (and you'd better have 
 * a good idea of the maximum number of entries!).  For non-shared hash 
 * tables, the initial directory size can be left at the default. 
 */ 
</span><a name="LN108"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_SEGSIZE</span>            <span class='Number'>256</span> 
<a name="LN109"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_SEGSIZE_SHIFT</span>      <span class='Number'>8</span>    <span class='Comment_Single_Line'>/* must be log2(DEF_SEGSIZE) */ 
</span><a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_DIRSIZE</span>            <span class='Number'>256</span> 
<a name="LN111"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DEF_FFACTOR</span>            <span class='Number'>1</span>    <span class='Comment_Single_Line'>/* default fill factor */ 
</span> 
<span class='Comment_Multi_Line'>/* Number of freelists to be used for a partitioned hash table. */ 
</span><a name="LN114"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>NUM_FREELISTS</span>           <span class='Number'>32</span> 
 
<span class='Comment_Multi_Line'>/* A hash bucket is a linked list of HASHELEMENTs */ 
</span><a name="LN117"></a><span class='Control'>typedef</span> <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>HASHBUCKET</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* A hash segment is an array of bucket headers */ 
</span><a name="LN120"></a><span class='Control'>typedef</span> <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>HASHSEGMENT</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Using array of FreeListData instead of separate arrays of mutexes, nentries 
 * and freeLists prevents, at least partially, sharing one cache line between 
 * different mutexes (see below). 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN129"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* spinlock */ 
</span><a name="LN130"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>nentries</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* number of entries */ 
</span><a name="LN131"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Member'>freeList</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* list of free elements */ 
</span><a name="LN132"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>FreeListData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Header structure for a hash table --- contains all changeable info 
 * 
 * In a shared-memory hash table, the HASHHDR is in shared memory, while 
 * each backend has a local HTAB struct.  For a non-shared table, there isn't 
 * any functional difference between HASHHDR and HTAB, but we separate them 
 * anyway to share code between shared and non-shared tables. 
 */ 
</span><a name="LN142"></a><span class='Control'>struct</span> <span class='Declare_Struct'>HASHHDR</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * The freelist can become a point of contention on high-concurrency hash 
     * tables, so we use an array of freelist, each with its own mutex and 
     * nentries count, instead of just a single one. 
     * 
     * If hash table is not partitioned only freeList[0] is used and spinlocks 
     * are not used at all. 
     */ 
</span><a name="LN152"></a>    <a href="dynahash.c.html#LN127"><span class='Ref_to_Typedef'>FreeListData</span></a> <span class='Declare_Member'>freeList</span><span class='Delimiter'>[</span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* These fields can change, but not in a partitioned table */ 
</span>    <span class='Comment_Multi_Line'>/* Also, dsize can't change in a shared table, even if unpartitioned */ 
</span><a name="LN156"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>dsize</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* directory size */ 
</span><a name="LN157"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>nsegs</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* number of allocated segments (&LT;= dsize) */ 
</span><a name="LN158"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>max_bucket</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* ID of maximum bucket in use */ 
</span><a name="LN159"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>high_mask</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* mask to modulo into entire table */ 
</span><a name="LN160"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>low_mask</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* mask to modulo into lower half of table */ 
</span> 
    <span class='Comment_Multi_Line'>/* These fields are fixed at hashtable creation */ 
</span><a name="LN163"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>keysize</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* hash key length in bytes */ 
</span><a name="LN164"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>entrysize</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* total user element size in bytes */ 
</span><a name="LN165"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>num_partitions</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* # partitions (must be power of 2), or 0 */ 
</span><a name="LN166"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>ffactor</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* target fill factor */ 
</span><a name="LN167"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>max_dsize</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* 'dsize' limit if directory is fixed size */ 
</span><a name="LN168"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>ssize</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* segment size --- must be power of 2 */ 
</span><a name="LN169"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>sshift</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* segment shift = log2(ssize) */ 
</span><a name="LN170"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nelem_alloc</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* number of entries to allocate at once */ 
</span> 
<span class='Directive'>#ifdef</span> HASH_STATISTICS 
 
    <span class='Comment_Multi_Line'>/* 
     * Count statistics here.  NB: stats code doesn't bother with mutex, so 
     * counts could be corrupted a bit in a partitioned table. 
     */ 
</span><a name="LN178"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>accesses</span><span class='Delimiter'>; 
</span><a name="LN179"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>collisions</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end HASHHDR &raquo; </span><span class='Delimiter'>; 
</span> 
<a name="LN183"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>IS_PARTITIONED</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>hctl</span><span class='Parentheses'>)</span>  <span class='Parentheses'>((</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Parameter'>hctl</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>num_partitions <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
<a name="LN185"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>FREELIST_IDX</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>hctl</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>hashcode</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN185"><span class='Ref_to_Parameter'>hctl</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="dynahash.c.html#LN185"><span class='Ref_to_Parameter'>hashcode</span></a> <span class='Operator'>% </span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a> <span class='Operator'>: </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Top control structure for a hashtable --- in a shared table, each backend 
 * has its own copy (OK since no fields change at runtime) 
 */ 
</span><a name="LN192"></a><span class='Control'>struct</span> <span class='Declare_Struct'>HTAB</span> 
<span class='Delimiter'>{ 
</span><a name="LN194"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>hctl</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* =&GT; shared control information */ 
</span><a name="LN195"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Declare_Member'>dir</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* directory of segment starts */ 
</span><a name="LN196"></a>    <a href="../../../include/utils/hsearch.h.html#LN20"><span class='Ref_to_Typedef'>HashValueFunc</span></a> <span class='Declare_Member'>hash</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* hash function */ 
</span><a name="LN197"></a>    <a href="../../../include/utils/hsearch.h.html#LN28"><span class='Ref_to_Typedef'>HashCompareFunc</span></a> <span class='Declare_Member'>match</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* key comparison function */ 
</span><a name="LN198"></a>    <a href="../../../include/utils/hsearch.h.html#LN36"><span class='Ref_to_Typedef'>HashCopyFunc</span></a> <span class='Declare_Member'>keycopy</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* key copying function */ 
</span><a name="LN199"></a>    <a href="../../../include/utils/hsearch.h.html#LN43"><span class='Ref_to_Typedef'>HashAllocFunc</span></a> <span class='Declare_Member'>alloc</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* memory allocator */ 
</span><a name="LN200"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Member'>hcxt</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* memory context if default allocator used */ 
</span><a name="LN201"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>tabname</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* table name (for error messages) */ 
</span><a name="LN202"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>isshared</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* true if table is in shared memory */ 
</span><a name="LN203"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>isfixed</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* if true, don't enlarge */ 
</span> 
    <span class='Comment_Multi_Line'>/* freezing a shared table isn't allowed, so we can keep state here */ 
</span><a name="LN206"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>frozen</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* true = no more inserts allowed */ 
</span> 
    <span class='Comment_Multi_Line'>/* We keep local copies of these fixed values to reduce contention */ 
</span><a name="LN209"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>keysize</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* hash key length in bytes */ 
</span><a name="LN210"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>ssize</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* segment size --- must be power of 2 */ 
</span><a name="LN211"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>sshift</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* segment shift = log2(ssize) */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end HTAB &raquo; </span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Key (also entry) part of a HASHELEMENT 
 */ 
</span><a name="LN217"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ELEMENTKEY</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>helem</span><span class='Parentheses'>)</span>  <span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)(</span><a href="dynahash.c.html#LN217"><span class='Ref_to_Parameter'>helem</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a><span class='Parentheses'>)))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain element pointer given pointer to key 
 */ 
</span><a name="LN222"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>ELEMENT_FROM_KEY</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>key</span><span class='Parentheses'>)</span>  <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="dynahash.c.html#LN222"><span class='Ref_to_Parameter'>key</span></a><span class='Parentheses'>))</span> <span class='Operator'>- </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a><span class='Parentheses'>))))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Fast MOD arithmetic, assuming that y is a power of 2 ! 
 */ 
</span><a name="LN228"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>MOD</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>x</span><span class='Delimiter'>,</span><span class='Declare_Parameter'>y</span><span class='Parentheses'>)</span>               <span class='Parentheses'>((</span><a href="dynahash.c.html#LN228"><span class='Ref_to_Parameter'>x</span></a><span class='Parentheses'>)</span> <span class='Operator'>& </span><span class='Parentheses'>((</span><a href="dynahash.c.html#LN228"><span class='Ref_to_Parameter'>y</span></a><span class='Parentheses'>)</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>))</span> 
 
<span class='Directive'>#if</span> HASH_STATISTICS 
<a name="LN231"></a><span class='Keyword'>static long </span><span class='Declare_Var'>hash_accesses</span><span class='Delimiter'>, 
</span><a name="LN232"></a>            <span class='Declare_Var'>hash_collisions</span><span class='Delimiter'>, 
</span><a name="LN233"></a>            <span class='Declare_Var'>hash_expansions</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Private function prototypes 
 */ 
</span><a name="LN239"></a><span class='Keyword'>static void </span><span class='Operator'>*</span><span class='Declare_Prototype'>DynaHashAlloc</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN240"></a><span class='Keyword'>static </span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Prototype'>seg_alloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN241"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>element_alloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>freelist_idx</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN242"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>dir_realloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN243"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>expand_table</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN244"></a><span class='Keyword'>static </span><a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Declare_Prototype'>get_hash_entry</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>freelist_idx</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN245"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>hdefault</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN246"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>choose_nelem_alloc</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>entrysize</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN247"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>init_htab</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>nelem</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN248"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>hash_corrupted</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN249"></a><span class='Keyword'>static long </span><span class='Declare_Prototype'>next_pow2_long</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN250"></a><span class='Keyword'>static int</span>  <span class='Declare_Prototype'>next_pow2_int</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN251"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>register_seq_scan</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN252"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>deregister_seq_scan</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN253"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>has_seq_scans</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * memory allocation support 
 */ 
</span><a name="LN259"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>CurrentDynaHashCxt</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN262"></a><span class='Declare_Function'>DynaHashAlloc</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/nodes/memnodes.h.html#LN96"><span class='Ref_to_Macro'>MemoryContextIsValid</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN262"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * HashCompareFunc for string keys 
 * 
 * Because we copy keys with strlcpy(), they will be truncated at keysize-1 
 * bytes, so we can only compare that many ... hence strncmp is almost but 
 * not quite the right thing. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN277"></a><span class='Declare_Function'>string_compare</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key1</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>key2</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>keysize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> strncmp<span class='Parentheses'>(</span><a href="dynahash.c.html#LN277"><span class='Ref_to_Parameter'>key1</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN277"><span class='Ref_to_Parameter'>key2</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN277"><span class='Ref_to_Parameter'>keysize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/************************** CREATE ROUTINES **********************/ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * hash_create -- create a new dynamic hash table 
 * 
 *  tabname: a name for the table (for debugging purposes) 
 *  nelem: maximum number of elements expected 
 *  *info: additional table parameters, as indicated by flags 
 *  flags: bitmask indicating which parameters to take from *info 
 * 
 * Note: for a shared-memory hashtable, nelem needs to be a pretty good 
 * estimate, since we can't expand the table on the fly.  But an unshared 
 * hashtable can be expanded on-the-fly, so it's better for nelem to be 
 * on the small side and let the table grow if it's exceeded.  An overly 
 * large nelem will penalize hash_seq_search speed without buying much. 
 */ 
</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN300"></a><span class='Declare_Function'>hash_create</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>tabname</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>nelem</span><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN302"></a>    <a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>hashp</span><span class='Delimiter'>; 
</span><a name="LN303"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For shared hash tables, we have a local hash header (HTAB struct) that 
     * we allocate in TopMemoryContext; all else is in shared memory. 
     * 
     * For non-shared hash tables, everything including the hash header is in 
     * a memory context created specially for the hash table --- this makes 
     * hash_destroy very simple.  The memory context is made a child of either 
     * a context specified by the caller, or TopMemoryContext if nothing is 
     * specified. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN93"><span class='Ref_to_Const'>HASH_SHARED_MEM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Set up to allocate the hash header */ 
</span>        <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Create the hash table's private memory context */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN92"><span class='Ref_to_Const'>HASH_CONTEXT</span></a><span class='Parentheses'>) 
</span>            <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN77"><span class='Ref_to_Member'>hcxt</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a><span class='Delimiter'>, 
</span>                                                   <a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>tabname</span></a><span class='Delimiter'>, 
</span>                                                   <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize the hash header, plus a copy of the table name */ 
</span>    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN239"><span class='Ref_to_Proto'>DynaHashAlloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>tabname</span></a><span class='Parentheses'>) </span><span class='Operator'>+</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Select the appropriate hash function (see comments at head of file). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN88"><span class='Ref_to_Const'>HASH_FUNCTION</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN73"><span class='Ref_to_Member'>hash</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN87"><span class='Ref_to_Const'>HASH_BLOBS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We can optimize hashing for common key sizes */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>== </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>))</span> 
            <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>= </span><a href="hashfn.c.html#LN62"><span class='Ref_to_Func'>uint32_hash</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>= </span><a href="hashfn.c.html#LN50"><span class='Ref_to_Func'>tag_hash</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>= </span><a href="hashfn.c.html#LN32"><span class='Ref_to_Func'>string_hash</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* default hash function */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If you don't specify a match function, it defaults to string_compare if 
     * you used string_hash (either explicitly or by default) and to memcmp 
     * otherwise. 
     * 
     * Note: explicitly specifying string_hash is deprecated, because this 
     * might not work for callers in loadable modules on some platforms due to 
     * referencing a trampoline instead of the string_hash function proper. 
     * Just let it default, eh? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN89"><span class='Ref_to_Const'>HASH_COMPARE</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN197"><span class='Ref_to_Member'>match</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN74"><span class='Ref_to_Member'>match</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>== </span><a href="hashfn.c.html#LN32"><span class='Ref_to_Func'>string_hash</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN197"><span class='Ref_to_Member'>match</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN28"><span class='Ref_to_Typedef'>HashCompareFunc</span></a><span class='Parentheses'>) </span><a href="dynahash.c.html#LN276"><span class='Ref_to_Func'>string_compare</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN197"><span class='Ref_to_Member'>match</span></a> <span class='Operator'>= </span>memcmp<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Similarly, the key-copying function defaults to strlcpy or memcpy. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN90"><span class='Ref_to_Const'>HASH_KEYCOPY</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN198"><span class='Ref_to_Member'>keycopy</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN75"><span class='Ref_to_Member'>keycopy</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a> <span class='Operator'>== </span><a href="hashfn.c.html#LN32"><span class='Ref_to_Func'>string_hash</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN198"><span class='Ref_to_Member'>keycopy</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN36"><span class='Ref_to_Typedef'>HashCopyFunc</span></a><span class='Parentheses'>) </span><a href="../../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN198"><span class='Ref_to_Member'>keycopy</span></a> <span class='Operator'>= </span>memcpy<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* And select the entry allocation function, too. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN91"><span class='Ref_to_Const'>HASH_ALLOC</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN76"><span class='Ref_to_Member'>alloc</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN239"><span class='Ref_to_Proto'>DynaHashAlloc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN93"><span class='Ref_to_Const'>HASH_SHARED_MEM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * ctl structure and directory are preallocated for shared memory 
         * tables.  Note that HASH_DIRSIZE and HASH_ALLOC had better be set as 
         * well. 
         */ 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN78"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN78"><span class='Ref_to_Member'>hctl</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN202"><span class='Ref_to_Member'>isshared</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* hash table already exists, we're just attaching to it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN94"><span class='Ref_to_Const'>HASH_ATTACH</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* make local copies of some heavily-used values */ 
</span>            <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN163"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if flags&HASH_SHARED_MEM &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* setup hash table defaults */ 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN202"><span class='Ref_to_Member'>isshared</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN245"><span class='Ref_to_Proto'>hdefault</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN82"><span class='Ref_to_Const'>HASH_PARTITION</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Doesn't make sense to partition a local hash table */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN93"><span class='Ref_to_Const'>HASH_SHARED_MEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The number of partitions had better be a power of 2. Also, it must 
         * be less than INT_MAX (see init_htab()), so call the int version of 
         * next_pow2. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN66"><span class='Ref_to_Member'>num_partitions</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN250"><span class='Ref_to_Proto'>next_pow2_int</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN66"><span class='Ref_to_Member'>num_partitions</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN165"><span class='Ref_to_Member'>num_partitions</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN66"><span class='Ref_to_Member'>num_partitions</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN83"><span class='Ref_to_Const'>HASH_SEGMENT</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN67"><span class='Ref_to_Member'>ssize</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN67"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* ssize had better be a power of 2 */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><span class='Number'>1L</span> <span class='Operator'>&LT;&LT; </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN85"><span class='Ref_to_Const'>HASH_FFACTOR</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN166"><span class='Ref_to_Member'>ffactor</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN70"><span class='Ref_to_Member'>ffactor</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * SHM hash tables have fixed directory size passed by the caller. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN84"><span class='Ref_to_Const'>HASH_DIRSIZE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN167"><span class='Ref_to_Member'>max_dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN69"><span class='Ref_to_Member'>max_dsize</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN68"><span class='Ref_to_Member'>dsize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * hash table now allocates space for key and data but you have to say how 
     * much space to allocate 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN163"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN164"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* make local copies of heavily-used constant fields */ 
</span>    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN163"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build the hash directory structure */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN247"><span class='Ref_to_Proto'>init_htab</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>nelem</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"failed to initialize hash table \"%s\""</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * For a shared hash table, preallocate the requested number of elements. 
     * This reduces problems with run-time out-of-shared-memory conditions. 
     * 
     * For a non-shared hash table, preallocate the requested number of 
     * elements if it's less than our chosen nelem_alloc.  This avoids wasting 
     * space if the caller correctly estimates a small table size. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN93"><span class='Ref_to_Const'>HASH_SHARED_MEM</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>nelem</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN303"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN170"><span class='Ref_to_Member'>nelem_alloc</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN502"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN503"></a>                    <span class='Declare_Local'>freelist_partitions</span><span class='Delimiter'>, 
</span><a name="LN504"></a>                    <span class='Declare_Local'>nelem_alloc</span><span class='Delimiter'>, 
</span><a name="LN505"></a>                    <span class='Declare_Local'>nelem_alloc_first</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If hash table is partitioned all freeLists have equal number of 
         * elements. Otherwise only freeList[0] is used. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Parentheses'>))</span> 
            <a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>nelem</span></a> <span class='Operator'>/ </span><a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Make sure all memory will be used */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>* </span><a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>nelem</span></a><span class='Parentheses'>) 
</span>            <a href="dynahash.c.html#LN505"><span class='Ref_To_Local'>nelem_alloc_first</span></a> <span class='Operator'>= 
</span>                <a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>nelem</span></a> <span class='Operator'>- </span><a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="dynahash.c.html#LN505"><span class='Ref_To_Local'>nelem_alloc_first</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN502"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN502"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN503"><span class='Ref_To_Local'>freelist_partitions</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN502"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN529"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>temp</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN502"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>? </span><a href="dynahash.c.html#LN505"><span class='Ref_To_Local'>nelem_alloc_first</span></a> <span class='Operator'>: </span><a href="dynahash.c.html#LN504"><span class='Ref_To_Local'>nelem_alloc</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN241"><span class='Ref_to_Proto'>element_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN529"><span class='Ref_To_Local'>temp</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN502"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (flags&HASH_SHARED_ME... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN300"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN95"><span class='Ref_to_Const'>HASH_FIXED_SIZE</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN203"><span class='Ref_to_Member'>isfixed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="dynahash.c.html#LN302"><span class='Ref_To_Local'>hashp</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hash_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Set default HASHHDR parameters. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN547"></a><span class='Declare_Function'>hdefault</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN549"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN547"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN110"><span class='Ref_to_Const'>DEF_DIRSIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* rather pointless defaults for key & entry size */ 
</span>    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN163"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN164"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Number'>2</span> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN165"><span class='Ref_to_Member'>num_partitions</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* not partitioned */ 
</span> 
    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN166"><span class='Ref_to_Member'>ffactor</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN111"><span class='Ref_to_Const'>DEF_FFACTOR</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* table has no fixed maximum size */ 
</span>    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN167"><span class='Ref_to_Member'>max_dsize</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN99"><span class='Ref_to_Const'>NO_MAX_DSIZE</span></a><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN108"><span class='Ref_to_Const'>DEF_SEGSIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN109"><span class='Ref_to_Const'>DEF_SEGSIZE_SHIFT</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HASH_STATISTICS 
    <a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN178"><span class='Ref_to_Member'>accesses</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN549"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN179"><span class='Ref_to_Member'>collisions</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end hdefault &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Given the user-specified entry size, choose nelem_alloc, ie, how many 
 * elements to add to the hash table when we need more. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN580"></a><span class='Declare_Function'>choose_nelem_alloc</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>entrysize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN582"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nelem_alloc</span><span class='Delimiter'>; 
</span><a name="LN583"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>elementSize</span><span class='Delimiter'>; 
</span><a name="LN584"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>allocSize</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Each element has a HASHELEMENT header plus user data. */ 
</span>    <span class='Comment_Multi_Line'>/* NB: this had better match element_alloc() */ 
</span>    <a href="dynahash.c.html#LN583"><span class='Ref_To_Local'>elementSize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN580"><span class='Ref_to_Parameter'>entrysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The idea here is to choose nelem_alloc at least 32, but round up so 
     * that the allocation request will be a power of 2 or just less. This 
     * makes little difference for hash tables in shared memory, but for hash 
     * tables managed by palloc, the allocation request will be rounded up to 
     * a power of 2 anyway.  If we fail to take this into account, we'll waste 
     * as much as half the allocated space. 
     */ 
</span>    <a href="dynahash.c.html#LN584"><span class='Ref_To_Local'>allocSize</span></a> <span class='Operator'>= </span><span class='Number'>32</span> <span class='Operator'>* </span><span class='Number'>4</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* assume elementSize at least 8 */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN584"><span class='Ref_To_Local'>allocSize</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN582"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN584"><span class='Ref_To_Local'>allocSize</span></a> <span class='Operator'>/ </span><a href="dynahash.c.html#LN583"><span class='Ref_To_Local'>elementSize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN582"><span class='Ref_To_Local'>nelem_alloc</span></a> <span class='Operator'>&LT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN582"><span class='Ref_To_Local'>nelem_alloc</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end choose_nelem_alloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute derived fields of hctl and build the initial directory/segment 
 * arrays 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN613"></a><span class='Declare_Function'>init_htab</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>nelem</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN615"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN616"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segp</span><span class='Delimiter'>; 
</span><a name="LN617"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nbuckets</span><span class='Delimiter'>; 
</span><a name="LN618"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nsegs</span><span class='Delimiter'>; 
</span><a name="LN619"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * initialize mutex if it's a partitioned table 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN619"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN619"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN619"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN619"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Divide number of elements by the fill factor to determine a desired 
     * number of buckets.  Allocate space for the next greater power of two 
     * number of buckets 
     */ 
</span>    <a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN250"><span class='Ref_to_Proto'>next_pow2_int</span></a><span class='Parentheses'>((</span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>nelem</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN166"><span class='Ref_to_Member'>ffactor</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In a partitioned table, nbuckets must be at least equal to 
     * num_partitions; were it less, keys with apparently different partition 
     * numbers would map to the same bucket, breaking partition independence. 
     * (Normally nbuckets will be much bigger; this is just a safety check.) 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN165"><span class='Ref_to_Member'>num_partitions</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Figure number of directory segments needed, round up to a power of 2 
     */ 
</span>    <a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN617"><span class='Ref_To_Local'>nbuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN250"><span class='Ref_to_Proto'>next_pow2_int</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make sure directory is big enough. If pre-allocated directory is too 
     * small, choke (caller screwed up). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a> <span class='Operator'>&GT; </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Parentheses'>))</span> 
            <a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate a directory */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate initial segments */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN616"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN618"><span class='Ref_To_Local'>nsegs</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN616"><span class='Ref_To_Local'>segp</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Operator'>*</span><a href="dynahash.c.html#LN616"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN240"><span class='Ref_to_Proto'>seg_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="dynahash.c.html#LN616"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Choose number of entries to allocate at a time */ 
</span>    <a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN170"><span class='Ref_to_Member'>nelem_alloc</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN246"><span class='Ref_to_Proto'>choose_nelem_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN164"><span class='Ref_to_Member'>entrysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> HASH_DEBUG 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"init_htab:\n%s%p\n%s%ld\n%s%ld\n%s%d\n%s%ld\n%s%u\n%s%x\n%s%x\n%s%ld\n%s%ld\n"</span><span class='Delimiter'>, 
</span>            <span class='String'>"TABLE POINTER   "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN613"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"DIRECTORY SIZE  "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"SEGMENT SIZE    "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN168"><span class='Ref_to_Member'>ssize</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"SEGMENT SHIFT   "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN169"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"FILL FACTOR     "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN166"><span class='Ref_to_Member'>ffactor</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"MAX BUCKET      "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"HIGH MASK       "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"LOW  MASK       "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"NSEGS           "</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a><span class='Delimiter'>, 
</span>            <span class='String'>"NENTRIES        "</span><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN615"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end init_htab &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate the space needed for a hashtable containing the given number 
 * of entries of given size. 
 * NOTE: this is used to estimate the footprint of hashtables in shared 
 * memory; therefore it does not count HTAB which is in local memory. 
 * NB: assumes that all hash structure parameters have default values! 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN710"></a><span class='Declare_Function'>hash_estimate_size</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num_entries</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>entrysize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN712"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN713"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>nBuckets</span><span class='Delimiter'>, 
</span><a name="LN714"></a>                <span class='Declare_Local'>nSegments</span><span class='Delimiter'>, 
</span><a name="LN715"></a>                <span class='Declare_Local'>nDirEntries</span><span class='Delimiter'>, 
</span><a name="LN716"></a>                <span class='Declare_Local'>nElementAllocs</span><span class='Delimiter'>, 
</span><a name="LN717"></a>                <span class='Declare_Local'>elementSize</span><span class='Delimiter'>, 
</span><a name="LN718"></a>                <span class='Declare_Local'>elementAllocCnt</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* estimate number of buckets wanted */ 
</span>    <a href="dynahash.c.html#LN713"><span class='Ref_To_Local'>nBuckets</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN249"><span class='Ref_to_Proto'>next_pow2_long</span></a><span class='Parentheses'>((</span><a href="dynahash.c.html#LN710"><span class='Ref_to_Parameter'>num_entries</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN111"><span class='Ref_to_Const'>DEF_FFACTOR</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* # of segments needed for nBuckets */ 
</span>    <a href="dynahash.c.html#LN714"><span class='Ref_To_Local'>nSegments</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN249"><span class='Ref_to_Proto'>next_pow2_long</span></a><span class='Parentheses'>((</span><a href="dynahash.c.html#LN713"><span class='Ref_To_Local'>nBuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN108"><span class='Ref_to_Const'>DEF_SEGSIZE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* directory entries */ 
</span>    <a href="dynahash.c.html#LN715"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN110"><span class='Ref_to_Const'>DEF_DIRSIZE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN715"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN714"><span class='Ref_To_Local'>nSegments</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN715"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* dir_alloc doubles dsize at each call */ 
</span> 
    <span class='Comment_Multi_Line'>/* fixed control info */ 
</span>    <a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* but not HTAB, per above */ 
</span>    <span class='Comment_Multi_Line'>/* directory */ 
</span>    <a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN715"><span class='Ref_To_Local'>nDirEntries</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* segments */ 
</span>    <a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN714"><span class='Ref_To_Local'>nSegments</span></a><span class='Delimiter'>, 
</span>                                <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN108"><span class='Ref_to_Const'>DEF_SEGSIZE</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* elements --- allocated in groups of choose_nelem_alloc() entries */ 
</span>    <a href="dynahash.c.html#LN718"><span class='Ref_To_Local'>elementAllocCnt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN246"><span class='Ref_to_Proto'>choose_nelem_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN710"><span class='Ref_to_Parameter'>entrysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN716"><span class='Ref_To_Local'>nElementAllocs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN710"><span class='Ref_to_Parameter'>num_entries</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN718"><span class='Ref_To_Local'>elementAllocCnt</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN717"><span class='Ref_To_Local'>elementSize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN710"><span class='Ref_to_Parameter'>entrysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN716"><span class='Ref_To_Local'>nElementAllocs</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN718"><span class='Ref_To_Local'>elementAllocCnt</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN717"><span class='Ref_To_Local'>elementSize</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN712"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hash_estimate_size &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Select an appropriate directory size for a hashtable with the given 
 * maximum number of entries. 
 * This is only needed for hashtables in shared memory, whose directories 
 * cannot be expanded dynamically. 
 * NB: assumes that all hash structure parameters have default values! 
 * 
 * XXX this had better agree with the behavior of init_htab()... 
 */ 
</span><span class='Keyword'>long 
</span><a name="LN757"></a><span class='Declare_Function'>hash_select_dirsize</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num_entries</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN759"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>nBuckets</span><span class='Delimiter'>, 
</span><a name="LN760"></a>                <span class='Declare_Local'>nSegments</span><span class='Delimiter'>, 
</span><a name="LN761"></a>                <span class='Declare_Local'>nDirEntries</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* estimate number of buckets wanted */ 
</span>    <a href="dynahash.c.html#LN759"><span class='Ref_To_Local'>nBuckets</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN249"><span class='Ref_to_Proto'>next_pow2_long</span></a><span class='Parentheses'>((</span><a href="dynahash.c.html#LN757"><span class='Ref_to_Parameter'>num_entries</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN111"><span class='Ref_to_Const'>DEF_FFACTOR</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* # of segments needed for nBuckets */ 
</span>    <a href="dynahash.c.html#LN760"><span class='Ref_To_Local'>nSegments</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN249"><span class='Ref_to_Proto'>next_pow2_long</span></a><span class='Parentheses'>((</span><a href="dynahash.c.html#LN759"><span class='Ref_To_Local'>nBuckets</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dynahash.c.html#LN108"><span class='Ref_to_Const'>DEF_SEGSIZE</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* directory entries */ 
</span>    <a href="dynahash.c.html#LN761"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN110"><span class='Ref_to_Const'>DEF_DIRSIZE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN761"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN760"><span class='Ref_To_Local'>nSegments</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN761"><span class='Ref_To_Local'>nDirEntries</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* dir_alloc doubles dsize at each call */ 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN761"><span class='Ref_To_Local'>nDirEntries</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Compute the required initial memory allocation for a shared-memory 
 * hashtable with the given parameters.  We need space for the HASHHDR 
 * and for the (non expansible) directory. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN781"></a><span class='Declare_Function'>hash_get_shared_size</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>info</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN781"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/hsearch.h.html#LN84"><span class='Ref_to_Const'>HASH_DIRSIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN781"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN68"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN781"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN69"><span class='Ref_to_Member'>max_dsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="dynahash.c.html#LN781"><span class='Ref_to_Parameter'>info</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN68"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************** DESTROY ROUTINES ************************/ 
</span> 
<span class='Keyword'>void 
</span><a name="LN792"></a><span class='Declare_Function'>hash_destroy</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN792"><span class='Ref_to_Parameter'>hashp</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* allocation method must be one we know how to free, too */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN792"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN239"><span class='Ref_to_Proto'>DynaHashAlloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* so this hashtable must have it's own context */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN792"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/hsearch.h.html#LN124"><span class='Ref_to_Proto'>hash_stats</span></a><span class='Parentheses'>(</span><span class='String'>"destroy"</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN792"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Free everything by destroying the hash table's memory context. 
         */ 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN792"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN811"></a><span class='Declare_Function'>hash_stats</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>where</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#if</span> HASH_STATISTICS 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: this HTAB -- accesses %ld collisions %ld\n"</span><span class='Delimiter'>, 
</span>            <a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>where</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN178"><span class='Ref_to_Member'>accesses</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN179"><span class='Ref_to_Member'>collisions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"hash_stats: entries %ld keysize %ld maxp %u segmentcount %ld\n"</span><span class='Delimiter'>, 
</span>            <a href="../../../include/utils/hsearch.h.html#LN133"><span class='Ref_to_Proto'>hash_get_num_entries</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN163"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>, 
</span>            <a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"%s: total accesses %ld total collisions %ld\n"</span><span class='Delimiter'>, 
</span>            <a href="dynahash.c.html#LN811"><span class='Ref_to_Parameter'>where</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN231"><span class='Ref_to_Global_Var'>hash_accesses</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN232"><span class='Ref_to_Global_Var'>hash_collisions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"hash_stats: total expansions %ld\n"</span><span class='Delimiter'>, 
</span>            <a href="dynahash.c.html#LN233"><span class='Ref_to_Global_Var'>hash_expansions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/*******************************SEARCH ROUTINES *****************************/ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * get_hash_value -- exported routine to calculate a key's hash value 
 * 
 * We export this because for partitioned tables, callers need to compute 
 * the partition number (from the low-order bits of the hash value) before 
 * searching. 
 */ 
</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN838"></a><span class='Declare_Function'>get_hash_value</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>keyPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="dynahash.c.html#LN838"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN838"><span class='Ref_to_Parameter'>keyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN838"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Convert a hash value to a bucket number */ 
</span><span class='Keyword'>static inline </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> 
<a name="LN845"></a><span class='Declare_Function'>calc_bucket</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hctl</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hash_val</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN847"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN847"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN845"><span class='Ref_to_Parameter'>hash_val</span></a> <span class='Operator'>& </span><a href="dynahash.c.html#LN845"><span class='Ref_to_Parameter'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN847"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>&GT; </span><a href="dynahash.c.html#LN845"><span class='Ref_to_Parameter'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN847"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN847"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>& </span><a href="dynahash.c.html#LN845"><span class='Ref_to_Parameter'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN847"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * hash_search -- look up key in table and perform action 
 * hash_search_with_hash_value -- same, with key's hash value already computed 
 * 
 * action is one of: 
 *      HASH_FIND: look up key in table 
 *      HASH_ENTER: look up key in table, creating entry if not present 
 *      HASH_ENTER_NULL: same, but return NULL if out of memory 
 *      HASH_REMOVE: look up key in table, remove entry if present 
 * 
 * Return value is a pointer to the element found/entered/removed if any, 
 * or NULL if no match was found.  (NB: in the case of the REMOVE action, 
 * the result is a dangling pointer that shouldn't be dereferenced!) 
 * 
 * HASH_ENTER will normally ereport a generic "out of memory" error if 
 * it is unable to create a new entry.  The HASH_ENTER_NULL operation is 
 * the same except it will return NULL if out of memory.  Note that 
 * HASH_ENTER_NULL cannot be used with the default palloc-based allocator, 
 * since palloc internally ereports on out-of-memory. 
 * 
 * If foundPtr isn't NULL, then *foundPtr is set TRUE if we found an 
 * existing entry in the table, FALSE otherwise.  This is needed in the 
 * HASH_ENTER case, but is redundant with the return value otherwise. 
 * 
 * For hash_search_with_hash_value, the hashvalue parameter must have been 
 * calculated with get_hash_value(). 
 */ 
</span><span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN884"></a><span class='Declare_Function'>hash_search</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, 
</span><a name="LN885"></a>            <span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>keyPtr</span><span class='Delimiter'>, 
</span><a name="LN886"></a>            <a href="../../../include/utils/hsearch.h.html#LN102"><span class='Ref_to_Typedef'>HASHACTION</span></a> <span class='Declare_Parameter'>action</span><span class='Delimiter'>, 
</span><a name="LN887"></a>            <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>foundPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/hsearch.h.html#LN128"><span class='Ref_to_Proto'>hash_search_with_hash_value</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN884"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>, 
</span>                                       <a href="dynahash.c.html#LN885"><span class='Ref_to_Parameter'>keyPtr</span></a><span class='Delimiter'>, 
</span>                                       <a href="dynahash.c.html#LN884"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN885"><span class='Ref_to_Parameter'>keyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN884"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="dynahash.c.html#LN886"><span class='Ref_to_Parameter'>action</span></a><span class='Delimiter'>, 
</span>                                       <a href="dynahash.c.html#LN887"><span class='Ref_to_Parameter'>foundPtr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN897"></a><span class='Declare_Function'>hash_search_with_hash_value</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, 
</span><a name="LN898"></a>                            <span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>keyPtr</span><span class='Delimiter'>, 
</span><a name="LN899"></a>                            <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>hashvalue</span><span class='Delimiter'>, 
</span><a name="LN900"></a>                            <a href="../../../include/utils/hsearch.h.html#LN102"><span class='Ref_to_Typedef'>HASHACTION</span></a> <span class='Declare_Parameter'>action</span><span class='Delimiter'>, 
</span><a name="LN901"></a>                            <span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>foundPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN903"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN904"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>keysize</span><span class='Delimiter'>; 
</span><a name="LN905"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN906"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_num</span><span class='Delimiter'>; 
</span><a name="LN907"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_ndx</span><span class='Delimiter'>; 
</span><a name="LN908"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Local'>segp</span><span class='Delimiter'>; 
</span><a name="LN909"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a>  <span class='Declare_Local'>currBucket</span><span class='Delimiter'>; 
</span><a name="LN910"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prevBucketPtr</span><span class='Delimiter'>; 
</span><a name="LN911"></a>    <a href="../../../include/utils/hsearch.h.html#LN28"><span class='Ref_to_Typedef'>HashCompareFunc</span></a> <span class='Declare_Local'>match</span><span class='Delimiter'>; 
</span><a name="LN912"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>freelist_idx</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN185"><span class='Ref_to_Macro'>FREELIST_IDX</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN899"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> HASH_STATISTICS 
    <a href="dynahash.c.html#LN231"><span class='Ref_to_Global_Var'>hash_accesses</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN178"><span class='Ref_to_Member'>accesses</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If inserting, check if it is time to split a bucket. 
     * 
     * NOTE: failure to expand table is not a fatal error, it just means we 
     * have to run at higher fill factor than we wanted.  However, if we're 
     * using the palloc allocator then it will throw error anyway on 
     * out-of-memory, so we must do this before modifying the table. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN900"><span class='Ref_to_Parameter'>action</span></a> <span class='Operator'>== </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a> <span class='Operator'>|| </span><a href="dynahash.c.html#LN900"><span class='Ref_to_Parameter'>action</span></a> <span class='Operator'>== </span><a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Can't split if running in partitioned mode, nor if frozen, nor if 
         * table is the subject of any active hash_seq_search scans.  Strange 
         * order of these tests is to try to check cheaper conditions first. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>) </span><span class='Operator'>&& !</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>&& 
</span>            <a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) (</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN166"><span class='Ref_to_Member'>ffactor</span></a> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="dynahash.c.html#LN253"><span class='Ref_to_Proto'>has_seq_scans</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>))</span> 
            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN243"><span class='Ref_to_Proto'>expand_table</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do the initial lookup 
     */ 
</span>    <a href="dynahash.c.html#LN905"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN844"><span class='Ref_to_Func'>calc_bucket</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN899"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN906"><span class='Ref_To_Local'>segment_num</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN905"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN907"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN905"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN908"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN906"><span class='Ref_To_Local'>segment_num</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN908"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN248"><span class='Ref_to_Proto'>hash_corrupted</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN908"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN907"><span class='Ref_To_Local'>segment_ndx</span></a><span class='Delimiter'>]; 
</span>    <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Follow collision chain looking for matching key 
     */ 
</span>    <a href="dynahash.c.html#LN911"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN197"><span class='Ref_to_Member'>match</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* save one fetch in inner loop */ 
</span>    <a href="dynahash.c.html#LN904"><span class='Ref_To_Local'>keysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ditto */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN899"><span class='Ref_to_Parameter'>hashvalue</span></a> <span class='Operator'>&& 
</span>            <a href="dynahash.c.html#LN911"><span class='Ref_To_Local'>match</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN898"><span class='Ref_to_Parameter'>keyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN904"><span class='Ref_To_Local'>keysize</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#if</span> HASH_STATISTICS 
        <a href="dynahash.c.html#LN232"><span class='Ref_to_Global_Var'>hash_collisions</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN179"><span class='Ref_to_Member'>collisions</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN901"><span class='Ref_to_Parameter'>foundPtr</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>*</span><a href="dynahash.c.html#LN901"><span class='Ref_to_Parameter'>foundPtr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>bool</span><span class='Parentheses'>) (</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * OK, now what? 
     */ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN900"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Operator'>: 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* if partitioned, must lock to touch nentries and freeList */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
                    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* remove record from hash bucket's chain. */ 
</span>                <span class='Operator'>*</span><a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* add the record to the freelist for this table.  */ 
</span>                <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>; 
</span>                <a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
                    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN903"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * better hope the caller is synchronizing access to this 
                 * element, because someone else is going to reuse it the next 
                 * time something is added to the table 
                 */ 
</span>                <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if currBucket!=NULL &raquo; </span> 
            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* ENTER_NULL does not work with palloc-based allocator */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a> <span class='Operator'>!= </span><a href="dynahash.c.html#LN239"><span class='Ref_to_Proto'>DynaHashAlloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* FALL THRU */ 
</span> 
        <span class='Control'>case</span> <a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Operator'>: 
</span>            <span class='Comment_Multi_Line'>/* Return existing element if found, else create one */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* disallow inserts if frozen */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot insert into frozen hashtable \"%s\""</span><span class='Delimiter'>, 
</span>                     <a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN244"><span class='Ref_to_Proto'>get_hash_entry</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN912"><span class='Ref_To_Local'>freelist_idx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* out of memory */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN900"><span class='Ref_to_Parameter'>action</span></a> <span class='Operator'>== </span><a href="../../../include/utils/hsearch.h.html#LN107"><span class='Ref_to_EnumConst'>HASH_ENTER_NULL</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Comment_Multi_Line'>/* report a generic message */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN202"><span class='Ref_to_Member'>isshared</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of shared memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* link into hashbucket chain */ 
</span>            <span class='Operator'>*</span><a href="dynahash.c.html#LN910"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* copy key into record */ 
</span>            <a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN899"><span class='Ref_to_Parameter'>hashvalue</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN897"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN198"><span class='Ref_to_Member'>keycopy</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN898"><span class='Ref_to_Parameter'>keyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN904"><span class='Ref_To_Local'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Caller is expected to fill the data field on return.  DO NOT 
             * insert any code that could possibly throw error here, as doing 
             * so would leave the table entry incomplete and hence corrupt the 
             * caller's data structure. 
             */ 
</span> 
            <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN909"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch action &raquo; </span> 
 
    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unrecognized hash action code: %d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN900"><span class='Ref_to_Parameter'>action</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>                <span class='Comment_Single_Line'>/* keep compiler quiet */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end hash_search_with_hash_value &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * hash_update_hash_key -- change the hash key of an existing table entry 
 * 
 * This is equivalent to removing the entry, making a new entry, and copying 
 * over its data, except that the entry never goes to the table's freelist. 
 * Therefore this cannot suffer an out-of-memory failure, even if there are 
 * other processes operating in other partitions of the hashtable. 
 * 
 * Returns TRUE if successful, FALSE if the requested new hash key is already 
 * present.  Throws error if the specified entry pointer isn't actually a 
 * table member. 
 * 
 * NB: currently, there is no special case for old and new hash keys being 
 * identical, which means we'll report FALSE for that situation.  This is 
 * preferable for existing uses. 
 * 
 * NB: for a partitioned hashtable, caller must hold lock on both relevant 
 * partitions, if the new hash key would belong to a different partition. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1092"></a><span class='Declare_Function'>hash_update_hash_key</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, 
</span><a name="LN1093"></a>                     <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>existingEntry</span><span class='Delimiter'>, 
</span><a name="LN1094"></a>                     <span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>newKeyPtr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1096"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>existingElement</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN222"><span class='Ref_to_Macro'>ELEMENT_FROM_KEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1093"><span class='Ref_to_Parameter'>existingEntry</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1097"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN1098"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newhashvalue</span><span class='Delimiter'>; 
</span><a name="LN1099"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>keysize</span><span class='Delimiter'>; 
</span><a name="LN1100"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>bucket</span><span class='Delimiter'>; 
</span><a name="LN1101"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>newbucket</span><span class='Delimiter'>; 
</span><a name="LN1102"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_num</span><span class='Delimiter'>; 
</span><a name="LN1103"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_ndx</span><span class='Delimiter'>; 
</span><a name="LN1104"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Local'>segp</span><span class='Delimiter'>; 
</span><a name="LN1105"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a>  <span class='Declare_Local'>currBucket</span><span class='Delimiter'>; 
</span><a name="LN1106"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prevBucketPtr</span><span class='Delimiter'>; 
</span><a name="LN1107"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldPrevPtr</span><span class='Delimiter'>; 
</span><a name="LN1108"></a>    <a href="../../../include/utils/hsearch.h.html#LN28"><span class='Ref_to_Typedef'>HashCompareFunc</span></a> <span class='Declare_Local'>match</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> HASH_STATISTICS 
    <a href="dynahash.c.html#LN231"><span class='Ref_to_Global_Var'>hash_accesses</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1097"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN178"><span class='Ref_to_Member'>accesses</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* disallow updates if frozen */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot update in frozen hashtable \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lookup the existing element using its saved hash value.  We need to do 
     * this to be able to unlink it from its hash chain, but as a side benefit 
     * we can verify the validity of the passed existingEntry pointer. 
     */ 
</span>    <a href="dynahash.c.html#LN1100"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN844"><span class='Ref_to_Func'>calc_bucket</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1097"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1096"><span class='Ref_To_Local'>existingElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1102"><span class='Ref_To_Local'>segment_num</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1100"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1103"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1100"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1102"><span class='Ref_To_Local'>segment_num</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN248"><span class='Ref_to_Proto'>hash_corrupted</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1103"><span class='Ref_To_Local'>segment_ndx</span></a><span class='Delimiter'>]; 
</span>    <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN1096"><span class='Ref_To_Local'>existingElement</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"hash_update_hash_key argument is not in hashtable \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1107"><span class='Ref_To_Local'>oldPrevPtr</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now perform the equivalent of a HASH_ENTER operation to locate the hash 
     * chain we want to put the entry into. 
     */ 
</span>    <a href="dynahash.c.html#LN1098"><span class='Ref_To_Local'>newhashvalue</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN196"><span class='Ref_to_Member'>hash</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1094"><span class='Ref_to_Parameter'>newKeyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1101"><span class='Ref_To_Local'>newbucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN844"><span class='Ref_to_Func'>calc_bucket</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1097"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1098"><span class='Ref_To_Local'>newhashvalue</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1102"><span class='Ref_To_Local'>segment_num</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1101"><span class='Ref_To_Local'>newbucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1103"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1101"><span class='Ref_To_Local'>newbucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1102"><span class='Ref_To_Local'>segment_num</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN248"><span class='Ref_to_Proto'>hash_corrupted</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1104"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1103"><span class='Ref_To_Local'>segment_ndx</span></a><span class='Delimiter'>]; 
</span>    <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Follow collision chain looking for matching key 
     */ 
</span>    <a href="dynahash.c.html#LN1108"><span class='Ref_To_Local'>match</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN197"><span class='Ref_to_Member'>match</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* save one fetch in inner loop */ 
</span>    <a href="dynahash.c.html#LN1099"><span class='Ref_To_Local'>keysize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN209"><span class='Ref_to_Member'>keysize</span></a><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* ditto */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN1098"><span class='Ref_To_Local'>newhashvalue</span></a> <span class='Operator'>&& 
</span>            <a href="dynahash.c.html#LN1108"><span class='Ref_To_Local'>match</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1094"><span class='Ref_to_Parameter'>newKeyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1099"><span class='Ref_To_Local'>keysize</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= &</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#if</span> HASH_STATISTICS 
        <a href="dynahash.c.html#LN232"><span class='Ref_to_Global_Var'>hash_collisions</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1097"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN179"><span class='Ref_to_Member'>collisions</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* collision with an existing entry */ 
</span> 
    <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1096"><span class='Ref_To_Local'>existingElement</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If old and new hash values belong to the same bucket, we need not 
     * change any chain links, and indeed should not since this simplistic 
     * update will corrupt the list if currBucket is the last element.  (We 
     * cannot fall out earlier, however, since we need to scan the bucket to 
     * check for duplicate keys.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1100"><span class='Ref_To_Local'>bucket</span></a> <span class='Operator'>!= </span><a href="dynahash.c.html#LN1101"><span class='Ref_To_Local'>newbucket</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* OK to remove record from old hash bucket's chain. */ 
</span>        <span class='Operator'>*</span><a href="dynahash.c.html#LN1107"><span class='Ref_To_Local'>oldPrevPtr</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* link into new hashbucket chain */ 
</span>        <span class='Operator'>*</span><a href="dynahash.c.html#LN1106"><span class='Ref_To_Local'>prevBucketPtr</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* copy new key into record */ 
</span>    <a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1098"><span class='Ref_To_Local'>newhashvalue</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1092"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN198"><span class='Ref_to_Member'>keycopy</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1105"><span class='Ref_To_Local'>currBucket</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1094"><span class='Ref_to_Parameter'>newKeyPtr</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1099"><span class='Ref_To_Local'>keysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* rest of record is untouched */ 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hash_update_hash_key &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * create a new entry if possible 
 */ 
</span><span class='Keyword'>static </span><a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> 
<a name="LN1225"></a><span class='Declare_Function'>get_hash_entry</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>freelist_idx</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1227"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN1228"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a>  <span class='Declare_Local'>newElement</span><span class='Delimiter'>; 
</span><a name="LN1229"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>borrow_from_idx</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* if partitioned, must lock to touch nentries and freeList */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* try to get an entry from the freelist */ 
</span>        <a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* no free elements.  allocate another chunk of buckets */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN241"><span class='Ref_to_Proto'>element_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN170"><span class='Ref_to_Member'>nelem_alloc</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* out of memory */ 
</span> 
            <span class='Comment_Multi_Line'>/* try to borrow element from another partition */ 
</span>            <a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Parentheses'>) 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span> 
                <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1229"><span class='Ref_To_Local'>borrow_from_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
            <span class='Control'>return</span> <a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !element_alloc(hashp,... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* remove entry from freelist, bump nentries */ 
</span>    <a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1227"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1225"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN1228"><span class='Ref_To_Local'>newElement</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_hash_entry &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * hash_get_num_entries -- get the number of entries in a hashtable 
 */ 
</span><span class='Keyword'>long 
</span><a name="LN1296"></a><span class='Declare_Function'>hash_get_num_entries</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1298"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1299"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>sum</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN1296"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We currently don't bother with the mutex; it's only sensible to call 
     * this function if you've got lock on all partitions of the table. 
     */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1296"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <a href="dynahash.c.html#LN1299"><span class='Ref_To_Local'>sum</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1298"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1298"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN114"><span class='Ref_to_Const'>NUM_FREELISTS</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1298"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN1299"><span class='Ref_To_Local'>sum</span></a> <span class='Operator'>+= </span><a href="dynahash.c.html#LN1296"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1298"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN130"><span class='Ref_to_Member'>nentries</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN1299"><span class='Ref_To_Local'>sum</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * hash_seq_init/_search/_term 
 *          Sequentially search through hash table and return 
 *          all the elements one by one, return NULL when no more. 
 * 
 * hash_seq_term should be called if and only if the scan is abandoned before 
 * completion; if hash_seq_search returns NULL then it has already done the 
 * end-of-scan cleanup. 
 * 
 * NOTE: caller may delete the returned element before continuing the scan. 
 * However, deleting any other element while the scan is in progress is 
 * UNDEFINED (it might be the one that curIndex is pointing at!).  Also, 
 * if elements are added to the table while the scan is in progress, it is 
 * unspecified whether they will be visited by the scan or not. 
 * 
 * NOTE: it is possible to use hash_seq_init/hash_seq_search without any 
 * worry about hash_seq_term cleanup, if the hashtable is first locked against 
 * further insertions by calling hash_freeze. 
 * 
 * NOTE: to use this with a partitioned hashtable, caller had better hold 
 * at least shared lock on all partitions of the table throughout the scan! 
 * We can cope with insertions or deletions by our own backend, but *not* 
 * with concurrent insertions or deletions by another. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1340"></a><span class='Declare_Function'>hash_seq_init</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN113"><span class='Ref_to_Member'>hashp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN114"><span class='Ref_to_Member'>curBucket</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN251"><span class='Ref_to_Proto'>register_seq_scan</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1340"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN1350"></a><span class='Declare_Function'>hash_seq_search</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1352"></a>    <a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>hashp</span><span class='Delimiter'>; 
</span><a name="LN1353"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span><span class='Delimiter'>; 
</span><a name="LN1354"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>max_bucket</span><span class='Delimiter'>; 
</span><a name="LN1355"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>ssize</span><span class='Delimiter'>; 
</span><a name="LN1356"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_num</span><span class='Delimiter'>; 
</span><a name="LN1357"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>segment_ndx</span><span class='Delimiter'>; 
</span><a name="LN1358"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Local'>segp</span><span class='Delimiter'>; 
</span><a name="LN1359"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>curBucket</span><span class='Delimiter'>; 
</span><a name="LN1360"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>curElem</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Continuing scan of curBucket... */ 
</span>        <a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>   <span class='Comment_Single_Line'>/* end of this bucket */ 
</span>            <span class='Operator'>++</span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN114"><span class='Ref_to_Member'>curBucket</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search for next nonempty bucket starting at curBucket. 
     */ 
</span>    <a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN114"><span class='Ref_to_Member'>curBucket</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN113"><span class='Ref_to_Member'>hashp</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1353"><span class='Ref_To_Local'>hctl</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1355"><span class='Ref_To_Local'>ssize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1354"><span class='Ref_To_Local'>max_bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1353"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a> <span class='Operator'>&GT; </span><a href="dynahash.c.html#LN1354"><span class='Ref_To_Local'>max_bucket</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN136"><span class='Ref_to_Proto'>hash_seq_term</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* search is done */ 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * first find the right segment in the table directory. 
     */ 
</span>    <a href="dynahash.c.html#LN1356"><span class='Ref_To_Local'>segment_num</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1357"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1355"><span class='Ref_To_Local'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1358"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1356"><span class='Ref_To_Local'>segment_num</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Pick up the first item in this bucket's chain.  If chain is not empty 
     * we can begin searching it.  Otherwise we have to advance to find the 
     * next nonempty bucket.  We try to optimize that case since searching a 
     * near-empty hashtable has to iterate this loop a lot. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1358"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1357"><span class='Ref_To_Local'>segment_ndx</span></a><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* empty bucket, advance to next */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a> <span class='Operator'>&GT; </span><a href="dynahash.c.html#LN1354"><span class='Ref_To_Local'>max_bucket</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN114"><span class='Ref_to_Member'>curBucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/hsearch.h.html#LN136"><span class='Ref_to_Proto'>hash_seq_term</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* search is done */ 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>++</span><a href="dynahash.c.html#LN1357"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN1355"><span class='Ref_To_Local'>ssize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dynahash.c.html#LN1356"><span class='Ref_To_Local'>segment_num</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN1357"><span class='Ref_To_Local'>segment_ndx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN1358"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1352"><span class='Ref_To_Local'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1356"><span class='Ref_To_Local'>segment_num</span></a><span class='Delimiter'>]; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Begin scan of curBucket... */ 
</span>    <a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN115"><span class='Ref_to_Member'>curEntry</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span>       <span class='Comment_Single_Line'>/* end of this bucket */ 
</span>        <span class='Operator'>++</span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1350"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN114"><span class='Ref_to_Member'>curBucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1359"><span class='Ref_To_Local'>curBucket</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN217"><span class='Ref_to_Macro'>ELEMENTKEY</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1360"><span class='Ref_To_Local'>curElem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end hash_seq_search &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN1426"></a><span class='Declare_Function'>hash_seq_term</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>status</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN1426"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN113"><span class='Ref_to_Member'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN252"><span class='Ref_to_Proto'>deregister_seq_scan</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1426"><span class='Ref_to_Parameter'>status</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN113"><span class='Ref_to_Member'>hashp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * hash_freeze 
 *          Freeze a hashtable against future insertions (deletions are 
 *          still allowed) 
 * 
 * The reason for doing this is that by preventing any more bucket splits, 
 * we no longer need to worry about registering hash_seq_search scans, 
 * and thus caller need not be careful about ensuring hash_seq_term gets 
 * called at the right times. 
 * 
 * Multiple calls to hash_freeze() are allowed, but you can't freeze a table 
 * with active scans (since hash_seq_term would then do the wrong thing). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1446"></a><span class='Declare_Function'>hash_freeze</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN202"><span class='Ref_to_Member'>isshared</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot freeze shared hashtable \"%s\""</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>&& </span><a href="dynahash.c.html#LN253"><span class='Ref_to_Proto'>has_seq_scans</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot freeze hashtable \"%s\" because it has active scans"</span><span class='Delimiter'>, 
</span>             <a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1446"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN206"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/********************************* UTILITIES ************************/ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Expand the table by adding one more hash bucket. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1463"></a><span class='Declare_Function'>expand_table</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1465"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN1466"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Local'>old_seg</span><span class='Delimiter'>, 
</span><a name="LN1467"></a>                <span class='Declare_Local'>new_seg</span><span class='Delimiter'>; 
</span><a name="LN1468"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>old_bucket</span><span class='Delimiter'>, 
</span><a name="LN1469"></a>                <span class='Declare_Local'>new_bucket</span><span class='Delimiter'>; 
</span><a name="LN1470"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>new_segnum</span><span class='Delimiter'>, 
</span><a name="LN1471"></a>                <span class='Declare_Local'>new_segndx</span><span class='Delimiter'>; 
</span><a name="LN1472"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>old_segnum</span><span class='Delimiter'>, 
</span><a name="LN1473"></a>                <span class='Declare_Local'>old_segndx</span><span class='Delimiter'>; 
</span><a name="LN1474"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a> <span class='Operator'>*</span><span class='Declare_Local'>oldlink</span><span class='Delimiter'>, 
</span><a name="LN1475"></a>               <span class='Operator'>*</span><span class='Declare_Local'>newlink</span><span class='Delimiter'>; 
</span><a name="LN1476"></a>    <a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a>  <span class='Declare_Local'>currElement</span><span class='Delimiter'>, 
</span><a name="LN1477"></a>                <span class='Declare_Local'>nextElement</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HASH_STATISTICS 
    <a href="dynahash.c.html#LN233"><span class='Ref_to_Global_Var'>hash_expansions</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1470"><span class='Ref_To_Local'>new_segnum</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1471"><span class='Ref_To_Local'>new_segndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1470"><span class='Ref_To_Local'>new_segnum</span></a> <span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Allocate new segment if necessary -- could fail if dir full */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1470"><span class='Ref_To_Local'>new_segnum</span></a> <span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN242"><span class='Ref_to_Proto'>dir_realloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1470"><span class='Ref_To_Local'>new_segnum</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN240"><span class='Ref_to_Proto'>seg_alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>)))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN157"><span class='Ref_to_Member'>nsegs</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* OK, we created a new bucket */ 
</span>    <a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN158"><span class='Ref_to_Member'>max_bucket</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * *Before* changing masks, find old bucket corresponding to same hash 
     * values; values in that bucket may need to be relocated to new bucket. 
     * Note that new_bucket is certainly larger than low_mask at this point, 
     * so we can skip the first step of the regular hash mask calc. 
     */ 
</span>    <a href="dynahash.c.html#LN1468"><span class='Ref_To_Local'>old_bucket</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>& </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we crossed a power of 2, readjust masks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>&GT; </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN159"><span class='Ref_to_Member'>high_mask</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1469"><span class='Ref_To_Local'>new_bucket</span></a> <span class='Operator'>| </span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN160"><span class='Ref_to_Member'>low_mask</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Relocate records to the new bucket.  NOTE: because of the way the hash 
     * masking is done in calc_bucket, only one old bucket can need to be 
     * split at this point.  With a different way of reducing the hash value, 
     * that might not be true! 
     */ 
</span>    <a href="dynahash.c.html#LN1472"><span class='Ref_To_Local'>old_segnum</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1468"><span class='Ref_To_Local'>old_bucket</span></a> <span class='Operator'>&GT;&GT; </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN211"><span class='Ref_to_Member'>sshift</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1473"><span class='Ref_To_Local'>old_segndx</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN228"><span class='Ref_to_Macro'>MOD</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1468"><span class='Ref_To_Local'>old_bucket</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1466"><span class='Ref_To_Local'>old_seg</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1472"><span class='Ref_To_Local'>old_segnum</span></a><span class='Delimiter'>]; 
</span>    <a href="dynahash.c.html#LN1467"><span class='Ref_To_Local'>new_seg</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1463"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1470"><span class='Ref_To_Local'>new_segnum</span></a><span class='Delimiter'>]; 
</span> 
    <a href="dynahash.c.html#LN1474"><span class='Ref_To_Local'>oldlink</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1466"><span class='Ref_To_Local'>old_seg</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1473"><span class='Ref_To_Local'>old_segndx</span></a><span class='Delimiter'>]; 
</span>    <a href="dynahash.c.html#LN1475"><span class='Ref_To_Local'>newlink</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1467"><span class='Ref_To_Local'>new_seg</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1471"><span class='Ref_To_Local'>new_segndx</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a> <span class='Operator'>= *</span><a href="dynahash.c.html#LN1474"><span class='Ref_To_Local'>oldlink</span></a><span class='Delimiter'>; 
</span>         <a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1477"><span class='Ref_To_Local'>nextElement</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN1477"><span class='Ref_To_Local'>nextElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN844"><span class='Ref_to_Func'>calc_bucket</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1465"><span class='Ref_To_Local'>hctl</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN53"><span class='Ref_to_Member'>hashvalue</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="dynahash.c.html#LN1468"><span class='Ref_To_Local'>old_bucket</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="dynahash.c.html#LN1474"><span class='Ref_To_Local'>oldlink</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN1474"><span class='Ref_To_Local'>oldlink</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>*</span><a href="dynahash.c.html#LN1475"><span class='Ref_To_Local'>newlink</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN1475"><span class='Ref_To_Local'>newlink</span></a> <span class='Operator'>= &</span><a href="dynahash.c.html#LN1476"><span class='Ref_To_Local'>currElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* don't forget to terminate the rebuilt hash chains... */ 
</span>    <span class='Operator'>*</span><a href="dynahash.c.html#LN1474"><span class='Ref_To_Local'>oldlink</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="dynahash.c.html#LN1475"><span class='Ref_To_Local'>newlink</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end expand_table &raquo; </span> 
 
 
<span class='Keyword'>static bool 
</span><a name="LN1560"></a><span class='Declare_Function'>dir_realloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1562"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p</span><span class='Delimiter'>; 
</span><a name="LN1563"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>old_p</span><span class='Delimiter'>; 
</span><a name="LN1564"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>new_dsize</span><span class='Delimiter'>; 
</span><a name="LN1565"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>old_dirsize</span><span class='Delimiter'>; 
</span><a name="LN1566"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>new_dirsize</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN167"><span class='Ref_to_Member'>max_dsize</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/hsearch.h.html#LN99"><span class='Ref_to_Const'>NO_MAX_DSIZE</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Reallocate directory */ 
</span>    <a href="dynahash.c.html#LN1564"><span class='Ref_To_Local'>new_dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>&LT;&LT; </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1565"><span class='Ref_To_Local'>old_dirsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1566"><span class='Ref_To_Local'>new_dirsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1564"><span class='Ref_To_Local'>new_dsize</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN1563"><span class='Ref_To_Local'>old_p</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1562"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1566"><span class='Ref_To_Local'>new_dirsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1562"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        memcpy<span class='Parentheses'>(</span><a href="dynahash.c.html#LN1562"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1563"><span class='Ref_To_Local'>old_p</span></a><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1565"><span class='Ref_To_Local'>old_dirsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1562"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="dynahash.c.html#LN1565"><span class='Ref_To_Local'>old_dirsize</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1566"><span class='Ref_To_Local'>new_dirsize</span></a> <span class='Operator'>- </span><a href="dynahash.c.html#LN1565"><span class='Ref_To_Local'>old_dirsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN195"><span class='Ref_to_Member'>dir</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1562"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN156"><span class='Ref_to_Member'>dsize</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1564"><span class='Ref_To_Local'>new_dsize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* XXX assume the allocator is palloc, so we know how to free */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1560"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a> <span class='Operator'>== </span><a href="dynahash.c.html#LN239"><span class='Ref_to_Proto'>DynaHashAlloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1563"><span class='Ref_To_Local'>old_p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dir_realloc &raquo; </span> 
 
 
<span class='Keyword'>static </span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> 
<a name="LN1599"></a><span class='Declare_Function'>seg_alloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1601"></a>    <a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a> <span class='Declare_Local'>segp</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1599"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1601"><span class='Ref_To_Local'>segp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN120"><span class='Ref_to_Typedef'>HASHSEGMENT</span></a><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1599"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dynahash.c.html#LN1599"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN1601"><span class='Ref_To_Local'>segp</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1601"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN117"><span class='Ref_to_Typedef'>HASHBUCKET</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dynahash.c.html#LN1599"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN210"><span class='Ref_to_Member'>ssize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dynahash.c.html#LN1601"><span class='Ref_To_Local'>segp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * allocate some new elements and link them into the indicated free list 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1618"></a><span class='Declare_Function'>element_alloc</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nelem</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>freelist_idx</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1620"></a>    <a href="dynahash.c.html#LN142"><span class='Ref_to_Struct'>HASHHDR</span></a>    <span class='Operator'>*</span><span class='Declare_Local'>hctl</span> <span class='Operator'>= </span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN194"><span class='Ref_to_Member'>hctl</span></a><span class='Delimiter'>; 
</span><a name="LN1621"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>elementSize</span><span class='Delimiter'>; 
</span><a name="LN1622"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>firstElement</span><span class='Delimiter'>; 
</span><a name="LN1623"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tmpElement</span><span class='Delimiter'>; 
</span><a name="LN1624"></a>    <a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prevElement</span><span class='Delimiter'>; 
</span><a name="LN1625"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN203"><span class='Ref_to_Member'>isfixed</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Each element has a HASHELEMENT header plus user data. */ 
</span>    <a href="dynahash.c.html#LN1621"><span class='Ref_To_Local'>elementSize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN164"><span class='Ref_to_Member'>entrysize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dynahash.c.html#LN259"><span class='Ref_to_Global_Var'>CurrentDynaHashCxt</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN200"><span class='Ref_to_Member'>hcxt</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1622"><span class='Ref_To_Local'>firstElement</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN199"><span class='Ref_to_Member'>alloc</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>nelem</span></a> <span class='Operator'>* </span><a href="dynahash.c.html#LN1621"><span class='Ref_To_Local'>elementSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dynahash.c.html#LN1622"><span class='Ref_To_Local'>firstElement</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* prepare to link all the new entries into the freelist */ 
</span>    <a href="dynahash.c.html#LN1624"><span class='Ref_To_Local'>prevElement</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1623"><span class='Ref_To_Local'>tmpElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1622"><span class='Ref_To_Local'>firstElement</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1625"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1625"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>nelem</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1625"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dynahash.c.html#LN1623"><span class='Ref_To_Local'>tmpElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1624"><span class='Ref_To_Local'>prevElement</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1624"><span class='Ref_To_Local'>prevElement</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1623"><span class='Ref_To_Local'>tmpElement</span></a><span class='Delimiter'>; 
</span>        <a href="dynahash.c.html#LN1623"><span class='Ref_To_Local'>tmpElement</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/hsearch.h.html#LN50"><span class='Ref_to_Struct'>HASHELEMENT</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dynahash.c.html#LN1623"><span class='Ref_To_Local'>tmpElement</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="dynahash.c.html#LN1621"><span class='Ref_To_Local'>elementSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* if partitioned, must lock to touch freeList */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* freelist could be nonempty if two backends did this concurrently */ 
</span>    <a href="dynahash.c.html#LN1622"><span class='Ref_To_Local'>firstElement</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/hsearch.h.html#LN52"><span class='Ref_to_Member'>link</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN131"><span class='Ref_to_Member'>freeList</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1624"><span class='Ref_To_Local'>prevElement</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN183"><span class='Ref_to_Macro'>IS_PARTITIONED</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dynahash.c.html#LN1620"><span class='Ref_To_Local'>hctl</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN152"><span class='Ref_to_Member'>freeList</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1618"><span class='Ref_to_Parameter'>freelist_idx</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dynahash.c.html#LN129"><span class='Ref_to_Member'>mutex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end element_alloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* complain when we have detected a corrupted hashtable */ 
</span><span class='Keyword'>static void 
</span><a name="LN1665"></a><span class='Declare_Function'>hash_corrupted</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If the corruption is in a shared hashtable, we'd better force a 
     * systemwide restart.  Otherwise, just shut down this one backend. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1665"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN202"><span class='Ref_to_Member'>isshared</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN52"><span class='Ref_to_Const'>PANIC</span></a><span class='Delimiter'>, </span><span class='String'>"hash table \"%s\" corrupted"</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1665"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"hash table \"%s\" corrupted"</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1665"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* calculate ceil(log base 2) of num */ 
</span><span class='Keyword'>int 
</span><a name="LN1679"></a><span class='Declare_Function'>my_log2</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1681"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1682"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>limit</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* guard against too-large input, which would put us into infinite loop */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1679"><span class='Ref_to_Parameter'>num</span></a> <span class='Operator'>&GT; </span>LONG_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN1679"><span class='Ref_to_Parameter'>num</span></a> <span class='Operator'>= </span>LONG_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1681"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1682"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1682"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN1679"><span class='Ref_to_Parameter'>num</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1681"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Delimiter'>, </span><a href="dynahash.c.html#LN1682"><span class='Ref_To_Local'>limit</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="dynahash.c.html#LN1681"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* calculate first power of 2 &GT;= num, bounded to what will fit in a long */ 
</span><span class='Keyword'>static long 
</span><a name="LN1695"></a><span class='Declare_Function'>next_pow2_long</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* my_log2's internal range check is sufficient */ 
</span>    <span class='Control'>return</span> <span class='Number'>1L</span> <span class='Operator'>&LT;&LT; </span><a href="../../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1695"><span class='Ref_to_Parameter'>num</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* calculate first power of 2 &GT;= num, bounded to what will fit in an int */ 
</span><span class='Keyword'>static int 
</span><a name="LN1703"></a><span class='Declare_Function'>next_pow2_int</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>num</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1703"><span class='Ref_to_Parameter'>num</span></a> <span class='Operator'>&GT; </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <a href="dynahash.c.html#LN1703"><span class='Ref_to_Parameter'>num</span></a> <span class='Operator'>= </span>INT_MAX <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="../../../include/utils/dynahash.h.html#LN16"><span class='Ref_to_Proto'>my_log2</span></a><span class='Parentheses'>(</span><a href="dynahash.c.html#LN1703"><span class='Ref_to_Parameter'>num</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/************************* SEQ SCAN TRACKING ************************/ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * We track active hash_seq_search scans here.  The need for this mechanism 
 * comes from the fact that a scan will get confused if a bucket split occurs 
 * while it's in progress: it might visit entries twice, or even miss some 
 * entirely (if it's partway through the same bucket that splits).  Hence 
 * we want to inhibit bucket splits if there are any active scans on the 
 * table being inserted into.  This is a fairly rare case in current usage, 
 * so just postponing the split until the next insertion seems sufficient. 
 * 
 * Given present usages of the function, only a few scans are likely to be 
 * open concurrently; so a finite-size stack of open scans seems sufficient, 
 * and we don't worry that linear search is too slow.  Note that we do 
 * allow multiple scans of the same hashtable to be open concurrently. 
 * 
 * This mechanism can support concurrent scan and insertion in a shared 
 * hashtable if it's the same backend doing both.  It would fail otherwise, 
 * but locking reasons seem to preclude any such scenario anyway, so we don't 
 * worry. 
 * 
 * This arrangement is reasonably robust if a transient hashtable is deleted 
 * without notifying us.  The absolute worst case is we might inhibit splits 
 * in another table created later at exactly the same address.  We will give 
 * a warning at transaction end for reference leaks, so any bugs leading to 
 * lack of notification should be easy to catch. 
 */ 
</span> 
<a name="LN1739"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_SEQ_SCANS</span> <span class='Number'>100</span> 
 
<a name="LN1741"></a><span class='Keyword'>static </span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>seq_scan_tables</span><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1739"><span class='Ref_to_Const'>MAX_SEQ_SCANS</span></a><span class='Delimiter'>];</span>    <span class='Comment_Single_Line'>/* tables being scanned */ 
</span><a name="LN1742"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>seq_scan_level</span><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1739"><span class='Ref_to_Const'>MAX_SEQ_SCANS</span></a><span class='Delimiter'>];</span>      <span class='Comment_Single_Line'>/* subtransaction nest level */ 
</span><a name="LN1743"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>num_seq_scans</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* Register a table as having an active hash_seq_search scan */ 
</span><span class='Keyword'>static void 
</span><a name="LN1748"></a><span class='Declare_Function'>register_seq_scan</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN1739"><span class='Ref_to_Const'>MAX_SEQ_SCANS</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"too many active hash_seq_search scans, cannot start one on \"%s\""</span><span class='Delimiter'>, 
</span>             <a href="dynahash.c.html#LN1748"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN1748"><span class='Ref_to_Parameter'>hashp</span></a><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Deregister an active scan */ 
</span><span class='Keyword'>static void 
</span><a name="LN1760"></a><span class='Declare_Function'>deregister_seq_scan</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1762"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search backward since it's most likely at the stack top */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="dynahash.c.html#LN1760"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>            <a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1762"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>            <a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"no hash_seq_search scan for hash table \"%s\""</span><span class='Delimiter'>, 
</span>         <a href="dynahash.c.html#LN1760"><span class='Ref_to_Parameter'>hashp</span></a><span class='Operator'>-&GT;</span><a href="dynahash.c.html#LN201"><span class='Ref_to_Member'>tabname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Check if a table has any active scan */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1781"></a><span class='Declare_Function'>has_seq_scans</span><span class='Parentheses'>(</span><a href="dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>hashp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1783"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1783"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1783"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1783"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1783"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="dynahash.c.html#LN1781"><span class='Ref_to_Parameter'>hashp</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Clean up any open scans at end of transaction */ 
</span><span class='Keyword'>void 
</span><a name="LN1795"></a><span class='Declare_Function'>AtEOXact_HashTables</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * During abort cleanup, open scans are expected; just silently clean 'em 
     * out.  An open scan at commit means someone forgot a hash_seq_term() 
     * call, so complain. 
     * 
     * Note: it's tempting to try to print the tabname here, but refrain for 
     * fear of touching deallocated memory.  This isn't a user-facing message 
     * anyway, so it needn't be pretty. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1795"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1808"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1808"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1808"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1808"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"leaked hash_seq_search scan for hash table %p"</span><span class='Delimiter'>, 
</span>                 <a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1808"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtEOXact_HashTables &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Clean up any open scans at end of subtransaction */ 
</span><span class='Keyword'>void 
</span><a name="LN1821"></a><span class='Declare_Function'>AtEOSubXact_HashTables</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>nestDepth</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1823"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search backward to make cleanup easy.  Note we must check all entries, 
     * not only those at the end of the array, because deletion technique 
     * doesn't keep them in order. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a><span class='Operator'>--</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>&GT;= </span><a href="dynahash.c.html#LN1821"><span class='Ref_to_Parameter'>nestDepth</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dynahash.c.html#LN1821"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"leaked hash_seq_search scan for hash table %p"</span><span class='Delimiter'>, 
</span>                     <a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN1741"><span class='Ref_to_Global_Var'>seq_scan_tables</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>            <a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1823"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dynahash.c.html#LN1742"><span class='Ref_to_Global_Var'>seq_scan_level</span></a><span class='Delimiter'>[</span><a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>            <a href="dynahash.c.html#LN1743"><span class='Ref_to_Global_Var'>num_seq_scans</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AtEOSubXact_HashTables &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>