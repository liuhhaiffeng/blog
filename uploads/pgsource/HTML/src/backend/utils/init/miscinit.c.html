<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\init\miscinit.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\init\miscinit.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:57 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * miscinit.c 
 *    miscellaneous initialization support stuff 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/init/miscinit.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/param.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/file.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/time.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;fcntl.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;grp.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;pwd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;netinet/in.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;arpa/inet.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_UTIME_H 
<span class='Keyword'>#include </span><span class='String'>&LT;utime.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/htup_details.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_authid.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq/libpq.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"mb/pg_wchar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgstat.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/autovacuum.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"postmaster/postmaster.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/fd.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/latch.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/pg_shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/guc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/varlena.h"</span> 
 
 
<a name="LN53"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DIRECTORY_LOCK_FILE</span>     <span class='String'>"postmaster.pid"</span> 
 
<a name="LN55"></a><a href="../../../include/miscadmin.h.html#LN360"><span class='Ref_to_Enum'>ProcessingMode</span></a> <span class='Declare_Var'>Mode</span> <span class='Operator'>= </span><a href="../../../include/miscadmin.h.html#LN363"><span class='Ref_to_EnumConst'>InitProcessing</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* List of lock files to be removed at proc exit */ 
</span><a name="LN58"></a><span class='Keyword'>static </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>lock_files</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
<a name="LN60"></a><span class='Keyword'>static </span><a href="../../../include/storage/latch.h.html#LN109"><span class='Ref_to_Struct'>Latch</span></a> <span class='Declare_Var'>LocalLatchData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *      ignoring system indexes support stuff 
 * 
 * NOTE: "ignoring system indexes" means we do not use the system indexes 
 * for lookups (either in hardwired catalog accesses or in planner-generated 
 * plans).  We do, however, still update the indexes when a catalog 
 * modification is made. 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<a name="LN72"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>IgnoreSystemIndexes</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *              database path / name support stuff 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>void 
</span><a name="LN81"></a><span class='Declare_Function'>SetDatabasePath</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* This should happen only once per process */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="globals.c.html#LN84"><span class='Ref_to_Global_Var'>DatabasePath</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN125"><span class='Ref_to_Proto'>MemoryContextStrdup</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN81"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set data directory, but make sure it's an absolute path.  Use this, 
 * never set DataDir directly. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN93"></a><span class='Declare_Function'>SetDataDir</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN95"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>new</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN93"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If presented path is relative, convert to absolute */ 
</span>    <span class='Control'>new</span> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN48"><span class='Ref_to_Proto'>make_absolute_path</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN93"><span class='Ref_to_Parameter'>dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a> <span class='Operator'>= </span><span class='Control'>new</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Change working directory to DataDir.  Most of the postmaster and backend 
 * code assumes that we are in DataDir so it can use relative paths to access 
 * stuff in and under the data directory.  For convenience during path 
 * setup, however, we don't force the chdir to occur during SetDataDir. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN114"></a><span class='Declare_Function'>ChangeToDataDir</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>chdir<span class='Parentheses'>(</span><a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not change directory to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *  User ID state 
 * 
 * We have to track several different values associated with the concept 
 * of "user ID". 
 * 
 * AuthenticatedUserId is determined at connection start and never changes. 
 * 
 * SessionUserId is initially the same as AuthenticatedUserId, but can be 
 * changed by SET SESSION AUTHORIZATION (if AuthenticatedUserIsSuperuser). 
 * This is the ID reported by the SESSION_USER SQL function. 
 * 
 * OuterUserId is the current user ID in effect at the "outer level" (outside 
 * any transaction or function).  This is initially the same as SessionUserId, 
 * but can be changed by SET ROLE to any role that SessionUserId is a 
 * member of.  (XXX rename to something like CurrentRoleId?) 
 * 
 * CurrentUserId is the current effective user ID; this is the one to use 
 * for all normal permissions-checking purposes.  At outer level this will 
 * be the same as OuterUserId, but it changes during calls to SECURITY 
 * DEFINER functions, as well as locally in some specialized commands. 
 * 
 * SecurityRestrictionContext holds flags indicating reason(s) for changing 
 * CurrentUserId.  In some cases we need to lock down operations that are 
 * not directly controlled by privilege settings, and this provides a 
 * convenient way to do it. 
 * ---------------------------------------------------------------- 
 */ 
</span><a name="LN154"></a><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Var'>AuthenticatedUserId</span> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN155"></a><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Var'>SessionUserId</span> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN156"></a><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Var'>OuterUserId</span> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span><a name="LN157"></a><span class='Keyword'>static </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>  <span class='Declare_Var'>CurrentUserId</span> <span class='Operator'>= </span><a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* We also have to remember the superuser state of some of these levels */ 
</span><a name="LN160"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>AuthenticatedUserIsSuperuser</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN161"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>SessionUserIsSuperuser</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<a name="LN163"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>SecurityRestrictionContext</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* We also remember if a SET ROLE is currently active */ 
</span><a name="LN166"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>SetRoleIsActive</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize the basic environment for a postmaster child 
 * 
 * Should be called as early as possible after the child's startup. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN174"></a><span class='Declare_Function'>InitPostmasterChild</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* we are a postmaster subprocess now */ 
</span> 
    <a href="globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* reset MyProcPid */ 
</span> 
    <a href="globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* set our start time in case we call elog */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * make sure stderr is in binary mode before anything can possibly be 
     * written to it, in case it's actually the syslogger pipe, so the pipe 
     * chunking protocol isn't disturbed. Non-logpipe data gets translated on 
     * redirection (e.g. via pg_ctl -l) anyway. 
     */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    _setmode<span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span>stderr<span class='Parentheses'>)</span><span class='Delimiter'>, </span>_O_BINARY<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* We don't want the postmaster's proc_exit() handlers */ 
</span>    <a href="../../../include/storage/ipc.h.html#LN72"><span class='Ref_to_Proto'>on_exit_reset</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize process-local latch support */ 
</span>    <a href="../../storage/ipc/latch.c.html#LN145"><span class='Ref_to_Func'>InitializeLatchSupport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>= &</span><a href="miscinit.c.html#LN60"><span class='Ref_to_Global_Var'>LocalLatchData</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/latch.h.html#LN147"><span class='Ref_to_Proto'>InitLatch</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If possible, make this process a group leader, so that the postmaster 
     * can signal any child processes too. Not all processes will have 
     * children, but for consistency we make all postmaster child processes do 
     * this. 
     */ 
</span><span class='Directive'>#ifdef</span> HAVE_SETSID 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>setsid<span class='Parentheses'>() </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"setsid() failed: %m"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end InitPostmasterChild &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize the basic environment for a standalone process. 
 * 
 * argv0 has to be suitable to find the program's executable. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN218"></a><span class='Declare_Function'>InitStandaloneProcess</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>argv0</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="globals.c.html#LN99"><span class='Ref_to_Global_Var'>IsPostmasterEnvironment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="globals.c.html#LN38"><span class='Ref_to_Global_Var'>MyProcPid</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* reset MyProcPid */ 
</span> 
    <a href="globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* set our start time in case we call elog */ 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize process-local latch support */ 
</span>    <a href="../../storage/ipc/latch.c.html#LN145"><span class='Ref_to_Func'>InitializeLatchSupport</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>= &</span><a href="miscinit.c.html#LN60"><span class='Ref_to_Global_Var'>LocalLatchData</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/latch.h.html#LN147"><span class='Ref_to_Proto'>InitLatch</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute paths, no postmaster to inherit from */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN96"><span class='Ref_to_Proto'>find_my_exec</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN218"><span class='Ref_to_Parameter'>argv0</span></a><span class='Delimiter'>, </span><a href="globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"%s: could not locate my own executable path"</span><span class='Delimiter'>, 
</span>                 <a href="miscinit.c.html#LN218"><span class='Ref_to_Parameter'>argv0</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <a href="../../../include/port.h.html#LN56"><span class='Ref_to_Proto'>get_pkglib_path</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="globals.c.html#LN64"><span class='Ref_to_Global_Var'>pkglib_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitStandaloneProcess &raquo; </span> 
 
<span class='Keyword'>void 
</span><a name="LN244"></a><span class='Declare_Function'>SwitchToSharedLatch</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>== &</span><a href="miscinit.c.html#LN60"><span class='Ref_to_Global_Var'>LocalLatchData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>= &</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../libpq/pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN158"><span class='Ref_to_Proto'>ModifyWaitEvent</span></a><span class='Parentheses'>(</span><a href="../../libpq/pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Set the shared latch as the local one might have been set. This 
     * shouldn't normally be necessary as code is supposed to check the 
     * condition before waiting for the latch, but a bit care can't hurt. 
     */ 
</span>    <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN263"></a><span class='Declare_Function'>SwitchBackToLocalLatch</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>!= &</span><a href="miscinit.c.html#LN60"><span class='Ref_to_Global_Var'>LocalLatchData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>== &</span><a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN102"><span class='Ref_to_Member'>procLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a> <span class='Operator'>= &</span><a href="miscinit.c.html#LN60"><span class='Ref_to_Global_Var'>LocalLatchData</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../libpq/pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/latch.h.html#LN158"><span class='Ref_to_Proto'>ModifyWaitEvent</span></a><span class='Parentheses'>(</span><a href="../../libpq/pqcomm.c.html#LN166"><span class='Ref_to_Global_Var'>FeBeWaitSet</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="../../../include/storage/latch.h.html#LN123"><span class='Ref_to_Const'>WL_LATCH_SET</span></a><span class='Delimiter'>, </span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/latch.h.html#LN151"><span class='Ref_to_Proto'>SetLatch</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN51"><span class='Ref_to_Global_Var'>MyLatch</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GetUserId - get the current effective user ID. 
 * 
 * Note: there's no SetUserId() anymore; use SetUserIdAndSecContext(). 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN282"></a><span class='Declare_Function'>GetUserId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetOuterUserId/SetOuterUserId - get/set the outer-level user ID. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN293"></a><span class='Declare_Function'>GetOuterUserId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN156"><span class='Ref_to_Global_Var'>OuterUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN156"><span class='Ref_to_Global_Var'>OuterUserId</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>static void 
</span><a name="LN301"></a><span class='Declare_Function'>SetOuterUserId</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN301"><span class='Ref_to_Parameter'>userid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN156"><span class='Ref_to_Global_Var'>OuterUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN301"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We force the effective user ID to match, too */ 
</span>    <a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN301"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetSessionUserId/SetSessionUserId - get/set the session user ID. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN316"></a><span class='Declare_Function'>GetSessionUserId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN155"><span class='Ref_to_Global_Var'>SessionUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN155"><span class='Ref_to_Global_Var'>SessionUserId</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Keyword'>static void 
</span><a name="LN324"></a><span class='Declare_Function'>SetSessionUserId</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_superuser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN324"><span class='Ref_to_Parameter'>userid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN155"><span class='Ref_to_Global_Var'>SessionUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN324"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN161"><span class='Ref_to_Global_Var'>SessionUserIsSuperuser</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN324"><span class='Ref_to_Parameter'>is_superuser</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN166"><span class='Ref_to_Global_Var'>SetRoleIsActive</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We force the effective user IDs to match, too */ 
</span>    <a href="miscinit.c.html#LN156"><span class='Ref_to_Global_Var'>OuterUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN324"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN324"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GetAuthenticatedUserId - get the authenticated user ID 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN341"></a><span class='Declare_Function'>GetAuthenticatedUserId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetUserIdAndSecContext/SetUserIdAndSecContext - get/set the current user ID 
 * and the SecurityRestrictionContext flags. 
 * 
 * Currently there are three valid bits in SecurityRestrictionContext: 
 * 
 * SECURITY_LOCAL_USERID_CHANGE indicates that we are inside an operation 
 * that is temporarily changing CurrentUserId via these functions.  This is 
 * needed to indicate that the actual value of CurrentUserId is not in sync 
 * with guc.c's internal state, so SET ROLE has to be disallowed. 
 * 
 * SECURITY_RESTRICTED_OPERATION indicates that we are inside an operation 
 * that does not wish to trust called user-defined functions at all.  This 
 * bit prevents not only SET ROLE, but various other changes of session state 
 * that normally is unprotected but might possibly be used to subvert the 
 * calling session later.  An example is replacing an existing prepared 
 * statement with new code, which will then be executed with the outer 
 * session's permissions when the prepared statement is next used.  Since 
 * these restrictions are fairly draconian, we apply them only in contexts 
 * where the called functions are really supposed to be side-effect-free 
 * anyway, such as VACUUM/ANALYZE/REINDEX. 
 * 
 * SECURITY_NOFORCE_RLS indicates that we are inside an operation which should 
 * ignore the FORCE ROW LEVEL SECURITY per-table indication.  This is used to 
 * ensure that FORCE RLS does not mistakenly break referential integrity 
 * checks.  Note that this is intentionally only checked when running as the 
 * owner of the table (which should always be the case for referential 
 * integrity checks). 
 * 
 * Unlike GetUserId, GetUserIdAndSecContext does *not* Assert that the current 
 * value of CurrentUserId is valid; nor does SetUserIdAndSecContext require 
 * the new value to be valid.  In fact, these routines had better not 
 * ever throw any kind of error.  This is because they are used by 
 * StartTransaction and AbortTransaction to save/restore the settings, 
 * and during the first transaction within a backend, the value to be saved 
 * and perhaps restored is indeed invalid.  We have to be able to get 
 * through AbortTransaction without asserting in case InitPostgres fails. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN387"></a><span class='Declare_Function'>GetUserIdAndSecContext</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>sec_context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Operator'>*</span><a href="miscinit.c.html#LN387"><span class='Ref_to_Parameter'>userid</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="miscinit.c.html#LN387"><span class='Ref_to_Parameter'>sec_context</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN394"></a><span class='Declare_Function'>SetUserIdAndSecContext</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>sec_context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN394"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN394"><span class='Ref_to_Parameter'>sec_context</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * InLocalUserIdChange - are we inside a local change of CurrentUserId? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN405"></a><span class='Declare_Function'>InLocalUserIdChange</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>& </span><a href="../../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * InSecurityRestrictedOperation - are we inside a security-restricted command? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN414"></a><span class='Declare_Function'>InSecurityRestrictedOperation</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>& </span><a href="../../../include/miscadmin.h.html#LN296"><span class='Ref_to_Const'>SECURITY_RESTRICTED_OPERATION</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * InNoForceRLSOperation - are we ignoring FORCE ROW LEVEL SECURITY ? 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN423"></a><span class='Declare_Function'>InNoForceRLSOperation</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>& </span><a href="../../../include/miscadmin.h.html#LN297"><span class='Ref_to_Const'>SECURITY_NOFORCE_RLS</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * These are obsolete versions of Get/SetUserIdAndSecContext that are 
 * only provided for bug-compatibility with some rather dubious code in 
 * pljava.  We allow the userid to be set, but only when not inside a 
 * security restriction context. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN436"></a><span class='Declare_Function'>GetUserIdAndContext</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>sec_def_context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Operator'>*</span><a href="miscinit.c.html#LN436"><span class='Ref_to_Parameter'>userid</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="miscinit.c.html#LN436"><span class='Ref_to_Parameter'>sec_def_context</span></a> <span class='Operator'>= </span><a href="../../../include/miscadmin.h.html#LN314"><span class='Ref_to_Proto'>InLocalUserIdChange</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN443"></a><span class='Declare_Function'>SetUserIdAndContext</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>sec_def_context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* We throw the same error SET ROLE would. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/miscadmin.h.html#LN315"><span class='Ref_to_Proto'>InSecurityRestrictedOperation</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot set parameter \"%s\" within security-restricted operation"</span><span class='Delimiter'>, 
</span>                        <span class='String'>"role"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN157"><span class='Ref_to_Global_Var'>CurrentUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN443"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN443"><span class='Ref_to_Parameter'>sec_def_context</span></a><span class='Parentheses'>) 
</span>        <a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>|= </span><a href="../../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="miscinit.c.html#LN163"><span class='Ref_to_Global_Var'>SecurityRestrictionContext</span></a> <span class='Operator'>&= ~</span><a href="../../../include/miscadmin.h.html#LN295"><span class='Ref_to_Const'>SECURITY_LOCAL_USERID_CHANGE</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check whether specified role has explicit REPLICATION privilege 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN463"></a><span class='Declare_Function'>has_rolreplication</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>roleid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN465"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>utup</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN466"><span class='Ref_To_Local'>utup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN44"><span class='Ref_to_EnumConst'>AUTHOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN463"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN466"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="miscinit.c.html#LN465"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/catalog/pg_authid.h.html#LN71"><span class='Ref_to_Typedef'>Form_pg_authid</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN466"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rolreplication<span class='Delimiter'>; 
</span>        <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN466"><span class='Ref_To_Local'>utup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN465"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize user identity during normal backend startup 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN481"></a><span class='Declare_Function'>InitializeSessionUserId</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>rolename</span><span class='Delimiter'>, </span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>roleid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN483"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>roleTup</span><span class='Delimiter'>; 
</span><a name="LN484"></a>    <a href="../../../include/catalog/pg_authid.h.html#LN71"><span class='Ref_to_Typedef'>Form_pg_authid</span></a> <span class='Declare_Local'>rform</span><span class='Delimiter'>; 
</span><a name="LN485"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rname</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't do scans if we're bootstrapping, none of the system catalogs 
     * exist yet, and they should be owned by postgres anyway. 
     */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/miscadmin.h.html#LN369"><span class='Ref_to_Macro'>IsBootstrapProcessingMode</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* call only once */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>rolename</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN43"><span class='Ref_to_EnumConst'>AUTHNAME</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>rolename</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"role \"%s\" does not exist"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>rolename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN44"><span class='Ref_to_EnumConst'>AUTHOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"role with OID %u does not exist"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_authid.h.html#LN71"><span class='Ref_to_Typedef'>Form_pg_authid</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a> <span class='Operator'>= </span><a href="../../../include/access/htup_details.h.html#LN694"><span class='Ref_to_Macro'>HeapTupleGetOid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN485"><span class='Ref_To_Local'>rname</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a><span class='Operator'>-&GT;</span>rolname<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a><span class='Operator'>-&GT;</span>rolsuper<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This sets OuterUserId/CurrentUserId too */ 
</span>    <a href="miscinit.c.html#LN323"><span class='Ref_to_Func'>SetSessionUserId</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Also mark our PGPROC entry with the authenticated user id */ 
</span>    <span class='Comment_Multi_Line'>/* (We assume this is an atomic store so no lock is needed) */ 
</span>    <a href="../../storage/lmgr/proc.c.html#LN66"><span class='Ref_to_Global_Var'>MyProc</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN113"><span class='Ref_to_Member'>roleId</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * These next checks are not enforced when in standalone mode, so that 
     * there is a way to recover from sillinesses like "UPDATE pg_authid SET 
     * rolcanlogin = false;". 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Is role allowed to login at all? 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a><span class='Operator'>-&GT;</span>rolcanlogin<span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_AUTHORIZATION_SPECIFICATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"role \"%s\" is not permitted to log in"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN485"><span class='Ref_To_Local'>rname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check connection limit for this role. 
         * 
         * There is a race condition here --- we create our PGPROC before 
         * checking for other PGPROCs.  If two backends did this at about the 
         * same time, they might both think they were over the limit, while 
         * ideally one should succeed and one fail.  Getting that to work 
         * exactly seems more trouble than it is worth, however; instead we 
         * just document that the connection limit is approximate. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a><span class='Operator'>-&GT;</span>rolconnlimit <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <span class='Operator'>!</span><a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a> <span class='Operator'>&& 
</span>            <a href="../../../include/storage/procarray.h.html#LN113"><span class='Ref_to_Proto'>CountUserBackends</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN481"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="miscinit.c.html#LN484"><span class='Ref_To_Local'>rform</span></a><span class='Operator'>-&GT;</span>rolconnlimit<span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_TOO_MANY_CONNECTIONS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"too many connections for role \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN485"><span class='Ref_To_Local'>rname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if IsUnderPostmaster &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Record username and superuser status as GUC settings too */ 
</span>    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"session_authorization"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN485"><span class='Ref_To_Local'>rname</span></a><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN73"><span class='Ref_to_EnumConst'>PGC_BACKEND</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"is_superuser"</span><span class='Delimiter'>, 
</span>                    <a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a> <span class='Operator'>? </span><span class='String'>"on"</span> <span class='Operator'>: </span><span class='String'>"off"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN69"><span class='Ref_to_EnumConst'>PGC_INTERNAL</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN483"><span class='Ref_To_Local'>roleTup</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end InitializeSessionUserId &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize user identity during special backend startup 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN577"></a><span class='Declare_Function'>InitializeSessionUserIdStandalone</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * This function should only be called in single-user mode, in autovacuum 
     * workers, and in background workers. 
     */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="globals.c.html#LN100"><span class='Ref_to_Global_Var'>IsUnderPostmaster</span></a> <span class='Operator'>|| </span><a href="../../../include/postmaster/autovacuum.h.html#LN50"><span class='Ref_to_Proto'>IsAutoVacuumWorkerProcess</span></a><span class='Parentheses'>() </span><span class='Operator'>|| </span><a href="globals.c.html#LN102"><span class='Ref_to_Global_Var'>IsBackgroundWorker</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* call only once */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a> <span class='Operator'>= </span><a href="../../../include/catalog/pg_authid.h.html#LN101"><span class='Ref_to_Const'>BOOTSTRAP_SUPERUSERID</span></a><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN323"><span class='Ref_to_Func'>SetSessionUserId</span></a><span class='Parentheses'>(</span><a href="../../../include/catalog/pg_authid.h.html#LN101"><span class='Ref_to_Const'>BOOTSTRAP_SUPERUSERID</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Change session auth ID while running 
 * 
 * Only a superuser may set auth ID to something other than himself.  Note 
 * that in case of multiple SETs in a single session, the original userid's 
 * superuserness is what matters.  But we set the GUC variable is_superuser 
 * to indicate whether the *current* session userid is a superuser. 
 * 
 * Note: this is not an especially clean place to do the permission check. 
 * It's OK because the check does not require catalog access and can't 
 * fail during an end-of-transaction GUC reversion, but we may someday 
 * have to push it up into assign_session_authorization. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN609"></a><span class='Declare_Function'>SetSessionAuthorization</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>userid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_superuser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Must have authenticated already, else can't make permission check */ 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN609"><span class='Ref_to_Parameter'>userid</span></a> <span class='Operator'>!= </span><a href="miscinit.c.html#LN154"><span class='Ref_to_Global_Var'>AuthenticatedUserId</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="miscinit.c.html#LN160"><span class='Ref_to_Global_Var'>AuthenticatedUserIsSuperuser</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INSUFFICIENT_PRIVILEGE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"permission denied to set session authorization"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN323"><span class='Ref_to_Func'>SetSessionUserId</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN609"><span class='Ref_to_Parameter'>userid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN609"><span class='Ref_to_Parameter'>is_superuser</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"is_superuser"</span><span class='Delimiter'>, 
</span>                    <a href="miscinit.c.html#LN609"><span class='Ref_to_Parameter'>is_superuser</span></a> <span class='Operator'>? </span><span class='String'>"on"</span> <span class='Operator'>: </span><span class='String'>"off"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN69"><span class='Ref_to_EnumConst'>PGC_INTERNAL</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Report current role id 
 *      This follows the semantics of SET ROLE, ie return the outer-level ID 
 *      not the current effective ID, and return InvalidOid when the setting 
 *      is logically SET ROLE NONE. 
 */ 
</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> 
<a name="LN634"></a><span class='Declare_Function'>GetCurrentRoleId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN166"><span class='Ref_to_Global_Var'>SetRoleIsActive</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="miscinit.c.html#LN156"><span class='Ref_to_Global_Var'>OuterUserId</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../../include/postgres_ext.h.html#LN33"><span class='Ref_to_Const'>InvalidOid</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Change Role ID while running (SET ROLE) 
 * 
 * If roleid is InvalidOid, we are doing SET ROLE NONE: revert to the 
 * session user authorization.  In this case the is_superuser argument 
 * is ignored. 
 * 
 * When roleid is not InvalidOid, the caller must have checked whether 
 * the session user has permission to become that role.  (We cannot check 
 * here because this routine must be able to execute in a failed transaction 
 * to restore a prior value of the ROLE GUC variable.) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN655"></a><span class='Declare_Function'>SetCurrentRoleId</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>roleid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_superuser</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Get correct info if it's SET ROLE NONE 
     * 
     * If SessionUserId hasn't been set yet, just do nothing --- the eventual 
     * SetSessionUserId call will fix everything.  This is needed since we 
     * will get called during GUC initialization. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN655"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN155"><span class='Ref_to_Global_Var'>SessionUserId</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
        <a href="miscinit.c.html#LN655"><span class='Ref_to_Parameter'>roleid</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN155"><span class='Ref_to_Global_Var'>SessionUserId</span></a><span class='Delimiter'>; 
</span>        <a href="miscinit.c.html#LN655"><span class='Ref_to_Parameter'>is_superuser</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN161"><span class='Ref_to_Global_Var'>SessionUserIsSuperuser</span></a><span class='Delimiter'>; 
</span> 
        <a href="miscinit.c.html#LN166"><span class='Ref_to_Global_Var'>SetRoleIsActive</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="miscinit.c.html#LN166"><span class='Ref_to_Global_Var'>SetRoleIsActive</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN300"><span class='Ref_to_Func'>SetOuterUserId</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN655"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/guc.h.html#LN276"><span class='Ref_to_Proto'>SetConfigOption</span></a><span class='Parentheses'>(</span><span class='String'>"is_superuser"</span><span class='Delimiter'>, 
</span>                    <a href="miscinit.c.html#LN655"><span class='Ref_to_Parameter'>is_superuser</span></a> <span class='Operator'>? </span><span class='String'>"on"</span> <span class='Operator'>: </span><span class='String'>"off"</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/utils/guc.h.html#LN69"><span class='Ref_to_EnumConst'>PGC_INTERNAL</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/guc.h.html#LN116"><span class='Ref_to_EnumConst'>PGC_S_OVERRIDE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetCurrentRoleId &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Get user name from user oid, returns NULL for nonexistent roleid if noerr 
 * is true. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN690"></a><span class='Declare_Function'>GetUserNameFromId</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>roleid</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>noerr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN692"></a>    <a href="../../../include/access/htup.h.html#LN69"><span class='Ref_to_Typedef'>HeapTuple</span></a>   <span class='Declare_Local'>tuple</span><span class='Delimiter'>; 
</span><a name="LN693"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN692"><span class='Ref_To_Local'>tuple</span></a> <span class='Operator'>= </span><a href="../../../include/utils/syscache.h.html#LN155"><span class='Ref_to_Macro'>SearchSysCache1</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/syscache.h.html#LN44"><span class='Ref_to_EnumConst'>AUTHOID</span></a><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN512"><span class='Ref_to_Macro'>ObjectIdGetDatum</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN690"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/htup.h.html#LN76"><span class='Ref_to_Macro'>HeapTupleIsValid</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN692"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="miscinit.c.html#LN690"><span class='Ref_to_Parameter'>noerr</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_UNDEFINED_OBJECT<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid role OID: %u"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN690"><span class='Ref_to_Parameter'>roleid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="miscinit.c.html#LN693"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="miscinit.c.html#LN693"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN498"><span class='Ref_to_Macro'>NameStr</span></a><span class='Parentheses'>(((</span><a href="../../../include/catalog/pg_authid.h.html#LN71"><span class='Ref_to_Typedef'>Form_pg_authid</span></a><span class='Parentheses'>) </span><a href="../../../include/access/htup_details.h.html#LN655"><span class='Ref_to_Macro'>GETSTRUCT</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN692"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>))</span><span class='Operator'>-&GT;</span>rolname<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/syscache.h.html#LN119"><span class='Ref_to_Proto'>ReleaseSysCache</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN692"><span class='Ref_To_Local'>tuple</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="miscinit.c.html#LN693"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetUserNameFromId &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 *              Interlock-file support 
 * 
 * These routines are used to create both a data-directory lockfile 
 * ($DATADIR/postmaster.pid) and Unix-socket-file lockfiles ($SOCKFILE.lock). 
 * Both kinds of files contain the same info initially, although we can add 
 * more information to a data-directory lockfile after it's created, using 
 * AddToDataDirLockFile().  See miscadmin.h for documentation of the contents 
 * of these lockfiles. 
 * 
 * On successful lockfile creation, a proc_exit callback to remove the 
 * lockfile is automatically created. 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * proc_exit callback to remove lockfiles. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN732"></a><span class='Declare_Function'>UnlinkLockFiles</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>status</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN734"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN734"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN738"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>curfile</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN734"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN738"><span class='Ref_To_Local'>curfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Should we complain if the unlink fails? */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Comment_Multi_Line'>/* Since we're about to exit, no need to reclaim storage */ 
</span>    <a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Lock file removal should always be the last externally visible action 
     * of a postmaster or standalone backend, while we won't come here at all 
     * when exiting postmaster child processes.  Therefore, this is a good 
     * place to log completion of shutdown.  We could alternatively teach 
     * proc_exit() to do it, but that seems uglier.  In a standalone backend, 
     * use NOTICE elevel to be less chatty. 
     */ 
</span>    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN99"><span class='Ref_to_Global_Var'>IsPostmasterEnvironment</span></a> <span class='Operator'>? </span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a> <span class='Operator'>: </span><a href="../../../include/utils/elog.h.html#LN36"><span class='Ref_to_Const'>NOTICE</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database system is shut down"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end UnlinkLockFiles &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a lockfile. 
 * 
 * filename is the path name of the lockfile to create. 
 * amPostmaster is used to determine how to encode the output PID. 
 * socketDir is the Unix socket directory path to include (possibly empty). 
 * isDDLock and refName are used to determine what error message to produce. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN767"></a><span class='Declare_Function'>CreateLockFile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>amPostmaster</span><span class='Delimiter'>, 
</span><a name="LN768"></a>               <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>socketDir</span><span class='Delimiter'>, 
</span><a name="LN769"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>isDDLock</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>refName</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN771"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN772"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buffer</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span> <span class='Operator'>+ </span><span class='Number'>256</span><span class='Delimiter'>]; 
</span><a name="LN773"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ntries</span><span class='Delimiter'>; 
</span><a name="LN774"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN775"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>encoded_pid</span><span class='Delimiter'>; 
</span><a name="LN776"></a>    <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>other_pid</span><span class='Delimiter'>; 
</span><a name="LN777"></a>    <a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a>       <span class='Declare_Local'>my_pid</span><span class='Delimiter'>, 
</span><a name="LN778"></a>                <span class='Declare_Local'>my_p_pid</span><span class='Delimiter'>, 
</span><a name="LN779"></a>                <span class='Declare_Local'>my_gp_pid</span><span class='Delimiter'>; 
</span><a name="LN780"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>envvar</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the PID in the lockfile is our own PID or our parent's or 
     * grandparent's PID, then the file must be stale (probably left over from 
     * a previous system boot cycle).  We need to check this because of the 
     * likelihood that a reboot will assign exactly the same PID as we had in 
     * the previous reboot, or one that's only one or two counts larger and 
     * hence the lockfile's PID now refers to an ancestor shell process.  We 
     * allow pg_ctl to pass down its parent shell PID (our grandparent PID) 
     * via the environment variable PG_GRANDPARENT_PID; this is so that 
     * launching the postmaster via pg_ctl can be just as reliable as 
     * launching it directly.  There is no provision for detecting 
     * further-removed ancestor processes, but if the init script is written 
     * carefully then all but the immediate parent shell will be root-owned 
     * processes and so the kill test will fail with EPERM.  Note that we 
     * cannot get a false negative this way, because an existing postmaster 
     * would surely never launch a competing postmaster or pg_ctl process 
     * directly. 
     */ 
</span>    <a href="miscinit.c.html#LN777"><span class='Ref_To_Local'>my_pid</span></a> <span class='Operator'>= </span>getpid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="miscinit.c.html#LN778"><span class='Ref_To_Local'>my_p_pid</span></a> <span class='Operator'>= </span>getppid<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Windows hasn't got getppid(), but doesn't need it since it's not using 
     * real kill() either... 
     */ 
</span>    <a href="miscinit.c.html#LN778"><span class='Ref_To_Local'>my_p_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="miscinit.c.html#LN780"><span class='Ref_To_Local'>envvar</span></a> <span class='Operator'>= </span>getenv<span class='Parentheses'>(</span><span class='String'>"PG_GRANDPARENT_PID"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN780"><span class='Ref_To_Local'>envvar</span></a><span class='Parentheses'>) 
</span>        <a href="miscinit.c.html#LN779"><span class='Ref_To_Local'>my_gp_pid</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="miscinit.c.html#LN780"><span class='Ref_To_Local'>envvar</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="miscinit.c.html#LN779"><span class='Ref_To_Local'>my_gp_pid</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We need a loop here because of race conditions.  But don't loop forever 
     * (for example, a non-writable $PGDATA directory might cause a failure 
     * that won't go away).  100 tries seems like plenty. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN773"><span class='Ref_To_Local'>ntries</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;; </span><a href="miscinit.c.html#LN773"><span class='Ref_To_Local'>ntries</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Try to create the lock file --- O_EXCL makes this atomic. 
         * 
         * Think not to make the file protection weaker than 0600.  See 
         * comments below. 
         */ 
</span>        <a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span>O_CREAT <span class='Operator'>| </span>O_EXCL<span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* Success; exit the retry loop */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Couldn't create the pid file. Probably it already exists. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span>errno <span class='Operator'>!= </span>EEXIST <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EACCES<span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="miscinit.c.html#LN773"><span class='Ref_To_Local'>ntries</span></a> <span class='Operator'>&GT; </span><span class='Number'>100</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create lock file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Read the file to get the old owner's PID.  Note race condition 
         * here: file might have been deleted since we tried to create it. 
         */ 
</span>        <a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span>O_RDONLY<span class='Delimiter'>, </span><span class='Number'>0600</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* race condition; try again */ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open lock file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN859"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="miscinit.c.html#LN774"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read lock file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN774"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_FILE_EXISTS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"lock file \"%s\" is empty"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Either another server is starting, or the lock file is the remnant of a previous server startup crash."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>[</span><a href="miscinit.c.html#LN774"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>        <a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* if pid &LT; 0, the pid is for postgres, not postmaster */ 
</span>        <a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a><span class='Parentheses'>) (</span><a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>? -</span><a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a> <span class='Operator'>: </span><a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"bogus data in lock file \"%s\": \"%s\""</span><span class='Delimiter'>, 
</span>                 <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check to see if the other process still exists 
         * 
         * Per discussion above, my_pid, my_p_pid, and my_gp_pid can be 
         * ignored as false matches. 
         * 
         * Normally kill() will fail with ESRCH if the given PID doesn't 
         * exist. 
         * 
         * We can treat the EPERM-error case as okay because that error 
         * implies that the existing process has a different userid than we 
         * do, which means it cannot be a competing postmaster.  A postmaster 
         * cannot successfully attach to a data directory owned by a userid 
         * other than its own.  (This is now checked directly in 
         * checkDataDir(), but has been true for a long time because of the 
         * restriction that the data directory isn't group- or 
         * world-accessible.)  Also, since we create the lockfiles mode 600, 
         * we'd have failed above if the lockfile belonged to another userid 
         * --- which means that whatever process kill() is reporting about 
         * isn't the one that made the lockfile.  (NOTE: this last 
         * consideration is the only one that keeps us from blowing away a 
         * Unix socket file belonging to an instance of Postgres being run by 
         * someone else, at least on machines where /tmp hasn't got a 
         * stickybit.) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a> <span class='Operator'>!= </span><a href="miscinit.c.html#LN777"><span class='Ref_To_Local'>my_pid</span></a> <span class='Operator'>&& </span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a> <span class='Operator'>!= </span><a href="miscinit.c.html#LN778"><span class='Ref_To_Local'>my_p_pid</span></a> <span class='Operator'>&& 
</span>            <a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a> <span class='Operator'>!= </span><a href="miscinit.c.html#LN779"><span class='Ref_To_Local'>my_gp_pid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span>ESRCH <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EPERM<span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* lockfile belongs to a live process */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_FILE_EXISTS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"lock file \"%s\" already exists"</span><span class='Delimiter'>, 
</span>                                <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>isDDLock</span></a> <span class='Operator'>? 
</span>                         <span class='Parentheses'>(</span><a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>? 
</span>                          <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postgres (PID %d) running in data directory \"%s\"?"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>refName</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                          <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postmaster (PID %d) running in data directory \"%s\"?"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>refName</span></a><span class='Parentheses'>))</span> <span class='Operator'>: 
</span>                         <span class='Parentheses'>(</span><a href="miscinit.c.html#LN775"><span class='Ref_To_Local'>encoded_pid</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>? 
</span>                          <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postgres (PID %d) using socket file \"%s\"?"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>refName</span></a><span class='Parentheses'>)</span> <span class='Operator'>: 
</span>                          <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"Is another postmaster (PID %d) using socket file \"%s\"?"</span><span class='Delimiter'>, 
</span>                                  <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="miscinit.c.html#LN776"><span class='Ref_To_Local'>other_pid</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>refName</span></a><span class='Parentheses'>))))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if kill(other_pid,0)==0|... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if other_pid!=my_pid&&ot... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * No, the creating process did not exist.  However, it could be that 
         * the postmaster crashed (or more likely was kill -9'd by a clueless 
         * admin) but has left orphan backends behind.  Check for this by 
         * looking to see if there is an associated shmem segment that is 
         * still in use. 
         * 
         * Note: because postmaster.pid is written in multiple steps, we might 
         * not find the shmem ID values in it; we can't treat that as an 
         * error. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>isDDLock</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN949"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span> <span class='Operator'>= </span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>; 
</span><a name="LN950"></a>            <span class='Keyword'>unsigned long </span><span class='Declare_Local'>id1</span><span class='Delimiter'>, 
</span><a name="LN951"></a>                        <span class='Declare_Local'>id2</span><span class='Delimiter'>; 
</span><a name="LN952"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>lineno</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN952"><span class='Ref_To_Local'>lineno</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="miscinit.c.html#LN952"><span class='Ref_To_Local'>lineno</span></a> <span class='Operator'>&LT; </span><a href="../../../include/miscadmin.h.html#LN456"><span class='Ref_to_Const'>LOCK_FILE_LINE_SHMEM_KEY</span></a><span class='Delimiter'>; </span><a href="miscinit.c.html#LN952"><span class='Ref_To_Local'>lineno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="miscinit.c.html#LN949"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="miscinit.c.html#LN949"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <a href="miscinit.c.html#LN949"><span class='Ref_To_Local'>ptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN949"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                sscanf<span class='Parentheses'>(</span><a href="miscinit.c.html#LN949"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>"%lu %lu"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="miscinit.c.html#LN950"><span class='Ref_To_Local'>id1</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="miscinit.c.html#LN951"><span class='Ref_To_Local'>id2</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/pg_shmem.h.html#LN68"><span class='Ref_to_Proto'>PGSharedMemoryIsInUse</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN950"><span class='Ref_To_Local'>id1</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN951"><span class='Ref_To_Local'>id2</span></a><span class='Parentheses'>))</span> 
                    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                            <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_LOCK_FILE_EXISTS<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"pre-existing shared memory block "</span> 
                                    <span class='String'>"(key %lu, ID %lu) is still in use"</span><span class='Delimiter'>, 
</span>                                    <a href="miscinit.c.html#LN950"><span class='Ref_To_Local'>id1</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN951"><span class='Ref_To_Local'>id2</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"If you're sure there are no old "</span> 
                                     <span class='String'>"server processes still running, remove "</span> 
                                     <span class='String'>"the shared memory block "</span> 
                                     <span class='String'>"or just delete the file \"%s\"."</span><span class='Delimiter'>, 
</span>                                     <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if isDDLock &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Looks like nobody's home.  Unlink the file and try again to create 
         * it.  Need a loop because of possible race condition against other 
         * would-be creators. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not remove old lock file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"The file seems accidentally left over, but "</span> 
                           <span class='String'>"it could not be removed. Please remove the file "</span> 
                             <span class='String'>"by hand and try again."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ntries=0;;ntries++ &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Successfully created the file, now fill it.  See comment in miscadmin.h 
     * about the contents.  Note that we write the same first five lines into 
     * both datadir and socket lockfiles; although more stuff may get added to 
     * the datadir lockfile later. 
     */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%d\n%s\n%ld\n%d\n%s\n"</span><span class='Delimiter'>, 
</span>             <a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>amPostmaster</span></a> <span class='Operator'>? </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <a href="miscinit.c.html#LN777"><span class='Ref_To_Local'>my_pid</span></a> <span class='Operator'>: -</span><span class='Parentheses'>((</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="miscinit.c.html#LN777"><span class='Ref_To_Local'>my_pid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>             <a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>)</span> <a href="globals.c.html#LN39"><span class='Ref_to_Global_Var'>MyStartTime</span></a><span class='Delimiter'>, 
</span>             <a href="../../postmaster/postmaster.c.html#LN193"><span class='Ref_to_Global_Var'>PostPortNumber</span></a><span class='Delimiter'>, 
</span>             <a href="miscinit.c.html#LN768"><span class='Ref_to_Parameter'>socketDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In a standalone backend, the next line (LOCK_FILE_LINE_LISTEN_ADDR) 
     * will never receive data, so fill it in as empty now. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN769"><span class='Ref_to_Parameter'>isDDLock</span></a> <span class='Operator'>&& !</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>amPostmaster</span></a><span class='Parentheses'>) 
</span>        <a href="../../../port/strlcat.c.html#LN31"><span class='Ref_to_Func'>strlcat</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN861"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="miscinit.c.html#LN772"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1017"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* if write didn't set errno, assume problem is no disk space */ 
</span>        errno <span class='Operator'>= </span><a href="miscinit.c.html#LN1017"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>? </span><a href="miscinit.c.html#LN1017"><span class='Ref_To_Local'>save_errno</span></a> <span class='Operator'>: </span>ENOSPC<span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write lock file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN860"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_CREATE_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1032"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="miscinit.c.html#LN1032"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write lock file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN771"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1044"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>save_errno</span> <span class='Operator'>= </span>errno<span class='Delimiter'>; 
</span> 
        <a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        errno <span class='Operator'>= </span><a href="miscinit.c.html#LN1044"><span class='Ref_To_Local'>save_errno</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write lock file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Arrange to unlink the lock file(s) at proc_exit.  If this is the first 
     * one, set up the on_proc_exit function to do it; then add this lock file 
     * to the list of files to unlink. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/ipc.h.html#LN68"><span class='Ref_to_Proto'>on_proc_exit</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN731"><span class='Ref_to_Func'>UnlinkLockFiles</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Use lcons so that the lock files are unlinked in reverse order of 
     * creation; this is critical! 
     */ 
</span>    <a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN215"><span class='Ref_to_Proto'>lcons</span></a><span class='Parentheses'>(</span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN767"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreateLockFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create the data directory lockfile. 
 * 
 * When this is called, we must have already switched the working 
 * directory to DataDir, so we can just use a relative path.  This 
 * helps ensure that we are locking the directory we should be. 
 * 
 * Note that the socket directory path line is initially written as empty. 
 * postmaster.c will rewrite it upon creating the first Unix socket. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1079"></a><span class='Declare_Function'>CreateDataDirLockFile</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>amPostmaster</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="miscinit.c.html#LN766"><span class='Ref_to_Func'>CreateLockFile</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1079"><span class='Ref_to_Parameter'>amPostmaster</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="globals.c.html#LN59"><span class='Ref_to_Global_Var'>DataDir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a lockfile for the specified Unix socket file. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1088"></a><span class='Declare_Function'>CreateSocketLockFile</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>socketfile</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>amPostmaster</span><span class='Delimiter'>, 
</span><a name="LN1089"></a>                     <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>socketDir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1091"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>lockfile</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1091"><span class='Ref_To_Local'>lockfile</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1091"><span class='Ref_To_Local'>lockfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s.lock"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1088"><span class='Ref_to_Parameter'>socketfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN766"><span class='Ref_to_Func'>CreateLockFile</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1091"><span class='Ref_To_Local'>lockfile</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1088"><span class='Ref_to_Parameter'>amPostmaster</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1089"><span class='Ref_to_Parameter'>socketDir</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1088"><span class='Ref_to_Parameter'>socketfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * TouchSocketLockFiles -- mark socket lock files as recently accessed 
 * 
 * This routine should be called every so often to ensure that the socket 
 * lock files have a recent mod or access date.  That saves them 
 * from being removed by overenthusiastic /tmp-directory-cleaner daemons. 
 * (Another reason we should never have put the socket file in /tmp...) 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1106"></a><span class='Declare_Function'>TouchSocketLockFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1108"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1108"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN58"><span class='Ref_to_Global_Var'>lock_files</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1112"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>socketLockFile</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1108"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* No need to touch the data directory lock file, we trust */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1112"><span class='Ref_To_Local'>socketLockFile</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * utime() is POSIX standard, utimes() is a common alternative; if we 
         * have neither, fall back to actually reading the file (which only 
         * sets the access time not mod time, but that should be enough in 
         * most cases).  In all paths, we ignore errors. 
         */ 
</span><span class='Directive'>#ifdef</span> HAVE_UTIME 
        utime<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1112"><span class='Ref_To_Local'>socketLockFile</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_UTIME */ 
</span><span class='Directive'>#ifdef</span> HAVE_UTIMES 
        utimes<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1112"><span class='Ref_To_Local'>socketLockFile</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !HAVE_UTIMES */ 
</span><a name="LN1130"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1131"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buffer</span><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span> 
        <a href="miscinit.c.html#LN1130"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1112"><span class='Ref_To_Local'>socketLockFile</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1130"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1130"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1131"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1131"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1130"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UTIMES */ 
</span><span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* HAVE_UTIME */ 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end TouchSocketLockFiles &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Add (or replace) a line in the data directory lock file. 
 * The given string should not include a trailing newline. 
 * 
 * Note: because we don't truncate the file, if we were to rewrite a line 
 * with less data than it had before, there would be garbage after the last 
 * line.  We don't ever actually do that, so not worth adding another kernel 
 * call to cover the possibility. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1155"></a><span class='Declare_Function'>AddToDataDirLockFile</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>target_line</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>str</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1157"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1158"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN1159"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>lineno</span><span class='Delimiter'>; 
</span><a name="LN1160"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>srcptr</span><span class='Delimiter'>; 
</span><a name="LN1161"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>destptr</span><span class='Delimiter'>; 
</span><a name="LN1162"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>srcbuffer</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span><a name="LN1163"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>destbuffer</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span> 
    <a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN856"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Delimiter'>[</span><a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Advance over lines we are not supposed to rewrite, then copy them to 
     * destbuffer. 
     */ 
</span>    <a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1159"><span class='Ref_To_Local'>lineno</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="miscinit.c.html#LN1159"><span class='Ref_To_Local'>lineno</span></a> <span class='Operator'>&LT; </span><a href="miscinit.c.html#LN1155"><span class='Ref_to_Parameter'>target_line</span></a><span class='Delimiter'>; </span><a href="miscinit.c.html#LN1159"><span class='Ref_To_Local'>lineno</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>))</span> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"incomplete data in \"%s\": found only %d newlines while trying to add line %d"</span><span class='Delimiter'>, 
</span>                 <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1159"><span class='Ref_To_Local'>lineno</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1155"><span class='Ref_to_Parameter'>target_line</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    memcpy<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a> <span class='Operator'>- </span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a> <span class='Operator'>- </span><a href="miscinit.c.html#LN1162"><span class='Ref_To_Local'>srcbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Write or rewrite the target line. 
     */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a><span class='Delimiter'>, </span><span class='String'>"%s\n"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1155"><span class='Ref_to_Parameter'>str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a> <span class='Operator'>+= </span>strlen<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there are more lines in the old file, append them to destbuffer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="miscinit.c.html#LN1161"><span class='Ref_To_Local'>destptr</span></a><span class='Delimiter'>, </span><span class='String'>"%s"</span><span class='Delimiter'>, 
</span>                 <a href="miscinit.c.html#LN1160"><span class='Ref_To_Local'>srcptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And rewrite the data.  Since we write in a single kernel call, this 
     * update should appear atomic to onlookers. 
     */ 
</span>    <a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN858"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_WRITE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>, </span>SEEK_SET<span class='Parentheses'>)</span> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>)</span> <a href="../../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1163"><span class='Ref_To_Local'>destbuffer</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> <span class='Operator'>!= </span><a href="miscinit.c.html#LN1158"><span class='Ref_To_Local'>len</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* if write didn't set errno, assume problem is no disk space */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            errno <span class='Operator'>= </span>ENOSPC<span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN857"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_ADDTODATADIR_SYNC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN114"><span class='Ref_to_Proto'>pg_fsync</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1157"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AddToDataDirLockFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Recheck that the data directory lock file still exists with expected 
 * content.  Return TRUE if the lock file appears OK, FALSE if it isn't. 
 * 
 * We call this periodically in the postmaster.  The idea is that if the 
 * lock file has been removed or replaced by another postmaster, we should 
 * do a panic database shutdown.  Therefore, we should return TRUE if there 
 * is any doubt: we do not want to cause a panic shutdown unnecessarily. 
 * Transient failures like EINTR or ENFILE should not cause us to fail. 
 * (If there really is something wrong, we'll detect it on a future recheck.) 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1276"></a><span class='Declare_Function'>RecheckDataDirLockFile</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1278"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN1279"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>len</span><span class='Delimiter'>; 
</span><a name="LN1280"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>file_pid</span><span class='Delimiter'>; 
</span><a name="LN1281"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buffer</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span> 
    <a href="miscinit.c.html#LN1278"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Delimiter'>, </span>O_RDWR <span class='Operator'>| </span><a href="../../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1278"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * There are many foreseeable false-positive error conditions.  For 
         * safety, fail only on enumerated clearly-something-is-wrong 
         * conditions. 
         */ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span>errno<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> ENOENT<span class='Operator'>: 
</span>            <span class='Control'>case</span> ENOTDIR<span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* disaster */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                                <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span>                <span class='Comment_Multi_Line'>/* non-fatal, at least for now */ 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                  <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m; continuing anyway"</span><span class='Delimiter'>, 
</span>                         <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fd&LT;0 &raquo; </span> 
    <a href="../../../include/pgstat.h.html#LN1206"><span class='Ref_to_Func'>pgstat_report_wait_start</span></a><span class='Parentheses'>(</span><a href="../../../include/pgstat.h.html#LN862"><span class='Ref_to_EnumConst'>WAIT_EVENT_LOCK_FILE_RECHECKDATADIR_READ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1279"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>= </span><a href="../../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1278"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1281"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1281"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/pgstat.h.html#LN1230"><span class='Ref_to_Func'>pgstat_report_wait_end</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1279"><span class='Ref_To_Local'>len</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read from file \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1278"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* treat read failure as nonfatal */ 
</span>    <span class='Delimiter'>} 
</span>    <a href="miscinit.c.html#LN1281"><span class='Ref_To_Local'>buffer</span></a><span class='Delimiter'>[</span><a href="miscinit.c.html#LN1279"><span class='Ref_To_Local'>len</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="../../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1278"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1280"><span class='Ref_To_Local'>file_pid</span></a> <span class='Operator'>= </span>atol<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1281"><span class='Ref_To_Local'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1280"><span class='Ref_To_Local'>file_pid</span></a> <span class='Operator'>== </span>getpid<span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* all is well */ 
</span> 
    <span class='Comment_Multi_Line'>/* Trouble: someone's overwritten the lock file */ 
</span>    <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>            <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"lock file \"%s\" contains wrong PID: %ld instead of %ld"</span><span class='Delimiter'>, 
</span>                    <a href="miscinit.c.html#LN53"><span class='Ref_to_Const'>DIRECTORY_LOCK_FILE</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1280"><span class='Ref_To_Local'>file_pid</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span>getpid<span class='Parentheses'>())))</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RecheckDataDirLockFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 *              Version checking support 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Determine whether the PG_VERSION file in directory `path' indicates 
 * a data version compatible with the version of this program. 
 * 
 * If compatible, return. Otherwise, ereport(FATAL). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1348"></a><span class='Declare_Function'>ValidatePgVersion</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>path</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1350"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>full_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1351"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>file</span><span class='Delimiter'>; 
</span><a name="LN1352"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ret</span><span class='Delimiter'>; 
</span><a name="LN1353"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>file_major</span><span class='Delimiter'>; 
</span><a name="LN1354"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>my_major</span><span class='Delimiter'>; 
</span><a name="LN1355"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>endptr</span><span class='Delimiter'>; 
</span><a name="LN1356"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>file_version_string</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN1357"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>my_version_string</span> <span class='Operator'>= </span>PG_VERSION<span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN1354"><span class='Ref_To_Local'>my_major</span></a> <span class='Operator'>= </span>strtol<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1357"><span class='Ref_To_Local'>my_version_string</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="miscinit.c.html#LN1355"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/PG_VERSION"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1348"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="miscinit.c.html#LN1351"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Delimiter'>, </span><span class='String'>"r"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="miscinit.c.html#LN1351"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>== </span>ENOENT<span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a valid data directory"</span><span class='Delimiter'>, 
</span>                            <a href="miscinit.c.html#LN1348"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"File \"%s\" is missing."</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not open file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="miscinit.c.html#LN1356"><span class='Ref_To_Local'>file_version_string</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1352"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>= </span>fscanf<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1351"><span class='Ref_To_Local'>file</span></a><span class='Delimiter'>, </span><span class='String'>"%63s"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1356"><span class='Ref_To_Local'>file_version_string</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1353"><span class='Ref_To_Local'>file_major</span></a> <span class='Operator'>= </span>strtol<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1356"><span class='Ref_To_Local'>file_version_string</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="miscinit.c.html#LN1355"><span class='Ref_To_Local'>endptr</span></a><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1352"><span class='Ref_To_Local'>ret</span></a> <span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="miscinit.c.html#LN1355"><span class='Ref_To_Local'>endptr</span></a> <span class='Operator'>== </span><a href="miscinit.c.html#LN1356"><span class='Ref_To_Local'>file_version_string</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"\"%s\" is not a valid data directory"</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN1348"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"File \"%s\" does not contain valid data."</span><span class='Delimiter'>, 
</span>                           <a href="miscinit.c.html#LN1350"><span class='Ref_To_Local'>full_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN985"><span class='Ref_to_Func'>errhint</span></a><span class='Parentheses'>(</span><span class='String'>"You might need to initdb."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1351"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1354"><span class='Ref_To_Local'>my_major</span></a> <span class='Operator'>!= </span><a href="miscinit.c.html#LN1353"><span class='Ref_To_Local'>file_major</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"database files are incompatible with server"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The data directory was initialized by PostgreSQL version %s, "</span> 
                           <span class='String'>"which is not compatible with this version %s."</span><span class='Delimiter'>, 
</span>                           <a href="miscinit.c.html#LN1356"><span class='Ref_To_Local'>file_version_string</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1357"><span class='Ref_To_Local'>my_version_string</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ValidatePgVersion &raquo; </span> 
 
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 *              Library preload support 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GUC variables: lists of library names to be preloaded at postmaster 
 * start and at backend start 
 */ 
</span><a name="LN1411"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>session_preload_libraries_string</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1412"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>shared_preload_libraries_string</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1413"></a><span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Var'>local_preload_libraries_string</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Flag telling that we are loading shared_preload_libraries */ 
</span><a name="LN1416"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>process_shared_preload_libraries_in_progress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * load the shared libraries listed in 'libraries' 
 * 
 * 'gucname': name of GUC variable, for error reports 
 * 'restricted': if true, force libraries to be in $libdir/plugins/ 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1425"></a><span class='Declare_Function'>load_libraries</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>libraries</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>gucname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>restricted</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1427"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>rawstring</span><span class='Delimiter'>; 
</span><a name="LN1428"></a>    <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a>       <span class='Operator'>*</span><span class='Declare_Local'>elemlist</span><span class='Delimiter'>; 
</span><a name="LN1429"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>l</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>libraries</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>libraries</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* nothing to do */ 
</span> 
    <span class='Comment_Multi_Line'>/* Need a modifiable copy of string */ 
</span>    <a href="miscinit.c.html#LN1427"><span class='Ref_To_Local'>rawstring</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>libraries</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Parse string into list of identifiers */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/varlena.h.html#LN29"><span class='Ref_to_Proto'>SplitIdentifierString</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1427"><span class='Ref_To_Local'>rawstring</span></a><span class='Delimiter'>, </span><span class='String'>','</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="miscinit.c.html#LN1428"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* syntax error in list */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1427"><span class='Ref_To_Local'>rawstring</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1428"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_SYNTAX_ERROR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid list syntax in parameter \"%s\""</span><span class='Delimiter'>, 
</span>                        <a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>gucname</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1429"><span class='Ref_To_Local'>l</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1428"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1452"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>tok</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1429"><span class='Ref_To_Local'>l</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1453"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filename</span><span class='Delimiter'>; 
</span> 
        <a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1452"><span class='Ref_To_Local'>tok</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* If restricting, insert $libdir/plugins if not mentioned already */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>restricted</span></a> <span class='Operator'>&& </span><a href="../../../include/port.h.html#LN37"><span class='Ref_to_Proto'>first_dir_separator</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1460"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>expanded</span><span class='Delimiter'>; 
</span> 
            <a href="miscinit.c.html#LN1460"><span class='Ref_To_Local'>expanded</span></a> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"$libdir/plugins/%s"</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a> <span class='Operator'>= </span><a href="miscinit.c.html#LN1460"><span class='Ref_To_Local'>expanded</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../fmgr/dfmgr.c.html#LN135"><span class='Ref_to_Func'>load_file</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1425"><span class='Ref_to_Parameter'>restricted</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"loaded library \"%s\""</span><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1453"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1427"><span class='Ref_To_Local'>rawstring</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/nodes/pg_list.h.html#LN265"><span class='Ref_to_Proto'>list_free</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1428"><span class='Ref_To_Local'>elemlist</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end load_libraries &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * process any libraries that should be preloaded at postmaster start 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1480"></a><span class='Declare_Function'>process_shared_preload_libraries</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="miscinit.c.html#LN1416"><span class='Ref_to_Global_Var'>process_shared_preload_libraries_in_progress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1424"><span class='Ref_to_Func'>load_libraries</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1412"><span class='Ref_to_Global_Var'>shared_preload_libraries_string</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"shared_preload_libraries"</span><span class='Delimiter'>, 
</span>                   <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1416"><span class='Ref_to_Global_Var'>process_shared_preload_libraries_in_progress</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * process any libraries that should be preloaded at backend start 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1493"></a><span class='Declare_Function'>process_session_preload_libraries</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="miscinit.c.html#LN1424"><span class='Ref_to_Func'>load_libraries</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1411"><span class='Ref_to_Global_Var'>session_preload_libraries_string</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"session_preload_libraries"</span><span class='Delimiter'>, 
</span>                   <span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="miscinit.c.html#LN1424"><span class='Ref_to_Func'>load_libraries</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1413"><span class='Ref_to_Global_Var'>local_preload_libraries_string</span></a><span class='Delimiter'>, 
</span>                   <span class='String'>"local_preload_libraries"</span><span class='Delimiter'>, 
</span>                   <span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN1504"></a><span class='Declare_Function'>pg_bindtextdomain</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>domain</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> ENABLE_NLS 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1509"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>locale_path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
        <a href="../../../include/port.h.html#LN57"><span class='Ref_to_Proto'>get_locale_path</span></a><span class='Parentheses'>(</span><a href="globals.c.html#LN63"><span class='Ref_to_Global_Var'>my_exec_path</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1509"><span class='Ref_To_Local'>locale_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        bindtextdomain<span class='Parentheses'>(</span><a href="miscinit.c.html#LN1504"><span class='Ref_to_Parameter'>domain</span></a><span class='Delimiter'>, </span><a href="miscinit.c.html#LN1509"><span class='Ref_To_Local'>locale_path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/mb/pg_wchar.h.html#LN551"><span class='Ref_to_Proto'>pg_bind_textdomain_codeset</span></a><span class='Parentheses'>(</span><a href="miscinit.c.html#LN1504"><span class='Ref_to_Parameter'>domain</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>