<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\mb\Unicode\convutils.pm</title>
<LINK REL=StyleSheet HREF="../../../../../Perl_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\mb\Unicode\convutils.pm</b></p></td>
<td align='right'>
Wed Jun 14 08:25:57 2017
</td></tr>
<tr><td><a href='../../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Single_Line'># 
# Copyright (c) 2001-2017, PostgreSQL Global Development Group 
# 
# src/backend/utils/mb/Unicode/convutils.pm 
</span> 
<span class='Keyword'>package </span>convutils<span class='Delimiter'>; 
</span> 
<span class='Control'>use</span> strict<span class='Delimiter'>; 
</span> 
<span class='Control'>use</span> Exporter <span class='String'>'import'</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>our </span>@EXPORT <span class='Operator'>= 
</span>  <span class='Keyword'>qw</span><span class='String'>( NONE TO_UNICODE FROM_UNICODE BOTH read_source print_conversion_tables)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Constants used in the 'direction' field of the character maps 
</span><span class='Control'>use</span> constant <span class='Delimiter'>{ 
</span>    NONE         <span class='Operator'>=&GT; </span>0<span class='Delimiter'>, 
</span>    TO_UNICODE   <span class='Operator'>=&GT; </span>1<span class='Delimiter'>, 
</span>    FROM_UNICODE <span class='Operator'>=&GT; </span>2<span class='Delimiter'>, 
</span>    BOTH         <span class='Operator'>=&GT; </span>3 <span class='Delimiter'>}; 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# read_source - common routine to read source file 
# 
# fname ; input file name 
# 
</span><a name="LN26"></a><span class='Control'>sub</span> <span class='Declare_Function'>read_source</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$fname<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>@r<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>open</span><span class='Parentheses'>(</span><span class='Keyword'>my </span>$in<span class='Delimiter'>, </span><span class='String'>'&LT;'</span><span class='Delimiter'>, </span>$fname<span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Control'>die</span><span class='Parentheses'>(</span><span class='String'>"cannot open $fname"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>&LT;</span>$in<span class='Operator'>&GT;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>/^#/</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Keyword'>chop</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>/^$/</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'># Ignore empty lines 
</span> 
        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>/^0x([0-9A-F]+)\s+(#.*)$/</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Single_Line'># The Unicode source files have three columns 
</span>        <span class='Comment_Single_Line'># 1: The "foreign" code (in hex) 
</span>        <span class='Comment_Single_Line'># 2: Unicode code point (in hex) 
</span>        <span class='Comment_Single_Line'># 3: Unicode name 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!/^0x([0-9A-Fa-f]+)\s+0x([0-9A-Fa-f]+)\s+(#.*)$/</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>print </span>STDERR <span class='String'>"READ ERROR at line $. in $fname: $_\n"</span><span class='Delimiter'>; 
</span>            <span class='Control'>exit</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Keyword'>my </span>$out <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>            code      <span class='Operator'>=&GT; </span><span class='Keyword'>hex</span><span class='Parentheses'>(</span>$1<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            ucs       <span class='Operator'>=&GT; </span><span class='Keyword'>hex</span><span class='Parentheses'>(</span>$2<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>            comment   <span class='Operator'>=&GT; </span>$4<span class='Delimiter'>, 
</span>            direction <span class='Operator'>=&GT; </span>BOTH<span class='Delimiter'>, 
</span>            f         <span class='Operator'>=&GT; </span>$fname<span class='Delimiter'>, 
</span>            l         <span class='Operator'>=&GT; </span>$<span class='Operator'>. </span><span class='Delimiter'>}; 
</span> 
        <span class='Comment_Single_Line'># Ignore pure ASCII mappings. PostgreSQL character conversion code 
</span>        <span class='Comment_Single_Line'># never even passes these to the conversion code. 
</span>        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>$out<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>} </span><span class='Operator'>&LT; </span>0x80 <span class='Operator'>|| </span>$out<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs<span class='Delimiter'>} </span><span class='Operator'>&LT; </span>0x80<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>push</span><span class='Parentheses'>(</span>@r<span class='Delimiter'>, </span>$out<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>close</span><span class='Parentheses'>(</span>$in<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Operator'>\</span>@r<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>################################################################## 
# print_conversion_tables - output mapping tables 
# 
# print_conversion_tables($this_script, $csname, \%charset) 
# 
# this_script - the name of the *caller script* of this feature 
# csname      - character set name other than ucs 
# charset     - ref to character set array 
# 
# Input character set array format: 
# 
# Each element in the character set array is a hash. Each hash has the following fields: 
#   direction  - BOTH, TO_UNICODE, or FROM_UNICODE (or NONE, to ignore the entry altogether) 
#   ucs        - Unicode code point 
#   ucs_second - Second Unicode code point, if this is a "combined" character. 
#   code       - Byte sequence in the "other" character set, as an integer 
#   comment    - Text representation of the character 
#   f          - Source filename 
#   l          - Line number in source file 
# 
</span><a name="LN90"></a><span class='Control'>sub</span> <span class='Declare_Function'>print_conversion_tables</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$this_script<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>$charset<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <a href="convutils.pm.html#LN113"><span class='Ref_to_Func'>print_conversion_tables_direction</span></a><span class='Parentheses'>(</span>$this_script<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>FROM_UNICODE<span class='Delimiter'>, 
</span>        $charset<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="convutils.pm.html#LN113"><span class='Ref_to_Func'>print_conversion_tables_direction</span></a><span class='Parentheses'>(</span>$this_script<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>TO_UNICODE<span class='Delimiter'>, 
</span>        $charset<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>############################################################################# 
# INTERNAL ROUTINES 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# print_conversion_tables_direction - write the whole content of C source of radix tree 
# 
# print_conversion_tables_direction($this_script, $csname, $direction, \%charset, $tblwidth) 
# 
# this_script - the name of the *caller script* of this feature 
# csname      - character set name other than ucs 
# direction   - desired direction, TO_UNICODE or FROM_UNICODE 
# charset     - ref to character set array 
# 
</span><a name="LN113"></a><span class='Control'>sub</span> <span class='Declare_Function'>print_conversion_tables_direction</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$this_script<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>$direction<span class='Delimiter'>, </span>$charset<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>$fname<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$tblname<span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$direction <span class='Operator'>== </span>TO_UNICODE<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $fname   <span class='Operator'>= </span><span class='Keyword'>lc</span><span class='Parentheses'>(</span><span class='String'>"${csname}_to_utf8.map"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        $tblname <span class='Operator'>= </span><span class='Keyword'>lc</span><span class='Parentheses'>(</span><span class='String'>"${csname}_to_unicode_tree"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>print </span><span class='String'>"- Writing ${csname}=&GT;UTF8 conversion table: $fname\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        $fname   <span class='Operator'>= </span><span class='Keyword'>lc</span><span class='Parentheses'>(</span><span class='String'>"utf8_to_${csname}.map"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        $tblname <span class='Operator'>= </span><span class='Keyword'>lc</span><span class='Parentheses'>(</span><span class='String'>"${csname}_from_unicode_tree"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>print </span><span class='String'>"- Writing UTF8=&GT;${csname} conversion table: $fname\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>open</span><span class='Parentheses'>(</span><span class='Keyword'>my </span>$out<span class='Delimiter'>, </span><span class='String'>'&GT;'</span><span class='Delimiter'>, </span>$fname<span class='Parentheses'>) </span><span class='Operator'>|| </span><span class='Control'>die</span><span class='Parentheses'>(</span><span class='String'>"cannot open $fname"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>print </span>$out <span class='String'>"/* src/backend/utils/mb/Unicode/$fname */\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"/* This file is generated by $this_script */\n\n"</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Single_Line'># Collect regular, non-combined, mappings, and create the radix tree from them. 
</span>    <span class='Keyword'>my </span>$charmap <span class='Operator'>= &</span><a href="convutils.pm.html#LN696"><span class='Ref_to_Func'>make_charmap</span></a><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$charset<span class='Delimiter'>, </span>$direction<span class='Delimiter'>, </span>0<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="convutils.pm.html#LN238"><span class='Ref_to_Func'>print_radix_table</span></a><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$tblname<span class='Delimiter'>, </span>$charmap<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
   <span class='Comment_Single_Line'># Collect combined characters, and create combined character table (if any) 
</span>    <span class='Keyword'>my </span>$charmap_combined <span class='Operator'>= &</span><a href="convutils.pm.html#LN757"><span class='Ref_to_Func'>make_charmap_combined</span></a><span class='Parentheses'>(</span>$charset<span class='Delimiter'>, </span>$direction<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>scalar </span>@<span class='Delimiter'>{</span>$charmap_combined<span class='Delimiter'>} </span><span class='Operator'>&GT; </span>0<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>$direction <span class='Operator'>== </span>TO_UNICODE<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="convutils.pm.html#LN195"><span class='Ref_to_Func'>print_to_utf8_combined_map</span></a><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>$charmap_combined<span class='Delimiter'>, </span>1<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="convutils.pm.html#LN161"><span class='Ref_to_Func'>print_from_utf8_combined_map</span></a><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$csname<span class='Delimiter'>, </span>$charmap_combined<span class='Delimiter'>, </span>1<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>close</span><span class='Parentheses'>(</span>$out<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN161"></a><span class='Control'>sub</span> <span class='Declare_Function'>print_from_utf8_combined_map</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$charset<span class='Delimiter'>, </span>$table<span class='Delimiter'>, </span>$verbose<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>$last_comment <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>printf </span>$out <span class='String'>"\n/* Combined character map */\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out 
<span class='String'>"static const pg_utf_to_local_combined ULmap${charset}_combined[ %d ] = {"</span><span class='Delimiter'>, 
</span>      <span class='Keyword'>scalar</span><span class='Parentheses'>(</span>@$table<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$first <span class='Operator'>= </span>1<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$i <span class='Parentheses'>(</span><span class='Keyword'>sort </span><span class='Delimiter'>{ </span>$a<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8<span class='Delimiter'>} </span><span class='Operator'>&LT;=&GT; </span>$b<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8<span class='Delimiter'>} } </span>@$table<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print</span><span class='Parentheses'>(</span>$out <span class='String'>","</span><span class='Parentheses'>) </span><span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>$first<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        $first <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"\t/* $last_comment */"</span> 
          <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&& </span>$last_comment <span class='Operator'>ne </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>printf </span>$out <span class='String'>"\n  {0x%08x, 0x%08x, 0x%04x}"</span><span class='Delimiter'>, 
</span>          $i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8_second<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>}; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&GT;= </span>2<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $last_comment <span class='Operator'>= 
</span>              <span class='Keyword'>sprintf</span><span class='Parentheses'>(</span><span class='String'>"%s:%d %s"</span><span class='Delimiter'>, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>f<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>l<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&GT;= </span>1<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $last_comment <span class='Operator'>= </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"\t/* $last_comment */"</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&& </span>$last_comment <span class='Operator'>ne </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"\n};\n"</span><span class='Delimiter'>; 
} 
</span> 
<a name="LN195"></a><span class='Control'>sub</span> <span class='Declare_Function'>print_to_utf8_combined_map</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$charset<span class='Delimiter'>, </span>$table<span class='Delimiter'>, </span>$verbose<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>$last_comment <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>printf </span>$out <span class='String'>"\n/* Combined character map */\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out 
<span class='String'>"static const pg_local_to_utf_combined LUmap${charset}_combined[ %d ] = {"</span><span class='Delimiter'>, 
</span>      <span class='Keyword'>scalar</span><span class='Parentheses'>(</span>@$table<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>$first <span class='Operator'>= </span>1<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$i <span class='Parentheses'>(</span><span class='Keyword'>sort </span><span class='Delimiter'>{ </span>$a<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>} </span><span class='Operator'>&LT;=&GT; </span>$b<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>} } </span>@$table<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print</span><span class='Parentheses'>(</span>$out <span class='String'>","</span><span class='Parentheses'>) </span><span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span>$first<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        $first <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"\t/* $last_comment */"</span> 
          <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&& </span>$last_comment <span class='Operator'>ne </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>printf </span>$out <span class='String'>"\n  {0x%04x, 0x%08x, 0x%08x}"</span><span class='Delimiter'>, 
</span>          $i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>utf8_second<span class='Delimiter'>}; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&GT;= </span>2<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $last_comment <span class='Operator'>= 
</span>              <span class='Keyword'>sprintf</span><span class='Parentheses'>(</span><span class='String'>"%s:%d %s"</span><span class='Delimiter'>, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>f<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>l<span class='Delimiter'>}, </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&GT;= </span>1<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $last_comment <span class='Operator'>= </span>$i<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"\t/* $last_comment */"</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose <span class='Operator'>&& </span>$last_comment <span class='Operator'>ne </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"\n};\n"</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# print_radix_table(&LT;output handle&GT;, &LT;table name&GT;, &LT;charmap hash ref&GT;) 
# 
# Input: A hash, mapping an input character to an output character. 
# 
# Constructs a radix tree from the hash, and prints it out as a C-struct. 
# 
</span><a name="LN238"></a><span class='Control'>sub</span> <span class='Declare_Function'>print_radix_table</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$tblname<span class='Delimiter'>, </span>$c<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Build radix trees in memory, for 1-, 2-, 3- and 4-byte inputs. Each 
</span>    <span class='Comment_Single_Line'>### radix tree is represented as a nested hash, each hash indexed by 
</span>    <span class='Comment_Single_Line'>### input byte 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Keyword'>my </span>%b1map<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>%b2map<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>%b3map<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>%b4map<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$in <span class='Parentheses'>(</span><span class='Keyword'>keys </span>%$c<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>$out <span class='Operator'>= </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$in<span class='Delimiter'>}; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>$in <span class='Operator'>&LT; </span>0x100<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $b1map<span class='Delimiter'>{</span>$in<span class='Delimiter'>} </span><span class='Operator'>= </span>$out<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$in <span class='Operator'>&LT; </span>0x10000<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$b1 <span class='Operator'>= </span>$in <span class='Operator'>&GT;&GT; </span>8<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b2 <span class='Operator'>= </span>$in <span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span> 
            $b2map<span class='Delimiter'>{</span>$b1<span class='Delimiter'>}{</span>$b2<span class='Delimiter'>} </span><span class='Operator'>= </span>$out<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$in <span class='Operator'>&LT; </span>0x1000000<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$b1 <span class='Operator'>= </span>$in <span class='Operator'>&GT;&GT; </span>16<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b2 <span class='Operator'>= </span><span class='Parentheses'>(</span>$in <span class='Operator'>&GT;&GT; </span>8<span class='Parentheses'>) </span><span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b3 <span class='Operator'>= </span>$in <span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span> 
            $b3map<span class='Delimiter'>{</span>$b1<span class='Delimiter'>}{</span>$b2<span class='Delimiter'>}{</span>$b3<span class='Delimiter'>} </span><span class='Operator'>= </span>$out<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$in <span class='Operator'>&LT; </span>0x100000000<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$b1 <span class='Operator'>= </span>$in <span class='Operator'>&GT;&GT; </span>24<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b2 <span class='Operator'>= </span><span class='Parentheses'>(</span>$in <span class='Operator'>&GT;&GT; </span>16<span class='Parentheses'>) </span><span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b3 <span class='Operator'>= </span><span class='Parentheses'>(</span>$in <span class='Operator'>&GT;&GT; </span>8<span class='Parentheses'>) </span><span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$b4 <span class='Operator'>= </span>$in <span class='Operator'>& </span>0xff<span class='Delimiter'>; 
</span> 
            $b4map<span class='Delimiter'>{</span>$b1<span class='Delimiter'>}{</span>$b2<span class='Delimiter'>}{</span>$b3<span class='Delimiter'>}{</span>$b4<span class='Delimiter'>} </span><span class='Operator'>= </span>$out<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>die</span> <span class='Keyword'>sprintf</span><span class='Parentheses'>(</span><span class='String'>"up to 4 byte code is supported: %x"</span><span class='Delimiter'>, </span>$in<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>my </span>@segments<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Build a linear list of "segments", from the nested hashes. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Each segment is a lookup table, keyed by the next byte in the input. 
</span>    <span class='Comment_Single_Line'>### The segments are written out physically to one big array in the final 
</span>    <span class='Comment_Single_Line'>### step, but logically, they form a radix tree. Or rather, four radix 
</span>    <span class='Comment_Single_Line'>### trees: one for 1-byte inputs, another for 2-byte inputs, 3-byte 
</span>    <span class='Comment_Single_Line'>### inputs, and 4-byte inputs. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Each segment is represented by a hash with following fields: 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### comment =&GT; &LT;string to output as a comment&GT; 
</span>    <span class='Comment_Single_Line'>### label =&GT; &LT;label that can be used to refer to this segment from elsewhere&GT; 
</span>    <span class='Comment_Single_Line'>### values =&GT; &LT;a hash, keyed by byte, 0-0xff&GT; 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Entries in 'values' can be integers (for leaf-level segments), or 
</span>    <span class='Comment_Single_Line'>### string labels, pointing to a segment with that label. Any missing 
</span>    <span class='Comment_Single_Line'>### values are treated as zeros. If 'values' hash is missing altogether, 
</span>    <span class='Comment_Single_Line'>### it's treated as all-zeros. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Subsequent steps will enrich the segments with more fields. 
</span>    <span class='Comment_Single_Line'>### 
</span> 
    <span class='Comment_Single_Line'># Add the segments for the radix trees themselves. 
</span>    <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>      <a href="convutils.pm.html#LN625"><span class='Ref_to_Func'>build_segments_from_tree</span></a><span class='Parentheses'>(</span><span class='String'>"Single byte table"</span><span class='Delimiter'>, </span><span class='String'>"1-byte"</span><span class='Delimiter'>, </span>1<span class='Delimiter'>, </span><span class='Operator'>\</span>%b1map<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>      <a href="convutils.pm.html#LN625"><span class='Ref_to_Func'>build_segments_from_tree</span></a><span class='Parentheses'>(</span><span class='String'>"Two byte table"</span><span class='Delimiter'>, </span><span class='String'>"2-byte"</span><span class='Delimiter'>, </span>2<span class='Delimiter'>, </span><span class='Operator'>\</span>%b2map<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>      <a href="convutils.pm.html#LN625"><span class='Ref_to_Func'>build_segments_from_tree</span></a><span class='Parentheses'>(</span><span class='String'>"Three byte table"</span><span class='Delimiter'>, </span><span class='String'>"3-byte"</span><span class='Delimiter'>, </span>3<span class='Delimiter'>, </span><span class='Operator'>\</span>%b3map<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>      <a href="convutils.pm.html#LN625"><span class='Ref_to_Func'>build_segments_from_tree</span></a><span class='Parentheses'>(</span><span class='String'>"Four byte table"</span><span class='Delimiter'>, </span><span class='String'>"4-byte"</span><span class='Delimiter'>, </span>4<span class='Delimiter'>, </span><span class='Operator'>\</span>%b4map<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Find min and max index used in each level of each tree. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### These are stored separately, and we can then leave out the unused 
</span>    <span class='Comment_Single_Line'>### parts of every segment. (When using the resulting tree, you must 
</span>    <span class='Comment_Single_Line'>### check each input byte against the min and max.) 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Keyword'>my </span>%min_idx<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>%max_idx<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>$this_min <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} }; 
</span>        <span class='Keyword'>my </span>$this_max <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} }; 
</span> 
        <span class='Control'>foreach</span> <span class='Keyword'>my </span>$i <span class='Parentheses'>(</span><span class='Keyword'>keys </span>%<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $this_min <span class='Operator'>= </span>$i <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Keyword'>defined </span>$this_min <span class='Operator'>|| </span>$i <span class='Operator'>&LT; </span>$this_min<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            $this_max <span class='Operator'>= </span>$i <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Keyword'>defined </span>$this_max <span class='Operator'>|| </span>$i <span class='Operator'>&GT; </span>$this_max<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        $min_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} } </span><span class='Operator'>= </span>$this_min<span class='Delimiter'>; 
</span>        $max_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} } </span><span class='Operator'>= </span>$this_max<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'># Copy the mins and max's back to every segment, for convenience. 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>} </span><span class='Operator'>= </span>$min_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} }; 
</span>        $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>= </span>$max_idx<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>depth<span class='Delimiter'>} }{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} }; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Prepend a dummy all-zeros map to the beginning. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### A 0 is an invalid value anywhere in the table, and this allows us to 
</span>    <span class='Comment_Single_Line'>### point to 0 offset from any table, to get a 0 result. 
</span>    <span class='Comment_Single_Line'>### 
</span> 
    <span class='Comment_Single_Line'># Find the max range between min and max indexes in any of the segments. 
</span>    <span class='Keyword'>my </span>$widest_range <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>$this_range <span class='Operator'>= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>- </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>}; 
</span>        $widest_range <span class='Operator'>= </span>$this_range <span class='Control'>if</span> <span class='Parentheses'>(</span>$this_range <span class='Operator'>&GT; </span>$widest_range<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>unshift </span>@segments<span class='Delimiter'>, 
</span>      <span class='Delimiter'>{ </span>header  <span class='Operator'>=&GT; </span><span class='String'>"Dummy map, for invalid values"</span><span class='Delimiter'>, 
</span>        min_idx <span class='Operator'>=&GT; </span>0<span class='Delimiter'>, 
</span>        max_idx <span class='Operator'>=&GT; </span>$widest_range <span class='Delimiter'>}; 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Eliminate overlapping zeros 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### For each segment, if there are zero values at the end of, and there 
</span>    <span class='Comment_Single_Line'>### are also zero values at the beginning of the next segment, we can 
</span>    <span class='Comment_Single_Line'>### overlay the tail of this segment with the head of next segment, to 
</span>    <span class='Comment_Single_Line'>### save space. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### To achieve that, we subtract the 'max_idx' of each segment with the 
</span>    <span class='Comment_Single_Line'>### amount of zeros that can be overlaid. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Keyword'>my </span>$j <span class='Operator'>= </span>0<span class='Delimiter'>; </span>$j <span class='Operator'>&LT; $#</span>segments <span class='Operator'>- </span>1<span class='Delimiter'>; </span>$j<span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>$seg     <span class='Operator'>= </span>$segments<span class='Delimiter'>[</span>$j<span class='Delimiter'>]; 
</span>        <span class='Keyword'>my </span>$nextseg <span class='Operator'>= </span>$segments<span class='Delimiter'>[ </span>$j <span class='Operator'>+ </span>1 <span class='Delimiter'>]; 
</span> 
        <span class='Comment_Single_Line'># Count the number of zero values at the end of this segment. 
</span>        <span class='Keyword'>my </span>$this_trail_zeros <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>( 
</span>            <span class='Keyword'>my </span>$i <span class='Operator'>= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>}; 
</span>            $i <span class='Operator'>&GT;= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>} </span><span class='Operator'>&& !</span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$i<span class='Delimiter'>}; 
</span>            $i<span class='Operator'>--</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $this_trail_zeros<span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Single_Line'># Count the number of zeros at the beginning of next segment. 
</span>        <span class='Keyword'>my </span>$next_lead_zeros <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>( 
</span>            <span class='Keyword'>my </span>$i <span class='Operator'>= </span>$nextseg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>}; 
</span>            $i <span class='Operator'>&LT;= </span>$nextseg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>&& !</span>$nextseg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$i<span class='Delimiter'>}; 
</span>            $i<span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $next_lead_zeros<span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Single_Line'># How many zeros in common? 
</span>        <span class='Keyword'>my </span>$overlaid_trail_zeros <span class='Operator'>= 
</span>          <span class='Parentheses'>(</span>$this_trail_zeros <span class='Operator'>&GT; </span>$next_lead_zeros<span class='Parentheses'>) 
</span>          <span class='Operator'>? </span>$next_lead_zeros 
          <span class='Operator'>: </span>$this_trail_zeros<span class='Delimiter'>; 
</span> 
        $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>overlaid_trail_zeros<span class='Delimiter'>} </span><span class='Operator'>= </span>$overlaid_trail_zeros<span class='Delimiter'>; 
</span>        $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>- </span>$overlaid_trail_zeros<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Replace label references with real offsets. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### So far, the non-leaf segments have referred to other segments by 
</span>    <span class='Comment_Single_Line'>### their labels. Replace them with numerical offsets from the beginning 
</span>    <span class='Comment_Single_Line'>### of the final array. You cannot move, add, or remove segments after 
</span>    <span class='Comment_Single_Line'>### this step, as that would invalidate the offsets calculated here! 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Keyword'>my </span>$flatoff <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>%segmap<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># First pass: assign offsets to each segment, and build hash 
</span>    <span class='Comment_Single_Line'># of label =&GT; offset. 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>offset<span class='Delimiter'>} </span><span class='Operator'>= </span>$flatoff<span class='Delimiter'>; 
</span>        $segmap<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>label<span class='Delimiter'>} } </span><span class='Operator'>= </span>$flatoff<span class='Delimiter'>; 
</span>        $flatoff <span class='Operator'>+= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>} </span><span class='Operator'>- </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>} </span><span class='Operator'>+ </span>1<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>my </span>$tblsize <span class='Operator'>= </span>$flatoff<span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># Second pass: look up the offset of each label reference in the hash. 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Keyword'>my </span><span class='Parentheses'>(</span>$i<span class='Delimiter'>, </span>$val<span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Keyword'>each </span>%<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>} }</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span>$val <span class='Operator'>=~ /^[0-9,.E]+$/</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Keyword'>my </span>$segoff <span class='Operator'>= </span>$segmap<span class='Delimiter'>{</span>$val<span class='Delimiter'>}; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>$segoff<span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    $seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$i<span class='Delimiter'>} </span><span class='Operator'>= </span>$segoff<span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>die</span> <span class='String'>"no segment with label $val"</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'># Also look up the positions of the roots in the table. 
</span>    <span class='Keyword'>my </span>$b1root <span class='Operator'>= </span>$segmap<span class='Delimiter'>{</span><span class='String'>"1-byte"</span><span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b2root <span class='Operator'>= </span>$segmap<span class='Delimiter'>{</span><span class='String'>"2-byte"</span><span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3root <span class='Operator'>= </span>$segmap<span class='Delimiter'>{</span><span class='String'>"3-byte"</span><span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4root <span class='Operator'>= </span>$segmap<span class='Delimiter'>{</span><span class='String'>"4-byte"</span><span class='Delimiter'>}; 
</span> 
    <span class='Comment_Single_Line'># And the lower-upper values of each level in each radix tree. 
</span>    <span class='Keyword'>my </span>$b1_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>1<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b1_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>1<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span> 
    <span class='Keyword'>my </span>$b2_1_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>2<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b2_1_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>2<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b2_2_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>2<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b2_2_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>2<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span> 
    <span class='Keyword'>my </span>$b3_1_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3_1_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3_2_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3_2_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3_3_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>3<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b3_3_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>3<span class='Delimiter'>}{</span>3<span class='Delimiter'>}; 
</span> 
    <span class='Keyword'>my </span>$b4_1_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_1_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>1<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_2_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_2_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>2<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_3_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>3<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_3_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>3<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_4_lower <span class='Operator'>= </span>$min_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>4<span class='Delimiter'>}; 
</span>    <span class='Keyword'>my </span>$b4_4_upper <span class='Operator'>= </span>$max_idx<span class='Delimiter'>{</span>4<span class='Delimiter'>}{</span>4<span class='Delimiter'>}; 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Find the maximum value in the whole table, to determine if we can 
</span>    <span class='Comment_Single_Line'>### use uint16 or if we need to use uint32. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Keyword'>my </span>$max_val <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>foreach</span> <span class='Keyword'>my </span>$val <span class='Parentheses'>(</span><span class='Keyword'>values </span>%<span class='Delimiter'>{ </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>} }</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            $max_val <span class='Operator'>= </span>$val <span class='Control'>if</span> <span class='Parentheses'>(</span>$val <span class='Operator'>&GT; </span>$max_val<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>my </span>$datatype <span class='Operator'>= </span><span class='Parentheses'>(</span>$max_val <span class='Operator'>&LT;= </span>0xffff<span class='Parentheses'>) </span><span class='Operator'>? </span><span class='String'>"uint16"</span> <span class='Operator'>: </span><span class='String'>"uint32"</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># For formatting, determine how many values we can fit on a single 
</span>    <span class='Comment_Single_Line'># line, and how wide each value needs to be to align nicely. 
</span>    <span class='Keyword'>my </span>$vals_per_line<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$colwidth<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>$max_val <span class='Operator'>&LT;= </span>0xffff<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $vals_per_line <span class='Operator'>= </span>8<span class='Delimiter'>; 
</span>        $colwidth      <span class='Operator'>= </span>4<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$max_val <span class='Operator'>&LT;= </span>0xffffff<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $vals_per_line <span class='Operator'>= </span>4<span class='Delimiter'>; 
</span>        $colwidth      <span class='Operator'>= </span>6<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        $vals_per_line <span class='Operator'>= </span>4<span class='Delimiter'>; 
</span>        $colwidth      <span class='Operator'>= </span>8<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'>### 
</span>    <span class='Comment_Single_Line'>### Print the struct and array. 
</span>    <span class='Comment_Single_Line'>### 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"static const $datatype ${tblname}_table[$tblsize];\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"static const pg_mb_radix_tree $tblname =\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"{\n"</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$datatype <span class='Operator'>eq </span><span class='String'>"uint16"</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"  ${tblname}_table,\n"</span><span class='Delimiter'>; 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"  NULL, /* 32-bit table not used */\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$datatype <span class='Operator'>eq </span><span class='String'>"uint32"</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"  NULL, /* 16-bit table not used */\n"</span><span class='Delimiter'>; 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"  ${tblname}_table,\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%04x, /* offset of table for 1-byte inputs */\n"</span><span class='Delimiter'>, 
</span>      $b1root<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b1_lower */\n"</span><span class='Delimiter'>, </span>$b1_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b1_upper */\n"</span><span class='Delimiter'>, </span>$b1_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%04x, /* offset of table for 2-byte inputs */\n"</span><span class='Delimiter'>, 
</span>      $b2root<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b2_1_lower */\n"</span><span class='Delimiter'>, </span>$b2_1_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b2_1_upper */\n"</span><span class='Delimiter'>, </span>$b2_1_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b2_2_lower */\n"</span><span class='Delimiter'>, </span>$b2_2_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b2_2_upper */\n"</span><span class='Delimiter'>, </span>$b2_2_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%04x, /* offset of table for 3-byte inputs */\n"</span><span class='Delimiter'>, 
</span>      $b3root<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_1_lower */\n"</span><span class='Delimiter'>, </span>$b3_1_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_1_upper */\n"</span><span class='Delimiter'>, </span>$b3_1_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_2_lower */\n"</span><span class='Delimiter'>, </span>$b3_2_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_2_upper */\n"</span><span class='Delimiter'>, </span>$b3_2_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_3_lower */\n"</span><span class='Delimiter'>, </span>$b3_3_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b3_3_upper */\n"</span><span class='Delimiter'>, </span>$b3_3_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%04x, /* offset of table for 3-byte inputs */\n"</span><span class='Delimiter'>, 
</span>      $b4root<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_1_lower */\n"</span><span class='Delimiter'>, </span>$b4_1_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_1_upper */\n"</span><span class='Delimiter'>, </span>$b4_1_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_2_lower */\n"</span><span class='Delimiter'>, </span>$b4_2_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_2_upper */\n"</span><span class='Delimiter'>, </span>$b4_2_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_3_lower */\n"</span><span class='Delimiter'>, </span>$b4_3_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_3_upper */\n"</span><span class='Delimiter'>, </span>$b4_3_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x, /* b4_4_lower */\n"</span><span class='Delimiter'>, </span>$b4_4_lower<span class='Delimiter'>; 
</span>    <span class='Keyword'>printf </span>$out <span class='String'>"  0x%02x  /* b4_4_upper */\n"</span><span class='Delimiter'>, </span>$b4_4_upper<span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"};\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"static const $datatype ${tblname}_table[$tblsize] =\n"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>print </span>$out <span class='String'>"{"</span><span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$off <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span> 
    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$seg <span class='Parentheses'>(</span>@segments<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>        <span class='Keyword'>printf </span>$out <span class='String'>"  /*** %s - offset 0x%05x ***/\n"</span><span class='Delimiter'>, </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>header<span class='Delimiter'>}, </span>$off<span class='Delimiter'>; 
</span>        <span class='Keyword'>printf </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Keyword'>my </span>$i <span class='Operator'>= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>min_idx<span class='Delimiter'>}; </span>$i <span class='Operator'>&LT;= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>};</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span> 
            <span class='Comment_Single_Line'># Print the next line's worth of values. 
</span>            <span class='Comment_Single_Line'># XXX pad to begin at a nice boundary 
</span>            <span class='Keyword'>printf </span>$out <span class='String'>"  /* %02x */ "</span><span class='Delimiter'>, </span>$i<span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Keyword'>my </span>$j <span class='Operator'>= </span>0<span class='Delimiter'>; 
</span>                $j <span class='Operator'>&LT; </span>$vals_per_line <span class='Operator'>&& </span>$i <span class='Operator'>&LT;= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>max_idx<span class='Delimiter'>}; </span>$j<span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Keyword'>my </span>$val <span class='Operator'>= </span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span><span class='Keyword'>values</span><span class='Delimiter'>}</span><span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>$i<span class='Delimiter'>}; 
</span> 
                <span class='Keyword'>printf </span>$out <span class='String'>" 0x%0*x"</span><span class='Delimiter'>, </span>$colwidth<span class='Delimiter'>, </span>$val<span class='Delimiter'>; 
</span>                $off<span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>$off <span class='Operator'>!= </span>$tblsize<span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Keyword'>print </span>$out <span class='String'>","</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                $i<span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Keyword'>print </span>$out <span class='String'>"\n"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>$seg<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>overlaid_trail_zeros<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>printf </span>$out 
<span class='String'>"    /* $seg-&GT;{overlaid_trail_zeros} trailing zero values shared with next segment */\n"</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Single_Line'># Sanity check. 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$off <span class='Operator'>!= </span>$tblsize<span class='Parentheses'>) </span><span class='Delimiter'>{ </span><span class='Control'>die</span> <span class='String'>"table size didn't match!"</span><span class='Delimiter'>; } 
</span> 
    <span class='Keyword'>print </span>$out <span class='String'>"};\n"</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>### 
</span><a name="LN625"></a><span class='Control'>sub</span> <span class='Declare_Function'>build_segments_from_tree</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$header<span class='Delimiter'>, </span>$rootlabel<span class='Delimiter'>, </span>$depth<span class='Delimiter'>, </span>$map<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>@segments<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>%<span class='Delimiter'>{</span>$map<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        @segments <span class='Operator'>= 
</span>          <a href="convutils.pm.html#LN647"><span class='Ref_to_Func'>build_segments_recurse</span></a><span class='Parentheses'>(</span>$header<span class='Delimiter'>, </span>$rootlabel<span class='Delimiter'>, </span><span class='String'>""</span><span class='Delimiter'>, </span>1<span class='Delimiter'>, </span>$depth<span class='Delimiter'>, </span>$map<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Single_Line'># Sort the segments into "breadth-first" order. Not strictly required, 
</span>        <span class='Comment_Single_Line'># but makes the maps nicer to read. 
</span>        @segments <span class='Operator'>= 
</span>          <span class='Keyword'>sort </span><span class='Delimiter'>{ </span>$a<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} </span><span class='Operator'>cmp </span>$b<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>level<span class='Delimiter'>} </span>or $a<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>path<span class='Delimiter'>} </span><span class='Operator'>cmp </span>$b<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>path<span class='Delimiter'>} } 
</span>          @segments<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> @segments<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>### 
</span><a name="LN647"></a><span class='Control'>sub</span> <span class='Declare_Function'>build_segments_recurse</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$header<span class='Delimiter'>, </span>$label<span class='Delimiter'>, </span>$path<span class='Delimiter'>, </span>$level<span class='Delimiter'>, </span>$depth<span class='Delimiter'>, </span>$map<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>@segments<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>$level <span class='Operator'>== </span>$depth<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>          <span class='Delimiter'>{ </span>header <span class='Operator'>=&GT; </span>$header <span class='Operator'>. </span><span class='String'>", leaf: ${path}xx"</span><span class='Delimiter'>, 
</span>            label  <span class='Operator'>=&GT; </span>$label<span class='Delimiter'>, 
</span>            level  <span class='Operator'>=&GT; </span>$level<span class='Delimiter'>, 
</span>            depth  <span class='Operator'>=&GT; </span>$depth<span class='Delimiter'>, 
</span>            path   <span class='Operator'>=&GT; </span>$path<span class='Delimiter'>, 
</span>            <span class='Keyword'>values </span><span class='Operator'>=&GT; </span>$map <span class='Delimiter'>}; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>my </span>%children<span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Keyword'>my </span><span class='Parentheses'>(</span>$i<span class='Delimiter'>, </span>$val<span class='Parentheses'>) </span><span class='Operator'>= </span><span class='Keyword'>each </span>%$map<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$childpath <span class='Operator'>= </span>$path <span class='Operator'>. </span><span class='Keyword'>sprintf</span><span class='Parentheses'>(</span><span class='String'>"%02x"</span><span class='Delimiter'>, </span>$i<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Keyword'>my </span>$childlabel <span class='Operator'>= </span><span class='String'>"$depth-level-$level-$childpath"</span><span class='Delimiter'>; 
</span> 
            <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>              <a href="convutils.pm.html#LN647"><span class='Ref_to_Func'>build_segments_recurse</span></a><span class='Parentheses'>(</span>$header<span class='Delimiter'>, </span>$childlabel<span class='Delimiter'>, </span>$childpath<span class='Delimiter'>, 
</span>                $level <span class='Operator'>+ </span>1<span class='Delimiter'>, </span>$depth<span class='Delimiter'>, </span>$val<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            $children<span class='Delimiter'>{</span>$i<span class='Delimiter'>} </span><span class='Operator'>= </span>$childlabel<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Keyword'>push </span>@segments<span class='Delimiter'>, 
</span>          <span class='Delimiter'>{ </span>header <span class='Operator'>=&GT; </span>$header <span class='Operator'>. </span><span class='String'>", byte #$level: ${path}xx"</span><span class='Delimiter'>, 
</span>            label  <span class='Operator'>=&GT; </span>$label<span class='Delimiter'>, 
</span>            level  <span class='Operator'>=&GT; </span>$level<span class='Delimiter'>, 
</span>            depth  <span class='Operator'>=&GT; </span>$depth<span class='Delimiter'>, 
</span>            path   <span class='Operator'>=&GT; </span>$path<span class='Delimiter'>, 
</span>            <span class='Keyword'>values </span><span class='Operator'>=&GT; \</span>%children <span class='Delimiter'>}; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> @segments<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# make_charmap - convert charset table to charmap hash 
# 
# make_charmap(\@charset, $direction) 
# charset     - ref to charset table : see print_conversion_tables 
# direction   - conversion direction 
# 
</span><a name="LN696"></a><span class='Control'>sub</span> <span class='Declare_Function'>make_charmap</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$out<span class='Delimiter'>, </span>$charset<span class='Delimiter'>, </span>$direction<span class='Delimiter'>, </span>$verbose<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Control'>die</span> <span class='String'>"unacceptable direction : $direction"</span> 
      <span class='Control'>if</span> <span class='Parentheses'>(</span>$direction <span class='Operator'>!= </span>TO_UNICODE <span class='Operator'>&& </span>$direction <span class='Operator'>!= </span>FROM_UNICODE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Single_Line'># In verbose mode, print a large comment with the source and comment of 
</span>    <span class='Comment_Single_Line'># each character 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"/*\n"</span><span class='Delimiter'>; 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"&LT;src&GT;  &LT;dst&GT;    &LT;file&GT;:&LT;lineno&GT; &LT;comment&GT;\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Keyword'>my </span>%charmap<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$c <span class='Parentheses'>(</span>@$charset<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Comment_Single_Line'># combined characters are handled elsewhere 
</span>        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs_second<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>direction<span class='Delimiter'>} </span><span class='Operator'>!= </span>$direction <span class='Operator'>&& </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>direction<span class='Delimiter'>} </span><span class='Operator'>!= </span>BOTH<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Keyword'>my </span><span class='Parentheses'>(</span>$src<span class='Delimiter'>, </span>$dst<span class='Parentheses'>) </span><span class='Operator'>= 
</span>          $direction <span class='Operator'>== </span>TO_UNICODE 
          <span class='Operator'>? </span><span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>}, </span><a href="convutils.pm.html#LN788"><span class='Ref_to_Func'>ucs2utf</span></a><span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs<span class='Delimiter'>}</span><span class='Parentheses'>))</span> 
          <span class='Operator'>: </span><span class='Parentheses'>(</span><a href="convutils.pm.html#LN788"><span class='Ref_to_Func'>ucs2utf</span></a><span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Single_Line'># check for duplicate source codes 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$charmap<span class='Delimiter'>{</span>$src<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>printf </span>STDERR 
<span class='String'>"Error: duplicate source code on %s:%d: 0x%04x =&GT; 0x%04x, 0x%04x\n"</span><span class='Delimiter'>, 
</span>              $c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>f<span class='Delimiter'>}, </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>l<span class='Delimiter'>}, </span>$src<span class='Delimiter'>, </span>$charmap<span class='Delimiter'>{</span>$src<span class='Delimiter'>}, </span>$dst<span class='Delimiter'>; 
</span>            <span class='Control'>exit</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        $charmap<span class='Delimiter'>{</span>$src<span class='Delimiter'>} </span><span class='Operator'>= </span>$dst<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose<span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>printf </span>$out <span class='String'>"0x%04x 0x%04x %s:%d %s\n"</span><span class='Delimiter'>, </span>$src<span class='Delimiter'>, </span>$dst<span class='Delimiter'>, </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>f<span class='Delimiter'>}, 
</span>              $c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>l<span class='Delimiter'>}, </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>$verbose<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Keyword'>print </span>$out <span class='String'>"*/\n\n"</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Operator'>\</span>%charmap<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# make_charmap_combined - convert charset table to charmap hash 
#     with checking duplicate source code 
# 
# make_charmap_combined(\@charset, $direction) 
# charset     - ref to charset table : see print_conversion_tables 
# direction   - conversion direction 
# 
</span><a name="LN757"></a><span class='Control'>sub</span> <span class='Declare_Function'>make_charmap_combined</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$charset<span class='Delimiter'>, </span>$direction<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span> 
    <span class='Control'>die</span> <span class='String'>"unacceptable direction : $direction"</span> 
      <span class='Control'>if</span> <span class='Parentheses'>(</span>$direction <span class='Operator'>!= </span>TO_UNICODE <span class='Operator'>&& </span>$direction <span class='Operator'>!= </span>FROM_UNICODE<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Keyword'>my </span>@combined<span class='Delimiter'>; 
</span>    <span class='Control'>foreach</span> <span class='Keyword'>my </span>$c <span class='Parentheses'>(</span>@$charset<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>next</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>direction<span class='Delimiter'>} </span><span class='Operator'>!= </span>$direction <span class='Operator'>&& </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>direction<span class='Delimiter'>} </span><span class='Operator'>!= </span>BOTH<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Keyword'>defined </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs_second<span class='Delimiter'>}</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Keyword'>my </span>$entry <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>                utf8        <span class='Operator'>=&GT; </span><a href="convutils.pm.html#LN788"><span class='Ref_to_Func'>ucs2utf</span></a><span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                utf8_second <span class='Operator'>=&GT; </span><a href="convutils.pm.html#LN788"><span class='Ref_to_Func'>ucs2utf</span></a><span class='Parentheses'>(</span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>ucs_second<span class='Delimiter'>}</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                code        <span class='Operator'>=&GT; </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>code<span class='Delimiter'>}, 
</span>                comment     <span class='Operator'>=&GT; </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>comment<span class='Delimiter'>}, 
</span>                f           <span class='Operator'>=&GT; </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>f<span class='Delimiter'>}, 
</span>                l           <span class='Operator'>=&GT; </span>$c<span class='Operator'>-&GT;</span><span class='Delimiter'>{</span>l<span class='Delimiter'>} }; 
</span>            <span class='Keyword'>push </span>@combined<span class='Delimiter'>, </span>$entry<span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Operator'>\</span>@combined<span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Single_Line'>####################################################################### 
# convert UCS-4 to UTF-8 
# 
</span><a name="LN788"></a><span class='Control'>sub</span> <span class='Declare_Function'>ucs2utf</span> 
<span class='Delimiter'>{ 
</span>    <span class='Keyword'>my </span><span class='Parentheses'>(</span>$ucs<span class='Parentheses'>) </span><span class='Operator'>= </span>@_<span class='Delimiter'>; 
</span>    <span class='Keyword'>my </span>$utf<span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>$ucs <span class='Operator'>&LT;= </span>0x007f<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $utf <span class='Operator'>= </span>$ucs<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$ucs <span class='Operator'>&GT; </span>0x007f <span class='Operator'>&& </span>$ucs <span class='Operator'>&LT;= </span>0x07ff<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $utf <span class='Operator'>= </span><span class='Parentheses'>((</span>$ucs <span class='Operator'>& </span>0x003f<span class='Parentheses'>) </span><span class='Operator'>| </span>0x80<span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Parentheses'>(((</span>$ucs <span class='Operator'>&GT;&GT; </span>6<span class='Parentheses'>) </span><span class='Operator'>| </span>0xc0<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>8<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>elsif</span> <span class='Parentheses'>(</span>$ucs <span class='Operator'>&GT; </span>0x07ff <span class='Operator'>&& </span>$ucs <span class='Operator'>&LT;= </span>0xffff<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        $utf <span class='Operator'>= 
</span>          <span class='Parentheses'>(((</span>$ucs <span class='Operator'>&GT;&GT; </span>12<span class='Parentheses'>) </span><span class='Operator'>| </span>0xe0<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>16<span class='Parentheses'>)</span> <span class='Operator'>| 
</span>          <span class='Parentheses'>((((</span>$ucs <span class='Operator'>& </span>0x0fc0<span class='Parentheses'>) </span><span class='Operator'>&GT;&GT; </span>6<span class='Parentheses'>)</span> <span class='Operator'>| </span>0x80<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>8<span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Parentheses'>((</span>$ucs <span class='Operator'>& </span>0x003f<span class='Parentheses'>) </span><span class='Operator'>| </span>0x80<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        $utf <span class='Operator'>= 
</span>          <span class='Parentheses'>(((</span>$ucs <span class='Operator'>&GT;&GT; </span>18<span class='Parentheses'>) </span><span class='Operator'>| </span>0xf0<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>24<span class='Parentheses'>)</span> <span class='Operator'>| 
</span>          <span class='Parentheses'>((((</span>$ucs <span class='Operator'>& </span>0x3ffff<span class='Parentheses'>) </span><span class='Operator'>&GT;&GT; </span>12<span class='Parentheses'>)</span> <span class='Operator'>| </span>0x80<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>16<span class='Parentheses'>)</span> <span class='Operator'>| 
</span>          <span class='Parentheses'>((((</span>$ucs <span class='Operator'>& </span>0x0fc0<span class='Parentheses'>) </span><span class='Operator'>&GT;&GT; </span>6<span class='Parentheses'>)</span> <span class='Operator'>| </span>0x80<span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span>8<span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Parentheses'>((</span>$ucs <span class='Operator'>& </span>0x003f<span class='Parentheses'>) </span><span class='Operator'>| </span>0x80<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span>$utf<span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
1<span class='Delimiter'>; 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>