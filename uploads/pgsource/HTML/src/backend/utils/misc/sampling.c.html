<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\misc\sampling.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\misc\sampling.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * sampling.c 
 *    Relation block sampling routines. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/misc/sampling.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;math.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/sampling.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * BlockSampler_Init -- prepare for random sampling of blocknumbers 
 * 
 * BlockSampler provides algorithm for block level sampling of a relation 
 * as discussed on pgsql-hackers 2004-04-02 (subject "Large DB") 
 * It selects a random sample of samplesize blocks out of 
 * the nblocks blocks in the table. If the table has less than 
 * samplesize blocks, all blocks are selected. 
 * 
 * Since we know the total number of blocks in advance, we can use the 
 * straightforward Algorithm S from Knuth 3.4.2, rather than Vitter's 
 * algorithm. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN36"></a><span class='Declare_Function'>BlockSampler_Init</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN37"><span class='Ref_to_Typedef'>BlockSampler</span></a> <span class='Declare_Parameter'>bs</span><span class='Delimiter'>, </span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Parameter'>nblocks</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>samplesize</span><span class='Delimiter'>, 
</span><a name="LN37"></a>                  <span class='Keyword'>long </span><span class='Declare_Parameter'>randseed</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN30"><span class='Ref_to_Member'>N</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>nblocks</span></a><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* measured table size */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we decide to reduce samplesize for tables that have less or not much 
     * more than samplesize blocks, here is the place to do it. 
     */ 
</span>    <a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN31"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>samplesize</span></a><span class='Delimiter'>; 
</span>    <a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* blocks scanned so far */ 
</span>    <a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN33"><span class='Ref_to_Member'>m</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>                  <span class='Comment_Single_Line'>/* blocks selected so far */ 
</span> 
    <a href="../../../include/utils/sampling.h.html#LN21"><span class='Ref_to_Proto'>sampler_random_init_state</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN37"><span class='Ref_to_Parameter'>randseed</span></a><span class='Delimiter'>, </span><a href="sampling.c.html#LN36"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN34"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN53"></a><span class='Declare_Function'>BlockSampler_HasMore</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN37"><span class='Ref_to_Typedef'>BlockSampler</span></a> <span class='Declare_Parameter'>bs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN53"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a> <span class='Operator'>&LT; </span><a href="sampling.c.html#LN53"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN30"><span class='Ref_to_Member'>N</span></a><span class='Parentheses'>) </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN53"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN33"><span class='Ref_to_Member'>m</span></a> <span class='Operator'>&LT; </span><a href="sampling.c.html#LN53"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN31"><span class='Ref_to_Member'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> 
<a name="LN59"></a><span class='Declare_Function'>BlockSampler_Next</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN37"><span class='Ref_to_Typedef'>BlockSampler</span></a> <span class='Declare_Parameter'>bs</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN61"></a>    <a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a> <span class='Declare_Local'>K</span> <span class='Operator'>= </span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN30"><span class='Ref_to_Member'>N</span></a> <span class='Operator'>- </span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* remaining blocks */ 
</span><a name="LN62"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>k</span> <span class='Operator'>= </span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN31"><span class='Ref_to_Member'>n</span></a> <span class='Operator'>- </span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN33"><span class='Ref_to_Member'>m</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* blocks still to sample */ 
</span><a name="LN63"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>p</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* probability to skip block */ 
</span><a name="LN64"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>V</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* random */ 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN41"><span class='Ref_to_Proto'>BlockSampler_HasMore</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Parentheses'>))</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* hence K &GT; 0 and k &GT; 0 */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../../include/storage/block.h.html#LN30"><span class='Ref_to_Typedef'>BlockNumber</span></a><span class='Parentheses'>) </span><a href="sampling.c.html#LN62"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>&GT;= </span><a href="sampling.c.html#LN61"><span class='Ref_To_Local'>K</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* need all the rest */ 
</span>        <a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN33"><span class='Ref_to_Member'>m</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/*---------- 
     * It is not obvious that this code matches Knuth's Algorithm S. 
     * Knuth says to skip the current block with probability 1 - k/K. 
     * If we are to skip, we should advance t (hence decrease K), and 
     * repeat the same probabilistic test for the next block.  The naive 
     * implementation thus requires a sampler_random_fract() call for each 
     * block number.  But we can reduce this to one sampler_random_fract() 
     * call per selected block, by noting that each time the while-test 
     * succeeds, we can reinterpret V as a uniform random number in the range 
     * 0 to p. Therefore, instead of choosing a new V, we just adjust p to be 
     * the appropriate fraction of its former value, and our next loop 
     * makes the appropriate probabilistic test. 
     * 
     * We have initially K &GT; k &GT; 0.  If the loop reduces K to equal k, 
     * the next while-test must fail since p will become exactly zero 
     * (we assume there will not be roundoff error in the division). 
     * (Note: Knuth suggests a "&LT;=" loop condition, but we use "&LT;" just 
     * to be doubly sure about roundoff error.)  Therefore K cannot become 
     * less than k, which means that we cannot fail to select enough blocks. 
     *---------- 
     */ 
</span>    <a href="sampling.c.html#LN64"><span class='Ref_To_Local'>V</span></a> <span class='Operator'>= </span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN34"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="sampling.c.html#LN63"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN62"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN61"><span class='Ref_To_Local'>K</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN64"><span class='Ref_To_Local'>V</span></a> <span class='Operator'>&LT; </span><a href="sampling.c.html#LN63"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* skip */ 
</span>        <a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="sampling.c.html#LN61"><span class='Ref_To_Local'>K</span></a><span class='Operator'>--</span><span class='Delimiter'>;</span>                    <span class='Comment_Single_Line'>/* keep K == N - t */ 
</span> 
        <span class='Comment_Multi_Line'>/* adjust p to be new cutoff point in reduced range */ 
</span>        <a href="sampling.c.html#LN63"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>*= </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN62"><span class='Ref_To_Local'>k</span></a> <span class='Operator'>/ </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN61"><span class='Ref_To_Local'>K</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* select */ 
</span>    <a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN33"><span class='Ref_to_Member'>m</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sampling.c.html#LN59"><span class='Ref_to_Parameter'>bs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN32"><span class='Ref_to_Member'>t</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BlockSampler_Next &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * These two routines embody Algorithm Z from "Random sampling with a 
 * reservoir" by Jeffrey S. Vitter, in ACM Trans. Math. Softw. 11, 1 
 * (Mar. 1985), Pages 37-57.  Vitter describes his algorithm in terms 
 * of the count S of records to skip before processing another record. 
 * It is computed primarily based on t, the number of records already read. 
 * The only extra state needed between calls is W, a random state variable. 
 * 
 * reservoir_init_selection_state computes the initial W value. 
 * 
 * Given that we've already read t records (t &GT;= n), reservoir_get_next_S 
 * determines the number of records to skip before the next record is 
 * processed. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN128"></a><span class='Declare_Function'>reservoir_init_selection_state</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN52"><span class='Ref_to_Typedef'>ReservoirState</span></a> <span class='Declare_Parameter'>rs</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Reservoir sampling is not used anywhere where it would need to return 
     * repeatable results so we can initialize it randomly. 
     */ 
</span>    <a href="../../../include/utils/sampling.h.html#LN21"><span class='Ref_to_Proto'>sampler_random_init_state</span></a><span class='Parentheses'>(</span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="sampling.c.html#LN128"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initial value of W (for use when Algorithm Z is first applied) */ 
</span>    <a href="sampling.c.html#LN128"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN48"><span class='Ref_to_Member'>W</span></a> <span class='Operator'>= </span>exp<span class='Parentheses'>(</span><span class='Operator'>-</span>log<span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN128"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN128"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>double 
</span><a name="LN141"></a><span class='Declare_Function'>reservoir_get_next_S</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN52"><span class='Ref_to_Typedef'>ReservoirState</span></a> <span class='Declare_Parameter'>rs</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Declare_Parameter'>t</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN143"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>S</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The magic constant here is T from Vitter's paper */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><span class='Number'>22</span><span class='Operator'>.</span><span class='Number'>0</span> <span class='Operator'>* </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Process records using Algorithm X until t is large enough */ 
</span><a name="LN149"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>V</span><span class='Delimiter'>, 
</span><a name="LN150"></a>                    <span class='Declare_Local'>quot</span><span class='Delimiter'>; 
</span> 
        <a href="sampling.c.html#LN149"><span class='Ref_To_Local'>V</span></a> <span class='Operator'>= </span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* Generate V */ 
</span>        <a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Note: "num" in Vitter's code is always equal to t - n */ 
</span>        <a href="sampling.c.html#LN150"><span class='Ref_To_Local'>quot</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Find min S satisfying (4.1) */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN150"><span class='Ref_To_Local'>quot</span></a> <span class='Operator'>&GT; </span><a href="sampling.c.html#LN149"><span class='Ref_To_Local'>V</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN150"><span class='Ref_To_Local'>quot</span></a> <span class='Operator'>*= </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Now apply Algorithm Z */ 
</span><a name="LN168"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>W</span> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN48"><span class='Ref_to_Member'>W</span></a><span class='Delimiter'>; 
</span><a name="LN169"></a>        <span class='Keyword'>double</span>      <span class='Declare_Local'>term</span> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN173"></a>            <span class='Keyword'>double</span>      <span class='Declare_Local'>numer</span><span class='Delimiter'>, 
</span><a name="LN174"></a>                        <span class='Declare_Local'>numer_lim</span><span class='Delimiter'>, 
</span><a name="LN175"></a>                        <span class='Declare_Local'>denom</span><span class='Delimiter'>; 
</span><a name="LN176"></a>            <span class='Keyword'>double</span>      <span class='Declare_Local'>U</span><span class='Delimiter'>, 
</span><a name="LN177"></a>                        <span class='Declare_Local'>X</span><span class='Delimiter'>, 
</span><a name="LN178"></a>                        <span class='Declare_Local'>lhs</span><span class='Delimiter'>, 
</span><a name="LN179"></a>                        <span class='Declare_Local'>rhs</span><span class='Delimiter'>, 
</span><a name="LN180"></a>                        <span class='Declare_Local'>y</span><span class='Delimiter'>, 
</span><a name="LN181"></a>                        <span class='Declare_Local'>tmp</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Generate U and X */ 
</span>            <a href="sampling.c.html#LN176"><span class='Ref_To_Local'>U</span></a> <span class='Operator'>= </span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN168"><span class='Ref_To_Local'>W</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a> <span class='Operator'>= </span>floor<span class='Parentheses'>(</span><a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* S is tentatively set to floor(X) */ 
</span>            <span class='Comment_Multi_Line'>/* Test if U &LT;= h(S)/cg(X) in the manner of (6.3) */ 
</span>            <a href="sampling.c.html#LN181"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN178"><span class='Ref_To_Local'>lhs</span></a> <span class='Operator'>= </span>exp<span class='Parentheses'>(</span>log<span class='Parentheses'>(((</span><a href="sampling.c.html#LN176"><span class='Ref_To_Local'>U</span></a> <span class='Operator'>* </span><a href="sampling.c.html#LN181"><span class='Ref_To_Local'>tmp</span></a> <span class='Operator'>* </span><a href="sampling.c.html#LN181"><span class='Ref_To_Local'>tmp</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="sampling.c.html#LN179"><span class='Ref_To_Local'>rhs</span></a> <span class='Operator'>= </span><span class='Parentheses'>(((</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Parentheses'>))</span> <span class='Operator'>* </span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN178"><span class='Ref_To_Local'>lhs</span></a> <span class='Operator'>&LT;= </span><a href="sampling.c.html#LN179"><span class='Ref_To_Local'>rhs</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="sampling.c.html#LN168"><span class='Ref_To_Local'>W</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN179"><span class='Ref_To_Local'>rhs</span></a> <span class='Operator'>/ </span><a href="sampling.c.html#LN178"><span class='Ref_To_Local'>lhs</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Comment_Multi_Line'>/* Test if U &LT;= f(S)/cg(X) */ 
</span>            <a href="sampling.c.html#LN180"><span class='Ref_To_Local'>y</span></a> <span class='Operator'>= </span><span class='Parentheses'>(((</span><a href="sampling.c.html#LN176"><span class='Ref_To_Local'>U</span></a> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a><span class='Parentheses'>)</span> <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>/ </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>&LT; </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="sampling.c.html#LN175"><span class='Ref_To_Local'>denom</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a><span class='Delimiter'>; 
</span>                <a href="sampling.c.html#LN174"><span class='Ref_To_Local'>numer_lim</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN169"><span class='Ref_To_Local'>term</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="sampling.c.html#LN175"><span class='Ref_To_Local'>denom</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>double</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Delimiter'>; 
</span>                <a href="sampling.c.html#LN174"><span class='Ref_To_Local'>numer_lim</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN173"><span class='Ref_To_Local'>numer</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Delimiter'>; </span><a href="sampling.c.html#LN173"><span class='Ref_To_Local'>numer</span></a> <span class='Operator'>&GT;= </span><a href="sampling.c.html#LN174"><span class='Ref_To_Local'>numer_lim</span></a><span class='Delimiter'>; </span><a href="sampling.c.html#LN173"><span class='Ref_To_Local'>numer</span></a> <span class='Operator'>-= </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="sampling.c.html#LN180"><span class='Ref_To_Local'>y</span></a> <span class='Operator'>*= </span><a href="sampling.c.html#LN173"><span class='Ref_To_Local'>numer</span></a> <span class='Operator'>/ </span><a href="sampling.c.html#LN175"><span class='Ref_To_Local'>denom</span></a><span class='Delimiter'>; 
</span>                <a href="sampling.c.html#LN175"><span class='Ref_To_Local'>denom</span></a> <span class='Operator'>-= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="sampling.c.html#LN168"><span class='Ref_To_Local'>W</span></a> <span class='Operator'>= </span>exp<span class='Parentheses'>(</span><span class='Operator'>-</span>log<span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Generate W in advance */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>exp<span class='Parentheses'>(</span>log<span class='Parentheses'>(</span><a href="sampling.c.html#LN180"><span class='Ref_To_Local'>y</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a> <span class='Operator'>+ </span><a href="sampling.c.html#LN177"><span class='Ref_To_Local'>X</span></a><span class='Parentheses'>)</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>t</span></a><span class='Parentheses'>)</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
        <a href="sampling.c.html#LN141"><span class='Ref_to_Parameter'>rs</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/sampling.h.html#LN48"><span class='Ref_to_Member'>W</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN168"><span class='Ref_To_Local'>W</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Control'>return</span> <a href="sampling.c.html#LN143"><span class='Ref_To_Local'>S</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end reservoir_get_next_S &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/*---------- 
 * Random number generator used by sampling 
 *---------- 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN228"></a><span class='Declare_Function'>sampler_random_init_state</span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Declare_Parameter'>seed</span><span class='Delimiter'>, </span><a href="../../../include/utils/sampling.h.html#LN19"><span class='Ref_to_Typedef'>SamplerRandomState</span></a> <span class='Declare_Parameter'>randstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="sampling.c.html#LN228"><span class='Ref_to_Parameter'>randstate</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0x330e</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* same as pg_erand48, but could be anything */ 
</span>    <a href="sampling.c.html#LN228"><span class='Ref_to_Parameter'>randstate</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) </span><a href="sampling.c.html#LN228"><span class='Ref_to_Parameter'>seed</span></a><span class='Delimiter'>; 
</span>    <a href="sampling.c.html#LN228"><span class='Ref_to_Parameter'>randstate</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned short</span><span class='Parentheses'>) (</span><a href="sampling.c.html#LN228"><span class='Ref_to_Parameter'>seed</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>16</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* Select a random value R uniformly distributed in (0 - 1) */ 
</span><span class='Keyword'>double 
</span><a name="LN237"></a><span class='Declare_Function'>sampler_random_fract</span><span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN19"><span class='Ref_to_Typedef'>SamplerRandomState</span></a> <span class='Declare_Parameter'>randstate</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN239"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* pg_erand48 returns a value in [0.0 - 1.0), so we must reject 0 */ 
</span>    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span>        <a href="sampling.c.html#LN239"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../../port/erand48.c.html#LN77"><span class='Ref_to_Func'>pg_erand48</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN237"><span class='Ref_to_Parameter'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN239"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sampling.c.html#LN239"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Backwards-compatible API for block sampling 
 * 
 * This code is now deprecated, but since it's still in use by many FDWs, 
 * we should keep it for awhile at least.  The functionality is the same as 
 * sampler_random_fract/reservoir_init_selection_state/reservoir_get_next_S, 
 * except that a common random state is used across all callers. 
 */ 
</span><a name="LN258"></a><span class='Keyword'>static </span><a href="../../../include/utils/sampling.h.html#LN46"><span class='Ref_to_Typedef'>ReservoirStateData</span></a> <span class='Declare_Var'>oldrs</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>double 
</span><a name="LN261"></a><span class='Declare_Function'>anl_random_fract</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* initialize if first time through */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/sampling.h.html#LN21"><span class='Ref_to_Proto'>sampler_random_init_state</span></a><span class='Parentheses'>(</span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and compute a random fraction */ 
</span>    <span class='Control'>return</span> <a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>double 
</span><a name="LN272"></a><span class='Declare_Function'>anl_init_selection_state</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* initialize if first time through */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/sampling.h.html#LN21"><span class='Ref_to_Proto'>sampler_random_init_state</span></a><span class='Parentheses'>(</span><a href="../../../port/random.c.html#LN20"><span class='Ref_to_Func'>random</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initial value of W (for use when Algorithm Z is first applied) */ 
</span>    <span class='Control'>return</span> exp<span class='Parentheses'>(</span><span class='Operator'>-</span>log<span class='Parentheses'>(</span><a href="../../../include/utils/sampling.h.html#LN23"><span class='Ref_to_Proto'>sampler_random_fract</span></a><span class='Parentheses'>(</span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN49"><span class='Ref_to_Member'>randstate</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ </span><a href="sampling.c.html#LN272"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>double 
</span><a name="LN283"></a><span class='Declare_Function'>anl_get_next_S</span><span class='Parentheses'>(</span><span class='Keyword'>double </span><span class='Declare_Parameter'>t</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>n</span><span class='Delimiter'>, </span><span class='Keyword'>double </span><span class='Operator'>*</span><span class='Declare_Parameter'>stateptr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN285"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN48"><span class='Ref_to_Member'>W</span></a> <span class='Operator'>= *</span><a href="sampling.c.html#LN283"><span class='Ref_to_Parameter'>stateptr</span></a><span class='Delimiter'>; 
</span>    <a href="sampling.c.html#LN285"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/sampling.h.html#LN55"><span class='Ref_to_Proto'>reservoir_get_next_S</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Delimiter'>, </span><a href="sampling.c.html#LN283"><span class='Ref_to_Parameter'>t</span></a><span class='Delimiter'>, </span><a href="sampling.c.html#LN283"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="sampling.c.html#LN283"><span class='Ref_to_Parameter'>stateptr</span></a> <span class='Operator'>= </span><a href="sampling.c.html#LN258"><span class='Ref_to_Global_Var'>oldrs</span></a><span class='Operator'>.</span><a href="../../../include/utils/sampling.h.html#LN48"><span class='Ref_to_Member'>W</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="sampling.c.html#LN285"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>