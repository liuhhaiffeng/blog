<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\mmgr\aset.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\mmgr\aset.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * aset.c 
 *    Allocation set definitions. 
 * 
 * AllocSet is our standard implementation of the abstract MemoryContext 
 * type. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/mmgr/aset.c 
 * 
 * NOTE: 
 *  This is a new (Feb. 05, 1999) implementation of the allocation set 
 *  routines. AllocSet...() does not use OrderedSet...() any more. 
 *  Instead it manages allocations in a block pool by itself, combining 
 *  many small allocations in a few bigger blocks. AllocSetFree() normally 
 *  doesn't free() memory really. It just add's the free'd area to some 
 *  list for later reuse by AllocSetAlloc(). All memory blocks are free()'d 
 *  at once on AllocSetReset(), which happens when the memory context gets 
 *  destroyed. 
 *              Jan Wieck 
 * 
 *  Performance improvement from Tom Lane, 8/99: for extremely large request 
 *  sizes, we do want to be able to give the memory back to free() as soon 
 *  as it is pfree()'d.  Otherwise we risk tying up a lot of memory in 
 *  freelist entries that might never be usable.  This is specially needed 
 *  when the caller is repeatedly repalloc()'ing a block bigger and bigger; 
 *  the previous instances of the block were guaranteed to be wasted until 
 *  AllocSetReset() under the old way. 
 * 
 *  Further improvement 12/00: as the code stood, request sizes in the 
 *  midrange between "small" and "large" were handled very inefficiently, 
 *  because any sufficiently large free chunk would be used to satisfy a 
 *  request, even if it was much larger than necessary.  This led to more 
 *  and more wasted space in allocated chunks over time.  To fix, get rid 
 *  of the midrange behavior: we now handle only "small" power-of-2-size 
 *  chunks as chunks.  Anything "large" is passed off to malloc().  Change 
 *  the number of freelists to change the small/large boundary. 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/memdebug.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
<span class='Comment_Multi_Line'>/* Define this to detail debug alloc information */ 
/* #define HAVE_ALLOCINFO */ 
</span> 
<span class='Comment_Multi_Line'>/*-------------------- 
 * Chunk freelist k holds chunks of size 1 &LT;&LT; (k + ALLOC_MINBITS), 
 * for k = 0 .. ALLOCSET_NUM_FREELISTS-1. 
 * 
 * Note that all chunks in the freelists have power-of-2 sizes.  This 
 * improves recyclability: we may waste some space, but the wasted space 
 * should stay pretty constant as requests are made and released. 
 * 
 * A request too large for the last freelist is handled by allocating a 
 * dedicated block from malloc().  The block still has a block header and 
 * chunk header, but when the chunk is freed we'll return the whole block 
 * to malloc(), not put it on our freelists. 
 * 
 * CAUTION: ALLOC_MINBITS must be large enough so that 
 * 1&LT;&LT;ALLOC_MINBITS is at least MAXALIGN, 
 * or we may fail to align the smallest chunks adequately. 
 * 8-byte alignment is enough on all currently known machines. 
 * 
 * With the current parameters, request sizes up to 8K are treated as chunks, 
 * larger requests go into dedicated blocks.  Change ALLOCSET_NUM_FREELISTS 
 * to adjust the boundary point; and adjust ALLOCSET_SEPARATE_THRESHOLD in 
 * memutils.h to agree.  (Note: in contexts with small maxBlockSize, we may 
 * set the allocChunkLimit to less than 8K, so as to avoid space wastage.) 
 *-------------------- 
 */ 
</span> 
<a name="LN80"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOC_MINBITS</span>       <span class='Number'>3</span>   <span class='Comment_Single_Line'>/* smallest chunk size is 8 bytes */ 
</span><a name="LN81"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOCSET_NUM_FREELISTS</span>  <span class='Number'>11</span> 
<a name="LN82"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOC_CHUNK_LIMIT</span>   <span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="aset.c.html#LN81"><span class='Ref_to_Const'>ALLOCSET_NUM_FREELISTS</span></a><span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>+</span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>))</span> 
<span class='Comment_Multi_Line'>/* Size of largest chunk that we use a fixed size for */ 
</span><a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOC_CHUNK_FRACTION</span>    <span class='Number'>4</span> 
<span class='Comment_Multi_Line'>/* We allow chunks to be at most 1/4 of maxBlockSize (less overhead) */ 
</span> 
<span class='Comment_Multi_Line'>/*-------------------- 
 * The first block allocated for an allocset has size initBlockSize. 
 * Each time we have to allocate another block, we double the block size 
 * (if possible, and without exceeding maxBlockSize), so as to reduce 
 * the bookkeeping load on malloc(). 
 * 
 * Blocks allocated to hold oversize chunks do not follow this rule, however; 
 * they are just however big they need to be to hold that single chunk. 
 *-------------------- 
 */ 
</span> 
<a name="LN98"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOC_BLOCKHDRSZ</span>    <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN147"><span class='Ref_to_Struct'>AllocBlockData</span></a><span class='Parentheses'>))</span> 
<a name="LN99"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>ALLOC_CHUNKHDRSZ</span>    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Control'>struct</span> <a href="aset.c.html#LN160"><span class='Ref_to_Struct'>AllocChunkData</span></a><span class='Parentheses'>) 
</span> 
<a name="LN101"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <a href="aset.c.html#LN147"><span class='Ref_to_Struct'>AllocBlockData</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>AllocBlock</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* forward reference */ 
</span><a name="LN102"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <a href="aset.c.html#LN160"><span class='Ref_to_Struct'>AllocChunkData</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>AllocChunk</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocPointer 
 *      Aligned pointer which may be a member of an allocation set. 
 */ 
</span><a name="LN108"></a><span class='Control'>typedef</span> <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Typedef'>AllocPointer</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocSetContext is our standard implementation of MemoryContext. 
 * 
 * Note: header.isReset means there is nothing for AllocSetReset to do. 
 * This is different from the aset being physically empty (empty blocks list) 
 * because we may still have a keeper block.  It's also different from the set 
 * being logically empty, because we don't attempt to detect pfree'ing the 
 * last active chunk. 
 */ 
</span><a name="LN119"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>AllocSetContext</span> 
<span class='Delimiter'>{ 
</span><a name="LN121"></a>    <a href="../../../include/nodes/memnodes.h.html#LN72"><span class='Ref_to_Struct'>MemoryContextData</span></a> <span class='Declare_Member'>header</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Standard memory-context fields */ 
</span>    <span class='Comment_Multi_Line'>/* Info about storage allocated in this context: */ 
</span><a name="LN123"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Member'>blocks</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* head of list of blocks in this set */ 
</span><a name="LN124"></a>    <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Member'>freelist</span><span class='Delimiter'>[</span><a href="aset.c.html#LN81"><span class='Ref_to_Const'>ALLOCSET_NUM_FREELISTS</span></a><span class='Delimiter'>];</span>       <span class='Comment_Single_Line'>/* free chunk lists */ 
</span>    <span class='Comment_Multi_Line'>/* Allocation parameters for this context: */ 
</span><a name="LN126"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>initBlockSize</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* initial block size */ 
</span><a name="LN127"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>maxBlockSize</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* maximum block size */ 
</span><a name="LN128"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>nextBlockSize</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* next block size to allocate */ 
</span><a name="LN129"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>allocChunkLimit</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* effective chunk size limit */ 
</span><a name="LN130"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Member'>keeper</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* if not NULL, keep this block over resets */ 
</span><a name="LN131"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>AllocSetContext</span><span class='Delimiter'>; 
</span> 
<a name="LN133"></a><span class='Control'>typedef</span> <a href="aset.c.html#LN119"><span class='Ref_to_Struct'>AllocSetContext</span></a> <span class='Operator'>*</span><span class='Declare_Typedef'>AllocSet</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocBlock 
 *      An AllocBlock is the unit of memory that is obtained by aset.c 
 *      from malloc().  It contains one or more AllocChunks, which are 
 *      the units requested by palloc() and freed by pfree().  AllocChunks 
 *      cannot be returned to malloc() individually, instead they are put 
 *      on freelists by pfree() and re-used by the next palloc() that has 
 *      a matching request size. 
 * 
 *      AllocBlockData is the header data for a block --- the usable space 
 *      within the block begins at the next alignment boundary. 
 */ 
</span><a name="LN147"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>AllocBlockData</span> 
<span class='Delimiter'>{ 
</span><a name="LN149"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Member'>aset</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* aset that owns this block */ 
</span><a name="LN150"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Member'>prev</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* prev block in aset's blocks list, if any */ 
</span><a name="LN151"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Member'>next</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* next block in aset's blocks list, if any */ 
</span><a name="LN152"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>freeptr</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* start of free space in this block */ 
</span><a name="LN153"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>endptr</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* end of space in this block */ 
</span><a name="LN154"></a><span class='Delimiter'>}</span>   <span class='Declare_Typedef'>AllocBlockData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocChunk 
 *      The prefix of each piece of memory in an AllocBlock 
 */ 
</span><a name="LN160"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>AllocChunkData</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* size is always the size of the usable space in the chunk */ 
</span><a name="LN163"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>size</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <span class='Comment_Multi_Line'>/* when debugging memory usage, also store actual requested size */ 
</span>    <span class='Comment_Multi_Line'>/* this is zero in a free chunk */ 
</span><a name="LN167"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>requested_size</span><span class='Delimiter'>; 
</span><span class='Directive'>#if</span> MAXIMUM_ALIGNOF <span class='Operator'>&GT; </span><span class='Number'>4</span> <span class='Operator'>&& </span>SIZEOF_VOID_P <span class='Operator'>== </span><span class='Number'>4</span> 
<a name="LN169"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>padding</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* MEMORY_CONTEXT_CHECKING */ 
</span> 
    <span class='Comment_Multi_Line'>/* aset is the owning aset if allocated, or the freelist link if free */ 
</span><a name="LN175"></a>    <span class='Keyword'>void</span>       <span class='Operator'>*</span><span class='Declare_Member'>aset</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* there must not be any padding to reach a MAXALIGN boundary here! */ 
</span><a name="LN178"></a><span class='Delimiter'>}</span>   <span class='Declare_Typedef'>AllocChunkData</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocPointerIsValid 
 *      True iff pointer is valid allocation pointer. 
 */ 
</span><a name="LN184"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocPointerIsValid</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>) </span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN184"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocSetIsValid 
 *      True iff set is valid allocation set. 
 */ 
</span><a name="LN190"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocSetIsValid</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>set</span><span class='Parentheses'>) </span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN190"><span class='Ref_to_Parameter'>set</span></a><span class='Parentheses'>) 
</span> 
<a name="LN192"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocPointerGetChunk</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>ptr</span><span class='Parentheses'>)</span>   <span class='Operator'>\ 
</span>                    <span class='Parentheses'>((</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>)(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)(</span><a href="aset.c.html#LN192"><span class='Ref_to_Parameter'>ptr</span></a><span class='Parentheses'>))</span> <span class='Operator'>- </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
<a name="LN194"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocChunkGetPointer</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>chk</span><span class='Parentheses'>)</span>   <span class='Operator'>\ 
</span>                    <span class='Parentheses'>((</span><a href="aset.c.html#LN108"><span class='Ref_to_Typedef'>AllocPointer</span></a><span class='Parentheses'>)(((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>)(</span><a href="aset.c.html#LN194"><span class='Ref_to_Parameter'>chk</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * These functions implement the MemoryContext API for AllocSet contexts. 
 */ 
</span><a name="LN200"></a><span class='Keyword'>static void </span><span class='Operator'>*</span><span class='Declare_Prototype'>AllocSetAlloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN201"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetFree</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN202"></a><span class='Keyword'>static void </span><span class='Operator'>*</span><span class='Declare_Prototype'>AllocSetRealloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN203"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetInit</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN204"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetReset</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN205"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetDelete</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN206"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>AllocSetGetChunkSpace</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN207"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>AllocSetIsEmpty</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN208"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetStats</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>print</span><span class='Delimiter'>, 
</span><a name="LN209"></a>              <a href="../../../include/nodes/memnodes.h.html#LN28"><span class='Ref_to_Struct'>MemoryContextCounters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>totals</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
<a name="LN212"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>AllocSetCheck</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * This is the virtual function table for AllocSet contexts. 
 */ 
</span><a name="LN218"></a><span class='Keyword'>static </span><a href="../../../include/nodes/memnodes.h.html#LN53"><span class='Ref_to_Struct'>MemoryContextMethods</span></a> <span class='Declare_Var'>AllocSetMethods</span> <span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <a href="aset.c.html#LN200"><span class='Ref_to_Proto'>AllocSetAlloc</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN201"><span class='Ref_to_Proto'>AllocSetFree</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN202"><span class='Ref_to_Proto'>AllocSetRealloc</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN203"><span class='Ref_to_Proto'>AllocSetInit</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN204"><span class='Ref_to_Proto'>AllocSetReset</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN205"><span class='Ref_to_Proto'>AllocSetDelete</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN206"><span class='Ref_to_Proto'>AllocSetGetChunkSpace</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN207"><span class='Ref_to_Proto'>AllocSetIsEmpty</span></a><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN208"><span class='Ref_to_Proto'>AllocSetStats</span></a> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <span class='Delimiter'>,</span><a href="aset.c.html#LN212"><span class='Ref_to_Proto'>AllocSetCheck</span></a> 
<span class='Directive'>#endif</span> 
<span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Table for AllocSetFreeIndex 
 */ 
</span><a name="LN236"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>LT16</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Parameter'>n</span></a> 
 
<a name="LN238"></a><span class='Keyword'>static const unsigned char </span><span class='Declare_Var'>LogTable256</span><span class='Delimiter'>[</span><span class='Number'>256</span><span class='Delimiter'>] </span><span class='Operator'>= 
</span><span class='Delimiter'>{ 
</span>    <span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>5</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>7</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>    <a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN236"><span class='Ref_to_Macro'>LT16</span></a><span class='Parentheses'>(</span><span class='Number'>8</span><span class='Parentheses'>) 
</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* ---------- 
 * Debug macros 
 * ---------- 
 */ 
</span><span class='Directive'>#ifdef</span> HAVE_ALLOCINFO 
<a name="LN250"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocFreeInfo</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_cxt</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_chunk</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"AllocFree: %s: %p, %zu\n"</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="aset.c.html#LN250"><span class='Ref_to_Parameter'>_cxt</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>header<span class='Operator'>.</span>name<span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="aset.c.html#LN250"><span class='Ref_to_Parameter'>_chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="aset.c.html#LN250"><span class='Ref_to_Parameter'>_chunk</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>size<span class='Parentheses'>)</span> 
<a name="LN253"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocAllocInfo</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_cxt</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_chunk</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>            <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"AllocAlloc: %s: %p, %zu\n"</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                <span class='Parentheses'>(</span><a href="aset.c.html#LN253"><span class='Ref_to_Parameter'>_cxt</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>header<span class='Operator'>.</span>name<span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="aset.c.html#LN253"><span class='Ref_to_Parameter'>_chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="aset.c.html#LN253"><span class='Ref_to_Parameter'>_chunk</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>size<span class='Parentheses'>)</span> 
<span class='Directive'>#else</span> 
<a name="LN257"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocFreeInfo</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_cxt</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_chunk</span><span class='Parentheses'>) 
</span><a name="LN258"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>AllocAllocInfo</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>_cxt</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>_chunk</span><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* ---------- 
 * AllocSetFreeIndex - 
 * 
 *      Depending on the size of an allocation compute which freechunk 
 *      list of the alloc set it belongs to.  Caller must have verified 
 *      that size &LT;= ALLOC_CHUNK_LIMIT. 
 * ---------- 
 */ 
</span><span class='Keyword'>static inline int 
</span><a name="LN270"></a><span class='Declare_Function'>AllocSetFreeIndex</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN272"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>idx</span><span class='Delimiter'>; 
</span><a name="LN273"></a>    <span class='Keyword'>unsigned int </span><span class='Declare_Local'>t</span><span class='Delimiter'>, 
</span><a name="LN274"></a>                <span class='Declare_Local'>tsize</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN270"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="aset.c.html#LN274"><span class='Ref_To_Local'>tsize</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN270"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>&GT;&GT; </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * At this point we need to obtain log2(tsize)+1, ie, the number of 
         * not-all-zero bits at the right.  We used to do this with a 
         * shift-and-count loop, but this function is enough of a hotspot to 
         * justify micro-optimization effort.  The best approach seems to be 
         * to use a lookup table.  Note that this code assumes that 
         * ALLOCSET_NUM_FREELISTS &LT;= 17, since we only cope with two bytes of 
         * the tsize value. 
         */ 
</span>        <a href="aset.c.html#LN273"><span class='Ref_To_Local'>t</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN274"><span class='Ref_To_Local'>tsize</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>8</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN272"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN273"><span class='Ref_To_Local'>t</span></a> <span class='Operator'>? </span><a href="aset.c.html#LN238"><span class='Ref_to_Global_Var'>LogTable256</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN273"><span class='Ref_To_Local'>t</span></a><span class='Delimiter'>] </span><span class='Operator'>+ </span><span class='Number'>8</span> <span class='Operator'>: </span><a href="aset.c.html#LN238"><span class='Ref_to_Global_Var'>LogTable256</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN274"><span class='Ref_To_Local'>tsize</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="aset.c.html#LN272"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN81"><span class='Ref_to_Const'>ALLOCSET_NUM_FREELISTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="aset.c.html#LN272"><span class='Ref_To_Local'>idx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="aset.c.html#LN272"><span class='Ref_To_Local'>idx</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetFreeIndex &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Public routines 
 */ 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetContextCreate 
 *      Create a new AllocSet context. 
 * 
 * parent: parent context, or NULL if top-level context 
 * name: name of context (for debugging only, need not be unique) 
 * minContextSize: minimum context size 
 * initBlockSize: initial allocation block size 
 * maxBlockSize: maximum allocation block size 
 * 
 * Notes: the name string will be copied into context-lifespan storage. 
 * Most callers should abstract the context size parameters using a macro 
 * such as ALLOCSET_DEFAULT_SIZES. 
 */ 
</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> 
<a name="LN321"></a><span class='Declare_Function'>AllocSetContextCreate</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>parent</span><span class='Delimiter'>, 
</span><a name="LN322"></a>                      <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, 
</span><a name="LN323"></a>                      <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>minContextSize</span><span class='Delimiter'>, 
</span><a name="LN324"></a>                      <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>initBlockSize</span><span class='Delimiter'>, 
</span><a name="LN325"></a>                      <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>maxBlockSize</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN327"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN160"><span class='Ref_to_Struct'>AllocChunkData</span></a><span class='Delimiter'>, </span>aset<span class='Parentheses'>)</span> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a><span class='Parentheses'>)</span> <span class='Operator'>== 
</span>                     <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN160"><span class='Ref_to_Struct'>AllocChunkData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                     <span class='String'>"padding calculation in AllocChunkData is wrong"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * First, validate allocation parameters.  (If we're going to throw an 
     * error, we should do so before the context is created, not after.)  We 
     * somewhat arbitrarily enforce a minimum 1K block size. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a> <span class='Operator'>&LT; </span><span class='Number'>1024</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid initBlockSize for memory context: %zu"</span><span class='Delimiter'>, 
</span>             <a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a> <span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../../include/utils/memutils.h.html#LN45"><span class='Ref_to_Macro'>AllocHugeSizeIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a><span class='Parentheses'>))</span>    <span class='Comment_Single_Line'>/* must be safe to double */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid maxBlockSize for memory context: %zu"</span><span class='Delimiter'>, 
</span>             <a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>         <a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a> <span class='Operator'>&LT;= </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid minContextSize for memory context: %zu"</span><span class='Delimiter'>, 
</span>             <a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Do the type-independent part of context creation */ 
</span>    <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="../../../include/utils/memutils.h.html#LN134"><span class='Ref_to_Proto'>MemoryContextCreate</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/nodes.h.html#LN274"><span class='Ref_to_EnumConst'>T_AllocSetContext</span></a><span class='Delimiter'>, 
</span>                                         <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN119"><span class='Ref_to_Struct'>AllocSetContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <span class='Operator'>&</span><a href="aset.c.html#LN218"><span class='Ref_to_Global_Var'>AllocSetMethods</span></a><span class='Delimiter'>, 
</span>                                         <a href="aset.c.html#LN321"><span class='Ref_to_Parameter'>parent</span></a><span class='Delimiter'>, 
</span>                                         <a href="aset.c.html#LN322"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Save allocation parameters */ 
</span>    <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN126"><span class='Ref_to_Member'>initBlockSize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN127"><span class='Ref_to_Member'>maxBlockSize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN324"><span class='Ref_to_Parameter'>initBlockSize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the allocation chunk size limit for this context.  It can't be 
     * more than ALLOC_CHUNK_LIMIT because of the fixed number of freelists. 
     * If maxBlockSize is small then requests exceeding the maxBlockSize, or 
     * even a significant fraction of it, should be treated as large chunks 
     * too.  For the typical case of maxBlockSize a power of 2, the chunk size 
     * limit will be at most 1/8th maxBlockSize, so that given a stream of 
     * requests that are all the maximum chunk size we will waste at most 
     * 1/8th of the allocated space. 
     * 
     * We have to have allocChunkLimit a power of two, because the requested 
     * and actually-allocated sizes of any chunk must be on the same side of 
     * the limit, else we get confused about whether the chunk is "big". 
     * 
     * Also, allocChunkLimit must not exceed ALLOCSET_SEPARATE_THRESHOLD. 
     */ 
</span>    <a href="../../../include/c.h.html#LN751"><span class='Ref_to_Macro'>StaticAssertStmt</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN82"><span class='Ref_to_Const'>ALLOC_CHUNK_LIMIT</span></a> <span class='Operator'>== </span><a href="../../../include/utils/memutils.h.html#LN191"><span class='Ref_to_Const'>ALLOCSET_SEPARATE_THRESHOLD</span></a><span class='Delimiter'>, 
</span>                     <span class='String'>"ALLOC_CHUNK_LIMIT != ALLOCSET_SEPARATE_THRESHOLD"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN82"><span class='Ref_to_Const'>ALLOC_CHUNK_LIMIT</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT; 
</span>           <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>((</span><a href="aset.c.html#LN325"><span class='Ref_to_Parameter'>maxBlockSize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="aset.c.html#LN84"><span class='Ref_to_Const'>ALLOC_CHUNK_FRACTION</span></a><span class='Parentheses'>))</span> 
        <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Grab always-allocated space, if requested 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN394"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>blksize</span> <span class='Operator'>= </span><a href="aset.c.html#LN323"><span class='Ref_to_Parameter'>minContextSize</span></a><span class='Delimiter'>; 
</span><a name="LN395"></a>        <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN394"><span class='Ref_To_Local'>blksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/memutils.h.html#LN83"><span class='Ref_to_Proto'>MemoryContextStats</span></a><span class='Parentheses'>(</span><a href="mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed while creating memory context \"%s\"."</span><span class='Delimiter'>, 
</span>                               <a href="aset.c.html#LN322"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN394"><span class='Ref_To_Local'>blksize</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Mark block as not to be released at reset time */ 
</span>        <a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark unallocated space NOACCESS; leave the block header alone. */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN395"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Delimiter'>, 
</span>                                   <a href="aset.c.html#LN394"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if minContextSize&GT;0 &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN327"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetContextCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetInit 
 *      Context-type-specific initialization routine. 
 * 
 * This is called by MemoryContextCreate() after setting up the 
 * generic MemoryContext fields and before linking the new context 
 * into the context tree.  We must do whatever is needed to make the 
 * new context minimally valid for deletion.  We must *not* risk 
 * failure --- thus, for example, allocating more memory is not cool. 
 * (AllocSetContextCreate can allocate memory when it gets control 
 * back, however.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN439"></a><span class='Declare_Function'>AllocSetInit</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Since MemoryContextCreate already zeroed the context node, we don't 
     * have to do anything here: it's already OK. 
     */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocSetReset 
 *      Frees all memory which is allocated in the given set. 
 * 
 * Actually, this routine has some discretion about what to do. 
 * It should mark all allocated chunks freed, but it need not necessarily 
 * give back all the resources the set owns.  Our actual implementation is 
 * that we hang onto any "keeper" block specified for the set.  In this way, 
 * we don't thrash malloc() when a context is repeatedly reset after small 
 * allocations, which is typical behavior for per-tuple contexts. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN459"></a><span class='Declare_Function'>AllocSetReset</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN461"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN459"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN462"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN190"><span class='Ref_to_Macro'>AllocSetIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <span class='Comment_Multi_Line'>/* Check for corruption and leaks before freeing */ 
</span>    <a href="aset.c.html#LN212"><span class='Ref_to_Proto'>AllocSetCheck</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN459"><span class='Ref_to_Parameter'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Clear chunk freelists */ 
</span>    <a href="../../../include/c.h.html#LN889"><span class='Ref_to_Macro'>MemSetAligned</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* New blocks list is either empty or just the keeper block */ 
</span>    <a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN481"></a>        <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Reset the block, but don't return it to malloc */ 
</span><a name="LN486"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>datastart</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
            <a href="../../../include/utils/memdebug.h.html#LN37"><span class='Ref_to_Func'>wipe_mem</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN486"><span class='Ref_To_Local'>datastart</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN486"><span class='Ref_To_Local'>datastart</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
            <span class='Comment_Multi_Line'>/* wipe_mem() would have done this */ 
</span>            <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN486"><span class='Ref_To_Local'>datastart</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN486"><span class='Ref_To_Local'>datastart</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN486"><span class='Ref_To_Local'>datastart</span></a><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Normal case, release the block */ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
            <a href="../../../include/utils/memdebug.h.html#LN37"><span class='Ref_to_Func'>wipe_mem</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
            <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="aset.c.html#LN462"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN481"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while block!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Reset block size allocation sequence, too */ 
</span>    <a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN461"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN126"><span class='Ref_to_Member'>initBlockSize</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetReset &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetDelete 
 *      Frees all memory which is allocated in the given set, 
 *      in preparation for deletion of the set. 
 * 
 * Unlike AllocSetReset, this *must* free all resources of the set. 
 * But note we are not responsible for deleting the context node itself. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN522"></a><span class='Declare_Function'>AllocSetDelete</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN524"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN522"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN525"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span> <span class='Operator'>= </span><a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN190"><span class='Ref_to_Macro'>AllocSetIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <span class='Comment_Multi_Line'>/* Check for corruption and leaks before freeing */ 
</span>    <a href="aset.c.html#LN212"><span class='Ref_to_Proto'>AllocSetCheck</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN522"><span class='Ref_to_Parameter'>context</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Make it look empty, just in case... */ 
</span>    <a href="../../../include/c.h.html#LN889"><span class='Ref_to_Macro'>MemSetAligned</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN524"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN541"></a>        <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
        <a href="../../../include/utils/memdebug.h.html#LN37"><span class='Ref_to_Func'>wipe_mem</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN525"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN541"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetDelete &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetAlloc 
 *      Returns pointer to allocated memory of given size or NULL if 
 *      request could not be completed; memory is added to the set. 
 * 
 * No request may exceed: 
 *      MAXALIGN_DOWN(SIZE_MAX) - ALLOC_BLOCKHDRSZ - ALLOC_CHUNKHDRSZ 
 * All callers use a much-lower limit. 
 */ 
</span><span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN561"></a><span class='Declare_Function'>AllocSetAlloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN563"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN564"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN565"></a>    <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span><a name="LN566"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fidx</span><span class='Delimiter'>; 
</span><a name="LN567"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>chunk_size</span><span class='Delimiter'>; 
</span><a name="LN568"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>blksize</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN190"><span class='Ref_to_Macro'>AllocSetIsValid</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If requested size exceeds maximum for chunks, allocate an entire block 
     * for this request. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
        <span class='Comment_Multi_Line'>/* Valgrind: Will be made NOACCESS below. */ 
</span>        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* set mark to catch clobber of "unused" space */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memdebug.h.html#LN49"><span class='Ref_to_Func'>set_sentinel</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> RANDOMIZE_ALLOCATED_MEMORY 
        <span class='Comment_Multi_Line'>/* fill the allocated space with junk */ 
</span>        <a href="memdebug.c.html#LN73"><span class='Ref_to_Func'>randomize_mem</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Stick the new block underneath the active allocation block, if any, 
         * so that we don't lose the use of the space remaining therein. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>                <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="aset.c.html#LN253"><span class='Ref_to_Macro'>AllocAllocInfo</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Chunk's metadata fields remain DEFINED.  The requested allocation 
         * itself can be NOACCESS or UNDEFINED; our caller will soon make it 
         * UNDEFINED.  Make extra space at the end of the chunk, if any, 
         * NOACCESS. 
         */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>, 
</span>                                   <a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if size&GT;set-&GT;allocChunkL... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Request is small enough to be treated as a chunk.  Look in the 
     * corresponding free list to see if there is a free chunk we could reuse. 
     * If one is found, remove it from the free list, make it again a member 
     * of the alloc set and return its data address. 
     */ 
</span>    <a href="aset.c.html#LN566"><span class='Ref_To_Local'>fidx</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN269"><span class='Ref_to_Func'>AllocSetFreeIndex</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN566"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT;= </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN566"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
        <span class='Comment_Multi_Line'>/* Valgrind: Free list requested_size should be DEFINED. */ 
</span>        <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* set mark to catch clobber of "unused" space */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memdebug.h.html#LN49"><span class='Ref_to_Func'>set_sentinel</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> RANDOMIZE_ALLOCATED_MEMORY 
        <span class='Comment_Multi_Line'>/* fill the allocated space with junk */ 
</span>        <a href="memdebug.c.html#LN73"><span class='Ref_to_Func'>randomize_mem</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="aset.c.html#LN253"><span class='Ref_to_Macro'>AllocAllocInfo</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if chunk!=NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Choose the actual chunk size to allocate. 
     */ 
</span>    <a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><a href="aset.c.html#LN566"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>&GT;= </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there is enough room in the active allocation block, we will put the 
     * chunk into that block.  Else must start a new one. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN680"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>availspace</span> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN680"><span class='Ref_To_Local'>availspace</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * The existing active (top) block does not have enough room for 
             * the requested allocation, but it might still have a useful 
             * amount of space in it.  Once we push it down in the block list, 
             * we'll never try to allocate more space from it. So, before we 
             * do that, carve up its free space into chunks that we can put on 
             * the set's freelists. 
             * 
             * Because we can only get here when there's less than 
             * ALLOC_CHUNK_LIMIT left in the block, this loop cannot iterate 
             * more than ALLOCSET_NUM_FREELISTS-1 times. 
             */ 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN680"><span class='Ref_To_Local'>availspace</span></a> <span class='Operator'>&GT;= </span><span class='Parentheses'>((</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span><a name="LN698"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>availchunk</span> <span class='Operator'>= </span><a href="aset.c.html#LN680"><span class='Ref_To_Local'>availspace</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
</span><a name="LN699"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>a_fidx</span> <span class='Operator'>= </span><a href="aset.c.html#LN269"><span class='Ref_to_Func'>AllocSetFreeIndex</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * In most cases, we'll get back the index of the next larger 
                 * freelist than the one we need to put this chunk on.  The 
                 * exception is when availchunk is exactly a power of 2. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a> <span class='Operator'>!= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>)))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) (</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Prepare to initialize the chunk header. */ 
</span>                <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="aset.c.html#LN680"><span class='Ref_To_Local'>availspace</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN698"><span class='Ref_To_Local'>availchunk</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
                <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* mark it free */ 
</span><span class='Directive'>#endif</span> 
                <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a><span class='Delimiter'>]; 
</span>                <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN699"><span class='Ref_To_Local'>a_fidx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while availspace&GT;=((1&LT;&LT;ALLO... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Mark that we need to create a new block */ 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if availspace&LT;(chunk_siz... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (block=set-&GT;blocks)!=... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Time to create a new regular (multi-chunk) block? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN739"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>required_size</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * The first such block has size initBlockSize, and we double the 
         * space in each succeeding block, but not more than maxBlockSize. 
         */ 
</span>        <a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN127"><span class='Ref_to_Member'>maxBlockSize</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN128"><span class='Ref_to_Member'>nextBlockSize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN127"><span class='Ref_to_Member'>maxBlockSize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If initBlockSize is less than ALLOC_CHUNK_LIMIT, we could need more 
         * space... but try to keep it a power of 2. 
         */ 
</span>        <a href="aset.c.html#LN739"><span class='Ref_To_Local'>required_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN739"><span class='Ref_To_Local'>required_size</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>&LT;&LT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Try to allocate it */ 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We could be asking for pretty big blocks here, so cope if malloc 
         * fails.  But give up if there's less than a meg or so available... 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>&GT; </span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>&GT;&GT;= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN739"><span class='Ref_To_Local'>required_size</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN49"><span class='Ref_to_Macro'>malloc</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is the first block of the set, make it the "keeper" block. 
         * Formerly, a keeper block could only be created during context 
         * creation, but allowing it to happen here lets us have fast reset 
         * cycling even for contexts created with minContextSize = 0; that way 
         * we don't have to force space to be allocated in contexts that might 
         * never need any space.  Don't mark an oversize block as a keeper, 
         * however. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>== </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN126"><span class='Ref_to_Member'>initBlockSize</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Mark unallocated space NOACCESS. */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Delimiter'>, 
</span>                                   <a href="aset.c.html#LN568"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if block==NULL &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * OK, do the allocation 
     */ 
</span>    <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) (</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Prepare to initialize the chunk header. */ 
</span>    <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>+= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>&LT;= </span><a href="aset.c.html#LN564"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>; 
</span>    <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN567"><span class='Ref_To_Local'>chunk_size</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* set mark to catch clobber of "unused" space */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memdebug.h.html#LN49"><span class='Ref_to_Func'>set_sentinel</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> RANDOMIZE_ALLOCATED_MEMORY 
    <span class='Comment_Multi_Line'>/* fill the allocated space with junk */ 
</span>    <a href="memdebug.c.html#LN73"><span class='Ref_to_Func'>randomize_mem</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="aset.c.html#LN561"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="aset.c.html#LN253"><span class='Ref_to_Macro'>AllocAllocInfo</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN563"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN565"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetAlloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetFree 
 *      Frees allocated memory; memory is removed from the set. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN838"></a><span class='Declare_Function'>AllocSetFree</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN840"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN838"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN841"></a>    <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><a href="aset.c.html#LN192"><span class='Ref_to_Macro'>AllocPointerGetChunk</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN838"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="aset.c.html#LN250"><span class='Ref_to_Macro'>AllocFreeInfo</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                              <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Test for someone scribbling on unused space in chunk */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/memdebug.h.html#LN59"><span class='Ref_to_Func'>sentinel_ok</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN838"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"detected write past chunk end in %s %p"</span><span class='Delimiter'>, 
</span>                 <a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN121"><span class='Ref_to_Member'>header</span></a><span class='Operator'>.</span><a href="../../../include/nodes/memnodes.h.html#LN83"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Big chunks are certain to have been allocated as single-chunk 
         * blocks.  Just unlink that block and return it to malloc(). 
         */ 
</span><a name="LN861"></a>        <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Try to verify that we have a sane block pointer: it should 
         * reference the correct aset, and freeptr and endptr should point 
         * just past the chunk. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>!= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ 
</span>            <span class='Parentheses'>(</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find block containing chunk %p"</span><span class='Delimiter'>, </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* OK, remove block from aset's list and free it */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
        <a href="../../../include/utils/memdebug.h.html#LN37"><span class='Ref_to_Func'>wipe_mem</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="../../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN861"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if chunk-&GT;size&GT;set-&GT;allo... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Normal case, put the chunk into appropriate freelist */ 
</span><a name="LN889"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>fidx</span> <span class='Operator'>= </span><a href="aset.c.html#LN269"><span class='Ref_to_Func'>AllocSetFreeIndex</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN889"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>]; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
        <a href="../../../include/utils/memdebug.h.html#LN37"><span class='Ref_to_Func'>wipe_mem</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN838"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
        <span class='Comment_Multi_Line'>/* Reset requested_size to 0 in chunks that are on freelist */ 
</span>        <a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="aset.c.html#LN840"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN889"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="aset.c.html#LN841"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetFree &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetRealloc 
 *      Returns new pointer to allocated memory of given size or NULL if 
 *      request could not be completed; this memory is added to the set. 
 *      Memory associated with given pointer is copied into the new memory, 
 *      and the old memory is freed. 
 * 
 * Without MEMORY_CONTEXT_CHECKING, we don't know the old request size.  This 
 * makes our Valgrind client requests less-precise, hazarding false negatives. 
 * (In principle, we could use VALGRIND_GET_VBITS() to rediscover the old 
 * request size.) 
 */ 
</span><span class='Keyword'>static void </span><span class='Operator'>* 
</span><a name="LN918"></a><span class='Declare_Function'>AllocSetRealloc</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN920"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN921"></a>    <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><a href="aset.c.html#LN192"><span class='Ref_to_Macro'>AllocPointerGetChunk</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN922"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>oldsize</span> <span class='Operator'>= </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
    <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                              <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Test for someone scribbling on unused space in chunk */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/memdebug.h.html#LN59"><span class='Ref_to_Func'>sentinel_ok</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"detected write past chunk end in %s %p"</span><span class='Delimiter'>, 
</span>                 <a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN121"><span class='Ref_to_Member'>header</span></a><span class='Operator'>.</span><a href="../../../include/nodes/memnodes.h.html#LN83"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Chunk sizes are aligned to power of 2 in AllocSetAlloc(). Maybe the 
     * allocated area already is &GT;= the new size.  (In particular, we always 
     * fall out here if the requested size is a decrease.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>&GT;= </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
<a name="LN942"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>oldrequest</span> <span class='Operator'>= </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> RANDOMIZE_ALLOCATED_MEMORY 
        <span class='Comment_Multi_Line'>/* We can only fill the extra space if we know the prior request */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Parentheses'>) 
</span>            <a href="memdebug.c.html#LN73"><span class='Ref_to_Func'>randomize_mem</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Delimiter'>, 
</span>                          <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is an increase, mark any newly-available part UNDEFINED. 
         * Otherwise, mark the obsolete part NOACCESS. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Delimiter'>, 
</span>                                        <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN942"><span class='Ref_To_Local'>oldrequest</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, 
</span>                                       <a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* set mark to catch clobber of "unused" space */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memdebug.h.html#LN49"><span class='Ref_to_Func'>set_sentinel</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !MEMORY_CONTEXT_CHECKING */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't have the information to determine whether we're growing 
         * the old request or shrinking it, so we conservatively mark the 
         * entire new allocation DEFINED. 
         */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>return</span> <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldsize&GT;=size &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The chunk must have been allocated as a single-chunk block.  Use 
         * realloc() to make the containing block bigger with minimum space 
         * wastage. 
         */ 
</span><a name="LN990"></a>        <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN991"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>chksize</span><span class='Delimiter'>; 
</span><a name="LN992"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>blksize</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Try to verify that we have a sane block pointer: it should 
         * reference the correct aset, and freeptr and endptr should point 
         * just past the chunk. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>!= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ 
</span>            <span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not find block containing chunk %p"</span><span class='Delimiter'>, </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do the realloc */ 
</span>        <a href="aset.c.html#LN991"><span class='Ref_To_Local'>chksize</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN992"><span class='Ref_To_Local'>blksize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN991"><span class='Ref_To_Local'>chksize</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a><span class='Parentheses'>) </span><a href="../../../include/snowball/header.h.html#LN59"><span class='Ref_to_Macro'>realloc</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN992"><span class='Ref_To_Local'>blksize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN992"><span class='Ref_To_Local'>blksize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update pointers since block has likely been moved */ 
</span>        <a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) (((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN194"><span class='Ref_to_Macro'>AllocChunkGetPointer</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>            <a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN990"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN991"><span class='Ref_To_Local'>chksize</span></a><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
<span class='Directive'>#ifdef</span> RANDOMIZE_ALLOCATED_MEMORY 
        <span class='Comment_Multi_Line'>/* We can only fill the extra space if we know the prior request */ 
</span>        <a href="memdebug.c.html#LN73"><span class='Ref_to_Func'>randomize_mem</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                      <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * realloc() (or randomize_mem()) will have left the newly-allocated 
         * part UNDEFINED, but we may need to adjust trailing bytes from the 
         * old allocation. 
         */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                    <a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* set mark to catch clobber of "unused" space */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/memdebug.h.html#LN49"><span class='Ref_to_Func'>set_sentinel</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* !MEMORY_CONTEXT_CHECKING */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We don't know how much of the old chunk size was the actual 
         * allocation; it could have been as small as one byte.  We have to be 
         * conservative and just mark the entire old portion DEFINED. 
         */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Make any trailing alignment padding NOACCESS. */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN991"><span class='Ref_To_Local'>chksize</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if oldsize&GT;set-&GT;allocChu... &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Small-chunk case.  We just do this by brute force, ie, allocate a 
         * new chunk and copy the data.  Since we know the existing data isn't 
         * huge, this won't involve any great memcpy expense, so it's not 
         * worth being smarter.  (At one time we tried to avoid memcpy when it 
         * was possible to enlarge the chunk in-place, but that turns out to 
         * misbehave unpleasantly for repeated cycles of 
         * palloc/repalloc/pfree: the eventually freed chunks go into the 
         * wrong freelist for the next initial palloc request, and so we leak 
         * memory indefinitely.  See pgsql-hackers archives for 2007-08-11.) 
         */ 
</span><a name="LN1074"></a>        <a href="aset.c.html#LN108"><span class='Ref_to_Typedef'>AllocPointer</span></a> <span class='Declare_Local'>newPointer</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* allocate new chunk */ 
</span>        <a href="aset.c.html#LN1074"><span class='Ref_To_Local'>newPointer</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN200"><span class='Ref_to_Proto'>AllocSetAlloc</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* leave immediately if request was not completed */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1074"><span class='Ref_To_Local'>newPointer</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * AllocSetAlloc() just made the region NOACCESS.  Change it to 
         * UNDEFINED for the moment; memcpy() will then transfer definedness 
         * from the old allocation to the new.  If we know the old allocation, 
         * copy just that much.  Otherwise, make the entire old chunk defined 
         * to avoid errors as we copy the currently-NOACCESS trailing bytes. 
         */ 
</span>        <a href="../../../include/utils/memdebug.h.html#LN27"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_UNDEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN1074"><span class='Ref_To_Local'>newPointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
        <a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN921"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
        <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* transfer existing data (certain to fit) */ 
</span>        memcpy<span class='Parentheses'>(</span><a href="aset.c.html#LN1074"><span class='Ref_To_Local'>newPointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN922"><span class='Ref_To_Local'>oldsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* free old chunk */ 
</span>        <a href="aset.c.html#LN201"><span class='Ref_to_Proto'>AllocSetFree</span></a><span class='Parentheses'>((</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN920"><span class='Ref_To_Local'>set</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN918"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="aset.c.html#LN1074"><span class='Ref_To_Local'>newPointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AllocSetRealloc &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetGetChunkSpace 
 *      Given a currently-allocated chunk, determine the total space 
 *      it occupies (including all memory-allocation overhead). 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1113"></a><span class='Declare_Function'>AllocSetGetChunkSpace</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>pointer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1115"></a>    <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><a href="aset.c.html#LN192"><span class='Ref_to_Macro'>AllocPointerGetChunk</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN1113"><span class='Ref_to_Parameter'>pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="aset.c.html#LN1115"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocSetIsEmpty 
 *      Is an allocset empty of any allocated space? 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1125"></a><span class='Declare_Function'>AllocSetIsEmpty</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * For now, we say "empty" only if the context is new or just reset. We 
     * could examine the freelists to determine if all space has been freed, 
     * but it's not really worth the trouble for present uses of this 
     * functionality. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1125"><span class='Ref_to_Parameter'>context</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/memnodes.h.html#LN76"><span class='Ref_to_Member'>isReset</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AllocSetStats 
 *      Compute stats about memory consumption of an allocset. 
 * 
 * level: recursion level (0 at top level); used for print indentation. 
 * print: true to print stats to stderr. 
 * totals: if not NULL, add stats about this allocset into *totals. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1147"></a><span class='Declare_Function'>AllocSetStats</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>print</span><span class='Delimiter'>, 
</span><a name="LN1148"></a>              <a href="../../../include/nodes/memnodes.h.html#LN28"><span class='Ref_to_Struct'>MemoryContextCounters</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>totals</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1150"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN1147"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN1151"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nblocks</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1152"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freechunks</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1153"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>totalspace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1154"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freespace</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1155"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN1156"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fidx</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1150"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="aset.c.html#LN1151"><span class='Ref_To_Local'>nblocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN1153"><span class='Ref_To_Local'>totalspace</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>- </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN1154"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN1155"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1156"><span class='Ref_To_Local'>fidx</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="aset.c.html#LN1156"><span class='Ref_To_Local'>fidx</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN81"><span class='Ref_to_Const'>ALLOCSET_NUM_FREELISTS</span></a><span class='Delimiter'>; </span><a href="aset.c.html#LN1156"><span class='Ref_To_Local'>fidx</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1166"></a>        <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1166"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1150"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN124"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="aset.c.html#LN1156"><span class='Ref_To_Local'>fidx</span></a><span class='Delimiter'>]; </span><a href="aset.c.html#LN1166"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>             <a href="aset.c.html#LN1166"><span class='Ref_To_Local'>chunk</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN1166"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="aset.c.html#LN1152"><span class='Ref_To_Local'>freechunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN1154"><span class='Ref_To_Local'>freespace</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1166"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1147"><span class='Ref_to_Parameter'>print</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1178"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1178"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="aset.c.html#LN1178"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN1147"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>; </span><a href="aset.c.html#LN1178"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  "</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>            <span class='String'>"%s: %zu total in %zd blocks; %zu free (%zd chunks); %zu used\n"</span><span class='Delimiter'>, 
</span>                <a href="aset.c.html#LN1150"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN121"><span class='Ref_to_Member'>header</span></a><span class='Operator'>.</span><a href="../../../include/nodes/memnodes.h.html#LN83"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1153"><span class='Ref_To_Local'>totalspace</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1151"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1154"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1152"><span class='Ref_To_Local'>freechunks</span></a><span class='Delimiter'>, 
</span>                <a href="aset.c.html#LN1153"><span class='Ref_To_Local'>totalspace</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN1154"><span class='Ref_To_Local'>freespace</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1148"><span class='Ref_to_Parameter'>totals</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="aset.c.html#LN1148"><span class='Ref_to_Parameter'>totals</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/memnodes.h.html#LN30"><span class='Ref_to_Member'>nblocks</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1151"><span class='Ref_To_Local'>nblocks</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN1148"><span class='Ref_to_Parameter'>totals</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/memnodes.h.html#LN31"><span class='Ref_to_Member'>freechunks</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1152"><span class='Ref_To_Local'>freechunks</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN1148"><span class='Ref_to_Parameter'>totals</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/memnodes.h.html#LN32"><span class='Ref_to_Member'>totalspace</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1153"><span class='Ref_To_Local'>totalspace</span></a><span class='Delimiter'>; 
</span>        <a href="aset.c.html#LN1148"><span class='Ref_to_Parameter'>totals</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/memnodes.h.html#LN33"><span class='Ref_to_Member'>freespace</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1154"><span class='Ref_To_Local'>freespace</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AllocSetStats &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN275"><span class='Ref_to_Const'>MEMORY_CONTEXT_CHECKING</span></a> 
 
<span class='Comment_Multi_Line'>/* 
 * AllocSetCheck 
 *      Walk through chunks and check consistency of memory. 
 * 
 * NOTE: report errors as WARNING, *not* ERROR or FATAL.  Otherwise you'll 
 * find yourself in an infinite loop when trouble occurs, because this 
 * routine will be entered again when elog cleanup tries to release memory! 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1209"></a><span class='Declare_Function'>AllocSetCheck</span><span class='Parentheses'>(</span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Parameter'>context</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1211"></a>    <a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a>    <span class='Declare_Local'>set</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN133"><span class='Ref_to_Typedef'>AllocSet</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN1209"><span class='Ref_to_Parameter'>context</span></a><span class='Delimiter'>; 
</span><a name="LN1212"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>name</span> <span class='Operator'>= </span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN121"><span class='Ref_to_Member'>header</span></a><span class='Operator'>.</span><a href="../../../include/nodes/memnodes.h.html#LN83"><span class='Ref_to_Member'>name</span></a><span class='Delimiter'>; 
</span><a name="LN1213"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>prevblock</span><span class='Delimiter'>; 
</span><a name="LN1214"></a>    <a href="aset.c.html#LN101"><span class='Ref_to_Typedef'>AllocBlock</span></a>  <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1213"><span class='Ref_To_Local'>prevblock</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN123"><span class='Ref_to_Member'>blocks</span></a><span class='Delimiter'>; 
</span>         <a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="aset.c.html#LN1213"><span class='Ref_To_Local'>prevblock</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN151"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1220"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>bpoz</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span> <span class='Operator'>+ </span><a href="aset.c.html#LN98"><span class='Ref_to_Const'>ALLOC_BLOCKHDRSZ</span></a><span class='Delimiter'>; 
</span><a name="LN1221"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>blk_used</span> <span class='Operator'>= </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>- </span><a href="aset.c.html#LN1220"><span class='Ref_To_Local'>bpoz</span></a><span class='Delimiter'>; 
</span><a name="LN1222"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>blk_data</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1223"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>nchunks</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Empty block - empty can be keeper-block only 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="aset.c.html#LN1221"><span class='Ref_To_Local'>blk_used</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN130"><span class='Ref_to_Member'>keeper</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: empty block %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check block header fields 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN149"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN150"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN1213"><span class='Ref_To_Local'>prevblock</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN1220"><span class='Ref_To_Local'>bpoz</span></a> <span class='Operator'>|| 
</span>            <a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN153"><span class='Ref_to_Member'>endptr</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: corrupt header in block %p"</span><span class='Delimiter'>, 
</span>                 <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Chunk walker 
         */ 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1220"><span class='Ref_To_Local'>bpoz</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN152"><span class='Ref_to_Member'>freeptr</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1250"></a>            <a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a>  <span class='Declare_Local'>chunk</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="aset.c.html#LN102"><span class='Ref_to_Typedef'>AllocChunk</span></a><span class='Parentheses'>) </span><a href="aset.c.html#LN1220"><span class='Ref_To_Local'>bpoz</span></a><span class='Delimiter'>; 
</span><a name="LN1251"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>chsize</span><span class='Delimiter'>, 
</span><a name="LN1252"></a>                        <span class='Declare_Local'>dsize</span><span class='Delimiter'>; 
</span> 
            <a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN163"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* aligned chunk size */ 
</span>            <a href="../../../include/utils/memdebug.h.html#LN25"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_DEFINED</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                      <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>= </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* real data */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span>      <span class='Comment_Single_Line'>/* not on a free list */ 
</span>                <a href="../../../include/utils/memdebug.h.html#LN26"><span class='Ref_to_Macro'>VALGRIND_MAKE_MEM_NOACCESS</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Delimiter'>, 
</span>                                           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN167"><span class='Ref_to_Member'>requested_size</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check chunk size 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: req size &GT; alloc size for chunk %p in block %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a> <span class='Operator'>&LT; </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="aset.c.html#LN80"><span class='Ref_to_Const'>ALLOC_MINBITS</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: bad size %zu for chunk %p in block %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* single-chunk block? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a> <span class='Operator'>&GT; </span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN129"><span class='Ref_to_Member'>allocChunkLimit</span></a> <span class='Operator'>&& 
</span>                <a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a> <span class='Operator'>!= </span><a href="aset.c.html#LN1221"><span class='Ref_To_Local'>blk_used</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: bad single-chunk %p in block %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If chunk is allocated, check for correct aset pointer. (If it's 
             * free, the aset is the freelist pointer, which we can't check as 
             * easily...) 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Operator'>-&GT;</span><a href="aset.c.html#LN175"><span class='Ref_to_Member'>aset</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="aset.c.html#LN1211"><span class='Ref_To_Local'>set</span></a><span class='Parentheses'>)</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: bogus aset link in block %p, chunk %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Check for overwrite of "unallocated" space in chunk 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a> <span class='Operator'>&LT; </span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a> <span class='Operator'>&& 
</span>                <span class='Operator'>!</span><a href="../../../include/utils/memdebug.h.html#LN59"><span class='Ref_to_Func'>sentinel_ok</span></a><span class='Parentheses'>(</span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN1252"><span class='Ref_To_Local'>dsize</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: detected write past chunk end in block %p, chunk %p"</span><span class='Delimiter'>, 
</span>                     <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1250"><span class='Ref_To_Local'>chunk</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="aset.c.html#LN1222"><span class='Ref_To_Local'>blk_data</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a><span class='Delimiter'>; 
</span>            <a href="aset.c.html#LN1223"><span class='Ref_To_Local'>nchunks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
            <a href="aset.c.html#LN1220"><span class='Ref_To_Local'>bpoz</span></a> <span class='Operator'>+= </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a> <span class='Operator'>+ </span><a href="aset.c.html#LN1251"><span class='Ref_To_Local'>chsize</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while bpoz&LT;block-&GT;freeptr &raquo; </span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="aset.c.html#LN1222"><span class='Ref_To_Local'>blk_data</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="aset.c.html#LN1223"><span class='Ref_To_Local'>nchunks</span></a> <span class='Operator'>* </span><a href="aset.c.html#LN99"><span class='Ref_to_Const'>ALLOC_CHUNKHDRSZ</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><a href="aset.c.html#LN1221"><span class='Ref_To_Local'>blk_used</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"problem in alloc set %s: found inconsistent memory block %p"</span><span class='Delimiter'>, 
</span>                 <a href="aset.c.html#LN1212"><span class='Ref_To_Local'>name</span></a><span class='Delimiter'>, </span><a href="aset.c.html#LN1214"><span class='Ref_To_Local'>block</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for prevblock=NULL,block=... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AllocSetCheck &raquo; </span> 
 
<span class='Directive'>#endif</span>   <span class='Comment_Single_Line'>/* MEMORY_CONTEXT_CHECKING */ 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>