<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\mmgr\dsa.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\mmgr\dsa.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * dsa.c 
 *    Dynamic shared memory areas. 
 * 
 * This module provides dynamic shared memory areas which are built on top of 
 * DSM segments.  While dsm.c allows segments of memory of shared memory to be 
 * created and shared between backends, it isn't designed to deal with small 
 * objects.  A DSA area is a shared memory heap usually backed by one or more 
 * DSM segments which can allocate memory using dsa_allocate() and dsa_free(). 
 * Alternatively, it can be created in pre-existing shared memory, including a 
 * DSM segment, and then create extra DSM segments as required.  Unlike the 
 * regular system heap, it deals in pseudo-pointers which must be converted to 
 * backend-local pointers before they are dereferenced.  These pseudo-pointers 
 * can however be shared with other backends, and can be used to construct 
 * shared data structures. 
 * 
 * Each DSA area manages a set of DSM segments, adding new segments as 
 * required and detaching them when they are no longer needed.  Each segment 
 * contains a number of 4KB pages, a free page manager for tracking 
 * consecutive runs of free pages, and a page map for tracking the source of 
 * objects allocated on each page.  Allocation requests above 8KB are handled 
 * by choosing a segment and finding consecutive free pages in its free page 
 * manager.  Allocation requests for smaller sizes are handled using pools of 
 * objects of a selection of sizes.  Each pool consists of a number of 16 page 
 * (64KB) superblocks allocated in the same way as large objects.  Allocation 
 * of large objects and new superblocks is serialized by a single LWLock, but 
 * allocation of small objects from pre-existing superblocks uses one LWLock 
 * per pool.  Currently there is one pool, and therefore one lock, per size 
 * class.  Per-core pools to increase concurrency and strategies for reducing 
 * the resulting fragmentation are areas for future research.  Each superblock 
 * is managed with a 'span', which tracks the superblock's freelist.  Free 
 * requests are handled by looking in the page map to find which span an 
 * address was allocated from, so that small objects can be returned to the 
 * appropriate free list, and large object pages can be returned directly to 
 * the free page map.  When allocating, simple heuristics for selecting 
 * segments and superblocks try to encourage occupied memory to be 
 * concentrated, increasing the likelihood that whole superblocks can become 
 * empty and be returned to the free page manager, and whole segments can 
 * become empty and be returned to the operating system. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/mmgr/dsa.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"port/atomics.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/dsm.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/ipc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/lwlock.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/shmem.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/dsa.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/freepage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The size of the initial DSM segment that backs a dsa_area created by 
 * dsa_create.  After creating some number of segments of this size we'll 
 * double this size, and so on.  Larger segments may be created if necessary 
 * to satisfy large requests. 
 */ 
</span><a name="LN67"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_INITIAL_SEGMENT_SIZE</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) (</span><span class='Number'>1</span> <span class='Operator'>* </span><span class='Number'>1024</span> <span class='Operator'>* </span><span class='Number'>1024</span><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * How many segments to create before we double the segment size.  If this is 
 * low, then there is likely to be a lot of wasted space in the largest 
 * segment.  If it is high, then we risk running out of segment slots (see 
 * dsm.c's limits on total number of segments), or limiting the total size 
 * an area can manage when using small pointers. 
 */ 
</span><a name="LN76"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_NUM_SEGMENTS_AT_EACH_SIZE</span> <span class='Number'>4</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The number of bits used to represent the offset part of a dsa_pointer. 
 * This controls the maximum size of a segment, the maximum possible 
 * allocation size and also the maximum number of segments per area. 
 */ 
</span><span class='Directive'>#if</span> <a href="../../../include/utils/dsa.h.html#LN39"><span class='Ref_to_Const'>SIZEOF_DSA_POINTER</span></a> <span class='Operator'>== </span><span class='Number'>4</span> 
<a name="LN84"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_OFFSET_WIDTH</span> <span class='Number'>27</span>     <span class='Comment_Single_Line'>/* 32 segments of size up to 128MB */ 
</span><span class='Directive'>#else</span> 
<a name="LN86"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_OFFSET_WIDTH</span> <span class='Number'>40</span>     <span class='Comment_Single_Line'>/* 1024 segments of size up to 1TB */ 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The maximum number of DSM segments that an area can own, determined by 
 * the number of bits remaining (but capped at 1024). 
 */ 
</span><a name="LN93"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_MAX_SEGMENTS</span> <span class='Operator'>\ 
</span>    <a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><span class='Number'>1024</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>((</span><a href="../../../include/utils/dsa.h.html#LN39"><span class='Ref_to_Const'>SIZEOF_DSA_POINTER</span></a> <span class='Operator'>* </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="dsa.c.html#LN84"><span class='Ref_to_Const'>DSA_OFFSET_WIDTH</span></a><span class='Parentheses'>)))</span> 
 
<span class='Comment_Multi_Line'>/* The bitmask for extracting the offset from a dsa_pointer. */ 
</span><a name="LN97"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_OFFSET_BITMASK</span> <span class='Parentheses'>(((</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="dsa.c.html#LN84"><span class='Ref_to_Const'>DSA_OFFSET_WIDTH</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* The maximum size of a DSM segment. */ 
</span><a name="LN100"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_MAX_SEGMENT_SIZE</span> <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><a href="dsa.c.html#LN84"><span class='Ref_to_Const'>DSA_OFFSET_WIDTH</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Number of pages (see FPM_PAGE_SIZE) per regular superblock. */ 
</span><a name="LN103"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_PAGES_PER_SUPERBLOCK</span>        <span class='Number'>16</span> 
 
<span class='Comment_Multi_Line'>/* 
 * A magic number used as a sanity check for following DSM segments belonging 
 * to a DSA area (this number will be XORed with the area handle and 
 * the segment index). 
 */ 
</span><a name="LN110"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SEGMENT_HEADER_MAGIC</span> <span class='Number'>0x0ce26608</span> 
 
<span class='Comment_Multi_Line'>/* Build a dsa_pointer given a segment number and offset. */ 
</span><a name="LN113"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DSA_MAKE_POINTER</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>segment_number</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(((</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>) (</span><a href="dsa.c.html#LN113"><span class='Ref_to_Parameter'>segment_number</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;&LT; </span><a href="dsa.c.html#LN84"><span class='Ref_to_Const'>DSA_OFFSET_WIDTH</span></a><span class='Parentheses'>)</span> <span class='Operator'>| </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN113"><span class='Ref_to_Parameter'>offset</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* Extract the segment number from a dsa_pointer. */ 
</span><a name="LN117"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DSA_EXTRACT_SEGMENT_NUMBER</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>dp</span><span class='Parentheses'>) ((</span><a href="dsa.c.html#LN117"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;&GT; </span><a href="dsa.c.html#LN84"><span class='Ref_to_Const'>DSA_OFFSET_WIDTH</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Extract the offset from a dsa_pointer. */ 
</span><a name="LN120"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DSA_EXTRACT_OFFSET</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>dp</span><span class='Parentheses'>) ((</span><a href="dsa.c.html#LN120"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>) </span><span class='Operator'>& </span><a href="dsa.c.html#LN97"><span class='Ref_to_Const'>DSA_OFFSET_BITMASK</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* The type used for index segment indexes (zero based). */ 
</span><a name="LN123"></a><span class='Control'>typedef</span> <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Typedef'>dsa_segment_index</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Sentinel value for dsa_segment_index indicating 'none' or 'end'. */ 
</span><a name="LN126"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SEGMENT_INDEX_NONE</span> <span class='Parentheses'>(</span><span class='Operator'>~</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a><span class='Parentheses'>)</span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * How many bins of segments do we have?  The bins are used to categorize 
 * segments by their largest contiguous run of free pages. 
 */ 
</span><a name="LN132"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_NUM_SEGMENT_BINS</span> <span class='Number'>16</span> 
 
<span class='Comment_Multi_Line'>/* 
 * What is the lowest bin that holds segments that *might* have n contiguous 
 * free pages?  There is no point in looking in segments in lower bins; they 
 * definitely can't service a request for n free pages. 
 */ 
</span><a name="LN139"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>contiguous_pages_to_segment_bin</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>n</span><span class='Parentheses'>) </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="../../../port/fls.c.html#LN53"><span class='Ref_to_Func'>fls</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN139"><span class='Ref_to_Parameter'>n</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN132"><span class='Ref_to_Const'>DSA_NUM_SEGMENT_BINS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Macros for access to locks. */ 
</span><a name="LN142"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DSA_AREA_LOCK</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="dsa.c.html#LN142"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span>control<span class='Operator'>-&GT;</span>lock<span class='Parentheses'>) 
</span><a name="LN143"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DSA_SCLASS_LOCK</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>sclass</span><span class='Parentheses'>) (</span><span class='Operator'>&</span><a href="dsa.c.html#LN143"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span>control<span class='Operator'>-&GT;</span>pools<span class='Delimiter'>[</span><a href="dsa.c.html#LN143"><span class='Ref_to_Parameter'>sclass</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>lock<span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The header for an individual segment.  This lives at the start of each DSM 
 * segment owned by a DSA area including the first segment (where it appears 
 * as part of the dsa_area_control struct). 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Sanity check magic value. */ 
</span><a name="LN153"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>magic</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Total number of pages in this segment (excluding metadata area). */ 
</span><a name="LN155"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>usable_pages</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Total size of this segment in bytes. */ 
</span><a name="LN157"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Index of the segment that precedes this one in the same segment bin, or 
     * DSA_SEGMENT_INDEX_NONE if this is the first one. 
     */ 
</span><a name="LN163"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Member'>prev</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Index of the segment that follows this one in the same segment bin, or 
     * DSA_SEGMENT_INDEX_NONE if this is the last one. 
     */ 
</span><a name="LN169"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The index of the bin that contains this segment. */ 
</span><a name="LN171"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>bin</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * A flag raised to indicate that this segment is being returned to the 
     * operating system and has been unpinned. 
     */ 
</span><a name="LN177"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>freed</span><span class='Delimiter'>; 
</span><a name="LN178"></a>}<span class='Auto_Annotations'> &laquo; end {anondsa_segment_header} &raquo; </span> <span class='Declare_Typedef'>dsa_segment_header</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Metadata for one superblock. 
 * 
 * For most blocks, span objects are stored out-of-line; that is, the span 
 * object is not stored within the block itself.  But, as an exception, for a 
 * "span of spans", the span object is stored "inline".  The allocation is 
 * always exactly one page, and the dsa_area_span object is located at 
 * the beginning of that page.  The size class is DSA_SCLASS_BLOCK_OF_SPANS, 
 * and the remaining fields are used just as they would be in an ordinary 
 * block.  We can't allocate spans out of ordinary superblocks because 
 * creating an ordinary superblock requires us to be able to allocate a span 
 * *first*.  Doing it this way avoids that circularity. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN195"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>pool</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Containing pool. */ 
</span><a name="LN196"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>prevspan</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Previous span. */ 
</span><a name="LN197"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>nextspan</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Next span. */ 
</span><a name="LN198"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>start</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* Starting address. */ 
</span><a name="LN199"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>npages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Length of span in pages. */ 
</span><a name="LN200"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>size_class</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* Size class. */ 
</span><a name="LN201"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>ninitialized</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Maximum number of objects ever allocated. */ 
</span><a name="LN202"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>nallocatable</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* Number of objects currently allocatable. */ 
</span><a name="LN203"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>firstfree</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* First object on free list. */ 
</span><a name="LN204"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>nmax</span><span class='Delimiter'>;</span>           <span class='Comment_Single_Line'>/* Maximum number of objects ever possible. */ 
</span><a name="LN205"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Member'>fclass</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* Current fullness class. */ 
</span><a name="LN206"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>dsa_area_span</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Given a pointer to an object in a span, access the index of the next free 
 * object in the same span (ie in the span's freelist) as an L-value. 
 */ 
</span><a name="LN212"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>NextFreeObjectIndex</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>object</span><span class='Parentheses'>) (</span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="dsa.c.html#LN212"><span class='Ref_to_Parameter'>object</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Small allocations are handled by dividing a single block of memory into 
 * many small objects of equal size.  The possible allocation sizes are 
 * defined by the following array.  Larger size classes are spaced more widely 
 * than smaller size classes.  We fudge the spacing for size classes &GT;1kB to 
 * avoid space wastage: based on the knowledge that we plan to allocate 64kB 
 * blocks, we bump the maximum object size up to the largest multiple of 
 * 8 bytes that still lets us fit the same number of objects into one block. 
 * 
 * NB: Because of this fudging, if we were ever to use differently-sized blocks 
 * for small allocations, these size classes would need to be reworked to be 
 * optimal for the new size. 
 * 
 * NB: The optimal spacing for size classes, as well as the size of the blocks 
 * out of which small objects are allocated, is not a question that has one 
 * right answer.  Some allocators (such as tcmalloc) use more closely-spaced 
 * size classes than we do here, while others (like aset.c) use more 
 * widely-spaced classes.  Spacing the classes more closely avoids wasting 
 * memory within individual chunks, but also means a larger number of 
 * potentially-unfilled blocks. 
 */ 
</span><a name="LN235"></a><span class='Keyword'>static const </span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Var'>dsa_size_classes</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>,</span>   <span class='Comment_Single_Line'>/* special size classes */ 
</span>    <span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>32</span><span class='Delimiter'>, </span><span class='Number'>40</span><span class='Delimiter'>, </span><span class='Number'>48</span><span class='Delimiter'>, </span><span class='Number'>56</span><span class='Delimiter'>, </span><span class='Number'>64</span><span class='Delimiter'>,</span>      <span class='Comment_Single_Line'>/* 8 classes separated by 8 bytes */ 
</span>    <span class='Number'>80</span><span class='Delimiter'>, </span><span class='Number'>96</span><span class='Delimiter'>, </span><span class='Number'>112</span><span class='Delimiter'>, </span><span class='Number'>128</span><span class='Delimiter'>,</span>           <span class='Comment_Single_Line'>/* 4 classes separated by 16 bytes */ 
</span>    <span class='Number'>160</span><span class='Delimiter'>, </span><span class='Number'>192</span><span class='Delimiter'>, </span><span class='Number'>224</span><span class='Delimiter'>, </span><span class='Number'>256</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* 4 classes separated by 32 bytes */ 
</span>    <span class='Number'>320</span><span class='Delimiter'>, </span><span class='Number'>384</span><span class='Delimiter'>, </span><span class='Number'>448</span><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Delimiter'>,</span>         <span class='Comment_Single_Line'>/* 4 classes separated by 64 bytes */ 
</span>    <span class='Number'>640</span><span class='Delimiter'>, </span><span class='Number'>768</span><span class='Delimiter'>, </span><span class='Number'>896</span><span class='Delimiter'>, </span><span class='Number'>1024</span><span class='Delimiter'>,</span>        <span class='Comment_Single_Line'>/* 4 classes separated by 128 bytes */ 
</span>    <span class='Number'>1280</span><span class='Delimiter'>, </span><span class='Number'>1560</span><span class='Delimiter'>, </span><span class='Number'>1816</span><span class='Delimiter'>, </span><span class='Number'>2048</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* 4 classes separated by ~256 bytes */ 
</span>    <span class='Number'>2616</span><span class='Delimiter'>, </span><span class='Number'>3120</span><span class='Delimiter'>, </span><span class='Number'>3640</span><span class='Delimiter'>, </span><span class='Number'>4096</span><span class='Delimiter'>,</span>     <span class='Comment_Single_Line'>/* 4 classes separated by ~512 bytes */ 
</span>    <span class='Number'>5456</span><span class='Delimiter'>, </span><span class='Number'>6552</span><span class='Delimiter'>, </span><span class='Number'>7280</span><span class='Delimiter'>, </span><span class='Number'>8192</span>      <span class='Comment_Single_Line'>/* 4 classes separated by ~1024 bytes */ 
</span><span class='Delimiter'>}; 
</span><a name="LN246"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_NUM_SIZE_CLASSES</span>                <a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Special size classes. */ 
</span><a name="LN249"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SCLASS_BLOCK_OF_SPANS</span>       <span class='Number'>0</span> 
<a name="LN250"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SCLASS_SPAN_LARGE</span>           <span class='Number'>1</span> 
 
<span class='Comment_Multi_Line'>/* 
 * The following lookup table is used to map the size of small objects 
 * (less than 1kB) onto the corresponding size class.  To use this table, 
 * round the size of the object up to the next multiple of 8 bytes, and then 
 * index into this array. 
 */ 
</span><a name="LN258"></a><span class='Keyword'>static char </span><span class='Declare_Var'>dsa_size_class_map</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>    <span class='Number'>2</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='Number'>6</span><span class='Delimiter'>, </span><span class='Number'>7</span><span class='Delimiter'>, </span><span class='Number'>8</span><span class='Delimiter'>, </span><span class='Number'>9</span><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Delimiter'>, </span><span class='Number'>10</span><span class='Delimiter'>, </span><span class='Number'>11</span><span class='Delimiter'>, </span><span class='Number'>11</span><span class='Delimiter'>, </span><span class='Number'>12</span><span class='Delimiter'>, </span><span class='Number'>12</span><span class='Delimiter'>, </span><span class='Number'>13</span><span class='Delimiter'>, </span><span class='Number'>13</span><span class='Delimiter'>, 
</span>    <span class='Number'>14</span><span class='Delimiter'>, </span><span class='Number'>14</span><span class='Delimiter'>, </span><span class='Number'>14</span><span class='Delimiter'>, </span><span class='Number'>14</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Delimiter'>, </span><span class='Number'>15</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>16</span><span class='Delimiter'>, </span><span class='Number'>17</span><span class='Delimiter'>, </span><span class='Number'>17</span><span class='Delimiter'>, </span><span class='Number'>17</span><span class='Delimiter'>, </span><span class='Number'>17</span><span class='Delimiter'>, 
</span>    <span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>18</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, </span><span class='Number'>19</span><span class='Delimiter'>, 
</span>    <span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>20</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, </span><span class='Number'>21</span><span class='Delimiter'>, 
</span>    <span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, </span><span class='Number'>22</span><span class='Delimiter'>, 
</span>    <span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, </span><span class='Number'>23</span><span class='Delimiter'>, 
</span>    <span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, </span><span class='Number'>24</span><span class='Delimiter'>, 
</span>    <span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span><span class='Delimiter'>, </span><span class='Number'>25</span> 
<span class='Delimiter'>}; 
</span><a name="LN268"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SIZE_CLASS_MAP_QUANTUM</span>  <span class='Number'>8</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Superblocks are binned by how full they are.  Generally, each fullness 
 * class corresponds to one quartile, but the block being used for 
 * allocations is always at the head of the list for fullness class 1, 
 * regardless of how full it really is. 
 */ 
</span><a name="LN276"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_FULLNESS_CLASSES</span>        <span class='Number'>4</span> 
 
<span class='Comment_Multi_Line'>/* 
 * A dsa_area_pool represents a set of objects of a given size class. 
 * 
 * Perhaps there should be multiple pools for the same size class for 
 * contention avoidance, but for now there is just one! 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* A lock protecting access to this pool. */ 
</span><a name="LN287"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>      <span class='Declare_Member'>lock</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* A set of linked lists of spans, arranged by fullness. */ 
</span><a name="LN289"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Member'>spans</span><span class='Delimiter'>[</span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* Should we pad this out to a cacheline boundary? */ 
</span><a name="LN291"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>dsa_area_pool</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * The control block for an area.  This lives in shared memory, at the start of 
 * the first DSM segment controlled by this area. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* The segment header for the first segment. */ 
</span><a name="LN300"></a>    <a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Declare_Member'>segment_header</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The handle for this area. */ 
</span><a name="LN302"></a>    <a href="../../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a>  <span class='Declare_Member'>handle</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The handles of the segments owned by this area. */ 
</span><a name="LN304"></a>    <a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a>  <span class='Declare_Member'>segment_handles</span><span class='Delimiter'>[</span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* Lists of segments, binned by maximum contiguous run of free pages. */ 
</span><a name="LN306"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Member'>segment_bins</span><span class='Delimiter'>[</span><a href="dsa.c.html#LN132"><span class='Ref_to_Const'>DSA_NUM_SEGMENT_BINS</span></a><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* The object pools for each size class. */ 
</span><a name="LN308"></a>    <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Declare_Member'>pools</span><span class='Delimiter'>[</span><a href="dsa.c.html#LN246"><span class='Ref_to_Const'>DSA_NUM_SIZE_CLASSES</span></a><span class='Delimiter'>]; 
</span>    <span class='Comment_Multi_Line'>/* The total size of all active segments. */ 
</span><a name="LN310"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>total_segment_size</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The maximum total size of backing storage we are allowed. */ 
</span><a name="LN312"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>max_total_segment_size</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Highest used segment index in the history of this area. */ 
</span><a name="LN314"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Member'>high_segment_index</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The reference count for this area. */ 
</span><a name="LN316"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>refcnt</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* A flag indicating that this area has been pinned. */ 
</span><a name="LN318"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>pinned</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The number of times that segments have been freed. */ 
</span><a name="LN320"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>freed_segment_counter</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The LWLock tranche ID. */ 
</span><a name="LN322"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>lwlock_tranche_id</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* The general lock (protects everything except object pools). */ 
</span><a name="LN324"></a>    <a href="../../../include/storage/lwlock.h.html#LN31"><span class='Ref_to_Struct'>LWLock</span></a>      <span class='Declare_Member'>lock</span><span class='Delimiter'>; 
</span><a name="LN325"></a>}<span class='Auto_Annotations'> &laquo; end {anondsa_area_control} &raquo; </span> <span class='Declare_Typedef'>dsa_area_control</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Given a pointer to a pool, find a dsa_pointer. */ 
</span><a name="LN328"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>DsaAreaPoolToDsaPointer</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>p</span><span class='Parentheses'>)</span>    <span class='Operator'>\ 
</span>    <a href="dsa.c.html#LN113"><span class='Ref_to_Macro'>DSA_MAKE_POINTER</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN328"><span class='Ref_to_Parameter'>p</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN328"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span>control<span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* 
 * A dsa_segment_map is stored within the backend-private memory of each 
 * individual backend.  It holds the base address of the segment within that 
 * backend, plus the addresses of key objects within the segment.  Those 
 * could instead be derived from the base address but it's handy to have them 
 * around. 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN340"></a>    <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Member'>segment</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* DSM segment */ 
</span><a name="LN341"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>mapped_address</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Address at which segment is mapped */ 
</span><a name="LN342"></a>    <a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Operator'>*</span><span class='Declare_Member'>header</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* Header (same as mapped_address) */ 
</span><a name="LN343"></a>    <a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Member'>fpm</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Free page manager within segment. */ 
</span><a name="LN344"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Declare_Member'>pagemap</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* Page map within segment. */ 
</span><a name="LN345"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>dsa_segment_map</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Per-backend state for a storage area.  Backends obtain one of these by 
 * creating an area or attaching to an existing one using a handle.  Each 
 * process that needs to use an area uses its own object to track where the 
 * segments are mapped. 
 */ 
</span><a name="LN353"></a><span class='Control'>struct</span> <span class='Declare_Struct'>dsa_area</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Pointer to the control object in shared memory. */ 
</span><a name="LN356"></a>    <a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Declare_Member'>control</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Has the mapping been pinned? */ 
</span><a name="LN359"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>mapping_pinned</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This backend's array of segment maps, ordered by segment index 
     * corresponding to control-&GT;segment_handles.  Some of the area's segments 
     * may not be mapped in in this backend yet, and some slots may have been 
     * freed and need to be detached; these operations happen on demand. 
     */ 
</span><a name="LN367"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Declare_Member'>segment_maps</span><span class='Delimiter'>[</span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* The highest segment index this backend has ever mapped. */ 
</span><a name="LN370"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Member'>high_segment_index</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* The last observed freed_segment_counter. */ 
</span><a name="LN373"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>freed_segment_counter</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_area &raquo; </span><span class='Delimiter'>; 
</span> 
<a name="LN376"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SPAN_NOTHING_FREE</span>   <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a><span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
<a name="LN377"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>DSA_SUPERBLOCK_SIZE</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN103"><span class='Ref_to_Const'>DSA_PAGES_PER_SUPERBLOCK</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>) 
</span> 
<span class='Comment_Multi_Line'>/* Given a pointer to a segment_map, obtain a segment index number. */ 
</span><a name="LN380"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>get_segment_index</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>segment_map_ptr</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="dsa.c.html#LN380"><span class='Ref_to_Parameter'>segment_map_ptr</span></a> <span class='Operator'>- &</span><a href="dsa.c.html#LN380"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span>segment_maps<span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>) 
</span> 
<a name="LN383"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>init_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Delimiter'>, 
</span><a name="LN384"></a>          <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>start</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, 
</span><a name="LN385"></a>          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>size_class</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN386"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>transfer_first_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, 
</span><a name="LN387"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>fromclass</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>toclass</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN388"></a><span class='Keyword'>static inline </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Prototype'>alloc_object</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size_class</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN389"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>ensure_active_superblock</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, 
</span><a name="LN390"></a>                         <span class='Keyword'>int </span><span class='Declare_Parameter'>size_class</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN391"></a><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_segment_by_index</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, 
</span><a name="LN392"></a>                     <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN393"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>destroy_superblock</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN394"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>unlink_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN395"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>add_span_to_fullness_class</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Delimiter'>, 
</span><a name="LN396"></a>                           <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fclass</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN397"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>unlink_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment_map</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN398"></a><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_best_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN399"></a><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>make_new_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>requested_pages</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN400"></a><span class='Keyword'>static </span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>create_internal</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Delimiter'>, 
</span><a name="LN401"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>tranche_id</span><span class='Delimiter'>, 
</span><a name="LN402"></a>                <a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a> <span class='Declare_Parameter'>control_handle</span><span class='Delimiter'>, 
</span><a name="LN403"></a>                <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>control_segment</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN404"></a><span class='Keyword'>static </span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>attach_internal</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span><a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment</span><span class='Delimiter'>, 
</span><a name="LN405"></a>                <a href="../../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a> <span class='Declare_Parameter'>handle</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN406"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>check_for_freed_segments</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a new shared area in a new DSM segment.  Further DSM segments will 
 * be allocated as required to extend the available space. 
 * 
 * We can't allocate a LWLock tranche_id within this function, because tranche 
 * IDs are a scarce resource; there are only 64k available, using low numbers 
 * when possible matters, and we have no provision for recycling them.  So, 
 * we require the caller to provide one. 
 */ 
</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN418"></a><span class='Declare_Function'>dsa_create</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>tranche_id</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN420"></a>    <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span><span class='Delimiter'>; 
</span><a name="LN421"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the DSM segment that will hold the shared control object and the 
     * first segment of usable space. 
     */ 
</span>    <a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN36"><span class='Ref_to_Proto'>dsm_create</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN67"><span class='Ref_to_Const'>DSA_INITIAL_SEGMENT_SIZE</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * All segments backing this area are pinned, so that DSA can explicitly 
     * control their lifetime (otherwise a newly created segment belonging to 
     * this area might be freed when the only backend that happens to have it 
     * mapped in ends, corrupting the area). 
     */ 
</span>    <a href="../../../include/storage/dsm.h.html#LN45"><span class='Ref_to_Proto'>dsm_pin_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Create a new DSA area with the control object in this segment. */ 
</span>    <a href="dsa.c.html#LN421"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN400"><span class='Ref_to_Proto'>create_internal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                           <a href="dsa.c.html#LN67"><span class='Ref_to_Const'>DSA_INITIAL_SEGMENT_SIZE</span></a><span class='Delimiter'>, 
</span>                           <a href="dsa.c.html#LN418"><span class='Ref_to_Parameter'>tranche_id</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/storage/dsm.h.html#LN52"><span class='Ref_to_Proto'>dsm_segment_handle</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up when the control segment detaches. */ 
</span>    <a href="../../../include/storage/dsm.h.html#LN56"><span class='Ref_to_Proto'>on_dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../../../include/utils/dsa.h.html#LN109"><span class='Ref_to_Proto'>dsa_on_dsm_detach_release_in_place</span></a><span class='Delimiter'>, 
</span>                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN420"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN421"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_create &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a new shared area in an existing shared memory space, which may be 
 * either DSM or Postmaster-initialized memory.  DSM segments will be 
 * allocated as required to extend the available space, though that can be 
 * prevented with dsa_set_size_limit(area, size) using the same size provided 
 * to dsa_create_in_place. 
 * 
 * Areas created in-place must eventually be released by the backend that 
 * created them and all backends that attach to them.  This can be done 
 * explicitly with dsa_release_in_place, or, in the special case that 'place' 
 * happens to be in a pre-existing DSM segment, by passing in a pointer to the 
 * segment so that a detach hook can be registered with the containing DSM 
 * segment. 
 * 
 * See dsa_create() for a note about the tranche arguments. 
 */ 
</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN467"></a><span class='Declare_Function'>dsa_create_in_place</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Delimiter'>, 
</span><a name="LN468"></a>                    <span class='Keyword'>int </span><span class='Declare_Parameter'>tranche_id</span><span class='Delimiter'>, </span><a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN470"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN470"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN400"><span class='Ref_to_Proto'>create_internal</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN467"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN467"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN468"><span class='Ref_to_Parameter'>tranche_id</span></a><span class='Delimiter'>, 
</span>                           <a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clean up when the control segment detaches, if a containing DSM segment 
     * was provided. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN468"><span class='Ref_to_Parameter'>segment</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/dsm.h.html#LN56"><span class='Ref_to_Proto'>on_dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN468"><span class='Ref_to_Parameter'>segment</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../../../include/utils/dsa.h.html#LN109"><span class='Ref_to_Proto'>dsa_on_dsm_detach_release_in_place</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN467"><span class='Ref_to_Parameter'>place</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN470"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Obtain a handle that can be passed to other processes so that they can 
 * attach to the given area.  Cannot be called for areas created with 
 * dsa_create_in_place. 
 */ 
</span><a href="../../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a> 
<a name="LN492"></a><span class='Declare_Function'>dsa_get_handle</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN492"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="dsa.c.html#LN492"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Attach to an area given a handle generated (possibly in another process) by 
 * dsa_get_handle.  The area must have been created with dsa_create (not 
 * dsa_create_in_place). 
 */ 
</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN504"></a><span class='Declare_Function'>dsa_attach</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a> <span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN506"></a>    <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span><span class='Delimiter'>; 
</span><a name="LN507"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * An area handle is really a DSM segment handle for the first segment, so 
     * we go ahead and attach to that. 
     */ 
</span>    <a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN37"><span class='Ref_to_Proto'>dsm_attach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN504"><span class='Ref_to_Parameter'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not attach to dynamic shared area"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN507"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN404"><span class='Ref_to_Proto'>attach_internal</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN504"><span class='Ref_to_Parameter'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Clean up when the control segment detaches. */ 
</span>    <a href="../../../include/storage/dsm.h.html#LN56"><span class='Ref_to_Proto'>on_dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../../../include/utils/dsa.h.html#LN109"><span class='Ref_to_Proto'>dsa_on_dsm_detach_release_in_place</span></a><span class='Delimiter'>, 
</span>                  <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN506"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN507"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_attach &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Attach to an area that was created with dsa_create_in_place.  The caller 
 * must somehow know the location in memory that was used when the area was 
 * created, though it may be mapped at a different virtual address in this 
 * process. 
 * 
 * See dsa_create_in_place for note about releasing in-place areas, and the 
 * optional 'segment' argument which can be provided to allow automatic 
 * release if the containing memory happens to be a DSM segment. 
 */ 
</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN539"></a><span class='Declare_Function'>dsa_attach_in_place</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span><a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN541"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN541"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN404"><span class='Ref_to_Proto'>attach_internal</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN539"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Clean up when the control segment detaches, if a containing DSM segment 
     * was provided. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN539"><span class='Ref_to_Parameter'>segment</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/dsm.h.html#LN56"><span class='Ref_to_Proto'>on_dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN539"><span class='Ref_to_Parameter'>segment</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="../../../include/utils/dsa.h.html#LN109"><span class='Ref_to_Proto'>dsa_on_dsm_detach_release_in_place</span></a><span class='Delimiter'>, 
</span>                      <a href="../../../include/postgres.h.html#LN561"><span class='Ref_to_Macro'>PointerGetDatum</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN539"><span class='Ref_to_Parameter'>place</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN541"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Release a DSA area that was produced by dsa_create_in_place or 
 * dsa_attach_in_place.  The 'segment' argument is ignored but provides an 
 * interface suitable for on_dsm_detach, for the convenience of users who want 
 * to create a DSA segment inside an existing DSM segment and have it 
 * automatically released when the containing DSM segment is detached. 
 * 'place' should be the address of the place where the area was created. 
 * 
 * This callback is automatically registered for the DSM segment containing 
 * the control object of in-place areas when a segment is provided to 
 * dsa_create_in_place or dsa_attach_in_place, and also for all areas created 
 * with dsa_create. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN570"></a><span class='Declare_Function'>dsa_on_dsm_detach_release_in_place</span><span class='Parentheses'>(</span><a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>place</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/dsa.h.html#LN108"><span class='Ref_to_Proto'>dsa_release_in_place</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN570"><span class='Ref_to_Parameter'>place</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Release a DSA area that was produced by dsa_create_in_place or 
 * dsa_attach_in_place.  The 'code' argument is ignored but provides an 
 * interface suitable for on_shmem_exit or before_shmem_exit, for the 
 * convenience of users who want to create a DSA segment inside shared memory 
 * other than a DSM segment and have it automatically release at backend exit. 
 * 'place' should be the address of the place where the area was created. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN584"></a><span class='Declare_Function'>dsa_on_shmem_exit_release_in_place</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Delimiter'>, </span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> <span class='Declare_Parameter'>place</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/dsa.h.html#LN108"><span class='Ref_to_Proto'>dsa_release_in_place</span></a><span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN554"><span class='Ref_to_Macro'>DatumGetPointer</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN584"><span class='Ref_to_Parameter'>place</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Release a DSA area that was produced by dsa_create_in_place or 
 * dsa_attach_in_place.  It is preferable to use one of the 'dsa_on_XXX' 
 * callbacks so that this is managed automatically, because failure to release 
 * an area created in-place leaks its segments permanently. 
 * 
 * This is also called automatically for areas produced by dsa_create or 
 * dsa_attach as an implementation detail. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN599"></a><span class='Declare_Function'>dsa_release_in_place</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN601"></a>    <a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Declare_Local'>control</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN599"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span><a name="LN602"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN324"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN153"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== 
</span>           <span class='Parentheses'>(</span><a href="dsa.c.html#LN110"><span class='Ref_to_Const'>DSA_SEGMENT_HEADER_MAGIC</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>^ </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>--</span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN602"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN314"><span class='Ref_to_Member'>high_segment_index</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN612"></a>            <a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a>  <span class='Declare_Local'>handle</span><span class='Delimiter'>; 
</span> 
            <a href="dsa.c.html#LN612"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN602"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN612"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>!= </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/storage/dsm.h.html#LN46"><span class='Ref_to_Proto'>dsm_unpin_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN612"><span class='Ref_To_Local'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dsa.c.html#LN601"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN324"><span class='Ref_to_Member'>lock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_release_in_place &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Keep a DSA area attached until end of session or explicit detach. 
 * 
 * By default, areas are owned by the current resource owner, which means they 
 * are detached automatically when that scope ends. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN629"></a><span class='Declare_Function'>dsa_pin_mapping</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN631"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dsa.c.html#LN629"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN629"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN631"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN631"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN629"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN631"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN629"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN631"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/dsm.h.html#LN43"><span class='Ref_to_Proto'>dsm_pin_mapping</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN629"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN631"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Allocate memory in this storage area.  The return value is a dsa_pointer 
 * that can be passed to other processes, and converted to a local pointer 
 * with dsa_get_address.  'flags' is a bitmap which should be constructed 
 * from the following values: 
 * 
 * DSA_ALLOC_HUGE allows allocations &GT;= 1GB.  Otherwise, such allocations 
 * will result in an ERROR. 
 * 
 * DSA_ALLOC_NO_OOM causes this function to return InvalidDsaPointer when 
 * no memory is available or a size limit establed by set_dsa_size_limit 
 * would be exceeded.  Otherwise, such allocations will result in an ERROR. 
 * 
 * DSA_ALLOC_ZERO causes the allocated memory to be zeroed.  Otherwise, the 
 * contents of newly-allocated memory are indeterminate. 
 * 
 * These flags correspond to similarly named flags used by 
 * MemoryContextAllocExtended().  See also the macros dsa_allocate and 
 * dsa_allocate0 which expand to a call to this function with commonly used 
 * flags. 
 */ 
</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> 
<a name="LN663"></a><span class='Declare_Function'>dsa_allocate_extended</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>size</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>flags</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN665"></a>    <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>size_class</span><span class='Delimiter'>; 
</span><a name="LN666"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>start_pointer</span><span class='Delimiter'>; 
</span><a name="LN667"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span><a name="LN668"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sanity check on huge individual allocation size. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/dsa.h.html#LN72"><span class='Ref_to_Const'>DSA_ALLOC_HUGE</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="../../../include/utils/memutils.h.html#LN45"><span class='Ref_to_Macro'>AllocHugeSizeIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>))</span> <span class='Operator'>|| 
</span>        <span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/dsa.h.html#LN72"><span class='Ref_to_Const'>DSA_ALLOC_HUGE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& !</span><a href="../../../include/utils/memutils.h.html#LN41"><span class='Ref_to_Macro'>AllocSizeIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid DSA memory alloc request size %zu"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If bigger than the largest size class, just grab a run of pages from 
     * the free page manager, instead of allocating an object from a pool. 
     * There will still be a span, but it's a special class of span that 
     * manages this whole allocation and simply gives all pages back to the 
     * free page manager when dsa_free is called. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN686"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>npages</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN73"><span class='Ref_to_Macro'>fpm_size_to_pages</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN687"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN688"></a>        <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span><span class='Delimiter'>; 
</span><a name="LN689"></a>        <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pool</span> <span class='Operator'>= &</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* Obtain a span object. */ 
</span>        <a href="dsa.c.html#LN688"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN388"><span class='Ref_to_Proto'>alloc_object</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN688"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Find a segment from which to allocate. */ 
</span>        <a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN398"><span class='Ref_to_Proto'>get_best_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN686"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN399"><span class='Ref_to_Proto'>make_new_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN686"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Can't make any more segments: game over. */ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN688"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Raise error unless asked not to. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/common/fe_memutils.h.html#LN17"><span class='Ref_to_Const'>MCXT_ALLOC_NO_OOM</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed on DSA request of size %zu."</span><span class='Delimiter'>, 
</span>                                   <a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Ask the free page manager for a run of pages.  This should always 
         * succeed, since both get_best_segment and make_new_segment should 
         * only return a non-NULL pointer if it actually contains enough 
         * contiguous freespace.  If it does fail, something in our backend 
         * private state is out of whack, so use FATAL to kill the process. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/freepage.h.html#LN92"><span class='Ref_to_Proto'>FreePageManagerGet</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN686"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dsa.c.html#LN687"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"dsa_allocate could not find %zu free pages"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN686"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN666"><span class='Ref_To_Local'>start_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN113"><span class='Ref_to_Macro'>DSA_MAKE_POINTER</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN380"><span class='Ref_to_Macro'>get_segment_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                         <a href="dsa.c.html#LN687"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Initialize span and pagemap. */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN383"><span class='Ref_to_Proto'>init_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN688"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN689"><span class='Ref_To_Local'>pool</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN666"><span class='Ref_To_Local'>start_pointer</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN686"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, 
</span>                  <a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN667"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN687"><span class='Ref_To_Local'>first_page</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN688"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Zero-initialize the memory if requested. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/dsa.h.html#LN74"><span class='Ref_to_Const'>DSA_ALLOC_ZERO</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            memset<span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN666"><span class='Ref_To_Local'>start_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="dsa.c.html#LN666"><span class='Ref_To_Local'>start_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if size&GT;dsa_size_classes... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Map allocation to a size class. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN258"><span class='Ref_to_Global_Var'>dsa_size_class_map</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dsa.c.html#LN268"><span class='Ref_to_Const'>DSA_SIZE_CLASS_MAP_QUANTUM</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN751"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>mapidx</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* For smaller sizes we have a lookup table... */ 
</span>        <a href="dsa.c.html#LN751"><span class='Ref_To_Local'>mapidx</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN268"><span class='Ref_to_Const'>DSA_SIZE_CLASS_MAP_QUANTUM</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ 
</span>                  <a href="dsa.c.html#LN268"><span class='Ref_to_Const'>DSA_SIZE_CLASS_MAP_QUANTUM</span></a><span class='Parentheses'>)</span> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN258"><span class='Ref_to_Global_Var'>dsa_size_class_map</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN751"><span class='Ref_To_Local'>mapidx</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN760"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>min</span><span class='Delimiter'>; 
</span><a name="LN761"></a>        <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>max</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* ... and for the rest we search by binary chop. */ 
</span>        <a href="dsa.c.html#LN760"><span class='Ref_To_Local'>min</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN258"><span class='Ref_to_Global_Var'>dsa_size_class_map</span></a><span class='Delimiter'>[</span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN258"><span class='Ref_to_Global_Var'>dsa_size_class_map</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>        <a href="dsa.c.html#LN761"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN561"><span class='Ref_to_Macro'>lengthof</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN760"><span class='Ref_To_Local'>min</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN761"><span class='Ref_To_Local'>max</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN769"></a>            <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>mid</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN760"><span class='Ref_To_Local'>min</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN761"><span class='Ref_To_Local'>max</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span><a name="LN770"></a>            <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a>      <span class='Declare_Local'>class_size</span> <span class='Operator'>= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN769"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN770"><span class='Ref_To_Local'>class_size</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>) 
</span>                <a href="dsa.c.html#LN760"><span class='Ref_To_Local'>min</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN769"><span class='Ref_To_Local'>mid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="dsa.c.html#LN761"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN769"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN760"><span class='Ref_To_Local'>min</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Attempt to allocate an object from the appropriate pool. */ 
</span>    <a href="dsa.c.html#LN668"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN388"><span class='Ref_to_Proto'>alloc_object</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN665"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check for failure to allocate. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN668"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Raise error unless asked not to. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/dsa.h.html#LN73"><span class='Ref_to_Const'>DSA_ALLOC_NO_OOM</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OUT_OF_MEMORY<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"out of memory"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"Failed on DSA request of size %zu."</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Zero-initialize the memory if requested. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>flags</span></a> <span class='Operator'>& </span><a href="../../../include/utils/dsa.h.html#LN74"><span class='Ref_to_Const'>DSA_ALLOC_ZERO</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        memset<span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN668"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN663"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN668"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_allocate_extended &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Free memory obtained with dsa_allocate. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN811"></a><span class='Declare_Function'>dsa_free</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>dp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN813"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span><a name="LN814"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pageno</span><span class='Delimiter'>; 
</span><a name="LN815"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span><span class='Delimiter'>; 
</span><a name="LN816"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span><a name="LN817"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>superblock</span><span class='Delimiter'>; 
</span><a name="LN818"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span><a name="LN819"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN820"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size_class</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Make sure we don't have a stale segment in the slot 'dp' refers to. */ 
</span>    <a href="dsa.c.html#LN406"><span class='Ref_to_Proto'>check_for_freed_segments</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Locate the object, span and pool. */ 
</span>    <a href="dsa.c.html#LN813"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN117"><span class='Ref_to_Macro'>DSA_EXTRACT_SEGMENT_NUMBER</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN814"><span class='Ref_To_Local'>pageno</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN120"><span class='Ref_to_Macro'>DSA_EXTRACT_OFFSET</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN815"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN813"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN814"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN815"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN817"><span class='Ref_To_Local'>superblock</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN820"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN200"><span class='Ref_to_Member'>size_class</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN819"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN820"><span class='Ref_To_Local'>size_class</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Special case for large objects that live in a special span: we return 
     * those pages directly to the free page manager and free the span. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN200"><span class='Ref_to_Member'>size_class</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
        memset<span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, </span><span class='Number'>0x7f</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN199"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Give pages back to free page manager. */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/freepage.h.html#LN94"><span class='Ref_to_Proto'>FreePageManagerPut</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN813"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, 
</span>                           <a href="dsa.c.html#LN120"><span class='Ref_to_Macro'>DSA_EXTRACT_OFFSET</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>, 
</span>                           <a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN199"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Unlink span. */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                      <a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN394"><span class='Ref_to_Proto'>unlink_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Free the span object so it can be reused. */ 
</span>        <a href="../../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN815"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if span-&GT;size_class==DSA... &raquo; </span> 
 
<span class='Directive'>#ifdef</span> <a href="../../../include/pg_config_manual.h.html#LN266"><span class='Ref_to_Const'>CLOBBER_FREED_MEMORY</span></a> 
    memset<span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a><span class='Delimiter'>, </span><span class='Number'>0x7f</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN819"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN820"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Put the object on the span's freelist. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>&GT;= </span><a href="dsa.c.html#LN817"><span class='Ref_To_Local'>superblock</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN817"><span class='Ref_To_Local'>superblock</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN377"><span class='Ref_to_Const'>DSA_SUPERBLOCK_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>- </span><a href="dsa.c.html#LN817"><span class='Ref_To_Local'>superblock</span></a><span class='Parentheses'>) </span><span class='Operator'>% </span><a href="dsa.c.html#LN819"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN212"><span class='Ref_to_Macro'>NextFreeObjectIndex</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a><span class='Parentheses'>) </span><span class='Operator'>= </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN818"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>- </span><a href="dsa.c.html#LN817"><span class='Ref_To_Local'>superblock</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dsa.c.html#LN819"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>++</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * See if the span needs to moved to a different fullness class, or be 
     * freed so its pages can be given back to the segment. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>== </span><span class='Number'>1</span> <span class='Operator'>&& </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The block was completely full and is located in the 
         * highest-numbered fullness class, which is never scanned for free 
         * chunks.  We must move it to the next-lower fullness class. 
         */ 
</span>        <a href="dsa.c.html#LN394"><span class='Ref_to_Proto'>unlink_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN395"><span class='Ref_to_Proto'>add_span_to_fullness_class</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN815"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>, 
</span>                                   <a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is the only span, and there is no active span, then we 
         * should probably move this span to fullness class 1.  (Otherwise if 
         * you allocate exactly all the objects in the only span, it moves to 
         * class 3, then you free them all, it moves to 2, and then is given 
         * back, leaving no active span). 
         */ 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN204"><span class='Ref_to_Member'>nmax</span></a> <span class='Operator'>&& 
</span>             <span class='Parentheses'>(</span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>!= </span><span class='Number'>1</span> <span class='Operator'>|| </span><a href="dsa.c.html#LN816"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This entire block is free, and it's not the active block for this 
         * size class.  Return the memory to the free page manager. We don't 
         * do this for the active block to prevent hysteresis: if we 
         * repeatedly allocate and free the only chunk in the active block, it 
         * will be very inefficient if we deallocate and reallocate the block 
         * every time. 
         */ 
</span>        <a href="dsa.c.html#LN393"><span class='Ref_to_Proto'>destroy_superblock</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN815"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN811"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN820"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_free &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain a backend-local address for a dsa_pointer.  'dp' must point to 
 * memory allocated by the given area (possibly in another process) that 
 * hasn't yet been freed.  This may cause a segment to be mapped into the 
 * current process if required, and may cause freed segments to be unmapped. 
 */ 
</span><span class='Keyword'>void </span><span class='Operator'>* 
</span><a name="LN923"></a><span class='Declare_Function'>dsa_get_address</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>dp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN925"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN926"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert InvalidDsaPointer to NULL. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Process any requests to detach from freed segments. */ 
</span>    <a href="dsa.c.html#LN406"><span class='Ref_to_Proto'>check_for_freed_segments</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Break the dsa_pointer into its components. */ 
</span>    <a href="dsa.c.html#LN925"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN117"><span class='Ref_to_Macro'>DSA_EXTRACT_SEGMENT_NUMBER</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN926"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN120"><span class='Ref_to_Macro'>DSA_EXTRACT_OFFSET</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>dp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN925"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Check if we need to cause this segment to be mapped in. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN958"><span class='Ref_to_Macro'>unlikely</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN925"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Call for effect (we don't need the result). */ 
</span>        <a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN925"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN923"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN925"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN926"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_get_address &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Pin this area, so that it will continue to exist even if all backends 
 * detach from it.  In that case, the area can still be reattached to if a 
 * handle has been recorded somewhere. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN956"></a><span class='Declare_Function'>dsa_pin</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN318"><span class='Ref_to_Member'>pinned</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"dsa_area already pinned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN318"><span class='Ref_to_Member'>pinned</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Operator'>++</span><a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN956"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Undo the effects of dsa_pin, so that the given area can be freed when no 
 * backends are attached to it.  May be called only if dsa_pin has been 
 * called. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN975"></a><span class='Declare_Function'>dsa_unpin</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN318"><span class='Ref_to_Member'>pinned</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"dsa_area not pinned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN318"><span class='Ref_to_Member'>pinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Operator'>--</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN975"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Set the total size limit for this area.  This limit is checked whenever new 
 * segments need to be allocated from the operating system.  If the new size 
 * limit is already exceeded, this has no immediate effect. 
 * 
 * Note that the total virtual memory usage may be temporarily larger than 
 * this limit when segments have been freed, but not yet detached by all 
 * backends that have attached to them. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN999"></a><span class='Declare_Function'>dsa_set_size_limit</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>limit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN999"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN999"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN999"><span class='Ref_to_Parameter'>limit</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN999"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Aggressively free all spare memory in the hope of returning DSM segments to 
 * the operating system. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1011"></a><span class='Declare_Function'>dsa_trim</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1013"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size_class</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Trim in reverse pool order so we get to the spans-of-spans last, just 
     * in case any become entirely free while processing all the other pools. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN246"><span class='Ref_to_Const'>DSA_NUM_SIZE_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Delimiter'>; </span><span class='Operator'>--</span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1021"></a>        <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pool</span> <span class='Operator'>= &</span><a href="dsa.c.html#LN1011"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a><span class='Delimiter'>]; 
</span><a name="LN1022"></a>        <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Large object frees give back segments aggressively already. */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Search fullness class 1 only.  That is where we expect to find an 
         * entirely empty superblock (entirely empty superblocks in other 
         * fullness classes are returned to the free page map by dsa_free). 
         */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1011"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1022"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1021"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1022"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1039"></a>            <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1011"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1022"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1040"></a>            <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="dsa.c.html#LN1039"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1039"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN1039"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN204"><span class='Ref_to_Member'>nmax</span></a><span class='Parentheses'>) 
</span>                <a href="dsa.c.html#LN393"><span class='Ref_to_Proto'>destroy_superblock</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1011"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1022"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="dsa.c.html#LN1022"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1040"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1011"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1013"><span class='Ref_To_Local'>size_class</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for size_class=DSA_NUM_SI... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end dsa_trim &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Print out debugging information about the internal state of the shared 
 * memory area. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1056"></a><span class='Declare_Function'>dsa_dump</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1058"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>i</span><span class='Delimiter'>, 
</span><a name="LN1059"></a>                <span class='Declare_Local'>j</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: This gives an inconsistent snapshot as it acquires and releases 
     * individual locks as it goes... 
     */ 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"dsa_area handle %x:\n"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  max_total_segment_size: %zu\n"</span><span class='Delimiter'>, 
</span>            <a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  total_segment_size: %zu\n"</span><span class='Delimiter'>, 
</span>            <a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  refcnt: %d\n"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  pinned: %c\n"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN318"><span class='Ref_to_Member'>pinned</span></a> <span class='Operator'>? </span><span class='String'>'t'</span> <span class='Operator'>: </span><span class='String'>'f'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  segment bins:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN132"><span class='Ref_to_Const'>DSA_NUM_SEGMENT_BINS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1079"></a>            <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>segment_index</span><span class='Delimiter'>; 
</span> 
            <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                <span class='String'>"    segment bin %zu (at least %d contiguous pages free):\n"</span><span class='Delimiter'>, 
</span>                    <a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1079"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1079"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1087"></a>                <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span> 
                <a href="dsa.c.html#LN1087"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= 
</span>                    <a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1079"><span class='Ref_To_Local'>segment_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        <span class='String'>"      segment index %zu, usable_pages = %zu, "</span> 
                        <span class='String'>"contiguous_pages = %zu, mapped at %p\n"</span><span class='Delimiter'>, 
</span>                        <a href="dsa.c.html#LN1079"><span class='Ref_To_Local'>segment_index</span></a><span class='Delimiter'>, 
</span>                        <a href="dsa.c.html#LN1087"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN155"><span class='Ref_to_Member'>usable_pages</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/freepage.h.html#LN87"><span class='Ref_to_Macro'>fpm_largest</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1087"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="dsa.c.html#LN1087"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN1079"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1087"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if area-&GT;control-&GT;segmen... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;DSA_NUM_SEGMENT... &raquo; </span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"  pools:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN246"><span class='Ref_to_Const'>DSA_NUM_SIZE_CLASSES</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1108"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                <a href="dsa.c.html#LN1108"><span class='Ref_To_Local'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1108"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>                <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"    pool for blocks of span objects:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>) 
</span>                <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"    pool for large object spans:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    <span class='String'>"    pool for size class %zu (object size %hu bytes):\n"</span><span class='Delimiter'>, 
</span>                        <a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
                    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"      fullness class %zu is empty\n"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN1130"></a>                    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span> <span class='Operator'>= </span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Delimiter'>]; 
</span> 
                    <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"      fullness class %zu:\n"</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1059"><span class='Ref_To_Local'>j</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1130"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
                    <span class='Delimiter'>{ 
</span><a name="LN1135"></a>                        <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span> 
                        <a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1130"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="../../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                                <span class='String'>"        span descriptor at "</span> 
                                <a href="../../../include/utils/dsa.h.html#LN59"><span class='Ref_to_Const'>DSA_POINTER_FORMAT</span></a> <span class='String'>", superblock at "</span> 
                                <a href="../../../include/utils/dsa.h.html#LN59"><span class='Ref_to_Const'>DSA_POINTER_FORMAT</span></a> 
                                <span class='String'>", pages = %zu, objects free = %hu/%hu\n"</span><span class='Delimiter'>, 
</span>                                <a href="dsa.c.html#LN1130"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN199"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>, 
</span>                                <a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN204"><span class='Ref_to_Member'>nmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <a href="dsa.c.html#LN1130"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1135"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for j=0;j&LT;DSA_FULLNESS_CL... &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if found &raquo; </span> 
        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1056"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1058"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;DSA_NUM_SIZE_CL... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end dsa_dump &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the smallest size that you can successfully provide to 
 * dsa_create_in_place. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1159"></a><span class='Declare_Function'>dsa_minimum_size</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1161"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN1162"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>pages</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN1161"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Figure out how many pages we need, including the page map... */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(((</span><a href="dsa.c.html#LN1161"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN1162"><span class='Ref_To_Local'>pages</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Operator'>++</span><a href="dsa.c.html#LN1162"><span class='Ref_To_Local'>pages</span></a><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1161"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN1162"><span class='Ref_To_Local'>pages</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Workhorse function for dsa_create and dsa_create_in_place. 
 */ 
</span><span class='Keyword'>static </span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN1181"></a><span class='Declare_Function'>create_internal</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Delimiter'>, 
</span><a name="LN1182"></a>                <span class='Keyword'>int </span><span class='Declare_Parameter'>tranche_id</span><span class='Delimiter'>, 
</span><a name="LN1183"></a>                <a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a> <span class='Declare_Parameter'>control_handle</span><span class='Delimiter'>, 
</span><a name="LN1184"></a>                <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>control_segment</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1186"></a>    <a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Declare_Local'>control</span><span class='Delimiter'>; 
</span><a name="LN1187"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span><a name="LN1188"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span><a name="LN1189"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>usable_pages</span><span class='Delimiter'>; 
</span><a name="LN1190"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>total_pages</span><span class='Delimiter'>; 
</span><a name="LN1191"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>metadata_bytes</span><span class='Delimiter'>; 
</span><a name="LN1192"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Sanity check on the space we have to work in. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/dsa.h.html#LN116"><span class='Ref_to_Proto'>dsa_minimum_size</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"dsa_area space must be at least %zu, but %zu provided"</span><span class='Delimiter'>, 
</span>             <a href="../../../include/utils/dsa.h.html#LN116"><span class='Ref_to_Proto'>dsa_minimum_size</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Now figure out how much space is usable */ 
</span>    <a href="dsa.c.html#LN1190"><span class='Ref_To_Local'>total_pages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <a href="dsa.c.html#LN1190"><span class='Ref_To_Local'>total_pages</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Add padding up to next page boundary. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>- </span><a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize the dsa_area_control object located at the start of the 
     * space. 
     */ 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN153"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN110"><span class='Ref_to_Const'>DSA_SEGMENT_HEADER_MAGIC</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN1183"><span class='Ref_to_Parameter'>control_handle</span></a> <span class='Operator'>^ </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN155"><span class='Ref_to_Member'>usable_pages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN177"><span class='Ref_to_Member'>freed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN157"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN67"><span class='Ref_to_Const'>DSA_INITIAL_SEGMENT_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1183"><span class='Ref_to_Parameter'>control_handle</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1183"><span class='Ref_to_Parameter'>control_handle</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN132"><span class='Ref_to_Const'>DSA_NUM_SEGMENT_BINS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN314"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN320"><span class='Ref_to_Member'>freed_segment_counter</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN322"><span class='Ref_to_Member'>lwlock_tranche_id</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1182"><span class='Ref_to_Parameter'>tranche_id</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the dsa_area object that this backend will use to access the 
     * area.  Other backends will need to obtain their own dsa_area object by 
     * attaching. 
     */ 
</span>    <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN373"><span class='Ref_to_Member'>freed_segment_counter</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN187"><span class='Ref_to_Proto'>LWLockInitialize</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN324"><span class='Ref_to_Member'>lock</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN322"><span class='Ref_to_Member'>lwlock_tranche_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN246"><span class='Ref_to_Const'>DSA_NUM_SIZE_CLASSES</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/lwlock.h.html#LN187"><span class='Ref_to_Proto'>LWLockInitialize</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1192"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN322"><span class='Ref_to_Member'>lwlock_tranche_id</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up the segment map for this process's mapping. */ 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= &</span><a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1184"><span class='Ref_to_Parameter'>control_segment</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN1181"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up the free page map. */ 
</span>    <a href="../../../include/utils/freepage.h.html#LN91"><span class='Ref_to_Proto'>FreePageManagerInitialize</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* There can be 0 usable pages if size is dsa_minimum_size(). */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/freepage.h.html#LN94"><span class='Ref_to_Proto'>FreePageManagerPut</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1191"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>, 
</span>                           <a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Put this segment into the appropriate bin. */ 
</span>    <a href="dsa.c.html#LN1186"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN139"><span class='Ref_to_Macro'>contiguous_pages_to_segment_bin</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1188"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN139"><span class='Ref_to_Macro'>contiguous_pages_to_segment_bin</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1189"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN1187"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end create_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Workhorse function for dsa_attach and dsa_attach_in_place. 
 */ 
</span><span class='Keyword'>static </span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>* 
</span><a name="LN1284"></a><span class='Declare_Function'>attach_internal</span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>place</span><span class='Delimiter'>, </span><a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN99"><span class='Ref_to_Typedef'>dsa_handle</span></a> <span class='Declare_Parameter'>handle</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1286"></a>    <a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Declare_Local'>control</span><span class='Delimiter'>; 
</span><a name="LN1287"></a>    <a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>area</span><span class='Delimiter'>; 
</span><a name="LN1288"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN300"><span class='Ref_to_Member'>segment_header</span></a><span class='Operator'>.</span><a href="dsa.c.html#LN153"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== 
</span>           <span class='Parentheses'>(</span><a href="dsa.c.html#LN110"><span class='Ref_to_Const'>DSA_SEGMENT_HEADER_MAGIC</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>handle</span></a> <span class='Operator'>^ </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build the backend-local area object. */ 
</span>    <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Number'>0</span><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up the segment map for this process's mapping. */ 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= &</span><a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>segment</span></a><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* NULL for in-place */ 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1284"><span class='Ref_to_Parameter'>place</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN1288"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ </span><a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN297"><span class='Ref_to_Typedef'>dsa_area_control</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Bump the reference count. */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We can't attach to a DSA area that has already been destroyed. */ 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not attach to dynamic shared area"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Operator'>++</span><a href="dsa.c.html#LN1286"><span class='Ref_To_Local'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN316"><span class='Ref_to_Member'>refcnt</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN373"><span class='Ref_to_Member'>freed_segment_counter</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN320"><span class='Ref_to_Member'>freed_segment_counter</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN1287"><span class='Ref_To_Local'>area</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end attach_internal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Add a new span to fullness class 1 of the indicated pool. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1335"></a><span class='Declare_Function'>init_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, 
</span><a name="LN1336"></a>          <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Delimiter'>, 
</span><a name="LN1337"></a>          <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>start</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, 
</span><a name="LN1338"></a>          <a href="../../../include/c.h.html#LN266"><span class='Ref_to_Typedef'>uint16</span></a> <span class='Declare_Parameter'>size_class</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1340"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1335"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1336"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1341"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>obsize</span> <span class='Operator'>= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1338"><span class='Ref_to_Parameter'>size_class</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The per-pool lock must be held because we manipulate the span list for 
     * this pool. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1335"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1338"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Push this span onto the front of the span list for fullness class 1. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1352"></a>        <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>head</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1335"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1352"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1336"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN195"><span class='Ref_to_Member'>pool</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN328"><span class='Ref_to_Macro'>DsaAreaPoolToDsaPointer</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1335"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>pool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1336"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>start</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN199"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1337"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN200"><span class='Ref_to_Member'>size_class</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1338"><span class='Ref_to_Parameter'>size_class</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN201"><span class='Ref_to_Member'>ninitialized</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1338"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * A block-of-spans contains its own descriptor, so mark one object as 
         * initialized and reduce the count of allocatable objects by one. 
         * Doing this here has the side effect of also reducing nmax by one, 
         * which is important to make sure we free this object at the correct 
         * time. 
         */ 
</span>        <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN201"><span class='Ref_to_Member'>ninitialized</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>/ </span><a href="dsa.c.html#LN1341"><span class='Ref_To_Local'>obsize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1338"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN250"><span class='Ref_to_Const'>DSA_SCLASS_SPAN_LARGE</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN377"><span class='Ref_to_Const'>DSA_SUPERBLOCK_SIZE</span></a> <span class='Operator'>/ </span><a href="dsa.c.html#LN1341"><span class='Ref_To_Local'>obsize</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN376"><span class='Ref_to_Const'>DSA_SPAN_NOTHING_FREE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN204"><span class='Ref_to_Member'>nmax</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1340"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end init_span &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Transfer the first span in one fullness class to the head of another 
 * fullness class. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1390"></a><span class='Declare_Function'>transfer_first_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, 
</span><a name="LN1391"></a>                    <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>fromclass</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>toclass</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1393"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span><span class='Delimiter'>; 
</span><a name="LN1394"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span><a name="LN1395"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nextspan</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Can't do it if source list is empty. */ 
</span>    <a href="dsa.c.html#LN1393"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>fromclass</span></a><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1393"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove span from head of source list. */ 
</span>    <a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1390"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1393"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>fromclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1395"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1390"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1395"><span class='Ref_To_Local'>nextspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Add span to head of target list. */ 
</span>    <a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>toclass</span></a><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>toclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1393"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1395"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1390"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1395"><span class='Ref_To_Local'>nextspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1393"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dsa.c.html#LN1394"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1391"><span class='Ref_to_Parameter'>toclass</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end transfer_first_span &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate one object of the requested size class from the given area. 
 */ 
</span><span class='Keyword'>static inline </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> 
<a name="LN1430"></a><span class='Declare_Function'>alloc_object</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>size_class</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1432"></a>    <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pool</span> <span class='Operator'>= &</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN308"><span class='Ref_to_Member'>pools</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Delimiter'>]; 
</span><a name="LN1433"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span><a name="LN1434"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>block</span><span class='Delimiter'>; 
</span><a name="LN1435"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1436"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>object</span><span class='Delimiter'>; 
</span><a name="LN1437"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Even though ensure_active_superblock can in turn call alloc_object if 
     * it needs to allocate a new span, that's always from a different pool, 
     * and the order of lock acquisition is always the same, so it's OK that 
     * we hold this lock for the duration of this function. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If there's no active superblock, we must successfully obtain one or 
     * fail the request. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1432"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="dsa.c.html#LN389"><span class='Ref_to_Proto'>ensure_active_superblock</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1432"><span class='Ref_To_Local'>pool</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1435"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * There should be a block in fullness class 1 at this point, and it 
         * should never be completely full.  Thus we can either pop an object 
         * from the free list or, failing that, initialize a new object. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1432"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1432"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1434"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN246"><span class='Ref_to_Const'>DSA_NUM_SIZE_CLASSES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1437"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN376"><span class='Ref_to_Const'>DSA_SPAN_NOTHING_FREE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="dsa.c.html#LN1435"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1434"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a> <span class='Operator'>* </span><a href="dsa.c.html#LN1437"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1436"><span class='Ref_To_Local'>object</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1435"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN203"><span class='Ref_to_Member'>firstfree</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN212"><span class='Ref_to_Macro'>NextFreeObjectIndex</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1436"><span class='Ref_To_Local'>object</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="dsa.c.html#LN1435"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1434"><span class='Ref_To_Local'>block</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN201"><span class='Ref_to_Member'>ninitialized</span></a> <span class='Operator'>* </span><a href="dsa.c.html#LN1437"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>++</span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN201"><span class='Ref_to_Member'>ninitialized</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Operator'>--</span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If it's now full, move it to the highest-numbered fullness class. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1433"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dsa.c.html#LN386"><span class='Ref_to_Proto'>transfer_first_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1432"><span class='Ref_To_Local'>pool</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1430"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN1435"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end alloc_object &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Ensure an active (i.e. fullness class 1) superblock, unless all existing 
 * superblocks are completely full and no more can be allocated. 
 * 
 * Fullness classes K of 0..N are loosely intended to represent blocks whose 
 * utilization percentage is at least K/N, but we only enforce this rigorously 
 * for the highest-numbered fullness class, which always contains exactly 
 * those blocks that are completely full.  It's otherwise acceptable for a 
 * block to be in a higher-numbered fullness class than the one to which it 
 * logically belongs.  In addition, the active block, which is always the 
 * first block in fullness class 1, is permitted to have a higher allocation 
 * percentage than would normally be allowable for that fullness class; we 
 * don't move it until it's completely full, and then it goes to the 
 * highest-numbered fullness class. 
 * 
 * It might seem odd that the active block is the head of fullness class 1 
 * rather than fullness class 0, but experience with other allocators has 
 * shown that it's usually better to allocate from a block that's moderately 
 * full rather than one that's nearly empty.  Insofar as is reasonably 
 * possible, we want to avoid performing new allocations in a block that would 
 * otherwise become empty soon. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1518"></a><span class='Declare_Function'>ensure_active_superblock</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>pool</span><span class='Delimiter'>, 
</span><a name="LN1519"></a>                         <span class='Keyword'>int </span><span class='Declare_Parameter'>size_class</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1521"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>span_pointer</span><span class='Delimiter'>; 
</span><a name="LN1522"></a>    <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>start_pointer</span><span class='Delimiter'>; 
</span><a name="LN1523"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>obsize</span> <span class='Operator'>= </span><a href="dsa.c.html#LN235"><span class='Ref_to_Global_Var'>dsa_size_classes</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a><span class='Delimiter'>]; 
</span><a name="LN1524"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nmax</span><span class='Delimiter'>; 
</span><a name="LN1525"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>fclass</span><span class='Delimiter'>; 
</span><a name="LN1526"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>npages</span> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1527"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN1528"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1529"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN143"><span class='Ref_to_Macro'>DSA_SCLASS_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Compute the number of objects that will fit in a block of this size 
     * class.  Span-of-spans blocks are just a single page, and the first 
     * object isn't available for use because it describes the block-of-spans 
     * itself. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN1524"><span class='Ref_To_Local'>nmax</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>/ </span><a href="dsa.c.html#LN1523"><span class='Ref_To_Local'>obsize</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="dsa.c.html#LN1524"><span class='Ref_To_Local'>nmax</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN377"><span class='Ref_to_Const'>DSA_SUPERBLOCK_SIZE</span></a> <span class='Operator'>/ </span><a href="dsa.c.html#LN1523"><span class='Ref_To_Local'>obsize</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If fullness class 1 is empty, try to find a span to put in it by 
     * scanning higher-numbered fullness classes (excluding the last one, 
     * whose blocks are certain to all be completely full). 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1555"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>tfclass</span><span class='Delimiter'>; 
</span><a name="LN1556"></a>            <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span><a name="LN1557"></a>            <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nextspan</span><span class='Delimiter'>; 
</span><a name="LN1558"></a>            <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prevspan</span><span class='Delimiter'>; 
</span><a name="LN1559"></a>            <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Local'>next_span_pointer</span><span class='Delimiter'>; 
</span> 
            <a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1559"><span class='Ref_To_Local'>next_span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Figure out what fullness class should contain this span. */ 
</span>            <a href="dsa.c.html#LN1555"><span class='Ref_To_Local'>tfclass</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1524"><span class='Ref_To_Local'>nmax</span></a> <span class='Operator'>- </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN202"><span class='Ref_to_Member'>nallocatable</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="dsa.c.html#LN1524"><span class='Ref_To_Local'>nmax</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Look up next span. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>))</span> 
                <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * If utilization has dropped enough that this now belongs in some 
             * other fullness class, move it there. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1555"><span class='Ref_To_Local'>tfclass</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Remove from the current fullness class list. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* It was the head; remove it. */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                        <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* It was not the head. */ 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="dsa.c.html#LN1558"><span class='Ref_To_Local'>prevspan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="dsa.c.html#LN1558"><span class='Ref_To_Local'>prevspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                    <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Push onto the head of the new fullness class list. */ 
</span>                <a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1555"><span class='Ref_To_Local'>tfclass</span></a><span class='Delimiter'>]; 
</span>                <a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1555"><span class='Ref_To_Local'>tfclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>                        <a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="dsa.c.html#LN1557"><span class='Ref_To_Local'>nextspan</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="dsa.c.html#LN1556"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1555"><span class='Ref_To_Local'>tfclass</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if tfclass&LT;fclass &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Advance to next span on list. */ 
</span>            <a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1559"><span class='Ref_To_Local'>next_span_pointer</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while DsaPointerIsValid(spa... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Stop now if we found a suitable block. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for fclass=2;fclass&LT;DSA_F... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * If there are no blocks that properly belong in fullness class 1, pick 
     * one from some other fullness class and move it there anyway, so that we 
     * have an allocation target.  Our last choice is to transfer a block 
     * that's almost empty (and might become completely empty soon if left 
     * alone), but even that is better than failing, which is what we must do 
     * if there are no blocks at all with freespace. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN276"><span class='Ref_to_Const'>DSA_FULLNESS_CLASSES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN386"><span class='Ref_to_Proto'>transfer_first_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1525"><span class='Ref_To_Local'>fclass</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <a href="dsa.c.html#LN386"><span class='Ref_to_Proto'>transfer_first_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We failed to find an existing span with free objects, so we need to 
     * allocate a new superblock and construct a new span to manage it. 
     * 
     * First, get a dsa_area_span object to describe the new superblock block 
     * ... unless this allocation is for a dsa_area_span object, in which case 
     * that's surely not going to work.  We handle that case by storing the 
     * span describing a block-of-spans inline. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN388"><span class='Ref_to_Proto'>alloc_object</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN103"><span class='Ref_to_Const'>DSA_PAGES_PER_SUPERBLOCK</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Find or create a segment and allocate the superblock. */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN398"><span class='Ref_to_Proto'>get_best_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN399"><span class='Ref_to_Proto'>make_new_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/freepage.h.html#LN92"><span class='Ref_to_Proto'>FreePageManagerGet</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="dsa.c.html#LN1527"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Compute the start of the superblock. */ 
</span>    <a href="dsa.c.html#LN1522"><span class='Ref_To_Local'>start_pointer</span></a> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN113"><span class='Ref_to_Macro'>DSA_MAKE_POINTER</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN380"><span class='Ref_to_Macro'>get_segment_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="dsa.c.html#LN1527"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If this is a block-of-spans, carve the descriptor right out of the 
     * allocated space. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We have a pointer into the segment.  We need to build a dsa_pointer 
         * from the segment index and offset into the segment. 
         */ 
</span>        <a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1522"><span class='Ref_To_Local'>start_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize span and pagemap. */ 
</span>    <a href="dsa.c.html#LN383"><span class='Ref_to_Proto'>init_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1518"><span class='Ref_to_Parameter'>pool</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1522"><span class='Ref_To_Local'>start_pointer</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1519"><span class='Ref_to_Parameter'>size_class</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1528"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1528"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN1526"><span class='Ref_To_Local'>npages</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1528"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN1529"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1527"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN1528"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1521"><span class='Ref_To_Local'>span_pointer</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ensure_active_superblock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return the segment map corresponding to a given segment index, mapping the 
 * segment in if necessary.  For internal segment book-keeping, this is called 
 * with the area lock held.  It is also called by dsa_free and dsa_get_address 
 * without any locking, relying on the fact they have a known live segment 
 * index and they always call check_for_freed_segments to ensures that any 
 * freed segment occupying the same slot is detached first. 
 */ 
</span><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>* 
</span><a name="LN1713"></a><span class='Declare_Function'>get_segment_by_index</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN958"><span class='Ref_to_Macro'>unlikely</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1717"></a>        <a href="../../../include/storage/dsm_impl.h.html#LN54"><span class='Ref_to_Typedef'>dsm_handle</span></a>  <span class='Declare_Local'>handle</span><span class='Delimiter'>; 
</span><a name="LN1718"></a>        <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span><span class='Delimiter'>; 
</span><a name="LN1719"></a>        <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we are reached by dsa_free or dsa_get_address, there must be at 
         * least one object allocated in the referenced segment.  Otherwise, 
         * their caller has a double-free or access-after-free bug, which we 
         * have no hope of detecting.  So we know it's safe to access this 
         * array slot without holding a lock; it won't change underneath us. 
         * Furthermore, we know that we can see the latest contents of the 
         * slot, as explained in check_for_freed_segments, which those 
         * functions call before arriving here. 
         */ 
</span>        <a href="dsa.c.html#LN1717"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* It's an error to try to access an unused slot. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1717"><span class='Ref_To_Local'>handle</span></a> <span class='Operator'>== </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>               <span class='String'>"dsa_area could not attach to a segment that has been freed"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1718"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN37"><span class='Ref_to_Proto'>dsm_attach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1717"><span class='Ref_To_Local'>handle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1718"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"dsa_area could not attach to segment"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/dsm.h.html#LN43"><span class='Ref_to_Proto'>dsm_pin_mapping</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1718"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= &</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1718"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1718"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= 
</span>            <span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>             <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>            <span class='Parentheses'>(</span><a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>             <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>             <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Remember the highest index this backend has ever mapped. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>) 
</span>            <a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1719"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN153"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== 
</span>               <span class='Parentheses'>(</span><a href="dsa.c.html#LN110"><span class='Ref_to_Const'>DSA_SEGMENT_HEADER_MAGIC</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if unlikely(area-&GT;segmen... &raquo; </span> 
 
    <span class='Control'>return</span> <span class='Operator'>&</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1713"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]; 
}</span><span class='Auto_Annotations'> &laquo; end get_segment_by_index &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a superblock to the free page manager.  If the underlying segment 
 * has become entirely free, then return it to the operating system. 
 * 
 * The appropriate pool lock must be held. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1774"></a><span class='Declare_Function'>destroy_superblock</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1776"></a>    <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1777"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>size_class</span> <span class='Operator'>= </span><a href="dsa.c.html#LN1776"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN200"><span class='Ref_to_Member'>size_class</span></a><span class='Delimiter'>; 
</span><a name="LN1778"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN117"><span class='Ref_to_Macro'>DSA_EXTRACT_SEGMENT_NUMBER</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1776"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove it from its fullness class list. */ 
</span>    <a href="dsa.c.html#LN394"><span class='Ref_to_Proto'>unlink_span</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1776"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note: Here we acquire the area lock while we already hold a per-pool 
     * lock.  We never hold the area lock and then take a pool lock, or we 
     * could deadlock. 
     */ 
</span>    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/freepage.h.html#LN94"><span class='Ref_to_Proto'>FreePageManagerPut</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, 
</span>                       <a href="dsa.c.html#LN120"><span class='Ref_to_Macro'>DSA_EXTRACT_OFFSET</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1776"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN198"><span class='Ref_to_Member'>start</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>, 
</span>                       <a href="dsa.c.html#LN1776"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN199"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Check if the segment is now entirely free. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN87"><span class='Ref_to_Macro'>fpm_largest</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN155"><span class='Ref_to_Member'>usable_pages</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1798"></a>        <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>index</span> <span class='Operator'>= </span><a href="dsa.c.html#LN380"><span class='Ref_to_Macro'>get_segment_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If it's not the segment with extra control data, free it. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1798"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Give it back to the OS, and allow other backends to detect that 
             * they need to detach. 
             */ 
</span>            <a href="dsa.c.html#LN397"><span class='Ref_to_Proto'>unlink_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN177"><span class='Ref_to_Member'>freed</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>&GT;= 
</span>                   <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN157"><span class='Ref_to_Member'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>-= 
</span>                <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN157"><span class='Ref_to_Member'>size</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/dsm.h.html#LN46"><span class='Ref_to_Proto'>dsm_unpin_segment</span></a><span class='Parentheses'>(</span><a href="../../../include/storage/dsm.h.html#LN52"><span class='Ref_to_Proto'>dsm_segment_handle</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="../../../include/storage/dsm.h.html#LN40"><span class='Ref_to_Proto'>dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1798"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Delimiter'>; 
</span>            <span class='Operator'>++</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN320"><span class='Ref_to_Member'>freed_segment_counter</span></a><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1778"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if index!=0 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fpm_largest(segment_m... &raquo; </span> 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Span-of-spans blocks store the span which describes them within the 
     * block itself, so freeing the storage implicitly frees the descriptor 
     * also.  If this is a block of any other type, we need to separately free 
     * the span object also.  This recursive call to dsa_free will acquire the 
     * span pool's lock.  We can't deadlock because the acquisition order is 
     * always some other pool and then the span pool. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1777"><span class='Ref_To_Local'>size_class</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN249"><span class='Ref_to_Const'>DSA_SCLASS_BLOCK_OF_SPANS</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/dsa.h.html#LN119"><span class='Ref_to_Proto'>dsa_free</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1774"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end destroy_superblock &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1837"></a><span class='Declare_Function'>unlink_span</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1841"></a>        <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1841"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1847"></a>        <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1847"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1853"></a>        <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pool</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN195"><span class='Ref_to_Member'>pool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1853"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1837"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end unlink_span &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN1860"></a><span class='Declare_Function'>add_span_to_fullness_class</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Delimiter'>, 
</span><a name="LN1861"></a>                           <a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Declare_Parameter'>span_pointer</span><span class='Delimiter'>, 
</span><a name="LN1862"></a>                           <span class='Keyword'>int </span><span class='Declare_Parameter'>fclass</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1864"></a>    <a href="dsa.c.html#LN284"><span class='Ref_to_Typedef'>dsa_area_pool</span></a> <span class='Operator'>*</span><span class='Declare_Local'>pool</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN195"><span class='Ref_to_Member'>pool</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN80"><span class='Ref_to_Macro'>DsaPointerIsValid</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1864"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1862"><span class='Ref_to_Parameter'>fclass</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1868"></a>        <a href="dsa.c.html#LN193"><span class='Ref_to_Typedef'>dsa_area_span</span></a> <span class='Operator'>*</span><span class='Declare_Local'>head</span> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN120"><span class='Ref_to_Proto'>dsa_get_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, 
</span>                                              <a href="dsa.c.html#LN1864"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1862"><span class='Ref_to_Parameter'>fclass</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1868"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1861"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN196"><span class='Ref_to_Member'>prevspan</span></a> <span class='Operator'>= </span><a href="../../../include/utils/dsa.h.html#LN77"><span class='Ref_to_Const'>InvalidDsaPointer</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN197"><span class='Ref_to_Member'>nextspan</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1864"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1862"><span class='Ref_to_Parameter'>fclass</span></a><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN1864"><span class='Ref_To_Local'>pool</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN289"><span class='Ref_to_Member'>spans</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1862"><span class='Ref_to_Parameter'>fclass</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1861"><span class='Ref_to_Parameter'>span_pointer</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN1860"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN205"><span class='Ref_to_Member'>fclass</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1862"><span class='Ref_to_Parameter'>fclass</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Detach from an area that was either created or attached to by this process. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1883"></a><span class='Declare_Function'>dsa_detach</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1885"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Detach from all segments. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1885"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN1885"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN1883"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN1885"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1883"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1885"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="../../../include/storage/dsm.h.html#LN40"><span class='Ref_to_Proto'>dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1883"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1885"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that 'detaching' (= detaching from DSM segments) doesn't include 
     * 'releasing' (= adjusting the reference count).  It would be nice to 
     * combine these operations, but client code might never get around to 
     * calling dsa_detach because of an error path, and a detach hook on any 
     * particular segment is too late to detach other segments in the area 
     * without risking a 'leak' warning in the non-error path. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* Free the backend-local area object. */ 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1883"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end dsa_detach &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Unlink a segment from the bin that contains it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1909"></a><span class='Declare_Function'>unlink_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>segment_map</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1913"></a>        <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1913"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1913"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a><span class='Delimiter'>] </span><span class='Operator'>== 
</span>               <a href="dsa.c.html#LN380"><span class='Ref_to_Macro'>get_segment_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>            <a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1927"></a>        <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
        <a href="dsa.c.html#LN1927"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN1927"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1909"><span class='Ref_to_Parameter'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end unlink_segment &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find a segment that could satisfy a request for 'npages' of contiguous 
 * memory, or return NULL if none can be found.  This may involve attaching to 
 * segments that weren't previously attached so that we can query their free 
 * pages map. 
 */ 
</span><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>* 
</span><a name="LN1941"></a><span class='Declare_Function'>get_best_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1943"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>bin</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start searching from the first bin that *might* have enough contiguous 
     * pages. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1943"><span class='Ref_To_Local'>bin</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN139"><span class='Ref_to_Macro'>contiguous_pages_to_segment_bin</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="dsa.c.html#LN1943"><span class='Ref_To_Local'>bin</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN132"><span class='Ref_to_Const'>DSA_NUM_SEGMENT_BINS</span></a><span class='Delimiter'>; 
</span>         <span class='Operator'>++</span><a href="dsa.c.html#LN1943"><span class='Ref_To_Local'>bin</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The minimum contiguous size that any segment in this bin should 
         * have.  We'll re-bin if we see segments with fewer. 
         */ 
</span><a name="LN1959"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>threshold</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1943"><span class='Ref_To_Local'>bin</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1960"></a>        <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>segment_index</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Search this bin for a segment with enough contiguous space. */ 
</span>        <a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1943"><span class='Ref_To_Local'>bin</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1966"></a>            <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span><a name="LN1967"></a>            <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>next_segment_index</span><span class='Delimiter'>; 
</span><a name="LN1968"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>contiguous_pages</span><span class='Delimiter'>; 
</span> 
            <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1967"><span class='Ref_To_Local'>next_segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>; 
</span>            <a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN87"><span class='Ref_to_Macro'>fpm_largest</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Not enough for the request, still enough for this bin. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&GT;= </span><a href="dsa.c.html#LN1959"><span class='Ref_To_Local'>threshold</span></a> <span class='Operator'>&& </span><a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1967"><span class='Ref_To_Local'>next_segment_index</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Re-bin it if it's no longer in the appropriate bin. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN1959"><span class='Ref_To_Local'>threshold</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1984"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>new_bin</span><span class='Delimiter'>; 
</span> 
                <a href="dsa.c.html#LN1984"><span class='Ref_To_Local'>new_bin</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN139"><span class='Ref_to_Macro'>contiguous_pages_to_segment_bin</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Remove it from its current bin. */ 
</span>                <a href="dsa.c.html#LN397"><span class='Ref_to_Proto'>unlink_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Push it onto the front of its new bin. */ 
</span>                <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= 
</span>                    <a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1984"><span class='Ref_To_Local'>new_bin</span></a><span class='Delimiter'>]; 
</span>                <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1984"><span class='Ref_To_Local'>new_bin</span></a><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN1984"><span class='Ref_To_Local'>new_bin</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1999"></a>                    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
                    <a href="dsa.c.html#LN1999"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, 
</span>                                                <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN1999"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN1984"><span class='Ref_To_Local'>new_bin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="dsa.c.html#LN1999"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * But fall through to see if it's enough to satisfy this 
                 * request anyway.... 
                 */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if contiguous_pages&LT;thre... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Check if we are done. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN1968"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&GT;= </span><a href="dsa.c.html#LN1941"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>) 
</span>                <span class='Control'>return</span> <a href="dsa.c.html#LN1966"><span class='Ref_To_Local'>segment_map</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Continue searching the same bin. */ 
</span>            <a href="dsa.c.html#LN1960"><span class='Ref_To_Local'>segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN1967"><span class='Ref_To_Local'>next_segment_index</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while segment_index!=DSA_SE... &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for bin=contiguous_pages_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Not found. */ 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end get_best_segment &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a new segment that can handle at least requested_pages.  Returns 
 * NULL if the requested total size limit or maximum allowed number of 
 * segments would be exceeded. 
 */ 
</span><span class='Keyword'>static </span><a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>* 
</span><a name="LN2032"></a><span class='Declare_Function'>make_new_segment</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>requested_pages</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2034"></a>    <a href="dsa.c.html#LN123"><span class='Ref_to_Typedef'>dsa_segment_index</span></a> <span class='Declare_Local'>new_index</span><span class='Delimiter'>; 
</span><a name="LN2035"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>metadata_bytes</span><span class='Delimiter'>; 
</span><a name="LN2036"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>total_size</span><span class='Delimiter'>; 
</span><a name="LN2037"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>total_pages</span><span class='Delimiter'>; 
</span><a name="LN2038"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>usable_pages</span><span class='Delimiter'>; 
</span><a name="LN2039"></a>    <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment_map</span><span class='Delimiter'>; 
</span><a name="LN2040"></a>    <a href="../../storage/ipc/dsm.c.html#LN66"><span class='Ref_to_Struct'>dsm_segment</span></a> <span class='Operator'>*</span><span class='Declare_Local'>segment</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/storage/lwlock.h.html#LN151"><span class='Ref_to_Proto'>LWLockHeldByMe</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Find a segment slot that is not in use (linearly for now). */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>] </span><span class='Operator'>== </span><a href="../../../include/storage/dsm.h.html#LN22"><span class='Ref_to_Const'>DSM_HANDLE_INVALID</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN93"><span class='Ref_to_Const'>DSA_MAX_SEGMENTS</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the total size limit is already exceeded, then we exit early and 
     * avoid arithmetic wraparound in the unsigned expressions below. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>&GT;= 
</span>        <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The size should be at least as big as requested, and at least big 
     * enough to follow a geometric series that approximately doubles the 
     * total storage each time we create a new segment.  We use geometric 
     * growth because the underlying DSM system isn't designed for large 
     * numbers of segments (otherwise we might even consider just using one 
     * DSM segment for each large allocation and for each superblock, and then 
     * we wouldn't need to use FreePageManager). 
     * 
     * We decide on a total segment size first, so that we produce tidy 
     * power-of-two sized segments.  This is a good property to have if we 
     * move to huge pages in the future.  Then we work back to the number of 
     * pages we can fit. 
     */ 
</span>    <a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN67"><span class='Ref_to_Const'>DSA_INITIAL_SEGMENT_SIZE</span></a> <span class='Operator'>* 
</span>        <span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a><span class='Parentheses'>) </span><span class='Number'>1</span> <span class='Operator'>&LT;&LT; </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a> <span class='Operator'>/ </span><a href="dsa.c.html#LN76"><span class='Ref_to_Const'>DSA_NUM_SEGMENTS_AT_EACH_SIZE</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN100"><span class='Ref_to_Const'>DSA_MAX_SEGMENT_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Delimiter'>, 
</span>                     <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a> <span class='Operator'>- 
</span>                     <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="dsa.c.html#LN2037"><span class='Ref_To_Local'>total_pages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="dsa.c.html#LN2037"><span class='Ref_To_Local'>total_pages</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Add padding up to next page boundary. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>- </span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* See if that is enough... */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>requested_pages</span></a> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We'll make an odd-sized segment, working forward from the requested 
         * number of pages. 
         */ 
</span>        <a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>requested_pages</span></a><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>= 
</span>            <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>            <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>            <a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Add padding up to next page boundary. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>+= </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>% </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>+ </span><a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Is that too large for dsa_pointer's addressing scheme? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN100"><span class='Ref_to_Const'>DSA_MAX_SEGMENT_SIZE</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Would that exceed the limit? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a> <span class='Operator'>&GT; </span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a> <span class='Operator'>- 
</span>            <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if requested_pages&GT;usabl... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Create the segment. */ 
</span>    <a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN36"><span class='Ref_to_Proto'>dsm_create</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/dsm.h.html#LN45"><span class='Ref_to_Proto'>dsm_pin_segment</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN359"><span class='Ref_to_Member'>mapping_pinned</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/dsm.h.html#LN43"><span class='Ref_to_Proto'>dsm_pin_mapping</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Store the handle in shared memory to be found by index. */ 
</span>    <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN304"><span class='Ref_to_Member'>segment_handles</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>] </span><span class='Operator'>= 
</span>        <a href="../../../include/storage/dsm.h.html#LN52"><span class='Ref_to_Proto'>dsm_segment_handle</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Track the highest segment index in the history of the area. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN314"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN314"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Track the highest segment index this backend has ever mapped. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>&LT; </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Parentheses'>) 
</span>        <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Track total size of all segments. */ 
</span>    <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>+= </span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN310"><span class='Ref_to_Member'>total_segment_size</span></a> <span class='Operator'>&LT;= 
</span>           <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN312"><span class='Ref_to_Member'>max_total_segment_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Build a segment map for this segment in this backend. */ 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a> <span class='Operator'>= &</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><a href="../../../include/storage/dsm.h.html#LN50"><span class='Ref_to_Proto'>dsm_segment_address</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2040"><span class='Ref_To_Local'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN344"><span class='Ref_to_Member'>pagemap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/dsa.h.html#LN61"><span class='Ref_to_Typedef'>dsa_pointer</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN150"><span class='Ref_to_Typedef'>dsa_segment_header</span></a><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>         <a href="../../../include/c.h.html#LN587"><span class='Ref_to_Macro'>MAXALIGN</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up the free page map. */ 
</span>    <a href="../../../include/utils/freepage.h.html#LN91"><span class='Ref_to_Proto'>FreePageManagerInitialize</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/freepage.h.html#LN94"><span class='Ref_to_Proto'>FreePageManagerPut</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN343"><span class='Ref_to_Member'>fpm</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN2035"><span class='Ref_To_Local'>metadata_bytes</span></a> <span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Delimiter'>, 
</span>                       <a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Set up the segment header and put it in the appropriate bin. */ 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN153"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN110"><span class='Ref_to_Const'>DSA_SEGMENT_HEADER_MAGIC</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN302"><span class='Ref_to_Member'>handle</span></a> <span class='Operator'>^ </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN155"><span class='Ref_to_Member'>usable_pages</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN157"><span class='Ref_to_Member'>size</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2036"><span class='Ref_To_Local'>total_size</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN139"><span class='Ref_to_Macro'>contiguous_pages_to_segment_bin</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2038"><span class='Ref_To_Local'>usable_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a><span class='Delimiter'>]; 
</span>    <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN177"><span class='Ref_to_Member'>freed</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN306"><span class='Ref_to_Member'>segment_bins</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN126"><span class='Ref_to_Const'>DSA_SEGMENT_INDEX_NONE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2177"></a>        <a href="dsa.c.html#LN338"><span class='Ref_to_Typedef'>dsa_segment_map</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span> <span class='Operator'>= 
</span>        <a href="dsa.c.html#LN391"><span class='Ref_to_Proto'>get_segment_by_index</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2032"><span class='Ref_to_Parameter'>area</span></a><span class='Delimiter'>, </span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN169"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN2177"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a> <span class='Operator'>== </span><a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN171"><span class='Ref_to_Member'>bin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN2177"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN163"><span class='Ref_to_Member'>prev</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2034"><span class='Ref_To_Local'>new_index</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="dsa.c.html#LN2039"><span class='Ref_To_Local'>segment_map</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end make_new_segment &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Check if any segments have been freed by destroy_superblock, so we can 
 * detach from them in this backend.  This function is called by 
 * dsa_get_address and dsa_free to make sure that a dsa_pointer they have 
 * received can be resolved to the correct segment. 
 * 
 * The danger we want to defend against is that there could be an old segment 
 * mapped into a given slot in this backend, and the dsa_pointer they have 
 * might refer to some new segment in the same slot.  So those functions must 
 * be sure to process all instructions to detach from a freed segment that had 
 * been generated by the time this process received the dsa_pointer, before 
 * they call get_segment_by_index. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN2201"></a><span class='Declare_Function'>check_for_freed_segments</span><span class='Parentheses'>(</span><a href="dsa.c.html#LN353"><span class='Ref_to_Struct'>dsa_area</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>area</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2203"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>freed_segment_counter</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Any other process that has freed a segment has incremented 
     * free_segment_counter while holding an LWLock, and that must precede any 
     * backend creating a new segment in the same slot while holding an 
     * LWLock, and that must precede the creation of any dsa_pointer pointing 
     * into the new segment which might reach us here, and the caller must 
     * have sent the dsa_pointer to this process using appropriate memory 
     * synchronization (some kind of locking or atomic primitive or system 
     * call).  So all we need to do on the reading side is ask for the load of 
     * freed_segment_counter to follow the caller's load of the dsa_pointer it 
     * has, and we can be sure to detect any segments that had been freed as 
     * of the time that the dsa_pointer reached this process. 
     */ 
</span>    <a href="../../../include/port/atomics.h.html#LN160"><span class='Ref_to_Macro'>pg_read_barrier</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="dsa.c.html#LN2203"><span class='Ref_To_Local'>freed_segment_counter</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN356"><span class='Ref_to_Member'>control</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN320"><span class='Ref_to_Member'>freed_segment_counter</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN958"><span class='Ref_to_Macro'>unlikely</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN373"><span class='Ref_to_Member'>freed_segment_counter</span></a> <span class='Operator'>!= </span><a href="dsa.c.html#LN2203"><span class='Ref_To_Local'>freed_segment_counter</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2222"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check all currently mapped segments to find what's been freed. */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN370"><span class='Ref_to_Member'>high_segment_index</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>                <a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN177"><span class='Ref_to_Member'>freed</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/dsm.h.html#LN40"><span class='Ref_to_Proto'>dsm_detach</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN340"><span class='Ref_to_Member'>segment</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN342"><span class='Ref_to_Member'>header</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN367"><span class='Ref_to_Member'>segment_maps</span></a><span class='Delimiter'>[</span><a href="dsa.c.html#LN2222"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="dsa.c.html#LN341"><span class='Ref_to_Member'>mapped_address</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN142"><span class='Ref_to_Macro'>DSA_AREA_LOCK</span></a><span class='Parentheses'>(</span><a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="dsa.c.html#LN2201"><span class='Ref_to_Parameter'>area</span></a><span class='Operator'>-&GT;</span><a href="dsa.c.html#LN373"><span class='Ref_to_Member'>freed_segment_counter</span></a> <span class='Operator'>= </span><a href="dsa.c.html#LN2203"><span class='Ref_To_Local'>freed_segment_counter</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if unlikely(area-&GT;freed_... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end check_for_freed_segments &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>