<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\mmgr\freepage.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\mmgr\freepage.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * freepage.c 
 *    Management of free memory pages. 
 * 
 * The intention of this code is to provide infrastructure for memory 
 * allocators written specifically for PostgreSQL.  At least in the case 
 * of dynamic shared memory, we can't simply use malloc() or even 
 * relatively thin wrappers like palloc() which sit on top of it, because 
 * no allocator built into the operating system will deal with relative 
 * pointers.  In the future, we may find other cases in which greater 
 * control over our own memory management seems desirable. 
 * 
 * A FreePageManager keeps track of which 4kB pages of memory are currently 
 * unused from the point of view of some higher-level memory allocator. 
 * Unlike a user-facing allocator such as palloc(), a FreePageManager can 
 * only allocate and free in units of whole pages, and freeing an 
 * allocation can only be done given knowledge of its length in pages. 
 * 
 * Since a free page manager has only a fixed amount of dedicated memory, 
 * and since there is no underlying allocator, it uses the free pages 
 * it is given to manage to store its bookkeeping data.  It keeps multiple 
 * freelists of runs of pages, sorted by the size of the run; the head of 
 * each freelist is stored in the FreePageManager itself, and the first 
 * page of each run contains a relative pointer to the next run. See 
 * FreePageManagerGetInternal for more details on how the freelists are 
 * managed. 
 * 
 * To avoid memory fragmentation, it's important to consolidate adjacent 
 * spans of pages whenever possible; otherwise, large allocation requests 
 * might not be satisfied even when sufficient contiguous space is 
 * available.  Therefore, in addition to the freelists, we maintain an 
 * in-memory btree of free page ranges ordered by page number.  If a 
 * range being freed precedes or follows a range that is already free, 
 * the existing range is extended; if it exactly bridges the gap between 
 * free ranges, then the two existing ranges are consolidated with the 
 * newly-freed range to form one great big range of free pages. 
 * 
 * When there is only one range of free pages, the btree is trivial and 
 * is stored within the FreePageManager proper; otherwise, pages are 
 * allocated from the area under management as needed.  Even in cases 
 * where memory fragmentation is very severe, only a tiny fraction of 
 * the pages under management are consumed by this btree. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/mmgr/freepage.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/stringinfo.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"utils/freepage.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/relptr.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Magic numbers to identify various page types */ 
</span><a name="LN62"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FREE_PAGE_SPAN_LEADER_MAGIC</span>     <span class='Number'>0xea4020f0</span> 
<a name="LN63"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FREE_PAGE_LEAF_MAGIC</span>            <span class='Number'>0x98eae728</span> 
<a name="LN64"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FREE_PAGE_INTERNAL_MAGIC</span>        <span class='Number'>0x19aa32c9</span> 
 
<span class='Comment_Multi_Line'>/* Doubly linked list of spans of free pages; stored in first page of span. */ 
</span><a name="LN67"></a><span class='Control'>struct</span> <span class='Declare_Struct'>FreePageSpanLeader</span> 
<span class='Delimiter'>{ 
</span><a name="LN69"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>magic</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* always FREE_PAGE_SPAN_LEADER_MAGIC */ 
</span><a name="LN70"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>npages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* number of pages in span */ 
</span><a name="LN71"></a>    RelptrFreePageSpanLeader <span class='Declare_Member'>prev</span><span class='Delimiter'>; 
</span><a name="LN72"></a>    RelptrFreePageSpanLeader <span class='Declare_Member'>next</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* Common header for btree leaf and internal pages. */ 
</span><a name="LN76"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FreePageBtreeHeader</span> 
<span class='Delimiter'>{ 
</span><a name="LN78"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>magic</span><span class='Delimiter'>;</span>          <span class='Comment_Multi_Line'>/* FREE_PAGE_LEAF_MAGIC or 
                                 * FREE_PAGE_INTERNAL_MAGIC */ 
</span><a name="LN80"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>nused</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* number of items used */ 
</span><a name="LN81"></a>    RelptrFreePageBtree <span class='Declare_Member'>parent</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* uplink */ 
</span><a name="LN82"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>FreePageBtreeHeader</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Internal key; points to next level of btree. */ 
</span><a name="LN85"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FreePageBtreeInternalKey</span> 
<span class='Delimiter'>{ 
</span><a name="LN87"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>first_page</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* low bound for keys on child page */ 
</span><a name="LN88"></a>    RelptrFreePageBtree <span class='Declare_Member'>child</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* downlink */ 
</span><a name="LN89"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>FreePageBtreeInternalKey</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Leaf key; no payload data. */ 
</span><a name="LN92"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FreePageBtreeLeafKey</span> 
<span class='Delimiter'>{ 
</span><a name="LN94"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>first_page</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* first page in span */ 
</span><a name="LN95"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>npages</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* number of pages in span */ 
</span><a name="LN96"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>FreePageBtreeLeafKey</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Work out how many keys will fit on a page. */ 
</span><a name="LN99"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FPM_ITEMS_PER_INTERNAL_PAGE</span> <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN76"><span class='Ref_to_Struct'>FreePageBtreeHeader</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ \ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>))</span> 
<a name="LN102"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>FPM_ITEMS_PER_LEAF_PAGE</span> <span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a> <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN76"><span class='Ref_to_Struct'>FreePageBtreeHeader</span></a><span class='Parentheses'>))</span> <span class='Operator'>/ \ 
</span>        <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>))</span> 
 
<span class='Comment_Multi_Line'>/* A btree page of either sort */ 
</span><a name="LN107"></a><span class='Control'>struct</span> <span class='Declare_Struct'>FreePageBtree</span> 
<span class='Delimiter'>{ 
</span><a name="LN109"></a>    <a href="freepage.c.html#LN76"><span class='Ref_to_Struct'>FreePageBtreeHeader</span></a> <span class='Declare_Member'>hdr</span><span class='Delimiter'>; 
</span>    <span class='Control'>union</span> 
    <span class='Delimiter'>{ 
</span><a name="LN112"></a>        <a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a> <span class='Declare_Member'>internal_key</span><span class='Delimiter'>[</span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Delimiter'>]; 
</span><a name="LN113"></a>        <a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a> <span class='Declare_Member'>leaf_key</span><span class='Delimiter'>[</span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Delimiter'>]; 
</span><a name="LN114"></a>    <span class='Delimiter'>}</span>           <span class='Declare_Member'>u</span><span class='Delimiter'>; 
}; 
</span> 
<span class='Comment_Multi_Line'>/* Results of a btree search */ 
</span><a name="LN118"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>FreePageBtreeSearchResult</span> 
<span class='Delimiter'>{ 
</span><a name="LN120"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Member'>page</span><span class='Delimiter'>; 
</span><a name="LN121"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Member'>index</span><span class='Delimiter'>; 
</span><a name="LN122"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>found</span><span class='Delimiter'>; 
</span><a name="LN123"></a>    <span class='Keyword'>unsigned</span>    <span class='Declare_Member'>split_pages</span><span class='Delimiter'>; 
</span><a name="LN124"></a>} <span class='Declare_Typedef'>FreePageBtreeSearchResult</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Helper functions */ 
</span><a name="LN127"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeAdjustAncestorKeys</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, 
</span><a name="LN128"></a>                                <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN129"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageBtreeCleanup</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN130"></a><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>FreePageBtreeFindLeftSibling</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, 
</span><a name="LN131"></a>                             <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN132"></a><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>FreePageBtreeFindRightSibling</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, 
</span><a name="LN133"></a>                              <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN134"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageBtreeFirstKey</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN135"></a><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>FreePageBtreeGetRecycled</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN136"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeInsertInternal</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, 
</span><a name="LN137"></a>                          <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>child</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN138"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeInsertLeaf</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN139"></a>                        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN140"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeRecycle</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN141"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeRemove</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, 
</span><a name="LN142"></a>                    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN143"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeRemovePage</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN144"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeSearch</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, 
</span><a name="LN145"></a>                    <a href="freepage.c.html#LN118"><span class='Ref_to_Struct'>FreePageBtreeSearchResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN146"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageBtreeSearchInternal</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN147"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageBtreeSearchLeaf</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN148"></a><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>FreePageBtreeSplitPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, 
</span><a name="LN149"></a>                       <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageBtreeUpdateParentPointers</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN151"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageManagerDumpBtree</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, 
</span><a name="LN152"></a>                         <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN153"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageManagerDumpSpans</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, 
</span><a name="LN154"></a>                         <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>expected_pages</span><span class='Delimiter'>, 
</span><a name="LN155"></a>                         <a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN156"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>FreePageManagerGetInternal</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, 
</span><a name="LN157"></a>                           <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>first_page</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN158"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageManagerPutInternal</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, 
</span><a name="LN159"></a>                           <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>soft</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN160"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePagePopSpanLeader</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN161"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePagePushSpanLeader</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, 
</span><a name="LN162"></a>                       <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN163"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>FreePageManagerLargestContiguous</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN164"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreePageManagerUpdateLargest</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#if</span> FPM_EXTRA_ASSERTS 
<a name="LN167"></a><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Prototype'>sum_free_pages</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a new, empty free page manager. 
 * 
 * 'fpm' should reference caller-provided memory large enough to contain a 
 * FreePageManager.  We'll initialize it here. 
 * 
 * 'base' is the address to which all pointers are relative.  When managing 
 * a dynamic shared memory segment, it should normally be the base of the 
 * segment.  When managing backend-private memory, it can be either NULL or, 
 * if managing a single contiguous extent of memory, the start of that extent. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN182"></a><span class='Declare_Function'>FreePageManagerInitialize</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN184"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN49"><span class='Ref_to_Member'>self</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN57"><span class='Ref_to_Member'>contiguous_pages_dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><span class='Directive'>#ifdef</span> FPM_EXTRA_ASSERTS 
    <a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN184"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN184"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Delimiter'>; </span><a href="freepage.c.html#LN184"><span class='Ref_To_Local'>f</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN182"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN184"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>], </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerInitialize &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a run of pages of the given length from the free page manager. 
 * The return value indicates whether we were able to satisfy the request; 
 * if true, the first page of the allocation is stored in *first_page. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN209"></a><span class='Declare_Function'>FreePageManagerGet</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>first_page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN211"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN212"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>contiguous_pages</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN211"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN156"><span class='Ref_to_Proto'>FreePageManagerGetInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's a bit counterintuitive, but allocating pages can actually create 
     * opportunities for cleanup that create larger ranges.  We might pull a 
     * key out of the btree that enables the item at the head of the btree 
     * recycle list to be inserted; and then if there are more items behind it 
     * one of those might cause two currently-separated ranges to merge, 
     * creating a single range of contiguous pages larger than any that 
     * existed previously.  It might be worth trying to improve the cleanup 
     * algorithm to avoid such corner cases, but for now we just notice the 
     * condition and do the appropriate reporting. 
     */ 
</span>    <a href="freepage.c.html#LN212"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN129"><span class='Ref_to_Proto'>FreePageBtreeCleanup</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN212"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN212"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * FreePageManagerGetInternal may have set contiguous_pages_dirty. 
     * Recompute contigous_pages if so. 
     */ 
</span>    <a href="freepage.c.html#LN164"><span class='Ref_to_Proto'>FreePageManagerUpdateLargest</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> FPM_EXTRA_ASSERTS 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN211"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>-= </span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN167"><span class='Ref_to_Proto'>sum_free_pages</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN163"><span class='Ref_to_Proto'>FreePageManagerLargestContiguous</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN209"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN211"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerGet &raquo; </span> 
 
<span class='Directive'>#ifdef</span> FPM_EXTRA_ASSERTS 
<span class='Keyword'>static void 
</span><a name="LN251"></a><span class='Declare_Function'>sum_free_pages_recurse</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN253"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a> <span class='Operator'>|| 
</span>           <a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>++*</span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>sum</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN260"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span> 
 
        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN260"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN260"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN260"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN265"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN265"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN253"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN260"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN250"><span class='Ref_to_Func'>sum_free_pages_recurse</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN265"><span class='Ref_To_Local'>child</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN251"><span class='Ref_to_Parameter'>sum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end sum_free_pages_recurse &raquo; </span> 
<span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN273"></a><span class='Declare_Function'>sum_free_pages</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN275"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>recycle</span><span class='Delimiter'>; 
</span><a name="LN276"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN277"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>sum</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN278"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>list</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Count the spans by scanning the freelists. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN278"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN278"><span class='Ref_To_Local'>list</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN278"><span class='Ref_To_Local'>list</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN278"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN286"></a>            <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>candidate</span> <span class='Operator'>= 
</span>            <a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN276"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN278"><span class='Ref_To_Local'>list</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>do</span> 
            <span class='Delimiter'>{ 
</span>                <a href="freepage.c.html#LN277"><span class='Ref_To_Local'>sum</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN286"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN286"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN276"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN286"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN286"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Count btree internal pages. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN300"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN276"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN250"><span class='Ref_to_Func'>sum_free_pages_recurse</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN300"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN277"><span class='Ref_To_Local'>sum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Count the recycle list. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN275"><span class='Ref_To_Local'>recycle</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN276"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN273"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>         <a href="freepage.c.html#LN275"><span class='Ref_To_Local'>recycle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>         <a href="freepage.c.html#LN275"><span class='Ref_To_Local'>recycle</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN276"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN275"><span class='Ref_To_Local'>recycle</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN275"><span class='Ref_To_Local'>recycle</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>++</span><a href="freepage.c.html#LN277"><span class='Ref_To_Local'>sum</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN277"><span class='Ref_To_Local'>sum</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end sum_free_pages &raquo; </span> 
<span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Compute the size of the largest run of pages that the user could 
 * successfully get. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN323"></a><span class='Declare_Function'>FreePageManagerLargestContiguous</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN325"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span><span class='Delimiter'>; 
</span><a name="LN326"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>largest</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN325"><span class='Ref_To_Local'>base</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN323"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN326"><span class='Ref_To_Local'>largest</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN323"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN332"></a>        <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>candidate</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN325"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN323"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>do</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN326"><span class='Ref_To_Local'>largest</span></a><span class='Parentheses'>) 
</span>                <a href="freepage.c.html#LN326"><span class='Ref_To_Local'>largest</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN325"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN332"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN344"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>do</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Operator'>--</span><a href="freepage.c.html#LN344"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN323"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN344"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="freepage.c.html#LN326"><span class='Ref_To_Local'>largest</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN344"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN344"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN326"><span class='Ref_To_Local'>largest</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerLargestContiguous &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Recompute the size of the largest run of pages that the user could 
 * successfully get, if it has been marked dirty. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN365"></a><span class='Declare_Function'>FreePageManagerUpdateLargest</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="freepage.c.html#LN365"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN57"><span class='Ref_to_Member'>contiguous_pages_dirty</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN365"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN163"><span class='Ref_to_Proto'>FreePageManagerLargestContiguous</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN365"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN365"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN57"><span class='Ref_to_Member'>contiguous_pages_dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Transfer a run of pages to the free page manager. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN378"></a><span class='Declare_Function'>FreePageManagerPut</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN380"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>contiguous_pages</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Record the new pages. */ 
</span>    <a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>= 
</span>        <a href="freepage.c.html#LN158"><span class='Ref_to_Proto'>FreePageManagerPutInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If the new range we inserted into the page manager was contiguous with 
     * an existing range, it may have opened up cleanup opportunities. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN394"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>cleanup_contiguous_pages</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN394"><span class='Ref_To_Local'>cleanup_contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN129"><span class='Ref_to_Proto'>FreePageBtreeCleanup</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN394"><span class='Ref_To_Local'>cleanup_contiguous_pages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN394"><span class='Ref_To_Local'>cleanup_contiguous_pages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* See if we now have a new largest chunk. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN380"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The earlier call to FreePageManagerPutInternal may have set 
     * contiguous_pages_dirty if it needed to allocate internal pages, so 
     * recompute contiguous_pages if necessary. 
     */ 
</span>    <a href="freepage.c.html#LN164"><span class='Ref_to_Proto'>FreePageManagerUpdateLargest</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> FPM_EXTRA_ASSERTS 
    <a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN61"><span class='Ref_to_Member'>free_pages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN167"><span class='Ref_to_Proto'>sum_free_pages</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN163"><span class='Ref_to_Proto'>FreePageManagerLargestContiguous</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN378"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerPut &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Produce a debugging dump of the state of a free page manager. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN423"></a><span class='Declare_Function'>FreePageManagerDump</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN425"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN426"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN427"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>recycle</span><span class='Delimiter'>; 
</span><a name="LN428"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>dumped_any_freelist</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN429"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Initialize output buffer. */ 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Dump general stuff. */ 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"metadata: self %zu max contiguous pages = %zu\n"</span><span class='Delimiter'>, 
</span>                     <a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN49"><span class='Ref_to_Member'>self</span></a><span class='Operator'>.</span>relptr_off<span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Dump btree. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN441"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span><span class='Delimiter'>; 
</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"btree depth %u:\n"</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN441"><span class='Ref_To_Local'>root</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN425"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN151"><span class='Ref_to_Proto'>FreePageManagerDumpBtree</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN441"><span class='Ref_To_Local'>root</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"singleton: %zu(%zu)\n"</span><span class='Delimiter'>, 
</span>                         <a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Dump btree recycle list. */ 
</span>    <a href="freepage.c.html#LN427"><span class='Ref_To_Local'>recycle</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN425"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN427"><span class='Ref_To_Local'>recycle</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"btree recycle:"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN153"><span class='Ref_to_Proto'>FreePageManagerDumpSpans</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN427"><span class='Ref_To_Local'>recycle</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Dump free lists. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN464"></a>        <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="freepage.c.html#LN428"><span class='Ref_To_Local'>dumped_any_freelist</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"freelists:\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN428"><span class='Ref_To_Local'>dumped_any_freelist</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  %zu:"</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN464"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN425"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN153"><span class='Ref_to_Proto'>FreePageManagerDumpSpans</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN423"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN464"><span class='Ref_To_Local'>span</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN429"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* And return result to caller. */ 
</span>    <span class='Control'>return</span> <a href="freepage.c.html#LN426"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerDump &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * The first_page value stored at index zero in any non-root page must match 
 * the first_page value stored in its parent at the index which points to that 
 * page.  So when the value stored at index zero in a btree page changes, we've 
 * got to walk up the tree adjusting ancestor keys until we reach an ancestor 
 * where that key isn't index zero.  This function should be called after 
 * updating the first key on the target page; it will propagate the change 
 * upward as far as needed. 
 * 
 * We assume here that the first key on the page has not changed enough to 
 * require changes in the ordering of keys on its ancestor pages.  Thus, 
 * if we search the parent page for the first key greater than or equal to 
 * the first key on the current page, the downlink to this page will be either 
 * the exact index returned by the search (if the first key decreased) 
 * or one less (if the first key increased). 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN500"></a><span class='Declare_Function'>FreePageBtreeAdjustAncestorKeys</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN502"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN503"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN504"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span><a name="LN505"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* This might be either a leaf or an internal page. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN503"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN503"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="freepage.c.html#LN505"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN500"><span class='Ref_to_Parameter'>btp</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Loop until we find an ancestor that does not require adjustment. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN525"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>s</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN502"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN505"><span class='Ref_To_Local'>child</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN503"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Key is either at index s or index s-1; figure out which. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>--</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN540"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>check</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN540"><span class='Ref_To_Local'>check</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN502"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN540"><span class='Ref_To_Local'>check</span></a> <span class='Operator'>!= </span><a href="freepage.c.html#LN505"><span class='Ref_To_Local'>child</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Operator'>--</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifdef</span> USE_ASSERT_CHECKING 
        <span class='Comment_Multi_Line'>/* Debugging double-check. */ 
</span>        <span class='Delimiter'>{ 
</span><a name="LN553"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>check</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN553"><span class='Ref_To_Local'>check</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN502"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN505"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN553"><span class='Ref_To_Local'>check</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
        <span class='Comment_Multi_Line'>/* Update the parent key. */ 
</span>        <a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN503"><span class='Ref_To_Local'>first_page</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If this is the first key in the parent, go up another level; else 
         * done. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN525"><span class='Ref_To_Local'>s</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN505"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN504"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeAdjustAncestorKeys &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Attempt to reclaim space from the free-page btree.  The return value is 
 * the largest range of contiguous pages created by the cleanup operation. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN579"></a><span class='Declare_Function'>FreePageBtreeCleanup</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN581"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN582"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>max_contiguous_pages</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Attempt to shrink the depth of the btree. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN587"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If the root contains only one key, reduce depth by one. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Shrink depth of tree by one. */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Operator'>--</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* If root is a leaf, convert only entry to singleton range. */ 
</span>                <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span><a name="LN604"></a>                <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newroot</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* If root is an internal page, make only child the root. */ 
</span>                <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN604"><span class='Ref_To_Local'>newroot</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN604"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="freepage.c.html#LN140"><span class='Ref_to_Proto'>FreePageBtreeRecycle</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if root-&GT;hdr.nused==1 &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>== </span><span class='Number'>2</span> <span class='Operator'>&& 
</span>                 <a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN617"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>end_of_first</span><span class='Delimiter'>; 
</span><a name="LN618"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>start_of_second</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN617"><span class='Ref_To_Local'>end_of_first</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+ 
</span>                <a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN618"><span class='Ref_To_Local'>start_of_second</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN617"><span class='Ref_To_Local'>end_of_first</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>== </span><a href="freepage.c.html#LN618"><span class='Ref_To_Local'>start_of_second</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN626"></a>                <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>root_page</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN617"><span class='Ref_To_Local'>end_of_first</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN626"><span class='Ref_To_Local'>root_page</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>+ 
</span>                        <a href="freepage.c.html#LN587"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>, 
</span>                                           <a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN582"><span class='Ref_To_Local'>max_contiguous_pages</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN582"><span class='Ref_To_Local'>max_contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if end_of_first+1==start... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* Whether it worked or not, it's time to stop. */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if root-&GT;hdr.nused==2&&r... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Nothing more to do.  Stop. */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while !relptr_is_null(fpm-&GT;... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Attempt to free recycled btree pages.  We skip this if releasing the 
     * recycled page would require a btree page split, because the page we're 
     * trying to recycle would be consumed by the split, which would be 
     * counterproductive. 
     * 
     * We also currently only ever attempt to recycle the first page on the 
     * list; that could be made more aggressive, but it's not clear that the 
     * complexity would be worthwhile. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN667"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>btp</span><span class='Delimiter'>; 
</span><a name="LN668"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN669"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>contiguous_pages</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN667"><span class='Ref_To_Local'>btp</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN135"><span class='Ref_to_Proto'>FreePageBtreeGetRecycled</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN668"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN581"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN667"><span class='Ref_To_Local'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN669"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN158"><span class='Ref_to_Proto'>FreePageManagerPutInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN668"><span class='Ref_To_Local'>first_page</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN669"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="freepage.c.html#LN140"><span class='Ref_to_Proto'>FreePageBtreeRecycle</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN579"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN668"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN669"><span class='Ref_To_Local'>contiguous_pages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN582"><span class='Ref_To_Local'>max_contiguous_pages</span></a><span class='Parentheses'>) 
</span>                <a href="freepage.c.html#LN582"><span class='Ref_To_Local'>max_contiguous_pages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN669"><span class='Ref_To_Local'>contiguous_pages</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while fpm-&GT;btree_recycle_co... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="freepage.c.html#LN582"><span class='Ref_To_Local'>max_contiguous_pages</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeCleanup &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Consider consolidating the given page with its left or right sibling, 
 * if it's fairly empty. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN694"></a><span class='Declare_Function'>FreePageBtreeConsolidate</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN696"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN697"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>np</span><span class='Delimiter'>; 
</span><a name="LN698"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>max</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We only try to consolidate pages that are less than a third full. We 
     * could be more aggressive about this, but that might risk performing 
     * consolidation only to end up splitting again shortly thereafter.  Since 
     * the btree should be very small compared to the space under management, 
     * our goal isn't so much to ensure that it always occupies the absolutely 
     * smallest possible number of pages as to reclaim pages before things get 
     * too egregiously out of hand. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN698"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN698"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN698"><span class='Ref_To_Local'>max</span></a> <span class='Operator'>/ </span><span class='Number'>3</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we can fit our right sibling's keys onto this page, consolidate. 
     */ 
</span>    <a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN132"><span class='Ref_to_Proto'>FreePageBtreeFindRightSibling</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN696"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN698"><span class='Ref_To_Local'>max</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN150"><span class='Ref_to_Proto'>FreePageBtreeUpdateParentPointers</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN696"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="freepage.c.html#LN143"><span class='Ref_to_Proto'>FreePageBtreeRemovePage</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we can fit our keys onto our left sibling's page, consolidate. In 
     * this case, we move our keys onto the other page rather than visca 
     * versa, to avoid having to adjust ancestor keys. 
     */ 
</span>    <a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN130"><span class='Ref_to_Proto'>FreePageBtreeFindLeftSibling</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN696"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN698"><span class='Ref_To_Local'>max</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], 
</span>                   <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN150"><span class='Ref_to_Proto'>FreePageBtreeUpdateParentPointers</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN696"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN697"><span class='Ref_To_Local'>np</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="freepage.c.html#LN143"><span class='Ref_to_Proto'>FreePageBtreeRemovePage</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN694"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeConsolidate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find the passed page's left sibling; that is, the page at the same level 
 * of the tree whose keyspace immediately precedes ours. 
 */ 
</span><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>* 
</span><a name="LN773"></a><span class='Declare_Function'>FreePageBtreeFindLeftSibling</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN775"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="freepage.c.html#LN773"><span class='Ref_to_Parameter'>btp</span></a><span class='Delimiter'>; 
</span><a name="LN776"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>levels</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Move up until we can move left. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN781"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN782"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN781"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN134"><span class='Ref_to_Proto'>FreePageBtreeFirstKey</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN773"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* we were passed the rightmost page */ 
</span> 
        <a href="freepage.c.html#LN782"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN781"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN782"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN782"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN781"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN773"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN782"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN782"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>++</span><a href="freepage.c.html#LN776"><span class='Ref_To_Local'>levels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Descend left. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN776"><span class='Ref_To_Local'>levels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN773"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>--</span><a href="freepage.c.html#LN776"><span class='Ref_To_Local'>levels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN773"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN775"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeFindLeftSibling &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Find the passed page's right sibling; that is, the page at the same level 
 * of the tree whose keyspace immediately follows ours. 
 */ 
</span><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>* 
</span><a name="LN818"></a><span class='Declare_Function'>FreePageBtreeFindRightSibling</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN820"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>p</span> <span class='Operator'>= </span><a href="freepage.c.html#LN818"><span class='Ref_to_Parameter'>btp</span></a><span class='Delimiter'>; 
</span><a name="LN821"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>levels</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Move up until we can move right. */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN826"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span><a name="LN827"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN826"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN134"><span class='Ref_to_Proto'>FreePageBtreeFirstKey</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN818"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* we were passed the rightmost page */ 
</span> 
        <a href="freepage.c.html#LN827"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN826"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN827"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN827"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN826"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN818"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN827"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN827"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>++</span><a href="freepage.c.html#LN821"><span class='Ref_To_Local'>levels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Descend left. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN821"><span class='Ref_To_Local'>levels</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN818"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Operator'>--</span><a href="freepage.c.html#LN821"><span class='Ref_To_Local'>levels</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN818"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN820"><span class='Ref_To_Local'>p</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeFindRightSibling &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Get the first key on a btree page. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN862"></a><span class='Declare_Function'>FreePageBtreeFirstKey</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN862"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN862"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="freepage.c.html#LN862"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN862"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="freepage.c.html#LN862"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get a page from the btree recycle list for use as a btree page. 
 */ 
</span><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>* 
</span><a name="LN879"></a><span class='Declare_Function'>FreePageBtreeGetRecycled</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN881"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN879"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN882"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>victim</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN881"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN879"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN883"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newhead</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN882"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN883"><span class='Ref_To_Local'>newhead</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN881"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN882"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN883"><span class='Ref_To_Local'>newhead</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN883"><span class='Ref_To_Local'>newhead</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN882"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN881"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN879"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN883"><span class='Ref_To_Local'>newhead</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN77"><span class='Ref_to_Macro'>fpm_pointer_is_page_aligned</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN881"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN882"><span class='Ref_To_Local'>victim</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN879"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="freepage.c.html#LN882"><span class='Ref_To_Local'>victim</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Insert an item into an internal page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN899"></a><span class='Declare_Function'>FreePageBtreeInsertInternal</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, 
</span><a name="LN900"></a>                            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>child</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>], 
</span>            <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN900"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN900"><span class='Ref_to_Parameter'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Operator'>++</span><a href="freepage.c.html#LN899"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Insert an item into a leaf page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN916"></a><span class='Declare_Function'>FreePageBtreeInsertLeaf</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, 
</span><a name="LN917"></a>                        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>], 
</span>            <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN917"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>++</span><a href="freepage.c.html#LN916"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Put a page on the btree recycle list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN933"></a><span class='Declare_Function'>FreePageBtreeRecycle</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN935"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN933"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN936"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>head</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN933"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/freepage.h.html#LN66"><span class='Ref_to_Macro'>fpm_page_to_pointer</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN933"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN69"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN62"><span class='Ref_to_Const'>FREE_PAGE_SPAN_LEADER_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN936"><span class='Ref_To_Local'>head</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN936"><span class='Ref_To_Local'>head</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN936"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN935"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN933"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN937"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN933"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Remove an item from the btree at the given position on the given page. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN954"></a><span class='Declare_Function'>FreePageBtreeRemove</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>index</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* When last item is removed, extirpate entire page from btree. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN143"><span class='Ref_to_Proto'>FreePageBtreeRemovePage</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Physically remove the key from the page. */ 
</span>    <span class='Operator'>--</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If we just removed the first key, adjust ancestor keys. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Consider whether to consolidate this page with a sibling. */ 
</span>    <a href="freepage.c.html#LN693"><span class='Ref_to_Func'>FreePageBtreeConsolidate</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN954"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeRemove &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove a page from the btree.  Caller is responsible for having relocated 
 * any keys from this page that are still wanted.  The page is placed on the 
 * recycled list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN986"></a><span class='Declare_Function'>FreePageBtreeRemovePage</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN988"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN989"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span><a name="LN990"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN991"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>first_page</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Find parent page. */ 
</span>        <a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN988"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* We are removing the root page. */ 
</span>            <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN988"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If the parent contains only one item, we need to remove it as well. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN140"><span class='Ref_to_Proto'>FreePageBtreeRecycle</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN988"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>btp</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Find and remove the downlink. */ 
</span>    <a href="freepage.c.html#LN991"><span class='Ref_To_Local'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN134"><span class='Ref_to_Proto'>FreePageBtreeFirstKey</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN147"><span class='Ref_to_Proto'>FreePageBtreeSearchLeaf</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN991"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>], 
</span>                    <span class='Operator'>&</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN991"><span class='Ref_To_Local'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="../../../include/c.h.html#LN1057"><span class='Ref_to_Macro'>memmove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>], 
</span>                    <span class='Operator'>&</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>], 
</span>                    <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>* </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Recycle the page. */ 
</span>    <a href="freepage.c.html#LN140"><span class='Ref_to_Proto'>FreePageBtreeRecycle</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN988"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Adjust ancestor keys if needed. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN990"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Consider whether to consolidate the parent with a sibling. */ 
</span>    <a href="freepage.c.html#LN693"><span class='Ref_to_Func'>FreePageBtreeConsolidate</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN986"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN989"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeRemovePage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Search the btree for an entry for the given first page and initialize 
 * *result with the results of the search.  result-&GT;page and result-&GT;index 
 * indicate either the position of an exact match or the position at which 
 * the new key should be inserted.  result-&GT;found is true for an exact match, 
 * otherwise false.  result-&GT;split_pages will contain the number of additional 
 * btree pages that will be needed when performing a split to insert a key. 
 * Except as described above, the contents of fields in the result object are 
 * undefined on return. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1063"></a><span class='Declare_Function'>FreePageBtreeSearch</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, 
</span><a name="LN1064"></a>                    <a href="freepage.c.html#LN118"><span class='Ref_to_Struct'>FreePageBtreeSearchResult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>result</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1066"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1067"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>btp</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1066"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1068"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If the btree is empty, there's nothing to find. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN122"><span class='Ref_to_Member'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Descend until we hit a leaf. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1083"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span><a name="LN1084"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>found_exact</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1084"><span class='Ref_To_Local'>found_exact</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&& 
</span>            <a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we found an exact match we descend directly.  Otherwise, we 
         * descend into the child to the left if possible so that we can find 
         * the insertion point at that child's high end. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="freepage.c.html#LN1084"><span class='Ref_To_Local'>found_exact</span></a> <span class='Operator'>&& </span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Operator'>--</span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Track required split depth for leaf insert. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Descend to appropriate child page. */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1083"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1066"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1066"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1083"><span class='Ref_To_Local'>child</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1083"><span class='Ref_To_Local'>child</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while btp-&GT;hdr.magic==FREE_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Track required split depth for leaf insert. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Search leaf page. */ 
</span>    <a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN147"><span class='Ref_to_Proto'>FreePageBtreeSearchLeaf</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Assemble results. */ 
</span>    <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1064"><span class='Ref_to_Parameter'>result</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN122"><span class='Ref_to_Member'>found</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&& 
</span>        <a href="freepage.c.html#LN1063"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1067"><span class='Ref_To_Local'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1068"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeSearch &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Search an internal page for the first key greater than or equal to a given 
 * page number.  Returns the index of that key, or one greater than the number 
 * of keys on the page if none. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1139"></a><span class='Declare_Function'>FreePageBtreeSearchInternal</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1141"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>low</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1142"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>high</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1139"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1139"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1142"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="freepage.c.html#LN1142"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1141"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1142"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1149"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>mid</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1141"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1142"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span><a name="LN1150"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>val</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1139"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1149"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1139"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1150"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="freepage.c.html#LN1149"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1139"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1150"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN1142"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1149"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="freepage.c.html#LN1141"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1149"><span class='Ref_To_Local'>mid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN1141"><span class='Ref_To_Local'>low</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeSearchInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Search a leaf page for the first key greater than or equal to a given 
 * page number.  Returns the index of that key, or one greater than the number 
 * of keys on the page if none. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1169"></a><span class='Declare_Function'>FreePageBtreeSearchLeaf</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1171"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>low</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1172"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>high</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1169"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1169"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1172"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="freepage.c.html#LN1172"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1171"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1172"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1179"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>mid</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1171"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1172"><span class='Ref_To_Local'>high</span></a><span class='Parentheses'>) </span><span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span><a name="LN1180"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>val</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1169"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1179"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1169"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1180"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="freepage.c.html#LN1179"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1169"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1180"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN1172"><span class='Ref_To_Local'>high</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1179"><span class='Ref_To_Local'>mid</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="freepage.c.html#LN1171"><span class='Ref_To_Local'>low</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1179"><span class='Ref_To_Local'>mid</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN1171"><span class='Ref_To_Local'>low</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeSearchLeaf &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Allocate a new btree page and move half the keys from the provided page 
 * to the new page.  Caller is responsible for making sure that there's a 
 * page available from fpm-&GT;btree_recycle.  Returns a pointer to the new page, 
 * to which caller must add a downlink. 
 */ 
</span><span class='Keyword'>static </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>* 
</span><a name="LN1200"></a><span class='Declare_Function'>FreePageBtreeSplitPage</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1202"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newsibling</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN135"><span class='Ref_to_Proto'>FreePageBtreeGetRecycled</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>/ </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>-= </span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>, 
</span>               <span class='Operator'>&</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>, 
</span>               <span class='Operator'>&</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>], 
</span>               <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN85"><span class='Ref_to_Struct'>FreePageBtreeInternalKey</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN150"><span class='Ref_to_Proto'>FreePageBtreeUpdateParentPointers</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1200"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN1202"><span class='Ref_To_Local'>newsibling</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageBtreeSplitPage &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * When internal pages are split or merged, the parent pointers of their 
 * children must be updated. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1231"></a><span class='Declare_Function'>FreePageBtreeUpdateParentPointers</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>base</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1233"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN1233"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN1233"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1238"></a>        <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span> 
        <a href="freepage.c.html#LN1238"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1233"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1238"><span class='Ref_To_Local'>child</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1231"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Debugging dump of btree data. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1249"></a><span class='Declare_Function'>FreePageManagerDumpBtree</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>btp</span><span class='Delimiter'>, 
</span><a name="LN1250"></a>                         <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>parent</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Delimiter'>, </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1252"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1253"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pageno</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1252"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1254"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN1255"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>check_parent</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/miscadmin.h.html#LN275"><span class='Ref_to_Proto'>check_stack_depth</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1255"><span class='Ref_To_Local'>check_parent</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1252"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"  %zu@%d %c"</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN1253"><span class='Ref_To_Local'>pageno</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>level</span></a><span class='Delimiter'>, 
</span>                     <a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a> <span class='Operator'>? </span><span class='String'>'i'</span> <span class='Operator'>: </span><span class='String'>'l'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>parent</span></a> <span class='Operator'>!= </span><a href="freepage.c.html#LN1255"><span class='Ref_To_Local'>check_parent</span></a><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" [actual parent %zu, expected %zu]"</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1252"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1255"><span class='Ref_To_Local'>check_parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1252"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>parent</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../replication/syncrep_scanner.l.html#LN76"><span class='Ref_to_Proto'>appendStringInfoChar</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>':'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>) 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %zu-&GT;%zu"</span><span class='Delimiter'>, 
</span>                             <a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>, 
</span>                <a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Operator'>.</span>relptr_off <span class='Operator'>/ </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %zu(%zu)"</span><span class='Delimiter'>, 
</span>                             <a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>, 
</span>                             <a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1283"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN1283"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1252"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1254"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN151"><span class='Ref_to_Proto'>FreePageManagerDumpBtree</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1283"><span class='Ref_To_Local'>child</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1249"><span class='Ref_to_Parameter'>btp</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN1250"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerDumpBtree &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Debugging dump of free-span data. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1295"></a><span class='Declare_Function'>FreePageManagerDumpSpans</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>span</span><span class='Delimiter'>, 
</span><a name="LN1296"></a>                         <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>expected_pages</span><span class='Delimiter'>, </span><a href="../../../include/lib/stringinfo.h.html#LN42"><span class='Ref_to_Typedef'>StringInfo</span></a> <span class='Declare_Parameter'>buf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1298"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>!= </span><a href="freepage.c.html#LN1296"><span class='Ref_to_Parameter'>expected_pages</span></a><span class='Parentheses'>) 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1296"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %zu(%zu)"</span><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1298"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                             <a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1296"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>" %zu"</span><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1298"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1298"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1295"><span class='Ref_to_Parameter'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1296"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This function allocates a run of pages of the given length from the free 
 * page manager. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN1318"></a><span class='Declare_Function'>FreePageManagerGetInternal</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>first_page</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1320"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1321"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>victim</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1322"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span><a name="LN1323"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span><a name="LN1324"></a>    <a href="freepage.c.html#LN118"><span class='Ref_to_Struct'>FreePageBtreeSearchResult</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1325"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>victim_page</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* placate compiler */ 
</span><a name="LN1326"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Search for a free span. 
     * 
     * Right now, we use a simple best-fit policy here, but it's possible for 
     * this to result in memory fragmentation if we're repeatedly asked to 
     * allocate chunks just a little smaller than what we have available. 
     * Hopefully, this is unlikely, because we expect most requests to be 
     * single pages or superblock-sized chunks -- but no policy can be optimal 
     * under all circumstances unless it has knowledge of future allocation 
     * patterns. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Skip empty freelists. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * All of the freelists except the last one contain only items of a 
         * single size, so we just take the first one.  But the final free 
         * list contains everything too big for any of the other lists, so we 
         * need to search the list. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1355"></a>            <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>candidate</span><span class='Delimiter'>; 
</span> 
            <a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>do</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| 
</span>                                         <a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>))</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>) 
</span>                        <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} </span><span class='Control'>while</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1355"><span class='Ref_To_Local'>candidate</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for f=Min(npages,FPM_NUM_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* If we didn't find an allocatable span, return failure. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Remove span from free list. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN69"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN62"><span class='Ref_to_Const'>FREE_PAGE_SPAN_LEADER_MAGIC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1322"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1323"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1322"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1322"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>], </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1323"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1323"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1325"><span class='Ref_To_Local'>victim_page</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Decide whether we might be invalidating contiguous_pages. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>== </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a> <span class='Operator'>- </span><span class='Number'>1</span> <span class='Operator'>&& 
</span>        <a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The victim span came from the oversized freelist, and had the same 
         * size as the longest span.  There may or may not be another one of 
         * the same size, so contiguous_pages must be recomputed just to be 
         * safe. 
         */ 
</span>        <a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN57"><span class='Ref_to_Member'>contiguous_pages_dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>+ </span><span class='Number'>1</span> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN56"><span class='Ref_to_Member'>contiguous_pages</span></a> <span class='Operator'>&& 
</span>             <a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1326"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * The victim span came from a fixed sized freelist, and it was the 
         * list for spans of the same size as the current longest span, and 
         * the list is now empty after removing the victim.  So 
         * contiguous_pages must be recomputed without a doubt. 
         */ 
</span>        <a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN57"><span class='Ref_to_Member'>contiguous_pages_dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we haven't initialized the btree yet, the victim must be the single 
     * span stored within the FreePageManager itself.  Otherwise, we need to 
     * update the btree. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1325"><span class='Ref_To_Local'>victim_page</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>-= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>, 
</span>                                   <a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * If the span we found is exactly the right size, remove it from the 
         * btree completely.  Otherwise, adjust the btree entry to reflect the 
         * still-unallocated portion of the span, and put that portion on the 
         * appropriate free list. 
         */ 
</span>        <a href="freepage.c.html#LN144"><span class='Ref_to_Proto'>FreePageBtreeSearch</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1325"><span class='Ref_To_Local'>victim_page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN122"><span class='Ref_to_Member'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN141"><span class='Ref_to_Proto'>FreePageBtreeRemove</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1443"></a>            <a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>key</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Adjust btree to reflect remaining pages. */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1443"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= &</span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>]; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1443"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1443"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1443"><span class='Ref_To_Local'>key</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>-= </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1324"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Put the unallocated pages back on the appropriate free list. */ 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1325"><span class='Ref_To_Local'>victim_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>, 
</span>                                   <a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Return results to caller. */ 
</span>    <span class='Operator'>*</span><a href="freepage.c.html#LN1318"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN69"><span class='Ref_to_Macro'>fpm_pointer_to_page</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1320"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1321"><span class='Ref_To_Local'>victim</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerGetInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Put a range of pages into the btree and freelists, consolidating it with 
 * existing free spans just before and/or after it.  If 'soft' is true, 
 * only perform the insertion if it can be done without allocating new btree 
 * pages; if false, do it always.  Returns 0 if the soft flag caused the 
 * insertion to be skipped, or otherwise the size of the contiguous span 
 * created by the insertion.  This may be larger than npages if we're able 
 * to consolidate with an adjacent range.  *internal_pages_used is set to 
 * true if the btree allocated pages for internal purposes, which might 
 * invalidate the current largest run requiring it to be recomputed. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1477"></a><span class='Declare_Function'>FreePageManagerPutInternal</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Delimiter'>, 
</span><a name="LN1478"></a>                           <span class='Keyword'>bool </span><span class='Declare_Parameter'>soft</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1480"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1481"></a>    <a href="freepage.c.html#LN118"><span class='Ref_to_Struct'>FreePageBtreeSearchResult</span></a> <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN1482"></a>    <a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prevkey</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1483"></a>    <a href="freepage.c.html#LN92"><span class='Ref_to_Struct'>FreePageBtreeLeafKey</span></a> <span class='Operator'>*</span><span class='Declare_Local'>nextkey</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1484"></a>    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>np</span><span class='Delimiter'>; 
</span><a name="LN1485"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>nindex</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We can store a single free span without initializing the btree. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Don't have a span yet; store this one. */ 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>== 
</span>                 <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* New span immediately follows sole existing span. */ 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>, 
</span>                                   <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* New span immediately precedes sole existing span. */ 
</span>            <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>+= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>, 
</span>                                   <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Not contiguous; we need to initialize the btree. */ 
</span><a name="LN1523"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>root_page</span><span class='Delimiter'>; 
</span><a name="LN1524"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>root</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/relptr.h.html#LN55"><span class='Ref_to_Macro'>relptr_is_null</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN51"><span class='Ref_to_Member'>btree_recycle</span></a><span class='Parentheses'>))</span> 
                <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN135"><span class='Ref_to_Proto'>FreePageBtreeGetRecycled</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN156"><span class='Ref_to_Proto'>FreePageManagerGetInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN1523"><span class='Ref_To_Local'>root_page</span></a><span class='Parentheses'>))</span> 
                <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/freepage.h.html#LN66"><span class='Ref_to_Macro'>fpm_page_to_pointer</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1523"><span class='Ref_To_Local'>root_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* We'd better be able to get a page from the existing range. */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"free page manager btree is corrupt"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Create the btree and move the preexisting range into it. */ 
</span>            <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN63"><span class='Ref_to_Const'>FREE_PAGE_LEAF_MAGIC</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a><span class='Delimiter'>; 
</span>            <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN54"><span class='Ref_to_Member'>singleton_first_page</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN55"><span class='Ref_to_Member'>singleton_npages</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Corner case: it may be that the btree root took the very last 
             * free page.  In that case, the sole btree entry covers a zero 
             * page run, which is invalid.  Overwrite it with the entry we're 
             * trying to insert and get out. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN1524"><span class='Ref_To_Local'>root</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* Fall through to insert the new key. */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if fpm-&GT;btree_depth==0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Search the btree. */ 
</span>    <a href="freepage.c.html#LN144"><span class='Ref_to_Proto'>FreePageBtreeSearch</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN122"><span class='Ref_to_Member'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a> <span class='Operator'>= &</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>]; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1485"><span class='Ref_To_Local'>nindex</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a> <span class='Operator'>= &</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN132"><span class='Ref_to_Proto'>FreePageBtreeFindRightSibling</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1485"><span class='Ref_To_Local'>nindex</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a> <span class='Operator'>= &</span><a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Consolidate with the previous entry if possible. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1587"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>remove_next</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN1588"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check whether we can *also* consolidate with the following entry. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>            <a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>== 
</span>                   <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>+ </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="freepage.c.html#LN1587"><span class='Ref_To_Local'>remove_next</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Put the span on the correct freelist and save size. */ 
</span>        <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1588"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1482"><span class='Ref_To_Local'>prevkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If we consolidated with both the preceding and following entries, 
         * we must remove the following entry.  We do this last, because 
         * removing an element from the btree may invalidate pointers we hold 
         * into the current data structure. 
         * 
         * NB: The btree is technically in an invalid state a this point 
         * because we've already updated prevkey to cover the same key space 
         * as nextkey.  FreePageBtreeRemove() shouldn't notice that, though. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1587"><span class='Ref_To_Local'>remove_next</span></a><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN141"><span class='Ref_to_Proto'>FreePageBtreeRemove</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1485"><span class='Ref_To_Local'>nindex</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="freepage.c.html#LN1588"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if prevkey!=NULL&&prevke... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Consolidate with the next entry if possible. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>&GT;= </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1629"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>newpages</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Compute new size for span. */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a> <span class='Operator'>+ </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1629"><span class='Ref_To_Local'>newpages</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Put span on correct free list. */ 
</span>        <a href="freepage.c.html#LN160"><span class='Ref_to_Proto'>FreePagePopSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1629"><span class='Ref_To_Local'>newpages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Update key in place. */ 
</span>        <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span>        <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1629"><span class='Ref_To_Local'>newpages</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* If reducing first key on page, ancestors might need adjustment. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1485"><span class='Ref_To_Local'>nindex</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1484"><span class='Ref_To_Local'>np</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>return</span> <a href="freepage.c.html#LN1483"><span class='Ref_To_Local'>nextkey</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN95"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if nextkey!=NULL&&first_... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Split leaf page and as many of its ancestors as necessary. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * NB: We could consider various coping strategies here to avoid a 
         * split; most obviously, if np != result.page, we could target that 
         * page instead.   More complicated shuffling strategies could be 
         * possible as well; basically, unless every single leaf page is 100% 
         * full, we can jam this key in there if we try hard enough.  It's 
         * unlikely that trying that hard is worthwhile, but it's possible we 
         * might need to make more than no effort.  For now, we just do the 
         * easy thing, which is nothing. 
         */ 
</span> 
        <span class='Comment_Multi_Line'>/* If this is a soft insert, it's time to give up. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1478"><span class='Ref_to_Parameter'>soft</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check whether we need to allocate more btree pages to split. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>&GT; </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1671"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>pages_needed</span><span class='Delimiter'>; 
</span><a name="LN1672"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>recycle_page</span><span class='Delimiter'>; 
</span><a name="LN1673"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Allocate the required number of pages and split each one in 
             * turn.  This should never fail, because if we've got enough 
             * spans of free pages kicking around that we need additional 
             * storage space just to remember them all, then we should 
             * certainly have enough to expand the btree, which should only 
             * ever use a tiny number of pages compared to the number under 
             * management.  If it does, something's badly screwed up. 
             */ 
</span>            <a href="freepage.c.html#LN1671"><span class='Ref_To_Local'>pages_needed</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>- </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1673"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="freepage.c.html#LN1673"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1671"><span class='Ref_To_Local'>pages_needed</span></a><span class='Delimiter'>; </span><span class='Operator'>++</span><a href="freepage.c.html#LN1673"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="freepage.c.html#LN156"><span class='Ref_to_Proto'>FreePageManagerGetInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN1672"><span class='Ref_To_Local'>recycle_page</span></a><span class='Parentheses'>))</span> 
                    <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN51"><span class='Ref_to_Const'>FATAL</span></a><span class='Delimiter'>, </span><span class='String'>"free page manager btree is corrupt"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN140"><span class='Ref_to_Proto'>FreePageBtreeRecycle</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1672"><span class='Ref_To_Local'>recycle_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The act of allocating pages to recycle may have invalidated the 
             * results of our previous btree reserch, so repeat it. (We could 
             * recheck whether any of our split-avoidance strategies that were 
             * not viable before now are, but it hardly seems worthwhile, so 
             * we don't bother. Consolidation can't be possible now if it 
             * wasn't previously.) 
             */ 
</span>            <a href="freepage.c.html#LN144"><span class='Ref_to_Proto'>FreePageBtreeSearch</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * The act of allocating pages for use in constructing our btree 
             * should never cause any page to become more full, so the new 
             * split depth should be no greater than the old one, and perhaps 
             * less if we fortuitously allocated a chunk that freed up a slot 
             * on the page we need to update. 
             */ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>&LT;= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN53"><span class='Ref_to_Member'>btree_recycle_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result.split_pages&GT;fp... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* If we still need to perform a split, do it. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN123"><span class='Ref_to_Member'>split_pages</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1715"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>split_target</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>; 
</span><a name="LN1716"></a>            <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>child</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1717"></a>            <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>key</span> <span class='Operator'>= </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1721"></a>                <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newsibling</span><span class='Delimiter'>; 
</span><a name="LN1722"></a>                <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>parent</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Identify parent page, which must receive downlink. */ 
</span>                <a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* Split the page - downlink not added yet. */ 
</span>                <a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN148"><span class='Ref_to_Proto'>FreePageBtreeSplitPage</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * At this point in the loop, we're always carrying a pending 
                 * insertion.  On the first pass, it's the actual key we're 
                 * trying to insert; on subsequent passes, it's the downlink 
                 * that needs to be added as a result of the split performed 
                 * during the previous loop iteration.  Since we've just split 
                 * the page, there's definitely room on one of the two 
                 * resulting pages. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1716"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1741"></a>                    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN1742"></a>                    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>insert_into</span><span class='Delimiter'>; 
</span> 
                    <a href="freepage.c.html#LN1742"><span class='Ref_To_Local'>insert_into</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN113"><span class='Ref_to_Member'>leaf_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN94"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>? 
</span>                        <a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a> <span class='Operator'>: </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1741"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN147"><span class='Ref_to_Proto'>FreePageBtreeSearchLeaf</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1742"><span class='Ref_To_Local'>insert_into</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN138"><span class='Ref_to_Proto'>FreePageBtreeInsertLeaf</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1742"><span class='Ref_To_Local'>insert_into</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1741"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1741"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="freepage.c.html#LN1742"><span class='Ref_To_Local'>insert_into</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>) 
</span>                        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span><a name="LN1753"></a>                    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span><a name="LN1754"></a>                    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>insert_into</span><span class='Delimiter'>; 
</span> 
                    <a href="freepage.c.html#LN1754"><span class='Ref_To_Local'>insert_into</span></a> <span class='Operator'>= 
</span>                        <a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>? 
</span>                        <a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a> <span class='Operator'>: </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1753"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1754"><span class='Ref_To_Local'>insert_into</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN136"><span class='Ref_to_Proto'>FreePageBtreeInsertInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1754"><span class='Ref_To_Local'>insert_into</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1753"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, 
</span>                                                <a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1716"><span class='Ref_To_Local'>child</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1716"><span class='Ref_To_Local'>child</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1754"><span class='Ref_To_Local'>insert_into</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1753"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="freepage.c.html#LN1754"><span class='Ref_To_Local'>insert_into</span></a> <span class='Operator'>== </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>) 
</span>                        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* If the page we just split has no parent, split the root. */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1770"></a>                    <a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newroot</span><span class='Delimiter'>; 
</span> 
                    <a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN135"><span class='Ref_to_Proto'>FreePageBtreeGetRecycled</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN78"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN64"><span class='Ref_to_Const'>FREE_PAGE_INTERNAL_MAGIC</span></a><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, 
</span>                                 <span class='Parentheses'>(</span><a href="freepage.c.html#LN107"><span class='Ref_to_Struct'>FreePageBtree</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= 
</span>                        <a href="freepage.c.html#LN134"><span class='Ref_to_Proto'>FreePageBtreeFirstKey</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Delimiter'>, 
</span>                                 <a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a> <span class='Operator'>= 
</span>                        <a href="freepage.c.html#LN134"><span class='Ref_to_Proto'>FreePageBtreeFirstKey</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN88"><span class='Ref_to_Member'>child</span></a><span class='Delimiter'>, 
</span>                                 <a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN50"><span class='Ref_to_Member'>btree_root</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1770"><span class='Ref_To_Local'>newroot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN52"><span class='Ref_to_Member'>btree_depth</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if parent==NULL &raquo; </span> 
 
                <span class='Comment_Multi_Line'>/* If the parent page isn't full, insert the downlink. */ 
</span>                <a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN114"><span class='Ref_to_Member'>u</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN112"><span class='Ref_to_Member'>internal_key</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Operator'>.</span><a href="freepage.c.html#LN87"><span class='Ref_to_Member'>first_page</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN99"><span class='Ref_to_Const'>FPM_ITEMS_PER_INTERNAL_PAGE</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1797"></a>                    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>index</span><span class='Delimiter'>; 
</span> 
                    <a href="freepage.c.html#LN1797"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN146"><span class='Ref_to_Proto'>FreePageBtreeSearchInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="freepage.c.html#LN136"><span class='Ref_to_Proto'>FreePageBtreeInsertInternal</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1797"><span class='Ref_To_Local'>index</span></a><span class='Delimiter'>, 
</span>                                                <a href="freepage.c.html#LN1717"><span class='Ref_To_Local'>key</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1480"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN81"><span class='Ref_to_Member'>parent</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1797"><span class='Ref_To_Local'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>break</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <span class='Comment_Multi_Line'>/* The parent also needs to be split, so loop around. */ 
</span>                <a href="freepage.c.html#LN1716"><span class='Ref_To_Local'>child</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1721"><span class='Ref_To_Local'>newsibling</span></a><span class='Delimiter'>; 
</span>                <a href="freepage.c.html#LN1715"><span class='Ref_To_Local'>split_target</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1722"><span class='Ref_To_Local'>parent</span></a><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for ;; &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * The loop above did the insert, so just need to update the free 
             * list, and we're done. 
             */ 
</span>            <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result.split_pages&GT;0 &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if result.split_pages&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Physically add the key to the page. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN109"><span class='Ref_to_Member'>hdr</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN80"><span class='Ref_to_Member'>nused</span></a> <span class='Operator'>&LT; </span><a href="freepage.c.html#LN102"><span class='Ref_to_Const'>FPM_ITEMS_PER_LEAF_PAGE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN138"><span class='Ref_to_Proto'>FreePageBtreeInsertLeaf</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If new first key on page, ancestors might need adjustment. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN121"><span class='Ref_to_Member'>index</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="freepage.c.html#LN127"><span class='Ref_to_Proto'>FreePageBtreeAdjustAncestorKeys</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1481"><span class='Ref_To_Local'>result</span></a><span class='Operator'>.</span><a href="freepage.c.html#LN120"><span class='Ref_to_Member'>page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Put it on the free list. */ 
</span>    <a href="freepage.c.html#LN161"><span class='Ref_to_Proto'>FreePagePushSpanLeader</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>fpm</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>first_page</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="freepage.c.html#LN1477"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FreePageManagerPutInternal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Remove a FreePageSpanLeader from the linked-list that contains it, either 
 * because we're changing the size of the span, or because we're allocating it. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1842"></a><span class='Declare_Function'>FreePagePopSpanLeader</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>pageno</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1844"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1842"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1845"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span><a name="LN1846"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span><a name="LN1847"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>prev</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/freepage.h.html#LN66"><span class='Ref_to_Macro'>fpm_page_to_pointer</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1844"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1842"><span class='Ref_to_Parameter'>pageno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN1846"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1844"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1847"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1844"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1846"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1846"><span class='Ref_To_Local'>next</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1847"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1847"><span class='Ref_To_Local'>prev</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1859"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="freepage.c.html#LN1842"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1859"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Operator'>.</span>relptr_off <span class='Operator'>== </span><a href="freepage.c.html#LN1842"><span class='Ref_to_Parameter'>pageno</span></a> <span class='Operator'>* </span><a href="../../../include/utils/freepage.h.html#LN29"><span class='Ref_to_Const'>FPM_PAGE_SIZE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/relptr.h.html#LN73"><span class='Ref_to_Macro'>relptr_copy</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1842"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1859"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>], </span><a href="freepage.c.html#LN1845"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end FreePagePopSpanLeader &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initialize a new FreePageSpanLeader and put it on the appropriate free list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1870"></a><span class='Declare_Function'>FreePagePushSpanLeader</span><span class='Parentheses'>(</span><a href="../../../include/utils/freepage.h.html#LN47"><span class='Ref_to_Struct'>FreePageManager</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>fpm</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>first_page</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> <span class='Declare_Parameter'>npages</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1872"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>base</span> <span class='Operator'>= </span><a href="../../../include/utils/freepage.h.html#LN83"><span class='Ref_to_Macro'>fpm_segment_base</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>fpm</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1873"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>f</span> <span class='Operator'>= </span><a href="../../../interfaces/ecpg/pgtypeslib/numeric.c.html#LN11"><span class='Ref_to_Macro'>Min</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/freepage.h.html#LN39"><span class='Ref_to_Const'>FPM_NUM_FREELISTS</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN1874"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>head</span> <span class='Operator'>= </span><a href="../../../include/utils/relptr.h.html#LN41"><span class='Ref_to_Macro'>relptr_access</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1873"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1875"></a>    <a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Declare_Local'>span</span><span class='Delimiter'>; 
</span> 
    <a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/freepage.h.html#LN66"><span class='Ref_to_Macro'>fpm_page_to_pointer</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>first_page</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN69"><span class='Ref_to_Member'>magic</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN62"><span class='Ref_to_Const'>FREE_PAGE_SPAN_LEADER_MAGIC</span></a><span class='Delimiter'>; 
</span>    <a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN70"><span class='Ref_to_Member'>npages</span></a> <span class='Operator'>= </span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>npages</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN72"><span class='Ref_to_Member'>next</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1874"><span class='Ref_To_Local'>head</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="freepage.c.html#LN67"><span class='Ref_to_Struct'>FreePageSpanLeader</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="freepage.c.html#LN1874"><span class='Ref_To_Local'>head</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1874"><span class='Ref_To_Local'>head</span></a><span class='Operator'>-&GT;</span><a href="freepage.c.html#LN71"><span class='Ref_to_Member'>prev</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/relptr.h.html#LN59"><span class='Ref_to_Macro'>relptr_store</span></a><span class='Parentheses'>(</span><a href="freepage.c.html#LN1872"><span class='Ref_To_Local'>base</span></a><span class='Delimiter'>, </span><a href="freepage.c.html#LN1870"><span class='Ref_to_Parameter'>fpm</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/freepage.h.html#LN58"><span class='Ref_to_Member'>freelist</span></a><span class='Delimiter'>[</span><a href="freepage.c.html#LN1873"><span class='Ref_To_Local'>f</span></a><span class='Delimiter'>], </span><a href="freepage.c.html#LN1875"><span class='Ref_To_Local'>span</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>