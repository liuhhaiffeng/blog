<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\mmgr\portalmem.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\mmgr\portalmem.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * portalmem.c 
 *    backend portal memory management 
 * 
 * Portals are objects representing the execution state of a query. 
 * This module provides memory management services for portals, but it 
 * doesn't actually run the executor for them. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/mmgr/portalmem.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/pg_type.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"commands/portalcmds.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/timestamp.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Estimate of the maximum number of open portals a user would have, 
 * used in initially sizing the PortalHashTable in EnablePortalManager(). 
 * Since the hash table can expand, there's no need to make this overly 
 * generous, and keeping it small avoids unnecessary overhead in the 
 * hash_seq_search() calls executed during transaction end. 
 */ 
</span><a name="LN36"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>PORTALS_PER_USER</span>       <span class='Number'>16</span> 
 
 
<span class='Comment_Multi_Line'>/* ---------------- 
 *      Global state 
 * ---------------- 
 */ 
</span> 
<a name="LN44"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MAX_PORTALNAME_LEN</span>      <a href="../../../interfaces/ecpg/include/sqlda-native.h.html#LN15"><span class='Ref_to_Const'>NAMEDATALEN</span></a> 
 
<a name="LN46"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>portalhashent</span> 
<span class='Delimiter'>{ 
</span><a name="LN48"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>portalname</span><span class='Delimiter'>[</span><a href="portalmem.c.html#LN44"><span class='Ref_to_Const'>MAX_PORTALNAME_LEN</span></a><span class='Delimiter'>]; 
</span><a name="LN49"></a>    <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Member'>portal</span><span class='Delimiter'>; 
</span><a name="LN50"></a>} <span class='Declare_Typedef'>PortalHashEnt</span><span class='Delimiter'>; 
</span> 
<a name="LN52"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>PortalHashTable</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PortalHashTableLookup</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>NAME</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>PORTAL</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span>hentry<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Operator'>\ 
</span>    hentry <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                           <span class='Parentheses'>(</span><a href="portalmem.c.html#LN54"><span class='Ref_to_Parameter'>NAME</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN104"><span class='Ref_to_EnumConst'>HASH_FIND</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>hentry<span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <a href="portalmem.c.html#LN54"><span class='Ref_to_Parameter'>PORTAL</span></a> <span class='Operator'>= </span>hentry<span class='Operator'>-&GT;</span>portal<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>else</span> <span class='Operator'>\ 
</span>        <a href="portalmem.c.html#LN54"><span class='Ref_to_Parameter'>PORTAL</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN66"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PortalHashTableInsert</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>PORTAL</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>NAME</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span>hentry<span class='Delimiter'>; </span><span class='Keyword'>bool </span>found<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Operator'>\ 
</span>    hentry <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                           <span class='Parentheses'>(</span><a href="portalmem.c.html#LN66"><span class='Ref_to_Parameter'>NAME</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN105"><span class='Ref_to_EnumConst'>HASH_ENTER</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span>found<span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>found<span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"duplicate portal name"</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    hentry<span class='Operator'>-&GT;</span>portal <span class='Operator'>= </span><a href="portalmem.c.html#LN66"><span class='Ref_to_Parameter'>PORTAL</span></a><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Comment_Multi_Line'>/* To avoid duplicate storage, make PORTAL-&GT;name point to htab entry */ </span><span class='Operator'>\ 
</span>    <a href="portalmem.c.html#LN66"><span class='Ref_to_Parameter'>PORTAL</span></a><span class='Operator'>-&GT;</span>name <span class='Operator'>= </span>hentry<span class='Operator'>-&GT;</span>portalname<span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN79"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>PortalHashTableDelete</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>PORTAL</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span><span class='Control'>do</span> <span class='Delimiter'>{ </span><span class='Operator'>\ 
</span>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span>hentry<span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Operator'>\ 
</span>    hentry <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN125"><span class='Ref_to_Proto'>hash_search</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>                                           <a href="portalmem.c.html#LN79"><span class='Ref_to_Parameter'>PORTAL</span></a><span class='Operator'>-&GT;</span>name<span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN106"><span class='Ref_to_EnumConst'>HASH_REMOVE</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>hentry <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"trying to delete portal name that does not exist"</span><span class='Parentheses'>)</span><span class='Delimiter'>; </span><span class='Operator'>\ 
</span><span class='Delimiter'>} </span><span class='Control'>while</span><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>) 
</span> 
<a name="LN89"></a><span class='Keyword'>static </span><a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Var'>PortalMemory</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* ---------------------------------------------------------------- 
 *                 public portal interface functions 
 * ---------------------------------------------------------------- 
 */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * EnablePortalManager 
 *      Enables the portal management module at backend startup. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN102"></a><span class='Declare_Function'>EnablePortalManager</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN104"></a>    <a href="../../../include/utils/hsearch.h.html#LN64"><span class='Ref_to_Struct'>HASHCTL</span></a>     <span class='Declare_Local'>ctl</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN89"><span class='Ref_to_Global_Var'>PortalMemory</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN89"><span class='Ref_to_Global_Var'>PortalMemory</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="mcxt.c.html#LN42"><span class='Ref_to_Global_Var'>TopMemoryContext</span></a><span class='Delimiter'>, 
</span>                                         <span class='String'>"PortalMemory"</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN104"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN71"><span class='Ref_to_Member'>keysize</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN44"><span class='Ref_to_Const'>MAX_PORTALNAME_LEN</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN104"><span class='Ref_To_Local'>ctl</span></a><span class='Operator'>.</span><a href="../../../include/utils/hsearch.h.html#LN72"><span class='Ref_to_Member'>entrysize</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * use PORTALS_PER_USER as a guess of how many hash table entries to 
     * create, initially 
     */ 
</span>    <a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN121"><span class='Ref_to_Proto'>hash_create</span></a><span class='Parentheses'>(</span><span class='String'>"Portal hash"</span><span class='Delimiter'>, </span><a href="portalmem.c.html#LN36"><span class='Ref_to_Const'>PORTALS_PER_USER</span></a><span class='Delimiter'>, 
</span>                                  <span class='Operator'>&</span><a href="portalmem.c.html#LN104"><span class='Ref_To_Local'>ctl</span></a><span class='Delimiter'>, </span><a href="../../../include/utils/hsearch.h.html#LN86"><span class='Ref_to_Const'>HASH_ELEM</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end EnablePortalManager &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetPortalByName 
 *      Returns a portal given a portal name, or NULL if name not found. 
 */ 
</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> 
<a name="LN128"></a><span class='Declare_Function'>GetPortalByName</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN130"></a>    <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN128"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>))</span> 
        <a href="portalmem.c.html#LN54"><span class='Ref_to_Macro'>PortalHashTableLookup</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN128"><span class='Ref_to_Parameter'>name</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN130"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="portalmem.c.html#LN130"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="portalmem.c.html#LN130"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PortalGetPrimaryStmt 
 *      Get the "primary" stmt within a portal, ie, the one marked canSetTag. 
 * 
 * Returns NULL if no such stmt.  If multiple PlannedStmt structs within the 
 * portal are marked canSetTag, returns the first one.  Neither of these 
 * cases should occur in present usages of this function. 
 */ 
</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>* 
</span><a name="LN149"></a><span class='Declare_Function'>PortalGetPrimaryStmt</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN151"></a>    <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN151"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN149"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN135"><span class='Ref_to_Member'>stmts</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN155"></a>        <a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>stmt</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN108"><span class='Ref_to_Macro'>lfirst_node</span></a><span class='Parentheses'>(</span><a href="../../../include/nodes/plannodes.h.html#LN40"><span class='Ref_to_Struct'>PlannedStmt</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN151"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN155"><span class='Ref_To_Local'>stmt</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/plannodes.h.html#LN52"><span class='Ref_to_Member'>canSetTag</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <a href="portalmem.c.html#LN155"><span class='Ref_To_Local'>stmt</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * CreatePortal 
 *      Returns a new portal given a name. 
 * 
 * allowDup: if true, automatically drop any pre-existing portal of the 
 * same name (if false, an error is raised). 
 * 
 * dupSilent: if true, don't even emit a WARNING. 
 */ 
</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> 
<a name="LN173"></a><span class='Declare_Function'>CreatePortal</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>name</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>allowDup</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>dupSilent</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN175"></a>    <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN127"><span class='Ref_to_Func'>GetPortalByName</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN198"><span class='Ref_to_Macro'>PortalIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>allowDup</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_CURSOR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cursor \"%s\" already exists"</span><span class='Delimiter'>, </span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>dupSilent</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_DUPLICATE_CURSOR<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"closing existing cursor \"%s\""</span><span class='Delimiter'>, 
</span>                            <a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/portal.h.html#LN227"><span class='Ref_to_Proto'>PortalDrop</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* make new portal structure */ 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN71"><span class='Ref_to_Proto'>MemoryContextAllocZero</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN89"><span class='Ref_to_Global_Var'>PortalMemory</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof </span><span class='Operator'>*</span><a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize portal heap context; typically it won't store much */ 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN118"><span class='Ref_to_Member'>heap</span></a> <span class='Operator'>= </span><a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN89"><span class='Ref_to_Global_Var'>PortalMemory</span></a><span class='Delimiter'>, 
</span>                                         <span class='String'>"PortalHeapMemory"</span><span class='Delimiter'>, 
</span>                                         <a href="../../../include/utils/memutils.h.html#LN174"><span class='Ref_to_Const'>ALLOCSET_SMALL_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* create a resource owner for the portal */ 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><a href="../../../include/utils/resowner.h.html#LN66"><span class='Ref_to_Proto'>ResourceOwnerCreate</span></a><span class='Parentheses'>(</span><a href="../resowner/resowner.c.html#LN138"><span class='Ref_to_Global_Var'>CurTransactionResourceOwner</span></a><span class='Delimiter'>, 
</span>                                           <span class='String'>"Portal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* initialize portal fields that don't start off zero */ 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN103"><span class='Ref_to_EnumConst'>PORTAL_NEW</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><a href="../../../include/commands/portalcmds.h.html#LN28"><span class='Ref_to_Proto'>PortalCleanup</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN142"><span class='Ref_to_Member'>strategy</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN93"><span class='Ref_to_EnumConst'>PORTAL_MULTI_QUERY</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/parsenodes.h.html#LN2603"><span class='Ref_to_Const'>CURSOR_OPT_NO_SCROLL</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN185"><span class='Ref_to_Member'>atStart</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN186"><span class='Ref_to_Member'>atEnd</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* disallow fetches until query is set */ 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN191"><span class='Ref_to_Member'>visible</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN190"><span class='Ref_to_Member'>creation_time</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN341"><span class='Ref_to_Proto'>GetCurrentStatementStartTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* put portal in table (sets portal-&GT;name) */ 
</span>    <a href="portalmem.c.html#LN66"><span class='Ref_to_Macro'>PortalHashTableInsert</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN173"><span class='Ref_to_Parameter'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="portalmem.c.html#LN175"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CreatePortal &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CreateNewPortal 
 *      Create a new portal, assigning it a random nonconflicting name. 
 */ 
</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> 
<a name="LN229"></a><span class='Declare_Function'>CreateNewPortal</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN231"></a>    <span class='Keyword'>static unsigned int </span><span class='Declare_Local'>unnamed_portal_count</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<a name="LN233"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>portalname</span><span class='Delimiter'>[</span><a href="portalmem.c.html#LN44"><span class='Ref_to_Const'>MAX_PORTALNAME_LEN</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* Select a nonconflicting name */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><span class='Delimiter'>;;</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="portalmem.c.html#LN231"><span class='Ref_To_Local'>unnamed_portal_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN233"><span class='Ref_To_Local'>portalname</span></a><span class='Delimiter'>, </span><span class='String'>"&LT;unnamed portal %u&GT;"</span><span class='Delimiter'>, </span><a href="portalmem.c.html#LN231"><span class='Ref_To_Local'>unnamed_portal_count</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN127"><span class='Ref_to_Func'>GetPortalByName</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN233"><span class='Ref_To_Local'>portalname</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="portalmem.c.html#LN172"><span class='Ref_to_Func'>CreatePortal</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN233"><span class='Ref_To_Local'>portalname</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PortalDefineQuery 
 *      A simple subroutine to establish a portal's query. 
 * 
 * Notes: as of PG 8.4, caller MUST supply a sourceText string; it is not 
 * allowed anymore to pass NULL.  (If you really don't have source text, 
 * you can pass a constant string, perhaps "(query not available)".) 
 * 
 * commandTag shall be NULL if and only if the original query string 
 * (before rewriting) was an empty string.  Also, the passed commandTag must 
 * be a pointer to a constant string, since it is not copied. 
 * 
 * If cplan is provided, then it is a cached plan containing the stmts, and 
 * the caller must have done GetCachedPlan(), causing a refcount increment. 
 * The refcount will be released when the portal is destroyed. 
 * 
 * If cplan is NULL, then it is the caller's responsibility to ensure that 
 * the passed plan trees have adequate lifetime.  Typically this is done by 
 * copying them into the portal's heap context. 
 * 
 * The caller is also responsible for ensuring that the passed prepStmtName 
 * (if not NULL) and sourceText have adequate lifetime. 
 * 
 * NB: this function mustn't do much beyond storing the passed values; in 
 * particular don't do anything that risks elog(ERROR).  If that were to 
 * happen here before storing the cplan reference, we'd leak the plancache 
 * refcount that the caller is trying to hand off to us. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN276"></a><span class='Declare_Function'>PortalDefineQuery</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Delimiter'>, 
</span><a name="LN277"></a>                  <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>prepStmtName</span><span class='Delimiter'>, 
</span><a name="LN278"></a>                  <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sourceText</span><span class='Delimiter'>, 
</span><a name="LN279"></a>                  <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>commandTag</span><span class='Delimiter'>, 
</span><a name="LN280"></a>                  <a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>stmts</span><span class='Delimiter'>, 
</span><a name="LN281"></a>                  <a href="../../../include/utils/plancache.h.html#LN129"><span class='Ref_to_Struct'>CachedPlan</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>cplan</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN198"><span class='Ref_to_Macro'>PortalIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN677"><span class='Ref_to_Macro'>AssertState</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN103"><span class='Ref_to_EnumConst'>PORTAL_NEW</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN278"><span class='Ref_to_Parameter'>sourceText</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN279"><span class='Ref_to_Parameter'>commandTag</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>|| </span><a href="portalmem.c.html#LN280"><span class='Ref_to_Parameter'>stmts</span></a> <span class='Operator'>== </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN117"><span class='Ref_to_Member'>prepStmtName</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN277"><span class='Ref_to_Parameter'>prepStmtName</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN133"><span class='Ref_to_Member'>sourceText</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN278"><span class='Ref_to_Parameter'>sourceText</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN134"><span class='Ref_to_Member'>commandTag</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN279"><span class='Ref_to_Parameter'>commandTag</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN135"><span class='Ref_to_Member'>stmts</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN280"><span class='Ref_to_Parameter'>stmts</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN136"><span class='Ref_to_Member'>cplan</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN281"><span class='Ref_to_Parameter'>cplan</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN276"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN104"><span class='Ref_to_EnumConst'>PORTAL_DEFINED</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PortalDefineQuery &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PortalReleaseCachedPlan 
 *      Release a portal's reference to its cached plan, if any. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN302"></a><span class='Declare_Function'>PortalReleaseCachedPlan</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN302"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN136"><span class='Ref_to_Member'>cplan</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/utils/plancache.h.html#LN182"><span class='Ref_to_Proto'>ReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN302"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN136"><span class='Ref_to_Member'>cplan</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN302"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN136"><span class='Ref_to_Member'>cplan</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * We must also clear portal-&GT;stmts which is now a dangling reference 
         * to the cached plan's plan list.  This protects any code that might 
         * try to examine the Portal later. 
         */ 
</span>        <a href="portalmem.c.html#LN302"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN135"><span class='Ref_to_Member'>stmts</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PortalCreateHoldStore 
 *      Create the tuplestore for a portal. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN323"></a><span class='Declare_Function'>PortalCreateHoldStore</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN325"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN163"><span class='Ref_to_Member'>holdStore</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN174"><span class='Ref_to_Member'>holdSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the memory context that is used for storage of the tuple set. 
     * Note this is NOT a child of the portal's heap memory. 
     */ 
</span>    <a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/memutils.h.html#LN145"><span class='Ref_to_Proto'>AllocSetContextCreate</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN89"><span class='Ref_to_Global_Var'>PortalMemory</span></a><span class='Delimiter'>, 
</span>                              <span class='String'>"PortalHoldContext"</span><span class='Delimiter'>, 
</span>                              <a href="../../../include/utils/memutils.h.html#LN164"><span class='Ref_to_Const'>ALLOCSET_DEFAULT_SIZES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create the tuple store, selecting cross-transaction temp files, and 
     * enabling random access only if cursor requires scrolling. 
     * 
     * XXX: Should maintenance_work_mem be used for the portal size? 
     */ 
</span>    <a href="portalmem.c.html#LN325"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN163"><span class='Ref_to_Member'>holdStore</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN323"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2602"><span class='Ref_to_Const'>CURSOR_OPT_SCROLL</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN325"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PortalCreateHoldStore &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PinPortal 
 *      Protect a portal from dropping. 
 * 
 * A pinned portal is still unpinned and dropped at transaction or 
 * subtransaction abort. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN363"></a><span class='Declare_Function'>PinPortal</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN363"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"portal already pinned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN363"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>void 
</span><a name="LN372"></a><span class='Declare_Function'>UnpinPortal</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="portalmem.c.html#LN372"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"portal not pinned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN372"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MarkPortalActive 
 *      Transition a portal from READY to ACTIVE state. 
 * 
 * NOTE: never set portal-&GT;status = PORTAL_ACTIVE directly; call this instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN387"></a><span class='Declare_Function'>MarkPortalActive</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* For safety, this is a runtime test not just an Assert */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN387"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/portal.h.html#LN105"><span class='Ref_to_EnumConst'>PORTAL_READY</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"portal \"%s\" cannot be run"</span><span class='Delimiter'>, </span><a href="portalmem.c.html#LN387"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN116"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Perform the state transition */ 
</span>    <a href="portalmem.c.html#LN387"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN387"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN336"><span class='Ref_to_Proto'>GetCurrentSubTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * MarkPortalDone 
 *      Transition a portal from ACTIVE to DONE state. 
 * 
 * NOTE: never set portal-&GT;status = PORTAL_DONE directly; call this instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN406"></a><span class='Declare_Function'>MarkPortalDone</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Perform the state transition */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN107"><span class='Ref_to_EnumConst'>PORTAL_DONE</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow portalcmds.c to clean up the state it knows about.  We might as 
     * well do that now, since the portal can't be executed any more. 
     * 
     * In some cases involving execution of a ROLLBACK command in an already 
     * aborted transaction, this prevents an assertion failure caused by 
     * reaching AtCleanup_Portals with the cleanup hook still unexecuted. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>) (</span><a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN406"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end MarkPortalDone &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * MarkPortalFailed 
 *      Transition a portal into FAILED state. 
 * 
 * NOTE: never set portal-&GT;status = PORTAL_FAILED directly; call this instead. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN434"></a><span class='Declare_Function'>MarkPortalFailed</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Perform the state transition */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/portal.h.html#LN107"><span class='Ref_to_EnumConst'>PORTAL_DONE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>= </span><a href="../../../include/utils/portal.h.html#LN108"><span class='Ref_to_EnumConst'>PORTAL_FAILED</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow portalcmds.c to clean up the state it knows about.  We might as 
     * well do that now, since the portal can't be executed any more. 
     * 
     * In some cases involving cleanup of an already aborted transaction, this 
     * prevents an assertion failure caused by reaching AtCleanup_Portals with 
     * the cleanup hook still unexecuted. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>) (</span><a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN434"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end MarkPortalFailed &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PortalDrop 
 *      Destroy the portal. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN460"></a><span class='Declare_Function'>PortalDrop</span><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a> <span class='Declare_Parameter'>portal</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isTopCommit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/c.h.html#LN676"><span class='Ref_to_Macro'>AssertArg</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN198"><span class='Ref_to_Macro'>PortalIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't allow dropping a pinned portal, it's still needed by whoever 
     * pinned it. Not sure if the PORTAL_ACTIVE case can validly happen or 
     * not... 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a> <span class='Operator'>|| 
</span>        <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_CURSOR_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot drop active portal \"%s\""</span><span class='Delimiter'>, </span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN116"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Allow portalcmds.c to clean up the state it knows about, in particular 
     * shutting down the executor if still active.  This step potentially runs 
     * user-defined code so failure has to be expected.  It's the cleanup 
     * hook's responsibility to not try to do that more than once, in the case 
     * that failure occurs and then we come back to drop the portal again 
     * during transaction abort. 
     * 
     * Note: in most paths of control, this will have been done already in 
     * MarkPortalDone or MarkPortalFailed.  We're just making sure. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>) (</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Remove portal from hash table.  Because we do this here, we will not 
     * come back to try to remove the portal again if there's any error in the 
     * subsequent steps.  Better to leak a little memory than to get into an 
     * infinite error-recovery loop. 
     */ 
</span>    <a href="portalmem.c.html#LN79"><span class='Ref_to_Macro'>PortalHashTableDelete</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* drop cached plan reference, if any */ 
</span>    <a href="portalmem.c.html#LN301"><span class='Ref_to_Func'>PortalReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If portal has a snapshot protecting its data, release that.  This needs 
     * a little care since the registration will be attached to the portal's 
     * resowner; if the portal failed, we will already have released the 
     * resowner (and the snapshot) during transaction abort. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN174"><span class='Ref_to_Member'>holdSnapshot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/snapmgr.h.html#LN83"><span class='Ref_to_Proto'>UnregisterSnapshotFromOwner</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN174"><span class='Ref_to_Member'>holdSnapshot</span></a><span class='Delimiter'>, 
</span>                                        <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN174"><span class='Ref_to_Member'>holdSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Release any resources still attached to the portal.  There are several 
     * cases being covered here: 
     * 
     * Top transaction commit (indicated by isTopCommit): normally we should 
     * do nothing here and let the regular end-of-transaction resource 
     * releasing mechanism handle these resources too.  However, if we have a 
     * FAILED portal (eg, a cursor that got an error), we'd better clean up 
     * its resources to avoid resource-leakage warning messages. 
     * 
     * Sub transaction commit: never comes here at all, since we don't kill 
     * any portals in AtSubCommit_Portals(). 
     * 
     * Main or sub transaction abort: we will do nothing here because 
     * portal-&GT;resowner was already set NULL; the resources were already 
     * cleaned up in transaction abort. 
     * 
     * Ordinary portal drop: must release resources.  However, if the portal 
     * is not FAILED then we do not release its locks.  The locks become the 
     * responsibility of the transaction's ResourceOwner (since it is the 
     * parent of the portal's owner) and will be released when the transaction 
     * eventually ends. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>isTopCommit</span></a> <span class='Operator'>|| </span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN108"><span class='Ref_to_EnumConst'>PORTAL_FAILED</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN543"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>isCommit</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/portal.h.html#LN108"><span class='Ref_to_EnumConst'>PORTAL_FAILED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN46"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_BEFORE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <a href="portalmem.c.html#LN543"><span class='Ref_To_Local'>isCommit</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN47"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <a href="portalmem.c.html#LN543"><span class='Ref_To_Local'>isCommit</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN68"><span class='Ref_to_Proto'>ResourceOwnerRelease</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, 
</span>                             <a href="../../../include/utils/resowner.h.html#LN48"><span class='Ref_to_EnumConst'>RESOURCE_RELEASE_AFTER_LOCKS</span></a><span class='Delimiter'>, 
</span>                             <a href="portalmem.c.html#LN543"><span class='Ref_To_Local'>isCommit</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/resowner.h.html#LN72"><span class='Ref_to_Proto'>ResourceOwnerDelete</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Delete tuplestore if present.  We should do this even under error 
     * conditions; since the tuplestore would have been using cross- 
     * transaction storage, its temp files need to be explicitly deleted. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN163"><span class='Ref_to_Member'>holdStore</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN565"></a>        <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span> 
        <a href="portalmem.c.html#LN565"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/tuplestore.h.html#LN88"><span class='Ref_to_Proto'>tuplestore_end</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN163"><span class='Ref_to_Member'>holdStore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN565"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN163"><span class='Ref_to_Member'>holdStore</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* delete tuplestore storage, if any */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN164"><span class='Ref_to_Member'>holdContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release subsidiary storage */ 
</span>    <a href="../../../include/utils/memutils.h.html#LN74"><span class='Ref_to_Proto'>MemoryContextDelete</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN204"><span class='Ref_to_Macro'>PortalGetHeapMemory</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* release portal struct (it's in PortalMemory) */ 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN460"><span class='Ref_to_Parameter'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PortalDrop &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Delete all declared cursors. 
 * 
 * Used by commands: CLOSE ALL, DISCARD ALL 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN590"></a><span class='Declare_Function'>PortalHashTableDeleteAll</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN592"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN593"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN592"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN593"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN592"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN601"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN593"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Can't close the active portal (the one running the command) */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN601"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/portal.h.html#LN227"><span class='Ref_to_Proto'>PortalDrop</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN601"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Restart the iteration in case that led to other drops */ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN136"><span class='Ref_to_Proto'>hash_seq_term</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN592"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN592"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end PortalHashTableDeleteAll &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Pre-commit processing for portals. 
 * 
 * Holdable cursors created in this transaction need to be converted to 
 * materialized form, since we are going to close down the executor and 
 * release locks.  Non-holdable portals created in this transaction are 
 * simply removed.  Portals remaining from prior transactions should be 
 * left untouched. 
 * 
 * Returns TRUE if any portals changed state (possibly causing user-defined 
 * code to be run), FALSE if not. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN629"></a><span class='Declare_Function'>PreCommit_Portals</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isPrepare</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN631"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>result</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN632"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN633"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN632"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN633"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN632"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN639"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN633"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * There should be no pinned portals anymore. Complain if someone 
         * leaked one. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot commit while a portal is pinned"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Do not touch active portals --- this can only happen in the case of 
         * a multi-transaction utility command, such as VACUUM. 
         * 
         * Note however that any resource owner attached to such a portal is 
         * still going to go away, so don't leave a dangling pointer. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Is it a holdable portal created in the current xact? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2605"><span class='Ref_to_Const'>CURSOR_OPT_HOLD</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>!= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a> <span class='Operator'>&& 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN105"><span class='Ref_to_EnumConst'>PORTAL_READY</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We are exiting the transaction that created a holdable cursor. 
             * Instead of dropping the portal, prepare it for access by later 
             * transactions. 
             * 
             * However, if this is PREPARE TRANSACTION rather than COMMIT, 
             * refuse PREPARE, because the semantics seem pretty unclear. 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN629"><span class='Ref_to_Parameter'>isPrepare</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                        <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                         <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot PREPARE a transaction that has created a cursor WITH HOLD"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Note that PersistHoldablePortal() must release all resources 
             * used by the portal that are local to the creating transaction. 
             */ 
</span>            <a href="../../../include/utils/portal.h.html#LN236"><span class='Ref_to_Proto'>PortalCreateHoldStore</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../include/commands/portalcmds.h.html#LN30"><span class='Ref_to_Proto'>PersistHoldablePortal</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* drop cached plan reference, if any */ 
</span>            <a href="portalmem.c.html#LN301"><span class='Ref_to_Func'>PortalReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Any resources belonging to the portal will be released in the 
             * upcoming transaction-wide cleanup; the portal will no longer 
             * have its own resources. 
             */ 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Having successfully exported the holdable cursor, mark it as 
             * not belonging to this transaction. 
             */ 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Delimiter'>; 
</span>            <a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Report we changed state */ 
</span>            <a href="portalmem.c.html#LN631"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if (portal-&GT;cursorOption... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Do nothing to cursors held over from a previous transaction 
             * (including ones we just froze in a previous cycle of this loop) 
             */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Zap all non-holdable portals */ 
</span>            <a href="../../../include/utils/portal.h.html#LN227"><span class='Ref_to_Proto'>PortalDrop</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN639"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Report we changed state */ 
</span>            <a href="portalmem.c.html#LN631"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * After either freezing or dropping a portal, we have to restart the 
         * iteration, because we could have invoked user-defined code that 
         * caused a drop of the next portal in the hash chain. 
         */ 
</span>        <a href="../../../include/utils/hsearch.h.html#LN136"><span class='Ref_to_Proto'>hash_seq_term</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN632"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN632"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=(PortalHashEn... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="portalmem.c.html#LN631"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PreCommit_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Abort processing for portals. 
 * 
 * At this point we reset "active" status and run the cleanup hook if 
 * present, but we can't release the portal's memory until the cleanup call. 
 * 
 * The reason we need to reset active is so that we can replace the unnamed 
 * portal, else we'll fail to execute ROLLBACK when it arrives. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN745"></a><span class='Declare_Function'>AtAbort_Portals</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN747"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN748"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN747"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN748"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN747"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN754"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN748"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * See similar code in AtSubAbort_Portals().  This would fire if code 
         * orchestrating multiple top-level transactions within a portal, such 
         * as VACUUM, caught errors and continued under the same portal with a 
         * fresh transaction.  No part of core PostgreSQL functions that way. 
         * XXX Such code would wish the portal to remain ACTIVE, as in 
         * PreCommit_Portals(). 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/portal.h.html#LN226"><span class='Ref_to_Proto'>MarkPortalFailed</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Do nothing else to cursors held over from a previous transaction. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If it was created in the current transaction, we can't do normal 
         * shutdown on a READY portal either; it might refer to objects 
         * created in the failed transaction.  See comments in 
         * AtSubAbort_Portals. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN105"><span class='Ref_to_EnumConst'>PORTAL_READY</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/portal.h.html#LN226"><span class='Ref_to_Proto'>MarkPortalFailed</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allow portalcmds.c to clean up the state it knows about, if we 
         * haven't already. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>) (</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* drop cached plan reference, if any */ 
</span>        <a href="portalmem.c.html#LN301"><span class='Ref_to_Func'>PortalReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Any resources belonging to the portal will be released in the 
         * upcoming transaction-wide cleanup; they will be gone before we run 
         * PortalDrop. 
         */ 
</span>        <a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Although we can't delete the portal data structure proper, we can 
         * release any memory in subsidiary contexts, such as executor state. 
         * The cleanup hook was the last thing that might have needed data 
         * there. 
         */ 
</span>        <a href="../../../include/utils/memutils.h.html#LN77"><span class='Ref_to_Proto'>MemoryContextDeleteChildren</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN204"><span class='Ref_to_Macro'>PortalGetHeapMemory</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN754"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=(PortalHashEn... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtAbort_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Post-abort cleanup for portals. 
 * 
 * Delete all portals not held over from prior transactions.  */ 
</span><span class='Keyword'>void 
</span><a name="LN817"></a><span class='Declare_Function'>AtCleanup_Portals</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN819"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN820"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN819"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN820"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN819"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN826"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN820"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Do nothing to cursors held over from a previous transaction */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>== </span><a href="../../../include/c.h.html#LN402"><span class='Ref_to_Const'>InvalidSubTransactionId</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If a portal is still pinned, forcibly unpin it. PortalDrop will not 
         * let us drop the portal otherwise. Whoever pinned the portal was 
         * interrupted by the abort too and won't try to use it anymore. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a><span class='Parentheses'>) 
</span>            <a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We had better not be calling any user-defined code here */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Zap it. */ 
</span>        <a href="../../../include/utils/portal.h.html#LN227"><span class='Ref_to_Proto'>PortalDrop</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN826"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=(PortalHashEn... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtCleanup_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Pre-subcommit processing for portals. 
 * 
 * Reassign portals created or used in the current subtransaction to the 
 * parent subtransaction. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN859"></a><span class='Declare_Function'>AtSubCommit_Portals</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Delimiter'>, 
</span><a name="LN860"></a>                    <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>parentSubid</span><span class='Delimiter'>, 
</span><a name="LN861"></a>                    <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>parentXactOwner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN863"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN864"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN863"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN864"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN863"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN870"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN864"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>== </span><a href="portalmem.c.html#LN859"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN860"><span class='Ref_to_Parameter'>parentSubid</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>) 
</span>                <a href="../../../include/utils/resowner.h.html#LN74"><span class='Ref_to_Proto'>ResourceOwnerNewParent</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN861"><span class='Ref_to_Parameter'>parentXactOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>== </span><a href="portalmem.c.html#LN859"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>            <a href="portalmem.c.html#LN870"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN860"><span class='Ref_to_Parameter'>parentSubid</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end AtSubCommit_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Subtransaction abort handling for portals. 
 * 
 * Deactivate portals created or used during the failed subtransaction. 
 * Note that per AtSubCommit_Portals, this will catch portals created/used 
 * in descendants of the subtransaction too. 
 * 
 * We don't destroy any portals here; that's done in AtSubCleanup_Portals. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN893"></a><span class='Declare_Function'>AtSubAbort_Portals</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Delimiter'>, 
</span><a name="LN894"></a>                   <a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>parentSubid</span><span class='Delimiter'>, 
</span><a name="LN895"></a>                   <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>myXactOwner</span><span class='Delimiter'>, 
</span><a name="LN896"></a>                   <a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>parentXactOwner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN898"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN899"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN898"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN899"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN898"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN905"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN899"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Was it created in this subtransaction? */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>!= </span><a href="portalmem.c.html#LN893"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* No, but maybe it was used in this subtransaction? */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>== </span><a href="portalmem.c.html#LN893"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Maintain activeSubid until the portal is removed */ 
</span>                <a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN130"><span class='Ref_to_Member'>activeSubid</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN894"><span class='Ref_to_Parameter'>parentSubid</span></a><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * A MarkPortalActive() caller ran an upper-level portal in 
                 * this subtransaction and left the portal ACTIVE.  This can't 
                 * happen, but force the portal into FAILED state for the same 
                 * reasons discussed below. 
                 * 
                 * We assume we can get away without forcing upper-level READY 
                 * portals to fail, even if they were run and then suspended. 
                 * In theory a suspended upper-level portal could have 
                 * acquired some references to objects that are about to be 
                 * destroyed, but there should be sufficient defenses against 
                 * such cases: the portal's original query cannot contain such 
                 * references, and any references within, say, cached plans of 
                 * PL/pgSQL functions are not from active queries and should 
                 * be protected by revalidation logic. 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>                    <a href="../../../include/utils/portal.h.html#LN226"><span class='Ref_to_Proto'>MarkPortalFailed</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * Also, if we failed it during the current subtransaction 
                 * (either just above, or earlier), reattach its resource 
                 * owner to the current subtransaction's resource owner, so 
                 * that any resources it still holds will be released while 
                 * cleaning up this subtransaction.  This prevents some corner 
                 * cases wherein we might get Asserts or worse while cleaning 
                 * up objects created during the current subtransaction 
                 * (because they're still referenced within this portal). 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN108"><span class='Ref_to_EnumConst'>PORTAL_FAILED</span></a> <span class='Operator'>&& </span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../include/utils/resowner.h.html#LN74"><span class='Ref_to_Proto'>ResourceOwnerNewParent</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN895"><span class='Ref_to_Parameter'>myXactOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if portal-&GT;activeSubid==... &raquo; </span> 
            <span class='Comment_Multi_Line'>/* Done if it wasn't created in this subtransaction */ 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if portal-&GT;createSubid!=... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Force any live portals of my own subtransaction into FAILED state. 
         * We have to do this because they might refer to objects created or 
         * changed in the failed subtransaction, leading to crashes within 
         * ExecutorEnd when portalcmds.c tries to close down the portal. 
         * Currently, every MarkPortalActive() caller ensures it updates the 
         * portal status again before relinquishing control, so ACTIVE can't 
         * happen here.  If it does happen, dispose the portal like existing 
         * MarkPortalActive() callers would. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN105"><span class='Ref_to_EnumConst'>PORTAL_READY</span></a> <span class='Operator'>|| 
</span>            <a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN106"><span class='Ref_to_EnumConst'>PORTAL_ACTIVE</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/portal.h.html#LN226"><span class='Ref_to_Proto'>MarkPortalFailed</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Allow portalcmds.c to clean up the state it knows about, if we 
         * haven't already. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN525"><span class='Ref_to_Macro'>PointerIsValid</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a><span class='Parentheses'>) (</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* drop cached plan reference, if any */ 
</span>        <a href="portalmem.c.html#LN301"><span class='Ref_to_Func'>PortalReleaseCachedPlan</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Any resources belonging to the portal will be released in the 
         * upcoming transaction-wide cleanup; they will be gone before we run 
         * PortalDrop. 
         */ 
</span>        <a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN119"><span class='Ref_to_Member'>resowner</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Although we can't delete the portal data structure proper, we can 
         * release any memory in subsidiary contexts, such as executor state. 
         * The cleanup hook was the last thing that might have needed data 
         * there. 
         */ 
</span>        <a href="../../../include/utils/memutils.h.html#LN77"><span class='Ref_to_Proto'>MemoryContextDeleteChildren</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/portal.h.html#LN204"><span class='Ref_to_Macro'>PortalGetHeapMemory</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN905"><span class='Ref_To_Local'>portal</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=(PortalHashEn... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtSubAbort_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Post-subabort cleanup for portals. 
 * 
 * Drop all portals created in the failed subtransaction (but note that 
 * we will not drop any that were reassigned to the parent above). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1006"></a><span class='Declare_Function'>AtSubCleanup_Portals</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN400"><span class='Ref_to_Typedef'>SubTransactionId</span></a> <span class='Declare_Parameter'>mySubid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1008"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1009"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1008"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN1009"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1008"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1015"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN1009"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN1015"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN129"><span class='Ref_to_Member'>createSubid</span></a> <span class='Operator'>!= </span><a href="portalmem.c.html#LN1006"><span class='Ref_to_Parameter'>mySubid</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * If a portal is still pinned, forcibly unpin it. PortalDrop will not 
         * let us drop the portal otherwise. Whoever pinned the portal was 
         * interrupted by the abort too and won't try to use it anymore. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN1015"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a><span class='Parentheses'>) 
</span>            <a href="portalmem.c.html#LN1015"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN148"><span class='Ref_to_Member'>portalPinned</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* We had better not be calling any user-defined code here */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1015"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN120"><span class='Ref_to_Member'>cleanup</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Zap it. */ 
</span>        <a href="../../../include/utils/portal.h.html#LN227"><span class='Ref_to_Proto'>PortalDrop</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1015"><span class='Ref_To_Local'>portal</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=(PortalHashEn... &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end AtSubCleanup_Portals &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* Find all available cursors */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1038"></a><span class='Declare_Function'>pg_cursor</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1040"></a>    <a href="../../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Declare_Local'>rsinfo</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span>fcinfo<span class='Operator'>-&GT;</span>resultinfo<span class='Delimiter'>; 
</span><a name="LN1041"></a>    <a href="../../../include/access/tupdesc.h.html#LN70"><span class='Ref_to_Typedef'>TupleDesc</span></a>   <span class='Declare_Local'>tupdesc</span><span class='Delimiter'>; 
</span><a name="LN1042"></a>    <a href="../sort/tuplestore.c.html#LN102"><span class='Ref_to_Struct'>Tuplestorestate</span></a> <span class='Operator'>*</span><span class='Declare_Local'>tupstore</span><span class='Delimiter'>; 
</span><a name="LN1043"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>per_query_ctx</span><span class='Delimiter'>; 
</span><a name="LN1044"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcontext</span><span class='Delimiter'>; 
</span><a name="LN1045"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>hash_seq</span><span class='Delimiter'>; 
</span><a name="LN1046"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* check to see if caller supports us returning a tuplestore */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>|| !</span><a href="../../../include/nodes/nodes.h.html#LN559"><span class='Ref_to_Macro'>IsA</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/execnodes.h.html#LN261"><span class='Ref_to_Struct'>ReturnSetInfo</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"set-valued function called in context that cannot accept a set"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"materialize mode required, but it is not "</span> <span class='Operator'>\ 
</span>                        <span class='String'>"allowed in this context"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* need to build tuplestore in query context */ 
</span>    <a href="portalmem.c.html#LN1043"><span class='Ref_To_Local'>per_query_ctx</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN265"><span class='Ref_to_Member'>econtext</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN201"><span class='Ref_to_Member'>ecxt_per_query_memory</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN1044"><span class='Ref_To_Local'>oldcontext</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1043"><span class='Ref_To_Local'>per_query_ctx</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * build tupdesc for result tuples. This must match the definition of the 
     * pg_cursors view in system_views.sql 
     */ 
</span>    <a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a> <span class='Operator'>= </span><a href="../../access/common/tupdesc.c.html#LN39"><span class='Ref_to_Func'>CreateTemplateTupleDesc</span></a><span class='Parentheses'>(</span><span class='Number'>6</span><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='String'>"name"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>2</span><span class='Delimiter'>, </span><span class='String'>"statement"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN26"><span class='Ref_to_Const'>TEXTOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>3</span><span class='Delimiter'>, </span><span class='String'>"is_holdable"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>4</span><span class='Delimiter'>, </span><span class='String'>"is_binary"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='String'>"is_scrollable"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN17"><span class='Ref_to_Const'>BOOLOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/access/tupdesc.h.html#LN114"><span class='Ref_to_Proto'>TupleDescInitEntry</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../../include/access/attnum.h.html#LN20"><span class='Ref_to_Typedef'>AttrNumber</span></a><span class='Parentheses'>) </span><span class='Number'>6</span><span class='Delimiter'>, </span><span class='String'>"creation_time"</span><span class='Delimiter'>, 
</span>                       <a href="../../../interfaces/ecpg/ecpglib/pg_type.h.html#LN53"><span class='Ref_to_Const'>TIMESTAMPTZOID</span></a><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We put all the tuples into a tuplestore in one scan of the hashtable. 
     * This avoids any issue of the hashtable possibly changing between calls. 
     */ 
</span>    <a href="portalmem.c.html#LN1042"><span class='Ref_To_Local'>tupstore</span></a> <span class='Operator'>= 
</span>        <a href="../../../include/utils/tuplestore.h.html#LN46"><span class='Ref_to_Proto'>tuplestore_begin_heap</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN267"><span class='Ref_to_Member'>allowedModes</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/execnodes.h.html#LN251"><span class='Ref_to_EnumConst'>SFRM_Materialize_Random</span></a><span class='Delimiter'>, 
</span>                              <span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../init/globals.c.html#LN112"><span class='Ref_to_Global_Var'>work_mem</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* generate junk in short-term context */ 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1044"><span class='Ref_To_Local'>oldcontext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1045"><span class='Ref_To_Local'>hash_seq</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN1046"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1045"><span class='Ref_To_Local'>hash_seq</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1095"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN1046"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span><a name="LN1096"></a>        <a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a>       <span class='Declare_Local'>values</span><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>]; 
</span><a name="LN1097"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>nulls</span><span class='Delimiter'>[</span><span class='Number'>6</span><span class='Delimiter'>]; 
</span> 
        <span class='Comment_Multi_Line'>/* report only "visible" entries */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN191"><span class='Ref_to_Member'>visible</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1097"><span class='Ref_To_Local'>nulls</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1097"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN116"><span class='Ref_to_Member'>name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/utils/builtins.h.html#LN90"><span class='Ref_to_Macro'>CStringGetTextDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN133"><span class='Ref_to_Member'>sourceText</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2605"><span class='Ref_to_Const'>CURSOR_OPT_HOLD</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2601"><span class='Ref_to_Const'>CURSOR_OPT_BINARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/postgres.h.html#LN407"><span class='Ref_to_Macro'>BoolGetDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN143"><span class='Ref_to_Member'>cursorOptions</span></a> <span class='Operator'>& </span><a href="../../../include/nodes/parsenodes.h.html#LN2602"><span class='Ref_to_Const'>CURSOR_OPT_SCROLL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>[</span><span class='Number'>5</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN31"><span class='Ref_to_Macro'>TimestampTzGetDatum</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1095"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN190"><span class='Ref_to_Member'>creation_time</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/utils/tuplestore.h.html#LN55"><span class='Ref_to_Proto'>tuplestore_putvalues</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1042"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN1096"><span class='Ref_To_Local'>values</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN1097"><span class='Ref_To_Local'>nulls</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (hentry=hash_seq_sear... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* clean up and return the tuplestore */ 
</span>    <a href="../../../include/utils/tuplestore.h.html#LN59"><span class='Ref_to_Macro'>tuplestore_donestoring</span></a><span class='Parentheses'>(</span><a href="portalmem.c.html#LN1042"><span class='Ref_To_Local'>tupstore</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN269"><span class='Ref_to_Member'>returnMode</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/execnodes.h.html#LN250"><span class='Ref_to_EnumConst'>SFRM_Materialize</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN272"><span class='Ref_to_Member'>setResult</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN1042"><span class='Ref_To_Local'>tupstore</span></a><span class='Delimiter'>; 
</span>    <a href="portalmem.c.html#LN1040"><span class='Ref_To_Local'>rsinfo</span></a><span class='Operator'>-&GT;</span><a href="../../../include/nodes/execnodes.h.html#LN273"><span class='Ref_to_Member'>setDesc</span></a> <span class='Operator'>= </span><a href="portalmem.c.html#LN1041"><span class='Ref_To_Local'>tupdesc</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a><span class='Parentheses'>) </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end pg_cursor &raquo; </span> 
 
<span class='Keyword'>bool 
</span><a name="LN1126"></a><span class='Declare_Function'>ThereAreNoReadyPortals</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1128"></a>    <a href="../../../include/utils/hsearch.h.html#LN111"><span class='Ref_to_Typedef'>HASH_SEQ_STATUS</span></a> <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1129"></a>    <a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>hentry</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/hsearch.h.html#LN134"><span class='Ref_to_Proto'>hash_seq_init</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1128"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><a href="portalmem.c.html#LN52"><span class='Ref_to_Global_Var'>PortalHashTable</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="portalmem.c.html#LN1129"><span class='Ref_To_Local'>hentry</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="portalmem.c.html#LN46"><span class='Ref_to_Typedef'>PortalHashEnt</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/utils/hsearch.h.html#LN135"><span class='Ref_to_Proto'>hash_seq_search</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="portalmem.c.html#LN1128"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1135"></a>        <a href="../../../include/utils/portal.h.html#LN111"><span class='Ref_to_Typedef'>Portal</span></a>      <span class='Declare_Local'>portal</span> <span class='Operator'>= </span><a href="portalmem.c.html#LN1129"><span class='Ref_To_Local'>hentry</span></a><span class='Operator'>-&GT;</span><a href="portalmem.c.html#LN49"><span class='Ref_to_Member'>portal</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="portalmem.c.html#LN1135"><span class='Ref_To_Local'>portal</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/portal.h.html#LN147"><span class='Ref_to_Member'>status</span></a> <span class='Operator'>== </span><a href="../../../include/utils/portal.h.html#LN105"><span class='Ref_to_EnumConst'>PORTAL_READY</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>