<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\sort\logtape.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\sort\logtape.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:58 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * logtape.c 
 *    Management of "logical tapes" within temporary files. 
 * 
 * This module exists to support sorting via multiple merge passes (see 
 * tuplesort.c).  Merging is an ideal algorithm for tape devices, but if 
 * we implement it on disk by creating a separate file for each "tape", 
 * there is an annoying problem: the peak space usage is at least twice 
 * the volume of actual data to be sorted.  (This must be so because each 
 * datum will appear in both the input and output tapes of the final 
 * merge pass.  For seven-tape polyphase merge, which is otherwise a 
 * pretty good algorithm, peak usage is more like 4x actual data volume.) 
 * 
 * We can work around this problem by recognizing that any one tape 
 * dataset (with the possible exception of the final output) is written 
 * and read exactly once in a perfectly sequential manner.  Therefore, 
 * a datum once read will not be required again, and we can recycle its 
 * space for use by the new tape dataset(s) being generated.  In this way, 
 * the total space usage is essentially just the actual data volume, plus 
 * insignificant bookkeeping and start/stop overhead. 
 * 
 * Few OSes allow arbitrary parts of a file to be released back to the OS, 
 * so we have to implement this space-recycling ourselves within a single 
 * logical file.  logtape.c exists to perform this bookkeeping and provide 
 * the illusion of N independent tape devices to tuplesort.c.  Note that 
 * logtape.c itself depends on buffile.c to provide a "logical file" of 
 * larger size than the underlying OS may support. 
 * 
 * For simplicity, we allocate and release space in the underlying file 
 * in BLCKSZ-size blocks.  Space allocation boils down to keeping track 
 * of which blocks in the underlying file belong to which logical tape, 
 * plus any blocks that are free (recycled and not yet reused). 
 * The blocks in each logical tape form a chain, with a prev- and next- 
 * pointer in each block. 
 * 
 * The initial write pass is guaranteed to fill the underlying file 
 * perfectly sequentially, no matter how data is divided into logical tapes. 
 * Once we begin merge passes, the access pattern becomes considerably 
 * less predictable --- but the seeking involved should be comparable to 
 * what would happen if we kept each logical tape in a separate file, 
 * so there's no serious performance penalty paid to obtain the space 
 * savings of recycling.  We try to localize the write accesses by always 
 * writing to the lowest-numbered free block when we have a choice; it's 
 * not clear this helps much, but it can't hurt.  (XXX perhaps a LIFO 
 * policy for free blocks would be better?) 
 * 
 * To further make the I/Os more sequential, we can use a larger buffer 
 * when reading, and read multiple blocks from the same tape in one go, 
 * whenever the buffer becomes empty.  LogicalTapeAssignReadBufferSize() 
 * can be used to set the size of the read buffer. 
 * 
 * To support the above policy of writing to the lowest free block, 
 * ltsGetFreeBlock sorts the list of free block numbers into decreasing 
 * order each time it is asked for a block and the list isn't currently 
 * sorted.  This is an efficient way to handle it because we expect cycles 
 * of releasing many blocks followed by re-using many blocks, due to 
 * the larger read buffer. 
 * 
 * Since all the bookkeeping and buffer memory is allocated with palloc(), 
 * and the underlying file(s) are made with OpenTemporaryFile, all resources 
 * for a logical tape set are certain to be cleaned up even if processing 
 * is aborted by ereport(ERROR).  To avoid confusion, the caller should take 
 * care that all calls for a single LogicalTapeSet are made in the same 
 * palloc context. 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/sort/logtape.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"storage/buffile.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/logtape.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
 
<span class='Comment_Multi_Line'>/* 
 * A TapeBlockTrailer is stored at the end of each BLCKSZ block. 
 * 
 * The first block of a tape has prev == -1.  The last block of a tape 
 * stores the number of valid bytes on the block, inverted, in 'next' 
 * Therefore next &LT; 0 indicates the last block. 
 */ 
</span><a name="LN88"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TapeBlockTrailer</span> 
<span class='Delimiter'>{ 
</span><a name="LN90"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>prev</span><span class='Delimiter'>;</span>           <span class='Comment_Multi_Line'>/* previous block on this tape, or -1 on first 
                                 * block */ 
</span><a name="LN92"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>next</span><span class='Delimiter'>;</span>           <span class='Comment_Multi_Line'>/* next block on this tape, or # of valid 
                                 * bytes on last block (if &LT; 0) */ 
</span><a name="LN94"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>TapeBlockTrailer</span><span class='Delimiter'>; 
</span> 
<a name="LN96"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>TapeBlockPayloadSize</span>  <span class='Parentheses'>(</span>BLCKSZ <span class='Operator'>- </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN88"><span class='Ref_to_Struct'>TapeBlockTrailer</span></a><span class='Parentheses'>))</span> 
<a name="LN97"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TapeBlockGetTrailer</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>((</span><a href="logtape.c.html#LN88"><span class='Ref_to_Struct'>TapeBlockTrailer</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <span class='Parentheses'>((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN97"><span class='Ref_to_Parameter'>buf</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Parentheses'>))</span> 
 
<a name="LN100"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TapeBlockIsLast</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) (</span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN100"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<a name="LN101"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TapeBlockGetNBytes</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="logtape.c.html#LN100"><span class='Ref_to_Macro'>TapeBlockIsLast</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN101"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span> <span class='Operator'>? \ 
</span>     <span class='Parentheses'>(</span><span class='Operator'>- </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN101"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Parentheses'>)</span> <span class='Operator'>: </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Parentheses'>)</span> 
<a name="LN104"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>TapeBlockSetNBytes</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>nbytes</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN104"><span class='Ref_to_Parameter'>buf</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next <span class='Operator'>= -</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN104"><span class='Ref_to_Parameter'>nbytes</span></a><span class='Parentheses'>))</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * This data structure represents a single "logical tape" within the set 
 * of logical tapes stored in the same file. 
 * 
 * While writing, we hold the current partially-written data block in the 
 * buffer.  While reading, we can hold multiple blocks in the buffer.  Note 
 * that we don't retain the trailers of a block when it's read into the 
 * buffer.  The buffer therefore contains one large contiguous chunk of data 
 * from the tape. 
 */ 
</span><a name="LN118"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>LogicalTape</span> 
<span class='Delimiter'>{ 
</span><a name="LN120"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>writing</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* T while in write phase */ 
</span><a name="LN121"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>frozen</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* T if blocks should not be freed when read */ 
</span><a name="LN122"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>dirty</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* does buffer need to be written? */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Block numbers of the first, current, and next block of the tape. 
     * 
     * The "current" block number is only valid when writing, or reading from 
     * a frozen tape.  (When reading from an unfrozen tape, we use a larger 
     * read buffer that holds multiple blocks, so the "current" block is 
     * ambiguous.) 
     */ 
</span><a name="LN132"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>firstBlockNumber</span><span class='Delimiter'>; 
</span><a name="LN133"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>curBlockNumber</span><span class='Delimiter'>; 
</span><a name="LN134"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>nextBlockNumber</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Buffer for current data block(s). 
     */ 
</span><a name="LN139"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>buffer</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* physical buffer (separately palloc'd) */ 
</span><a name="LN140"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>buffer_size</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* allocated size of the buffer */ 
</span><a name="LN141"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>pos</span><span class='Delimiter'>;</span>            <span class='Comment_Single_Line'>/* next read/write position in buffer */ 
</span><a name="LN142"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nbytes</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* total # of valid bytes in buffer */ 
</span><a name="LN143"></a><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LogicalTape &raquo; </span> <span class='Declare_Typedef'>LogicalTape</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * This data structure represents a set of related "logical tapes" sharing 
 * space in a single underlying file.  (But that "file" may be multiple files 
 * if needed to escape OS limits on file size; buffile.c handles that for us.) 
 * The number of tapes is fixed at creation. 
 */ 
</span><a name="LN151"></a><span class='Control'>struct</span> <span class='Declare_Struct'>LogicalTapeSet</span> 
<span class='Delimiter'>{ 
</span><a name="LN153"></a>    <a href="../../storage/file/buffile.c.html#LN58"><span class='Ref_to_Struct'>BufFile</span></a>    <span class='Operator'>*</span><span class='Declare_Member'>pfile</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* underlying file for whole tape set */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * File size tracking.  nBlocksWritten is the size of the underlying file, 
     * in BLCKSZ blocks.  nBlocksAllocated is the number of blocks allocated 
     * by ltsGetFreeBlock(), and it is always greater than or equal to 
     * nBlocksWritten.  Blocks between nBlocksAllocated and nBlocksWritten are 
     * blocks that have been allocated for a tape, but have not been written 
     * to the underlying file yet. 
     */ 
</span><a name="LN163"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>nBlocksAllocated</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* # of blocks allocated */ 
</span><a name="LN164"></a>    <span class='Keyword'>long</span>        <span class='Declare_Member'>nBlocksWritten</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* # of blocks used in underlying file */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We store the numbers of recycled-and-available blocks in freeBlocks[]. 
     * When there are no such blocks, we extend the underlying file. 
     * 
     * If forgetFreeSpace is true then any freed blocks are simply forgotten 
     * rather than being remembered in freeBlocks[].  See notes for 
     * LogicalTapeSetForgetFreeSpace(). 
     * 
     * If blocksSorted is true then the block numbers in freeBlocks are in 
     * *decreasing* order, so that removing the last entry gives us the lowest 
     * free block.  We re-sort the blocks whenever a block is demanded; this 
     * should be reasonably efficient given the expected usage pattern. 
     */ 
</span><a name="LN179"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>forgetFreeSpace</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* are we remembering free blocks? */ 
</span><a name="LN180"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>blocksSorted</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* is freeBlocks[] currently in order? */ 
</span><a name="LN181"></a>    <span class='Keyword'>long</span>       <span class='Operator'>*</span><span class='Declare_Member'>freeBlocks</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* resizable array */ 
</span><a name="LN182"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nFreeBlocks</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* # of currently free blocks */ 
</span><a name="LN183"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>freeBlocksLen</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* current allocated length of freeBlocks[] */ 
</span> 
    <span class='Comment_Multi_Line'>/* The array of logical tapes. */ 
</span><a name="LN186"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>nTapes</span><span class='Delimiter'>;</span>         <span class='Comment_Single_Line'>/* # of logical tapes in set */ 
</span><a name="LN187"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Declare_Member'>tapes</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>];</span>   <span class='Comment_Single_Line'>/* has nTapes nentries */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeSet &raquo; </span><span class='Delimiter'>; 
</span> 
<a name="LN190"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ltsWriteBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN191"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ltsReadBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN192"></a><span class='Keyword'>static long </span><span class='Declare_Prototype'>ltsGetFreeBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN193"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ltsReleaseBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write a block-sized buffer to the specified block of the underlying file. 
 * 
 * No need for an error return convention; we ereport() on any error. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN202"></a><span class='Declare_Function'>ltsWriteBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * BufFile does not support "holes", so if we're about to write a block 
     * that's past the current end of file, fill the space between the current 
     * end of file and the target block with zeros. 
     * 
     * This should happen rarely, otherwise you are not writing very 
     * sequentially.  In current use, this only happens when the sort ends 
     * writing a run, and switches to another tape.  The last block of the 
     * previous tape isn't flushed to disk until the end of the sort, so you 
     * get one-block hole, where the last block of the previous tape will 
     * later go. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN164"><span class='Ref_to_Member'>nBlocksWritten</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN218"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>zerobuf</span><span class='Delimiter'>[</span>BLCKSZ<span class='Delimiter'>]; 
</span> 
        <a href="../../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN218"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN218"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN190"><span class='Ref_to_Proto'>ltsWriteBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN164"><span class='Ref_to_Member'>nBlocksWritten</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN218"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Write the requested block */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN42"><span class='Ref_to_Proto'>BufFileSeekBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../include/storage/buffile.h.html#LN39"><span class='Ref_to_Proto'>BufFileWrite</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write block %ld of temporary file: %m"</span><span class='Delimiter'>, 
</span>                        <a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Update nBlocksWritten, if we extended the file */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>== </span><a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN164"><span class='Ref_to_Member'>nBlocksWritten</span></a><span class='Parentheses'>) 
</span>        <a href="logtape.c.html#LN202"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN164"><span class='Ref_to_Member'>nBlocksWritten</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ltsWriteBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read a block-sized buffer from the specified block of the underlying file. 
 * 
 * No need for an error return convention; we ereport() on any error.   This 
 * module should never attempt to read a block it doesn't know is there. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN245"></a><span class='Declare_Function'>ltsReadBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>buffer</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/buffile.h.html#LN42"><span class='Ref_to_Proto'>BufFileSeekBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN245"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN245"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>        <a href="../../../include/storage/buffile.h.html#LN38"><span class='Ref_to_Proto'>BufFileRead</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN245"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN245"><span class='Ref_to_Parameter'>buffer</span></a><span class='Delimiter'>, </span>BLCKSZ<span class='Parentheses'>) </span><span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not read block %ld of temporary file: %m"</span><span class='Delimiter'>, 
</span>                        <a href="logtape.c.html#LN245"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Read as many blocks as we can into the per-tape buffer. 
 * 
 * Returns true if anything was read, 'false' on EOF. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN261"></a><span class='Declare_Function'>ltsReadFillBuffer</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lt</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>do</span> 
    <span class='Delimiter'>{ 
</span><a name="LN268"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>thisbuf</span> <span class='Operator'>= </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Fetch next block number */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>== -</span><span class='Number'>1L</span><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>;</span>              <span class='Comment_Single_Line'>/* EOF */ 
</span> 
        <span class='Comment_Multi_Line'>/* Read the block */ 
</span>        <a href="logtape.c.html#LN191"><span class='Ref_to_Proto'>ltsReadBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN268"><span class='Ref_To_Local'>thisbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN193"><span class='Ref_to_Proto'>ltsReleaseBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>+= </span><a href="logtape.c.html#LN101"><span class='Ref_to_Macro'>TapeBlockGetNBytes</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN268"><span class='Ref_To_Local'>thisbuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN100"><span class='Ref_to_Macro'>TapeBlockIsLast</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN268"><span class='Ref_To_Local'>thisbuf</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* EOF */ 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN268"><span class='Ref_To_Local'>thisbuf</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Advance to next block, if we have buffer space left */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end do &raquo; </span> <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>- </span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>&GT; </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN261"><span class='Ref_to_Parameter'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ltsReadFillBuffer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * qsort comparator for sorting freeBlocks[] into decreasing order. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN300"></a><span class='Declare_Function'>freeBlocks_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const void </span><span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN302"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>ablk</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN300"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN303"></a>    <span class='Keyword'>long</span>        <span class='Declare_Local'>bblk</span> <span class='Operator'>= *</span><span class='Parentheses'>((</span><span class='Keyword'>const long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN300"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* can't just subtract because long might be wider than int */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN302"><span class='Ref_To_Local'>ablk</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN303"><span class='Ref_To_Local'>bblk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN302"><span class='Ref_To_Local'>ablk</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN303"><span class='Ref_To_Local'>bblk</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Select a currently unused block for writing to. 
 */ 
</span><span class='Keyword'>static long 
</span><a name="LN317"></a><span class='Declare_Function'>ltsGetFreeBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If there are multiple free blocks, we select the one appearing last in 
     * freeBlocks[] (after sorting the array if needed).  If there are none, 
     * assign the next block at the end of the file. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN180"><span class='Ref_to_Member'>blocksSorted</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../include/port.h.html#LN439"><span class='Ref_to_Macro'>qsort</span></a><span class='Parentheses'>((</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a><span class='Delimiter'>, 
</span>                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="logtape.c.html#LN299"><span class='Ref_to_Func'>freeBlocks_cmp</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN180"><span class='Ref_to_Member'>blocksSorted</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>return</span> <a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>[</span><span class='Operator'>--</span><a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a><span class='Delimiter'>]; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="logtape.c.html#LN317"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN163"><span class='Ref_to_Member'>nBlocksAllocated</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ltsGetFreeBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a block# to the freelist. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN342"></a><span class='Declare_Function'>ltsReleaseBlock</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN344"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>ndx</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do nothing if we're no longer interested in remembering free space. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN179"><span class='Ref_to_Member'>forgetFreeSpace</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Enlarge freeBlocks array if full. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>&GT;= </span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN183"><span class='Ref_to_Member'>freeBlocksLen</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN183"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>*= </span><span class='Number'>2</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN36"><span class='Ref_to_Proto'>repalloc</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>, 
</span>                                          <a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN183"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Add blocknum to array, and mark the array unsorted if it's no longer in 
     * decreasing order. 
     */ 
</span>    <a href="logtape.c.html#LN344"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN344"><span class='Ref_To_Local'>ndx</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN344"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN344"><span class='Ref_To_Local'>ndx</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>&LT; </span><a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Parentheses'>) 
</span>        <a href="logtape.c.html#LN342"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN180"><span class='Ref_to_Member'>blocksSorted</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ltsReleaseBlock &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Create a set of logical tapes in a temporary underlying file. 
 * 
 * Each tape is initialized in write state. 
 */ 
</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>* 
</span><a name="LN378"></a><span class='Declare_Function'>LogicalTapeSetCreate</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>ntapes</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN380"></a>    <a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lts</span><span class='Delimiter'>; 
</span><a name="LN381"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span><a name="LN382"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create top-level struct including per-tape LogicalTape structs. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN378"><span class='Ref_to_Parameter'>ntapes</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a><span class='Delimiter'>, </span>tapes<span class='Parentheses'>) </span><span class='Operator'>+ 
</span>                                    <a href="logtape.c.html#LN378"><span class='Ref_to_Parameter'>ntapes</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a> <span class='Operator'>= </span><a href="../../../include/storage/buffile.h.html#LN36"><span class='Ref_to_Proto'>BufFileCreateTemp</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN163"><span class='Ref_to_Member'>nBlocksAllocated</span></a> <span class='Operator'>= </span><span class='Number'>0L</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN164"><span class='Ref_to_Member'>nBlocksWritten</span></a> <span class='Operator'>= </span><span class='Number'>0L</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN179"><span class='Ref_to_Member'>forgetFreeSpace</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN180"><span class='Ref_to_Member'>blocksSorted</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>;</span>   <span class='Comment_Single_Line'>/* a zero-length array is sorted ... */ 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN183"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>= </span><span class='Number'>32</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* reasonable initial guess */ 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>long </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN183"><span class='Ref_to_Member'>freeBlocksLen</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN182"><span class='Ref_to_Member'>nFreeBlocks</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN378"><span class='Ref_to_Parameter'>ntapes</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Initialize per-tape structs.  Note we allocate the I/O buffer and the 
     * first block for a tape only when it is first actually written to.  This 
     * avoids wasting memory space when tuplesort.c overestimates the number 
     * of tapes needed. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN382"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="logtape.c.html#LN382"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN378"><span class='Ref_to_Parameter'>ntapes</span></a><span class='Delimiter'>; </span><a href="logtape.c.html#LN382"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN382"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN381"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="logtape.c.html#LN380"><span class='Ref_To_Local'>lts</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeSetCreate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close a logical tape set and release all resources. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN426"></a><span class='Declare_Function'>LogicalTapeSetClose</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN428"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span><a name="LN429"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/buffile.h.html#LN37"><span class='Ref_to_Proto'>BufFileClose</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN426"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN153"><span class='Ref_to_Member'>pfile</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN429"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="logtape.c.html#LN429"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN426"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Delimiter'>; </span><a href="logtape.c.html#LN429"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN428"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN426"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN429"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN428"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN428"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN426"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN181"><span class='Ref_to_Member'>freeBlocks</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN426"><span class='Ref_to_Parameter'>lts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Mark a logical tape set as not needing management of free space anymore. 
 * 
 * This should be called if the caller does not intend to write any more data 
 * into the tape set, but is reading from un-frozen tapes.  Since no more 
 * writes are planned, remembering free blocks is no longer useful.  Setting 
 * this flag lets us avoid wasting time and space in ltsReleaseBlock(), which 
 * is not designed to handle large numbers of free blocks. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN452"></a><span class='Declare_Function'>LogicalTapeSetForgetFreeSpace</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="logtape.c.html#LN452"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN179"><span class='Ref_to_Member'>forgetFreeSpace</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Write to a logical tape. 
 * 
 * There are no error returns; we ereport() on failure. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN463"></a><span class='Declare_Function'>LogicalTapeWrite</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, 
</span><a name="LN464"></a>                 <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN466"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    size_t      <span class='Declare_Local'>nthistime</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate data buffer and first block on first write */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span>BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN192"><span class='Ref_to_Proto'>ltsGetFreeBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>lts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>prev <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>&GT;= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Buffer full, dump it out */ 
</span><a name="LN496"></a>            <span class='Keyword'>long</span>        <span class='Declare_Local'>nextBlockNumber</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* Hmm, went directly from reading to writing? */ 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid logtape state: should be dirty"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * First allocate the next block, so that we can store it in the 
             * 'next' pointer of this block. 
             */ 
</span>            <a href="logtape.c.html#LN496"><span class='Ref_To_Local'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN192"><span class='Ref_to_Proto'>ltsGetFreeBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>lts</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* set the next-pointer and dump the current block. */ 
</span>            <a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next <span class='Operator'>= </span><a href="logtape.c.html#LN496"><span class='Ref_To_Local'>nextBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN190"><span class='Ref_to_Proto'>ltsWriteBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN463"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* initialize the prev-pointer of the next block */ 
</span>            <a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>prev <span class='Operator'>= </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN496"><span class='Ref_To_Local'>nextBlockNumber</span></a><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if lt-&GT;pos&GT;=TapeBlockPay... &raquo; </span> 
 
        <a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a> <span class='Operator'>- </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>+= </span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN466"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN464"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>-= </span><a href="logtape.c.html#LN467"><span class='Ref_To_Local'>nthistime</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while size&GT;0 &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeWrite &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rewind logical tape and switch from writing to reading. 
 * 
 * The tape must currently be in writing state, or "frozen" in read state. 
 * 
 * 'buffer_size' specifies how much memory to use for the read buffer. 
 * Regardless of the argument, the actual amount of memory used is between 
 * BLCKSZ and MaxAllocSize, and is a multiple of BLCKSZ.  The given value is 
 * rounded down and truncated to fit those constraints, if necessary.  If the 
 * tape is frozen, the 'buffer_size' argument is ignored, and a small BLCKSZ 
 * byte buffer is used. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN550"></a><span class='Declare_Function'>LogicalTapeRewindForRead</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>buffer_size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN552"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Round and cap buffer_size if needed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>) 
</span>        <a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>= </span>BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* need at least one block */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>&LT; </span>BLCKSZ<span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>= </span>BLCKSZ<span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * palloc() larger than MaxAllocSize would fail (a multi-gigabyte 
         * buffer is unlikely to be helpful, anyway) 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>&GT; </span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a><span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>= </span><a href="../../../common/psprintf.c.html#LN27"><span class='Ref_to_Const'>MaxAllocSize</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* round down to BLCKSZ boundary */ 
</span>        <a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>-= </span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a> <span class='Operator'>% </span>BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Completion of a write phase.  Flush last partial data block, and 
         * rewind for normal (destructive) read. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="logtape.c.html#LN104"><span class='Ref_to_Macro'>TapeBlockSetNBytes</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN190"><span class='Ref_to_Proto'>ltsWriteBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * This is only OK if tape is frozen; we rewind for (another) read 
         * pass. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Allocate a read buffer (unless the tape is empty) */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>!= -</span><span class='Number'>1L</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>buffer_size</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Read the first block, or reset if tape is empty */ 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN260"><span class='Ref_to_Func'>ltsReadFillBuffer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN550"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN552"><span class='Ref_To_Local'>lt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeRewindForRead &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Rewind logical tape and switch from reading to writing. 
 * 
 * NOTE: we assume the caller has read the tape to the end; otherwise 
 * untouched data will not have been freed. We could add more code to free 
 * any unread blocks, but in current usage of this module it'd be useless 
 * code. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN628"></a><span class='Declare_Function'>LogicalTapeRewindForWrite</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN630"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN628"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN628"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN628"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN628"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN628"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>&& !</span><a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN630"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeRewindForWrite &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Read from a logical tape. 
 * 
 * Early EOF is indicated by return value less than #bytes requested. 
 */ 
</span>size_t 
<a name="LN654"></a><span class='Declare_Function'>LogicalTapeRead</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, 
</span><a name="LN655"></a>                <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>ptr</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN657"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span><a name="LN658"></a>    size_t      <span class='Declare_Local'>nread</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN659"></a>    size_t      <span class='Declare_Local'>nthistime</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>&GT;= </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Try to load more data into buffer. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN260"><span class='Ref_to_Func'>ltsReadFillBuffer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN654"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Parentheses'>))</span> 
                <span class='Control'>break</span><span class='Delimiter'>;</span>          <span class='Comment_Single_Line'>/* EOF */ 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>- </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>size</span></a><span class='Parentheses'>) 
</span>            <a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>(</span><a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>ptr</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN657"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>+= </span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>ptr</span></a> <span class='Operator'>+ </span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN655"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>-= </span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN658"><span class='Ref_To_Local'>nread</span></a> <span class='Operator'>+= </span><a href="logtape.c.html#LN659"><span class='Ref_To_Local'>nthistime</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while size&GT;0 &raquo; </span> 
 
    <span class='Control'>return</span> <a href="logtape.c.html#LN658"><span class='Ref_To_Local'>nread</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeRead &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * "Freeze" the contents of a tape so that it can be read multiple times 
 * and/or read backwards.  Once a tape is frozen, its contents will not 
 * be released until the LogicalTapeSet is destroyed.  This is expected 
 * to be used only for the final output pass of a merge. 
 * 
 * This *must* be called just at the end of a write pass, before the 
 * tape is rewound (after rewind is too late!).  It performs a rewind 
 * and switch to read mode "for free".  An immediately following rewind- 
 * for-read call is OK but not necessary. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN702"></a><span class='Declare_Function'>LogicalTapeFreeze</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN704"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Completion of a write phase.  Flush last partial data block, and rewind 
     * for nondestructive read. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN122"><span class='Ref_to_Member'>dirty</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN104"><span class='Ref_to_Macro'>TapeBlockSetNBytes</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN190"><span class='Ref_to_Proto'>ltsWriteBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN120"><span class='Ref_to_Member'>writing</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The seek and backspace functions assume a single block read buffer. 
     * That's OK with current usage.  A larger buffer is helpful to make the 
     * read pattern of the backing file look more sequential to the OS, when 
     * we're reading from multiple tapes.  But at the end of a sort, when a 
     * tape is frozen, we only read from a single tape anyway. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>|| </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>!= </span>BLCKSZ<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a> <span class='Operator'>= </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>= </span>BLCKSZ<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Read the first block, or reset if tape is empty */ 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a> <span class='Operator'>== -</span><span class='Number'>1L</span><span class='Parentheses'>) 
</span>        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN191"><span class='Ref_to_Proto'>ltsReadBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN702"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN100"><span class='Ref_to_Macro'>TapeBlockIsLast</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>))</span> 
        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= -</span><span class='Number'>1L</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN101"><span class='Ref_to_Macro'>TapeBlockGetNBytes</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN704"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeFreeze &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Backspace the tape a given number of bytes.  (We also support a more 
 * general seek interface, see below.) 
 * 
 * *Only* a frozen-for-read tape can be backed up; we don't support 
 * random access during write, and an unfrozen read tape may have 
 * already discarded the desired data! 
 * 
 * Returns the number of bytes backed up.  It can be less than the 
 * requested amount, if there isn't that much data before the current 
 * position.  The tape is positioned to the beginning of the tape in 
 * that case. 
 */ 
</span>size_t 
<a name="LN767"></a><span class='Declare_Function'>LogicalTapeBackspace</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, </span>size_t <span class='Declare_Parameter'>size</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN769"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span><a name="LN770"></a>    size_t      <span class='Declare_Local'>seekpos</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Easy case for seek within current block. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>) </span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>-= </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Not-so-easy case, have to walk back the chain of blocks.  This 
     * implementation would be pretty inefficient for long seeks, but we 
     * really aren't doing that (a seek over one tuple is typical). 
     */ 
</span>    <a href="logtape.c.html#LN770"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>size_t<span class='Parentheses'>) </span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* part within this block */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN770"><span class='Ref_To_Local'>seekpos</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN794"></a>        <span class='Keyword'>long</span>        <span class='Declare_Local'>prev</span> <span class='Operator'>= </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>prev<span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN794"><span class='Ref_To_Local'>prev</span></a> <span class='Operator'>== -</span><span class='Number'>1L</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Tried to back up beyond the beginning of tape. */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>!= </span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN132"><span class='Ref_to_Member'>firstBlockNumber</span></a><span class='Parentheses'>) 
</span>                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"unexpected end of tape"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span> <a href="logtape.c.html#LN770"><span class='Ref_To_Local'>seekpos</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="logtape.c.html#LN191"><span class='Ref_to_Proto'>ltsReadBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN794"><span class='Ref_To_Local'>prev</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next <span class='Operator'>!= </span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Parentheses'>)</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"broken tape, next of block %ld is %ld, expected %ld"</span><span class='Delimiter'>, 
</span>                 <a href="logtape.c.html#LN794"><span class='Ref_To_Local'>prev</span></a><span class='Delimiter'>, 
</span>                 <a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Delimiter'>, 
</span>                 <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN794"><span class='Ref_To_Local'>prev</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Delimiter'>; 
</span> 
        <a href="logtape.c.html#LN770"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>+= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while size&GT;seekpos &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * 'seekpos' can now be greater than 'size', because it points to the 
     * beginning the target block.  The difference is the position within the 
     * page. 
     */ 
</span>    <a href="logtape.c.html#LN769"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN770"><span class='Ref_To_Local'>seekpos</span></a> <span class='Operator'>- </span><a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="logtape.c.html#LN767"><span class='Ref_to_Parameter'>size</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeBackspace &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Seek to an arbitrary position in a logical tape. 
 * 
 * *Only* a frozen-for-read tape can be seeked. 
 * 
 * Must be called with a block/offset previously returned by 
 * LogicalTapeTell(). 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN838"></a><span class='Declare_Function'>LogicalTapeSeek</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, 
</span><a name="LN839"></a>                <span class='Keyword'>long </span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN841"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN121"><span class='Ref_to_Member'>frozen</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&LT;= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>!= </span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="logtape.c.html#LN191"><span class='Ref_to_Proto'>ltsReadBlock</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN838"><span class='Ref_to_Parameter'>lts</span></a><span class='Delimiter'>, </span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>blocknum</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN96"><span class='Ref_to_Const'>TapeBlockPayloadSize</span></a><span class='Delimiter'>; 
</span>        <a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN134"><span class='Ref_to_Member'>nextBlockNumber</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN97"><span class='Ref_to_Macro'>TapeBlockGetTrailer</span></a><span class='Parentheses'>(</span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN139"><span class='Ref_to_Member'>buffer</span></a><span class='Parentheses'>)</span><span class='Operator'>-&GT;</span>next<span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>&GT; </span><a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN142"><span class='Ref_to_Member'>nbytes</span></a><span class='Parentheses'>) 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"invalid tape seek position"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN841"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN839"><span class='Ref_to_Parameter'>offset</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogicalTapeSeek &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Obtain current position in a form suitable for a later LogicalTapeSeek. 
 * 
 * NOTE: it'd be OK to do this during write phase with intention of using 
 * the position for a seek after freezing.  Not clear if anyone needs that. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN869"></a><span class='Declare_Function'>LogicalTapeTell</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>tapenum</span><span class='Delimiter'>, 
</span><a name="LN870"></a>                <span class='Keyword'>long </span><span class='Operator'>*</span><span class='Declare_Parameter'>blocknum</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Operator'>*</span><span class='Declare_Parameter'>offset</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN872"></a>    <a href="logtape.c.html#LN118"><span class='Ref_to_Struct'>LogicalTape</span></a> <span class='Operator'>*</span><span class='Declare_Local'>lt</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN869"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="logtape.c.html#LN869"><span class='Ref_to_Parameter'>tapenum</span></a> <span class='Operator'>&LT; </span><a href="logtape.c.html#LN869"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN186"><span class='Ref_to_Member'>nTapes</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="logtape.c.html#LN872"><span class='Ref_To_Local'>lt</span></a> <span class='Operator'>= &</span><a href="logtape.c.html#LN869"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN187"><span class='Ref_to_Member'>tapes</span></a><span class='Delimiter'>[</span><a href="logtape.c.html#LN869"><span class='Ref_to_Parameter'>tapenum</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* With a larger buffer, 'pos' wouldn't be the same as offset within page */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN872"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN140"><span class='Ref_to_Member'>buffer_size</span></a> <span class='Operator'>== </span>BLCKSZ<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Operator'>*</span><a href="logtape.c.html#LN870"><span class='Ref_to_Parameter'>blocknum</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN872"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN133"><span class='Ref_to_Member'>curBlockNumber</span></a><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="logtape.c.html#LN870"><span class='Ref_to_Parameter'>offset</span></a> <span class='Operator'>= </span><a href="logtape.c.html#LN872"><span class='Ref_To_Local'>lt</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN141"><span class='Ref_to_Member'>pos</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Obtain total disk space currently used by a LogicalTapeSet, in blocks. 
 */ 
</span><span class='Keyword'>long 
</span><a name="LN888"></a><span class='Declare_Function'>LogicalTapeSetBlocks</span><span class='Parentheses'>(</span><a href="logtape.c.html#LN151"><span class='Ref_to_Struct'>LogicalTapeSet</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>lts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="logtape.c.html#LN888"><span class='Ref_to_Parameter'>lts</span></a><span class='Operator'>-&GT;</span><a href="logtape.c.html#LN163"><span class='Ref_to_Member'>nBlocksAllocated</span></a><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>