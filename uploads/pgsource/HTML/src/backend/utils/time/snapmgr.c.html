<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\backend\utils\time\snapmgr.c</title>
<LINK REL=StyleSheet HREF="../../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\backend\utils\time\snapmgr.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * snapmgr.c 
 *      PostgreSQL snapshot manager 
 * 
 * We keep track of snapshots in two ways: those "registered" by resowner.c, 
 * and the "active snapshot" stack.  All snapshots in either of them live in 
 * persistent memory.  When a snapshot is no longer in any of these lists 
 * (tracked by separate refcounts on each snapshot), its memory can be freed. 
 * 
 * The FirstXactSnapshot, if any, is treated a bit specially: we increment its 
 * regd_count and list it in RegisteredSnapshots, but this reference is not 
 * tracked by a resource owner. We used to use the TopTransactionResourceOwner 
 * to track this snapshot reference, but that introduces logical circularity 
 * and thus makes it impossible to clean up in a sane fashion.  It's better to 
 * handle this reference as an internally-tracked registration, so that this 
 * module is entirely lower-level than ResourceOwners. 
 * 
 * Likewise, any snapshots that have been exported by pg_export_snapshot 
 * have regd_count = 1 and are listed in RegisteredSnapshots, but are not 
 * tracked by any resource owner. 
 * 
 * Likewise, the CatalogSnapshot is listed in RegisteredSnapshots when it 
 * is valid, but is not tracked by any resource owner. 
 * 
 * The same is true for historic snapshots used during logical decoding, 
 * their lifetime is managed separately (as they live longer than one xact.c 
 * transaction). 
 * 
 * These arrangements let us reset MyPgXact-&GT;xmin when there are no snapshots 
 * referenced by this transaction, and advance it when the one with oldest 
 * Xmin is no longer referenced.  For simplicity however, only registered 
 * snapshots not active snapshots participate in tracking which one is oldest; 
 * we don't try to change MyPgXact-&GT;xmin except when the active-snapshot 
 * stack is empty. 
 * 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * Portions Copyright (c) 1994, Regents of the University of California 
 * 
 * IDENTIFICATION 
 *    src/backend/utils/time/snapmgr.c 
 * 
 *------------------------------------------------------------------------- 
 */ 
</span><span class='Keyword'>#include </span><span class='String'>"postgres.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"access/transam.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xact.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"catalog/catalog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"lib/pairingheap.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"miscadmin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/predicate.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/proc.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/procarray.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/sinval.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"storage/spin.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/builtins.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/memutils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/rel.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/resowner_private.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/snapmgr.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/syscache.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"utils/tqual.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * GUC parameters 
 */ 
</span><a name="LN73"></a><span class='Keyword'>int</span>         <span class='Declare_Var'>old_snapshot_threshold</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* number of minutes, -1 disables */ 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Structure for dealing with old_snapshot_threshold implementation. 
 */ 
</span><a name="LN78"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>OldSnapshotControlData</span> 
<span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Variables for old snapshot handling are shared among processes and are 
     * only allowed to move forward. 
     */ 
</span><a name="LN84"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex_current</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* protect current_timestamp */ 
</span><a name="LN85"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>current_timestamp</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* latest snapshot timestamp */ 
</span><a name="LN86"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex_latest_xmin</span><span class='Delimiter'>;</span>      <span class='Comment_Multi_Line'>/* protect latest_xmin and 
                                         * next_map_update */ 
</span><a name="LN88"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>latest_xmin</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* latest snapshot xmin */ 
</span><a name="LN89"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>next_map_update</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* latest snapshot valid up to */ 
</span><a name="LN90"></a>    <a href="../../../include/storage/s_lock.h.html#LN137"><span class='Ref_to_Typedef'>slock_t</span></a>     <span class='Declare_Member'>mutex_threshold</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* protect threshold fields */ 
</span><a name="LN91"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>threshold_timestamp</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* earlier snapshot is old */ 
</span><a name="LN92"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>threshold_xid</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* earlier xid may be gone */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Keep one xid per minute for old snapshot error handling. 
     * 
     * Use a circular buffer with a head offset, a count of entries currently 
     * used, and a timestamp corresponding to the xid at the head offset.  A 
     * count_used value of zero means that there are no times stored; a 
     * count_used value of OLD_SNAPSHOT_TIME_MAP_ENTRIES means that the buffer 
     * is full and the head must be advanced to add new entries.  Use 
     * timestamps aligned to minute boundaries, since that seems less 
     * surprising than aligning based on the first usage timestamp.  The 
     * latest bucket is effectively stored within latest_xmin.  The circular 
     * buffer is updated when we get a new xmin value that doesn't fall into 
     * the same interval. 
     * 
     * It is OK if the xid for a given time slot is from earlier than 
     * calculated by adding the number of minutes corresponding to the 
     * (possibly wrapped) distance from the head offset to the time of the 
     * head entry, since that just results in the vacuuming of old tuples 
     * being slightly less aggressive.  It would not be OK for it to be off in 
     * the other direction, since it might result in vacuuming tuples that are 
     * still expected to be there. 
     * 
     * Use of an SLRU was considered but not chosen because it is more 
     * heavyweight than is needed for this, and would probably not be any less 
     * code to implement. 
     * 
     * Persistence is not needed. 
     */ 
</span><a name="LN122"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>head_offset</span><span class='Delimiter'>;</span>    <span class='Comment_Single_Line'>/* subscript of oldest tracked time */ 
</span><a name="LN123"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>head_timestamp</span><span class='Delimiter'>; </span><span class='Comment_Single_Line'>/* time corresponding to head xid */ 
</span><a name="LN124"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>count_used</span><span class='Delimiter'>;</span>     <span class='Comment_Single_Line'>/* how many slots are in use */ 
</span><a name="LN125"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xid_by_minute</span><span class='Delimiter'>[</span>FLEXIBLE_ARRAY_MEMBER<span class='Delimiter'>]; 
</span><a name="LN126"></a>}<span class='Auto_Annotations'> &laquo; end OldSnapshotControlData &raquo; </span> <span class='Declare_Typedef'>OldSnapshotControlData</span><span class='Delimiter'>; 
</span> 
<a name="LN128"></a><span class='Keyword'>static volatile </span><a href="snapmgr.c.html#LN78"><span class='Ref_to_Struct'>OldSnapshotControlData</span></a> <span class='Operator'>*</span><span class='Declare_Var'>oldSnapshotControl</span><span class='Delimiter'>; 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * CurrentSnapshot points to the only snapshot taken in transaction-snapshot 
 * mode, and to the latest one taken in a read-committed transaction. 
 * SecondarySnapshot is a snapshot that's always up-to-date as of the current 
 * instant, even in transaction-snapshot mode.  It should only be used for 
 * special-purpose code (say, RI checking.)  CatalogSnapshot points to an 
 * MVCC snapshot intended to be used for catalog scans; we must invalidate it 
 * whenever a system catalog change occurs. 
 * 
 * These SnapshotData structs are static to simplify memory allocation 
 * (see the hack in GetSnapshotData to avoid repeated malloc/free). 
 */ 
</span><a name="LN143"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Var'>CurrentSnapshotData</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><a href="../../../include/utils/tqual.h.html#LN58"><span class='Ref_to_Proto'>HeapTupleSatisfiesMVCC</span></a><span class='Delimiter'>}; 
</span><a name="LN144"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Var'>SecondarySnapshotData</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><a href="../../../include/utils/tqual.h.html#LN58"><span class='Ref_to_Proto'>HeapTupleSatisfiesMVCC</span></a><span class='Delimiter'>}; 
</span><a name="LN145"></a><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Var'>CatalogSnapshotData</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><a href="../../../include/utils/tqual.h.html#LN58"><span class='Ref_to_Proto'>HeapTupleSatisfiesMVCC</span></a><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* Pointers to valid snapshots */ 
</span><a name="LN148"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Var'>CurrentSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN149"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Var'>SecondarySnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN150"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Var'>CatalogSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN151"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Var'>HistoricSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * These are updated by GetSnapshotData.  We initialize them this way 
 * for the convenience of TransactionIdIsInProgress: even in bootstrap 
 * mode, we don't want it to say that BootstrapTransactionId is in progress. 
 * 
 * RecentGlobalXmin and RecentGlobalDataXmin are initialized to 
 * InvalidTransactionId, to ensure that no one tries to use a stale 
 * value. Readers should ensure that it has been set to something else 
 * before using it. 
 */ 
</span><a name="LN163"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>TransactionXmin</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN164"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>RecentXmin</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN33"><span class='Ref_to_Const'>FirstNormalTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN165"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>RecentGlobalXmin</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span><a name="LN166"></a><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Var'>RecentGlobalDataXmin</span> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* (table, ctid) =&GT; (cmin, cmax) mapping during timetravel */ 
</span><a name="LN169"></a><span class='Keyword'>static </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Var'>tuplecid_data</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Elements of the active snapshot stack. 
 * 
 * Each element here accounts for exactly one active_count on SnapshotData. 
 * 
 * NB: the code assumes that elements in this list are in non-increasing 
 * order of as_level; also, the list must be NULL-terminated. 
 */ 
</span><a name="LN179"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>ActiveSnapshotElt</span> 
<span class='Delimiter'>{ 
</span><a name="LN181"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Member'>as_snap</span><span class='Delimiter'>; 
</span><a name="LN182"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>as_level</span><span class='Delimiter'>; 
</span><a name="LN183"></a>    <span class='Control'>struct</span> <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Member'>as_next</span><span class='Delimiter'>; 
</span><a name="LN184"></a>} <span class='Declare_Typedef'>ActiveSnapshotElt</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Top of the stack of active snapshots */ 
</span><a name="LN187"></a><span class='Keyword'>static </span><a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Var'>ActiveSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Bottom of the stack of active snapshots */ 
</span><a name="LN190"></a><span class='Keyword'>static </span><a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Var'>OldestActiveSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Currently registered Snapshots.  Ordered in a heap by xmin, so that we can 
 * quickly find the one with lowest xmin, to advance our MyPgXact-&GT;xmin. 
 */ 
</span><a name="LN196"></a><span class='Keyword'>static int </span><span class='Declare_Prototype'>xmin_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/lib/pairingheap.h.html#LN29"><span class='Ref_to_Struct'>pairingheap_node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/lib/pairingheap.h.html#LN29"><span class='Ref_to_Struct'>pairingheap_node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>, 
</span><a name="LN197"></a>         <span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN199"></a><span class='Keyword'>static </span><a href="../../../include/lib/pairingheap.h.html#LN70"><span class='Ref_to_Struct'>pairingheap</span></a> <span class='Declare_Var'>RegisteredSnapshots</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN196"><span class='Ref_to_Proto'>xmin_cmp</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>}; 
</span> 
<span class='Comment_Multi_Line'>/* first GetTransactionSnapshot call in a transaction? */ 
</span><a name="LN202"></a><span class='Keyword'>bool</span>        <span class='Declare_Var'>FirstSnapshotSet</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Remember the serializable transaction snapshot, if any.  We cannot trust 
 * FirstSnapshotSet in combination with IsolationUsesXactSnapshot(), because 
 * GUC may be reset before us, changing the value of IsolationUsesXactSnapshot. 
 */ 
</span><a name="LN209"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Var'>FirstXactSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Define pathname of exported-snapshot files */ 
</span><a name="LN212"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>SNAPSHOT_EXPORT_DIR</span> <span class='String'>"pg_snapshots"</span> 
<a name="LN213"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>XactExportFilePath</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>path</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>xid</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>num</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>suffix</span><span class='Parentheses'>) </span><span class='Operator'>\ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN213"><span class='Ref_to_Parameter'>path</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN213"><span class='Ref_to_Parameter'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a> <span class='String'>"/%08X-%d%s"</span><span class='Delimiter'>, </span><span class='Operator'>\ 
</span>             <a href="snapmgr.c.html#LN213"><span class='Ref_to_Parameter'>xid</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN213"><span class='Ref_to_Parameter'>num</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN213"><span class='Ref_to_Parameter'>suffix</span></a><span class='Parentheses'>)</span> 
 
<span class='Comment_Multi_Line'>/* Current xact's exported snapshots (a list of Snapshot structs) */ 
</span><a name="LN218"></a><span class='Keyword'>static </span><a href="../../../include/nodes/pg_list.h.html#LN44"><span class='Ref_to_Struct'>List</span></a> <span class='Operator'>*</span><span class='Declare_Var'>exportedSnapshots</span> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Prototypes for local functions */ 
</span><a name="LN221"></a><span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Prototype'>AlignTimestampToMinuteBoundary</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>ts</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN222"></a><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Prototype'>CopySnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN223"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>FreeSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN224"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>SnapshotResetXmin</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Snapshot fields to be serialized. 
 * 
 * Only these fields need to be sent to the cooperating backend; the 
 * remaining ones can (and must) be set by the receiver upon restore. 
 */ 
</span><a name="LN232"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>SerializedSnapshotData</span> 
<span class='Delimiter'>{ 
</span><a name="LN234"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xmin</span><span class='Delimiter'>; 
</span><a name="LN235"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Member'>xmax</span><span class='Delimiter'>; 
</span><a name="LN236"></a>    <a href="../../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Member'>xcnt</span><span class='Delimiter'>; 
</span><a name="LN237"></a>    <a href="../../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a>       <span class='Declare_Member'>subxcnt</span><span class='Delimiter'>; 
</span><a name="LN238"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>suboverflowed</span><span class='Delimiter'>; 
</span><a name="LN239"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>takenDuringRecovery</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Member'>curcid</span><span class='Delimiter'>; 
</span><a name="LN241"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Member'>whenTaken</span><span class='Delimiter'>; 
</span><a name="LN242"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>lsn</span><span class='Delimiter'>; 
</span><a name="LN243"></a>} <span class='Declare_Typedef'>SerializedSnapshotData</span><span class='Delimiter'>; 
</span> 
<a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN246"></a><span class='Declare_Function'>SnapMgrShmemSize</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN248"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN248"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/c.h.html#LN554"><span class='Ref_to_Macro'>offsetof</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN78"><span class='Ref_to_Struct'>OldSnapshotControlData</span></a><span class='Delimiter'>, </span>xid_by_minute<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN248"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN248"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, </span><a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                       <a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN248"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Initialize for managing old snapshot detection. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN262"></a><span class='Declare_Function'>SnapMgrInit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN264"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>found</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Create or attach to the OldSnapshotControlData structure. 
     */ 
</span>    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>volatile </span><a href="snapmgr.c.html#LN78"><span class='Ref_to_Struct'>OldSnapshotControlData</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <a href="../../../include/storage/shmem.h.html#LN43"><span class='Ref_to_Proto'>ShmemInitStruct</span></a><span class='Parentheses'>(</span><span class='String'>"OldSnapshotControlData"</span><span class='Delimiter'>, 
</span>                        <a href="../../../include/utils/snapmgr.h.html#LN51"><span class='Ref_to_Proto'>SnapMgrShmemSize</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN264"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN264"><span class='Ref_To_Local'>found</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN84"><span class='Ref_to_Member'>mutex_current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN85"><span class='Ref_to_Member'>current_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN86"><span class='Ref_to_Member'>mutex_latest_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN88"><span class='Ref_to_Member'>latest_xmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN89"><span class='Ref_to_Member'>next_map_update</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN59"><span class='Ref_to_Macro'>SpinLockInit</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN91"><span class='Ref_to_Member'>threshold_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN92"><span class='Ref_to_Member'>threshold_xid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end SnapMgrInit &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetTransactionSnapshot 
 *      Get the appropriate snapshot for a new query in a transaction. 
 * 
 * Note that the return value may point at static storage that will be modified 
 * by future calls and by CommandCounterIncrement().  Callers should call 
 * RegisterSnapshot or PushActiveSnapshot on the returned snap if it is to be 
 * used very long. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN299"></a><span class='Declare_Function'>GetTransactionSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Return historic snapshot if doing logical decoding. We'll never need a 
     * non-historic transaction snapshot in this (sub-)transaction, so there's 
     * no need to be careful to set one up for later calls to 
     * GetTransactionSnapshot(). 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN105"><span class='Ref_to_Proto'>HistoricSnapshotActive</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="snapmgr.c.html#LN151"><span class='Ref_to_Global_Var'>HistoricSnapshot</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* First call in transaction? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Don't allow catalog snapshot to be older than xact snapshot.  Must 
         * do this first to allow the empty-heap Assert to succeed. 
         */ 
</span>        <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                 <span class='String'>"cannot take query snapshot during a parallel operation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * In transaction-snapshot mode, the first snapshot must live until 
         * end of xact regardless of what the caller does with it, so we must 
         * make a copy of it rather than returning CurrentSnapshotData 
         * directly.  Furthermore, if we're running in serializable mode, 
         * predicate.c needs to wrap the snapshot fetch in its own processing. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN42"><span class='Ref_to_Macro'>IsolationUsesXactSnapshot</span></a><span class='Parentheses'>())</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* First, create the snapshot in CurrentSnapshotData */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN43"><span class='Ref_to_Macro'>IsolationIsSerializable</span></a><span class='Parentheses'>())</span> 
                <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/predicate.h.html#LN46"><span class='Ref_to_Proto'>GetSerializableTransactionSnapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN143"><span class='Ref_to_Global_Var'>CurrentSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>else</span> 
                <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN143"><span class='Ref_to_Global_Var'>CurrentSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Make a saved copy */ 
</span>            <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>; 
</span>            <span class='Comment_Multi_Line'>/* Mark it as "registered" in FirstXactSnapshot */ 
</span>            <a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="../../../include/lib/pairingheap.h.html#LN80"><span class='Ref_to_Proto'>pairingheap_add</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN143"><span class='Ref_to_Global_Var'>CurrentSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !FirstSnapshotSet &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN42"><span class='Ref_to_Macro'>IsolationUsesXactSnapshot</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Don't allow catalog snapshot to be older than xact snapshot. */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN143"><span class='Ref_to_Global_Var'>CurrentSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetTransactionSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetLatestSnapshot 
 *      Get a snapshot that is up-to-date as of the current instant, 
 *      even if we are executing in transaction-snapshot mode. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN374"></a><span class='Declare_Function'>GetLatestSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * We might be able to relax this, but nothing that could otherwise work 
     * needs it. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>())</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"cannot update SecondarySnapshot during a parallel operation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * So far there are no cases requiring support for GetLatestSnapshot() 
     * during logical decoding, but it wouldn't be hard to add if required. 
     */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/snapmgr.h.html#LN105"><span class='Ref_to_Proto'>HistoricSnapshotActive</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* If first call in transaction, go ahead and set the xact snapshot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/snapmgr.h.html#LN63"><span class='Ref_to_Proto'>GetTransactionSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN144"><span class='Ref_to_Global_Var'>SecondarySnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetLatestSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetOldestSnapshot 
 * 
 *      Get the transaction's oldest known snapshot, as judged by the LSN. 
 *      Will return NULL if there are no active or registered snapshots. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN406"></a><span class='Declare_Function'>GetOldestSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN408"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>OldestRegisteredSnapshot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN409"></a>    <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>RegisteredLSN</span> <span class='Operator'>= </span><a href="../../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN408"><span class='Ref_To_Local'>OldestRegisteredSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/lib/pairingheap.h.html#LN42"><span class='Ref_to_Macro'>pairingheap_container</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Delimiter'>, </span>ph_node<span class='Delimiter'>, 
</span>                                    <a href="../../../include/lib/pairingheap.h.html#LN81"><span class='Ref_to_Proto'>pairingheap_first</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN409"><span class='Ref_To_Local'>RegisteredLSN</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN408"><span class='Ref_To_Local'>OldestRegisteredSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN111"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN420"></a>        <a href="../../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>ActiveLSN</span> <span class='Operator'>= </span><a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN111"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xlogdefs.h.html#LN28"><span class='Ref_to_Macro'>XLogRecPtrIsInvalid</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN409"><span class='Ref_To_Local'>RegisteredLSN</span></a><span class='Parentheses'>) </span><span class='Operator'>|| </span><a href="snapmgr.c.html#LN409"><span class='Ref_To_Local'>RegisteredLSN</span></a> <span class='Operator'>&GT; </span><a href="snapmgr.c.html#LN420"><span class='Ref_To_Local'>ActiveLSN</span></a><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN408"><span class='Ref_To_Local'>OldestRegisteredSnapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetOldestSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetCatalogSnapshot 
 *      Get a snapshot that is sufficiently up-to-date for scan of the 
 *      system catalog with the specified OID. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN435"></a><span class='Declare_Function'>GetCatalogSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * Return historic snapshot while we're doing logical decoding, so we can 
     * see the appropriate state of the catalog. 
     * 
     * This is the primary reason for needing to reset the system caches after 
     * finishing decoding. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN105"><span class='Ref_to_Proto'>HistoricSnapshotActive</span></a><span class='Parentheses'>())</span> 
        <span class='Control'>return</span> <a href="snapmgr.c.html#LN151"><span class='Ref_to_Global_Var'>HistoricSnapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/utils/snapmgr.h.html#LN69"><span class='Ref_to_Proto'>GetNonHistoricCatalogSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN435"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * GetNonHistoricCatalogSnapshot 
 *      Get a snapshot that is sufficiently up-to-date for scan of the system 
 *      catalog with the specified OID, even while historic snapshots are set 
 *      up. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN457"></a><span class='Declare_Function'>GetNonHistoricCatalogSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a> <span class='Declare_Parameter'>relid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * If the caller is trying to scan a relation that has no syscache, no 
     * catcache invalidations will be sent when it is updated.  For a few key 
     * relations, snapshot invalidations are sent instead.  If we're trying to 
     * scan a relation for which neither catcache nor snapshot invalidations 
     * are sent, we must refresh the snapshot every time. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a> <span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/utils/syscache.h.html#LN146"><span class='Ref_to_Proto'>RelationInvalidatesSnapshotsOnly</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN457"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>) </span><span class='Operator'>&& 
</span>        <span class='Operator'>!</span><a href="../../../include/utils/syscache.h.html#LN147"><span class='Ref_to_Proto'>RelationHasSysCache</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN457"><span class='Ref_to_Parameter'>relid</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Get new snapshot. */ 
</span>        <a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN145"><span class='Ref_to_Global_Var'>CatalogSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Make sure the catalog snapshot will be accounted for in decisions 
         * about advancing PGXACT-&GT;xmin.  We could apply RegisterSnapshot, but 
         * that would result in making a physical copy, which is overkill; and 
         * it would also create a dependency on some resource owner, which we 
         * do not want for reasons explained at the head of this file. Instead 
         * just shove the CatalogSnapshot into the pairing heap manually. This 
         * has to be reversed in InvalidateCatalogSnapshot, of course. 
         * 
         * NB: it had better be impossible for this to throw error, since the 
         * CatalogSnapshot pointer is already valid. 
         */ 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN80"><span class='Ref_to_Proto'>pairingheap_add</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GetNonHistoricCatalogSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * InvalidateCatalogSnapshot 
 *      Mark the current catalog snapshot, if any, as invalid 
 * 
 * We could change this API to allow the caller to provide more fine-grained 
 * invalidation details, so that a change to relation A wouldn't prevent us 
 * from using our cached snapshot to scan relation B, but so far there's no 
 * evidence that the CPU cycles we spent tracking such fine details would be 
 * well-spent. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN505"></a><span class='Declare_Function'>InvalidateCatalogSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN83"><span class='Ref_to_Proto'>pairingheap_remove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN224"><span class='Ref_to_Proto'>SnapshotResetXmin</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * InvalidateCatalogSnapshotConditionally 
 *      Drop catalog snapshot if it's the only one we have 
 * 
 * This is called when we are about to wait for client input, so we don't 
 * want to continue holding the catalog snapshot if it might mean that the 
 * global xmin horizon can't advance.  However, if there are other snapshots 
 * still active or registered, the catalog snapshot isn't likely to be the 
 * oldest one, so we might as well keep it. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN526"></a><span class='Declare_Function'>InvalidateCatalogSnapshotConditionally</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN150"><span class='Ref_to_Global_Var'>CatalogSnapshot</span></a> <span class='Operator'>&& 
</span>        <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN98"><span class='Ref_to_Macro'>pairingheap_is_singular</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SnapshotSetCommandId 
 *      Propagate CommandCounterIncrement into the static snapshots, if set 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN539"></a><span class='Declare_Function'>SnapshotSetCommandId</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a> <span class='Declare_Parameter'>curcid</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN539"><span class='Ref_to_Parameter'>curcid</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN539"><span class='Ref_to_Parameter'>curcid</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Should we do the same with CatalogSnapshot? */ 
</span><span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SetTransactionSnapshot 
 *      Set the transaction's snapshot from an imported MVCC snapshot. 
 * 
 * Note that this is very closely tied to GetTransactionSnapshot --- it 
 * must take care of all the same considerations as the first-snapshot case 
 * in GetTransactionSnapshot. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN560"></a><span class='Declare_Function'>SetTransactionSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>sourcesnap</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>sourcexid</span><span class='Delimiter'>, 
</span><a name="LN561"></a>                       <a href="../../../include/storage/proc.h.html#LN93"><span class='Ref_to_Struct'>PGPROC</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>sourceproc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Caller should have checked this already */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Better do this to ensure following Assert succeeds. */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/utils/snapmgr.h.html#LN105"><span class='Ref_to_Proto'>HistoricSnapshotActive</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Even though we are not going to use the snapshot it computes, we must 
     * call GetSnapshotData, for two reasons: (1) to be sure that 
     * CurrentSnapshotData's XID arrays have been allocated, and (2) to update 
     * RecentXmin and RecentGlobalXmin.  (We could alternatively include those 
     * two variables in exported snapshot files, but it seems better to have 
     * snapshot importers compute reasonably up-to-date values for them.) 
     */ 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/storage/procarray.h.html#LN81"><span class='Ref_to_Proto'>GetSnapshotData</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN143"><span class='Ref_to_Global_Var'>CurrentSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now copy appropriate fields from the source snapshot. 
     */ 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/storage/procarray.h.html#LN78"><span class='Ref_to_Proto'>GetMaxSnapshotXidCount</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>           <a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/storage/procarray.h.html#LN79"><span class='Ref_to_Proto'>GetMaxSnapshotSubxidCount</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, 
</span>           <a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcesnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* NB: curcid should NOT be copied, it's a local matter */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now we have to fix what GetSnapshotData did with MyPgXact-&GT;xmin and 
     * TransactionXmin.  There is a race condition: to make sure we are not 
     * causing the global xmin to go backwards, we have to test that the 
     * source transaction is still running, and that has to be done 
     * atomically. So let procarray.c do it. 
     * 
     * Note: in serializable mode, predicate.c will do this a second time. It 
     * doesn't seem worth contorting the logic here to avoid two calls, 
     * especially since it's not clear that predicate.c *must* do this. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN561"><span class='Ref_to_Parameter'>sourceproc</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/procarray.h.html#LN85"><span class='Ref_to_Proto'>ProcArrayInstallRestoredXmin</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN561"><span class='Ref_to_Parameter'>sourceproc</span></a><span class='Parentheses'>))</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not import the requested snapshot"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The source transaction is not running anymore."</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/storage/procarray.h.html#LN83"><span class='Ref_to_Proto'>ProcArrayInstallImportedXmin</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcexid</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_OBJECT_NOT_IN_PREREQUISITE_STATE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not import the requested snapshot"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="../error/elog.c.html#LN871"><span class='Ref_to_Func'>errdetail</span></a><span class='Parentheses'>(</span><span class='String'>"The source transaction %u is not running anymore."</span><span class='Delimiter'>, 
</span>                         <a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcexid</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * In transaction-snapshot mode, the first snapshot must live until end of 
     * xact, so we must make a copy of it.  Furthermore, if we're running in 
     * serializable mode, predicate.c needs to do its own processing. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN42"><span class='Ref_to_Macro'>IsolationUsesXactSnapshot</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN43"><span class='Ref_to_Macro'>IsolationIsSerializable</span></a><span class='Parentheses'>())</span> 
            <a href="../../../include/storage/predicate.h.html#LN47"><span class='Ref_to_Proto'>SetSerializableTransactionSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN560"><span class='Ref_to_Parameter'>sourcexid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Make a saved copy */ 
</span>        <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Mark it as "registered" in FirstXactSnapshot */ 
</span>        <a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN80"><span class='Ref_to_Proto'>pairingheap_add</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SetTransactionSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * CopySnapshot 
 *      Copy the given snapshot. 
 * 
 * The copy is palloc'd in TopTransactionContext and has initial refcounts set 
 * to 0.  The returned snapshot has the copied flag set. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN654"></a><span class='Declare_Function'>CopySnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN656"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>newsnap</span><span class='Delimiter'>; 
</span><a name="LN657"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>subxipoff</span><span class='Delimiter'>; 
</span><a name="LN658"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We allocate any XID arrays needed in the same palloc block. */ 
</span>    <a href="snapmgr.c.html#LN658"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN657"><span class='Ref_To_Local'>subxipoff</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN658"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>+= </span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN658"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* setup XID array */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Setup subXID array. Don't bother to copy it if it had overflowed, 
     * though, because it's not used anywhere in that case. Except if it's a 
     * snapshot taken during recovery; all the top-level XIDs are in subxip as 
     * well in that case, so we mustn't lose them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>|| </span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) ((</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN657"><span class='Ref_To_Local'>subxipoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN654"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN656"><span class='Ref_To_Local'>newsnap</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end CopySnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * FreeSnapshot 
 *      Free the memory associated with a snapshot. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN709"></a><span class='Declare_Function'>FreeSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN709"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN709"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN709"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN709"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * PushActiveSnapshot 
 *      Set the given snapshot as the current active snapshot 
 * 
 * If the passed snapshot is a statically-allocated one, or it is possibly 
 * subject to a future command counter update, create a new long-lived copy 
 * with active refcount=1.  Otherwise, only increment the refcount. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN727"></a><span class='Declare_Function'>PushActiveSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN729"></a>    <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newactive</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Checking SecondarySnapshot is probably useless here, but it seems 
     * better to be sure. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a> <span class='Operator'>== </span><a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>|| </span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a> <span class='Operator'>== </span><a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a> <span class='Operator'>|| !</span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN727"><span class='Ref_to_Parameter'>snap</span></a><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN183"><span class='Ref_to_Member'>as_next</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN182"><span class='Ref_to_Member'>as_level</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN344"><span class='Ref_to_Proto'>GetCurrentTransactionNestLevel</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN729"><span class='Ref_To_Local'>newactive</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PushActiveSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PushCopiedSnapshot 
 *      As above, except forcibly copy the presented snapshot. 
 * 
 * This should be used when the ActiveSnapshot has to be modifiable, for 
 * example if the caller intends to call UpdateActiveSnapshotCommandId. 
 * The new snapshot will be released when popped from the stack. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN763"></a><span class='Declare_Function'>PushCopiedSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN73"><span class='Ref_to_Proto'>PushActiveSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN763"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * UpdateActiveSnapshotCommandId 
 * 
 * Update the current CID of the active snapshot.  This can only be applied 
 * to a snapshot that is not referenced elsewhere. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN775"></a><span class='Declare_Function'>UpdateActiveSnapshotCommandId</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN777"></a>    <a href="../../../include/c.h.html#LN410"><span class='Ref_to_Typedef'>CommandId</span></a>   <span class='Declare_Local'>save_curcid</span><span class='Delimiter'>, 
</span><a name="LN778"></a>                <span class='Declare_Local'>curcid</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't allow modification of the active snapshot during parallel 
     * operation.  We share the snapshot to worker backends at the beginning 
     * of parallel operation, so any change to the snapshot can lead to 
     * inconsistencies.  We have other defenses against 
     * CommandCounterIncrement, but there are a few places that call this 
     * directly, so we put an additional guard here. 
     */ 
</span>    <a href="snapmgr.c.html#LN777"><span class='Ref_To_Local'>save_curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN778"><span class='Ref_To_Local'>curcid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN339"><span class='Ref_to_Proto'>GetCurrentCommandId</span></a><span class='Parentheses'>(</span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN405"><span class='Ref_to_Proto'>IsInParallelMode</span></a><span class='Parentheses'>() </span><span class='Operator'>&& </span><a href="snapmgr.c.html#LN777"><span class='Ref_To_Local'>save_curcid</span></a> <span class='Operator'>!= </span><a href="snapmgr.c.html#LN778"><span class='Ref_To_Local'>curcid</span></a><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"cannot modify commandid in active snapshot during a parallel operation"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN778"><span class='Ref_To_Local'>curcid</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end UpdateActiveSnapshotCommandId &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * PopActiveSnapshot 
 * 
 * Remove the topmost snapshot from the active snapshot stack, decrementing the 
 * reference count, and free it if this was the last reference. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN806"></a><span class='Declare_Function'>PopActiveSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN808"></a>    <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>newstack</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN808"><span class='Ref_To_Local'>newstack</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN183"><span class='Ref_to_Member'>as_next</span></a><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN223"><span class='Ref_to_Proto'>FreeSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN808"><span class='Ref_To_Local'>newstack</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN224"><span class='Ref_to_Proto'>SnapshotResetXmin</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end PopActiveSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * GetActiveSnapshot 
 *      Return the topmost snapshot in the Active stack. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN833"></a><span class='Declare_Function'>GetActiveSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * ActiveSnapshotSet 
 *      Return whether there is at least one snapshot in the Active stack 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN845"></a><span class='Declare_Function'>ActiveSnapshotSet</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RegisterSnapshot 
 *      Register a snapshot as being in use by the current resource owner 
 * 
 * If InvalidSnapshot is passed, it is not registered. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN857"></a><span class='Declare_Function'>RegisterSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN857"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="../../../include/utils/snapmgr.h.html#LN82"><span class='Ref_to_Proto'>RegisterSnapshotOnOwner</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN857"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="../resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * RegisterSnapshotOnOwner 
 *      As above, but use the specified resource owner 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN870"></a><span class='Declare_Function'>RegisterSnapshotOnOwner</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN872"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Static snapshot?  Create a persistent copy */ 
</span>    <a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>? </span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>: </span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and tell resowner.c about it */ 
</span>    <a href="../../../include/utils/resowner_private.h.html#LN70"><span class='Ref_to_Proto'>ResourceOwnerEnlargeSnapshots</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>owner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/resowner_private.h.html#LN71"><span class='Ref_to_Proto'>ResourceOwnerRememberSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN870"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN80"><span class='Ref_to_Proto'>pairingheap_add</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN872"><span class='Ref_To_Local'>snap</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RegisterSnapshotOnOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * UnregisterSnapshot 
 * 
 * Decrement the reference count of a snapshot, remove the corresponding 
 * reference from CurrentResourceOwner, and free the snapshot if no more 
 * references remain. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN899"></a><span class='Declare_Function'>UnregisterSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN899"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/snapmgr.h.html#LN83"><span class='Ref_to_Proto'>UnregisterSnapshotFromOwner</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN899"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="../resowner/resowner.c.html#LN137"><span class='Ref_to_Global_Var'>CurrentResourceOwner</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * UnregisterSnapshotFromOwner 
 *      As above, but use the specified resource owner 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN912"></a><span class='Declare_Function'>UnregisterSnapshotFromOwner</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><a href="../../../include/utils/resowner.h.html#LN26"><span class='Ref_to_Typedef'>ResourceOwner</span></a> <span class='Declare_Parameter'>owner</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/utils/resowner_private.h.html#LN73"><span class='Ref_to_Proto'>ResourceOwnerForgetSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>owner</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a><span class='Operator'>--</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN83"><span class='Ref_to_Proto'>pairingheap_remove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN223"><span class='Ref_to_Proto'>FreeSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN912"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN224"><span class='Ref_to_Proto'>SnapshotResetXmin</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end UnregisterSnapshotFromOwner &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Comparison function for RegisteredSnapshots heap.  Snapshots are ordered 
 * by xmin, so that the snapshot with smallest xmin is at the top. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN938"></a><span class='Declare_Function'>xmin_cmp</span><span class='Parentheses'>(</span><span class='Keyword'>const </span><a href="../../../include/lib/pairingheap.h.html#LN29"><span class='Ref_to_Struct'>pairingheap_node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>a</span><span class='Delimiter'>, </span><span class='Keyword'>const </span><a href="../../../include/lib/pairingheap.h.html#LN29"><span class='Ref_to_Struct'>pairingheap_node</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>b</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN940"></a>    <span class='Keyword'>const </span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>asnap</span> <span class='Operator'>= </span><a href="../../../include/lib/pairingheap.h.html#LN50"><span class='Ref_to_Macro'>pairingheap_const_container</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Delimiter'>, </span>ph_node<span class='Delimiter'>, </span><a href="snapmgr.c.html#LN938"><span class='Ref_to_Parameter'>a</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN941"></a>    <span class='Keyword'>const </span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Operator'>*</span><span class='Declare_Local'>bsnap</span> <span class='Operator'>= </span><a href="../../../include/lib/pairingheap.h.html#LN50"><span class='Ref_to_Macro'>pairingheap_const_container</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Delimiter'>, </span>ph_node<span class='Delimiter'>, </span><a href="snapmgr.c.html#LN938"><span class='Ref_to_Parameter'>b</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN940"><span class='Ref_To_Local'>asnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN941"><span class='Ref_To_Local'>bsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN940"><span class='Ref_To_Local'>asnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN941"><span class='Ref_To_Local'>bsnap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SnapshotResetXmin 
 * 
 * If there are no more snapshots, we can reset our PGXACT-&GT;xmin to InvalidXid. 
 * Note we can do this without locking because we assume that storing an Xid 
 * is atomic. 
 * 
 * Even if there are some remaining snapshots, we may be able to advance our 
 * PGXACT-&GT;xmin to some degree.  This typically happens when a portal is 
 * dropped.  For efficiency, we only consider recomputing PGXACT-&GT;xmin when 
 * the active snapshot stack is empty; this allows us not to need to track 
 * which active snapshot is oldest. 
 * 
 * Note: it's tempting to use GetOldestSnapshot() here so that we can include 
 * active snapshots in the calculation.  However, that compares by LSN not 
 * xmin so it's not entirely clear that it's the same thing.  Also, we'd be 
 * critically dependent on the assumption that the bottommost active snapshot 
 * stack entry has the oldest xmin.  (Current uses of GetOldestSnapshot() are 
 * not actually critical, but this would be.) 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN972"></a><span class='Declare_Function'>SnapshotResetXmin</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN974"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>minSnapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="snapmgr.c.html#LN974"><span class='Ref_To_Local'>minSnapshot</span></a> <span class='Operator'>= </span><a href="../../../include/lib/pairingheap.h.html#LN42"><span class='Ref_to_Macro'>pairingheap_container</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Delimiter'>, </span>ph_node<span class='Delimiter'>, 
</span>                                    <a href="../../../include/lib/pairingheap.h.html#LN81"><span class='Ref_to_Proto'>pairingheap_first</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN974"><span class='Ref_To_Local'>minSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>))</span> 
        <a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN974"><span class='Ref_To_Local'>minSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end SnapshotResetXmin &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtSubCommit_Snapshot 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN996"></a><span class='Declare_Function'>AtSubCommit_Snapshot</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN998"></a>    <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>active</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Relabel the active snapshots set in this subtransaction as though they 
     * are owned by the parent subxact. 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN183"><span class='Ref_to_Member'>as_next</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN182"><span class='Ref_to_Member'>as_level</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN996"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>) 
</span>            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN998"><span class='Ref_To_Local'>active</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN182"><span class='Ref_to_Member'>as_level</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN996"><span class='Ref_to_Parameter'>level</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * AtSubAbort_Snapshot 
 *      Clean up snapshots after a subtransaction abort 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1017"></a><span class='Declare_Function'>AtSubAbort_Snapshot</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>level</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* Forget the active snapshots set by this subtransaction */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>&& </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN182"><span class='Ref_to_Member'>as_level</span></a> <span class='Operator'>&GT;= </span><a href="snapmgr.c.html#LN1017"><span class='Ref_to_Parameter'>level</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1022"></a>        <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>next</span><span class='Delimiter'>; 
</span> 
        <a href="snapmgr.c.html#LN1022"><span class='Ref_To_Local'>next</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN183"><span class='Ref_to_Member'>as_next</span></a><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Decrement the snapshot's active count.  If it's still registered or 
         * marked as active by an outer subtransaction, we can't free it yet. 
         */ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>&GT;= </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>-= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>            <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="snapmgr.c.html#LN223"><span class='Ref_to_Proto'>FreeSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN181"><span class='Ref_to_Member'>as_snap</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* and free the stack element */ 
</span>        <a href="../../../include/common/fe_memutils.h.html#LN37"><span class='Ref_to_Proto'>pfree</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1022"><span class='Ref_To_Local'>next</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while ActiveSnapshot&&Activ... &raquo; </span> 
 
    <a href="snapmgr.c.html#LN224"><span class='Ref_to_Proto'>SnapshotResetXmin</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtSubAbort_Snapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * AtEOXact_Snapshot 
 *      Snapshot manager's cleanup function for end of transaction 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1053"></a><span class='Declare_Function'>AtEOXact_Snapshot</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>isCommit</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>resetXmin</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Comment_Multi_Line'>/* 
     * In transaction-snapshot mode we must release our privately-managed 
     * reference to the transaction snapshot.  We must remove it from 
     * RegisteredSnapshots to keep the check below happy.  But we don't bother 
     * to do FreeSnapshot, for two reasons: the memory will go away with 
     * TopTransactionContext anyway, and if someone has left the snapshot 
     * stacked as active, we don't want the code below to be chasing through a 
     * dangling pointer. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Debug'>Assert</span><span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN83"><span class='Ref_to_Proto'>pairingheap_remove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="snapmgr.c.html#LN209"><span class='Ref_to_Global_Var'>FirstXactSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we exported any snapshots, clean them up. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1077"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>myxid</span> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN331"><span class='Ref_to_Proto'>GetTopTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1078"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1079"></a>        <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1080"></a>        <a href="../../../include/nodes/pg_list.h.html#LN52"><span class='Ref_to_Struct'>ListCell</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>lc</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Get rid of the files.  Unlink failure is only a WARNING because (1) 
         * it's too late to abort the transaction, and (2) leaving a leaked 
         * file around has little real consequence anyway. 
         */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1078"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1078"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1078"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="snapmgr.c.html#LN213"><span class='Ref_to_Macro'>XactExportFilePath</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1079"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1077"><span class='Ref_To_Local'>myxid</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1078"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1079"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
                <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"could not unlink file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1079"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * As with the FirstXactSnapshot, we needn't spend any effort on 
         * cleaning up the per-snapshot data structures, but we do need to 
         * remove them from RegisteredSnapshots to prevent a warning below. 
         */ 
</span>        <a href="../../../include/nodes/pg_list.h.html#LN160"><span class='Ref_to_Macro'>foreach</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1080"><span class='Ref_To_Local'>lc</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1101"></a>            <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snap</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a><span class='Parentheses'>) </span><a href="../../../include/nodes/pg_list.h.html#LN105"><span class='Ref_to_Macro'>lfirst</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1080"><span class='Ref_To_Local'>lc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../include/lib/pairingheap.h.html#LN83"><span class='Ref_to_Proto'>pairingheap_remove</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1101"><span class='Ref_To_Local'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a> <span class='Operator'>= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if exportedSnapshots!=NI... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Drop catalog snapshot if any */ 
</span>    <a href="../../../include/utils/snapmgr.h.html#LN70"><span class='Ref_to_Proto'>InvalidateCatalogSnapshot</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* On commit, complain about leftover snapshots */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1053"><span class='Ref_to_Parameter'>isCommit</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1115"></a>        <a href="snapmgr.c.html#LN179"><span class='Ref_to_Struct'>ActiveSnapshotElt</span></a> <span class='Operator'>*</span><span class='Declare_Local'>active</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"registered snapshots seem to remain after cleanup"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* complain about unpopped active snapshots */ 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1115"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1115"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1115"><span class='Ref_To_Local'>active</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1115"><span class='Ref_To_Local'>active</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN183"><span class='Ref_to_Member'>as_next</span></a><span class='Parentheses'>) 
</span>            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN39"><span class='Ref_to_Const'>WARNING</span></a><span class='Delimiter'>, </span><span class='String'>"snapshot %p still active"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1115"><span class='Ref_To_Local'>active</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * And reset our state.  We don't need to free the memory explicitly -- 
     * it'll go away with TopTransactionContext. 
     */ 
</span>    <a href="snapmgr.c.html#LN187"><span class='Ref_to_Global_Var'>ActiveSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN190"><span class='Ref_to_Global_Var'>OldestActiveSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/pairingheap.h.html#LN92"><span class='Ref_to_Macro'>pairingheap_reset</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN148"><span class='Ref_to_Global_Var'>CurrentSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN149"><span class='Ref_to_Global_Var'>SecondarySnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * During normal commit processing, we call ProcArrayEndTransaction() to 
     * reset the PgXact-&GT;xmin. That call happens prior to the call to 
     * AtEOXact_Snapshot(), so we need not touch xmin here at all. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1053"><span class='Ref_to_Parameter'>resetXmin</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN224"><span class='Ref_to_Proto'>SnapshotResetXmin</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1053"><span class='Ref_to_Parameter'>resetXmin</span></a> <span class='Operator'>|| </span><a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end AtEOXact_Snapshot &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * ExportSnapshot 
 *      Export the snapshot to a file so that other backends can import it. 
 *      Returns the token (the file name) that can be used to import this 
 *      snapshot. 
 */ 
</span><span class='Keyword'>char </span><span class='Operator'>* 
</span><a name="LN1157"></a><span class='Declare_Function'>ExportSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1159"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>topXid</span><span class='Delimiter'>; 
</span><a name="LN1160"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>children</span><span class='Delimiter'>; 
</span><a name="LN1161"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>nchildren</span><span class='Delimiter'>; 
</span><a name="LN1162"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>addTopXid</span><span class='Delimiter'>; 
</span><a name="LN1163"></a>    <a href="../../../include/lib/stringinfo.h.html#LN34"><span class='Ref_to_Struct'>StringInfoData</span></a> <span class='Declare_Local'>buf</span><span class='Delimiter'>; 
</span><a name="LN1164"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN1165"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1166"></a>    <a href="../../../include/utils/palloc.h.html#LN35"><span class='Ref_to_Typedef'>MemoryContext</span></a> <span class='Declare_Local'>oldcxt</span><span class='Delimiter'>; 
</span><a name="LN1167"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1168"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>pathtmp</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * It's tempting to call RequireTransactionChain here, since it's not very 
     * useful to export a snapshot that will disappear immediately afterwards. 
     * However, we haven't got enough information to do that, since we don't 
     * know if we're at top level or not.  For example, we could be inside a 
     * plpgsql function that is going to fire off other transactions via 
     * dblink.  Rather than disallow perfectly legitimate usages, don't make a 
     * check. 
     * 
     * Also note that we don't make any restriction on the transaction's 
     * isolation level; however, importers must check the level if they are 
     * serializable. 
     */ 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This will assign a transaction ID if we do not yet have one. 
     */ 
</span>    <a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN331"><span class='Ref_to_Proto'>GetTopTransactionId</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We cannot export a snapshot from a subtransaction because there's no 
     * easy way for importers to verify that the same subtransaction is still 
     * running. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN361"><span class='Ref_to_Proto'>IsSubTransaction</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot export a snapshot from a subtransaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We do however allow previous committed subtransactions to exist. 
     * Importers of the snapshot must see them as still running, so get their 
     * XIDs to add them to the snapshot. 
     */ 
</span>    <a href="snapmgr.c.html#LN1161"><span class='Ref_To_Local'>nchildren</span></a> <span class='Operator'>= </span><a href="../../../include/access/xact.h.html#LN379"><span class='Ref_to_Proto'>xactGetCommittedChildren</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1160"><span class='Ref_To_Local'>children</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy the snapshot into TopTransactionContext, add it to the 
     * exportedSnapshots list, and mark it pseudo-registered.  We do this to 
     * ensure that the snapshot's xmin is honored for the rest of the 
     * transaction. 
     */ 
</span>    <a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN222"><span class='Ref_to_Proto'>CopySnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1166"><span class='Ref_To_Local'>oldcxt</span></a> <span class='Operator'>= </span><a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a> <span class='Operator'>= </span><a href="../../nodes/list.c.html#LN126"><span class='Ref_to_Func'>lappend</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../include/utils/palloc.h.html#LN107"><span class='Ref_to_Func'>MemoryContextSwitchTo</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1166"><span class='Ref_To_Local'>oldcxt</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>    <a href="../../../include/lib/pairingheap.h.html#LN80"><span class='Ref_to_Proto'>pairingheap_add</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN108"><span class='Ref_to_Member'>ph_node</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Fill buf with a text serialization of the snapshot, plus identification 
     * data about this transaction.  The format expected by ImportSnapshot is 
     * pretty rigid: each line must be fieldname:value. 
     */ 
</span>    <a href="../../lib/stringinfo.c.html#LN44"><span class='Ref_to_Func'>initStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xid:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"dbid:%u\n"</span><span class='Delimiter'>, </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"iso:%d\n"</span><span class='Delimiter'>, </span><a href="../../access/transam/xact.c.html#LN73"><span class='Ref_to_Global_Var'>XactIsoLevel</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"ro:%d\n"</span><span class='Delimiter'>, </span><a href="../../access/transam/xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xmin:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xmax:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We must include our own top transaction ID in the top-xid data, since 
     * by definition we will still be running when the importing transaction 
     * adopts the snapshot, but GetSnapshotData never includes our own XID in 
     * the snapshot.  (There must, therefore, be enough room to add it.) 
     * 
     * However, it could be that our topXid is after the xmax, in which case 
     * we shouldn't include it because xip[] members are expected to be before 
     * xmax.  (We need not make the same check for subxip[] members, see 
     * snapshot.h.) 
     */ 
</span>    <a href="snapmgr.c.html#LN1162"><span class='Ref_To_Local'>addTopXid</span></a> <span class='Operator'>= </span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>) </span><span class='Operator'>? </span><span class='Number'>1</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xcnt:%d\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN1162"><span class='Ref_To_Local'>addTopXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xip:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1162"><span class='Ref_To_Local'>addTopXid</span></a><span class='Parentheses'>) 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"xip:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Similarly, we add our subcommitted child XIDs to the subxid data. Here, 
     * we have to cope with possible overflow. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>|| 
</span>        <a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN1161"><span class='Ref_To_Local'>nchildren</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/procarray.h.html#LN79"><span class='Ref_to_Proto'>GetMaxSnapshotSubxidCount</span></a><span class='Parentheses'>())</span> 
        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"sof:1\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN79"><span class='Ref_to_Func'>appendStringInfoString</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"sof:0\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"sxcnt:%d\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN1161"><span class='Ref_To_Local'>nchildren</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"sxp:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1161"><span class='Ref_To_Local'>nchildren</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"sxp:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1160"><span class='Ref_To_Local'>children</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1165"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../../bin/pg_waldump/compat.c.html#LN69"><span class='Ref_to_Func'>appendStringInfo</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='String'>"rec:%u\n"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1157"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now write the text representation into a file.  We first write to a 
     * ".tmp" filename, and rename to final filename if no error.  This 
     * ensures that no other backend can read an incomplete file 
     * (ImportSnapshot won't allow it because of its valid-characters check). 
     */ 
</span>    <a href="snapmgr.c.html#LN213"><span class='Ref_to_Macro'>XactExportFilePath</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>".tmp"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1164"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN1035"><span class='Ref_to_Const'>PG_BINARY_W</span></a><span class='Parentheses'>)))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not create file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fwrite<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN36"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1163"><span class='Ref_To_Local'>buf</span></a><span class='Operator'>.</span><a href="../../../include/lib/stringinfo.h.html#LN37"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1164"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* no fsync() since file need not survive a system crash */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1164"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not write to file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Now that we have written everything into a .tmp file, rename the file 
     * to remove the .tmp suffix. 
     */ 
</span>    <a href="snapmgr.c.html#LN213"><span class='Ref_to_Macro'>XactExportFilePath</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1167"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1159"><span class='Ref_To_Local'>topXid</span></a><span class='Delimiter'>, </span><a href="../../../include/nodes/pg_list.h.html#LN87"><span class='Ref_to_Func'>list_length</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../port/dirmod.c.html#LN121"><span class='Ref_to_Macro'>rename</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1167"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN132"><span class='Ref_to_Proto'>errcode_for_file_access</span></a><span class='Parentheses'>()</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"could not rename file \"%s\" to \"%s\": %m"</span><span class='Delimiter'>, 
</span>                        <a href="snapmgr.c.html#LN1168"><span class='Ref_To_Local'>pathtmp</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1167"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The basename of the file is what we return from pg_export_snapshot(). 
     * It's already in path in a textual format and we know that the path 
     * starts with SNAPSHOT_EXPORT_DIR.  Skip over the prefix and the slash 
     * and pstrdup it so as not to return the address of a local variable. 
     */ 
</span>    <span class='Control'>return</span> <a href="../../../include/common/fe_memutils.h.html#LN32"><span class='Ref_to_Proto'>pstrdup</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1167"><span class='Ref_To_Local'>path</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ExportSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * pg_export_snapshot 
 *      SQL-callable wrapper for ExportSnapshot. 
 */ 
</span><a href="../../../include/postgres.h.html#LN371"><span class='Ref_to_Typedef'>Datum</span></a> 
<a name="LN1322"></a><span class='Declare_Function'>pg_export_snapshot</span><span class='Parentheses'>(</span><a href="../../../include/fmgr.h.html#LN157"><span class='Ref_to_Const'>PG_FUNCTION_ARGS</span></a><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1324"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>snapshotName</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1324"><span class='Ref_To_Local'>snapshotName</span></a> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN98"><span class='Ref_to_Proto'>ExportSnapshot</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN77"><span class='Ref_to_Proto'>GetActiveSnapshot</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <a href="../../../include/fmgr.h.html#LN329"><span class='Ref_to_Macro'>PG_RETURN_TEXT_P</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/builtins.h.html#LN85"><span class='Ref_to_Proto'>cstring_to_text</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1324"><span class='Ref_To_Local'>snapshotName</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Parsing subroutines for ImportSnapshot: parse a line with the given 
 * prefix followed by a value, and advance *s to the next line.  The 
 * filename is provided for use in error messages. 
 */ 
</span><span class='Keyword'>static int 
</span><a name="LN1337"></a><span class='Declare_Function'>parseIntFromText</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>prefix</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1339"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span> <span class='Operator'>= *</span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>; 
</span><a name="LN1340"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>prefixlen</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1341"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>prefix</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1340"><span class='Ref_To_Local'>prefixlen</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="snapmgr.c.html#LN1340"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>"%d"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1341"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="snapmgr.c.html#LN1337"><span class='Ref_to_Parameter'>s</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1339"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1341"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parseIntFromText &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN1362"></a><span class='Declare_Function'>parseXidFromText</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>prefix</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>s</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1364"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>ptr</span> <span class='Operator'>= *</span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>s</span></a><span class='Delimiter'>; 
</span><a name="LN1365"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>prefixlen</span> <span class='Operator'>= </span>strlen<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>prefix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN1366"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>val</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strncmp<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>prefix</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1365"><span class='Ref_To_Local'>prefixlen</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+= </span><a href="snapmgr.c.html#LN1365"><span class='Ref_To_Local'>prefixlen</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>"%u"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1366"><span class='Ref_To_Local'>val</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>= </span>strchr<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a><span class='Delimiter'>, </span><span class='String'>'\n'</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Operator'>*</span><a href="snapmgr.c.html#LN1362"><span class='Ref_to_Parameter'>s</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1364"><span class='Ref_To_Local'>ptr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1366"><span class='Ref_To_Local'>val</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parseXidFromText &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * ImportSnapshot 
 *      Import a previously exported snapshot.  The argument should be a 
 *      filename in SNAPSHOT_EXPORT_DIR.  Load the snapshot from that file. 
 *      This is called by "SET TRANSACTION SNAPSHOT 'foo'". 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1393"></a><span class='Declare_Function'>ImportSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>idstr</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1395"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>path</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1396"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>f</span><span class='Delimiter'>; 
</span><a name="LN1397"></a>    <span class='Control'>struct</span> <a href="../../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>stat_buf</span><span class='Delimiter'>; 
</span><a name="LN1398"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>filebuf</span><span class='Delimiter'>; 
</span><a name="LN1399"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>xcnt</span><span class='Delimiter'>; 
</span><a name="LN1400"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1401"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>src_xid</span><span class='Delimiter'>; 
</span><a name="LN1402"></a>    <a href="../../../include/postgres_ext.h.html#LN30"><span class='Ref_to_Typedef'>Oid</span></a>         <span class='Declare_Local'>src_dbid</span><span class='Delimiter'>; 
</span><a name="LN1403"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>src_isolevel</span><span class='Delimiter'>; 
</span><a name="LN1404"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>src_readonly</span><span class='Delimiter'>; 
</span><a name="LN1405"></a>    <a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a> <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Must be at top level of a fresh transaction.  Note in particular that 
     * we check we haven't acquired an XID --- if we have, it's conceivable 
     * that the snapshot would show it as not running, making for very screwy 
     * behavior. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN202"><span class='Ref_to_Global_Var'>FirstSnapshotSet</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/access/xact.h.html#LN332"><span class='Ref_to_Proto'>GetTopTransactionIdIfAny</span></a><span class='Parentheses'>() </span><span class='Operator'>!= </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a> <span class='Operator'>|| 
</span>        <a href="../../../include/access/xact.h.html#LN361"><span class='Ref_to_Proto'>IsSubTransaction</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_ACTIVE_SQL_TRANSACTION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"SET TRANSACTION SNAPSHOT must be called before any query"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we are in read committed mode then the next query would execute with 
     * a new snapshot thus making this function call quite useless. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/xact.h.html#LN42"><span class='Ref_to_Macro'>IsolationUsesXactSnapshot</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"a snapshot-importing transaction must have isolation level SERIALIZABLE or REPEATABLE READ"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Verify the identifier: only 0-9, A-F and hyphens are allowed.  We do 
     * this mainly to prevent reading arbitrary files. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strspn<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1393"><span class='Ref_to_Parameter'>idstr</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789ABCDEF-"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1393"><span class='Ref_to_Parameter'>idstr</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot identifier: \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1393"><span class='Ref_to_Parameter'>idstr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, read the file */ 
</span>    <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a> <span class='String'>"/%s"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1393"><span class='Ref_to_Parameter'>idstr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1396"><span class='Ref_To_Local'>f</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN83"><span class='Ref_to_Proto'>AllocateFile</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><a href="../../../tools/entab/entab.c.html#LN12"><span class='Ref_to_Const'>PG_BINARY_R</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1396"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_PARAMETER_VALUE<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot identifier: \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1393"><span class='Ref_to_Parameter'>idstr</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* get the size of the file so that we know how much memory we need */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fstat<span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1396"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1397"><span class='Ref_To_Local'>stat_buf</span></a><span class='Parentheses'>))</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not stat file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* and read the file into a palloc'd string */ 
</span>    <a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1397"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>fread<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1397"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_size<span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1396"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, </span><span class='String'>"could not read file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1397"><span class='Ref_To_Local'>stat_buf</span></a><span class='Operator'>.</span>st_size<span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/fd.h.html#LN84"><span class='Ref_to_Proto'>FreeFile</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1396"><span class='Ref_To_Local'>f</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Construct a snapshot struct by parsing the file content. 
     */ 
</span>    memset<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1401"><span class='Ref_To_Local'>src_xid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"xid:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* we abuse parseXidFromText a bit here ... */ 
</span>    <a href="snapmgr.c.html#LN1402"><span class='Ref_To_Local'>src_dbid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"dbid:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1403"><span class='Ref_To_Local'>src_isolevel</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"iso:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1404"><span class='Ref_To_Local'>src_readonly</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"ro:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"xmin:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"xmax:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"xcnt:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sanity-check the xid count before palloc */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/procarray.h.html#LN78"><span class='Ref_to_Proto'>GetMaxSnapshotXidCount</span></a><span class='Parentheses'>())</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"xip:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"sof:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"sxcnt:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* sanity-check the xid count before palloc */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>&GT; </span><a href="../../../include/storage/procarray.h.html#LN79"><span class='Ref_to_Proto'>GetMaxSnapshotSubxidCount</span></a><span class='Parentheses'>())</span> 
            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
        <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../../include/common/fe_memutils.h.html#LN33"><span class='Ref_to_Proto'>palloc</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1399"><span class='Ref_To_Local'>xcnt</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1400"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1361"><span class='Ref_to_Func'>parseXidFromText</span></a><span class='Parentheses'>(</span><span class='String'>"sxp:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1336"><span class='Ref_to_Func'>parseIntFromText</span></a><span class='Parentheses'>(</span><span class='String'>"rec:"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1398"><span class='Ref_To_Local'>filebuf</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Do some additional sanity checking, just to protect ourselves.  We 
     * don't trouble to check the array elements, just the most critical 
     * fields. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1401"><span class='Ref_To_Local'>src_xid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../../include/c.h.html#LN537"><span class='Ref_to_Macro'>OidIsValid</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1402"><span class='Ref_To_Local'>src_dbid</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>.</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Parentheses'>))</span> 
        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_INVALID_TEXT_REPRESENTATION<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                 <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"invalid snapshot data in file \"%s\""</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1395"><span class='Ref_To_Local'>path</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're serializable, the source transaction must be too, otherwise 
     * predicate.c has problems (SxactGlobalXmin could go backwards).  Also, a 
     * non-read-only transaction can't adopt a snapshot from a read-only 
     * transaction, as predicate.c handles the cases very differently. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/xact.h.html#LN43"><span class='Ref_to_Macro'>IsolationIsSerializable</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1403"><span class='Ref_To_Local'>src_isolevel</span></a> <span class='Operator'>!= </span><a href="../../../include/access/xact.h.html#LN30"><span class='Ref_to_Const'>XACT_SERIALIZABLE</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"a serializable transaction cannot import a snapshot from a non-serializable transaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1404"><span class='Ref_To_Local'>src_readonly</span></a> <span class='Operator'>&& !</span><a href="../../access/transam/xact.c.html#LN76"><span class='Ref_to_Global_Var'>XactReadOnly</span></a><span class='Parentheses'>) 
</span>            <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                     <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"a non-read-only serializable transaction cannot import a snapshot from a read-only transaction"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We cannot import a snapshot that was taken in a different database, 
     * because vacuum calculates OldestXmin on a per-database basis; so the 
     * source transaction's xmin doesn't protect us from data loss.  This 
     * restriction could be removed if the source transaction were to mark its 
     * xmin as being globally applicable.  But that would require some 
     * additional syntax, since that has to be known when the snapshot is 
     * initially taken.  (See pgsql-hackers discussion of 2011-10-21.) 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1402"><span class='Ref_To_Local'>src_dbid</span></a> <span class='Operator'>!= </span><a href="../init/globals.c.html#LN76"><span class='Ref_to_Global_Var'>MyDatabaseId</span></a><span class='Parentheses'>) 
</span>        <a href="../../../include/utils/elog.h.html#LN121"><span class='Ref_to_Macro'>ereport</span></a><span class='Parentheses'>(</span><a href="../../../include/port/win32/sys/socket.h.html#LN22"><span class='Ref_to_Const'>ERROR</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN130"><span class='Ref_to_Proto'>errcode</span></a><span class='Parentheses'>(</span>ERRCODE_FEATURE_NOT_SUPPORTED<span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>              <a href="../error/elog.c.html#LN795"><span class='Ref_to_Func'>errmsg</span></a><span class='Parentheses'>(</span><span class='String'>"cannot import a snapshot from a different database"</span><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* OK, install the snapshot */ 
</span>    <a href="snapmgr.c.html#LN559"><span class='Ref_to_Func'>SetTransactionSnapshot</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN1405"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1401"><span class='Ref_To_Local'>src_xid</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ImportSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * XactHasExportedSnapshots 
 *      Test whether current transaction has exported any snapshots. 
 */ 
</span><span class='Keyword'>bool 
</span><a name="LN1564"></a><span class='Declare_Function'>XactHasExportedSnapshots</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN218"><span class='Ref_to_Global_Var'>exportedSnapshots</span></a> <span class='Operator'>!= </span><a href="../../../include/nodes/pg_list.h.html#LN68"><span class='Ref_to_Const'>NIL</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * DeleteAllExportedSnapshotFiles 
 *      Clean up any files that have been left behind by a crashed backend 
 *      that had exported snapshots before it died. 
 * 
 * This should be called during database startup or crash recovery. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1577"></a><span class='Declare_Function'>DeleteAllExportedSnapshotFiles</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1579"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><a href="../../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>]; 
</span><a name="LN1580"></a>    <a href="../../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>s_dir</span><span class='Delimiter'>; 
</span><a name="LN1581"></a>    <span class='Control'>struct</span> <a href="../../../include/port/win32_msvc/dirent.h.html#LN8"><span class='Ref_to_Struct'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>s_de</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1580"><span class='Ref_To_Local'>s_dir</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN91"><span class='Ref_to_Proto'>AllocateDir</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * We really should have that directory in a sane cluster setup. But 
         * then again if we don't, it's not fatal enough to make it FATAL. 
         * Since we're running in the postmaster, LOG is our best bet. 
         */ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not open directory \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="snapmgr.c.html#LN1581"><span class='Ref_To_Local'>s_de</span></a> <span class='Operator'>= </span><a href="../../../include/storage/fd.h.html#LN92"><span class='Ref_to_Proto'>ReadDir</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1580"><span class='Ref_To_Local'>s_dir</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1581"><span class='Ref_To_Local'>s_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>"."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1581"><span class='Ref_To_Local'>s_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='String'>".."</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <a href="../../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1579"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1579"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN212"><span class='Ref_to_Const'>SNAPSHOT_EXPORT_DIR</span></a> <span class='String'>"/%s"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1581"><span class='Ref_To_Local'>s_de</span></a><span class='Operator'>-&GT;</span><a href="../../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Comment_Multi_Line'>/* Again, unlink failure is not worthy of FATAL */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../timezone/private.h.html#LN59"><span class='Ref_to_Proto'>unlink</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1579"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
            <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN25"><span class='Ref_to_Const'>LOG</span></a><span class='Delimiter'>, </span><span class='String'>"could not unlink file \"%s\": %m"</span><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1579"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/fd.h.html#LN93"><span class='Ref_to_Proto'>FreeDir</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1580"><span class='Ref_To_Local'>s_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end DeleteAllExportedSnapshotFiles &raquo; </span> 
 
<span class='Keyword'>bool 
</span><a name="LN1610"></a><span class='Declare_Function'>ThereAreNoPriorRegisteredSnapshots</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/lib/pairingheap.h.html#LN95"><span class='Ref_to_Macro'>pairingheap_is_empty</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../../include/lib/pairingheap.h.html#LN98"><span class='Ref_to_Macro'>pairingheap_is_singular</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN199"><span class='Ref_to_Global_Var'>RegisteredSnapshots</span></a><span class='Parentheses'>))</span> 
        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Return a timestamp that is exactly on a minute boundary. 
 * 
 * If the argument is already aligned, return that value, otherwise move to 
 * the next minute boundary following the given time. 
 */ 
</span><span class='Keyword'>static </span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN1627"></a><span class='Declare_Function'>AlignTimestampToMinuteBoundary</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>ts</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1629"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>retval</span> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1627"><span class='Ref_to_Parameter'>ts</span></a> <span class='Operator'>+ </span><span class='Parentheses'>(</span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1629"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1629"><span class='Ref_To_Local'>retval</span></a> <span class='Operator'>% </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get current timestamp for snapshots 
 * 
 * This is basically GetCurrentTimestamp(), but with a guarantee that 
 * the result never moves backward. 
 */ 
</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN1641"></a><span class='Declare_Function'>GetSnapshotCurrentTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1643"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>now</span> <span class='Operator'>= </span><a href="../../../include/utils/timestamp.h.html#LN69"><span class='Ref_to_Proto'>GetCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't let time move backward; if it hasn't advanced, use the old value. 
     */ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN84"><span class='Ref_to_Member'>mutex_current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1643"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>&LT;= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN85"><span class='Ref_to_Member'>current_timestamp</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN1643"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN85"><span class='Ref_to_Member'>current_timestamp</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN85"><span class='Ref_to_Member'>current_timestamp</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1643"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN84"><span class='Ref_to_Member'>mutex_current</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1643"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Get timestamp through which vacuum may have processed based on last stored 
 * value for threshold_timestamp. 
 * 
 * XXX: So far, we never trust that a 64-bit value can be read atomically; if 
 * that ever changes, we could get rid of the spinlock here. 
 */ 
</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> 
<a name="LN1666"></a><span class='Declare_Function'>GetOldSnapshotThresholdTimestamp</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1668"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>threshold_timestamp</span><span class='Delimiter'>; 
</span> 
    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1668"><span class='Ref_To_Local'>threshold_timestamp</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN91"><span class='Ref_to_Member'>threshold_timestamp</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1668"><span class='Ref_To_Local'>threshold_timestamp</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>static void 
</span><a name="LN1678"></a><span class='Declare_Function'>SetOldSnapshotThresholdTimestamp</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>ts</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xlimit</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN91"><span class='Ref_to_Member'>threshold_timestamp</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1678"><span class='Ref_to_Parameter'>ts</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN92"><span class='Ref_to_Member'>threshold_xid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1678"><span class='Ref_to_Parameter'>xlimit</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * TransactionIdLimitedForOldSnapshots 
 * 
 * Apply old snapshot limit, if any.  This is intended to be called for page 
 * pruning and table vacuuming, to allow old_snapshot_threshold to override 
 * the normal global xmin value.  Actual testing for snapshot too old will be 
 * based on whether a snapshot timestamp is prior to the threshold timestamp 
 * set in this function. 
 */ 
</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> 
<a name="LN1696"></a><span class='Declare_Function'>TransactionIdLimitedForOldSnapshots</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>recentXmin</span><span class='Delimiter'>, 
</span><a name="LN1697"></a>                                    <a href="../../../include/utils/relcache.h.html#LN20"><span class='Ref_to_Typedef'>Relation</span></a> <span class='Declare_Parameter'>relation</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>&& </span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span> 
        <span class='Operator'>&& </span><a href="../../../include/utils/snapmgr.h.html#LN37"><span class='Ref_to_Macro'>RelationAllowsEarlyPruning</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1697"><span class='Ref_to_Parameter'>relation</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span><a name="LN1703"></a>        <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>ts</span> <span class='Operator'>= </span><a href="../../../include/utils/snapmgr.h.html#LN53"><span class='Ref_to_Proto'>GetSnapshotCurrentTimestamp</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span><a name="LN1704"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>xlimit</span> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Delimiter'>; 
</span><a name="LN1705"></a>        <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latest_xmin</span><span class='Delimiter'>; 
</span><a name="LN1706"></a>        <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>update_ts</span><span class='Delimiter'>; 
</span><a name="LN1707"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>same_ts_as_threshold</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN86"><span class='Ref_to_Member'>mutex_latest_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN88"><span class='Ref_to_Member'>latest_xmin</span></a><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN1706"><span class='Ref_To_Local'>update_ts</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN89"><span class='Ref_to_Member'>next_map_update</span></a><span class='Delimiter'>; 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN86"><span class='Ref_to_Member'>mutex_latest_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Zero threshold always overrides to latest xmin, if valid.  Without 
         * some heuristic it will find its own snapshot too old on, for 
         * example, a simple UPDATE -- which would make it useless for most 
         * testing, but there is no principled way to ensure that it doesn't 
         * fail in this way.  Use a five-second delay to try to get useful 
         * testing behavior, but this may need adjustment. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>, </span><a href="../../storage/lmgr/proc.c.html#LN67"><span class='Ref_to_Global_Var'>MyPgXact</span></a><span class='Operator'>-&GT;</span><a href="../../../include/storage/proc.h.html#LN212"><span class='Ref_to_Member'>xmin</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>&& </span><a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Parentheses'>))</span> 
                <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>; 
</span> 
            <a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>-= </span><span class='Number'>5</span> <span class='Operator'>* </span><a href="../../../include/datatype/timestamp.h.html#LN93"><span class='Ref_to_Const'>USECS_PER_SEC</span></a><span class='Delimiter'>; 
</span>            <a href="snapmgr.c.html#LN1677"><span class='Ref_to_Func'>SetOldSnapshotThresholdTimestamp</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>return</span> <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN221"><span class='Ref_to_Proto'>AlignTimestampToMinuteBoundary</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>- </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>* </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Check for fast exit without LW locking. */ 
</span>        <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>== </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN91"><span class='Ref_to_Member'>threshold_timestamp</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN92"><span class='Ref_to_Member'>threshold_xid</span></a><span class='Delimiter'>; 
</span>            <a href="snapmgr.c.html#LN1707"><span class='Ref_To_Local'>same_ts_as_threshold</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN90"><span class='Ref_to_Member'>mutex_threshold</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1707"><span class='Ref_To_Local'>same_ts_as_threshold</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>== </span><a href="snapmgr.c.html#LN1706"><span class='Ref_To_Local'>update_ts</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN66"><span class='Ref_to_Macro'>NormalTransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Parentheses'>))</span> 
                    <a href="snapmgr.c.html#LN1677"><span class='Ref_to_Func'>SetOldSnapshotThresholdTimestamp</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>OldSnapshotTimeMapLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN134"><span class='Ref_to_EnumConst'>LW_SHARED</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> 
                    <span class='Operator'>&& </span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>&GT;= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span><a name="LN1761"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>offset</span><span class='Delimiter'>; 
</span> 
                    <a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>- </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a><span class='Parentheses'>) 
</span>                              <span class='Operator'>/ </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>&GT; </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                        <a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a><span class='Parentheses'>) 
</span>                        <span class='Operator'>% </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Delimiter'>; 
</span>                    <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1761"><span class='Ref_To_Local'>offset</span></a><span class='Delimiter'>]; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN66"><span class='Ref_to_Macro'>NormalTransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Parentheses'>))</span> 
                        <a href="snapmgr.c.html#LN1677"><span class='Ref_to_Func'>SetOldSnapshotThresholdTimestamp</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1703"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span> 
                <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>OldSnapshotTimeMapLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !same_ts_as_threshold &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Failsafe protection against vacuuming work of active transaction. 
         * 
         * This is not an assertion because we avoid the spinlock for 
         * performance, leaving open the possibility that xlimit could advance 
         * and be more current; but it seems prudent to apply this limit.  It 
         * might make pruning a tiny bit less aggressive than it could be, but 
         * protects against data loss bugs. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Parentheses'>) 
</span>            <span class='Operator'>&& </span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Parentheses'>))</span> 
            <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1705"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN66"><span class='Ref_to_Macro'>NormalTransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Parentheses'>))</span> 
            <span class='Control'>return</span> <a href="snapmgr.c.html#LN1704"><span class='Ref_To_Local'>xlimit</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if TransactionIdIsNormal... &raquo; </span> 
 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN1696"><span class='Ref_to_Parameter'>recentXmin</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end TransactionIdLimitedForOldSnapshots &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Take care of the circular buffer that maps time to xid. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1803"></a><span class='Declare_Function'>MaintainOldSnapshotTimeMapping</span><span class='Parentheses'>(</span><a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Parameter'>whenTaken</span><span class='Delimiter'>, </span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Parameter'>xmin</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1805"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>ts</span><span class='Delimiter'>; 
</span><a name="LN1806"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Declare_Local'>latest_xmin</span><span class='Delimiter'>; 
</span><a name="LN1807"></a>    <a href="../../../interfaces/ecpg/include/pgtypes_timestamp.h.html#LN9"><span class='Ref_to_Typedef'>TimestampTz</span></a> <span class='Declare_Local'>update_ts</span><span class='Delimiter'>; 
</span><a name="LN1808"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>map_update_required</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Never call this function when old snapshot checking is disabled. */ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN221"><span class='Ref_to_Proto'>AlignTimestampToMinuteBoundary</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>whenTaken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Keep track of the latest xmin seen by any process. Update mapping with 
     * a new value when we have crossed a bucket boundary. 
     */ 
</span>    <a href="../../../include/storage/spin.h.html#LN61"><span class='Ref_to_Macro'>SpinLockAcquire</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN86"><span class='Ref_to_Member'>mutex_latest_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1806"><span class='Ref_To_Local'>latest_xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN88"><span class='Ref_to_Member'>latest_xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN1807"><span class='Ref_To_Local'>update_ts</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN89"><span class='Ref_to_Member'>next_map_update</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>&GT; </span><a href="snapmgr.c.html#LN1807"><span class='Ref_To_Local'>update_ts</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN89"><span class='Ref_to_Member'>next_map_update</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN1808"><span class='Ref_To_Local'>map_update_required</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN170"><span class='Ref_to_Proto'>TransactionIdFollows</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN1806"><span class='Ref_To_Local'>latest_xmin</span></a><span class='Parentheses'>))</span> 
        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN88"><span class='Ref_to_Member'>latest_xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="../../../include/storage/spin.h.html#LN63"><span class='Ref_to_Macro'>SpinLockRelease</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN86"><span class='Ref_to_Member'>mutex_latest_xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We only needed to update the most recent xmin value. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1808"><span class='Ref_To_Local'>map_update_required</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* No further tracking needed for 0 (used for testing). */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN73"><span class='Ref_to_Global_Var'>old_snapshot_threshold</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * We don't want to do something stupid with unusual values, but we don't 
     * want to litter the log with warnings or break otherwise normal 
     * processing for this feature; so if something seems unreasonable, just 
     * log at DEBUG level and return without doing anything. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>whenTaken</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>        <span class='String'>"MaintainOldSnapshotTimeMapping called with negative whenTaken = %ld"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>whenTaken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../../include/access/transam.h.html#LN41"><span class='Ref_to_Macro'>TransactionIdIsNormal</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"MaintainOldSnapshotTimeMapping called with xmin = %lu"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>unsigned long</span><span class='Parentheses'>) </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../../include/storage/lwlock.h.html#LN145"><span class='Ref_to_Proto'>LWLockAcquire</span></a><span class='Parentheses'>(</span>OldSnapshotTimeMapLock<span class='Delimiter'>, </span><a href="../../../include/storage/lwlock.h.html#LN133"><span class='Ref_to_EnumConst'>LW_EXCLUSIVE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>&LT; </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>((</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a> <span class='Operator'>% </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>&LT;= </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* set up first entry for empty mapping */ 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* old ts; log it at DEBUG */ 
</span>        <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>OldSnapshotTimeMapLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../bootstrap/bootscanner.l.html#LN129"><span class='Ref_to_Proto'>elog</span></a><span class='Parentheses'>(</span><a href="../../../include/utils/elog.h.html#LN24"><span class='Ref_to_Const'>DEBUG1</span></a><span class='Delimiter'>, 
</span>             <span class='String'>"MaintainOldSnapshotTimeMapping called with old whenTaken = %ld"</span><span class='Delimiter'>, 
</span>             <span class='Parentheses'>(</span><span class='Keyword'>long</span><span class='Parentheses'>) </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>whenTaken</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>&LT;= </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a> <span class='Operator'>+ 
</span>                    <span class='Parentheses'>((</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>                     <span class='Operator'>* </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>)))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* existing mapping; advance xid if possible */ 
</span><a name="LN1890"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>bucket</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> 
                              <span class='Operator'>+ </span><span class='Parentheses'>((</span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>- </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a><span class='Parentheses'>) 
</span>                                 <span class='Operator'>/ </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>))</span> 
        <span class='Operator'>% </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../../include/access/transam.h.html#LN168"><span class='Ref_to_Proto'>TransactionIdPrecedes</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1890"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>], </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Parentheses'>))</span> 
            <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1890"><span class='Ref_To_Local'>bucket</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* We need a new bucket, but it might not be the very next one. */ 
</span><a name="LN1901"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>advance</span> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a> <span class='Operator'>- </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a><span class='Parentheses'>) 
</span>                               <span class='Operator'>/ </span><a href="../../../include/datatype/timestamp.h.html#LN92"><span class='Ref_to_Const'>USECS_PER_MINUTE</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN123"><span class='Ref_to_Member'>head_timestamp</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1805"><span class='Ref_To_Local'>ts</span></a><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1901"><span class='Ref_To_Local'>advance</span></a> <span class='Operator'>&GT;= </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Advance is so far that all old data is junk; start over. */ 
</span>            <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>            <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>            <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Store the new value in one or more buckets. */ 
</span><a name="LN1916"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1916"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1916"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="snapmgr.c.html#LN1901"><span class='Ref_To_Local'>advance</span></a><span class='Delimiter'>; </span><a href="snapmgr.c.html#LN1916"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a> <span class='Operator'>== </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Map full and new value replaces old head. */ 
</span><a name="LN1923"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>old_head</span> <span class='Operator'>= </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a><span class='Delimiter'>; 
</span> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1923"><span class='Ref_To_Local'>old_head</span></a> <span class='Operator'>== </span><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
                        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <span class='Control'>else</span> 
                        <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1923"><span class='Ref_To_Local'>old_head</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1923"><span class='Ref_To_Local'>old_head</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* Extend map to unused entry. */ 
</span><a name="LN1934"></a>                    <span class='Keyword'>int</span>         <span class='Declare_Local'>new_tail</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN122"><span class='Ref_to_Member'>head_offset</span></a> 
                                            <span class='Operator'>+ </span><a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a><span class='Parentheses'>) 
</span>                    <span class='Operator'>% </span><a href="../../../include/utils/snapmgr.h.html#LN31"><span class='Ref_to_Const'>OLD_SNAPSHOT_TIME_MAP_ENTRIES</span></a><span class='Delimiter'>; 
</span> 
                    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN124"><span class='Ref_to_Member'>count_used</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                    <a href="snapmgr.c.html#LN128"><span class='Ref_to_Global_Var'>oldSnapshotControl</span></a><span class='Operator'>-&GT;</span><a href="snapmgr.c.html#LN125"><span class='Ref_to_Member'>xid_by_minute</span></a><span class='Delimiter'>[</span><a href="snapmgr.c.html#LN1934"><span class='Ref_To_Local'>new_tail</span></a><span class='Delimiter'>] </span><span class='Operator'>= </span><a href="snapmgr.c.html#LN1803"><span class='Ref_to_Parameter'>xmin</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for i=0;i&LT;advance;i++ &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
    <a href="../../../include/storage/lwlock.h.html#LN148"><span class='Ref_to_Proto'>LWLockRelease</span></a><span class='Parentheses'>(</span>OldSnapshotTimeMapLock<span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end MaintainOldSnapshotTimeMapping &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Setup a snapshot that replaces normal catalog snapshots that allows catalog 
 * access to behave just like it did at a certain point in the past. 
 * 
 * Needed for logical decoding. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1956"></a><span class='Declare_Function'>SetupHistoricSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>historic_snapshot</span><span class='Delimiter'>, </span><a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tuplecids</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1956"><span class='Ref_to_Parameter'>historic_snapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* setup the timetravel snapshot */ 
</span>    <a href="snapmgr.c.html#LN151"><span class='Ref_to_Global_Var'>HistoricSnapshot</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1956"><span class='Ref_to_Parameter'>historic_snapshot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* setup (cmin, cmax) lookup hash */ 
</span>    <a href="snapmgr.c.html#LN169"><span class='Ref_to_Global_Var'>tuplecid_data</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN1956"><span class='Ref_to_Parameter'>tuplecids</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Make catalog snapshots behave normally again. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN1972"></a><span class='Declare_Function'>TeardownHistoricSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>bool </span><span class='Declare_Parameter'>is_error</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="snapmgr.c.html#LN151"><span class='Ref_to_Global_Var'>HistoricSnapshot</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN169"><span class='Ref_to_Global_Var'>tuplecid_data</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<span class='Keyword'>bool 
</span><a name="LN1979"></a><span class='Declare_Function'>HistoricSnapshotActive</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>return</span> <a href="snapmgr.c.html#LN151"><span class='Ref_to_Global_Var'>HistoricSnapshot</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
} 
</span> 
<a href="../hash/dynahash.c.html#LN192"><span class='Ref_to_Struct'>HTAB</span></a> <span class='Operator'>* 
</span><a name="LN1985"></a><span class='Declare_Function'>HistoricSnapshotGetTupleCids</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapmgr.h.html#LN105"><span class='Ref_to_Proto'>HistoricSnapshotActive</span></a><span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <a href="snapmgr.c.html#LN169"><span class='Ref_to_Global_Var'>tuplecid_data</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * EstimateSnapshotSpace 
 *      Returns the size needed to store the given snapshot. 
 * 
 * We are exporting only required fields from the Snapshot, stored in 
 * SerializedSnapshotData. 
 */ 
</span><a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a> 
<a name="LN1999"></a><span class='Declare_Function'>EstimateSnapshotSpace</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snap</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2001"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a> <span class='Operator'>!= </span><a href="../../../include/utils/snapshot.h.html#LN24"><span class='Ref_to_Const'>InvalidSnapshot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN53"><span class='Ref_to_Member'>satisfies</span></a> <span class='Operator'>== </span><a href="../../../include/utils/tqual.h.html#LN58"><span class='Ref_to_Proto'>HeapTupleSatisfiesMVCC</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We allocate any XID arrays needed in the same palloc block. */ 
</span>    <a href="snapmgr.c.html#LN2001"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span> <span class='Operator'>&& 
</span>        <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>|| </span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>))</span> 
        <a href="snapmgr.c.html#LN2001"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><a href="../../../include/storage/shmem.h.html#LN44"><span class='Ref_to_Proto'>add_size</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2001"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>, 
</span>                        <a href="../../../include/storage/shmem.h.html#LN45"><span class='Ref_to_Proto'>mul_size</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN1999"><span class='Ref_to_Parameter'>snap</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN2001"><span class='Ref_To_Local'>size</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * SerializeSnapshot 
 *      Dumps the serialized snapshot (extracted from given snapshot) onto the 
 *      memory location at start_address. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2023"></a><span class='Declare_Function'>SerializeSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_address</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2025"></a>    <a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a> <span class='Declare_Local'>serialized_snapshot</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy all required fields */ 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN234"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN235"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN238"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN239"><span class='Ref_to_Member'>takenDuringRecovery</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN240"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN241"><span class='Ref_to_Member'>whenTaken</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN110"><span class='Ref_to_Member'>whenTaken</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN242"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN111"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy struct to possibly-unaligned buffer */ 
</span>    memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>start_address</span></a><span class='Delimiter'>, 
</span>           <span class='Operator'>&</span><a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy XID array */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        memcpy<span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>)</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>+ 
</span>                                  <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Copy SubXID array. Don't bother to copy it if it had overflowed, 
     * though, because it's not used anywhere in that case. Except if it's a 
     * snapshot taken during recovery; all the top-level XIDs are in subxip as 
     * well in that case, so we mustn't lose them. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN238"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>&& !</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Parentheses'>) 
</span>        <a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2025"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN2061"></a>        <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>subxipoff</span> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>) </span><span class='Operator'>+ 
</span>        <a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        memcpy<span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN2061"><span class='Ref_To_Local'>subxipoff</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2023"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end SerializeSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * RestoreSnapshot 
 *      Restore a serialized snapshot from the specified address. 
 * 
 * The copy is palloc'd in TopTransactionContext and has initial refcounts set 
 * to 0.  The returned snapshot has the copied flag set. 
 */ 
</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> 
<a name="LN2077"></a><span class='Declare_Function'>RestoreSnapshot</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>start_address</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2079"></a>    <a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a> <span class='Declare_Local'>serialized_snapshot</span><span class='Delimiter'>; 
</span><a name="LN2080"></a>    <a href="../../../include/c.h.html#LN355"><span class='Ref_to_Typedef'>Size</span></a>        <span class='Declare_Local'>size</span><span class='Delimiter'>; 
</span><a name="LN2081"></a>    <a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a>    <span class='Declare_Local'>snapshot</span><span class='Delimiter'>; 
</span><a name="LN2082"></a>    <a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Declare_Local'>serialized_xids</span><span class='Delimiter'>; 
</span> 
    memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2077"><span class='Ref_to_Parameter'>start_address</span></a><span class='Delimiter'>, 
</span>           <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2082"><span class='Ref_To_Local'>serialized_xids</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) 
</span>        <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2077"><span class='Ref_to_Parameter'>start_address</span></a> <span class='Operator'>+ </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN232"><span class='Ref_to_Struct'>SerializedSnapshotData</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* We allocate any XID arrays needed in the same palloc block. */ 
</span>    <a href="snapmgr.c.html#LN2080"><span class='Ref_To_Local'>size</span></a> <span class='Operator'>= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN51"><span class='Ref_to_Struct'>SnapshotData</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>+ </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>) 
</span>        <span class='Operator'>+ </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy all required fields */ 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a><span class='Parentheses'>) </span><a href="../../../include/utils/palloc.h.html#LN70"><span class='Ref_to_Proto'>MemoryContextAlloc</span></a><span class='Parentheses'>(</span><a href="../mmgr/mcxt.c.html#LN47"><span class='Ref_to_Global_Var'>TopTransactionContext</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2080"><span class='Ref_To_Local'>size</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN53"><span class='Ref_to_Member'>satisfies</span></a> <span class='Operator'>= </span><a href="../../../include/utils/tqual.h.html#LN58"><span class='Ref_to_Proto'>HeapTupleSatisfiesMVCC</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN65"><span class='Ref_to_Member'>xmin</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN234"><span class='Ref_to_Member'>xmin</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN66"><span class='Ref_to_Member'>xmax</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN235"><span class='Ref_to_Member'>xmax</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN77"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN89"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN90"><span class='Ref_to_Member'>suboverflowed</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN238"><span class='Ref_to_Member'>suboverflowed</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN92"><span class='Ref_to_Member'>takenDuringRecovery</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN239"><span class='Ref_to_Member'>takenDuringRecovery</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN95"><span class='Ref_to_Member'>curcid</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN240"><span class='Ref_to_Member'>curcid</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN110"><span class='Ref_to_Member'>whenTaken</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN241"><span class='Ref_to_Member'>whenTaken</span></a><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN111"><span class='Ref_to_Member'>lsn</span></a> <span class='Operator'>= </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN242"><span class='Ref_to_Member'>lsn</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Copy XIDs, if present. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN76"><span class='Ref_to_Member'>xip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2082"><span class='Ref_To_Local'>serialized_xids</span></a><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Copy SubXIDs, if present. */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a> <span class='Operator'>*</span><span class='Parentheses'>) (</span><a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>))</span> <span class='Operator'>+ 
</span>            <a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>; 
</span>        memcpy<span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN88"><span class='Ref_to_Member'>subxip</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2082"><span class='Ref_To_Local'>serialized_xids</span></a> <span class='Operator'>+ </span><a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN236"><span class='Ref_to_Member'>xcnt</span></a><span class='Delimiter'>, 
</span>               <a href="snapmgr.c.html#LN2079"><span class='Ref_To_Local'>serialized_snapshot</span></a><span class='Operator'>.</span><a href="snapmgr.c.html#LN237"><span class='Ref_to_Member'>subxcnt</span></a> <span class='Operator'>* </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="../../../include/c.h.html#LN396"><span class='Ref_to_Typedef'>TransactionId</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Set the copied flag so that the caller will set refcounts correctly. */ 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN107"><span class='Ref_to_Member'>regd_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN106"><span class='Ref_to_Member'>active_count</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Operator'>-&GT;</span><a href="../../../include/utils/snapshot.h.html#LN93"><span class='Ref_to_Member'>copied</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="snapmgr.c.html#LN2081"><span class='Ref_To_Local'>snapshot</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end RestoreSnapshot &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Install a restored snapshot as the transaction snapshot. 
 * 
 * The second argument is of type void * so that snapmgr.h need not include 
 * the declaration for PGPROC. 
 */ 
</span><span class='Keyword'>void 
</span><a name="LN2141"></a><span class='Declare_Function'>RestoreTransactionSnapshot</span><span class='Parentheses'>(</span><a href="../../../include/utils/snapshot.h.html#LN22"><span class='Ref_to_Typedef'>Snapshot</span></a> <span class='Declare_Parameter'>snapshot</span><span class='Delimiter'>, </span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Declare_Parameter'>master_pgproc</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="snapmgr.c.html#LN559"><span class='Ref_to_Func'>SetTransactionSnapshot</span></a><span class='Parentheses'>(</span><a href="snapmgr.c.html#LN2141"><span class='Ref_to_Parameter'>snapshot</span></a><span class='Delimiter'>, </span><a href="../../../include/access/transam.h.html#LN30"><span class='Ref_to_Const'>InvalidTransactionId</span></a><span class='Delimiter'>, </span><a href="snapmgr.c.html#LN2141"><span class='Ref_to_Parameter'>master_pgproc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span></pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>