<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_basebackup\pg_basebackup.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_basebackup\pg_basebackup.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
</span><span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pg_basebackup.c - receive a base backup using streaming replication protocol 
 * 
 * Author: Magnus Hagander &LT;magnus@hagander.net&GT; 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *        src/bin/pg_basebackup/pg_basebackup.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;dirent.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/wait.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;time.h&GT;</span> 
<span class='Directive'>#ifdef</span> HAVE_SYS_SELECT_H 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/select.h&GT;</span> 
<span class='Directive'>#endif</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<span class='Keyword'>#include </span><span class='String'>&LT;zlib.h&GT;</span> 
<span class='Directive'>#endif</span> 
 
<span class='Keyword'>#include </span><span class='String'>"common/file_utils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"common/string.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"fe_utils/string_utils.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"getopt_long.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pqexpbuffer.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgtar.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"pgtime.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"receivelog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"replication/basebackup.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"streamutil.h"</span> 
 
 
<a name="LN41"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TablespaceListCell</span> 
<span class='Delimiter'>{ 
</span><a name="LN43"></a>    <span class='Control'>struct</span> <a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Declare_Member'>next</span><span class='Delimiter'>; 
</span><a name="LN44"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>old_dir</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN45"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>new_dir</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN46"></a>} <span class='Declare_Typedef'>TablespaceListCell</span><span class='Delimiter'>; 
</span> 
<a name="LN48"></a><span class='Control'>typedef</span> <span class='Control'>struct</span> <span class='Declare_Struct'>TablespaceList</span> 
<span class='Delimiter'>{ 
</span><a name="LN50"></a>    <a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Declare_Member'>head</span><span class='Delimiter'>; 
</span><a name="LN51"></a>    <a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Declare_Member'>tail</span><span class='Delimiter'>; 
</span><a name="LN52"></a>} <span class='Declare_Typedef'>TablespaceList</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* 
 * pg_xlog has been renamed to pg_wal in version 10.  This version number 
 * should be compared with PQserverVersion(). 
 */ 
</span><a name="LN58"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MINIMUM_VERSION_FOR_PG_WAL</span>  <span class='Number'>100000</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Temporary replication slots are supported from version 10. 
 */ 
</span><a name="LN63"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>MINIMUM_VERSION_FOR_TEMP_SLOTS</span> <span class='Number'>100000</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Different ways to include WAL 
 */ 
</span><span class='Control'>typedef</span> <span class='Control'>enum</span> 
<span class='Delimiter'>{ 
</span><a name="LN70"></a>    <span class='Declare_Enum_Const'>NO_WAL</span><span class='Delimiter'>, 
</span><a name="LN71"></a>    <span class='Declare_Enum_Const'>FETCH_WAL</span><span class='Delimiter'>, 
</span><a name="LN72"></a>    <span class='Declare_Enum_Const'>STREAM_WAL</span> 
<a name="LN73"></a><span class='Delimiter'>} </span><span class='Declare_Typedef'>IncludeWal</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Global options */ 
</span><a name="LN76"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>basedir</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN77"></a><span class='Keyword'>static </span><a href="pg_basebackup.c.html#LN48"><span class='Ref_to_Struct'>TablespaceList</span></a> <span class='Declare_Var'>tablespace_dirs</span> <span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>}; 
</span><a name="LN78"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>xlog_dir</span> <span class='Operator'>= </span><span class='String'>""</span><span class='Delimiter'>; 
</span><a name="LN79"></a><span class='Keyword'>static char </span><span class='Declare_Var'>format</span> <span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* p(lain)/t(ar) */ 
</span><a name="LN80"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>label</span> <span class='Operator'>= </span><span class='String'>"pg_basebackup base backup"</span><span class='Delimiter'>; 
</span><a name="LN81"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>noclean</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN82"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>showprogress</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN83"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>verbose</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN84"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>compresslevel</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN85"></a><span class='Keyword'>static </span><a href="pg_basebackup.c.html#LN68"><span class='Ref_to_Typedef'>IncludeWal</span></a> <span class='Declare_Var'>includewal</span> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a><span class='Delimiter'>; 
</span><a name="LN86"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>fastcheckpoint</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN87"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>writerecoveryconf</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN88"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>do_sync</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN89"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>standby_message_timeout</span> <span class='Operator'>= </span><span class='Number'>10</span> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* 10 sec = default */ 
</span><a name="LN90"></a><span class='Keyword'>static </span><a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a> <span class='Declare_Var'>last_progress_report</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN91"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> <span class='Declare_Var'>maxrate</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* no limit by default */ 
</span><a name="LN92"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>replication_slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN93"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>temp_replication_slot</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
<a name="LN95"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>success</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN96"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>made_new_pgdata</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN97"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>found_existing_pgdata</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN98"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>made_new_xlogdir</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN99"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>found_existing_xlogdir</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN100"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>made_tablespace_dirs</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN101"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>found_tablespace_dirs</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Progress counters */ 
</span><a name="LN104"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Var'>totalsize</span><span class='Delimiter'>; 
</span><a name="LN105"></a><span class='Keyword'>static </span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a> <span class='Declare_Var'>totaldone</span><span class='Delimiter'>; 
</span><a name="LN106"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>tablespacecount</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Pipe to communicate with background wal receiver process */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN110"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>bgpipe</span><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='Delimiter'>{</span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>-</span><span class='Number'>1</span><span class='Delimiter'>}; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* Handle to child process */ 
</span><a name="LN114"></a><span class='Keyword'>static </span><a href="../../include/port/win32.h.html#LN255"><span class='Ref_to_Typedef'>pid_t</span></a> <span class='Declare_Var'>bgchild</span> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span><a name="LN115"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>in_log_streamer</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* End position for xlog streaming, empty string if unknown yet */ 
</span><a name="LN118"></a><span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Var'>xlogendptr</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN121"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>has_xlogendptr</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN123"></a><span class='Keyword'>static volatile LONG </span><span class='Declare_Var'>has_xlogendptr</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* Contents of recovery.conf to be generated */ 
</span><a name="LN127"></a><span class='Keyword'>static </span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN50"><span class='Ref_to_Typedef'>PQExpBuffer</span></a> <span class='Declare_Var'>recoveryconfcontents</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
<span class='Comment_Multi_Line'>/* Function headers */ 
</span><a name="LN130"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN131"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>disconnect_and_exit</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN132"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>verify_dir_is_empty_or_create</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>created</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>found</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN133"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>progress_report</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>tablespacenum</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN135"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReceiveTarFile</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rownum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN136"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>ReceiveAndUnpackTarFile</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rownum</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN137"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>GenerateRecoveryConf</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN138"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>WriteRecoveryConf</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN139"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>BaseBackup</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN141"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>reached_end_position</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>segendpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>timeline</span><span class='Delimiter'>, 
</span><a name="LN142"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>segment_finished</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN144"></a><span class='Keyword'>static const char </span><span class='Operator'>*</span><span class='Declare_Prototype'>get_tablespace_mapping</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN145"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>tablespace_list_append</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
 
<span class='Keyword'>static void 
</span><a name="LN149"></a><span class='Declare_Function'>cleanup_directories_atexit</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN95"><span class='Ref_to_Global_Var'>success</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN115"><span class='Ref_to_Global_Var'>in_log_streamer</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN81"><span class='Ref_to_Global_Var'>noclean</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN96"><span class='Ref_to_Global_Var'>made_new_pgdata</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: removing data directory \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: failed to remove data directory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>found_existing_pgdata</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: removing contents of data directory \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: failed to remove contents of data directory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN98"><span class='Ref_to_Global_Var'>made_new_xlogdir</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: removing WAL directory \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>))</span> 
                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: failed to remove WAL directory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN99"><span class='Ref_to_Global_Var'>found_existing_xlogdir</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: removing contents of WAL directory \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../common/rmtree.c.html#LN34"><span class='Ref_to_Func'>rmtree</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>))</span> 
                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: failed to remove contents of WAL directory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !noclean &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN96"><span class='Ref_to_Global_Var'>made_new_pgdata</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>found_existing_pgdata</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>              _<span class='Parentheses'>(</span><span class='String'>"%s: data directory \"%s\" not removed at user's request\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN98"><span class='Ref_to_Global_Var'>made_new_xlogdir</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN99"><span class='Ref_to_Global_Var'>found_existing_xlogdir</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>               _<span class='Parentheses'>(</span><span class='String'>"%s: WAL directory \"%s\" not removed at user's request\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN100"><span class='Ref_to_Global_Var'>made_tablespace_dirs</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN101"><span class='Ref_to_Global_Var'>found_tablespace_dirs</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>             _<span class='Parentheses'>(</span><span class='String'>"%s: changes to tablespace directories will not be undone\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end cleanup_directories_atexit &raquo; </span> 
 
<span class='Keyword'>static void 
</span><a name="LN212"></a><span class='Declare_Function'>disconnect_and_exit</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>code</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
    <span class='Comment_Multi_Line'>/* 
     * On windows, our background thread dies along with the process. But on 
     * Unix, if we have started a subprocess, we want to kill it off so it 
     * doesn't remain running trying to stream data. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="../../include/port.h.html#LN210"><span class='Ref_to_Macro'>kill</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a><span class='Delimiter'>, </span>SIGTERM<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN212"><span class='Ref_to_Parameter'>code</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Split argument into old_dir and new_dir and append to tablespace mapping 
 * list. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN237"></a><span class='Declare_Function'>tablespace_list_append</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>arg</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN239"></a>    <a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cell</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Parentheses'>) </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><a name="LN240"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dst</span><span class='Delimiter'>; 
</span><a name="LN241"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>dst_ptr</span><span class='Delimiter'>; 
</span><a name="LN242"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>arg_ptr</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN241"><span class='Ref_To_Local'>dst_ptr</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN240"><span class='Ref_To_Local'>dst</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN237"><span class='Ref_to_Parameter'>arg</span></a><span class='Delimiter'>; </span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN241"><span class='Ref_To_Local'>dst_ptr</span></a> <span class='Operator'>- </span><a href="pg_basebackup.c.html#LN240"><span class='Ref_To_Local'>dst</span></a> <span class='Operator'>&GT;= </span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: directory name too long\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>== </span><span class='String'>'\\'</span> <span class='Operator'>&& *</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>+ </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='String'>'='</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>;</span>                   <span class='Comment_Single_Line'>/* skip backslash escaping = */ 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>== </span><span class='String'>'='</span> <span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN237"><span class='Ref_to_Parameter'>arg</span></a> <span class='Operator'>|| *</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a> <span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='String'>'\\'</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: multiple \"=\" signs in tablespace mapping\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
                <a href="pg_basebackup.c.html#LN240"><span class='Ref_To_Local'>dst</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN241"><span class='Ref_To_Local'>dst_ptr</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Operator'>*</span><a href="pg_basebackup.c.html#LN241"><span class='Ref_To_Local'>dst_ptr</span></a><span class='Operator'>++ = *</span><a href="pg_basebackup.c.html#LN242"><span class='Ref_To_Local'>arg_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for arg_ptr=arg;*arg_ptr;... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!*</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a> <span class='Operator'>|| !*</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: invalid tablespace mapping format \"%s\", must be \"OLDDIR=NEWDIR\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN237"><span class='Ref_to_Parameter'>arg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * This check isn't absolutely necessary.  But all tablespaces are created 
     * with absolute directories, so specifying a non-absolute path here would 
     * just never match, possibly confusing users.  It's also good to be 
     * consistent with the new_dir check. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: old directory is not an absolute path in tablespace mapping: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: new directory is not an absolute path in tablespace mapping: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN77"><span class='Ref_to_Global_Var'>tablespace_dirs</span></a><span class='Operator'>.</span><a href="pg_basebackup.c.html#LN51"><span class='Ref_to_Member'>tail</span></a><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN77"><span class='Ref_to_Global_Var'>tablespace_dirs</span></a><span class='Operator'>.</span><a href="pg_basebackup.c.html#LN51"><span class='Ref_to_Member'>tail</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN43"><span class='Ref_to_Member'>next</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_basebackup.c.html#LN77"><span class='Ref_to_Global_Var'>tablespace_dirs</span></a><span class='Operator'>.</span><a href="pg_basebackup.c.html#LN50"><span class='Ref_to_Member'>head</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN77"><span class='Ref_to_Global_Var'>tablespace_dirs</span></a><span class='Operator'>.</span><a href="pg_basebackup.c.html#LN51"><span class='Ref_to_Member'>tail</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN239"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end tablespace_list_append &raquo; </span> 
 
 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN310"></a><span class='Declare_Function'>get_gz_error</span><span class='Parentheses'>(</span>gzFile <span class='Declare_Parameter'>gzf</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN312"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>errnum</span><span class='Delimiter'>; 
</span><a name="LN313"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>errmsg</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN313"><span class='Ref_To_Local'>errmsg</span></a> <span class='Operator'>= </span>gzerror<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN310"><span class='Ref_to_Parameter'>gzf</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN312"><span class='Ref_To_Local'>errnum</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN312"><span class='Ref_To_Local'>errnum</span></a> <span class='Operator'>== </span>Z_ERRNO<span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="pg_basebackup.c.html#LN313"><span class='Ref_To_Local'>errmsg</span></a><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Keyword'>static void 
</span><a name="LN324"></a><span class='Declare_Function'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"%s takes a base backup of a running PostgreSQL server.\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Usage:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  %s [OPTION]...\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nOptions controlling the output:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -D, --pgdata=DIRECTORY receive base backup into directory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -F, --format=p|t       output format (plain (default), tar)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -r, --max-rate=RATE    maximum transfer rate to transfer data directory\n"</span> 
      <span class='String'>"                         (in kB/s, or use suffix \"k\" or \"M\")\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -R, --write-recovery-conf\n"</span> 
          <span class='String'>"                         write recovery.conf for replication\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -S, --slot=SLOTNAME    replication slot to use\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --no-slot          prevent creation of temporary replication slot\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -T, --tablespace-mapping=OLDDIR=NEWDIR\n"</span> 
      <span class='String'>"                         relocate tablespace in OLDDIR to NEWDIR\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -X, --wal-method=none|fetch|stream\n"</span> 
             <span class='String'>"                         include required WAL files with specified method\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --waldir=WALDIR    location for the write-ahead log directory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -z, --gzip             compress tar output\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -Z, --compress=0-9     compress tar output with given compression level\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nGeneral options:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -c, --checkpoint=fast|spread\n"</span> 
             <span class='String'>"                         set fast or spread checkpointing\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -l, --label=LABEL      set backup label\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -n, --no-clean         do not clean up after errors\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -N, --no-sync          do not wait for changes to be written safely to disk\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -P, --progress         show progress information\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -v, --verbose          output verbose messages\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -V, --version          output version information, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -?, --help             show this help, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nConnection options:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -d, --dbname=CONNSTR   connection string\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -h, --host=HOSTNAME    database server host or socket directory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -p, --port=PORT        database server port number\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -s, --status-interval=INTERVAL\n"</span> 
             <span class='String'>"                         time between status packets sent to server (in seconds)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -U, --username=NAME    connect as specified database user\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -w, --no-password      never prompt for password\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -W, --password         force password prompt (should happen automatically)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nReport bugs to &LT;pgsql-bugs@postgresql.org&GT;.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end usage &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Called in the background process every time data is received. 
 * On Unix, we check to see if there is any data on our pipe 
 * (which would mean we have a stop position), and if it is, check if 
 * it is time to stop. 
 * On Windows, we are in a single process, so we can just check if it's 
 * time to stop. 
 */ 
</span><span class='Keyword'>static bool 
</span><a name="LN378"></a><span class='Declare_Function'>reached_end_position</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>segendpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>timeline</span><span class='Delimiter'>, 
</span><a name="LN379"></a>                     <span class='Keyword'>bool </span><span class='Declare_Parameter'>segment_finished</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN121"><span class='Ref_to_Global_Var'>has_xlogendptr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN384"></a>        fd_set      <span class='Declare_Local'>fds</span><span class='Delimiter'>; 
</span><a name="LN385"></a>        <span class='Control'>struct</span> timeval <span class='Declare_Local'>tv</span><span class='Delimiter'>; 
</span><a name="LN386"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Don't have the end pointer yet - check our pipe to see if it has 
         * been sent yet. 
         */ 
</span>        FD_ZERO<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN384"><span class='Ref_To_Local'>fds</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        FD_SET<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN384"><span class='Ref_To_Local'>fds</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN385"><span class='Ref_To_Local'>tv</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN385"><span class='Ref_To_Local'>tv</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <a href="pg_basebackup.c.html#LN386"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../include/port/win32.h.html#LN373"><span class='Ref_to_Macro'>select</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>+ </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN384"><span class='Ref_To_Local'>fds</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN385"><span class='Ref_To_Local'>tv</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN386"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN400"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>xlogend</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN401"></a>            <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hi</span><span class='Delimiter'>, 
</span><a name="LN402"></a>                        <span class='Declare_Local'>lo</span><span class='Delimiter'>; 
</span> 
            <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN386"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN386"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read from ready pipe: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><span class='String'>"%X/%X"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN401"><span class='Ref_To_Local'>hi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN402"><span class='Ref_To_Local'>lo</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                  _<span class='Parentheses'>(</span><span class='String'>"%s: could not parse write-ahead log location \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN400"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pg_basebackup.c.html#LN118"><span class='Ref_to_Global_Var'>xlogendptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN401"><span class='Ref_To_Local'>hi</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span> <span class='Operator'>| </span><a href="pg_basebackup.c.html#LN402"><span class='Ref_To_Local'>lo</span></a><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN121"><span class='Ref_to_Global_Var'>has_xlogendptr</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Fall through to check if we've reached the point further 
             * already. 
             */ 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r==1 &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * No data received on the pipe means we don't know the end 
             * position yet - so just say it's not time to stop yet. 
             */ 
</span>            <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * On win32, has_xlogendptr is set by the main thread, so if it's not 
         * set here, we just go back and wait until it shows up. 
         */ 
</span>        <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !has_xlogendptr &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * At this point we have an end pointer, so compare it to the current 
     * position to figure out if it's time to stop. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN378"><span class='Ref_to_Parameter'>segendpos</span></a> <span class='Operator'>&GT;= </span><a href="pg_basebackup.c.html#LN118"><span class='Ref_to_Global_Var'>xlogendptr</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Have end pointer, but haven't reached it yet - so tell the caller to 
     * keep streaming. 
     */ 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end reached_end_position &raquo; </span> 
 
<span class='Control'>typedef</span> <span class='Control'>struct</span> 
<span class='Delimiter'>{ 
</span><a name="LN462"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a>     <span class='Operator'>*</span><span class='Declare_Member'>bgconn</span><span class='Delimiter'>; 
</span><a name="LN463"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Member'>startptr</span><span class='Delimiter'>; 
</span><a name="LN464"></a>    <span class='Keyword'>char</span>        <span class='Declare_Member'>xlog</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>];</span>    <span class='Comment_Single_Line'>/* directory or tarfile depending on mode */ 
</span><a name="LN465"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Member'>sysidentifier</span><span class='Delimiter'>; 
</span><a name="LN466"></a>    <span class='Keyword'>int</span>         <span class='Declare_Member'>timeline</span><span class='Delimiter'>; 
</span><a name="LN467"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Member'>temp_slot</span><span class='Delimiter'>; 
</span><a name="LN468"></a>} <span class='Declare_Typedef'>logstreamer_param</span><span class='Delimiter'>; 
</span> 
<span class='Keyword'>static int 
</span><a name="LN471"></a><span class='Declare_Function'>LogStreamerMain</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN460"><span class='Ref_to_Typedef'>logstreamer_param</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>param</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN473"></a>    <a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a>   <span class='Declare_Local'>stream</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN115"><span class='Ref_to_Global_Var'>in_log_streamer</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN463"><span class='Ref_to_Member'>startptr</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN466"><span class='Ref_to_Member'>timeline</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN33"><span class='Ref_to_Member'>sysidentifier</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN465"><span class='Ref_to_Member'>sysidentifier</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN141"><span class='Ref_to_Proto'>reached_end_position</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN44"><span class='Ref_to_Member'>stop_socket</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span><span class='Directive'>#else</span> 
    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN44"><span class='Ref_to_Member'>stop_socket</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN35"><span class='Ref_to_Member'>standby_message_timeout</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN37"><span class='Ref_to_Member'>synchronous</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN39"><span class='Ref_to_Member'>do_sync</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN38"><span class='Ref_to_Member'>mark_done</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN50"><span class='Ref_to_Member'>temp_slot</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN467"><span class='Ref_to_Member'>temp_slot</span></a><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN50"><span class='Ref_to_Member'>temp_slot</span></a> <span class='Operator'>&& !</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"pg_basebackup_%d"</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN325"><span class='Ref_to_Proto'>PQbackendPID</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN462"><span class='Ref_to_Member'>bgconn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a> <span class='Operator'>= </span><a href="walmethods.h.html#LN87"><span class='Ref_to_Proto'>CreateWalDirectoryMethod</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN464"><span class='Ref_to_Member'>xlog</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a> <span class='Operator'>= </span><a href="walmethods.h.html#LN89"><span class='Ref_to_Proto'>CreateWalTarMethod</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN464"><span class='Ref_to_Member'>xlog</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.h.html#LN56"><span class='Ref_to_Proto'>ReceiveXlogStream</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN462"><span class='Ref_to_Member'>bgconn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Parentheses'>))</span> 
 
        <span class='Comment_Multi_Line'>/* 
         * Any errors will already have been reported in the function process, 
         * but we need to tell the parent that we didn't shutdown in a nice 
         * way. 
         */ 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN74"><span class='Ref_to_Member'>finish</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not finish writing WAL files: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Number'>1</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN471"><span class='Ref_to_Parameter'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN462"><span class='Ref_to_Member'>bgconn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <a href="walmethods.h.html#LN92"><span class='Ref_to_Proto'>FreeWalDirectoryMethod</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="walmethods.h.html#LN93"><span class='Ref_to_Proto'>FreeWalTarMethod</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN473"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end LogStreamerMain &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Initiate background process for receiving xlog during the backup. 
 * The background stream will use its own database connection so we can 
 * stream the logfile in parallel with the backups. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN536"></a><span class='Declare_Function'>StartLogStreamer</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>startpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>timeline</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>sysidentifier</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN538"></a>    <a href="pg_basebackup.c.html#LN460"><span class='Ref_to_Typedef'>logstreamer_param</span></a> <span class='Operator'>*</span><span class='Declare_Local'>param</span><span class='Delimiter'>; 
</span><a name="LN539"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hi</span><span class='Delimiter'>, 
</span><a name="LN540"></a>                <span class='Declare_Local'>lo</span><span class='Delimiter'>; 
</span><a name="LN541"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>statusdir</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span> 
    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN26"><span class='Ref_to_Proto'>pg_malloc0</span></a><span class='Parentheses'>(</span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN460"><span class='Ref_to_Typedef'>logstreamer_param</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN466"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN536"><span class='Ref_to_Parameter'>timeline</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN465"><span class='Ref_to_Member'>sysidentifier</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN536"><span class='Ref_to_Parameter'>sysidentifier</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Convert the starting position */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN536"><span class='Ref_to_Parameter'>startpos</span></a><span class='Delimiter'>, </span><span class='String'>"%X/%X"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN539"><span class='Ref_To_Local'>hi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN540"><span class='Ref_To_Local'>lo</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not parse write-ahead log location \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN536"><span class='Ref_to_Parameter'>startpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN463"><span class='Ref_to_Member'>startptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN539"><span class='Ref_To_Local'>hi</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span> <span class='Operator'>| </span><a href="pg_basebackup.c.html#LN540"><span class='Ref_To_Local'>lo</span></a><span class='Delimiter'>; 
</span>    <span class='Comment_Multi_Line'>/* Round off to even segment position */ 
</span>    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN463"><span class='Ref_to_Member'>startptr</span></a> <span class='Operator'>-= </span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN463"><span class='Ref_to_Member'>startptr</span></a> <span class='Operator'>% </span>XLOG_SEG_SIZE<span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <span class='Comment_Multi_Line'>/* Create our background pipe */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>pipe<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not create pipe for background process: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* Get a second connection */ 
</span>    <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN462"><span class='Ref_to_Member'>bgconn</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN30"><span class='Ref_to_Proto'>GetConnection</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN462"><span class='Ref_to_Member'>bgconn</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* Error message already written in GetConnection() */ 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* In post-10 cluster, pg_xlog has been renamed to pg_wal */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN464"><span class='Ref_to_Member'>xlog</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN464"><span class='Ref_to_Member'>xlog</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, 
</span>             <a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, 
</span>             <a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../common/file_utils.c.html#LN34"><span class='Ref_to_Const'>MINIMUM_VERSION_FOR_PG_WAL</span></a> <span class='Operator'>? 
</span>             <span class='String'>"pg_xlog"</span> <span class='Operator'>: </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* Temporary replication slots are only supported in 10 and newer */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="pg_basebackup.c.html#LN63"><span class='Ref_to_Const'>MINIMUM_VERSION_FOR_TEMP_SLOTS</span></a><span class='Parentheses'>)</span> 
        <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN467"><span class='Ref_to_Member'>temp_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN467"><span class='Ref_to_Member'>temp_slot</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN93"><span class='Ref_to_Global_Var'>temp_replication_slot</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Create pg_wal/archive_status or pg_xlog/archive_status (and thus 
         * pg_wal or pg_xlog) depending on the target server so we can write 
         * to basedir/pg_wal or basedir/pg_xlog as the directory entry in the 
         * tar file may arrive later. 
         */ 
</span>        <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN541"><span class='Ref_To_Local'>statusdir</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN541"><span class='Ref_To_Local'>statusdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s/archive_status"</span><span class='Delimiter'>, 
</span>                 <a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, 
</span>                 <a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../common/file_utils.c.html#LN34"><span class='Ref_to_Const'>MINIMUM_VERSION_FOR_PG_WAL</span></a> <span class='Operator'>? 
</span>                 <span class='String'>"pg_xlog"</span> <span class='Operator'>: </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgmkdirp.c.html#LN55"><span class='Ref_to_Func'>pg_mkdir_p</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN541"><span class='Ref_To_Local'>statusdir</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span>errno <span class='Operator'>!= </span>EEXIST<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not create directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN541"><span class='Ref_To_Local'>statusdir</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if format=='p' &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Start a child process and tell it to start streaming. On Unix, this is 
     * a fork(). On Windows, we create a thread. 
     */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>= </span>fork<span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* in child process */ 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN470"><span class='Ref_to_Func'>LogStreamerMain</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create background process: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Else we are in the parent process and all is well. 
     */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span>    <a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>= </span>_beginthreadex<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>void </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN470"><span class='Ref_to_Func'>LogStreamerMain</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN538"><span class='Ref_To_Local'>param</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create background thread: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end StartLogStreamer &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Verify that the given directory exists and is empty. If it does not 
 * exist, it is created. If it exists but is not empty, an error will 
 * be given and the process ended. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN648"></a><span class='Declare_Function'>verify_dir_is_empty_or_create</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dirname</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>created</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Operator'>*</span><span class='Declare_Parameter'>found</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="../../port/pgcheckdir.c.html#LN29"><span class='Ref_to_Func'>pg_check_dir</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>case</span> <span class='Number'>0</span><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Does not exist, so create 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgmkdirp.c.html#LN55"><span class='Ref_to_Func'>pg_mkdir_p</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>dirname</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: could not create directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>dirname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>created</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>created</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>1</span><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Exists, empty 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>found</span></a><span class='Parentheses'>) 
</span>                <span class='Operator'>*</span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>found</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <span class='Control'>return</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Number'>2</span><span class='Operator'>: 
</span>        <span class='Control'>case</span> <span class='Number'>3</span><span class='Operator'>: 
</span>        <span class='Control'>case</span> <span class='Number'>4</span><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Exists, not empty 
             */ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: directory \"%s\" exists but is not empty\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>dirname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>case</span> <span class='Operator'>-</span><span class='Number'>1</span><span class='Operator'>: 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * Access problem 
             */ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not access directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN648"><span class='Ref_to_Parameter'>dirname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch pg_check_dir(dirname) &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end verify_dir_is_empty_or_create &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Print a progress report based on the global variables. If verbose output 
 * is enabled, also print the current file name. 
 * 
 * Progress report is written at maximum once per second, unless the 
 * force parameter is set to true. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN706"></a><span class='Declare_Function'>progress_report</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>tablespacenum</span><span class='Delimiter'>, </span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>filename</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>force</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN708"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>percent</span><span class='Delimiter'>; 
</span><a name="LN709"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>totaldone_str</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN710"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>totalsize_str</span><span class='Delimiter'>[</span><span class='Number'>32</span><span class='Delimiter'>]; 
</span><a name="LN711"></a>    <a href="../../include/pgtime.h.html#LN22"><span class='Ref_to_Typedef'>pg_time_t</span></a>   <span class='Declare_Local'>now</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../pg_rewind/pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN711"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>= </span>time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN711"><span class='Ref_To_Local'>now</span></a> <span class='Operator'>== </span><a href="../pg_rewind/logging.c.html#LN23"><span class='Ref_to_Global_Var'>last_progress_report</span></a> <span class='Operator'>&& !</span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>force</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>return</span><span class='Delimiter'>;</span>                 <span class='Comment_Single_Line'>/* Max once per second */ 
</span> 
    <a href="../pg_rewind/logging.c.html#LN23"><span class='Ref_to_Global_Var'>last_progress_report</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN711"><span class='Ref_To_Local'>now</span></a><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN708"><span class='Ref_To_Local'>percent</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a> <span class='Operator'>? </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) ((</span><a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>100</span> <span class='Operator'>/ </span><a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a><span class='Parentheses'>)</span> <span class='Operator'>: </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Avoid overflowing past 100% or the full size. This may make the total 
     * size number change as we approach the end of the backup (the estimate 
     * will always be wrong if WAL is included), but that's better than having 
     * the done column be bigger than the total. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN708"><span class='Ref_To_Local'>percent</span></a> <span class='Operator'>&GT; </span><span class='Number'>100</span><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN708"><span class='Ref_To_Local'>percent</span></a> <span class='Operator'>= </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>/ </span><span class='Number'>1024</span> <span class='Operator'>&GT; </span><a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Separate step to keep platform-dependent format code out of 
     * translatable strings.  And we only test for INT64_FORMAT availability 
     * in snprintf, not fprintf. 
     */ 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN709"><span class='Ref_To_Local'>totaldone_str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN709"><span class='Ref_To_Local'>totaldone_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, 
</span>             <a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>/ </span><span class='Number'>1024</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN314"><span class='Ref_to_Const'>INT64_FORMAT</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN743"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>VERBOSE_FILENAME_LENGTH</span> <span class='Number'>35</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>) 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No filename given, so clear the status line (used for last 
             * call) 
             */ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    <a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%*s/%s kB (100%%), %d/%d tablespace %*s"</span><span class='Delimiter'>, 
</span>                             <span class='String'>"%*s/%s kB (100%%), %d/%d tablespaces %*s"</span><span class='Delimiter'>, 
</span>                             <a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="pg_basebackup.c.html#LN709"><span class='Ref_To_Local'>totaldone_str</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Delimiter'>, 
</span>                    <a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>tablespacenum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Delimiter'>, 
</span>                    <a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a> <span class='Operator'>+ </span><span class='Number'>5</span><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><a name="LN762"></a>            <span class='Keyword'>bool</span>        <span class='Declare_Local'>truncate</span> <span class='Operator'>= </span><span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    <a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%*s/%s kB (%d%%), %d/%d tablespace (%s%-*.*s)"</span><span class='Delimiter'>, 
</span>                             <span class='String'>"%*s/%s kB (%d%%), %d/%d tablespaces (%s%-*.*s)"</span><span class='Delimiter'>, 
</span>                             <a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="pg_basebackup.c.html#LN709"><span class='Ref_To_Local'>totaldone_str</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN708"><span class='Ref_To_Local'>percent</span></a><span class='Delimiter'>, 
</span>                    <a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>tablespacenum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* Prefix with "..." if we do leading truncation */ 
</span>                    <a href="pg_basebackup.c.html#LN762"><span class='Ref_To_Local'>truncate</span></a> <span class='Operator'>? </span><span class='String'>"..."</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>            <a href="pg_basebackup.c.html#LN762"><span class='Ref_To_Local'>truncate</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a> <span class='Operator'>- </span><span class='Number'>3</span> <span class='Operator'>: </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a><span class='Delimiter'>, 
</span>            <a href="pg_basebackup.c.html#LN762"><span class='Ref_To_Local'>truncate</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a> <span class='Operator'>- </span><span class='Number'>3</span> <span class='Operator'>: </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a><span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* Truncate filename at beginning if it's too long */ 
</span>                    <a href="pg_basebackup.c.html#LN762"><span class='Ref_To_Local'>truncate</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>filename</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><a href="pg_basebackup.c.html#LN743"><span class='Ref_to_Const'>VERBOSE_FILENAME_LENGTH</span></a> <span class='Operator'>+ </span><span class='Number'>3</span> <span class='Operator'>: </span><a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if verbose &raquo; </span> 
    <span class='Control'>else</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                <a href="../../include/c.h.html#LN126"><span class='Ref_to_Macro'>ngettext</span></a><span class='Parentheses'>(</span><span class='String'>"%*s/%s kB (%d%%), %d/%d tablespace"</span><span class='Delimiter'>, 
</span>                         <span class='String'>"%*s/%s kB (%d%%), %d/%d tablespaces"</span><span class='Delimiter'>, 
</span>                         <a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="pg_basebackup.c.html#LN709"><span class='Ref_To_Local'>totaldone_str</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN710"><span class='Ref_To_Local'>totalsize_str</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN708"><span class='Ref_To_Local'>percent</span></a><span class='Delimiter'>, 
</span>                <a href="pg_basebackup.c.html#LN706"><span class='Ref_to_Parameter'>tablespacenum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\r"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end progress_report &raquo; </span> 
 
<span class='Keyword'>static </span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a> 
<a name="LN792"></a><span class='Declare_Function'>parse_max_rate</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN794"></a>    <span class='Keyword'>double</span>      <span class='Declare_Local'>result</span><span class='Delimiter'>; 
</span><a name="LN795"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>after_num</span><span class='Delimiter'>; 
</span><a name="LN796"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>suffix</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>= </span>strtod<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: transfer rate \"%s\" is not a valid value\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: invalid transfer rate \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Reject obviously wrong values here. 
         */ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: transfer rate must be greater than zero\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Evaluate suffix, after skipping over possible whitespace. Lack of 
     * suffix means kilobytes. 
     */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>&& </span>isspace<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Parentheses'>))</span> 
        <a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_basebackup.c.html#LN796"><span class='Ref_To_Local'>suffix</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>== </span><span class='String'>'k'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* kilobyte is the expected unit. */ 
</span>            <a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>== </span><span class='String'>'M'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>*= </span><span class='Number'>1024</span><span class='Operator'>.</span><span class='Number'>0</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* The rest can only consist of white space. */ 
</span>    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span> <span class='Operator'>&& </span>isspace<span class='Parentheses'>((</span><span class='Keyword'>unsigned char</span><span class='Parentheses'>) </span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Parentheses'>))</span> 
        <a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>*</span><a href="pg_basebackup.c.html#LN795"><span class='Ref_To_Local'>after_num</span></a> <span class='Operator'>!= </span><span class='String'>'\0'</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: invalid --max-rate unit: \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN796"><span class='Ref_To_Local'>suffix</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Valid integer? */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>)</span> <a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>!= </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>)</span> <span class='Parentheses'>((</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: transfer rate \"%s\" exceeds integer range\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * The range is checked on the server side too, but avoid the server 
     * connection if a nonsensical value was passed. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&LT; </span><a href="../../include/replication/basebackup.h.html#LN19"><span class='Ref_to_Const'>MAX_RATE_LOWER</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a> <span class='Operator'>&GT; </span><a href="../../include/replication/basebackup.h.html#LN20"><span class='Ref_to_Const'>MAX_RATE_UPPER</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: transfer rate \"%s\" is out of range\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN792"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN255"><span class='Ref_to_Typedef'>int32</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN794"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end parse_max_rate &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Write a piece of tar data 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN887"></a><span class='Declare_Function'>writeTarData</span><span class='Parentheses'>( 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN889"></a>             gzFile <span class='Declare_Parameter'>ztarfile</span><span class='Delimiter'>, 
</span><span class='Directive'>#endif</span> 
<a name="LN891"></a>             FILE <span class='Operator'>*</span><span class='Declare_Parameter'>tarfile</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>r</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>current_file</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN889"><span class='Ref_to_Parameter'>ztarfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>gzwrite<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN889"><span class='Ref_to_Parameter'>ztarfile</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>r</span></a><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not write to compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>current_file</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN889"><span class='Ref_to_Parameter'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>fwrite<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>r</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>tarfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not write to file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN891"><span class='Ref_to_Parameter'>current_file</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
}</span><span class='Auto_Annotations'> &laquo; end writeTarData &raquo; </span> 
 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN917"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>WRITE_TAR_DATA</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>sz</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN886"><span class='Ref_to_Func'>writeTarData</span></a><span class='Parentheses'>(</span>ztarfile<span class='Delimiter'>, </span>tarfile<span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Parameter'>sz</span></a><span class='Delimiter'>, </span><a href="../pg_test_fsync/pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#else</span> 
<a name="LN919"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>WRITE_TAR_DATA</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>buf</span><span class='Delimiter'>, </span><span class='Declare_Parameter'>sz</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN886"><span class='Ref_to_Func'>writeTarData</span></a><span class='Parentheses'>(</span>tarfile<span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN919"><span class='Ref_to_Parameter'>buf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN919"><span class='Ref_to_Parameter'>sz</span></a><span class='Delimiter'>, </span><a href="../pg_test_fsync/pg_test_fsync.c.html#LN67"><span class='Ref_to_Global_Var'>filename</span></a><span class='Parentheses'>) 
</span><span class='Directive'>#endif</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Receive a tar format file from the connection to the server, and write 
 * the data from this file directly into a tar file. If compression is 
 * enabled, the data will be compressed while written to the file. 
 * 
 * The file will be named base.tar[.gz] if it's for the main data directory 
 * or &LT;tablespaceoid&GT;.tar[.gz] if it's for another tablespace. 
 * 
 * No attempt to inspect or validate the contents of the file is done. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN933"></a><span class='Declare_Function'>ReceiveTarFile</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rownum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN935"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>filename</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN936"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>copybuf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN937"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>tarfile</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN938"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>tarhdr</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span><a name="LN939"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>basetablespace</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN940"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>in_tarhdr</span> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span><a name="LN941"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>skip_file</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN942"></a>    size_t      <span class='Declare_Local'>tarhdrsz</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN943"></a>    <a href="../../include/port/win32.h.html#LN230"><span class='Ref_to_Const'>pgoff_t</span></a>     <span class='Declare_Local'>filesz</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
<a name="LN946"></a>    gzFile      <span class='Declare_Local'>ztarfile</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN939"><span class='Ref_To_Local'>basetablespace</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Base tablespaces 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a> <span class='Operator'>= </span>gzdopen<span class='Parentheses'>(</span>dup<span class='Parentheses'>(</span>fileno<span class='Parentheses'>(</span>stdout<span class='Parentheses'>))</span><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>gzsetparams<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, 
</span>                                Z_DEFAULT_STRATEGY<span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: could not set compression level %d: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
                <a href="pg_basebackup.c.html#LN937"><span class='Ref_To_Local'>tarfile</span></a> <span class='Operator'>= </span>stdout<span class='Delimiter'>; 
</span>            <a href="../../../contrib/cube/cubeparse.y.html#LN150"><span class='Ref_to_Proto'>strcpy</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(basedir,"-")==... &raquo; </span> 
        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/base.tar.gz"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a> <span class='Operator'>= </span>gzopen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>gzsetparams<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, 
</span>                                Z_DEFAULT_STRATEGY<span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: could not set compression level %d: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/base.tar"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN937"><span class='Ref_To_Local'>tarfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if basetablespace &raquo; </span> 
    <span class='Control'>else</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Specific tablespace 
         */ 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s.tar.gz"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, 
</span>                     <a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a> <span class='Operator'>= </span>gzopen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>gzsetparams<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, 
</span>                            Z_DEFAULT_STRATEGY<span class='Parentheses'>) </span><span class='Operator'>!= </span>Z_OK<span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: could not set compression level %d: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s.tar"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, 
</span>                     <a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN937"><span class='Ref_To_Local'>tarfile</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* Compression is in use */ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not create compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Either no zlib support, or zlib support but compresslevel = 0 */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN937"><span class='Ref_To_Local'>tarfile</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the COPY data stream 
     */ 
</span>    <a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN90"><span class='Ref_to_EnumConst'>PGRES_COPY_OUT</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not get COPY data stream: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1064"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * End of chunk. If requested, and this is the base tablespace, 
             * write recovery.conf into the tarfile. When done, close the file 
             * (but not stdout). 
             * 
             * Also, write two completely empty blocks at the end of the tar 
             * file, as required by some tar programs. 
             */ 
</span><a name="LN1083"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>zerobuf</span><span class='Delimiter'>[</span><span class='Number'>1024</span><span class='Delimiter'>]; 
</span> 
            <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1083"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1083"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN939"><span class='Ref_To_Local'>basetablespace</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN87"><span class='Ref_to_Global_Var'>writerecoveryconf</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span><a name="LN1089"></a>                <span class='Keyword'>char</span>        <span class='Declare_Local'>header</span><span class='Delimiter'>[</span><span class='Number'>512</span><span class='Delimiter'>]; 
</span><a name="LN1090"></a>                <span class='Keyword'>int</span>         <span class='Declare_Local'>padding</span><span class='Delimiter'>; 
</span> 
                <a href="../../include/pgtar.h.html#LN21"><span class='Ref_to_Proto'>tarCreateHeader</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1089"><span class='Ref_To_Local'>header</span></a><span class='Delimiter'>, </span><span class='String'>"recovery.conf"</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, 
</span>                                <a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, 
</span>                                <span class='Number'>0600</span><span class='Delimiter'>, </span><span class='Number'>04000</span><span class='Delimiter'>, </span><span class='Number'>02000</span><span class='Delimiter'>, 
</span>                                time<span class='Parentheses'>(</span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
                <a href="pg_basebackup.c.html#LN1090"><span class='Ref_To_Local'>padding</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>; 
</span> 
                <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1089"><span class='Ref_To_Local'>header</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1089"><span class='Ref_To_Local'>header</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1090"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>) 
</span>                    <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1083"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1090"><span class='Ref_To_Local'>padding</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Comment_Multi_Line'>/* 2 * 512 bytes empty data at end of file */ 
</span>            <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1083"><span class='Ref_To_Local'>zerobuf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1083"><span class='Ref_To_Local'>zerobuf</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_LIBZ 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>gzclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                       _<span class='Parentheses'>(</span><span class='String'>"%s: could not close compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN309"><span class='Ref_to_Func'>get_gz_error</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN946"><span class='Ref_To_Local'>ztarfile</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                    <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>else</span> 
<span class='Directive'>#endif</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span>fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN937"><span class='Ref_To_Local'>tarfile</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                                _<span class='Parentheses'>(</span><span class='String'>"%s: could not close file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>} 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if r==-1 &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read COPY data: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN87"><span class='Ref_to_Global_Var'>writerecoveryconf</span></a> <span class='Operator'>|| !</span><a href="pg_basebackup.c.html#LN939"><span class='Ref_To_Local'>basetablespace</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * When not writing recovery.conf, or when not working on the base 
             * tablespace, we never have to look for an existing recovery.conf 
             * file in the stream. 
             */ 
</span>            <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Look for a recovery.conf in the existing tar stream. If it's 
             * there, we must skip it so we can later overwrite it with our 
             * own version of the file. 
             * 
             * To do this, we have to process the individual files inside the 
             * TAR stream. The stream consists of a header and zero or more 
             * chunks, all 512 bytes long. The stream from the server is 
             * broken up into smaller pieces, so we have to track the size of 
             * the files to find the next header structure. 
             */ 
</span><a name="LN1165"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>rr</span> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span><a name="LN1166"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>pos</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>while</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN940"><span class='Ref_To_Local'>in_tarhdr</span></a><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We're currently reading a header structure inside the 
                     * TAR stream, i.e. the file metadata. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN942"><span class='Ref_To_Local'>tarhdrsz</span></a> <span class='Operator'>&LT; </span><span class='Number'>512</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * Copy the header structure into tarhdr in case the 
                         * header is not aligned to 512 bytes or it's not 
                         * returned in whole by the last PQgetCopyData call. 
                         */ 
</span><a name="LN1183"></a>                        <span class='Keyword'>int</span>         <span class='Declare_Local'>hdrleft</span><span class='Delimiter'>; 
</span><a name="LN1184"></a>                        <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes2copy</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN1183"><span class='Ref_To_Local'>hdrleft</span></a> <span class='Operator'>= </span><span class='Number'>512</span> <span class='Operator'>- </span><a href="pg_basebackup.c.html#LN942"><span class='Ref_To_Local'>tarhdrsz</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN1184"><span class='Ref_To_Local'>bytes2copy</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>&GT; </span><a href="pg_basebackup.c.html#LN1183"><span class='Ref_To_Local'>hdrleft</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN1183"><span class='Ref_To_Local'>hdrleft</span></a> <span class='Operator'>: </span><a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        memcpy<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN938"><span class='Ref_To_Local'>tarhdr</span></a><span class='Delimiter'>[</span><a href="pg_basebackup.c.html#LN942"><span class='Ref_To_Local'>tarhdrsz</span></a><span class='Delimiter'>], </span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>+ </span><a href="pg_basebackup.c.html#LN1166"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1184"><span class='Ref_To_Local'>bytes2copy</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>-= </span><a href="pg_basebackup.c.html#LN1184"><span class='Ref_To_Local'>bytes2copy</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN1166"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1184"><span class='Ref_To_Local'>bytes2copy</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN942"><span class='Ref_To_Local'>tarhdrsz</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1184"><span class='Ref_To_Local'>bytes2copy</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * We have the complete header structure in tarhdr, 
                         * look at the file metadata: - the subsequent file 
                         * contents have to be skipped if the filename is 
                         * recovery.conf - find out the size of the file 
                         * padded to the next multiple of 512 
                         */ 
</span><a name="LN1204"></a>                        <span class='Keyword'>int</span>         <span class='Declare_Local'>padding</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN941"><span class='Ref_To_Local'>skip_file</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN938"><span class='Ref_To_Local'>tarhdr</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><span class='String'>"recovery.conf"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>= </span><a href="../../include/pgtar.h.html#LN23"><span class='Ref_to_Proto'>read_tar_number</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN938"><span class='Ref_To_Local'>tarhdr</span></a><span class='Delimiter'>[</span><span class='Number'>124</span><span class='Delimiter'>], </span><span class='Number'>12</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN1204"><span class='Ref_To_Local'>padding</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1204"><span class='Ref_To_Local'>padding</span></a><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* Next part is the file, not the header */ 
</span>                        <a href="pg_basebackup.c.html#LN940"><span class='Ref_To_Local'>in_tarhdr</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
                        <span class='Comment_Multi_Line'>/* 
                         * If we're not skipping the file, write the tar 
                         * header unmodified. 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN941"><span class='Ref_To_Local'>skip_file</span></a><span class='Parentheses'>) 
</span>                            <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN938"><span class='Ref_To_Local'>tarhdr</span></a><span class='Delimiter'>, </span><span class='Number'>512</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if in_tarhdr &raquo; </span> 
                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * We're processing a file's contents. 
                     */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * We still have data to read (and possibly write). 
                         */ 
</span><a name="LN1234"></a>                        <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes2write</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN1234"><span class='Ref_To_Local'>bytes2write</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>&GT; </span><a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>: </span><a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN941"><span class='Ref_To_Local'>skip_file</span></a><span class='Parentheses'>) 
</span>                            <a href="pg_basebackup.c.html#LN917"><span class='Ref_to_Macro'>WRITE_TAR_DATA</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>+ </span><a href="pg_basebackup.c.html#LN1166"><span class='Ref_To_Local'>pos</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1234"><span class='Ref_To_Local'>bytes2write</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
                        <a href="pg_basebackup.c.html#LN1165"><span class='Ref_To_Local'>rr</span></a> <span class='Operator'>-= </span><a href="pg_basebackup.c.html#LN1234"><span class='Ref_To_Local'>bytes2write</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN1166"><span class='Ref_To_Local'>pos</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1234"><span class='Ref_To_Local'>bytes2write</span></a><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>-= </span><a href="pg_basebackup.c.html#LN1234"><span class='Ref_To_Local'>bytes2write</span></a><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                    <span class='Control'>else</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * No more data in the current file, the next piece of 
                         * data (if any) will be a new file header structure. 
                         */ 
</span>                        <a href="pg_basebackup.c.html#LN940"><span class='Ref_To_Local'>in_tarhdr</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN941"><span class='Ref_To_Local'>skip_file</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN942"><span class='Ref_To_Local'>tarhdrsz</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                        <a href="pg_basebackup.c.html#LN943"><span class='Ref_To_Local'>filesz</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while rr&GT;0 &raquo; </span> 
        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span> 
        <a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1064"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>        <a href="../pg_rewind/logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while 1 &raquo; </span>                           <span class='Comment_Single_Line'>/* while (1) */ 
</span>    <a href="../pg_rewind/logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN933"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN936"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* sync the resulting tar file, errors are not considered fatal */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN935"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end ReceiveTarFile &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Retrieve tablespace path, either relocated or original depending on whether 
 * -T was passed or not. 
 */ 
</span><span class='Keyword'>static const char </span><span class='Operator'>* 
</span><a name="LN1278"></a><span class='Declare_Function'>get_tablespace_mapping</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dir</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1280"></a>    <a href="pg_basebackup.c.html#LN41"><span class='Ref_to_Struct'>TablespaceListCell</span></a> <span class='Operator'>*</span><span class='Declare_Local'>cell</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN77"><span class='Ref_to_Global_Var'>tablespace_dirs</span></a><span class='Operator'>.</span><a href="pg_basebackup.c.html#LN50"><span class='Ref_to_Member'>head</span></a><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN43"><span class='Ref_to_Member'>next</span></a><span class='Parentheses'>) 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1278"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN44"><span class='Ref_to_Member'>old_dir</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Control'>return</span> <a href="pg_basebackup.c.html#LN1280"><span class='Ref_To_Local'>cell</span></a><span class='Operator'>-&GT;</span><a href="pg_basebackup.c.html#LN45"><span class='Ref_to_Member'>new_dir</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>return</span> <a href="pg_basebackup.c.html#LN1278"><span class='Ref_to_Parameter'>dir</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Receive a tar format stream from the connection to the server, and unpack 
 * the contents of it into a directory. Only files, directories and 
 * symlinks are supported, no other kinds of special files. 
 * 
 * If the data is for the main data directory, it will be restored in the 
 * specified directory. If it's for another tablespace, it will be restored 
 * in the original or mapped directory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1300"></a><span class='Declare_Function'>ReceiveAndUnpackTarFile</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>res</span><span class='Delimiter'>, </span><span class='Keyword'>int </span><span class='Declare_Parameter'>rownum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1302"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>current_path</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1303"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>filename</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1304"></a>    <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>mapped_tblspc_path</span><span class='Delimiter'>; 
</span><a name="LN1305"></a>    <a href="../../include/port/win32.h.html#LN230"><span class='Ref_to_Const'>pgoff_t</span></a>     <span class='Declare_Local'>current_len_left</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1306"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>current_padding</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN1307"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>basetablespace</span><span class='Delimiter'>; 
</span><a name="LN1308"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>copybuf</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1309"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>file</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN1307"><span class='Ref_To_Local'>basetablespace</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1307"><span class='Ref_To_Local'>basetablespace</span></a><span class='Parentheses'>) 
</span>        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1302"><span class='Ref_To_Local'>current_path</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1302"><span class='Ref_To_Local'>current_path</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1302"><span class='Ref_To_Local'>current_path</span></a><span class='Delimiter'>, 
</span>                <a href="pg_basebackup.c.html#LN144"><span class='Ref_to_Proto'>get_tablespace_mapping</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>, 
</span>                <span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1302"><span class='Ref_To_Local'>current_path</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the COPY data 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN90"><span class='Ref_to_EnumConst'>PGRES_COPY_OUT</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not get COPY data stream: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1332"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN433"><span class='Ref_to_Proto'>PQgetCopyData</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * End of chunk 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>) 
</span>                fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Control'>break</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>2</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read COPY data: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN1361"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>filemode</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * No current file, so this must be the header for a new file 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><span class='Number'>512</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid tar block header size: %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>+= </span><span class='Number'>512</span><span class='Delimiter'>; 
</span> 
            <a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>= </span><a href="../../include/pgtar.h.html#LN23"><span class='Ref_to_Proto'>read_tar_number</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>124</span><span class='Delimiter'>], </span><span class='Number'>12</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* Set permissions on the file */ 
</span>            <a href="pg_basebackup.c.html#LN1361"><span class='Ref_To_Local'>filemode</span></a> <span class='Operator'>= </span><a href="../../include/pgtar.h.html#LN23"><span class='Ref_to_Proto'>read_tar_number</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>100</span><span class='Delimiter'>], </span><span class='Number'>8</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * All files are padded up to 512 bytes 
             */ 
</span>            <a href="pg_basebackup.c.html#LN1306"><span class='Ref_To_Local'>current_padding</span></a> <span class='Operator'>= 
</span>                <span class='Parentheses'>((</span><a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>+ </span><span class='Number'>511</span><span class='Parentheses'>) </span><span class='Operator'>& ~</span><span class='Number'>511</span><span class='Parentheses'>)</span> <span class='Operator'>- </span><a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a><span class='Delimiter'>; 
</span> 
            <span class='Comment_Multi_Line'>/* 
             * First part of header is zero terminated filename 
             */ 
</span>            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1302"><span class='Ref_To_Local'>current_path</span></a><span class='Delimiter'>, 
</span>                     <a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>[</span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'/'</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Ends in a slash means directory or symlink to directory 
                 */ 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>156</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'5'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Directory 
                     */ 
</span>                    <a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>[</span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Remove trailing slash */ 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN56"><span class='Ref_to_Macro'>mkdir</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../include/port/win32.h.html#LN427"><span class='Ref_to_Const'>S_IRWXU</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <span class='Comment_Multi_Line'>/* 
                         * When streaming WAL, pg_wal (or pg_xlog for pre-9.6 
                         * clusters) will have been created by the wal 
                         * receiver process. Also, when the WAL directory 
                         * location was specified, pg_wal (or pg_xlog) has 
                         * already been created as a symbolic link before 
                         * starting the actual backup. So just ignore creation 
                         * failures on related directories. 
                         */ 
</span>                        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><span class='Parentheses'>((</span><a href="../../include/common/string.h.html#LN12"><span class='Ref_to_Proto'>pg_str_endswith</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"/pg_wal"</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                               <a href="../../include/common/string.h.html#LN12"><span class='Ref_to_Proto'>pg_str_endswith</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"/pg_xlog"</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>                             <a href="../../include/common/string.h.html#LN12"><span class='Ref_to_Proto'>pg_str_endswith</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"/archive_status"</span><span class='Parentheses'>))</span> <span class='Operator'>&& 
</span>                              errno <span class='Operator'>== </span>EEXIST<span class='Parentheses'>))</span> 
                        <span class='Delimiter'>{ 
</span>                            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: could not create directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                        <span class='Delimiter'>} 
</span>                    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if mkdir(filename,S_IRWX... &raquo; </span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
                    <span class='Control'>if</span> <span class='Parentheses'>(</span>chmod<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN422"><span class='Ref_to_Typedef'>mode_t</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1361"><span class='Ref_To_Local'>filemode</span></a><span class='Parentheses'>))</span> 
                        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                                _<span class='Parentheses'>(</span><span class='String'>"%s: could not set permissions on directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if copybuf[156]=='5' &raquo; </span> 
                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>156</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'2'</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <span class='Comment_Multi_Line'>/* 
                     * Symbolic link 
                     * 
                     * It's most likely a link in pg_tblspc directory, to the 
                     * location of a tablespace. Apply any tablespace mapping 
                     * given on the command line (--tablespace-mapping). (We 
                     * blindly apply the mapping without checking that the 
                     * link really is inside pg_tblspc. We don't expect there 
                     * to be other symlinks in a data directory, but if there 
                     * are, you can call it an undocumented feature that you 
                     * can map them too.) 
                     */ 
</span>                    <a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>[</span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>- </span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>= </span><span class='String'>'\0'</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* Remove trailing slash */ 
</span> 
                    <a href="pg_basebackup.c.html#LN1304"><span class='Ref_To_Local'>mapped_tblspc_path</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN144"><span class='Ref_to_Proto'>get_tablespace_mapping</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>157</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN255"><span class='Ref_to_Macro'>symlink</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1304"><span class='Ref_To_Local'>mapped_tblspc_path</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <span class='Delimiter'>{ 
</span>                        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                                _<span class='Parentheses'>(</span><span class='String'>"%s: could not create symbolic link from \"%s\" to \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1304"><span class='Ref_To_Local'>mapped_tblspc_path</span></a><span class='Delimiter'>, 
</span>                                <a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <span class='Delimiter'>} 
</span>                <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if copybuf[156]=='2' &raquo; </span> 
                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: unrecognized link indicator \"%c\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>[</span><span class='Number'>156</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>continue</span><span class='Delimiter'>;</span>       <span class='Comment_Single_Line'>/* directory or link handled */ 
</span>            <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if filename[strlen(filen... &raquo; </span> 
 
            <span class='Comment_Multi_Line'>/* 
             * regular file 
             */ 
</span>            <a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"wb"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>chmod<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/port/win32.h.html#LN422"><span class='Ref_to_Typedef'>mode_t</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1361"><span class='Ref_To_Local'>filemode</span></a><span class='Parentheses'>))</span> 
                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not set permissions on file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Done with this file, next one will be a new tar header 
                 */ 
</span>                fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if file==NULL &raquo; </span>                       <span class='Comment_Single_Line'>/* new file */ 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * Continuing blocks in existing file 
             */ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN1306"><span class='Ref_To_Local'>current_padding</span></a><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Received the padding block for this file, ignore it and 
                 * close the file, then move on to the next tar header. 
                 */ 
</span>                fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span>fwrite<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not write to file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>+= </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>            <a href="../pg_rewind/logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Boolean'>false</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>-= </span><a href="pg_basebackup.c.html#LN1332"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1305"><span class='Ref_To_Local'>current_len_left</span></a> <span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN1306"><span class='Ref_To_Local'>current_padding</span></a> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <span class='Comment_Multi_Line'>/* 
                 * Received the last block, and there is no padding to be 
                 * expected. Close the file and move on to the next tar 
                 * header. 
                 */ 
</span>                fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end else &raquo; </span>                       <span class='Comment_Single_Line'>/* continuing data in existing file */ 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while 1 &raquo; </span>                           <span class='Comment_Single_Line'>/* loop over all data blocks */ 
</span>    <a href="../pg_rewind/logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1300"><span class='Ref_to_Parameter'>rownum</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1303"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1309"><span class='Ref_To_Local'>file</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: COPY stream ended before last file was finished\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../../interfaces/libpq/libpq-fe.h.html#LN504"><span class='Ref_to_Proto'>PQfreemem</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1308"><span class='Ref_To_Local'>copybuf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1307"><span class='Ref_To_Local'>basetablespace</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN87"><span class='Ref_to_Global_Var'>writerecoveryconf</span></a><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN138"><span class='Ref_to_Proto'>WriteRecoveryConf</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * No data is synced here, everything is done for all tablespaces at the 
     * end. 
     */ 
</span><span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end ReceiveAndUnpackTarFile &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Escape a string so that it can be used as a value in a key-value pair 
 * a configuration file. 
 */ 
</span><span class='Keyword'>static char </span><span class='Operator'>* 
</span><a name="LN1560"></a><span class='Declare_Function'>escape_quotes</span><span class='Parentheses'>(</span><span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Parameter'>src</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1562"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>result</span> <span class='Operator'>= </span><a href="../../port/quotes.c.html#LN31"><span class='Ref_to_Func'>escape_single_quotes_ascii</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1560"><span class='Ref_to_Parameter'>src</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN1562"><span class='Ref_To_Local'>result</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: out of memory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <a href="pg_basebackup.c.html#LN1562"><span class='Ref_To_Local'>result</span></a><span class='Delimiter'>; 
} 
</span> 
<span class='Comment_Multi_Line'>/* 
 * Create a recovery.conf file in memory using a PQExpBuffer 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1576"></a><span class='Declare_Function'>GenerateRecoveryConf</span><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN139"><span class='Ref_to_Typedef'>PGconn</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>conn</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1578"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>connOptions</span><span class='Delimiter'>; 
</span><a name="LN1579"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN200"><span class='Ref_to_Typedef'>PQconninfoOption</span></a> <span class='Operator'>*</span><span class='Declare_Local'>option</span><span class='Delimiter'>; 
</span><a name="LN1580"></a>    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN43"><span class='Ref_to_Struct'>PQExpBufferData</span></a> <span class='Declare_Local'>conninfo_buf</span><span class='Delimiter'>; 
</span><a name="LN1581"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>escaped</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/pqexpbuffer.c.html#LN69"><span class='Ref_to_Func'>createPQExpBuffer</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: out of memory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_basebackup.c.html#LN1578"><span class='Ref_To_Local'>connOptions</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN281"><span class='Ref_to_Proto'>PQconninfo</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1576"><span class='Ref_to_Parameter'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1578"><span class='Ref_To_Local'>connOptions</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: out of memory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN164"><span class='Ref_to_Proto'>appendPQExpBufferStr</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Delimiter'>, </span><span class='String'>"standby_mode = 'on'\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN87"><span class='Ref_to_Func'>initPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN1578"><span class='Ref_To_Local'>connOptions</span></a><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>++</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Do not emit this setting if: - the setting is "replication", 
         * "dbname" or "fallback_application_name", since these would be 
         * overridden by the libpqwalreceiver module anyway. - not set or 
         * empty. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"replication"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"dbname"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Delimiter'>, </span><span class='String'>"fallback_application_name"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>] </span><span class='Operator'>== </span><span class='String'>'\0'</span><span class='Parentheses'>))</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* Separate key-value pairs with spaces */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN171"><span class='Ref_to_Proto'>appendPQExpBufferChar</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Delimiter'>, </span><span class='String'>' '</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Write "keyword=value" pieces, the value string is escaped and/or 
         * quoted if necessary. 
         */ 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Delimiter'>, </span><span class='String'>"%s="</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN202"><span class='Ref_to_Member'>keyword</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/fe_utils/string_utils.h.html#LN45"><span class='Ref_to_Proto'>appendConnStrVal</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1579"><span class='Ref_To_Local'>option</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN205"><span class='Ref_to_Member'>val</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end for option=connOptions;op... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Escape the connection string, so that it can be put in the config file. 
     * Note that this is different from the escaping of individual connection 
     * options above! 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1581"><span class='Ref_To_Local'>escaped</span></a> <span class='Operator'>= </span><a href="../initdb/initdb.c.html#LN263"><span class='Ref_to_Proto'>escape_quotes</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Operator'>.</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Delimiter'>, </span><span class='String'>"primary_conninfo = '%s'\n"</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1581"><span class='Ref_To_Local'>escaped</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1581"><span class='Ref_To_Local'>escaped</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_basebackup.c.html#LN1581"><span class='Ref_To_Local'>escaped</span></a> <span class='Operator'>= </span><a href="../initdb/initdb.c.html#LN263"><span class='Ref_to_Proto'>escape_quotes</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN260"><span class='Ref_to_Func'>appendPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Delimiter'>, </span><span class='String'>"primary_slot_name = '%s'\n"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1581"><span class='Ref_To_Local'>escaped</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN58"><span class='Ref_to_Macro'>PQExpBufferBroken</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>        <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN66"><span class='Ref_to_Macro'>PQExpBufferDataBroken</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: out of memory\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/pqexpbuffer.h.html#LN121"><span class='Ref_to_Proto'>termPQExpBuffer</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1580"><span class='Ref_To_Local'>conninfo_buf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN284"><span class='Ref_to_Proto'>PQconninfoFree</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1578"><span class='Ref_To_Local'>connOptions</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end GenerateRecoveryConf &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Write a recovery.conf file into the directory specified in basedir, 
 * with the contents already collected in memory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN1661"></a><span class='Declare_Function'>WriteRecoveryConf</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1663"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>filename</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1664"></a>    FILE       <span class='Operator'>*</span><span class='Declare_Local'>cf</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/port.h.html#LN170"><span class='Ref_to_Macro'>sprintf</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1663"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"%s/recovery.conf"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN1664"><span class='Ref_To_Local'>cf</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN290"><span class='Ref_to_Macro'>fopen</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1663"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><span class='String'>"w"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1664"><span class='Ref_To_Local'>cf</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1663"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>fwrite<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN45"><span class='Ref_to_Member'>data</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Operator'>-&GT;</span><a href="../../interfaces/libpq/pqexpbuffer.h.html#LN46"><span class='Ref_to_Member'>len</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1664"><span class='Ref_To_Local'>cf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not write to file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1663"><span class='Ref_To_Local'>filename</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    fclose<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1664"><span class='Ref_To_Local'>cf</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end WriteRecoveryConf &raquo; </span> 
 
 
<span class='Keyword'>static void 
</span><a name="LN1688"></a><span class='Declare_Function'>BaseBackup</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN1690"></a>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN146"><span class='Ref_to_Typedef'>PGresult</span></a>   <span class='Operator'>*</span><span class='Declare_Local'>res</span><span class='Delimiter'>; 
</span><a name="LN1691"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>sysidentifier</span><span class='Delimiter'>; 
</span><a name="LN1692"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>latesttli</span><span class='Delimiter'>; 
</span><a name="LN1693"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>starttli</span><span class='Delimiter'>; 
</span><a name="LN1694"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>basebkp</span><span class='Delimiter'>; 
</span><a name="LN1695"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>escaped_label</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a><span class='Delimiter'>]; 
</span><a name="LN1696"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>maxrate_clause</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN1697"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>i</span><span class='Delimiter'>; 
</span><a name="LN1698"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>xlogstart</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN1699"></a>    <span class='Keyword'>char</span>        <span class='Declare_Local'>xlogend</span><span class='Delimiter'>[</span><span class='Number'>64</span><span class='Delimiter'>]; 
</span><a name="LN1700"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>minServerMajor</span><span class='Delimiter'>, 
</span><a name="LN1701"></a>                <span class='Declare_Local'>maxServerMajor</span><span class='Delimiter'>; 
</span><a name="LN1702"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>serverVersion</span><span class='Delimiter'>, 
</span><a name="LN1703"></a>                <span class='Declare_Local'>serverMajor</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check server version. BASE_BACKUP command was introduced in 9.1, so we 
     * can't work with servers older than 9.1. 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1700"><span class='Ref_To_Local'>minServerMajor</span></a> <span class='Operator'>= </span><span class='Number'>901</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN1701"><span class='Ref_To_Local'>maxServerMajor</span></a> <span class='Operator'>= </span>PG_VERSION_NUM <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN1702"><span class='Ref_To_Local'>serverVersion</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN1703"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN1702"><span class='Ref_To_Local'>serverVersion</span></a> <span class='Operator'>/ </span><span class='Number'>100</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1703"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>&LT; </span><a href="pg_basebackup.c.html#LN1700"><span class='Ref_To_Local'>minServerMajor</span></a> <span class='Operator'>|| </span><a href="pg_basebackup.c.html#LN1703"><span class='Ref_To_Local'>serverMajor</span></a> <span class='Operator'>&GT; </span><a href="pg_basebackup.c.html#LN1701"><span class='Ref_To_Local'>maxServerMajor</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN1717"></a>        <span class='Keyword'>const char </span><span class='Operator'>*</span><span class='Declare_Local'>serverver</span> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN319"><span class='Ref_to_Proto'>PQparameterStatus</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><span class='String'>"server_version"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: incompatible server version %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1717"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN1717"><span class='Ref_To_Local'>serverver</span></a> <span class='Operator'>: </span><span class='String'>"'unknown'"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If WAL streaming was requested, also check that the server is new 
     * enough for that. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a> <span class='Operator'>&& !</span><a href="receivelog.h.html#LN55"><span class='Ref_to_Proto'>CheckServerVersionForStreaming</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Error message already written in CheckServerVersionForStreaming(), 
         * but add a hint about using -X none. 
         */ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"HINT: use -X none or -X fetch to disable log streaming\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Build contents of recovery.conf if requested 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN87"><span class='Ref_to_Global_Var'>writerecoveryconf</span></a><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN137"><span class='Ref_to_Proto'>GenerateRecoveryConf</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Run IDENTIFY_SYSTEM so we can get the timeline 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="streamutil.h.html#LN37"><span class='Ref_to_Proto'>RunIdentifySystem</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1691"><span class='Ref_To_Local'>sysidentifier</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1692"><span class='Ref_To_Local'>latesttli</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start the actual backup 
     */ 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN521"><span class='Ref_to_Proto'>PQescapeStringConn</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1695"><span class='Ref_To_Local'>escaped_label</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN80"><span class='Ref_to_Global_Var'>label</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1695"><span class='Ref_To_Local'>escaped_label</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>maxrate</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <a href="pg_basebackup.c.html#LN1696"><span class='Ref_To_Local'>maxrate_clause</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"MAX_RATE %u"</span><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>maxrate</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>        _<span class='Parentheses'>(</span><span class='String'>"%s: initiating base backup, waiting for checkpoint to complete\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_rewind/pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a> <span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"waiting for checkpoint\r"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN1694"><span class='Ref_To_Local'>basebkp</span></a> <span class='Operator'>= 
</span>        <a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"BASE_BACKUP LABEL '%s' %s %s %s %s %s %s"</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN1695"><span class='Ref_To_Local'>escaped_label</span></a><span class='Delimiter'>, 
</span>                 <a href="../pg_rewind/pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a> <span class='Operator'>? </span><span class='String'>"PROGRESS"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN71"><span class='Ref_to_EnumConst'>FETCH_WAL</span></a> <span class='Operator'>? </span><span class='String'>"WAL"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN86"><span class='Ref_to_Global_Var'>fastcheckpoint</span></a> <span class='Operator'>? </span><span class='String'>"FAST"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN70"><span class='Ref_to_EnumConst'>NO_WAL</span></a> <span class='Operator'>? </span><span class='String'>""</span> <span class='Operator'>: </span><span class='String'>"NOWAIT"</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN1696"><span class='Ref_To_Local'>maxrate_clause</span></a> <span class='Operator'>? </span><a href="pg_basebackup.c.html#LN1696"><span class='Ref_To_Local'>maxrate_clause</span></a> <span class='Operator'>: </span><span class='String'>""</span><span class='Delimiter'>, 
</span>                 <a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'t'</span> <span class='Operator'>? </span><span class='String'>"TABLESPACE_MAP"</span> <span class='Operator'>: </span><span class='String'>""</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN401"><span class='Ref_to_Proto'>PQsendQuery</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1694"><span class='Ref_To_Local'>basebkp</span></a><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not send replication command \"%s\": %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='String'>"BASE_BACKUP"</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the starting WAL location 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not initiate base backup: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: server returned unexpected response to BASE_BACKUP command; got %d rows and %d fields, expected %d rows and %d fields\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1698"><span class='Ref_To_Local'>xlogstart</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1698"><span class='Ref_To_Local'>xlogstart</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: checkpoint completed\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * 9.3 and later sends the TLI of the starting point. With older servers, 
     * assume it's the same as the latest timeline reported by 
     * IDENTIFY_SYSTEM. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN474"><span class='Ref_to_Proto'>PQnfields</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT;= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
        <a href="pg_basebackup.c.html#LN1693"><span class='Ref_To_Local'>starttli</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>else</span> 
        <a href="pg_basebackup.c.html#LN1693"><span class='Ref_To_Local'>starttli</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN1692"><span class='Ref_To_Local'>latesttli</span></a><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>!= </span><a href="pg_basebackup.c.html#LN70"><span class='Ref_to_EnumConst'>NO_WAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: write-ahead log start point: %s on timeline %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1698"><span class='Ref_To_Local'>xlogstart</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1693"><span class='Ref_To_Local'>starttli</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the header 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not get backup header: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: no data returned from server\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Sum up the total size, for progress reporting 
     */ 
</span>    <a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN105"><span class='Ref_to_Global_Var'>totaldone</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span>    <a href="pg_basebackup.c.html#LN106"><span class='Ref_to_Global_Var'>tablespacecount</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="pg_basebackup.c.html#LN104"><span class='Ref_to_Global_Var'>totalsize</span></a> <span class='Operator'>+= </span>atol<span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Verify tablespace directories are empty. Don't bother with the 
         * first once since it can be relocated, and it will be checked before 
         * we do anything anyway. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span> <span class='Operator'>&& !</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN490"><span class='Ref_to_Proto'>PQgetisnull</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span><a name="LN1854"></a>            <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>path</span> <span class='Operator'>= </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN144"><span class='Ref_to_Proto'>get_tablespace_mapping</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
            <a href="pg_basebackup.c.html#LN132"><span class='Ref_to_Proto'>verify_dir_is_empty_or_create</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1854"><span class='Ref_To_Local'>path</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN100"><span class='Ref_to_Global_Var'>made_tablespace_dirs</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN101"><span class='Ref_to_Global_Var'>found_tablespace_dirs</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * When writing to stdout, require a single tablespace 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'t'</span> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: can only write single tablespace to stdout, database has %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * If we're streaming WAL, start the streaming session before we start 
     * receiving the actual data chunks. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: starting background WAL receiver\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_basebackup.c.html#LN535"><span class='Ref_to_Func'>StartLogStreamer</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1698"><span class='Ref_To_Local'>xlogstart</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1693"><span class='Ref_To_Local'>starttli</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1691"><span class='Ref_To_Local'>sysidentifier</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start receiving chunks 
     */ 
</span>    <span class='Control'>for</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a> <span class='Operator'>&LT; </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Operator'>++</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'t'</span><span class='Parentheses'>) 
</span>            <a href="pg_basebackup.c.html#LN135"><span class='Ref_to_Proto'>ReceiveTarFile</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>else</span> 
            <a href="pg_basebackup.c.html#LN136"><span class='Ref_to_Proto'>ReceiveAndUnpackTarFile</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1697"><span class='Ref_To_Local'>i</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span>                           <span class='Comment_Single_Line'>/* Loop over all tablespaces */ 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_rewind/pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../pg_rewind/logging.h.html#LN32"><span class='Ref_to_Proto'>progress_report</span></a><span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span><span class='String'>"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>;</span>  <span class='Comment_Single_Line'>/* Need to move to next line */ 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Get the stop position 
     */ 
</span>    <a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN87"><span class='Ref_to_EnumConst'>PGRES_TUPLES_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>         _<span class='Parentheses'>(</span><span class='String'>"%s: could not get write-ahead log end position from server: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN473"><span class='Ref_to_Proto'>PQntuples</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>             _<span class='Parentheses'>(</span><span class='String'>"%s: no write-ahead log end position returned from server\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <a href="../../port/strlcpy.c.html#LN43"><span class='Ref_to_Func'>strlcpy</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN488"><span class='Ref_to_Proto'>PQgetvalue</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>!= </span><a href="pg_basebackup.c.html#LN70"><span class='Ref_to_EnumConst'>NO_WAL</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: write-ahead log end point: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a> <span class='Operator'>= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN421"><span class='Ref_to_Proto'>PQgetResult</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/libpq-fe.h.html#LN466"><span class='Ref_to_Proto'>PQresultStatus</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN84"><span class='Ref_to_EnumConst'>PGRES_COMMAND_OK</span></a><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: final receive failed: %s"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN323"><span class='Ref_to_Proto'>PQerrorMessage</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
<a name="LN1936"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span><a name="LN1937"></a>        <span class='Keyword'>int</span>         <span class='Declare_Local'>r</span><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
<a name="LN1939"></a>        <span class='Keyword'>DWORD</span>       <span class='Declare_Local'>status</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * get a pointer sized version of bgchild to avoid warnings about 
         * casting to a different size on WIN64. 
         */ 
</span><a name="LN1945"></a>        intptr_t    <span class='Declare_Local'>bgchild_handle</span> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a><span class='Delimiter'>; 
</span><a name="LN1946"></a>        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>hi</span><span class='Delimiter'>, 
</span><a name="LN1947"></a>                    <span class='Declare_Local'>lo</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: waiting for background process to finish streaming ...\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN13"><span class='Ref_to_Macro'>write</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN110"><span class='Ref_to_Global_Var'>bgpipe</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span>strlen<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: could not send command to background pipe: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* Just wait for the background process to exit */ 
</span>        <a href="pg_basebackup.c.html#LN1937"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>= </span><a href="../../backend/postmaster/postmaster.c.html#LN445"><span class='Ref_to_Proto'>waitpid</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1937"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>== -</span><span class='Number'>1</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not wait for child process: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1937"><span class='Ref_To_Local'>r</span></a> <span class='Operator'>!= </span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: child %d died, expected %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1937"><span class='Ref_To_Local'>r</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN114"><span class='Ref_to_Global_Var'>bgchild</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../timezone/private.h.html#LN41"><span class='Ref_to_Macro'>WIFEXITED</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: child process did not exit normally\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../timezone/private.h.html#LN44"><span class='Ref_to_Macro'>WEXITSTATUS</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: child process exited with error %d\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../timezone/private.h.html#LN44"><span class='Ref_to_Macro'>WEXITSTATUS</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* Exited normally, we're happy! */ 
</span><span class='Directive'>#else</span>                           <span class='Comment_Single_Line'>/* WIN32 */ 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * On Windows, since we are in the same process, we can just store the 
         * value directly in the variable, and then set the flag that says 
         * it's there. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>sscanf<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Delimiter'>, </span><span class='String'>"%X/%X"</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1946"><span class='Ref_To_Local'>hi</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1947"><span class='Ref_To_Local'>lo</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>2</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                  _<span class='Parentheses'>(</span><span class='String'>"%s: could not parse write-ahead log location \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1699"><span class='Ref_To_Local'>xlogend</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pg_basebackup.c.html#LN118"><span class='Ref_to_Global_Var'>xlogendptr</span></a> <span class='Operator'>= </span><span class='Parentheses'>((</span><a href="../../include/c.h.html#LN297"><span class='Ref_to_Typedef'>uint64</span></a><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1946"><span class='Ref_To_Local'>hi</span></a><span class='Parentheses'>)</span> <span class='Operator'>&LT;&LT; </span><span class='Number'>32</span> <span class='Operator'>| </span><a href="pg_basebackup.c.html#LN1947"><span class='Ref_To_Local'>lo</span></a><span class='Delimiter'>; 
</span>        InterlockedIncrement<span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN121"><span class='Ref_to_Global_Var'>has_xlogendptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* First wait for the thread to exit */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>WaitForSingleObjectEx<span class='Parentheses'>((</span>HANDLE<span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1945"><span class='Ref_To_Local'>bgchild_handle</span></a><span class='Delimiter'>, </span>INFINITE<span class='Delimiter'>, </span><span class='Boolean'>FALSE</span><span class='Parentheses'>)</span> <span class='Operator'>!= 
</span>            WAIT_OBJECT_0<span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../port/win32error.c.html#LN169"><span class='Ref_to_Func'>_dosmaperr</span></a><span class='Parentheses'>(</span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not wait for child thread: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>GetExitCodeThread<span class='Parentheses'>((</span>HANDLE<span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1945"><span class='Ref_To_Local'>bgchild_handle</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../port/win32error.c.html#LN169"><span class='Ref_to_Func'>_dosmaperr</span></a><span class='Parentheses'>(</span>GetLastError<span class='Parentheses'>())</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not get child thread exit status: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: child thread exited with error %u\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>unsigned int</span><span class='Parentheses'>) </span><a href="pg_basebackup.c.html#LN1936"><span class='Ref_To_Local'>status</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Comment_Multi_Line'>/* Exited normally, we're happy */ 
</span><span class='Directive'>#endif</span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if bgchild&GT;0 &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* Free the recovery.conf contents */ 
</span>    <a href="../../interfaces/libpq/pqexpbuffer.c.html#LN111"><span class='Ref_to_Func'>destroyPQExpBuffer</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN127"><span class='Ref_to_Global_Var'>recoveryconfcontents</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * End of copy data. Final result is already checked inside the loop. 
     */ 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN501"><span class='Ref_to_Proto'>PQclear</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN1690"><span class='Ref_To_Local'>res</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Make data persistent on disk once backup is completed. For tar format 
     * once syncing the parent directory is fine, each tar file created per 
     * tablespace has been already synced. In plain format, all the data of 
     * the base directory is synced, taking into account all the tablespaces. 
     * Errors are not considered fatal. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'t'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/common/file_utils.h.html#LN17"><span class='Ref_to_Proto'>fsync_fname</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) </span><a href="../../include/common/file_utils.h.html#LN19"><span class='Ref_to_Proto'>fsync_pgdata</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN1702"><span class='Ref_To_Local'>serverVersion</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: base backup completed\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end BaseBackup &raquo; </span> 
 
 
<span class='Keyword'>int 
</span><a name="LN2068"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN2070"></a>    <span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../include/getopt_long.h.html#LN15"><span class='Ref_to_Struct'>option</span></a> <span class='Declare_Local'>long_options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"help"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'?'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"version"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'V'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"pgdata"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"format"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'F'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"checkpoint"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'c'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"max-rate"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'r'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"write-recovery-conf"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'R'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"slot"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'S'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"tablespace-mapping"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'T'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"wal-method"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'X'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"gzip"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'z'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"compress"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'Z'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"label"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'l'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-clean"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'n'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-sync"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'N'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"dbname"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"host"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'h'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"port"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"username"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'U'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-password"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'w'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"password"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'W'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"status-interval"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'s'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"verbose"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'v'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"progress"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'P'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"waldir"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-slot"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span><a name="LN2099"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span> 
<a name="LN2101"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>option_index</span><span class='Delimiter'>; 
</span><a name="LN2102"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>no_slot</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN49"><span class='Ref_to_Proto'>get_progname</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN93"><span class='Ref_to_Proto'>set_pglocale_pgservice</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"pg_basebackup"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--help"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-?"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../psql/help.h.html#LN10"><span class='Ref_to_Proto'>usage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-V"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> 
                 <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--version"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            puts<span class='Parentheses'>(</span><span class='String'>"pg_basebackup (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    atexit<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN148"><span class='Ref_to_Func'>cleanup_directories_atexit</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_basebackup.c.html#LN2099"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../include/getopt_long.h.html#LN30"><span class='Ref_to_Proto'>getopt_long</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"D:F:r:RT:X:l:nNzZ:d:c:h:p:U:s:S:wWvP"</span><span class='Delimiter'>, 
</span>                            <a href="pg_basebackup.c.html#LN2070"><span class='Ref_To_Local'>long_options</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN2101"><span class='Ref_To_Local'>option_index</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2099"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'F'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"p"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"plain"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>= </span><span class='String'>'p'</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"t"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"tar"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>= </span><span class='String'>'t'</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: invalid output format \"%s\", must be \"plain\" or \"tar\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'r'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN91"><span class='Ref_to_Global_Var'>maxrate</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN791"><span class='Ref_to_Func'>parse_max_rate</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'R'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN87"><span class='Ref_to_Global_Var'>writerecoveryconf</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'S'</span><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * When specifying replication slot name, use a permanent 
                 * slot. 
                 */ 
</span>                <a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="pg_basebackup.c.html#LN93"><span class='Ref_to_Global_Var'>temp_replication_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>2</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN2102"><span class='Ref_To_Local'>no_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'T'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN145"><span class='Ref_to_Proto'>tablespace_list_append</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'X'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"n"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                    strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"none"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN70"><span class='Ref_to_EnumConst'>NO_WAL</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"f"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                         strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"fetch"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN71"><span class='Ref_to_EnumConst'>FETCH_WAL</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"s"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                         strcmp<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"stream"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>= </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                            _<span class='Parentheses'>(</span><span class='String'>"%s: invalid wal-method option \"%s\", must be \"fetch\", \"stream\" or \"none\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>1</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'l'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN80"><span class='Ref_to_Global_Var'>label</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'n'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN81"><span class='Ref_to_Global_Var'>noclean</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'N'</span><span class='Operator'>: 
</span>                <a href="pg_basebackup.c.html#LN88"><span class='Ref_to_Global_Var'>do_sync</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'z'</span><span class='Operator'>: 
</span><span class='Directive'>#ifdef</span> HAVE_LIBZ 
                <a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>= </span><a href="../pg_dump/pg_backup_archiver.h.html#LN52"><span class='Ref_to_Const'>Z_DEFAULT_COMPRESSION</span></a><span class='Delimiter'>; 
</span><span class='Directive'>#else</span> 
                <a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>;</span>      <span class='Comment_Single_Line'>/* will be rejected below */ 
</span><span class='Directive'>#endif</span> 
                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'Z'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>9</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid compression level \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'c'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"fast"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="pg_basebackup.c.html#LN86"><span class='Ref_to_Global_Var'>fastcheckpoint</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/pgstrcasecmp.c.html#LN34"><span class='Ref_to_Func'>pg_strcasecmp</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Delimiter'>, </span><span class='String'>"spread"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                    <a href="pg_basebackup.c.html#LN86"><span class='Ref_to_Global_Var'>fastcheckpoint</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>                <span class='Control'>else</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid checkpoint argument \"%s\", must be \"fast\" or \"spread\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'d'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN33"><span class='Ref_to_Global_Var'>connection_string</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'h'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN34"><span class='Ref_to_Global_Var'>dbhost</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'p'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN36"><span class='Ref_to_Global_Var'>dbport</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'U'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN35"><span class='Ref_to_Global_Var'>dbuser</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'w'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN38"><span class='Ref_to_Global_Var'>dbgetpassword</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'W'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN38"><span class='Ref_to_Global_Var'>dbgetpassword</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'s'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid status interval \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'v'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'P'</span><span class='Operator'>: 
</span>                <a href="../pg_rewind/pg_rewind.c.html#LN53"><span class='Ref_to_Global_Var'>showprogress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * getopt_long already emitted a complaint 
                 */ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch c &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (c=getopt_long(argc,a... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Any non-option arguments? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: too many command-line arguments (first is \"%s\")\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN2068"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Required arguments 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: no target directory specified\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Mutually exclusive arguments 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: only tar mode backups can be compressed\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'t'</span> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>== </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a> <span class='Operator'>&& </span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>             _<span class='Parentheses'>(</span><span class='String'>"%s: cannot stream write-ahead logs in tar mode to stdout\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a> <span class='Operator'>&& </span><a href="pg_basebackup.c.html#LN85"><span class='Ref_to_Global_Var'>includewal</span></a> <span class='Operator'>!= </span><a href="pg_basebackup.c.html#LN72"><span class='Ref_to_EnumConst'>STREAM_WAL</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>            _<span class='Parentheses'>(</span><span class='String'>"%s: replication slots can only be used with WAL streaming\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2102"><span class='Ref_To_Local'>no_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: --no-slot cannot be used with slot name\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <a href="pg_basebackup.c.html#LN93"><span class='Ref_to_Global_Var'>temp_replication_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>!= </span><span class='String'>'p'</span><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: WAL directory location can only be specified in plain mode\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span> 
        <span class='Comment_Multi_Line'>/* clean up xlog directory name, check it's absolute */ 
</span>        <a href="../../include/port.h.html#LN42"><span class='Ref_to_Proto'>canonicalize_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../../include/port.h.html#LN76"><span class='Ref_to_Macro'>is_absolute_path</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: WAL directory location must be "</span> 
                              <span class='String'>"an absolute path\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(xlog_dir,"")!=... &raquo; </span> 
 
<span class='Directive'>#ifndef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: this build does not support compression\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Verify that the target directory exists, or create it. For plaintext 
     * backups, always require the directory. For tar backups, require it 
     * unless we are writing to stdout. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN79"><span class='Ref_to_Global_Var'>format</span></a> <span class='Operator'>== </span><span class='String'>'p'</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='String'>"-"</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <a href="pg_basebackup.c.html#LN132"><span class='Ref_to_Proto'>verify_dir_is_empty_or_create</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN96"><span class='Ref_to_Global_Var'>made_new_pgdata</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN97"><span class='Ref_to_Global_Var'>found_existing_pgdata</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* connection in replication mode to server */ 
</span>    <a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN30"><span class='Ref_to_Proto'>GetConnection</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* Error message already written in GetConnection() */ 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create pg_wal symlink, if required */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><span class='String'>""</span><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN2398"></a>        <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>linkloc</span><span class='Delimiter'>; 
</span> 
        <a href="pg_basebackup.c.html#LN132"><span class='Ref_to_Proto'>verify_dir_is_empty_or_create</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN98"><span class='Ref_to_Global_Var'>made_new_xlogdir</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_basebackup.c.html#LN99"><span class='Ref_to_Global_Var'>found_existing_xlogdir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Form name of the place where the symlink must go. pg_xlog has been 
         * renamed to pg_wal in post-10 clusters. 
         */ 
</span>        <a href="pg_basebackup.c.html#LN2398"><span class='Ref_To_Local'>linkloc</span></a> <span class='Operator'>= </span><a href="../../common/psprintf.c.html#LN44"><span class='Ref_to_Func'>psprintf</span></a><span class='Parentheses'>(</span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, 
</span>                         <a href="../../interfaces/libpq/libpq-fe.h.html#LN322"><span class='Ref_to_Proto'>PQserverVersion</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT; </span><a href="../../common/file_utils.c.html#LN34"><span class='Ref_to_Const'>MINIMUM_VERSION_FOR_PG_WAL</span></a> <span class='Operator'>? 
</span>                           <span class='String'>"pg_xlog"</span> <span class='Operator'>: </span><span class='String'>"pg_wal"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<span class='Directive'>#ifdef</span> HAVE_SYMLINK 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN255"><span class='Ref_to_Macro'>symlink</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN78"><span class='Ref_to_Global_Var'>xlog_dir</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN2398"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not create symbolic link \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_basebackup.c.html#LN2398"><span class='Ref_To_Local'>linkloc</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span><span class='Directive'>#else</span> 
        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: symlinks are not supported on this platform\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
        <a href="../../include/snowball/header.h.html#LN64"><span class='Ref_to_Macro'>free</span></a><span class='Parentheses'>(</span><a href="pg_basebackup.c.html#LN2398"><span class='Ref_To_Local'>linkloc</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if strcmp(xlog_dir,"")!=... &raquo; </span> 
 
    <a href="pg_basebackup.c.html#LN139"><span class='Ref_to_Proto'>BaseBackup</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span> 
    <a href="pg_basebackup.c.html#LN95"><span class='Ref_to_Global_Var'>success</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Control'>return</span> <span class='Number'>0</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>