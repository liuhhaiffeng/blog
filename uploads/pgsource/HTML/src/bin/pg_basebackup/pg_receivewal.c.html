<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta name="generator" content="Source Insight Version 4.00.0084 Built on 2017-02-26">
<meta charset='UTF-8' />
<style type='text/css'><!--
TD {background-color: #C0C0C0; font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.blurb {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 70%; }
.filename {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 120%; font-weight: bold; }
.dirname {font-family: 'Verdana', 'Arial', 'Helvetica', Sans-Serif; font-size: 100%; font-weight: bold; margin-top: 2.5em;}
--></style>
<title>src\bin\pg_basebackup\pg_receivewal.c</title>
<LINK REL=StyleSheet HREF="../../../C_Cpp_Source_File.css" TYPE='text/css' MEDIA=screen>
</head>
<body bgcolor=#ffffff>
<table bgcolor='#c0c0c0' width='100%'>
<tr><td><p class='filename'><b>src\bin\pg_basebackup\pg_receivewal.c</b></p></td>
<td align='right'>
Wed Jun 14 08:25:59 2017
</td></tr>
<tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table>
<pre>
<span class='Comment_Multi_Line'>/*------------------------------------------------------------------------- 
 * 
 * pg_receivewal.c - receive streaming WAL data and write it 
 *                    to a local file. 
 * 
 * Author: Magnus Hagander &LT;magnus@hagander.net&GT; 
 * 
 * Portions Copyright (c) 1996-2017, PostgreSQL Global Development Group 
 * 
 * IDENTIFICATION 
 *        src/bin/pg_basebackup/pg_receivewal.c 
 *------------------------------------------------------------------------- 
 */ 
</span> 
<span class='Keyword'>#include </span><span class='String'>"postgres_fe.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>&LT;dirent.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;signal.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;sys/stat.h&GT;</span> 
<span class='Keyword'>#include </span><span class='String'>&LT;unistd.h&GT;</span> 
 
<span class='Keyword'>#include </span><span class='String'>"libpq-fe.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"access/xlog_internal.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"getopt_long.h"</span> 
 
<span class='Keyword'>#include </span><span class='String'>"receivelog.h"</span> 
<span class='Keyword'>#include </span><span class='String'>"streamutil.h"</span> 
 
 
<span class='Comment_Multi_Line'>/* Time to sleep between reconnection attempts */ 
</span><a name="LN30"></a><span class='Keyword'>#define </span><span class='Declare_Constant'>RECONNECT_SLEEP_TIME</span> <span class='Number'>5</span> 
 
<span class='Comment_Multi_Line'>/* Global options */ 
</span><a name="LN33"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>basedir</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span><a name="LN34"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>verbose</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN35"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>compresslevel</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN36"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>noloop</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN37"></a><span class='Keyword'>static int</span>  <span class='Declare_Var'>standby_message_timeout</span> <span class='Operator'>= </span><span class='Number'>10</span> <span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>;</span>        <span class='Comment_Single_Line'>/* 10 sec = default */ 
</span><a name="LN38"></a><span class='Keyword'>static volatile bool </span><span class='Declare_Var'>time_to_abort</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN39"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>do_create_slot</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN40"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>slot_exists_ok</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN41"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>do_drop_slot</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN42"></a><span class='Keyword'>static bool </span><span class='Declare_Var'>synchronous</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span><a name="LN43"></a><span class='Keyword'>static char </span><span class='Operator'>*</span><span class='Declare_Var'>replication_slot</span> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
</span> 
 
<a name="LN46"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN47"></a><span class='Keyword'>static </span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Prototype'>get_destination_dir</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest_folder</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN48"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>close_destination_dir</span><span class='Parentheses'>(</span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest_dir</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest_folder</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN49"></a><span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Prototype'>FindStreamingStart</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tli</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN50"></a><span class='Keyword'>static void </span><span class='Declare_Prototype'>StreamLog</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><a name="LN51"></a><span class='Keyword'>static bool </span><span class='Declare_Prototype'>stop_streaming</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>segendpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>timeline</span><span class='Delimiter'>, 
</span><a name="LN52"></a>               <span class='Keyword'>bool </span><span class='Declare_Parameter'>segment_finished</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
<a name="LN54"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>disconnect_and_exit</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>code</span><span class='Parentheses'>)</span>               <span class='Operator'>\ 
</span>    <span class='Delimiter'>{</span>                                           <span class='Operator'>\ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) </span><a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>           <span class='Operator'>\ 
</span>    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Parameter'>code</span></a><span class='Parentheses'>)</span><span class='Delimiter'>;</span>                                 <span class='Operator'>\ 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Comment_Multi_Line'>/* Routines to evaluate segment file format */ 
</span><a name="LN61"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>IsCompressXLogFileName</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>fname</span><span class='Parentheses'>)</span>    <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN61"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><span class='String'>".gz"</span><span class='Parentheses'>)</span> <span class='Operator'>&& \ 
</span>     strspn<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN61"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789ABCDEF"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a> <span class='Operator'>&&</span>     <span class='Operator'>\ 
</span>     strcmp<span class='Parentheses'>((</span><a href="pg_receivewal.c.html#LN61"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a><span class='Delimiter'>, </span><span class='String'>".gz"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
<a name="LN65"></a><span class='Keyword'>#define </span><span class='Declare_Macro'>IsPartialCompressXLogFileName</span><span class='Parentheses'>(</span><span class='Declare_Parameter'>fname</span><span class='Parentheses'>)</span>    <span class='Operator'>\ 
</span>    <span class='Parentheses'>(</span>strlen<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN65"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a> <span class='Operator'>+ </span>strlen<span class='Parentheses'>(</span><span class='String'>".gz.partial"</span><span class='Parentheses'>)</span> <span class='Operator'>&& \ 
</span>     strspn<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN65"><span class='Ref_to_Parameter'>fname</span></a><span class='Delimiter'>, </span><span class='String'>"0123456789ABCDEF"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a> <span class='Operator'>&&</span>     <span class='Operator'>\ 
</span>     strcmp<span class='Parentheses'>((</span><a href="pg_receivewal.c.html#LN65"><span class='Ref_to_Parameter'>fname</span></a><span class='Parentheses'>) </span><span class='Operator'>+ </span><a href="../../include/access/xlog_internal.h.html#LN140"><span class='Ref_to_Const'>XLOG_FNAME_LEN</span></a><span class='Delimiter'>, </span><span class='String'>".gz.partial"</span><span class='Parentheses'>)</span> <span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
 
<span class='Keyword'>static void 
</span><a name="LN71"></a><span class='Declare_Function'>usage</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"%s receives PostgreSQL streaming write-ahead logs.\n\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>           <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"Usage:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  %s [OPTION]...\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nOptions:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -D, --directory=DIR    receive write-ahead log files into this directory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --if-not-exists    do not error if slot already exists when creating a slot\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -n, --no-loop          do not loop on connection lost\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -s, --status-interval=SECS\n"</span> 
             <span class='String'>"                         time between status packets sent to server (default: %d)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a> <span class='Operator'>/ </span><span class='Number'>1000</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -S, --slot=SLOTNAME    replication slot to use\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --synchronous      flush write-ahead log immediately after writing\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -v, --verbose          output verbose messages\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -V, --version          output version information, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -Z, --compress=0-9     compress logs with given compression level\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -?, --help             show this help, then exit\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nConnection options:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -d, --dbname=CONNSTR   connection string\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -h, --host=HOSTNAME    database server host or socket directory\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -p, --port=PORT        database server port number\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -U, --username=NAME    connect as specified database user\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -w, --no-password      never prompt for password\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"  -W, --password         force password prompt (should happen automatically)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nOptional actions:\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --create-slot      create a new replication slot (for the slot's name see --slot)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"      --drop-slot        drop the replication slot (for the slot's name see --slot)\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN173"><span class='Ref_to_Macro'>printf</span></a><span class='Parentheses'>(</span>_<span class='Parentheses'>(</span><span class='String'>"\nReport bugs to &LT;pgsql-bugs@postgresql.org&GT;.\n"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end usage &raquo; </span> 
 
<span class='Keyword'>static bool 
</span><a name="LN103"></a><span class='Declare_Function'>stop_streaming</span><span class='Parentheses'>(</span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Parameter'>xlogpos</span><span class='Delimiter'>, </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Parameter'>timeline</span><span class='Delimiter'>, </span><span class='Keyword'>bool </span><span class='Declare_Parameter'>segment_finished</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN105"></a>    <span class='Keyword'>static </span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Declare_Local'>prevtimeline</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN106"></a>    <span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> <span class='Declare_Local'>prevpos</span> <span class='Operator'>= </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* we assume that we get called once at the end of each segment */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>segment_finished</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: finished segment at %X/%X (timeline %u)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>xlogpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>xlogpos</span></a><span class='Delimiter'>, 
</span>                <a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Note that we report the previous, not current, position here. After a 
     * timeline switch, xlogpos points to the beginning of the segment because 
     * that's where we always begin streaming. Reporting the end of previous 
     * timeline isn't totally accurate, because the next timeline can begin 
     * slightly before the end of the WAL that we received on the previous 
     * timeline, but it's close enough for reporting purposes. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN105"><span class='Ref_To_Local'>prevtimeline</span></a> <span class='Operator'>!= </span><span class='Number'>0</span> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN105"><span class='Ref_To_Local'>prevtimeline</span></a> <span class='Operator'>!= </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>timeline</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: switched to timeline %u at %X/%X\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>timeline</span></a><span class='Delimiter'>, 
</span>                <span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_receivewal.c.html#LN106"><span class='Ref_To_Local'>prevpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_receivewal.c.html#LN106"><span class='Ref_To_Local'>prevpos</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_receivewal.c.html#LN105"><span class='Ref_To_Local'>prevtimeline</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>timeline</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN106"><span class='Ref_To_Local'>prevpos</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN103"><span class='Ref_to_Parameter'>xlogpos</span></a><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN38"><span class='Ref_to_Global_Var'>time_to_abort</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: received interrupt signal, exiting\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>return</span> <span class='Boolean'>false</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end stop_streaming &raquo; </span> 
 
 
<span class='Comment_Multi_Line'>/* 
 * Get destination directory. 
 */ 
</span><span class='Keyword'>static </span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>* 
</span><a name="LN144"></a><span class='Declare_Function'>get_destination_dir</span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest_folder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN146"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span> 
    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN144"><span class='Ref_to_Parameter'>dest_folder</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN146"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="../../include/port/win32_msvc/dirent.h.html#LN18"><span class='Ref_to_Proto'>opendir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN144"><span class='Ref_to_Parameter'>dest_folder</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN146"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>return</span> <a href="pg_receivewal.c.html#LN146"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>; 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Close existing directory. 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN165"></a><span class='Declare_Function'>close_destination_dir</span><span class='Parentheses'>(</span><a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>dest_dir</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Declare_Parameter'>dest_folder</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <span class='Debug'>Assert</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN165"><span class='Ref_to_Parameter'>dest_dir</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN165"><span class='Ref_to_Parameter'>dest_folder</span></a> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port/win32_msvc/dirent.h.html#LN20"><span class='Ref_to_Proto'>closedir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN165"><span class='Ref_to_Parameter'>dest_dir</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not close directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN165"><span class='Ref_to_Parameter'>dest_folder</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
} 
</span> 
 
<span class='Comment_Multi_Line'>/* 
 * Determine starting location for streaming, based on any existing xlog 
 * segments in the directory. We start at the end of the last one that is 
 * complete (size matches XLogSegSize), on the timeline with highest ID. 
 * 
 * If there are no WAL files in the directory, returns InvalidXLogRecPtr. 
 */ 
</span><span class='Keyword'>static </span><a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a> 
<a name="LN185"></a><span class='Declare_Function'>FindStreamingStart</span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a> <span class='Operator'>*</span><span class='Declare_Parameter'>tli</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN187"></a>    <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span><span class='Delimiter'>; 
</span><a name="LN188"></a>    <span class='Control'>struct</span> <a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a> <span class='Operator'>*</span><span class='Declare_Local'>dirent</span><span class='Delimiter'>; 
</span><a name="LN189"></a>    <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>high_segno</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN190"></a>    <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>high_tli</span> <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>; 
</span><a name="LN191"></a>    <span class='Keyword'>bool</span>        <span class='Declare_Local'>high_ispartial</span> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="pg_receivewal.c.html#LN187"><span class='Ref_To_Local'>dir</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN47"><span class='Ref_to_Proto'>get_destination_dir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span>errno <span class='Operator'>= </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a> <span class='Operator'>= </span><a href="../../include/port/win32_msvc/dirent.h.html#LN19"><span class='Ref_to_Proto'>readdir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN187"><span class='Ref_To_Local'>dir</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Null_Value'>NULL</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span><a name="LN197"></a>        <a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a>      <span class='Declare_Local'>tli</span><span class='Delimiter'>; 
</span><a name="LN198"></a>        <a href="../../include/access/xlogdefs.h.html#LN33"><span class='Ref_to_Typedef'>XLogSegNo</span></a>   <span class='Declare_Local'>segno</span><span class='Delimiter'>; 
</span><a name="LN199"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>ispartial</span><span class='Delimiter'>; 
</span><a name="LN200"></a>        <span class='Keyword'>bool</span>        <span class='Declare_Local'>iscompress</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check if the filename looks like an xlog file, or a .partial file. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN150"><span class='Ref_to_Macro'>IsXLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/access/xlog_internal.h.html#LN159"><span class='Ref_to_Macro'>IsPartialXLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN61"><span class='Ref_to_Macro'>IsCompressXLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN65"><span class='Ref_to_Macro'>IsPartialCompressXLogFileName</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
            <span class='Control'>continue</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Looks like an xlog file. Parse its position. 
         */ 
</span>        <a href="../../include/access/xlog_internal.h.html#LN164"><span class='Ref_to_Macro'>XLogFromFileName</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN197"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN198"><span class='Ref_To_Local'>segno</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Check that the segment has the right size, if it's supposed to be 
         * completed.  For non-compressed segments just check the on-disk size 
         * and see if it matches a completed segment. For compressed segments, 
         * look at the last 4 bytes of the compressed file, which is where the 
         * uncompressed size is located for gz files with a size lower than 
         * 4GB, and then compare it to the size of a completed segment. The 4 
         * last bytes correspond to the ISIZE member according to 
         * http://www.zlib.org/rfc-gzip.html. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN245"></a>            <span class='Control'>struct</span> <a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a> <span class='Declare_Local'>statbuf</span><span class='Delimiter'>; 
</span><a name="LN246"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>fullpath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN246"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN246"><span class='Ref_To_Local'>fullpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../include/port.h.html#LN275"><span class='Ref_to_Macro'>stat</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN246"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN245"><span class='Ref_To_Local'>statbuf</span></a><span class='Parentheses'>) </span><span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not stat file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN246"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN245"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size <span class='Operator'>!= </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: segment file \"%s\" has incorrect size %d, skipping\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>int</span><span class='Parentheses'>) </span><a href="pg_receivewal.c.html#LN245"><span class='Ref_To_Local'>statbuf</span></a><span class='Operator'>.</span>st_size<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !ispartial&&!iscompre... &raquo; </span> 
        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN200"><span class='Ref_To_Local'>iscompress</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span><a name="LN266"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>fd</span><span class='Delimiter'>; 
</span><a name="LN267"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>buf</span><span class='Delimiter'>[</span><span class='Number'>4</span><span class='Delimiter'>]; 
</span><a name="LN268"></a>            <span class='Keyword'>int</span>         <span class='Declare_Local'>bytes_out</span><span class='Delimiter'>; 
</span><a name="LN269"></a>            <span class='Keyword'>char</span>        <span class='Declare_Local'>fullpath</span><span class='Delimiter'>[</span><a href="../../include/pg_config_manual.h.html#LN88"><span class='Ref_to_Const'>MAXPGPATH</span></a> <span class='Operator'>* </span><span class='Number'>2</span><span class='Delimiter'>]; 
</span> 
            <a href="../../pl/plperl/plperl.h.html#LN60"><span class='Ref_to_Macro'>snprintf</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='String'>"%s/%s"</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
            <a href="pg_receivewal.c.html#LN266"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN289"><span class='Ref_to_Macro'>open</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span>O_RDONLY <span class='Operator'>| </span><a href="../../include/c.h.html#LN1032"><span class='Ref_to_Const'>PG_BINARY</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN266"><span class='Ref_To_Local'>fd</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not open compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span>lseek<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN266"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span>off_t<span class='Parentheses'>) (</span><span class='Operator'>-</span><span class='Number'>4</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span>SEEK_END<span class='Parentheses'>)</span> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not seek compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../interfaces/libpq/win32.h.html#LN12"><span class='Ref_to_Macro'>read</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN266"><span class='Ref_To_Local'>fd</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><span class='Keyword'>char </span><span class='Operator'>*</span><span class='Parentheses'>) </span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Parentheses'>))</span> 
            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read compressed file \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN269"><span class='Ref_To_Local'>fullpath</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>                <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span> 
            <a href="../../interfaces/libpq/win32.h.html#LN11"><span class='Ref_to_Macro'>close</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN266"><span class='Ref_To_Local'>fd</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN268"><span class='Ref_To_Local'>bytes_out</span></a> <span class='Operator'>= </span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>3</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>24</span><span class='Parentheses'>) </span><span class='Operator'>| </span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>2</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>16</span><span class='Parentheses'>) </span><span class='Operator'>| 
</span>                <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>] </span><span class='Operator'>&LT;&LT; </span><span class='Number'>8</span><span class='Parentheses'>) </span><span class='Operator'>| </span><a href="pg_receivewal.c.html#LN267"><span class='Ref_To_Local'>buf</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]; 
</span> 
            <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN268"><span class='Ref_To_Local'>bytes_out</span></a> <span class='Operator'>!= </span>XLOG_SEG_SIZE<span class='Parentheses'>) 
</span>            <span class='Delimiter'>{ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                        _<span class='Parentheses'>(</span><span class='String'>"%s: compressed segment file \"%s\" has incorrect uncompressed size %d, skipping\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN188"><span class='Ref_To_Local'>dirent</span></a><span class='Operator'>-&GT;</span><a href="../../include/port/win32_msvc/dirent.h.html#LN13"><span class='Ref_to_Member'>d_name</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN268"><span class='Ref_To_Local'>bytes_out</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>continue</span><span class='Delimiter'>; 
</span>            <span class='Delimiter'>} 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end if !ispartial&&iscompres... &raquo; </span> 
 
        <span class='Comment_Multi_Line'>/* Looks like a valid segment. Remember that we saw it. */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>((</span><a href="pg_receivewal.c.html#LN198"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>&GT; </span><a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN198"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>== </span><a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN197"><span class='Ref_To_Local'>tli</span></a> <span class='Operator'>&GT; </span><a href="pg_receivewal.c.html#LN190"><span class='Ref_To_Local'>high_tli</span></a><span class='Parentheses'>) </span><span class='Operator'>|| 
</span>            <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN198"><span class='Ref_To_Local'>segno</span></a> <span class='Operator'>== </span><a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN197"><span class='Ref_To_Local'>tli</span></a> <span class='Operator'>== </span><a href="pg_receivewal.c.html#LN190"><span class='Ref_To_Local'>high_tli</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN191"><span class='Ref_To_Local'>high_ispartial</span></a> <span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a><span class='Parentheses'>))</span> 
        <span class='Delimiter'>{ 
</span>            <a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN198"><span class='Ref_To_Local'>segno</span></a><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN190"><span class='Ref_To_Local'>high_tli</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN197"><span class='Ref_To_Local'>tli</span></a><span class='Delimiter'>; 
</span>            <a href="pg_receivewal.c.html#LN191"><span class='Ref_To_Local'>high_ispartial</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN199"><span class='Ref_To_Local'>ispartial</span></a><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while errno=0,(dirent=readd... &raquo; </span> 
 
    <span class='Control'>if</span> <span class='Parentheses'>(</span>errno<span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: could not read directory \"%s\": %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="pg_receivewal.c.html#LN48"><span class='Ref_to_Proto'>close_destination_dir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN187"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a> <span class='Operator'>&GT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN328"></a>        <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>high_ptr</span><span class='Delimiter'>; 
</span> 
        <span class='Comment_Multi_Line'>/* 
         * Move the starting pointer to the start of the next segment, if the 
         * highest one we saw was completed. Otherwise start streaming from 
         * the beginning of the .partial segment. 
         */ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_receivewal.c.html#LN191"><span class='Ref_To_Local'>high_ispartial</span></a><span class='Parentheses'>) 
</span>            <a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span> 
        <a href="../../include/access/xlog_internal.h.html#LN94"><span class='Ref_to_Macro'>XLogSegNoOffsetToRecPtr</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN189"><span class='Ref_To_Local'>high_segno</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN328"><span class='Ref_To_Local'>high_ptr</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Operator'>*</span><a href="pg_receivewal.c.html#LN185"><span class='Ref_to_Parameter'>tli</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN190"><span class='Ref_To_Local'>high_tli</span></a><span class='Delimiter'>; 
</span>        <span class='Control'>return</span> <a href="pg_receivewal.c.html#LN328"><span class='Ref_To_Local'>high_ptr</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span>    <span class='Control'>else</span> 
        <span class='Control'>return</span> <a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end FindStreamingStart &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * Start the log streaming 
 */ 
</span><span class='Keyword'>static void 
</span><a name="LN351"></a><span class='Declare_Function'>StreamLog</span><span class='Parentheses'>(</span><span class='Keyword'>void</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN353"></a>    <a href="../../include/access/xlogdefs.h.html#LN20"><span class='Ref_to_Typedef'>XLogRecPtr</span></a>  <span class='Declare_Local'>serverpos</span><span class='Delimiter'>; 
</span><a name="LN354"></a>    <a href="../../include/access/xlogdefs.h.html#LN44"><span class='Ref_to_Typedef'>TimeLineID</span></a>  <span class='Declare_Local'>servertli</span><span class='Delimiter'>; 
</span><a name="LN355"></a>    <a href="receivelog.h.html#LN29"><span class='Ref_to_Struct'>StreamCtl</span></a>   <span class='Declare_Local'>stream</span><span class='Delimiter'>; 
</span> 
    <a href="../../include/c.h.html#LN856"><span class='Ref_to_Macro'>MemSet</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Keyword'>sizeof</span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Connect in replication mode to the server 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL</span><span class='Parentheses'>) 
</span>        <a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN30"><span class='Ref_to_Proto'>GetConnection</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* Error message already written in GetConnection() */ 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="receivelog.h.html#LN55"><span class='Ref_to_Proto'>CheckServerVersionForStreaming</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* 
         * Error message already written in CheckServerVersionForStreaming(). 
         * There's no hope of recovering from a version mismatch, so don't 
         * retry. 
         */ 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Identify server, obtaining start LSN position and current timeline ID 
     * at the same time, necessary if not valid data can be found in the 
     * existing output directory. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="streamutil.h.html#LN37"><span class='Ref_to_Proto'>RunIdentifySystem</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN354"><span class='Ref_To_Local'>servertli</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN353"><span class='Ref_To_Local'>serverpos</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Parentheses'>))</span> 
        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Figure out where to start streaming. 
     */ 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN49"><span class='Ref_to_Proto'>FindStreamingStart</span></a><span class='Parentheses'>(</span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>== </span><a href="../../include/access/xlogdefs.h.html#LN27"><span class='Ref_to_Const'>InvalidXLogRecPtr</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN353"><span class='Ref_To_Local'>serverpos</span></a><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN354"><span class='Ref_To_Local'>servertli</span></a><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Always start streaming at the beginning of a segment 
     */ 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>-= </span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>% </span>XLOG_SEG_SIZE<span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Start the replication 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: starting log streaming at %X/%X (timeline %u)\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) (</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a> <span class='Operator'>&GT;&GT; </span><span class='Number'>32</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><span class='Parentheses'>(</span><a href="../../include/c.h.html#LN267"><span class='Ref_to_Typedef'>uint32</span></a><span class='Parentheses'>) </span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN31"><span class='Ref_to_Member'>startpos</span></a><span class='Delimiter'>, 
</span>                <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN32"><span class='Ref_to_Member'>timeline</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN42"><span class='Ref_to_Member'>stream_stop</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN51"><span class='Ref_to_Proto'>stop_streaming</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN44"><span class='Ref_to_Member'>stop_socket</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN23"><span class='Ref_to_Const'>PGINVALID_SOCKET</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN35"><span class='Ref_to_Member'>standby_message_timeout</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN37"><span class='Ref_to_Member'>synchronous</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN42"><span class='Ref_to_Global_Var'>synchronous</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN39"><span class='Ref_to_Member'>do_sync</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN38"><span class='Ref_to_Member'>mark_done</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a> <span class='Operator'>= </span><a href="walmethods.h.html#LN87"><span class='Ref_to_Proto'>CreateWalDirectoryMethod</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a><span class='Delimiter'>, 
</span>                                                <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN39"><span class='Ref_to_Member'>do_sync</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN48"><span class='Ref_to_Member'>partial_suffix</span></a> <span class='Operator'>= </span><span class='String'>".partial"</span><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN49"><span class='Ref_to_Member'>replication_slot</span></a> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Delimiter'>; 
</span>    <a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN50"><span class='Ref_to_Member'>temp_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>false</span><span class='Delimiter'>; 
</span> 
    <a href="receivelog.h.html#LN56"><span class='Ref_to_Proto'>ReceiveXlogStream</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Operator'>-&GT;</span><a href="walmethods.h.html#LN74"><span class='Ref_to_Member'>finish</span></a><span class='Parentheses'>())</span> 
    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: could not finish writing WAL files: %s\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/strerror.c.html#LN17"><span class='Ref_to_Func'>strerror</span></a><span class='Parentheses'>(</span>errno<span class='Parentheses'>))</span><span class='Delimiter'>; 
</span>        <span class='Control'>return</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <a href="../../interfaces/libpq/libpq-fe.h.html#LN272"><span class='Ref_to_Proto'>PQfinish</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="walmethods.h.html#LN92"><span class='Ref_to_Proto'>FreeWalDirectoryMethod</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <a href="../../include/common/fe_memutils.h.html#LN29"><span class='Ref_to_Proto'>pg_free</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN355"><span class='Ref_To_Local'>stream</span></a><span class='Operator'>.</span><a href="receivelog.h.html#LN47"><span class='Ref_to_Member'>walmethod</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>= </span><span class='Null_Value'>NULL</span><span class='Delimiter'>; 
}</span><span class='Auto_Annotations'> &laquo; end StreamLog &raquo; </span> 
 
<span class='Comment_Multi_Line'>/* 
 * When sigint is called, just tell the system to exit at the next possible 
 * moment. 
 */ 
</span><span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
 
<span class='Keyword'>static void 
</span><a name="LN447"></a><span class='Declare_Function'>sigint_handler</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>signum</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span>    <a href="pg_receivewal.c.html#LN38"><span class='Ref_to_Global_Var'>time_to_abort</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
} 
</span><span class='Directive'>#endif</span> 
 
<span class='Keyword'>int 
</span><a name="LN454"></a><span class='Declare_Function'>main</span><span class='Parentheses'>(</span><span class='Keyword'>int </span><span class='Declare_Parameter'>argc</span><span class='Delimiter'>, </span><span class='Keyword'>char </span><span class='Operator'>**</span><span class='Declare_Parameter'>argv</span><span class='Parentheses'>) 
</span><span class='Delimiter'>{ 
</span><a name="LN456"></a>    <span class='Keyword'>static </span><span class='Control'>struct</span> <a href="../../include/getopt_long.h.html#LN15"><span class='Ref_to_Struct'>option</span></a> <span class='Declare_Local'>long_options</span><span class='Delimiter'>[] </span><span class='Operator'>= </span><span class='Delimiter'>{ 
</span>        <span class='Delimiter'>{</span><span class='String'>"help"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'?'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"version"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'V'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"directory"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'D'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"dbname"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'d'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"host"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'h'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"port"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'p'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"username"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'U'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-loop"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'n'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"no-password"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'w'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"password"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'W'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"status-interval"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'s'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"slot"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'S'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"verbose"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'v'</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"compress"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN24"><span class='Ref_to_Const'>required_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='String'>'Z'</span><span class='Delimiter'>}, 
</span><span class='Comment_Multi_Line'>/* action */ 
</span>        <span class='Delimiter'>{</span><span class='String'>"create-slot"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>1</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"drop-slot"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>2</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"if-not-exists"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>3</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='String'>"synchronous"</span><span class='Delimiter'>, </span><a href="../../include/getopt_long.h.html#LN23"><span class='Ref_to_Const'>no_argument</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>4</span><span class='Delimiter'>}, 
</span>        <span class='Delimiter'>{</span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Number'>0</span><span class='Delimiter'>} 
</span>    <span class='Delimiter'>}; 
</span> 
<a name="LN479"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>c</span><span class='Delimiter'>; 
</span><a name="LN480"></a>    <span class='Keyword'>int</span>         <span class='Declare_Local'>option_index</span><span class='Delimiter'>; 
</span><a name="LN481"></a>    <span class='Keyword'>char</span>       <span class='Operator'>*</span><span class='Declare_Local'>db_name</span><span class='Delimiter'>; 
</span> 
    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a> <span class='Operator'>= </span><a href="../../include/port.h.html#LN49"><span class='Ref_to_Proto'>get_progname</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <a href="../../include/port.h.html#LN93"><span class='Ref_to_Proto'>set_pglocale_pgservice</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>0</span><span class='Delimiter'>], </span><a href="../../include/c.h.html#LN1009"><span class='Ref_to_Macro'>PG_TEXTDOMAIN</span></a><span class='Parentheses'>(</span><span class='String'>"pg_basebackup"</span><span class='Parentheses'>))</span><span class='Delimiter'>; 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argc</span></a> <span class='Operator'>&GT; </span><span class='Number'>1</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--help"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| </span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-?"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../psql/help.h.html#LN10"><span class='Ref_to_Proto'>usage</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span>strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"-V"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span> <span class='Operator'>|| 
</span>                 strcmp<span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><span class='Number'>1</span><span class='Delimiter'>], </span><span class='String'>"--version"</span><span class='Parentheses'>) </span><span class='Operator'>== </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
        <span class='Delimiter'>{ 
</span>            puts<span class='Parentheses'>(</span><span class='String'>"pg_receivewal (PostgreSQL) "</span> PG_VERSION<span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>((</span><a href="pg_receivewal.c.html#LN479"><span class='Ref_To_Local'>c</span></a> <span class='Operator'>= </span><a href="../../include/getopt_long.h.html#LN30"><span class='Ref_to_Proto'>getopt_long</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argc</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>, </span><span class='String'>"D:d:h:p:U:s:S:nwWvZ:"</span><span class='Delimiter'>, 
</span>                            <a href="pg_receivewal.c.html#LN456"><span class='Ref_To_Local'>long_options</span></a><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN480"><span class='Ref_To_Local'>option_index</span></a><span class='Parentheses'>))</span> <span class='Operator'>!= -</span><span class='Number'>1</span><span class='Parentheses'>)</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Control'>switch</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN479"><span class='Ref_To_Local'>c</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Control'>case</span> <span class='String'>'D'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'d'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN33"><span class='Ref_to_Global_Var'>connection_string</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'h'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN34"><span class='Ref_to_Global_Var'>dbhost</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'p'</span><span class='Operator'>: 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>) </span><span class='Operator'>&LT;= </span><span class='Number'>0</span><span class='Parentheses'>)</span> 
                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid port number \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <a href="streamutil.c.html#LN36"><span class='Ref_to_Global_Var'>dbport</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'U'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN35"><span class='Ref_to_Global_Var'>dbuser</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'w'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN38"><span class='Ref_to_Global_Var'>dbgetpassword</span></a> <span class='Operator'>= -</span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'W'</span><span class='Operator'>: 
</span>                <a href="streamutil.c.html#LN38"><span class='Ref_to_Global_Var'>dbgetpassword</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'s'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>) </span><span class='Operator'>* </span><span class='Number'>1000</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN37"><span class='Ref_to_Global_Var'>standby_message_timeout</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid status interval \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'S'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a> <span class='Operator'>= </span><a href="../../include/common/fe_memutils.h.html#LN24"><span class='Ref_to_Proto'>pg_strdup</span></a><span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'n'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN36"><span class='Ref_to_Global_Var'>noloop</span></a> <span class='Operator'>= </span><span class='Number'>1</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'v'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Operator'>++</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='String'>'Z'</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>= </span>atoi<span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>&LT; </span><span class='Number'>0</span> <span class='Operator'>|| </span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>&GT; </span><span class='Number'>9</span><span class='Parentheses'>) 
</span>                <span class='Delimiter'>{ 
</span>                    <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: invalid compression level \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                            <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="../../port/getopt.c.html#LN52"><span class='Ref_to_Global_Var'>optarg</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                    <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <span class='Delimiter'>} 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span><span class='Comment_Multi_Line'>/* action */ 
</span>            <span class='Control'>case</span> <span class='Number'>1</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>2</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>3</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN40"><span class='Ref_to_Global_Var'>slot_exists_ok</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>case</span> <span class='Number'>4</span><span class='Operator'>: 
</span>                <a href="pg_receivewal.c.html#LN42"><span class='Ref_to_Global_Var'>synchronous</span></a> <span class='Operator'>= </span><span class='Boolean'>true</span><span class='Delimiter'>; 
</span>                <span class='Control'>break</span><span class='Delimiter'>; 
</span>            <span class='Control'>default</span><span class='Operator'>: 
</span> 
                <span class='Comment_Multi_Line'>/* 
                 * getopt_long already emitted a complaint 
                 */ 
</span>                <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                        <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>                <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end switch c &raquo; </span> 
    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while (c=getopt_long(argc,a... &raquo; </span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Any non-option arguments? 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a> <span class='Operator'>&LT; </span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argc</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: too many command-line arguments (first is \"%s\")\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN454"><span class='Ref_to_Parameter'>argv</span></a><span class='Delimiter'>[</span><a href="../../port/getopt.c.html#LN50"><span class='Ref_to_Global_Var'>optind</span></a><span class='Delimiter'>]</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>&& </span><a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: cannot use --create-slot together with --drop-slot\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& </span><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>|| </span><a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a><span class='Parentheses'>))</span> 
    <span class='Delimiter'>{ 
</span>        <span class='Comment_Multi_Line'>/* translator: second %s is an option name */ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: %s needs a slot to be specified using --slot\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, 
</span>                <a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>? </span><span class='String'>"--drop-slot"</span> <span class='Operator'>: </span><span class='String'>"--create-slot"</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Required arguments 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a> <span class='Operator'>== </span><span class='Null_Value'>NULL </span><span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: no target directory specified\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"Try \"%s --help\" for more information.\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> HAVE_LIBZ 
    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN35"><span class='Ref_to_Global_Var'>compresslevel</span></a> <span class='Operator'>!= </span><span class='Number'>0</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: this build does not support compression\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Check existence of destination folder. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a> <span class='Operator'>&& !</span><a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span><a name="LN641"></a>        <a href="../../port/dirent.c.html#LN24"><span class='Ref_to_Struct'>DIR</span></a>        <span class='Operator'>*</span><span class='Declare_Local'>dir</span> <span class='Operator'>= </span><a href="pg_receivewal.c.html#LN47"><span class='Ref_to_Proto'>get_destination_dir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <a href="pg_receivewal.c.html#LN48"><span class='Ref_to_Proto'>close_destination_dir</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN641"><span class='Ref_To_Local'>dir</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN33"><span class='Ref_to_Global_Var'>basedir</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
<span class='Directive'>#ifndef</span> <a href="../../include/c.h.html#LN61"><span class='Ref_to_Const'>WIN32</span></a> 
    <a href="../../port/pqsignal.c.html#LN38"><span class='Ref_to_Func'>pqsignal</span></a><span class='Parentheses'>(</span>SIGINT<span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN446"><span class='Ref_to_Func'>sigint_handler</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span><span class='Directive'>#endif</span> 
 
    <span class='Comment_Multi_Line'>/* 
     * Obtain a connection before doing anything. 
     */ 
</span>    <a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a> <span class='Operator'>= </span><a href="streamutil.h.html#LN30"><span class='Ref_to_Proto'>GetConnection</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Parentheses'>) 
</span>        <span class='Comment_Multi_Line'>/* error message already written in GetConnection() */ 
</span>        <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Run IDENTIFY_SYSTEM to make sure we've successfully have established a 
     * replication connection and haven't connected using a database specific 
     * connection. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="streamutil.h.html#LN37"><span class='Ref_to_Proto'>RunIdentifySystem</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Operator'>&</span><a href="pg_receivewal.c.html#LN481"><span class='Ref_To_Local'>db_name</span></a><span class='Parentheses'>))</span> 
        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Check that there is a database associated with connection, none should 
     * be defined in this context. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN481"><span class='Ref_To_Local'>db_name</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                _<span class='Parentheses'>(</span><span class='String'>"%s: replication connection using slot \"%s\" is unexpectedly database specific\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Drop a replication slot. 
     */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN41"><span class='Ref_to_Global_Var'>do_drop_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: dropping replication slot \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="streamutil.h.html#LN36"><span class='Ref_to_Proto'>DropReplicationSlot</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>))</span> 
            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* Create a replication slot */ 
</span>    <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN39"><span class='Ref_to_Global_Var'>do_create_slot</span></a><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN34"><span class='Ref_to_Global_Var'>verbose</span></a><span class='Parentheses'>) 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: creating replication slot \"%s\"\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span> 
        <span class='Control'>if</span> <span class='Parentheses'>(</span><span class='Operator'>!</span><a href="streamutil.h.html#LN33"><span class='Ref_to_Proto'>CreateReplicationSlot</span></a><span class='Parentheses'>(</span><a href="../pg_rewind/libpq_fetch.c.html#LN31"><span class='Ref_to_Global_Var'>conn</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN43"><span class='Ref_to_Global_Var'>replication_slot</span></a><span class='Delimiter'>, </span><span class='Null_Value'>NULL</span><span class='Delimiter'>, </span><span class='Boolean'>true</span><span class='Delimiter'>, 
</span>                                   <a href="pg_receivewal.c.html#LN40"><span class='Ref_to_Global_Var'>slot_exists_ok</span></a><span class='Parentheses'>))</span> 
            <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <a href="pg_receivewal.c.html#LN54"><span class='Ref_to_Macro'>disconnect_and_exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>    <span class='Delimiter'>} 
</span> 
    <span class='Comment_Multi_Line'>/* 
     * Don't close the connection here so that subsequent StreamLog() can 
     * reuse it. 
     */ 
</span> 
    <span class='Control'>while</span> <span class='Parentheses'>(</span><span class='Boolean'>true</span><span class='Parentheses'>) 
</span>    <span class='Delimiter'>{ 
</span>        <a href="pg_receivewal.c.html#LN50"><span class='Ref_to_Proto'>StreamLog</span></a><span class='Parentheses'>()</span><span class='Delimiter'>; 
</span>        <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN38"><span class='Ref_to_Global_Var'>time_to_abort</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <span class='Comment_Multi_Line'>/* 
             * We've been Ctrl-C'ed. That's not an error, so exit without an 
             * errorcode. 
             */ 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>0</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> <span class='Control'>if</span> <span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN36"><span class='Ref_to_Global_Var'>noloop</span></a><span class='Parentheses'>) 
</span>        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, </span>_<span class='Parentheses'>(</span><span class='String'>"%s: disconnected\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, </span><a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../test/isolation/specscanner.l.html#LN91"><span class='Ref_to_Proto'>exit</span></a><span class='Parentheses'>(</span><span class='Number'>1</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>        <span class='Control'>else</span> 
        <span class='Delimiter'>{ 
</span>            <a href="../../../contrib/seg/segscan.l.html#LN10"><span class='Ref_to_Macro'>fprintf</span></a><span class='Parentheses'>(</span>stderr<span class='Delimiter'>, 
</span>            <span class='Comment_Multi_Line'>/* translator: check source for value for %d */ 
</span>                    _<span class='Parentheses'>(</span><span class='String'>"%s: disconnected; waiting %d seconds to try again\n"</span><span class='Parentheses'>)</span><span class='Delimiter'>, 
</span>                    <a href="../pg_test_timing/pg_test_timing.c.html#LN11"><span class='Ref_to_Global_Var'>progname</span></a><span class='Delimiter'>, </span><a href="pg_receivewal.c.html#LN30"><span class='Ref_to_Const'>RECONNECT_SLEEP_TIME</span></a><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>            <a href="../../port/pgsleep.c.html#LN45"><span class='Ref_to_Func'>pg_usleep</span></a><span class='Parentheses'>(</span><a href="pg_receivewal.c.html#LN30"><span class='Ref_to_Const'>RECONNECT_SLEEP_TIME</span></a> <span class='Operator'>* </span><span class='Number'>1000000</span><span class='Parentheses'>)</span><span class='Delimiter'>; 
</span>        <span class='Delimiter'>} 
</span>    <span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end while true &raquo; </span> 
<span class='Delimiter'>}</span><span class='Auto_Annotations'> &laquo; end main &raquo; </span> 
</pre>
<table bgcolor='#c0c0c0' width='100%'><tr><td><a href='../../../Contents.html'>Contents</a></td></tr>
</table><hr><p class='blurb' align='center'><a href='http://www.sourceinsight.com'>HTML Created by Source Insight Version 4.00.0084 Built on 2017-02-26</a></p>
</body></html>